---

order: 1
author: zhiyu1998
title: JavaåŸºç¡€
category:
  - JavaåŸºç¡€
  - å…«è‚¡æ–‡
---

## ğŸ‚ å¸¸è§å…«è‚¡æ–‡ç²¾é€‰é›†

è¯¥æ¨¡å—çš„æ‰€æœ‰çŸ¥è¯†å†…å®¹æ•´ç†è‡ª

1. å´å¸ˆå…„çš„1000é“Java ç¨‹åºå‘˜å¿…å¤‡é¢è¯•é¢˜
2. JavaGuide
3. å°æ—coding
4. Java å…¨æ ˆçŸ¥è¯†ä½“ç³»
5. Javaå…«è‚¡æ–‡

é€‰å–ç†ç”±ï¼šæœ¬ç€æŸ¥ç¼ºè¡¥æ¼çš„æœ¨æ¡¶åŸç†ï¼Œåªé€‰å–é«˜é¢‘ï¼ˆâ­ï¸ã€ğŸŒ ã€ğŸŒŸã€âœ¨ã€ğŸ’«ã€ğŸ‡ã€ğŸ”¥ï¼‰å’Œä¸ä¼šçš„ï¼Œæ–¹ä¾¿é¢è¯•çªè¢­

## â˜•ï¸ JavaåŸºç¡€

### Java 8çš„æ¥â¼æ–°å¢äº†å“ªäº›ç‰¹æ€§ï¼Ÿ

- **Lambda è¡¨è¾¾å¼** âˆ’ Lambdaå…è®¸æŠŠå‡½æ•°ä½œä¸ºä¸€ä¸ªæ–¹æ³•çš„å‚æ•°ï¼ˆå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’è¿›æ–¹æ³•ä¸­)ã€‚
- **æ–¹æ³•å¼•ç”¨** âˆ’ æ–¹æ³•å¼•ç”¨æä¾›äº†éå¸¸æœ‰ç”¨çš„è¯­æ³•ï¼Œå¯ä»¥ç›´æ¥å¼•ç”¨å·²æœ‰Javaç±»æˆ–å¯¹è±¡ï¼ˆå®ä¾‹ï¼‰çš„æ–¹æ³•æˆ–æ„é€ å™¨ã€‚ä¸lambdaè”åˆä½¿ç”¨ï¼Œæ–¹æ³•å¼•ç”¨å¯ä»¥ä½¿è¯­è¨€çš„æ„é€ æ›´ç´§å‡‘ç®€æ´ï¼Œå‡å°‘å†—ä½™ä»£ç ã€‚
- **é»˜è®¤æ–¹æ³•** âˆ’ é»˜è®¤æ–¹æ³•å°±æ˜¯ä¸€ä¸ªåœ¨æ¥å£é‡Œé¢æœ‰äº†ä¸€ä¸ªå®ç°çš„æ–¹æ³•ã€‚
- **æ–°å·¥å…·** âˆ’ æ–°çš„ç¼–è¯‘å·¥å…·ï¼Œå¦‚ï¼šNashornå¼•æ“ jjsã€ ç±»ä¾èµ–åˆ†æå™¨jdepsã€‚
- **Stream API** âˆ’æ–°æ·»åŠ çš„Stream APIï¼ˆjava.util.streamï¼‰ æŠŠçœŸæ­£çš„å‡½æ•°å¼ç¼–ç¨‹é£æ ¼å¼•å…¥åˆ°Javaä¸­ã€‚
- **Date Time API** âˆ’ åŠ å¼ºå¯¹æ—¥æœŸä¸æ—¶é—´çš„å¤„ç†ã€‚
- **Optional ç±»** âˆ’ Optional ç±»å·²ç»æˆä¸º Java 8 ç±»åº“çš„ä¸€éƒ¨åˆ†ï¼Œç”¨æ¥è§£å†³ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚
- **Nashorn, JavaScript å¼•æ“** âˆ’ Java 8æä¾›äº†ä¸€ä¸ªæ–°çš„Nashorn javascriptå¼•æ“ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨JVMä¸Šè¿è¡Œç‰¹å®šçš„javascriptåº”ç”¨ã€‚

### é‡è½½ï¼ˆOverloadingï¼‰å’Œé‡å†™ï¼ˆOverridingï¼‰çš„åŒºåˆ«ï¼Ÿ
1. é‡è½½ï¼ˆOverloadingï¼‰
é‡è½½æ˜¯æŒ‡åœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³•åç›¸åŒä½†å‚æ•°åˆ—è¡¨ä¸åŒï¼ˆå‚æ•°çš„é¡ºåºã€ç±»å‹ã€æ•°é‡ä¸åŒï¼‰çš„å¤šä¸ªæ–¹æ³•ã€‚é‡è½½å…è®¸æˆ‘ä»¬æ ¹æ®ä¸åŒçš„è¾“å…¥å‚æ•°å¯¹åŒä¸€ä¸ªæ–¹æ³•åè¿›è¡Œå¤šæ¬¡å®šä¹‰ã€‚
```java
class Printer {
    void print(int number) {
        System.out.println("æ‰“å°æ•´æ•°: " + number);
    }

    void print(double number) {
        System.out.println("æ‰“å°æµ®ç‚¹æ•°: " + number);
    }

    void print(String text) {
        System.out.println("æ‰“å°æ–‡æœ¬: " + text);
    }
}
```

2. é‡å†™ï¼ˆOverridingï¼‰

é‡å†™æ˜¯æŒ‡å­ç±»ç»§æ‰¿çˆ¶ç±»æ—¶ï¼Œå­ç±»ä¸­é‡æ–°å®šä¹‰äº†çˆ¶ç±»ä¸­çš„æ–¹æ³•ã€‚é‡å†™çš„æ–¹æ³•å¿…é¡»ä¸çˆ¶ç±»æ–¹æ³•å…·æœ‰ç›¸åŒçš„æ–¹æ³•åã€å‚æ•°åˆ—è¡¨å’Œè¿”å›ç±»å‹ã€‚é‡å†™çš„ç›®çš„æ˜¯ä¸ºäº†è®©å­ç±»å¯ä»¥æä¾›ä¸çˆ¶ç±»ç›¸åŒçš„æ–¹æ³•åï¼Œä½†å…·æœ‰ä¸åŒçš„å®ç°ï¼Œä»è€Œå®ç°å¤šæ€ã€‚
```java
class Shape {
    double area() {
        return 0;
    }
}

class Circle extends Shape {
    double radius;

    Circle(double radius) {
        this.radius = radius;
    }

    @Override
    double area() {
        return Math.PI * radius * radius;
    }
}

class Rectangle extends Shape {
    double width, height;

    Rectangle(double width, double height) {
        this.width = width;
        this.height = height;
    }

    @Override
    double area() {
        return width * height;
    }
}
```

åœ¨é¢è¯•ä¸­ä»‹ç»è¿™ä¸¤ä¸ªæ¦‚å¿µæ—¶ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š
1. é¦–å…ˆå®šä¹‰é‡è½½å’Œé‡å†™ï¼Œå¼ºè°ƒå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚
2. ä¸¾ä¾‹è¯´æ˜é‡è½½å’Œé‡å†™çš„åº”ç”¨åœºæ™¯ã€‚
3. æåŠé‡è½½å’Œé‡å†™åœ¨ä»£ç å®ç°ä¸Šçš„è§„åˆ™ï¼ˆæ–¹æ³•åã€å‚æ•°åˆ—è¡¨ã€è¿”å›ç±»å‹ï¼‰ã€‚
4. å¯ä»¥ç®€è¦æåŠé‡è½½å’Œé‡å†™åœ¨å®ç°å¤šæ€å’Œä»£ç å¯è¯»æ€§æ–¹é¢çš„ä½œç”¨ã€‚

![image-20220617164632798](./personal_images/image-20220617164632798.webp)

![image-20220617164418584](./personal_images/image-20220617164418584.webp)

### å†…éƒ¨ç±»äº†è§£å—ï¼Ÿ

åœ¨Javaä¸­ï¼Œå¯ä»¥å°†â¼€ä¸ªç±»çš„å®šä¹‰æ”¾åœ¨å¦å¤–â¼€ä¸ªç±»çš„å®šä¹‰å†…éƒ¨ï¼Œè¿™å°±æ˜¯ å†…éƒ¨ç±» ã€‚å†…éƒ¨ç±»æœ¬èº«å°± æ˜¯ç±»çš„â¼€
ä¸ªå±æ€§ï¼Œä¸å…¶ä»–å±æ€§å®šä¹‰â½…å¼â¼€è‡´ã€‚

å†…éƒ¨ç±»å¯ä»¥åˆ†ä¸ºå››ç§ï¼š

æˆå‘˜å†…éƒ¨ç±»ï¼šåœ¨ä¸€ä¸ªç±»ä¸­ç›´æ¥å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œæˆå‘˜å†…éƒ¨ç±»ä¸æ™®é€šç±»çš„æˆå‘˜æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå¯ä»¥ä¸æ™®é€šæˆå‘˜ä¸€æ ·è¿›è¡Œä¿®é¥°å’Œé™åˆ¶ã€‚

```java
class Circle {
    double radius = 0;
   
    public Circle(double radius) {
        this.radius = radius;
    }
   
    class Draw {     //å†…éƒ¨ç±»
        public void drawSahpe() {
            System.out.println("drawshape");
        }
    }
}
```

å±€éƒ¨å†…éƒ¨ç±»ï¼šåœ¨æ–¹æ³•ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ç§°ä¸ºå±€éƒ¨å†…éƒ¨ç±»ã€‚ä¸å±€éƒ¨å˜é‡ç±»ä¼¼

```java
class People{
    public People() {
       
    }
}
 
class Man{
    public Man(){
       
    }
   
    public People getWoman(){
        class Woman extends People{   //å±€éƒ¨å†…éƒ¨ç±»
            int age =0;
        }
        return new Woman();
    }
}
```

åŒ¿åå†…éƒ¨ç±»ï¼šåŒ¿åå†…éƒ¨ç±»å°±æ˜¯æ²¡æœ‰åå­—çš„å†…éƒ¨ç±»

é™æ€å†…éƒ¨ç±»ï¼ˆ**åµŒå¥—ç±»**ï¼‰ï¼šå¦‚æœä½ ä¸éœ€è¦å†…éƒ¨ç±»å¯¹è±¡ä¸å…¶å¤–å›´ç±»å¯¹è±¡ä¹‹é—´æœ‰è”ç³»ï¼Œé‚£ä½ å¯ä»¥å°†å†…éƒ¨ç±»å£°æ˜ä¸ºstatic

```java
public class Test {
    public static void main(String[] args)  {
        Outter.Inner inner = new Outter.Inner();
    }
}
 
class Outter {
    public Outter() {
       
    }
   
    static class Inner {
        public Inner() {
           
        }
    }
}
```

### HashSet å¦‚ä½•æ£€æŸ¥é‡å¤

æ€è·¯æ•´ç†ï¼šhashcodeç›¸åŒ -> equals() ä¸åŒ-> hashå†æ•£åˆ—

1. å½“ä½ æŠŠå¯¹è±¡åŠ â¼ŠHashSetæ—¶ï¼ŒHashSetä¼šå…ˆè®¡ç®—å¯¹è±¡çš„hashcodeå€¼æ¥åˆ¤æ–­å¯¹è±¡åŠ â¼Šçš„ä½ç½®ï¼ŒåŒæ—¶ä¹Ÿä¼šä¸å…¶ä»–å·²ç»åŠ â¼Šçš„å¯¹è±¡çš„hashcodeå€¼ä½œâ½è¾ƒ
2. å¦‚æœæ²¡æœ‰ç›¸ç¬¦çš„hashcodeï¼ŒHashSetä¼šå‡è®¾å¯¹è±¡æ²¡æœ‰é‡å¤å‡ºç°ã€‚ä½†æ˜¯**å¦‚æœå‘ç°æœ‰ç›¸åŒhashcodeå€¼çš„å¯¹è±¡ï¼Œè¿™æ—¶ä¼šè°ƒâ½¤equals()â½…æ³•**æ¥æ£€æŸ¥hashcodeç›¸ç­‰çš„å¯¹è±¡æ˜¯å¦çœŸçš„ç›¸åŒ
3. å¦‚æœä¸¤è€…ç›¸åŒï¼ŒHashSetå°±ä¸ä¼šè®©å…¶åŠ â¼Šæ“ä½œæˆåŠŸã€‚å¦‚æœä¸åŒçš„è¯ï¼Œå°±ä¼šé‡æ–°æ•£åˆ—åˆ°å…¶ä»–ä½ç½®ã€‚è¿™æ ·æˆ‘ä»¬å°±â¼¤â¼¤å‡å°‘äº†equalsçš„æ¬¡æ•°ï¼Œç›¸åº”å°±â¼¤â¼¤æâ¾¼äº†æ‰§â¾é€Ÿåº¦ã€‚

### æ„é€ â½…æ³•æœ‰å“ªäº›ç‰¹æ€§ï¼Ÿ

* åå­—ä¸ç±»åç›¸åŒ
* æ²¡æœ‰è¿”å›å€¼ï¼Œä½†ä¸èƒ½â½¤voidå£°æ˜æ„é€ å‡½æ•°
* â½£æˆç±»çš„å¯¹è±¡æ—¶â¾ƒåŠ¨æ‰§â¾ï¼Œâ½†éœ€è°ƒâ½¤

### final,static,this,super å…³é”®å­—æ€»ç»“

#### static

static å…³é”®å­—ä¸»è¦æœ‰ä»¥ä¸‹å››ç§ä½¿ç”¨åœºæ™¯ï¼š

1. **ä¿®é¥°æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•:** è¢« static ä¿®é¥°çš„æˆå‘˜å±äºç±»ï¼Œä¸å±äºå•ä¸ªè¿™ä¸ªç±»çš„æŸä¸ªå¯¹è±¡ï¼Œè¢«ç±»ä¸­æ‰€æœ‰å¯¹è±¡å…±äº«ï¼Œå¯ä»¥å¹¶ä¸”å»ºè®®é€šè¿‡ç±»åè°ƒç”¨ã€‚è¢« static å£°æ˜çš„æˆå‘˜å˜é‡å±äºé™æ€æˆå‘˜å˜é‡ï¼Œé™æ€å˜é‡ å­˜æ”¾åœ¨ Java å†…å­˜åŒºåŸŸçš„æ–¹æ³•åŒºã€‚è°ƒç”¨æ ¼å¼ï¼š`ç±»å.é™æ€å˜é‡å` `ç±»å.é™æ€æ–¹æ³•å()`
2. **é™æ€ä»£ç å—:** é™æ€ä»£ç å—å®šä¹‰åœ¨ç±»ä¸­æ–¹æ³•å¤–, é™æ€ä»£ç å—åœ¨éé™æ€ä»£ç å—ä¹‹å‰æ‰§è¡Œ(é™æ€ä»£ç å—â€”>éé™æ€ä»£ç å—â€”>æ„é€ æ–¹æ³•)ã€‚ è¯¥ç±»ä¸ç®¡åˆ›å»ºå¤šå°‘å¯¹è±¡ï¼Œé™æ€ä»£ç å—åªæ‰§è¡Œä¸€æ¬¡.
3. **é™æ€å†…éƒ¨ç±»ï¼ˆstatic ä¿®é¥°ç±»çš„è¯åªèƒ½ä¿®é¥°å†…éƒ¨ç±»ï¼‰ï¼š** é™æ€å†…éƒ¨ç±»ä¸éé™æ€å†…éƒ¨ç±»ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæœ€å¤§çš„åŒºåˆ«:  éé™æ€å†…éƒ¨ç±»åœ¨ç¼–è¯‘å®Œæˆä¹‹åä¼šéšå«åœ°ä¿å­˜ç€ä¸€ä¸ªå¼•ç”¨ï¼Œè¯¥å¼•ç”¨æ˜¯æŒ‡å‘åˆ›å»ºå®ƒçš„å¤–å›´ç±»ï¼Œä½†æ˜¯é™æ€å†…éƒ¨ç±»å´æ²¡æœ‰ã€‚æ²¡æœ‰è¿™ä¸ªå¼•ç”¨å°±æ„å‘³ç€ï¼š1.  å®ƒçš„åˆ›å»ºæ˜¯ä¸éœ€è¦ä¾èµ–å¤–å›´ç±»çš„åˆ›å»ºã€‚2. å®ƒä¸èƒ½ä½¿ç”¨ä»»ä½•å¤–å›´ç±»çš„é static æˆå‘˜å˜é‡å’Œæ–¹æ³•ã€‚
4. **é™æ€å¯¼åŒ…(ç”¨æ¥å¯¼å…¥ç±»ä¸­çš„é™æ€èµ„æºï¼Œ1.5 ä¹‹åçš„æ–°ç‰¹æ€§):** æ ¼å¼ä¸ºï¼š`import static` è¿™ä¸¤ä¸ªå…³é”®å­—è¿ç”¨å¯ä»¥æŒ‡å®šå¯¼å…¥æŸä¸ªç±»ä¸­çš„æŒ‡å®šé™æ€èµ„æºï¼Œå¹¶ä¸”ä¸éœ€è¦ä½¿ç”¨ç±»åè°ƒç”¨ç±»ä¸­é™æ€æˆå‘˜ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ç±»ä¸­é™æ€æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•ã€‚

#### final

**final å…³é”®å­—ï¼Œæ„æ€æ˜¯æœ€ç»ˆçš„ã€ä¸å¯ä¿®æ”¹çš„ï¼Œæœ€è§ä¸å¾—å˜åŒ– ï¼Œç”¨æ¥ä¿®é¥°ç±»ã€æ–¹æ³•å’Œå˜é‡ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š**

1. final ä¿®é¥°çš„ç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼Œfinal ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•éƒ½ä¼šè¢«éšå¼çš„æŒ‡å®šä¸º final æ–¹æ³•ï¼›
2. final ä¿®é¥°çš„æ–¹æ³•ä¸èƒ½è¢«é‡å†™ï¼›
3. final ä¿®é¥°çš„å˜é‡æ˜¯å¸¸é‡ï¼Œå¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡ï¼Œåˆ™å…¶æ•°å€¼ä¸€æ—¦åœ¨åˆå§‹åŒ–ä¹‹åä¾¿ä¸èƒ½æ›´æ”¹ï¼›å¦‚æœæ˜¯å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œåˆ™åœ¨å¯¹å…¶åˆå§‹åŒ–ä¹‹åä¾¿ä¸èƒ½è®©å…¶æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡ã€‚

è¯´æ˜ï¼šä½¿ç”¨ final æ–¹æ³•çš„åŸå› æœ‰ä¸¤ä¸ªã€‚ç¬¬ä¸€ä¸ªåŸå› æ˜¯æŠŠæ–¹æ³•é”å®šï¼Œä»¥é˜²ä»»ä½•ç»§æ‰¿ç±»ä¿®æ”¹å®ƒçš„å«ä¹‰ï¼›ç¬¬äºŒä¸ªåŸå› æ˜¯æ•ˆç‡ã€‚åœ¨æ—©æœŸçš„ Java å®ç°ç‰ˆæœ¬ä¸­ï¼Œä¼šå°†  final æ–¹æ³•è½¬ä¸ºå†…åµŒè°ƒç”¨ã€‚ä½†æ˜¯å¦‚æœæ–¹æ³•è¿‡äºåºå¤§ï¼Œå¯èƒ½çœ‹ä¸åˆ°å†…åµŒè°ƒç”¨å¸¦æ¥çš„ä»»ä½•æ€§èƒ½æå‡ï¼ˆç°åœ¨çš„ Java ç‰ˆæœ¬å·²ç»ä¸éœ€è¦ä½¿ç”¨ final  æ–¹æ³•è¿›è¡Œè¿™äº›ä¼˜åŒ–äº†ï¼‰ã€‚ç±»ä¸­æ‰€æœ‰çš„ private æ–¹æ³•éƒ½éšå¼åœ°æŒ‡å®šä¸º finalã€‚

#### this

this å…³é”®å­—ç”¨äºå¼•ç”¨ç±»çš„å½“å‰å®ä¾‹ã€‚ ä¾‹å¦‚ï¼š

```java
class Manager {
    Employees[] employees;
    void manageEmployees() {
        int totalEmp = this.employees.length;
        System.out.println("Total employees: " + totalEmp);
        this.report();
    }
    void report() { }
}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œthis å…³é”®å­—ç”¨äºä¸¤ä¸ªåœ°æ–¹ï¼š

- this.employees.lengthï¼šè®¿é—®ç±» Manager çš„å½“å‰å®ä¾‹çš„å˜é‡ã€‚
- this.reportï¼ˆï¼‰ï¼šè°ƒç”¨ç±» Manager çš„å½“å‰å®ä¾‹çš„æ–¹æ³•ã€‚

æ­¤å…³é”®å­—æ˜¯å¯é€‰çš„ï¼Œè¿™æ„å‘³ç€å¦‚æœä¸Šé¢çš„ç¤ºä¾‹åœ¨ä¸ä½¿ç”¨æ­¤å…³é”®å­—çš„æƒ…å†µä¸‹è¡¨ç°ç›¸åŒã€‚ ä½†æ˜¯ï¼Œä½¿ç”¨æ­¤å…³é”®å­—å¯èƒ½ä¼šä½¿ä»£ç æ›´æ˜“è¯»æˆ–æ˜“æ‡‚ã€‚

#### super å…³é”®å­—

super å…³é”®å­—ç”¨äºä»å­ç±»è®¿é—®çˆ¶ç±»çš„å˜é‡å’Œæ–¹æ³•ã€‚ ä¾‹å¦‚ï¼š

```java
public class Super {
    protected int number;
    protected showNumber() {
        System.out.println("number = " + number);
    }
}
public class Sub extends Super {
    void bar() {
        super.number = 10;
        super.showNumber();
    }
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒSub ç±»è®¿é—®çˆ¶ç±»æˆå‘˜å˜é‡ number å¹¶è°ƒç”¨å…¶çˆ¶ç±» Super çš„ `showNumberï¼ˆï¼‰` æ–¹æ³•ã€‚

**ä½¿ç”¨ this å’Œ super è¦æ³¨æ„çš„é—®é¢˜ï¼š**

- åœ¨æ„é€ å™¨ä¸­ä½¿ç”¨ `super()` è°ƒç”¨çˆ¶ç±»ä¸­çš„å…¶ä»–æ„é€ æ–¹æ³•æ—¶ï¼Œè¯¥è¯­å¥å¿…é¡»å¤„äºæ„é€ å™¨çš„é¦–è¡Œï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚å¦å¤–ï¼Œthis è°ƒç”¨æœ¬ç±»ä¸­çš„å…¶ä»–æ„é€ æ–¹æ³•æ—¶ï¼Œä¹Ÿè¦æ”¾åœ¨é¦–è¡Œã€‚
- thisã€super ä¸èƒ½ç”¨åœ¨ static æ–¹æ³•ä¸­ã€‚

**ç®€å•è§£é‡Šä¸€ä¸‹ï¼š**

è¢« static ä¿®é¥°çš„æˆå‘˜å±äºç±»ï¼Œä¸å±äºå•ä¸ªè¿™ä¸ªç±»çš„æŸä¸ªå¯¹è±¡ï¼Œè¢«ç±»ä¸­æ‰€æœ‰å¯¹è±¡å…±äº«ã€‚è€Œ this ä»£è¡¨å¯¹æœ¬ç±»å¯¹è±¡çš„å¼•ç”¨ï¼ŒæŒ‡å‘æœ¬ç±»å¯¹è±¡ï¼›è€Œ super ä»£è¡¨å¯¹çˆ¶ç±»å¯¹è±¡çš„å¼•ç”¨ï¼ŒæŒ‡å‘çˆ¶ç±»å¯¹è±¡ï¼›æ‰€ä»¥ï¼Œ **this å’Œ super æ˜¯å±äºå¯¹è±¡èŒƒç•´çš„ä¸œè¥¿ï¼Œè€Œé™æ€æ–¹æ³•æ˜¯å±äºç±»èŒƒç•´çš„ä¸œè¥¿**ã€‚

### thisä¸superçš„åŒºåˆ«

* super:å®ƒå¼•â½¤å½“å‰å¯¹è±¡çš„ç›´æ¥â½—ç±»ä¸­çš„æˆå‘˜ï¼ˆâ½¤æ¥è®¿é—®ç›´æ¥â½—ç±»ä¸­è¢«éšè—çš„â½—ç±»ä¸­æˆå‘˜æ•°æ®æˆ–å‡½æ•°ï¼ŒåŸºç±»ä¸æ´¾â½£ç±»ä¸­æœ‰ç›¸åŒæˆå‘˜å®šä¹‰æ—¶å¦‚ï¼šsuper.å˜é‡åsuper.æˆå‘˜å‡½æ•°æ®åï¼ˆå®å‚ï¼‰
* thisï¼šå®ƒä»£è¡¨å½“å‰å¯¹è±¡åï¼ˆåœ¨ç¨‹åºä¸­æ˜“äº§â½£â¼†ä¹‰æ€§ä¹‹å¤„ï¼Œåº”ä½¿â½¤thisæ¥æŒ‡æ˜å½“å‰å¯¹è±¡ï¼›å¦‚æœå‡½æ•°çš„å½¢å‚ä¸ç±»ä¸­çš„æˆå‘˜æ•°æ®åŒåï¼Œè¿™æ—¶éœ€â½¤thisæ¥æŒ‡æ˜æˆå‘˜å˜é‡åï¼‰
* ğŸ‘»super()å’Œthis()ç±»ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼šsuper()åœ¨â¼¦ç±»ä¸­è°ƒâ½¤â½—ç±»çš„æ„é€ â½…æ³•ï¼Œthis()åœ¨æœ¬ç±»å†…è°ƒâ½¤æœ¬ç±»çš„å…¶å®ƒæ„é€ â½…æ³•ã€‚
* ğŸ‘»super()å’Œthis()å‡éœ€æ”¾åœ¨æ„é€ â½…æ³•å†…ç¬¬â¼€â¾ã€‚
* ğŸ‘»thiså’Œsuperä¸èƒ½åŒæ—¶å‡ºç°åœ¨â¼€ä¸ªæ„é€ å‡½æ•°â¾¥â¾¯ï¼Œå› ä¸ºthiså¿…ç„¶ä¼šè°ƒâ½¤å…¶å®ƒçš„æ„é€ å‡½æ•°ï¼Œå…¶å®ƒçš„æ„é€ å‡½æ•°å¿…ç„¶ä¹Ÿä¼šæœ‰superè¯­å¥çš„å­˜åœ¨ï¼Œæ‰€ä»¥åœ¨åŒâ¼€ä¸ªæ„é€ å‡½æ•°â¾¥â¾¯æœ‰ç›¸åŒçš„è¯­å¥ï¼Œå°±å¤±å»äº†è¯­å¥çš„æ„ä¹‰ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä¼šé€šè¿‡ã€‚
* this()å’Œsuper()éƒ½æŒ‡çš„æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥ï¼Œå‡ä¸å¯ä»¥åœ¨staticç¯å¢ƒä¸­ä½¿â½¤ã€‚åŒ…æ‹¬ï¼šstaticå˜é‡,staticâ½…æ³•ï¼Œstaticè¯­å¥å—ã€‚
* ğŸ‘»ä»æœ¬è´¨ä¸Šè®²ï¼Œthisæ˜¯â¼€ä¸ªæŒ‡å‘æœ¬å¯¹è±¡çš„æŒ‡é’ˆ,ç„¶â½½superæ˜¯â¼€ä¸ªJavaå…³é”®å­—ã€‚

### é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†

#### æ¦‚è¿°

ä»£ç†æ¨¡å¼å°±æ˜¯ **ä½¿ç”¨ä»£ç†å¯¹è±¡æ¥ä»£æ›¿å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸ä¿®æ”¹åŸç›®æ ‡å¯¹è±¡çš„å‰æä¸‹ï¼Œæä¾›é¢å¤–çš„åŠŸèƒ½æ“ä½œï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚**

ä»£ç†æ¨¡å¼å¤§è‡´æœ‰ä¸‰ç§è§’è‰²ï¼š

- Real Subjectï¼šçœŸå®ç±»ï¼Œä¹Ÿå°±æ˜¯è¢«ä»£ç†ç±»ã€å§”æ‰˜ç±»ã€‚ç”¨æ¥çœŸæ­£å®Œæˆä¸šåŠ¡æœåŠ¡åŠŸèƒ½ï¼›
- Proxyï¼šä»£ç†ç±»ã€‚å°†è‡ªèº«çš„è¯·æ±‚ç”¨ Real Subject å¯¹åº”çš„åŠŸèƒ½æ¥å®ç°ï¼Œä»£ç†ç±»å¯¹è±¡å¹¶ä¸çœŸæ­£çš„å»å®ç°å…¶ä¸šåŠ¡åŠŸèƒ½ï¼›
- Subjectï¼šå®šä¹‰ RealSubject å’Œ Proxy è§’è‰²éƒ½åº”è¯¥å®ç°çš„æ¥å£ã€‚

![img](./personal_images/20210221222746.webp)

é€šä¿—æ¥è¯´ï¼Œ**ä»£ç†æ¨¡å¼çš„ä¸»è¦ä½œç”¨æ˜¯æ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è¯´åœ¨ç›®æ ‡å¯¹è±¡çš„æŸä¸ªæ–¹æ³•æ‰§è¡Œå‰åä½ å¯ä»¥å¢åŠ ä¸€äº›é¢å¤–çš„æ“ä½œï¼Œå¹¶ä¸”ä¸ç”¨ä¿®æ”¹è¿™ä¸ªæ–¹æ³•çš„åŸæœ‰ä»£ç **ã€‚å¦‚æœå¤§å®¶å­¦è¿‡ Spring çš„ AOPï¼Œä¸€å®šèƒ½å¤Ÿå¾ˆå¥½çš„ç†è§£è¿™å¥è¯ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šä½ æ‰¾äº†å°çº¢æ¥å¸®ä½ å‘å°ç»¿é—®è¯ï¼Œå°çº¢å°±çœ‹ä½œæ˜¯ä»£ç†æˆ‘çš„ä»£ç†ç±» Proxyï¼Œè€Œä½ æ˜¯ Real Subjectï¼Œå› ä¸ºå°çº¢è¦ä¼ è¾¾çš„è¯å…¶å®æ˜¯ä½ è¯´çš„ã€‚é‚£ä¹ˆä½ å’Œå°çº¢éƒ½éœ€è¦å®ç°çš„æ¥å£ï¼ˆSubjectï¼‰å°±æ˜¯è¯´è¯ï¼Œç”±äºä½ ä¿©éƒ½èƒ½è¯´è¯ï¼Œåœ¨å¤–ç•Œçœ‹æ¥ä½ ä¿©å°±æ˜¯ä¸€æ ·çš„

![image-20220723002924420](./personal_images/image-20220723002924420.webp)

çœ‹åˆ°è¿™é‡Œï¼Œä¸çŸ¥é“å¤§å®¶èƒ½ä¸èƒ½ç†è§£äº†ä¸ºä»€ä¹ˆå§”æ‰˜ç±»å’Œä»£ç†ç±»éƒ½éœ€è¦å®ç°ç›¸åŒçš„æ¥å£ï¼Ÿ

é‚£æ˜¯ä¸ºäº†ä¿æŒè¡Œä¸ºçš„ä¸€è‡´æ€§ï¼Œåœ¨è®¿é—®è€…çœ‹æ¥ä¸¤è€…ä¹‹é—´å°±æ²¡æœ‰åŒºåˆ«ã€‚è¿™æ ·ï¼Œé€šè¿‡ä»£ç†ç±»è¿™ä¸ªä¸­é—´å±‚ï¼Œå¾ˆå¥½åœ°éšè—å’Œä¿æŠ¤äº†å§”æ‰˜ç±»å¯¹è±¡ï¼Œèƒ½**æœ‰æ•ˆå±è”½å¤–ç•Œå¯¹å§”æ‰˜ç±»å¯¹è±¡çš„ç›´æ¥è®¿é—®**ã€‚åŒæ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨ä»£ç†ç±»ä¸ŠåŠ ä¸Šé¢å¤–çš„æ“ä½œï¼Œæ¯”å¦‚**å°çº¢åœ¨è¯´è¯ä¹‹å‰ä¼šè·³ä¸€æ®µèˆï¼Œå¤–ç•Œå°±ä¼šè§‰å¾—ä½ åœ¨è¯´è¯å‰ä¼šè·³ä¸€æ®µèˆï¼Œæ‰€ä»¥ï¼Œè¿™å°±å®ç°äº†å§”æ‰˜ç±»çš„åŠŸèƒ½å¢å¼º**ã€‚

ä»£ç†æ¨¡å¼æœ‰é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¸¤ç§å®ç°æ–¹å¼ã€‚

#### é™æ€ä»£ç†

å…ˆæ¥çœ‹é™æ€ä»£ç†çš„å®ç°æ­¥éª¤ï¼š

1ï¼‰å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ˆSubjectï¼‰

2ï¼‰åˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰å®ç°è¿™ä¸ªæ¥å£

3ï¼‰åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼ˆProxyï¼‰åŒæ ·å®ç°è¿™ä¸ªæ¥å£

4ï¼‰**å°†å§”æ‰˜ç±» Real Subject æ³¨å…¥è¿›ä»£ç†ç±» Proxy**ï¼Œåœ¨ä»£ç†ç±»çš„æ–¹æ³•ä¸­è°ƒç”¨ Real Subject ä¸­çš„å¯¹åº”æ–¹æ³•ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»£ç†ç±»å±è”½å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰ååšä¸€äº›è‡ªå·±æƒ³åšçš„äº‹æƒ…ã€‚

ä»å®ç°å’Œåº”ç”¨è§’åº¦æ¥è¯´ï¼Œé™æ€ä»£ç†ä¸­ï¼Œæˆ‘ä»¬å¯¹ç›®æ ‡å¯¹è±¡çš„æ¯ä¸ªæ–¹æ³•çš„å¢å¼ºéƒ½æ˜¯æ‰‹åŠ¨å®Œæˆçš„ï¼Œéå¸¸ä¸çµæ´»ï¼ˆæ¯”å¦‚æ¥å£ä¸€æ—¦æ–°å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹ï¼‰ä¸”éº»çƒ¦ï¼ˆéœ€è¦å¯¹æ¯ä¸ªç›®æ ‡ç±»éƒ½å•ç‹¬å†™ä¸€ä¸ªä»£ç†ç±»ï¼‰ã€‚ å®é™…åº”ç”¨åœºæ™¯éå¸¸éå¸¸å°‘ï¼Œæ—¥å¸¸å¼€å‘å‡ ä¹çœ‹ä¸åˆ°ä½¿ç”¨é™æ€ä»£ç†çš„åœºæ™¯ã€‚

ä» JVM å±‚é¢æ¥è¯´ï¼Œ **é™æ€ä»£ç†åœ¨ç¼–è¯‘æ—¶å°±å°†æ¥å£ã€å§”æ‰˜ç±»ã€ä»£ç†ç±»è¿™äº›éƒ½å˜æˆäº†ä¸€ä¸ªä¸ªå®é™…çš„ `.class` æ–‡ä»¶ã€‚**

1ï¼‰å®šä¹‰å‘é€çŸ­ä¿¡çš„æ¥å£

```java
public interface SmsService {
    String send(String message);
}
```

2ï¼‰åˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰å®ç°è¿™ä¸ªæ¥å£

```java
public class SmsServiceImpl implements SmsService {
    public String send(String message) {
        System.out.println("send message:" + message);
        return message;
    }
}
```

3ï¼‰åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼ˆProxyï¼‰åŒæ ·å®ç°è¿™ä¸ªæ¥å£

4ï¼‰å°†å§”æ‰˜ç±» Real Subject æ³¨å…¥è¿›ä»£ç†ç±» Proxyï¼Œåœ¨ä»£ç†ç±»çš„æ–¹æ³•ä¸­è°ƒç”¨ Real Subject ä¸­çš„å¯¹åº”æ–¹æ³•ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»£ç†ç±»å±è”½å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰ååšä¸€äº›è‡ªå·±æƒ³åšçš„äº‹æƒ…ã€‚

```java
public class SmsProxy implements SmsService {

    // å°†å§”æ‰˜ç±»æ³¨å…¥è¿›ä»£ç†ç±»
    private final SmsService smsService;

    public SmsProxy(SmsService smsService) {
        this.smsService = smsService;
    }

    @Override
    public String send(String message) {
        // è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("before method send()");
        // è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•
        smsService.send(message); 
        // è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("after method send()");
        return null;
    }
}
```

é‚£ä¹ˆï¼Œå¦‚ä½•ä½¿ç”¨è¿™ä¸ªè¢«å¢å¼ºçš„ `send` æ–¹æ³•å‘¢ï¼Ÿ

```java
public class Main {
    public static void main(String[] args) {
        SmsService smsService = new SmsServiceImpl();
        SmsProxy smsProxy = new SmsProxy(smsService);
        smsProxy.send("Java");
    }
}
```

è¿è¡Œä¸Šè¿°ä»£ç ä¹‹åï¼Œæ§åˆ¶å°æ‰“å°å‡ºï¼š

```bash
before method send()
send message:java
after method send()
```

ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å·²ç»å¢å¼ºäº†å§”æ‰˜ç±» `SmsServiceImpl`  çš„ `send()` æ–¹æ³•ã€‚

å½“ç„¶ï¼Œä»ä¸Šè¿°ä»£ç æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œé™æ€ä»£ç†å­˜åœ¨ä¸€å®šçš„å¼Šç«¯ã€‚å‡å¦‚è¯´æˆ‘ä»¬ç°åœ¨æ–°å¢äº†ä¸€ä¸ªå§”æ‰˜ç±»å®ç°äº† `SmsService` æ¥å£ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹è¿™ä¸ªå§”æ‰˜ç±»è¿›è¡Œå¢å¼ºï¼Œå°±éœ€è¦é‡æ–°å†™ä¸€ä¸ªä»£ç†ç±»ï¼Œç„¶åæ³¨å…¥è¿™ä¸ªæ–°çš„å§”æ‰˜ç±»ï¼Œéå¸¸ä¸çµæ´»ã€‚ä¹Ÿå°±æ˜¯è¯´é™æ€ä»£ç†æ˜¯ä¸€ä¸ªå§”æ‰˜äº†å¯¹åº”ä¸€ä¸ªä»£ç†ç±»ï¼Œèƒ½ä¸èƒ½**å°†ä»£ç†ç±»åšæˆä¸€ä¸ªé€šç”¨çš„**å‘¢ï¼Ÿä¸ºæ­¤ï¼ŒåŠ¨æ€ä»£ç†åº”ç”¨è€Œç”Ÿã€‚



#### Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶

åœ¨è®²è§£åŠ¨æ€ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦è¯¦ç»†è¯´ä¸€ä¸‹ `.class` å­—èŠ‚ç æ–‡ä»¶è¿™ä¸ªä¸œè¥¿ã€‚åŠ¨æ€ä»£ç†æœºåˆ¶å’Œ Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶æ¯æ¯ç›¸å…³ã€‚

åœ¨ä¸Šæ–‡åå°„ä¸­æˆ‘ä»¬æåˆ°ï¼Œä¸€ä¸ª `Class` ç±»å¯¹åº”ä¸€ä¸ª `.class` å­—èŠ‚ç æ–‡ä»¶ï¼Œä¹Ÿå°±è¯´å­—èŠ‚ç æ–‡ä»¶ä¸­å­˜å‚¨äº†ä¸€ä¸ªç±»çš„å…¨éƒ¨ä¿¡æ¯ã€‚å­—èŠ‚ç å…¶å®æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå†…å®¹æ˜¯åªæœ‰ JVM èƒ½å¤Ÿè¯†åˆ«çš„æœºå™¨ç ã€‚

è§£æè¿‡ç¨‹è¿™æ ·çš„ï¼šJVM è¯»å– `.class` å­—èŠ‚ç æ–‡ä»¶ï¼Œå–å‡ºäºŒè¿›åˆ¶æ•°æ®ï¼ŒåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè§£æå­—èŠ‚ç æ–‡ä»¶å†…çš„ä¿¡æ¯ï¼Œç”Ÿæˆå¯¹åº”çš„ `Class` ç±»å¯¹è±¡ï¼š

![image-20220723003010392](./personal_images/image-20220723003010392.webp)

æ˜¾ç„¶ï¼Œä¸Šè¿°è¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨ç¼–è¯‘æœŸå°±å‘ç”Ÿçš„ã€‚

é‚£ä¹ˆï¼Œç”±äºJVM æ˜¯é€šè¿‡ `.class` å­—èŠ‚ç æ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶ä¿¡æ¯ï¼‰åŠ è½½ç±»çš„ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¿è¡ŒæœŸéµå¾ª Java ç¼–è¯‘ç³»ç»Ÿç»„ç»‡ `.class` å­—èŠ‚ç æ–‡ä»¶çš„æ ¼å¼å’Œç»“æ„ï¼Œç”Ÿæˆç›¸åº”çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œç„¶åå†æŠŠè¿™ä¸ªäºŒè¿›åˆ¶æ•°æ®åŠ è½½è½¬æ¢æˆå¯¹åº”çš„ç±»ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¸å°±å®Œæˆäº†åœ¨è¿è¡Œæ—¶åŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªç±»ã€‚è¿™ä¸ªæ€æƒ³å…¶å®ä¹Ÿå°±æ˜¯åŠ¨æ€ä»£ç†çš„æ€æƒ³ã€‚

![image-20220723003018675](./personal_images/image-20220723003018675.webp)

åœ¨è¿è¡Œæ—¶æœŸæŒ‰ç…§ JVM è§„èŒƒå¯¹ `.class` å­—èŠ‚ç æ–‡ä»¶çš„ç»„ç»‡è§„åˆ™ï¼Œç”Ÿæˆå¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®ã€‚å½“å‰æœ‰å¾ˆå¤šå¼€æºæ¡†æ¶å¯ä»¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ï¼Œå¦‚

- ASM
- CGLIB
- Javassist
- ......

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**CGLIB æ˜¯åŸºäº ASM çš„**ã€‚ è¿™é‡Œç®€å•å¯¹æ¯”ä¸€ä¸‹ ASM å’Œ Javassistï¼š

- Javassist æºä»£ç çº§ API æ¯” ASM ä¸­å®é™…çš„å­—èŠ‚ç æ“ä½œæ›´å®¹æ˜“ä½¿ç”¨
- Javassist åœ¨å¤æ‚çš„å­—èŠ‚ç çº§æ“ä½œä¸Šæä¾›äº†æ›´é«˜çº§åˆ«çš„æŠ½è±¡å±‚ã€‚Javassist æºä»£ç çº§ API åªéœ€è¦å¾ˆå°‘çš„å­—èŠ‚ç çŸ¥è¯†ï¼Œç”šè‡³ä¸éœ€è¦ä»»ä½•å®é™…å­—èŠ‚ç çŸ¥è¯†ï¼Œå› æ­¤å®ç°èµ·æ¥æ›´å®¹æ˜“ã€æ›´å¿«ã€‚
- Javassist ä½¿ç”¨åå°„æœºåˆ¶ï¼Œè¿™ä½¿å¾—å®ƒæ¯” ASM æ…¢ã€‚

**æ€»çš„æ¥è¯´ ASM æ¯” Javassist å¿«å¾—å¤šï¼Œå¹¶ä¸”æä¾›äº†æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯ Javassist ç›¸å¯¹æ¥è¯´æ›´å®¹æ˜“ä½¿ç”¨**ï¼Œä¸¤è€…å„æœ‰åƒç§‹ã€‚

ä»¥ Javassist ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›æ¡†æ¶åœ¨è¿è¡Œæ—¶ç”Ÿæˆ `.class` å­—èŠ‚ç æ–‡ä»¶çš„å¼ºå¤§èƒ½åŠ›ã€‚

æ­£å¸¸æ¥è¯´ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```java
package com.samples;

public class Programmer {
    public void code(){
        System.out.println("I'm a Programmer,Just Coding.....");
    }
}
```

ä¸‹é¢é€šè¿‡ Javassist åˆ›å»ºå’Œä¸Šé¢ä¸€æ¨¡ä¸€æ ·çš„ `Programmer` ç±»çš„å­—èŠ‚ç ï¼š

```java
import javassist.ClassPool;
import javassist.CtClass;
import javassist.CtMethod;
import javassist.CtNewMethod;

public class MyGenerator {
    public static void main(String[] args) throws Exception {
        ClassPool pool = ClassPool.getDefault();
          // åˆ›å»º Programmer ç±»        
        CtClass cc= pool.makeClass("com.samples.Programmer");
        // å®šä¹‰æ–¹æ³•
        CtMethod method = CtNewMethod.make("public void code(){}", cc);
        // æ’å…¥æ–¹æ³•ä»£ç 
        method.insertBefore("System.out.println(\"I'm a Programmer,Just Coding.....\");");
        cc.addMethod(method);
        // ä¿å­˜ç”Ÿæˆçš„å­—èŠ‚ç 
        cc.writeFile("d://temp");
    }
}
```

é€šè¿‡åç¼–è¯‘å·¥å…·æ‰“å¼€ `Programmer.class` å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ä»£ç ï¼š

![image-20220723003032359](./personal_images/image-20220723003032359.webp)



#### åŠ¨æ€ä»£ç†

äº†è§£äº† Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼Œå¯ä»¥å¼€å§‹å­¦ä¹ åŠ¨æ€ä»£ç†ï¼ˆDynamic Proxyï¼‰äº†ã€‚

å›é¡¾ä¸€ä¸‹é™æ€ä»£ç†ï¼Œæˆ‘ä»¬æŠŠé™æ€ä»£ç†çš„æ‰§è¡Œè¿‡ç¨‹æŠ½è±¡ä¸ºä¸‹å›¾ï¼š

![image-20220723003049255](./personal_images/image-20220723003049255.webp)

å¯ä»¥çœ‹è§ï¼Œä»£ç†ç±»æ— éæ˜¯åœ¨è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•çš„å‰åå¢åŠ äº†ä¸€äº›æ“ä½œã€‚å§”æ‰˜ç±»çš„ä¸åŒï¼Œä¹Ÿå°±å¯¼è‡´ä»£ç†ç±»çš„ä¸åŒã€‚

é‚£ä¹ˆä¸ºäº†åšä¸€ä¸ªé€šç”¨æ€§çš„ä»£ç†ç±»å‡ºæ¥ï¼Œæˆ‘ä»¬æŠŠè°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•çš„è¿™ä¸ªåŠ¨ä½œæŠ½å–å‡ºæ¥ï¼ŒæŠŠå®ƒå°è£…æˆä¸€ä¸ªé€šç”¨æ€§çš„å¤„ç†ç±»ï¼Œäºæ˜¯å°±æœ‰äº†åŠ¨æ€ä»£ç†ä¸­çš„ `InvocationHandler` è§’è‰²ï¼ˆå¤„ç†ç±»ï¼‰ã€‚

äºæ˜¯ï¼Œåœ¨ä»£ç†ç±»å’Œå§”æ‰˜ç±»ä¹‹é—´å°±å¤šäº†ä¸€ä¸ªå¤„ç†ç±»çš„è§’è‰²ï¼Œè¿™ä¸ªè§’è‰²ä¸»è¦æ˜¯**å¯¹ä»£ç†ç±»è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•çš„è¿™ä¸ªåŠ¨ä½œè¿›è¡Œç»Ÿä¸€çš„è°ƒç”¨**ï¼Œä¹Ÿå°±æ˜¯ç”± `InvocationHandler` æ¥ç»Ÿä¸€å¤„ç†ä»£ç†ç±»è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•è¿™ä¸ªæ“ä½œã€‚çœ‹ä¸‹å›¾ï¼š

![image-20220723003057769](./personal_images/image-20220723003057769.webp)

**ä» JVM è§’åº¦æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ `.class` å­—èŠ‚ç æ–‡ä»¶ ï¼Œå¹¶åŠ è½½åˆ° JVM ä¸­çš„**ã€‚è¿™ä¸ªæˆ‘ä»¬åœ¨ Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ä¸­å·²ç»æåˆ°è¿‡ã€‚

è™½ç„¶åŠ¨æ€ä»£ç†åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨çš„ç›¸å¯¹è¾ƒå°‘ï¼Œä½†æ˜¯åœ¨æ¡†æ¶ä¸­çš„å‡ ä¹æ˜¯å¿…ç”¨çš„ä¸€é—¨æŠ€æœ¯ã€‚å­¦ä¼šäº†åŠ¨æ€ä»£ç†ä¹‹åï¼Œå¯¹äºæˆ‘ä»¬ç†è§£å’Œå­¦ä¹ å„ç§æ¡†æ¶çš„åŸç†ä¹Ÿéå¸¸æœ‰å¸®åŠ©ï¼Œ**Spring AOPã€RPC ç­‰æ¡†æ¶çš„å®ç°éƒ½ä¾èµ–äº†åŠ¨æ€ä»£ç†**ã€‚

å°± Java æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ï¼š

- JDK åŠ¨æ€ä»£ç†
- CGLIB åŠ¨æ€ä»£ç†
- Javassit åŠ¨æ€ä»£ç†
- ......

ä¸‹é¢è¯¦ç»†è®²è§£è¿™ä¸‰ç§åŠ¨æ€ä»£ç†æœºåˆ¶ã€‚

#### JDK åŠ¨æ€ä»£ç†æœºåˆ¶

å…ˆæ¥çœ‹ä¸‹ JDK åŠ¨æ€ä»£ç†æœºåˆ¶çš„ä½¿ç”¨æ­¥éª¤ï¼š

1ï¼‰å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ˆSubjectï¼‰

2ï¼‰åˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰å®ç°è¿™ä¸ªæ¥å£

3ï¼‰åˆ›å»ºä¸€ä¸ªå¤„ç†ç±»å¹¶å®ç° `InvocationHandler` æ¥å£ï¼Œé‡å†™å…¶ `invoke` æ–¹æ³•ï¼ˆåœ¨ `invoke` æ–¹æ³•ä¸­åˆ©ç”¨åå°„æœºåˆ¶è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•ï¼Œå¹¶è‡ªå®šä¹‰ä¸€äº›å¤„ç†é€»è¾‘ï¼‰ï¼Œå¹¶å°†å§”æ‰˜ç±»æ³¨å…¥å¤„ç†ç±»

![image-20220723003128864](./personal_images/image-20220723003128864.webp)

è¯¥æ–¹æ³•æœ‰ä¸‹é¢ä¸‰ä¸ªå‚æ•°ï¼š

- proxyï¼šä»£ç†ç±»å¯¹è±¡ï¼ˆè§ä¸‹ä¸€æ­¥ï¼‰
- methodï¼šè¿˜è®°å¾—æˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« åå°„ä¸­è®²åˆ°çš„ `Method.invoke` å—ï¼Ÿå°±æ˜¯è¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•ï¼ˆåå°„ï¼‰

![image-20220723003137612](./personal_images/image-20220723003137612.webp)

- argsï¼šä¼ ç»™å§”æ‰˜ç±»æ–¹æ³•çš„å‚æ•°åˆ—è¡¨

4ï¼‰åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ï¼šé€šè¿‡ `Proxy.newProxyInstance()` åˆ›å»ºå§”æ‰˜ç±»å¯¹è±¡çš„ä»£ç†å¯¹è±¡

![image-20220723003147365](./personal_images/image-20220723003147365.webp)

è¿™ä¸ªæ–¹æ³•éœ€è¦ 3 ä¸ªå‚æ•°ï¼š

- ç±»åŠ è½½å™¨ ClassLoader
- å§”æ‰˜ç±»å®ç°çš„æ¥å£æ•°ç»„ï¼Œè‡³å°‘éœ€è¦ä¼ å…¥ä¸€ä¸ªæ¥å£è¿›å»
- è°ƒç”¨çš„ `InvocationHandler` å®ä¾‹å¤„ç†æ¥å£æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ 3 æ­¥æˆ‘ä»¬åˆ›å»ºçš„ç±»çš„å®ä¾‹ï¼‰

ä¹Ÿå°±æ˜¯è¯´ï¼šæˆ‘ä»¬åœ¨é€šè¿‡ `Proxy` ç±»çš„ `newProxyInstance()` åˆ›å»ºçš„ä»£ç†å¯¹è±¡åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…ä¼šè°ƒç”¨åˆ°å®ç°äº† `InvocationHandler` æ¥å£çš„å¤„ç†ç±»çš„ `invoke()`æ–¹æ³•ï¼Œå¯ä»¥åœ¨ `invoke()` æ–¹æ³•ä¸­è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ååšä»€ä¹ˆäº‹æƒ…ã€‚



1ï¼‰å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ˆSubjectï¼‰

```java
public interface SmsService {
    String send(String message);
}
```

2ï¼‰åˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰å®ç°è¿™ä¸ªæ¥å£

```java
public class SmsServiceImpl implements SmsService {
    public String send(String message) {
        System.out.println("send message:" + message);
        return message;
    }
}
```

3ï¼‰åˆ›å»ºä¸€ä¸ªå¤„ç†ç±»ï¼Œå¹¶å°†å§”æ‰˜ç±»æ³¨å…¥å¤„ç†ç±»ï¼Œå¦å¤–ï¼Œè¿™ä¸ªå¤„ç†ç±»éœ€è¦å®ç° `InvocationHandler` æ¥å£ï¼Œé‡å†™å…¶ `invoke` æ–¹æ³•ï¼ˆåœ¨ `invoke` æ–¹æ³•ä¸­åˆ©ç”¨åå°„æœºåˆ¶è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•ï¼Œå¹¶è‡ªå®šä¹‰ä¸€äº›å¤„ç†é€»è¾‘ï¼‰

```java
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class DebugInvocationHandler implements InvocationHandler {

    // å°†å§”æ‰˜ç±»æ³¨å…¥å¤„ç†ç±»ï¼ˆè¿™é‡Œæˆ‘ä»¬ç”¨ Object ä»£æ›¿ï¼Œæ–¹ä¾¿æ‰©å±•ï¼‰
    private final Object target;

    public DebugInvocationHandler(Object target) {
        this.target = target;
    }

    // é‡å†™ invoke æ–¹æ³•
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws InvocationTargetException, IllegalAccessException {
        //è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("before method " + method.getName());
        Object result = method.invoke(target, args);
        //è°ƒç”¨æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("after method " + method.getName());
        return result;
    }
}
```

4ï¼‰å®šä¹‰ä¸€ä¸ªåˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰çš„å·¥å‚ç±»ï¼šé€šè¿‡ `Proxy.newProxyInstance()` åˆ›å»ºå§”æ‰˜ç±»å¯¹è±¡çš„ä»£ç†å¯¹è±¡

```java
public class JdkProxyFactory {
    public static Object getProxy(Object target) {
        return Proxy.newProxyInstance(
                target.getClass().getClassLoader(),
                target.getClass().getInterfaces(),
                new DebugInvocationHandler(target)
        );
    }
}
```

5ï¼‰å®é™…ä½¿ç”¨

```java
SmsService smsService = (SmsService) JdkProxyFactory.getProxy(new SmsServiceImpl());
smsService.send("Java");
```

è¿è¡Œä¸Šè¿°ä»£ç ä¹‹åï¼Œæ§åˆ¶å°æ‰“å°å‡ºï¼š

```text
before method send
send message:Java
after method send
```

#### CGLIB åŠ¨æ€ä»£ç†æœºåˆ¶

**JDK åŠ¨æ€ä»£ç†æœ‰ä¸€ä¸ªæœ€è‡´å‘½çš„é—®é¢˜æ˜¯å®ƒåªèƒ½ä»£ç†å®ç°äº†æŸä¸ªæ¥å£çš„å®ç°ç±»ï¼Œå¹¶ä¸”ä»£ç†ç±»ä¹Ÿåªèƒ½ä»£ç†æ¥å£ä¸­å®ç°çš„æ–¹æ³•ï¼Œè¦æ˜¯å®ç°ç±»ä¸­æœ‰è‡ªå·±ç§æœ‰çš„æ–¹æ³•ï¼Œè€Œæ¥å£ä¸­æ²¡æœ‰çš„è¯ï¼Œè¯¥æ–¹æ³•ä¸èƒ½è¿›è¡Œä»£ç†è°ƒç”¨**ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ CGLIB åŠ¨æ€ä»£ç†æœºåˆ¶ã€‚

ä¸Šæ–‡ä¹Ÿæåˆ°è¿‡ï¼ŒCGLIBï¼ˆCode Generation Libraryï¼‰æ˜¯ä¸€ä¸ªåŸºäº ASM çš„ Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹å’ŒåŠ¨æ€ç”Ÿæˆã€‚åŸç†å°±æ˜¯**é€šè¿‡å­—èŠ‚ç æŠ€æœ¯ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œå¹¶åœ¨å­ç±»ä¸­æ‹¦æˆªçˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œç»‡å…¥é¢å¤–çš„ä¸šåŠ¡é€»è¾‘**ã€‚å…³é”®è¯å¤§å®¶æ³¨æ„åˆ°æ²¡æœ‰ï¼Œæ‹¦æˆªï¼CGLIB å¼•å…¥ä¸€ä¸ªæ–°çš„è§’è‰²å°±æ˜¯**æ–¹æ³•æ‹¦æˆªå™¨** `MethodInterceptor`ã€‚å’Œ JDK ä¸­çš„å¤„ç†ç±» `InvocationHandler` å·®ä¸å¤šï¼Œä¹Ÿæ˜¯ç”¨æ¥å®ç°æ–¹æ³•çš„ç»Ÿä¸€è°ƒç”¨çš„ã€‚çœ‹ä¸‹å›¾ï¼š

![image-20220723003222393](./personal_images/image-20220723003222393.webp)

å¦å¤–ç”±äº CGLIB é‡‡ç”¨**ç»§æ‰¿**çš„æ–¹å¼ï¼Œæ‰€ä»¥è¢«ä»£ç†çš„ç±»ä¸èƒ½è¢« `final` ä¿®é¥°ã€‚

å¾ˆå¤šçŸ¥åçš„å¼€æºæ¡†æ¶éƒ½ä½¿ç”¨åˆ°äº† CGLIBï¼Œ ä¾‹å¦‚ **Spring ä¸­çš„ AOP æ¨¡å—ä¸­ï¼šå¦‚æœç›®æ ‡å¯¹è±¡å®ç°äº†æ¥å£ï¼Œåˆ™é»˜è®¤é‡‡ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¦åˆ™é‡‡ç”¨ CGLIB åŠ¨æ€ä»£ç†**ã€‚

æ¥çœ‹ CGLIB åŠ¨æ€ä»£ç†çš„ä½¿ç”¨æ­¥éª¤ï¼š

1ï¼‰é¦–å…ˆåˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰

2ï¼‰åˆ›å»ºä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨å®ç°æ¥å£ `MethodInterceptor`ï¼Œå¹¶é‡å†™ `intercept` æ–¹æ³•ã€‚`intercept` ç”¨äºæ‹¦æˆªå¹¶å¢å¼ºå§”æ‰˜ç±»çš„æ–¹æ³•ï¼ˆå’Œ JDK åŠ¨æ€ä»£ç† `InvocationHandler` ä¸­çš„ `invoke` æ–¹æ³•ç±»ä¼¼ï¼‰

![image-20220723003232098](./personal_images/image-20220723003232098.webp)

è¯¥æ–¹æ³•æ‹¥æœ‰å››ä¸ªå‚æ•°ï¼š

- Object var1ï¼šå§”æ‰˜ç±»å¯¹è±¡
- Method var2ï¼šè¢«æ‹¦æˆªçš„æ–¹æ³•ï¼ˆå§”æ‰˜ç±»ä¸­éœ€è¦å¢å¼ºçš„æ–¹æ³•ï¼‰
- Object[] var3ï¼šæ–¹æ³•å…¥å‚
- MethodProxy var4ï¼šç”¨äºè°ƒç”¨å§”æ‰˜ç±»çš„åŸå§‹æ–¹æ³•ï¼ˆåº•å±‚ä¹Ÿæ˜¯é€šè¿‡åå°„æœºåˆ¶ï¼Œä¸è¿‡ä¸æ˜¯ `Method.invoke` äº†ï¼Œè€Œæ˜¯ä½¿ç”¨ `MethodProxy.invokeSuper` æ–¹æ³•ï¼‰

![image-20220723003242424](./personal_images/image-20220723003242424.webp)

3ï¼‰åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ï¼šé€šè¿‡ `Enhancer.create()` åˆ›å»ºå§”æ‰˜ç±»å¯¹è±¡çš„ä»£ç†å¯¹è±¡

![image-20220723003250555](./personal_images/image-20220723003250555.webp)

ä¹Ÿå°±æ˜¯è¯´ï¼šæˆ‘ä»¬åœ¨é€šè¿‡ `Enhancer` ç±»çš„ `create()` åˆ›å»ºçš„ä»£ç†å¯¹è±¡åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…ä¼šè°ƒç”¨åˆ°å®ç°äº† `MethodInterceptor` æ¥å£çš„å¤„ç†ç±»çš„ `intercept()`æ–¹æ³•ï¼Œå¯ä»¥åœ¨ `intercept()` æ–¹æ³•ä¸­è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ååšä»€ä¹ˆäº‹æƒ…ã€‚

> å¯ä»¥å‘ç°ï¼ŒCGLIB åŠ¨æ€ä»£ç†æœºåˆ¶å’Œ JDK åŠ¨æ€ä»£ç†æœºåˆ¶çš„æ­¥éª¤å·®ä¸å¤šï¼ŒCGLIB åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒæ˜¯æ–¹æ³•æ‹¦æˆªå™¨ `MethodInterceptor` å’Œ `Enhancer`ï¼Œè€Œ JDK åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒæ˜¯å¤„ç†ç±» `InvocationHandler` å’Œ `Proxy`ã€‚

ä¸åŒäº JDK åŠ¨æ€ä»£ç†ä¸éœ€è¦é¢å¤–çš„ä¾èµ–ã€‚CGLIB æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå¦‚æœä½ è¦ä½¿ç”¨å®ƒçš„è¯ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ç›¸å…³ä¾èµ–ã€‚

```xml
<dependency>
  <groupId>cglib</groupId>
  <artifactId>cglib</artifactId>
  <version>3.3.0</version>
</dependency>
```

1ï¼‰é¦–å…ˆåˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰

```java
public class AliSmsService {
    public String send(String message) {
        System.out.println("send message:" + message);
        return message;
    }
}
```

2ï¼‰åˆ›å»ºä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨å®ç°æ¥å£ `MethodInterceptor`ï¼Œå¹¶é‡å†™ `intercept` æ–¹æ³•

```java
import net.sf.cglib.proxy.MethodInterceptor;
import net.sf.cglib.proxy.MethodProxy;
import java.lang.reflect.Method;

public class DebugMethodInterceptor implements MethodInterceptor {

    @Override
    public Object intercept(Object o, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {
        // è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("before method " + method.getName());
        // é€šè¿‡åå°„è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•
        Object object = methodProxy.invokeSuper(o, args);
        // è°ƒç”¨æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("after method " + method.getName());
        return object;
    }

}
```

3ï¼‰åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ï¼šé€šè¿‡ `Enhancer.create()` åˆ›å»ºå§”æ‰˜ç±»å¯¹è±¡çš„ä»£ç†å¯¹è±¡

```java
import net.sf.cglib.proxy.Enhancer;

public class CglibProxyFactory {
    public static Object getProxy(Class<?> clazz) {
        // åˆ›å»ºåŠ¨æ€ä»£ç†å¢å¼ºç±»
        Enhancer enhancer = new Enhancer();
        // è®¾ç½®ç±»åŠ è½½å™¨
        enhancer.setClassLoader(clazz.getClassLoader());
        // è®¾ç½®å§”æ‰˜ç±»ï¼ˆè®¾ç½®çˆ¶ç±»ï¼‰
        enhancer.setSuperclass(clazz);
        // è®¾ç½®æ–¹æ³•æ‹¦æˆªå™¨
        enhancer.setCallback(new DebugMethodInterceptor());
        // åˆ›å»ºä»£ç†ç±»
        return enhancer.create();
    }
}
```

> ä» `setSuperclass` æˆ‘ä»¬å°±èƒ½çœ‹å‡ºï¼Œä¸ºä»€ä¹ˆè¯´ CGLIB æ˜¯åŸºäºç»§æ‰¿çš„ã€‚

4ï¼‰å®é™…ä½¿ç”¨

```java
AliSmsService aliSmsService = 
    (AliSmsService) CglibProxyFactory.getProxy(AliSmsService.class);
aliSmsService.send("Java");
```

è¿è¡Œä¸Šè¿°ä»£ç ä¹‹åï¼Œæ§åˆ¶å°æ‰“å°å‡ºï¼š

```bash
before method send
send message:Java
after method send
```

#### JDK åŠ¨æ€ä»£ç†å’Œ CGLIB åŠ¨æ€ä»£ç†å¯¹æ¯”

1ï¼‰JDK åŠ¨æ€ä»£ç†æ˜¯åŸºäºå®ç°äº†æ¥å£çš„å§”æ‰˜ç±»ï¼Œé€šè¿‡æ¥å£å®ç°ä»£ç†ï¼›è€Œ CGLIB åŠ¨æ€ä»£ç†æ˜¯åŸºäºç»§æ‰¿äº†å§”æ‰˜ç±»çš„å­ç±»ï¼Œé€šè¿‡å­ç±»å®ç°ä»£ç†ã€‚

2ï¼‰JDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»ï¼Œä¸”åªèƒ½å¢å¼ºæ¥å£ä¸­ç°æœ‰çš„æ–¹æ³•ï¼›è€Œ CGLIB å¯ä»¥ä»£ç†æœªå®ç°ä»»ä½•æ¥å£çš„ç±»ã€‚

3ï¼‰å°±äºŒè€…çš„æ•ˆç‡æ¥è¯´ï¼Œå¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯ JDK åŠ¨æ€ä»£ç†çš„æ•ˆç‡æ›´é«˜ï¼Œéšç€ JDK ç‰ˆæœ¬çš„å‡çº§ï¼Œè¿™ä¸ªä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚

> æä¸€å˜´ï¼Œå¸¸è§çš„è¿˜æœ‰ **Javassist åŠ¨æ€ä»£ç†æœºåˆ¶**ã€‚å’Œ CGLIB ä¸€æ ·ï¼Œä½œä¸ºä¸€ä¸ª Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼ŒJavassist å¤©ç”Ÿå°±æ‹¥æœ‰åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»çš„èƒ½åŠ›ï¼Œå®ç°åŠ¨æ€ä»£ç†è‡ªç„¶ä¸åœ¨è¯ä¸‹ã€‚ Dubbo å°±æ˜¯é»˜è®¤ä½¿ç”¨ Javassit æ¥è¿›è¡ŒåŠ¨æ€ä»£ç†çš„ã€‚

#### é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†å¯¹æ¯”

1. **çµæ´»æ€§** ï¼šåŠ¨æ€ä»£ç†æ›´åŠ çµæ´»ï¼Œä¸éœ€è¦å¿…é¡»å®ç°æ¥å£ï¼Œå¯ä»¥ç›´æ¥ä»£ç†å®ç°ç±»ï¼Œå¹¶ä¸”å¯ä»¥ä¸éœ€è¦é’ˆå¯¹æ¯ä¸ªç›®æ ‡ç±»éƒ½åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ã€‚å¦å¤–ï¼Œé™æ€ä»£ç†ä¸­ï¼Œæ¥å£ä¸€æ—¦æ–°å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ˜¯éå¸¸éº»çƒ¦çš„
2. **JVM å±‚é¢** ï¼šé™æ€ä»£ç†åœ¨ç¼–è¯‘æ—¶å°±å°†æ¥å£ã€å®ç°ç±»ã€ä»£ç†ç±»è¿™äº›éƒ½å˜æˆäº†ä¸€ä¸ªä¸ªå®é™…çš„ `.class` å­—èŠ‚ç æ–‡ä»¶ã€‚è€ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆç±»å­—èŠ‚ç ï¼Œå¹¶åŠ è½½åˆ° JVM ä¸­çš„ã€‚

#### ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨åŠ¨æ€ä»£ç†

1. è®¾è®¡æ¨¡å¼ä¸­æœ‰ä¸€ä¸ªè®¾è®¡åŸåˆ™æ˜¯**å¼€é—­åŸåˆ™**ï¼Œå³**å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾**ï¼Œæˆ‘ä»¬åœ¨å·¥ä½œä¸­æœ‰æ—¶ä¼šæ¥æ‰‹å¾ˆå¤šå‰äººçš„ä»£ç ï¼Œé‡Œé¢ä»£ç é€»è¾‘è®©äººæ‘¸ä¸ç€å¤´è„‘ï¼Œå°±å¾ˆéš¾å»ä¸‹æ‰‹ä¿®æ”¹ä»£ç ï¼Œé‚£ä¹ˆè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»£ç†å¯¹ç±»è¿›è¡Œå¢å¼ºã€‚
2. æˆ‘ä»¬åœ¨ä½¿ç”¨ **RPC æ¡†æ¶**çš„æ—¶å€™ï¼Œæ¡†æ¶æœ¬èº«å¹¶ä¸èƒ½æå‰çŸ¥é“å„ä¸ªä¸šåŠ¡æ–¹è¦è°ƒç”¨å“ªäº›æ¥å£çš„å“ªäº›æ–¹æ³• ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå°±å¯ç”¨é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼æ¥å»ºç«‹ä¸€ä¸ªä¸­é—´äººç»™å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œä¹Ÿæ–¹ä¾¿æ¡†æ¶è¿›è¡Œæ­å»ºé€»è¾‘ï¼ŒæŸç§ç¨‹åº¦ä¸Šä¹Ÿæ˜¯å®¢æˆ·ç«¯ä»£ç å’Œæ¡†æ¶æ¾è€¦åˆçš„ä¸€ç§è¡¨ç°ã€‚
3. **Spring çš„ AOP** æœºåˆ¶åŒæ ·ä¹Ÿæ˜¯é‡‡ç”¨äº†åŠ¨æ€ä»£ç†ï¼Œæ­¤å¤„ä¸åšè¯¦ç»†è®¨è®ºã€‚

#### æ€»ç»“

å…¨éƒ¨æ‹ä¸€éä¸‹æ¥è¿˜æ˜¯æ”¶è·è›®å¤šçš„ï¼Œæˆ‘æ„Ÿè§‰åªè¦ç†è§£äº†å­—èŠ‚ç åœ¨ç¼–è¯‘æœŸç”Ÿæˆè¿˜æ˜¯åœ¨è¿è¡ŒæœŸç”Ÿæˆï¼Œå°±å·®ä¸å¤šèƒ½å¤ŸæŠŠæ¡ä½é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†äº†ã€‚æ€»ç»“ä¸€ä¸‹é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¸­çš„è§’è‰²ï¼š

é™æ€ä»£ç†ï¼š

- Subjectï¼šå…¬å…±æ¥å£
- Real Subjectï¼šå§”æ‰˜ç±»
- Proxyï¼šä»£ç†ç±»

JDK åŠ¨æ€ä»£ç†ï¼š

- Subjectï¼šå…¬å…±æ¥å£
- Real Subjectï¼šå§”æ‰˜ç±»
- Proxyï¼šä»£ç†ç±»
- **InvocationHandler**ï¼šå¤„ç†ç±»ï¼Œç»Ÿä¸€è°ƒç”¨æ–¹æ³•

CGLIB åŠ¨æ€ä»£ç†ï¼š

- Subjectï¼šå…¬å…±æ¥å£
- Real Subjectï¼šå§”æ‰˜ç±»
- Proxyï¼šä»£ç†ç±»
- **MethodInterceptor**ï¼šæ–¹æ³•æ‹¦æˆªå™¨ï¼Œç»Ÿä¸€è°ƒç”¨æ–¹æ³•



### static{}é™æ€ä»£ç å—ä¸{}éé™æ€ä»£ç å—(æ„é€ ä»£ç å—)

**ç›¸åŒç‚¹**ï¼š éƒ½æ˜¯åœ¨ JVM åŠ è½½ç±»æ—¶ä¸”åœ¨æ„é€ æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œï¼Œåœ¨ç±»ä¸­éƒ½å¯ä»¥å®šä¹‰å¤šä¸ªï¼Œå®šä¹‰å¤šä¸ªæ—¶æŒ‰å®šä¹‰çš„é¡ºåºæ‰§è¡Œï¼Œä¸€èˆ¬åœ¨ä»£ç å—ä¸­å¯¹ä¸€äº› static å˜é‡è¿›è¡Œèµ‹å€¼ã€‚

**ä¸åŒç‚¹**ï¼š é™æ€ä»£ç å—åœ¨éé™æ€ä»£ç å—ä¹‹å‰æ‰§è¡Œ(é™æ€ä»£ç å— -> éé™æ€ä»£ç å— -> æ„é€ æ–¹æ³•)ã€‚é™æ€ä»£ç å—åªåœ¨ç¬¬ä¸€æ¬¡ new  æ‰§è¡Œä¸€æ¬¡ï¼Œä¹‹åä¸å†æ‰§è¡Œï¼Œè€Œéé™æ€ä»£ç å—åœ¨æ¯ new ä¸€æ¬¡å°±æ‰§è¡Œä¸€æ¬¡ã€‚ éé™æ€ä»£ç å—å¯åœ¨æ™®é€šæ–¹æ³•ä¸­å®šä¹‰(ä¸è¿‡ä½œç”¨ä¸å¤§)ï¼›è€Œé™æ€ä»£ç å—ä¸è¡Œã€‚

> ğŸ› **ä¿®æ­£**ï¼šé™æ€ä»£ç å—å¯èƒ½åœ¨ç¬¬ä¸€æ¬¡ new å¯¹è±¡çš„æ—¶å€™æ‰§è¡Œï¼Œä½†ä¸ä¸€å®šåªåœ¨ç¬¬ä¸€æ¬¡ new çš„æ—¶å€™æ‰§è¡Œã€‚æ¯”å¦‚é€šè¿‡ `Class.forName("ClassDemo")`åˆ›å»º Class å¯¹è±¡çš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡Œï¼Œå³ new æˆ–è€… `Class.forName("ClassDemo")` éƒ½ä¼šæ‰§è¡Œé™æ€ä»£ç å—ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹,å¦‚æœæœ‰äº›ä»£ç æ¯”å¦‚ä¸€äº›é¡¹ç›®æœ€å¸¸ç”¨çš„å˜é‡æˆ–å¯¹è±¡å¿…é¡»åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™å°±æ‰§è¡Œçš„æ—¶å€™,éœ€è¦ä½¿ç”¨é™æ€ä»£ç å—,è¿™ç§ä»£ç æ˜¯ä¸»åŠ¨æ‰§è¡Œçš„ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦è®¾è®¡ä¸éœ€è¦åˆ›å»ºå¯¹è±¡å°±å¯ä»¥è°ƒç”¨ç±»ä¸­çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š`Arrays` ç±»ï¼Œ`Character` ç±»ï¼Œ`String` ç±»ç­‰ï¼Œå°±éœ€è¦ä½¿ç”¨é™æ€æ–¹æ³•, ä¸¤è€…çš„åŒºåˆ«æ˜¯ é™æ€ä»£ç å—æ˜¯è‡ªåŠ¨æ‰§è¡Œçš„è€Œé™æ€æ–¹æ³•æ˜¯è¢«è°ƒç”¨çš„æ—¶å€™æ‰æ‰§è¡Œçš„.

Exampleï¼š

```java
public class Test {
    public Test() {
        System.out.print("é»˜è®¤æ„é€ æ–¹æ³•ï¼--");
    }
    //éé™æ€ä»£ç å—
    {
        System.out.print("éé™æ€ä»£ç å—ï¼--");
    }
    //é™æ€ä»£ç å—
    static {
        System.out.print("é™æ€ä»£ç å—ï¼--");
    }
    private static void test() {
        System.out.print("é™æ€æ–¹æ³•ä¸­çš„å†…å®¹! --");
        {
            System.out.print("é™æ€æ–¹æ³•ä¸­çš„ä»£ç å—ï¼--");
        }
    }
    public static void main(String[] args) {
        Test test = new Test();
        Test.test();//é™æ€ä»£ç å—ï¼--é™æ€æ–¹æ³•ä¸­çš„å†…å®¹! --é™æ€æ–¹æ³•ä¸­çš„ä»£ç å—ï¼--
    }
}
```

ä¸Šè¿°ä»£ç è¾“å‡ºï¼š

```text
é™æ€ä»£ç å—ï¼--éé™æ€ä»£ç å—ï¼--é»˜è®¤æ„é€ æ–¹æ³•ï¼--é™æ€æ–¹æ³•ä¸­çš„å†…å®¹! --é™æ€æ–¹æ³•ä¸­çš„ä»£ç å—ï¼--
```

å½“åªæ‰§è¡Œ `Test.test();` æ—¶è¾“å‡ºï¼š

```text
é™æ€ä»£ç å—ï¼--é™æ€æ–¹æ³•ä¸­çš„å†…å®¹! --é™æ€æ–¹æ³•ä¸­çš„ä»£ç å—ï¼--
```

å½“åªæ‰§è¡Œ `Test test = new Test();` æ—¶è¾“å‡ºï¼š

```text
é™æ€ä»£ç å—ï¼--éé™æ€ä»£ç å—ï¼--é»˜è®¤æ„é€ æ–¹æ³•ï¼--
```

éé™æ€ä»£ç å—ä¸æ„é€ å‡½æ•°çš„åŒºåˆ«æ˜¯ï¼š  éé™æ€ä»£ç å—æ˜¯ç»™æ‰€æœ‰å¯¹è±¡è¿›è¡Œç»Ÿä¸€åˆå§‹åŒ–ï¼Œè€Œæ„é€ å‡½æ•°æ˜¯ç»™å¯¹åº”çš„å¯¹è±¡åˆå§‹åŒ–ï¼Œå› ä¸ºæ„é€ å‡½æ•°æ˜¯å¯ä»¥å¤šä¸ªçš„ï¼Œè¿è¡Œå“ªä¸ªæ„é€ å‡½æ•°å°±ä¼šå»ºç«‹ä»€ä¹ˆæ ·çš„å¯¹è±¡ï¼Œä½†æ— è®ºå»ºç«‹å“ªä¸ªå¯¹è±¡ï¼Œéƒ½ä¼šå…ˆæ‰§è¡Œç›¸åŒçš„æ„é€ ä»£ç å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ„é€ ä»£ç å—ä¸­å®šä¹‰çš„æ˜¯ä¸åŒå¯¹è±¡å…±æ€§çš„åˆå§‹åŒ–å†…å®¹ã€‚

### charå‹å˜é‡ä¸­èƒ½å¦èƒ½ä¸èƒ½å­˜å‚¨â¼€ä¸ªä¸­â½‚æ±‰å­—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

charå¯ä»¥å­˜å‚¨â¼€ä¸ªä¸­â½‚æ±‰å­—ï¼Œå› ä¸ºJavaä¸­ä½¿â½¤çš„ç¼–ç æ˜¯Unicode(ä¸é€‰æ‹©ä»»ä½•ç‰¹å®šçš„ç¼–ç ï¼Œç›´æ¥ä½¿â½¤å­—ç¬¦åœ¨å­—ç¬¦é›†ä¸­çš„ç¼–å·ï¼Œè¿™æ˜¯ç»Ÿâ¼€çš„å”¯â¼€â½…æ³•ï¼‰ï¼Œâ¼€ä¸ªcharç±»å‹å 2ä¸ªå­—èŠ‚ï¼ˆ16â½ç‰¹ï¼‰ï¼Œæ‰€ä»¥æ”¾â¼€ä¸ªä¸­â½‚æ˜¯æ²¡é—®é¢˜çš„ã€‚

### æ˜¯å¦å¯ä»¥ç»§æ‰¿Stringç±»ï¼Ÿ

Stringç±»æ˜¯finalç±»ï¼Œä¸å¯ä»¥è¢«ç»§æ‰¿ã€‚

è¡¥å……ï¼šç»§æ‰¿Stringæœ¬èº«å°±æ˜¯â¼€ä¸ªé”™è¯¯çš„â¾ä¸ºï¼Œå¯¹Stringç±»å‹æœ€å¥½çš„é‡â½¤â½…å¼æ˜¯å…³è”å…³ç³»ï¼ˆHas-Aï¼‰å’Œä¾èµ–å…³ç³»ï¼ˆUse-Aï¼‰â½½ä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼ˆIs-Aï¼‰ã€‚

### è°ˆè°ˆä½ å¯¹å¤šæ€çš„ç†è§£ï¼Ÿ

å¤šæ€åˆ†ä¸ºç¼–è¯‘æ—¶å¤šæ€å’Œè¿è¡Œæ—¶å¤šæ€:

- ç¼–è¯‘æ—¶å¤šæ€ä¸»è¦æŒ‡æ–¹æ³•çš„é‡è½½
- è¿è¡Œæ—¶å¤šæ€æŒ‡ç¨‹åºä¸­å®šä¹‰çš„å¯¹è±¡å¼•ç”¨æ‰€æŒ‡å‘çš„å…·ä½“ç±»å‹åœ¨è¿è¡ŒæœŸé—´æ‰ç¡®å®š

è¿è¡Œæ—¶å¤šæ€æœ‰ä¸‰ä¸ªæ¡ä»¶:

- ç»§æ‰¿
- è¦†ç›–(é‡å†™)
- å‘ä¸Šè½¬å‹

ä¸‹é¢çš„ä»£ç ä¸­ï¼Œä¹å™¨ç±»(Instrument)æœ‰ä¸¤ä¸ªå­ç±»: Wind å’Œ Percussionï¼Œå®ƒä»¬éƒ½è¦†ç›–äº†çˆ¶ç±»çš„ play() æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨ main() æ–¹æ³•ä¸­ä½¿ç”¨çˆ¶ç±» Instrument æ¥å¼•ç”¨ Wind å’Œ Percussion å¯¹è±¡ã€‚åœ¨ Instrument å¼•ç”¨è°ƒç”¨ play() æ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œå®é™…å¼•ç”¨å¯¹è±¡æ‰€åœ¨ç±»çš„ play() æ–¹æ³•ï¼Œè€Œä¸æ˜¯ Instrument ç±»çš„æ–¹æ³•ã€‚

```java
public class Instrument {
    public void play() {
        System.out.println("Instrument is playing...");
    }
}

public class Wind extends Instrument {
    public void play() {
        System.out.println("Wind is playing...");
    }
}

public class Percussion extends Instrument {
    public void play() {
        System.out.println("Percussion is playing...");
    }
}

public class Music {
    public static void main(String[] args) {
        List<Instrument> instruments = new ArrayList<>();
        instruments.add(new Wind());
        instruments.add(new Percussion());
        for(Instrument instrument : instruments) {
            instrument.play();
        }
    }
}
```

> è¯¦ç»†

å¤šæ€çš„æ¦‚å¿µå¹¶ä¸éš¾ï¼Œå¹¶ä¸”åœ¨å®é™…ç¼–ç ä¸­å¯ä»¥è¯´æ˜¯æœ€æœ€é«˜é¢‘ä½¿ç”¨ç‡ã€‚å¤šæ€å°±æ˜¯**ä½¿å¾—åŒä¸€ä¸ªè¡Œä¸ºå…·æœ‰å¤šä¸ªä¸åŒè¡¨ç°å½¢å¼æˆ–å½¢æ€çš„èƒ½åŠ›**ã€‚ä¸¾ä¸ªå½¢è±¡ç‚¹çš„ä¾‹å­ï¼šå¯¹äº â€œæ‰“å°â€ è¿™ä¸ªè¡Œä¸ºï¼Œä½¿ç”¨å½©è‰²æ‰“å°æœº â€œæ‰“å°â€ å‡ºæ¥çš„æ•ˆæœå°±æ˜¯å½©è‰²çš„ï¼Œè€Œä½¿ç”¨é»‘ç™½æ‰“å°æœº â€œæ‰“å°â€ å‡ºæ¥çš„æ•ˆæœå°±æ˜¯é»‘ç™½çš„ã€‚æˆ‘ä»¬å°±ç§° â€œæ‰“å°â€ è¿™ä¸ªè¡Œä¸ºæ˜¯å¤šæ€çš„ï¼Œå½©è‰²æ‰“å°æ•ˆæœå’Œé»‘ç™½æ‰“å°æ•ˆæœå°±æ˜¯ â€œæ‰“å°â€ è¿™ä¸ªè¡Œä¸ºçš„ä¸¤ä¸ªä¸åŒçš„è¡¨ç°å½¢å¼ã€‚

![image-20220618172157050](./personal_images/image-20220618172157050.webp)

è¿˜å¯ä»¥è¿™æ ·ç†è§£ï¼Œ**åŒä¸€ä¸ªè¡Œä¸ºåœ¨ä¸åŒçš„å¯¹è±¡ä¸Šä¼šäº§ç”Ÿä¸åŒçš„ç»“æœ**ã€‚å†ä¸¾ä¸ªå½¢è±¡ç‚¹çš„ä¾‹å­ï¼šæ¯”å¦‚æˆ‘ä»¬æŒ‰ä¸‹ F1 é”®è¿™ä¸ªè¡Œä¸ºï¼šå¦‚æœå½“å‰åœ¨ Word ä¸‹å¼¹å‡ºçš„å°±æ˜¯ Word å¸®åŠ©å’Œæ”¯æŒï¼›åœ¨ Windows ä¸‹å¼¹å‡ºçš„å°±æ˜¯ Windows å¸®åŠ©å’Œæ”¯æŒã€‚

#### å¤šæ€å‘ç”Ÿçš„ä¸‰ä¸ªå¿…è¦æ¡ä»¶

å…ˆçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåŸºç±» `Shape`ï¼Œä¸‰ä¸ªå­ç±»ï¼Œå¹¶ä¸”éƒ½é‡å†™äº†åŸºç±»çš„ `draw` æ–¹æ³•ï¼š

```java
class Shape {
    void draw() {}
}
 
class Circle extends Shape {
    void draw() {
        System.out.println("Circle.draw()");
    }
}
 
class Square extends Shape {
    void draw() {
        System.out.println("Square.draw()");
    }
}
 
class Triangle extends Shape {
    void draw() {
        System.out.println("Triangle.draw()");
    }
}
```

ä¸‹é¢è¿™å‡ è¡Œä»£ç å°±å……åˆ†ä½“ç°äº†å¤šæ€æ€§ï¼š

```java
Shape circle = new Circle();
Shape square = new Square();
Shape triangle = new Triangle();
```

å¤§å®¶åº”è¯¥ä¸ä¼šå¤ªé™Œç”Ÿï¼Œå°±æ˜¯**å‘ä¸Šè½¬å‹**ï¼Œæ²¡é”™ï¼Œå®ƒå°±æ˜¯å¤šæ€çš„ä½“ç°ã€‚åŒæ ·çš„ä¸€ä¸ª draw æ–¹æ³•ï¼Œåœ¨è¿™ä¸‰ä¸ªä¸åŒçš„å¯¹è±¡ä¸Šäº§ç”Ÿäº†ä¸‰ç§ä¸åŒçš„è¡Œä¸ºï¼Œå¤šæ€åœ¨æ­¤ä½“ç°çš„æ·‹æ¼“å°½è‡´ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½¿ç”¨å¤šæ€æ–¹å¼è°ƒç”¨æ–¹æ³•æ—¶ï¼Œç¼–è¯‘å™¨ä¼šé¦–å…ˆæ£€æŸ¥çˆ¶ç±»ä¸­æ˜¯å¦æœ‰è¯¥æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ç¼–è¯‘é”™è¯¯ï¼›å¦‚æœçˆ¶ç±»ä¸­æœ‰è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”è¢«å­ç±»é‡å†™ï¼Œå°±ä¼šè°ƒç”¨å­ç±»çš„è¿™ä¸ªæ–¹æ³•ï¼›å¦‚æœçˆ¶ç±»çš„æ–¹æ³•æ²¡æœ‰è¢«å­ç±»é‡å†™ï¼Œå°±ä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ã€‚

```java
Shape circle = new Circle();
circle.draw(); // è°ƒç”¨çš„æ˜¯ Circle çš„ eat
```

ç®€å•æ¥è¯´ï¼š**å½“çˆ¶ç±»å¼•ç”¨å˜é‡æŒ‡å‘å­ç±»å¯¹è±¡åï¼ˆå¤šæ€ï¼‰ï¼Œåªèƒ½ä½¿ç”¨çˆ¶ç±»å·²å£°æ˜çš„æ–¹æ³•ï¼Œä½†æ–¹æ³•å¦‚æœè¢«é‡å†™ä¼šæ‰§è¡Œå­ç±»çš„æ–¹æ³•ï¼Œå¦‚æœæ–¹æ³•æœªè¢«é‡å†™é‚£ä¹ˆå°†æ‰§è¡Œçˆ¶ç±»çš„æ–¹æ³•**ã€‚

ç»“åˆä¸Šè¿°è¿™æ®µç®€å•çš„ä»£ç ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å¤šæ€äº§ç”Ÿçš„å¿…è¦æ¡ä»¶ï¼š

- 1ï¼‰ç»§æ‰¿
- 2ï¼‰é‡å†™
- 3ï¼‰çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡ï¼š`Parent p = new Child();`

![image-20220618172217768](./personal_images/image-20220618172217768.webp)

#### å¤šæ€æ˜¯å¦‚ä½•å‘ç”Ÿçš„

â“ é‚£ä¹ˆï¼Œå¤šæ€åˆ°åº•æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿç¼–è¯‘å™¨æ˜¯å¦‚ä½•çŸ¥é“çˆ¶ç±» Shape å¼•ç”¨æŒ‡å‘çš„æ˜¯ Circle è€Œä¸æ˜¯ Triangle æˆ– Square å‘¢ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„æ¦‚å¿µã€‚ä»€ä¹ˆæ˜¯**ç»‘å®š**ï¼Ÿå°†ä¸€ä¸ªæ–¹æ³•è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ä¸»ä½“å…³è”èµ·æ¥çš„è¿‡ç¨‹å°±ç§°ä½œç»‘å®šã€‚

è‹¥ç»‘å®šå‘ç”Ÿåœ¨ç¨‹åºè¿è¡Œå‰ï¼Œå«åš**é™æ€ç»‘å®š**ï¼Œä¹Ÿç§°**å‰æœŸç»‘å®š**ã€‚ä½ å¯èƒ½ä»æ¥æ²¡æœ‰å¬è¯´è¿™ä¸ªæœ¯è¯­ï¼Œå› ä¸ºå®ƒæ˜¯**é¢å‘è¿‡ç¨‹**è¯­è¨€ä¸éœ€é€‰æ‹©é»˜è®¤çš„ç»‘å®šæ–¹å¼ï¼Œä¾‹å¦‚åœ¨ C è¯­è¨€ä¸­å°±åªæœ‰å‰æœŸç»‘å®šè¿™ä¸€ç§æ–¹æ³•è°ƒç”¨ã€‚

é‚£ä¹ˆå¯¹äºè¿™æ®µä»£ç ï¼š

```java
Shape circle = new Circle();
Shape square = new Square();
circle.draw(); 
```

Shape å³å¼•ç”¨ç±»å‹åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸ä¼šè¢«æ”¹å˜ï¼Œè€Œ Circle ä½œä¸ºå®ä¾‹å¯¹è±¡ç±»å‹åœ¨è¿è¡ŒæœŸæ‰å¯çŸ¥ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥å¦‚æœä½¿ç”¨å‰æœŸç»‘å®šï¼Œåœ¨è¿è¡Œä¹‹å‰ï¼Œç¼–è¯‘å™¨åªçŸ¥é“æœ‰ä¸€ä¸ª Shape å¼•ç”¨ï¼Œå®ƒæ— æ³•å¾—çŸ¥ç©¶ç«Ÿä¼šè°ƒç”¨å“ªä¸ªæ–¹æ³•ã€‚

è§£å†³æ–¹æ³•å°±æ˜¯**åŠ¨æ€ç»‘å®š** Dynamic Bindingï¼Œåœ¨è¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„ç±»å‹è‡ªåŠ¨çš„è¿›è¡Œç»‘å®šï¼Œæ‰€ä»¥åŠ¨æ€ç»‘å®šä¹Ÿç§°**è¿è¡Œæ—¶ç»‘å®š**ã€‚åŠ¨æ€ç»‘å®šæ˜¯å¤šæ€çš„åŸºç¡€ã€‚

æ³¨æ„ï¼šJava ä¸­é™¤äº† `static`å’Œ `final`æ–¹æ³•ï¼ˆ`private`æ–¹æ³•å±äº `final`æ–¹æ³•ï¼‰ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯åŠ¨æ€ç»‘å®šã€‚è¿™æ„å‘³ç€é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦åˆ¤æ–­åŠ¨æ€ç»‘å®šæ˜¯å¦ä¼šå‘ç”Ÿï¼Œå®ƒæ˜¯è‡ªåŠ¨å‘ç”Ÿçš„ã€‚

> `final` å’Œ `static` å…³é”®å­—åç»­ä¼šå•ç‹¬å‡ºæ–‡ç« è®²è§£ï¼Œæ­¤å¤„å°±ç¬¼ç»Ÿçš„æ¦‚è¿°ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªå…³é”®å­—ä¿®é¥°çš„æ–¹æ³•æ˜¯é™æ€ç»‘å®šçš„ï¼š
>
> - `final` ä¸å…è®¸æ–¹æ³•é‡å†™ï¼Œè€Œå¤šæ€å‘ç”Ÿçš„æ¡ä»¶ä¹‹ä¸€å°±æ˜¯é‡å†™ï¼Œæ‰€ä»¥ `final` æ–¹æ³•ä¼šåœ¨ç¼–è¯‘æœŸé—´å°±è¿›è¡Œç»‘å®šï¼Œå³é™æ€ç»‘å®š
> - `static` æ–¹æ³•æ˜¯ç±»ç›´æ¥æ‹¥æœ‰çš„çš„ï¼Œä¸è¯¥ç±»çš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡éƒ½æ— å…³ï¼ˆè¯¥ç±»çš„æ‰€æœ‰å¯¹è±¡å…±åŒç»´æŠ¤ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯é™æ€ç»‘å®š

#### é‡è½½å’Œé‡å†™

é‡è½½å’Œé‡å†™åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­éƒ½è¯´è¿‡äº†ï¼Œæ­¤å¤„æ­£å¥½å€Ÿç€å¤šæ€è¿™ä¸ªä¸»é¢˜å°†è¿™ä¸¤ä¸ªå®¹æ˜“æ··æ·†çš„æ¦‚å¿µæ€»ç»“ä¸€æ³¢ã€‚

æ–¹æ³•çš„**é‡å†™ Overriding** å’Œ**é‡è½½ Overloading** éƒ½æ˜¯æ˜¯ Java å¤šæ€æ€§çš„è¡¨ç°ã€‚

ğŸ”¸ 1ï¼‰**æ–¹æ³•é‡å†™æ˜¯çˆ¶ç±»ä¸å­ç±»ä¹‹é—´å¤šæ€æ€§çš„è¡¨ç°**ã€‚å…¶å­ç±»å’Œçˆ¶ç±»æ–¹æ³•çš„åå­—ç›¸åŒï¼Œå‚æ•°ä¸ªæ•°ç›¸åŒï¼Œè¿”å›ç±»å‹ä¹Ÿç›¸åŒï¼Œå¹¶ä¸”å­ç±»çš„è®¿é—®æƒé™ä¸èƒ½æ¯”çˆ¶ç±»çš„ä¸¥æ ¼ï¼Œæ¯”å¦‚çˆ¶ç±»æ˜¯ publicï¼Œé‚£ä¹ˆå­ç±»ä¹Ÿåªèƒ½æ˜¯ publicï¼Œä¸èƒ½æ¯” public æ›´ä¸¥æ ¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**æ–¹æ³•é‡å†™ï¼Œåªæœ‰æ–¹æ³•ä½“æ˜¯ä¸ä¸€æ ·çš„ï¼Œè®¿é—®æƒé™å¯ä»¥æœ‰é™åˆ¶çš„ä¿®æ”¹**ã€‚

```java
class Shape {
    public void draw() {}
}
 
class Circle extends Shape {
    public void draw() {
        System.out.println("Circle.draw()");
    }
}
```

ğŸš¨ å…¶å®ï¼Œä¸Šé¢è¯´çš„è¿”å›ç±»å‹å®Œå…¨ç›¸åŒå¹¶ä¸ä¸¥æ ¼æ­£ç¡®ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“**æ–¹æ³•çš„åå­—å’Œå‚æ•°åˆ—è¡¨ç§°ä¸ºæ–¹æ³•çš„ç­¾å**ã€‚ä¾‹å¦‚ï¼Œ`draw()`  å’Œ  `draw(String)` æ˜¯ä¸¤ä¸ªå…·æœ‰ç›¸åŒåå­—ï¼Œ ä¸åŒç­¾åçš„æ–¹æ³•ã€‚å¦‚æœåœ¨å­ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªä¸è¶…ç±»ç­¾åç›¸åŒçš„æ–¹æ³•ï¼Œ é‚£ä¹ˆå­ç±»ä¸­çš„è¿™ä¸ªæ–¹æ³•å°±è¦†ç›–/é‡å†™äº†è¶…ç±»ä¸­çš„è¿™ä¸ªç›¸åŒç­¾åçš„æ–¹æ³•ã€‚

ä¸è¿‡ï¼Œ**è¿”å›ç±»å‹ä¸æ˜¯ç­¾åçš„ä¸€éƒ¨åˆ†**ï¼Œ å› æ­¤ï¼Œåœ¨è¦†ç›–/é‡å†™æ–¹æ³•æ—¶ï¼Œ ä¸€å®šè¦ä¿è¯è¿”å›ç±»çš„å…¼å®¹æ€§ã€‚ **å…è®¸å­ç±»å°†è¦†ç›–æ–¹æ³•çš„è¿”å›ç±»å‹å®šä¹‰ä¸ºåŸè¿”å›ç±»å‹çš„å­ç±»å‹**ã€‚

ä¾‹å¦‚ï¼Œ å‡è®¾ `Shape` ç±»æœ‰

```java
class Shape {
    public Shape draw() {
    	......
    }
}
```

åœ¨åé¢çš„å­ç±» `Circle` ä¸­ï¼Œ å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ‰€ç¤ºçš„æ–¹å¼è¦†ç›–è¿™ä¸ªæ–¹æ³•

```java
class Circle extends Shape {
    public Circle draw() {
        ......
    }
}
```

ç”¨ä¸“ä¸šæœ¯è¯­æ¥è¯´ï¼Œè¿™ä¸¤ä¸ª `draw` æ–¹æ³•å…·æœ‰**å¯åå˜çš„è¿”å›ç±»å‹**ã€‚

ğŸ”¸ 2ï¼‰æ–¹æ³•é‡è½½å¹¶éå¤šæ€çš„å¿…è¦æ¡ä»¶ï¼Œä¸è¿‡å¯ä»¥ç†è§£æˆ**æŸä¸ªç±»çš„å¤šæ€æ€§çš„è¡¨ç°**ã€‚æ‰€è°“æ–¹æ³•é‡è½½ï¼Œå°±æ˜¯ä¸€ä¸ªç±»ä¸­å®šä¹‰äº†å¤šä¸ªæ–¹æ³•åç›¸åŒï¼Œä½†æ˜¯å‚æ•°çš„æ•°é‡æˆ–è€…ç±»å‹ä¸åŒã€‚æ–¹æ³•çš„è¿”å›ç±»å‹å’Œè®¿é—®æƒé™å¯ä»¥ä»»æ„ä¿®æ”¹ï¼Œä¸ä»¥å®ƒä¿©ä½œä¸ºæ–¹æ³•é‡è½½çš„æ ‡å¿—ã€‚

```java
class Circle extends Shape {
    public void draw() {
        System.out.println("Circle.draw()");
    }
  
    public void draw(int i) {
        System.out.println("Circle.draw()" + i);
    }
}
```

![image-20220618172249142](./personal_images/image-20220618172249142.webp)

æ€»ç»“ä¸€ä¸‹æ–¹æ³•é‡è½½å’Œé‡å†™ï¼š

|            | æ–¹æ³•é‡è½½ |                      æ–¹æ³•é‡å†™                      |
| :--------: | :------: | :------------------------------------------------: |
|   æ–¹æ³•å   |   ç›¸åŒ   |                        ç›¸åŒ                        |
|  å‚æ•°åˆ—è¡¨  | å¿…é¡»ä¸åŒ |                      å¿…é¡»ç›¸åŒ                      |
|  è¿”å›ç±»å‹  | å¯ä»¥ä¸åŒ | å­ç±»æ–¹æ³•çš„è¿”å›ç±»å‹å¯ä»¥æ˜¯åŸçˆ¶ç±»æ–¹æ³•è¿”å›ç±»å‹çš„å­ç±»å‹ |
| è®¿é—®ä¿®é¥°ç¬¦ | å¯ä»¥ä¸åŒ |       å­ç±»ä¸èƒ½åšæ›´ä¸¥æ ¼çš„é™åˆ¶ï¼ˆå¯ä»¥é™ä½é™åˆ¶ï¼‰       |

#### main æ–¹æ³•æ˜¯å¦å¯ä»¥é‡è½½

IBM æ—©äº›å¹´å‡ºè¿‡è¿™æ–¹é¢çš„é¢˜ï¼Œè€ƒå€’äº†ä¸€ç‰‡äººã€‚é¦–å…ˆï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œmain æ—¢ç„¶ä½œä¸ºä¸€ä¸ªæ–¹æ³•ï¼Œé‚£å®ƒå½“ç„¶å¯ä»¥è¢«é‡è½½ã€‚

ä½†æ˜¯ï¼Œ**å¦‚æœæ˜¯ä½œä¸ºç¨‹åºçš„å…¥å£ï¼Œé‚£ä¹ˆ main å‡½æ•°åªæœ‰ä¸€ç§å†™æ³•ï¼ŒJava è™šæ‹Ÿæœºåœ¨è¿è¡Œçš„æ—¶å€™åªä¼šè°ƒç”¨å¸¦æœ‰å‚æ•°æ˜¯ String æ•°ç»„çš„é‚£ä¸ª `main()` æ–¹æ³•**ï¼Œè€Œå…¶ä»–é‡è½½çš„å†™æ³•è™šæ‹Ÿæœºæ˜¯ä¸è®¤çš„ï¼Œåªèƒ½äººä¸ºçš„è°ƒç”¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```java
class Test {
	public static void main(String[] args) {
		main(1);
	}
	public static void main(int i) {
		System.out.println("é‡è½½çš„ main æ–¹æ³•");
	}
}
```

è¯¥ç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```text
é‡è½½çš„ main æ–¹æ³•
```

å¯ä»¥çœ‹å‡ºç¬¬ä¸€ä¸ª main æ–¹æ³•æ­£å¸¸è°ƒç”¨äº†é‡è½½çš„ç¬¬äºŒä¸ª main æ–¹æ³•ï¼Œå³ main æ–¹æ³•èƒ½å¤Ÿè¢«å®Œç¾é‡è½½ã€‚ä½†æ˜¯ç¨‹åºçš„å…¥å£ä»ç„¶æ˜¯ç¬¬ä¸€ä¸ª main æ–¹æ³•å³å‚æ•°ä¸º String æ•°ç»„ã€‚

![image-20220618172317736](./personal_images/image-20220618172317736.webp)

### æ„é€ å™¨ï¼ˆconstructorï¼‰æ˜¯å¦å¯è¢«é‡å†™ï¼ˆoverrideï¼‰ï¼Ÿ

æ„é€ å™¨ä¸èƒ½è¢«ç»§æ‰¿ï¼Œå› æ­¤ä¸èƒ½è¢«é‡å†™ï¼Œä½†å¯ä»¥è¢«é‡è½½

### Java ä¸­æ“ä½œå­—ç¬¦ä¸²éƒ½æœ‰å“ªäº›ç±»ï¼Ÿå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

æ“ä½œå­—ç¬¦ä¸²çš„ç±»æœ‰ï¼š**Stringã€StringBufferã€StringBuilder**ã€‚

ç¬¬ä¸€ç‚¹: å¯å˜å’Œé€‚ç”¨èŒƒå›´ã€‚Stringå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œè€ŒStringBufferå’ŒStringBuilderæ˜¯å¯å˜å­—ç¬¦åºåˆ—ã€‚æ¯æ¬¡å¯¹Stringçš„æ“ä½œç›¸å½“äºç”Ÿæˆä¸€ä¸ªæ–°çš„Stringå¯¹è±¡ï¼Œè€Œå¯¹StringBufferå’ŒStringBuilderçš„æ“ä½œæ˜¯å¯¹å¯¹è±¡æœ¬èº«çš„æ“ä½œï¼Œè€Œä¸ä¼šç”Ÿæˆæ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹äºé¢‘ç¹æ”¹å˜å†…å®¹çš„å­—ç¬¦ä¸²é¿å…ä½¿ç”¨Stringï¼Œå› ä¸ºé¢‘ç¹çš„ç”Ÿæˆå¯¹è±¡å°†ä¼šå¯¹ç³»ç»Ÿæ€§èƒ½äº§ç”Ÿå½±å“ã€‚

ç¬¬äºŒç‚¹: çº¿ç¨‹å®‰å…¨ã€‚Stringç”±äºæœ‰finalä¿®é¥°ï¼Œæ˜¯immutableçš„ï¼Œå®‰å…¨æ€§æ˜¯ç®€å•è€Œçº¯ç²¹çš„ã€‚StringBuilderå’ŒStringBufferçš„åŒºåˆ«åœ¨äºStringBuilderä¸ä¿è¯åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœéœ€è¦çº¿ç¨‹å®‰å…¨éœ€è¦ä½¿ç”¨StringBufferï¼Œä¸éœ€è¦åŒæ­¥çš„StringBuilderæ•ˆç‡æ›´é«˜

|               | å¯å˜æ€§ | çº¿ç¨‹å®‰å…¨                                                     |
| :-----------: | :----: | ------------------------------------------------------------ |
|    String     | ä¸å¯å˜ | å› ä¸ºä¸å¯å˜ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„                                 |
| StringBuffer  |  å¯å˜  | çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå…¶å†…éƒ¨å¤§å¤šæ•°æ–¹æ³•éƒ½ä½¿ç”¨ `synchronized`è¿›è¡ŒåŒæ­¥ã€‚å…¶æ•ˆç‡è¾ƒä½ |
| StringBuilder |  å¯å˜  | ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºæ²¡æœ‰ä½¿ç”¨ `synchronized`è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¹Ÿæ˜¯å…¶æ•ˆç‡é«˜äº StringBuffer  çš„åŸå› ã€‚å•çº¿ç¨‹ä¸‹ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ StringBuilderã€‚ |

### String str = "i" å’ŒString str = new String("1")â¼€æ ·å—ï¼Ÿ

ä¸â¼€æ ·ï¼Œå› ä¸ºå†…å­˜çš„åˆ†é…â½…å¼ä¸â¼€æ ·ã€‚String str="i"çš„â½…å¼ï¼ŒJVMä¼šå°†å…¶åˆ†é…åˆ°å¸¸é‡æ± ä¸­ï¼›â½½String str=new String("i")ï¼ŒJVMä¼šå°†å…¶åˆ†é…åˆ°å †å†…å­˜ä¸­ã€‚

### ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ååºåˆ—åŒ–?

å¦‚æœæˆ‘ä»¬éœ€è¦æŒä¹…åŒ– Java å¯¹è±¡æ¯”å¦‚å°† Java å¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç½‘ç»œä¼ è¾“ Java å¯¹è±¡ï¼Œè¿™äº›åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ã€‚

ç®€å•æ¥è¯´ï¼š

- **åºåˆ—åŒ–**ï¼š å°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹
- **ååºåˆ—åŒ–**ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµè½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹

å¯¹äº Java è¿™ç§é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€æ¥è¯´ï¼Œæˆ‘ä»¬åºåˆ—åŒ–çš„éƒ½æ˜¯å¯¹è±¡ï¼ˆObjectï¼‰ä¹Ÿå°±æ˜¯å®ä¾‹åŒ–åçš„ç±»(Class)ï¼Œä½†æ˜¯åœ¨ C++è¿™ç§åŠé¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ï¼Œstruct(ç»“æ„ä½“)å®šä¹‰çš„æ˜¯æ•°æ®ç»“æ„ç±»å‹ï¼Œè€Œ class å¯¹åº”çš„æ˜¯å¯¹è±¡ç±»å‹ã€‚

ç»´åŸºç™¾ç§‘æ˜¯å¦‚æ˜¯ä»‹ç»åºåˆ—åŒ–çš„ï¼š

> **åºåˆ—åŒ–**ï¼ˆserializationï¼‰åœ¨è®¡ç®—æœºç§‘å­¦çš„æ•°æ®å¤„ç†ä¸­ï¼Œæ˜¯æŒ‡å°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡çŠ¶æ€è½¬æ¢æˆå¯å–ç”¨æ ¼å¼ï¼ˆä¾‹å¦‚å­˜æˆæ–‡ä»¶ï¼Œå­˜äºç¼“å†²ï¼Œæˆ–ç»ç”±ç½‘ç»œä¸­å‘é€ï¼‰ï¼Œä»¥ç•™å¾…åç»­åœ¨ç›¸åŒæˆ–å¦ä¸€å°è®¡ç®—æœºç¯å¢ƒä¸­ï¼Œèƒ½æ¢å¤åŸå…ˆçŠ¶æ€çš„è¿‡ç¨‹ã€‚ä¾ç…§åºåˆ—åŒ–æ ¼å¼é‡æ–°è·å–å­—èŠ‚çš„ç»“æœæ—¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥äº§ç”Ÿä¸åŸå§‹å¯¹è±¡ç›¸åŒè¯­ä¹‰çš„å‰¯æœ¬ã€‚å¯¹äºè®¸å¤šå¯¹è±¡ï¼Œåƒæ˜¯ä½¿ç”¨å¤§é‡å¼•ç”¨çš„å¤æ‚å¯¹è±¡ï¼Œè¿™ç§åºåˆ—åŒ–é‡å»ºçš„è¿‡ç¨‹å¹¶ä¸å®¹æ˜“ã€‚é¢å‘å¯¹è±¡ä¸­çš„å¯¹è±¡åºåˆ—åŒ–ï¼Œå¹¶ä¸æ¦‚æ‹¬ä¹‹å‰åŸå§‹å¯¹è±¡æ‰€å…³ç³»çš„å‡½æ•°ã€‚è¿™ç§è¿‡ç¨‹ä¹Ÿç§°ä¸ºå¯¹è±¡ç¼–ç»„ï¼ˆmarshallingï¼‰ã€‚ä»ä¸€ç³»åˆ—å­—èŠ‚æå–æ•°æ®ç»“æ„çš„åå‘æ“ä½œï¼Œæ˜¯ååºåˆ—åŒ–ï¼ˆä¹Ÿç§°ä¸ºè§£ç¼–ç»„ã€deserializationã€unmarshallingï¼‰ã€‚

ç»¼ä¸Šï¼š**åºåˆ—åŒ–çš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡ç½‘ç»œä¼ è¾“å¯¹è±¡æˆ–è€…è¯´æ˜¯å°†å¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“ã€å†…å­˜ä¸­ã€‚**

![image-20220620170922943](./personal_images/image-20220620170922943.webp)

### final finally finalizeçš„åŒºåˆ«

* finalå¯ä»¥ä¿®é¥°ç±»ã€å˜é‡ã€â½…æ³•ï¼Œä¿®é¥°ç±»è¡¨ç¤ºè¯¥ç±»ä¸èƒ½è¢«ç»§æ‰¿ã€ä¿®é¥°â½…æ³•è¡¨ç¤ºè¯¥â½…æ³•ä¸èƒ½è¢«é‡å†™ã€ä¿®é¥°å˜é‡è¡¨ç¤ºè¯¥å˜é‡æ˜¯â¼€ä¸ªå¸¸é‡ä¸èƒ½è¢«é‡æ–°èµ‹å€¼ã€‚
* finallyâ¼€èˆ¬ä½œâ½¤åœ¨try-catchä»£ç å—ä¸­ï¼Œåœ¨å¤„ç†å¼‚å¸¸çš„æ—¶å€™ï¼Œé€šå¸¸æˆ‘ä»¬å°†â¼€å®šè¦æ‰§â¾çš„ä»£ç â½…æ³•finallyä»£ç å—ä¸­ï¼Œè¡¨ç¤ºä¸ç®¡æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œè¯¥ä»£ç å—éƒ½ä¼šæ‰§â¾ï¼Œâ¼€èˆ¬â½¤æ¥å­˜æ”¾â¼€äº›å…³é—­èµ„æºçš„ä»£ç ã€‚

> âš ï¸ç‰¹æ®Šæƒ…å†µï¼šå½“finallyä¸­åŒ…å«return
>
> ![image-20220619143704353](./personal_images/image-20220619143704353.webp)

* finalizeæ˜¯â¼€ä¸ªâ½…æ³•ï¼Œå±äºObjectç±»çš„â¼€ä¸ªâ½…æ³•ï¼Œâ½½Objectç±»æ˜¯æ‰€æœ‰ç±»çš„â½—ç±»ï¼Œè¯¥â½…æ³•â¼€èˆ¬ç”±åƒåœ¾å›æ”¶å™¨æ¥è°ƒâ½¤ï¼Œå½“æˆ‘ä»¬è°ƒâ½¤System.gc()â½…æ³•çš„æ—¶å€™ï¼Œç”±åƒåœ¾å›æ”¶å™¨è°ƒâ½¤finalize()ï¼Œå›æ”¶åƒåœ¾ï¼Œâ¼€ä¸ªå¯¹è±¡æ˜¯å¦å¯å›æ”¶çš„æœ€ååˆ¤æ–­ã€‚

> âš ï¸æ³¨ï¼š
>
> - Java è¯­è¨€æä¾›äº†å¯¹è±¡ç»ˆæ­¢ï¼ˆfinalizationï¼‰æœºåˆ¶æ¥å…è®¸å¼€å‘äººå‘˜æä¾›å¯¹è±¡è¢«é”€æ¯ä¹‹å‰çš„è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚
> - å½“åƒåœ¾å›æ”¶å™¨å‘ç°æ²¡æœ‰å¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå³ï¼šåƒåœ¾å›æ”¶æ­¤å¯¹è±¡ä¹‹å‰ï¼Œæ€»ä¼šå…ˆè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ `finalize( )` æ–¹æ³•ã€‚
> - `finalize( )` æ–¹æ³•å…è®¸åœ¨å­ç±»ä¸­è¢«é‡å†™ï¼Œç”¨äºåœ¨å¯¹è±¡è¢«å›æ”¶æ—¶è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾å’Œæ¸…ç†çš„å·¥ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶ã€å¥—æ¥å­—å’Œæ•°æ®åº“è¿æ¥ç­‰ã€‚
> - **æ°¸è¿œä¸è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå¯¹è±¡çš„ finalize ( ) æ–¹æ³•ï¼Œåº”è¯¥äº¤ç»™åƒåœ¾å›æ”¶æœºåˆ¶è°ƒç”¨**ã€‚ç†ç”±åŒ…æ‹¬ä¸‹é¢ä¸‰ç‚¹ï¼š
>   - åœ¨ `finalize( )` æ‰§è¡Œæ—¶å¯èƒ½ä¼šå¯¼è‡´å¯¹è±¡å¤æ´»ã€‚
>   - `finalize( )` æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´æ˜¯æ²¡æœ‰ä¿éšœçš„ï¼Œå®ƒå®Œå…¨ç”± GC çº¿ç¨‹å†³å®šï¼Œæç«¯æƒ…å†µä¸‹ï¼Œè‹¥ä¸å‘ç”Ÿ GCï¼Œåˆ™ `finalize( )` æ–¹æ³•å°†æ²¡æœ‰æ‰§è¡Œæœºä¼šã€‚
>   - ä¸€ä¸ªç³Ÿç³•çš„ `finalize( )` ä¼šä¸¥é‡å½±å“ GC çš„æ€§èƒ½ã€‚
> - ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œ`finalize( )` æ–¹æ³•ä¸ C++ ä¸­çš„ææ„å‡½æ•°æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ˜¯ Java é‡‡ç”¨çš„æ˜¯åŸºäºåƒåœ¾å›æ”¶å™¨çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥ `finalize( )` æ–¹æ³•åœ¨æœ¬è´¨ä¸Šä¸åŒäº C++ ä¸­çš„ææ„å‡½æ•°ã€‚
> - ç”±äº `finalize( )` æ–¹æ³•çš„å­˜åœ¨ï¼Œè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ä¸€èˆ¬å¤„äºä¸‰ç§å¯èƒ½çš„çŠ¶æ€

### â­Javaæœ‰å“ªäº›æ•°æ®ç±»å‹

* ğŸ”¢ æ•°å€¼ï¼šbyteï¼Œshortï¼Œintï¼Œlong
* ğŸ§¿ æµ®ç‚¹ï¼šfloatï¼Œdouble
* ğŸ”£ å­—ç¬¦ï¼šchar
* â˜‘ï¸ å¸ƒå°”ï¼šboolean

è¿™å…«ç§åŸºæœ¬ç±»å‹éƒ½æœ‰å¯¹åº”çš„åŒ…è£…ç±»åˆ†åˆ«ä¸ºï¼šByteã€Shortã€Integerã€Longã€Floatã€Doubleã€Characterã€Boolean

#### åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»å‹çš„åŒºåˆ«ï¼Ÿ

- åŒ…è£…ç±»å‹ä¸èµ‹å€¼å°±æ˜¯ `null` ï¼Œè€ŒåŸºæœ¬ç±»å‹æœ‰é»˜è®¤å€¼ä¸”ä¸æ˜¯ `null`ã€‚
- åŒ…è£…ç±»å‹å¯ç”¨äºæ³›å‹ï¼Œè€ŒåŸºæœ¬ç±»å‹ä¸å¯ä»¥ã€‚
- åŸºæœ¬æ•°æ®ç±»å‹çš„å±€éƒ¨å˜é‡å­˜æ”¾åœ¨ Java è™šæ‹Ÿæœºæ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹çš„æˆå‘˜å˜é‡ï¼ˆæœªè¢« `static` ä¿®é¥° ï¼‰å­˜æ”¾åœ¨ Java è™šæ‹Ÿæœºçš„å †ä¸­ã€‚åŒ…è£…ç±»å‹å±äºå¯¹è±¡ç±»å‹ï¼Œæˆ‘ä»¬çŸ¥é“å‡ ä¹æ‰€æœ‰å¯¹è±¡å®ä¾‹éƒ½å­˜åœ¨äºå †ä¸­ã€‚
- ç›¸æ¯”äºå¯¹è±¡ç±»å‹ï¼Œ åŸºæœ¬æ•°æ®ç±»å‹å ç”¨çš„ç©ºé—´éå¸¸å°ã€‚

**ä¸ºä»€ä¹ˆè¯´æ˜¯å‡ ä¹æ‰€æœ‰å¯¹è±¡å®ä¾‹å‘¢ï¼Ÿ** è¿™æ˜¯å› ä¸º HotSpot è™šæ‹Ÿæœºå¼•å…¥äº† JIT ä¼˜åŒ–ä¹‹åï¼Œä¼šå¯¹å¯¹è±¡è¿›è¡Œé€ƒé€¸åˆ†æï¼Œå¦‚æœå‘ç°æŸä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸åˆ°æ–¹æ³•å¤–éƒ¨ï¼Œé‚£ä¹ˆå°±å¯èƒ½é€šè¿‡æ ‡é‡æ›¿æ¢æ¥å®ç°æ ˆä¸Šåˆ†é…ï¼Œè€Œé¿å…å †ä¸Šåˆ†é…å†…å­˜

âš ï¸æ³¨æ„ ï¼š **åŸºæœ¬æ•°æ®ç±»å‹å­˜æ”¾åœ¨æ ˆä¸­æ˜¯ä¸€ä¸ªå¸¸è§çš„è¯¯åŒºï¼** åŸºæœ¬æ•°æ®ç±»å‹çš„æˆå‘˜å˜é‡å¦‚æœæ²¡æœ‰è¢« `static` ä¿®é¥°çš„è¯ï¼ˆä¸å»ºè®®è¿™ä¹ˆä½¿ç”¨ï¼Œåº”è¯¥è¦ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åŒ…è£…ç±»å‹ï¼‰ï¼Œå°±å­˜æ”¾åœ¨å †ä¸­ã€‚

```java
class BasicTypeVar{
  private int x;
}
```

#### åŒ…è£…ç±»å‹çš„ç¼“å­˜æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

Java åŸºæœ¬æ•°æ®ç±»å‹çš„åŒ…è£…ç±»å‹çš„å¤§éƒ¨åˆ†éƒ½ç”¨åˆ°äº†ç¼“å­˜æœºåˆ¶æ¥æå‡æ€§èƒ½ã€‚

`Byte`,`Short`,`Integer`,`Long` è¿™ 4 ç§åŒ…è£…ç±»é»˜è®¤åˆ›å»ºäº†æ•°å€¼ **[-128ï¼Œ127]** çš„ç›¸åº”ç±»å‹çš„ç¼“å­˜æ•°æ®ï¼Œ`Character` åˆ›å»ºäº†æ•°å€¼åœ¨ **[0,127]** èŒƒå›´çš„ç¼“å­˜æ•°æ®ï¼Œ`Boolean` ç›´æ¥è¿”å› `True` or `False`ã€‚

#### â­ï¸å ç”¨çš„ç©ºé—´å¤§å°

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼š å®ƒä»¬çš„é»˜è®¤å€¼å’Œå ç”¨çš„ç©ºé—´å¤§å°çŸ¥é“ä¸ï¼Ÿ

ğŸ™‹ æˆ‘ ï¼šè¿™ 8 ç§åŸºæœ¬æ•°æ®ç±»å‹çš„é»˜è®¤å€¼ä»¥åŠæ‰€å ç©ºé—´çš„å¤§å°å¦‚ä¸‹ï¼š

| åŸºæœ¬ç±»å‹ | ä½æ•° | å­—èŠ‚ | é»˜è®¤å€¼  |
| -------- | ---- | ---- | ------- |
| int      | 32   | 4    | 0       |
| short    | 16   | 2    | 0       |
| long     | 64   | 8    | 0L      |
| byte     | 8    | 1    | 0       |
| char     | 16   | 2    | 'u0000' |
| float    | 32   | 4    | 0f      |
| double   | 64   | 8    | 0d      |
| boolean  | 1    |      | false   |

å¦å¤–ï¼Œå¯¹äº booleanï¼Œå®˜æ–¹æ–‡æ¡£æœªæ˜ç¡®å®šä¹‰ï¼Œå®ƒä¾èµ–äº JVM å‚å•†çš„å…·ä½“å®ç°ã€‚é€»è¾‘ä¸Šç†è§£æ˜¯å ç”¨ 1 ä½ï¼Œä½†æ˜¯å®é™…ä¸­ä¼šè€ƒè™‘è®¡ç®—æœºé«˜æ•ˆå­˜å‚¨å› ç´ ã€‚



#### Java ä¸­ boolean å å¤šå°‘å­—èŠ‚ï¼Ÿ

Oracle å®˜æ–¹æ–‡æ¡£åœ°å€åœ¨æ­¤ï¼šhttps://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html

![img](./personal_images/image-20220706230119388.webp)

æ€»å…± 8 å¤§åŸºç¡€æ•°æ®ç±»å‹ï¼Œå…¶ä½™ 7 ä¸ªéƒ½éå¸¸æ˜ç¡®çš„æ ‡æ˜äº†å ç”¨å¤šå°‘å­—èŠ‚ï¼Œåªæœ‰ boolean æ¨¡æ£±ä¸¤å¯ï¼š

> **boolean**: The `boolean` data type has only two possible values: `true` and `false`. Use this data type for simple flags that track true/false conditions. This data type represents one bit of information, but its "size" isn't something that's precisely defined.

ç¿»è¯‘ä¸‹åˆ’çº¿éƒ¨åˆ†ï¼šè¿™ä¸ªæ•°æ®ç±»å‹è¡¨ç¤º 1 bit çš„ä¿¡æ¯ï¼ˆtrue or falseï¼Œç¼–è¯‘åç”¨ 0 æˆ– 1 æ¥è¡¨ç¤ºï¼‰ï¼Œä½†æ˜¯å®ƒçš„ size å¹¶æ²¡æœ‰è¢«ç²¾ç¡®åœ°å®šä¹‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸ç®¡å®ƒå å¤šå¤§çš„ç©ºé—´ï¼Œåªæœ‰ 1 ä¸ª bit çš„ä¿¡æ¯æ˜¯æœ‰æ„ä¹‰çš„ã€‚**

äº‹å®ä¸Šï¼Œboolean åˆ°åº•å ç”¨å¤šå°‘å¤§å°çš„ç©ºé—´ï¼Œâ€œIt's virtual machine dependent.â€ï¼Œ**å®Œå…¨å–å†³äº Java è™šæ‹Ÿæœºæœ¬èº«çš„è®¾è®¡**ã€‚

ä¸è¿‡æ˜¾ç„¶ boolean æ˜¯è‚¯å®šä¸å¯èƒ½åªå ç”¨ 1 ä¸ª bit çš„ï¼Œæœ€èµ·ç ä¹Ÿæ˜¯ 1 ä¸ª Bytesï¼ˆå­—èŠ‚ï¼‰ï¼Œå› ä¸ºè®¡ç®—æœºå¤„ç†æ•°æ®çš„æœ€å°å•ä½æ˜¯ 1 ä¸ªå­—èŠ‚

ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹äº boolean åˆ°åº•å ç”¨å¤šå°‘ç©ºé—´æä¾›äº†ä¸€å®šçš„å»ºè®®ï¼ˆåªæ˜¯å»ºè®®ï¼Œå…·ä½“çš„å®ç°ä»ç„¶å–å†³äºæ¯ä¸ªè™šæ‹Ÿæœºæ˜¯å¦æŒ‰ç…§è§„èŒƒæ¥ï¼‰ï¼Œå®˜æ–¹æ–‡æ¡£åœ¨è¿™é‡Œï¼šhttps://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.3.4

> Although the Java Virtual Machine defines a `boolean` type, it only provides very limited support for it. There are no Java Virtual Machine instructions solely dedicated to operations on `boolean` values. Instead, expressions in the Java programming language that operate on `boolean` values are compiled to use values of the Java Virtual Machine `int` data type.

å°½ç®¡ Java è™šæ‹Ÿæœºå®šä¹‰äº†ä¸€ä¸ªå¸ƒå°”ç±»å‹ï¼Œä½†æ˜¯å®ƒåªæä¾›äº†éå¸¸æœ‰é™çš„æ”¯æŒï¼Œ**å¹¶ã€æ²¡æœ‰ã€‘ä¸“é—¨ç”¨äºå¯¹ã€boolean å€¼ã€‘è¿›è¡Œæ“ä½œçš„ Java è™šæ‹ŸæœºæŒ‡ä»¤**ã€‚ç›¸åï¼Œ**Java ä¸­æ“ä½œ boolean å€¼çš„è¡¨è¾¾å¼è¢«ç¼–è¯‘ä¸ºä½¿ç”¨ int æ•°æ®ç±»å‹çš„å€¼**ã€‚

> The Java Virtual Machine does directly support `boolean` arrays. Its `newarray` instruction (`newarray`) enables creation of `boolean` arrays. Arrays of type `boolean` are accessed and modified using the `byte` array instructions `baload` and `bastore`.

ä¸è¿‡ï¼Œ**Java è™šæ‹Ÿæœºã€ç›´æ¥æ”¯æŒã€‘ã€boolean æ•°ç»„ã€‘**ï¼Œé€šè¿‡ `newarray` æŒ‡ä»¤åˆ›å»º boolean æ•°ç»„ï¼Œç„¶åé€šè¿‡ byte æ•°ç»„æŒ‡ä»¤ `baload` å’Œ `bastore` æ¥è®¿é—®å’Œä¿®æ”¹ boolean æ•°ç»„ã€‚

- `newarray` æŒ‡ä»¤ï¼šCreate new array
- `baload` æŒ‡ä»¤ï¼šLoad `byte` or `boolean` from array
- `bastore` æŒ‡ä»¤ï¼šStore into `byte` or `boolean` array

> In Oracleâ€™s Java Virtual Machine implementation, `boolean` arrays in the Java programming language are encoded as Java Virtual Machine `byte` arrays, using 8 bits per `boolean` element.

**åœ¨ Oracle çš„ Java è™šæ‹Ÿæœºå®ç°ä¸­ï¼ŒJava ä¸­çš„ boolean æ•°ç»„è¢«ç¼–ç ä¸º byte æ•°ç»„ï¼Œæ¯ä¸ª boolean å…ƒç´ ä½¿ç”¨ 1 å­—èŠ‚ï¼ˆ8 bitï¼‰**ã€‚

æ€»ç»“ä¸‹ï¼ŒJava è™šæ‹Ÿæœºè§„èŒƒæè®®ï¼š

- å¦‚æœ boolean æ˜¯ â€œå•ç‹¬ä½¿ç”¨â€ï¼šboolean è¢«ç¼–è¯‘ä¸º int ç±»å‹ï¼Œå  **4** ä¸ªå­—èŠ‚
- å¦‚æœboolean æ˜¯ä»¥ â€œboolean æ•°ç»„â€ çš„å½¢å¼ä½¿ç”¨ï¼šboolean å  **1** ä¸ªå­—èŠ‚ï¼ŒJava è™šæ‹Ÿæœºç›´æ¥æ”¯æŒ boolean æ•°ç»„ï¼Œé€šè¿‡ `newarray` æŒ‡ä»¤åˆ›å»º boolean æ•°ç»„ï¼Œç„¶åé€šè¿‡ byte æ•°ç»„æŒ‡ä»¤ `baload` å’Œ `bastore` æ¥è®¿é—®å’Œä¿®æ”¹ boolean æ•°ç»„



### float f=3.4;æ˜¯å¦æ­£ç¡®ï¼Ÿ

ä¸æ­£ç¡®ï¼Œèµ‹å€¼è¿ç®—ç¬¦ "=" å·¦å³ä¸¤è¾¹çš„ç²¾åº¦ç±»å‹ä¸åŒ¹é…ã€‚

Javaä¸­ï¼Œæœ‰å°æ•°ç‚¹çš„é»˜è®¤è¢«å­˜å‚¨ä¸ºdoubleç±»å‹ï¼Œå³åŒç²¾åº¦ï¼›è€Œfloatç±»å‹çš„å˜é‡ä¸ºå•ç²¾åº¦ã€‚

å¯ä»¥ä½¿ç”¨å¼ºè½¬æˆ–åŠ fï¼Œå³ float f = (folat)3.4ï¼Œfloat f = 3.4fã€‚

æµ‹è¯•ï¼š

```java
public static void main(String[] args) {
    float f = 3.14222222222222222222222;
    double d = 3.4;
    System.out.println(f);
    System.out.println(d);
}
-------------------------------------------
1.java:3: é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: ä»doubleè½¬æ¢åˆ°floatå¯èƒ½ä¼šæœ‰æŸå¤±
float f = 3.14222222222222222222222;
      ^
1 ä¸ªé”™è¯¯
```

> æ‹“å±•ï¼šInteger a = 1000ï¼ŒInteger b = 1000ï¼Œa==b çš„ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿé‚£å¦‚æœ aï¼Œb éƒ½ä¸º1ï¼Œç»“æœåˆæ˜¯ä»€ä¹ˆï¼Ÿ

Integer a = 1000ï¼ŒInteger b = 1000ï¼Œa==b ç»“æœä¸º**false**

Integer a = 1ï¼ŒInteger b = 1ï¼Œa==b ç»“æœä¸º**true**

è¿™é“é¢˜ä¸»è¦è€ƒå¯Ÿ Integer åŒ…è£…ç±»ç¼“å­˜çš„èŒƒå›´,**åœ¨-128~127ä¹‹é—´ä¼šç¼“å­˜èµ·æ¥**,æ¯”è¾ƒçš„æ˜¯ç›´æ¥ç¼“å­˜çš„æ•°æ®,åœ¨æ­¤ä¹‹å¤–æ¯”è¾ƒçš„æ˜¯å¯¹è±¡

### æˆå‘˜å˜é‡ä¸å±€éƒ¨å˜é‡çš„åŒºåˆ«æœ‰å“ªäº›ï¼Ÿ

1. ä»**è¯­æ³•å½¢å¼ä¸Š**çœ‹:æˆå‘˜å˜é‡æ˜¯å±äºç±»çš„ï¼Œè€Œå±€éƒ¨å˜é‡æ˜¯åœ¨æ–¹æ³•ä¸­å®šä¹‰çš„å˜é‡æˆ–æ˜¯æ–¹æ³•çš„å‚æ•°ï¼›æˆå‘˜å˜é‡å¯ä»¥è¢«public,private,staticç­‰ä¿®é¥°ç¬¦æ‰€ä¿®é¥°ï¼Œè€Œ**å±€éƒ¨å˜é‡ä¸èƒ½è¢«è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦åŠstaticæ‰€ä¿®é¥°**ï¼›ä½†æ˜¯ï¼Œæˆå‘˜å˜é‡å’Œå±€éƒ¨å˜é‡éƒ½èƒ½è¢«finalæ‰€ä¿®é¥°ã€‚
2. ä»å˜é‡**åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼**æ¥çœ‹:å¦‚æœæˆå‘˜å˜é‡æ˜¯ä½¿ç”¨staticä¿®é¥°çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæˆå‘˜å˜é‡æ˜¯å±äºç±»çš„ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨staticä¿®é¥°ï¼Œè¿™ä¸ªæˆå‘˜å˜é‡æ˜¯å±äºå®ä¾‹çš„ã€‚å¯¹è±¡å­˜äºå †å†…å­˜ï¼Œå¦‚æœå±€éƒ¨å˜é‡ç±»å‹ä¸ºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆå­˜å‚¨åœ¨æ ˆå†…å­˜ï¼Œå¦‚æœä¸ºå¼•ç”¨æ•°æ®ç±»å‹ï¼Œé‚£å­˜æ”¾çš„æ˜¯æŒ‡å‘å †å†…å­˜å¯¹è±¡çš„å¼•ç”¨æˆ–è€…æ˜¯æŒ‡å‘å¸¸é‡æ± ä¸­çš„åœ°å€ã€‚
3. ä»å˜é‡åœ¨**å†…å­˜ä¸­çš„ç”Ÿå­˜æ—¶é—´ä¸Š**çœ‹:æˆå‘˜å˜é‡æ˜¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒéšç€å¯¹è±¡çš„åˆ›å»ºè€Œå­˜åœ¨ï¼Œè€Œå±€éƒ¨å˜é‡éšç€æ–¹æ³•çš„è°ƒç”¨è€Œè‡ªåŠ¨æ¶ˆå¤±ã€‚
4. æˆå‘˜å˜é‡**å¦‚æœæ²¡æœ‰è¢«èµ‹åˆå€¼**:åˆ™ä¼šè‡ªåŠ¨ä»¥ç±»å‹çš„é»˜è®¤å€¼è€Œèµ‹å€¼ï¼ˆä¸€ç§æƒ…å†µä¾‹å¤–:è¢«finalä¿®é¥°çš„æˆå‘˜å˜é‡ä¹Ÿå¿…é¡»æ˜¾å¼åœ°èµ‹å€¼ï¼‰ï¼Œè€Œ**å±€éƒ¨å˜é‡åˆ™ä¸ä¼šè‡ªåŠ¨èµ‹å€¼**ã€‚

### â­æ¥å£å’ŒæŠ½è±¡ç±»çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

1. æ¥å£çš„æ–¹æ³•é»˜è®¤æ˜¯publicï¼Œæ‰€æœ‰æ–¹æ³•åœ¨æ¥å£ä¸­ä¸èƒ½æœ‰å®ç°(Java8å¼€å§‹æ¥å£æ–¹æ³•å¯ä»¥æœ‰é»˜è®¤å®ç°ï¼‰ï¼Œè€ŒæŠ½è±¡ç±»å¯ä»¥æœ‰éæŠ½è±¡çš„æ–¹æ³•ã€‚
2. æ¥å£ä¸­é™¤äº†staticã€finalå˜é‡ï¼Œä¸èƒ½æœ‰å…¶ä»–å˜é‡ï¼Œè€ŒæŠ½è±¡ç±»ä¸­åˆ™ä¸ä¸€å®šã€‚
3. ä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œä½†åªèƒ½å®ç°ä¸€ä¸ªæŠ½è±¡ç±»ã€‚æ¥å£è‡ªå·±æœ¬èº«å¯ä»¥é€šè¿‡extendså…³é”®å­—æ‰©å±•å¤šä¸ªæ¥å£ã€‚
4. æ¥å£æ–¹æ³•é»˜è®¤ä¿®é¥°ç¬¦æ˜¯publicï¼ŒæŠ½è±¡æ–¹æ³•å¯ä»¥æœ‰publicã€protectedå’Œdefaultè¿™äº›ä¿®é¥°ç¬¦ï¼ˆæŠ½è±¡æ–¹æ³•å°±æ˜¯ä¸ºäº†è¢«é‡å†™æ‰€ä»¥ä¸èƒ½ä½¿ç”¨privateå…³é”®å­—ä¿®é¥°ï¼ï¼‰ã€‚
5. ä»è®¾è®¡å±‚é¢æ¥è¯´ï¼ŒæŠ½è±¡æ˜¯å¯¹ç±»çš„æŠ½è±¡ï¼Œæ˜¯ä¸€ç§æ¨¡æ¿è®¾è®¡ï¼Œè€Œæ¥å£æ˜¯å¯¹è¡Œä¸ºçš„æŠ½è±¡ï¼Œæ˜¯ä¸€ç§è¡Œä¸ºçš„è§„èŒƒã€‚

### ğŸŒ Java æ³›å‹äº†è§£ä¹ˆï¼Ÿæ³›å‹çš„ä½œç”¨ï¼Ÿä»€ä¹ˆæ˜¯ç±»å‹æ“¦é™¤ï¼Ÿ

**Java æ³›å‹ï¼ˆGenericsï¼‰** æ˜¯ JDK 5 ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ã€‚ä½¿ç”¨æ³›å‹å‚æ•°ï¼Œå¯ä»¥å¢å¼ºä»£ç çš„å¯è¯»æ€§ä»¥åŠç¨³å®šæ€§ã€‚

ç¼–è¯‘å™¨å¯ä»¥å¯¹æ³›å‹å‚æ•°è¿›è¡Œæ£€æµ‹ï¼Œå¹¶ä¸”é€šè¿‡æ³›å‹å‚æ•°å¯ä»¥æŒ‡å®šä¼ å…¥çš„å¯¹è±¡ç±»å‹ã€‚æ¯”å¦‚ `ArrayList<Persion> persons = new ArrayList<Persion>()` è¿™è¡Œä»£ç å°±æŒ‡æ˜äº†è¯¥ `ArrayList` å¯¹è±¡åªèƒ½ä¼ å…¥ `Persion` å¯¹è±¡ï¼Œå¦‚æœä¼ å…¥å…¶ä»–ç±»å‹çš„å¯¹è±¡å°±ä¼šæŠ¥é”™ã€‚

```java
ArrayList<E> extends AbstractList<E>
```

å¹¶ä¸”ï¼ŒåŸç”Ÿ `List` è¿”å›ç±»å‹æ˜¯ `Object` ï¼Œéœ€è¦æ‰‹åŠ¨è½¬æ¢ç±»å‹æ‰èƒ½ä½¿ç”¨ï¼Œä½¿ç”¨æ³›å‹åç¼–è¯‘å™¨è‡ªåŠ¨è½¬æ¢ã€‚

æ³›å‹ä¸€èˆ¬æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼:**æ³›å‹ç±»**ã€**æ³›å‹æ¥å£**ã€**æ³›å‹æ–¹æ³•**ã€‚

Javaæ³›å‹çš„å®ç°é‡‡å–äº†â€œä¼ªæ³›å‹â€çš„ç­–ç•¥ï¼Œå³Javaåœ¨è¯­æ³•ä¸Šæ”¯æŒæ³›å‹ï¼Œä½†æ˜¯**åœ¨ç¼–è¯‘é˜¶æ®µä¼šè¿›è¡Œæ‰€è°“çš„â€œç±»å‹æ“¦é™¤â€ï¼ˆType  Erasureï¼‰**ï¼Œå°†æ‰€æœ‰çš„æ³›å‹è¡¨ç¤ºï¼ˆå°–æ‹¬å·ä¸­çš„å†…å®¹ï¼‰éƒ½æ›¿æ¢ä¸ºå…·ä½“çš„ç±»å‹ï¼ˆå…¶å¯¹åº”çš„åŸç”Ÿæ€ç±»å‹ï¼‰ï¼Œå°±åƒå®Œå…¨æ²¡æœ‰æ³›å‹ä¸€æ ·ã€‚ç†è§£**ç±»å‹æ“¦é™¤**å¯¹äºç”¨å¥½æ³›å‹æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå°¤å…¶æ˜¯ä¸€äº›çœ‹èµ·æ¥â€œç–‘éš¾æ‚ç—‡â€çš„é—®é¢˜ï¼Œå¼„æ˜ç™½äº†ç±»å‹æ“¦é™¤ä¹Ÿå°±è¿åˆƒè€Œè§£äº†ã€‚

æ³›å‹çš„ç±»å‹æ“¦é™¤åŸåˆ™æ˜¯ï¼š

- æ¶ˆé™¤ç±»å‹å‚æ•°å£°æ˜ï¼Œå³åˆ é™¤ `<>`åŠå…¶åŒ…å›´çš„éƒ¨åˆ†ã€‚
- æ ¹æ®ç±»å‹å‚æ•°çš„ä¸Šä¸‹ç•Œæ¨æ–­å¹¶æ›¿æ¢æ‰€æœ‰çš„ç±»å‹å‚æ•°ä¸ºåŸç”Ÿæ€ç±»å‹ï¼šå¦‚æœç±»å‹å‚æ•°æ˜¯æ— é™åˆ¶é€šé…ç¬¦æˆ–æ²¡æœ‰ä¸Šä¸‹ç•Œé™å®šåˆ™æ›¿æ¢ä¸ºObjectï¼Œå¦‚æœå­˜åœ¨ä¸Šä¸‹ç•Œé™å®šåˆ™æ ¹æ®å­ç±»æ›¿æ¢åŸåˆ™å–ç±»å‹å‚æ•°çš„æœ€å·¦è¾¹é™å®šç±»å‹ï¼ˆå³çˆ¶ç±»ï¼‰ã€‚
- ä¸ºäº†ä¿è¯ç±»å‹å®‰å…¨ï¼Œå¿…è¦æ—¶æ’å…¥å¼ºåˆ¶ç±»å‹è½¬æ¢ä»£ç ã€‚
- è‡ªåŠ¨äº§ç”Ÿâ€œæ¡¥æ¥æ–¹æ³•â€ä»¥ä¿è¯æ“¦é™¤ç±»å‹åçš„ä»£ç ä»ç„¶å…·æœ‰æ³›å‹çš„â€œå¤šæ€æ€§â€ã€‚

#### æ“¦é™¤ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°

**æ— é™åˆ¶ç±»å‹æ“¦é™¤**  å½“ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°æ²¡æœ‰ä»»ä½•é™åˆ¶æ—¶ï¼Œåœ¨ç±»å‹æ“¦é™¤ä¸­ç›´æ¥è¢«æ›¿æ¢ä¸ºObjectï¼Œå³å½¢å¦‚ `<T>`å’Œ `<?>`çš„ç±»å‹å‚æ•°éƒ½è¢«æ›¿æ¢ä¸ºObject

![image-20220617165626034](./personal_images/image-20220617165626034.webp)

**æœ‰é™åˆ¶ç±»å‹æ“¦é™¤**  å½“ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°å­˜åœ¨é™åˆ¶ï¼ˆä¸Šä¸‹ç•Œï¼‰æ—¶ï¼Œåœ¨ç±»å‹æ“¦é™¤ä¸­æ›¿æ¢ä¸ºç±»å‹å‚æ•°çš„ä¸Šç•Œæˆ–è€…ä¸‹ç•Œï¼Œæ¯”å¦‚å½¢å¦‚ `<T extends Number>`å’Œ `<? extends Number>`çš„ç±»å‹å‚æ•°è¢«æ›¿æ¢ä¸ºNumberï¼Œ`<? super  Number>`è¢«æ›¿æ¢ä¸ºObject

![image-20220617165706253](./personal_images/image-20220617165706253.webp)

#### æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°

æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°åŸåˆ™å’Œæ“¦é™¤ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä»…ä»¥æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„æœ‰é™åˆ¶ç±»å‹å‚æ•°ä¸ºä¾‹

![image-20220617165721328](./personal_images/image-20220617165721328.webp)

#### æ¡¥æ¥æ–¹æ³•å’Œæ³›å‹çš„å¤šæ€

http://softlab.sdut.edu.cn/blog/subaochen/2017/01/generics-type-erasure/

ç”±äºåŸæ–‡çš„ç¯‡å¹…è¿‡é•¿ï¼Œè¿›è¡Œä»¥ä¸‹æ€»ç»“ï¼š

æ‰€è°“çš„â€œæ¡¥æ¥æ–¹æ³•â€ï¼ˆbridge methodï¼‰æ¥æ»¡è¶³Javaè¯­æ³•çš„è¦æ±‚ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†åŸºäºæ³›å‹çš„å¤šæ€èƒ½å¤Ÿæœ‰æ•ˆ

è¿è¡Œçš„æ—¶å€™ï¼Œä¼šå¯¹ `Child`ç±»çš„æ–¹æ³•è¡¨è¿›è¡Œæœç´¢ï¼Œå…ˆåˆ†æä¸€ä¸‹ `Child`ç±»çš„æ–¹æ³•è¡¨é‡Œæœ‰å“ªäº›ä¸œè¥¿ï¼š

```java
1. sayHello(Object value) : ä»ç±»å‹è¢«æ“¦é™¤åçš„è¶…ç±»ä¸­ç»§æ‰¿è¿‡æ¥
2. sayHello(String value) : è‡ªå·±æ–°å¢çš„æ–¹æ³•ï¼Œå’Œè¶…ç±»æ¯«æ— è”ç³»
```

![image-20220622211220694](./personal_images/image-20220622211220694.webp)

å…·ä½“çš„ï¼š

```java
public class Parent<T> {
    public T data;

    public void setData(T data) {
        this.data = data;
    }
}

public class Child extends Parent<Integer> {
    @Override
    public void setData(Integer data) {
        super.setData(data);
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ³›å‹ç±» `Parent` å’Œä¸€ä¸ªæ‰©å±•äº† `Parent` çš„éæ³›å‹ç±» `Child`ã€‚æˆ‘ä»¬åœ¨ `Child` ä¸­è¦†ç›–äº† `Parent` ä¸­çš„ `setData` æ–¹æ³•ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œ`Child` ä¸­çš„ `setData` æ–¹æ³•è¦†ç›–çš„æ˜¯ `Parent<Integer>` ä¸­çš„ `setData` æ–¹æ³•ï¼Œè€Œé `Parent` ç±»ä¸­çš„æ³›å‹ `setData` æ–¹æ³•ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ `Child` ç±»ä¸­è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ¡¥æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```java
public void setData(Object data) {
    setData((Integer) data);
}
```

è¿™ä¸ªæ–¹æ³•çš„å‚æ•°æ˜¯ `Object` ç±»å‹ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥è¦†ç›– `Parent` ç±»ä¸­çš„ `setData` æ–¹æ³•äº†ã€‚å¹¶ä¸”ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šå°†å‚æ•°è½¬æ¢ä¸º `Integer` ç±»å‹ï¼Œç„¶åè°ƒç”¨ `Child` ç±»ä¸­çš„ `setData(Integer)` æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ˜ç¡®å†™å‡ºçš„æ–¹æ³•ã€‚

æ‰€ä»¥ï¼Œä½ å¹¶ä¸éœ€è¦æ‰‹åŠ¨å†™å‡ºæ¡¥æ–¹æ³•ï¼Œå®ƒæ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥çš„ã€‚å¹¶ä¸”ï¼Œæ¡¥æ–¹æ³•åªæœ‰åœ¨éœ€è¦è§£å†³æ³›å‹ç±»å‹æ“¦é™¤å¯¼è‡´çš„æ–¹æ³•è¦†ç›–é—®é¢˜æ—¶æ‰ä¼šè¢«ç”Ÿæˆã€‚



å°ç»“ä¸€ä¸‹ï¼š

åœ¨Javaä¸­ï¼Œå› ä¸ºæ³›å‹ä¿¡æ¯åœ¨ç¼–è¯‘åä¼šè¢«æ“¦é™¤ï¼Œæ‰€ä»¥è¿è¡Œæ—¶æ‰€æœ‰çš„æ³›å‹ç±»å‹éƒ½ä¼šå˜æˆå®ƒä»¬çš„ä¸Šç•Œï¼Œå¯¹äºæ²¡æœ‰æ˜ç¡®æŒ‡å®šä¸Šç•Œçš„æ³›å‹å‚æ•°ï¼Œå®ƒçš„ä¸Šç•Œé»˜è®¤æ˜¯ `Object`ã€‚

åœ¨ä½ çš„ä¾‹å­ä¸­ï¼Œ`Parent` ç±»ä¸­çš„ `setData` æ–¹æ³•çš„å‚æ•°ç±»å‹ `T` åœ¨è¿è¡Œæ—¶ä¼šå˜æˆ `Object`ã€‚å› æ­¤ï¼Œå¦‚æœ `Child` ç±»æƒ³è¦è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒçš„æ–¹æ³•å‚æ•°ä¹Ÿå¿…é¡»æ˜¯ `Object` ç±»å‹ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬åœ¨ `Child` ç±»ä¸­å®šä¹‰çš„ `setData` æ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯ `Integer`ï¼Œå› æ­¤å®ƒå¹¶æ²¡æœ‰çœŸæ­£è¦†ç›– `Parent` ç±»ä¸­çš„ `setData` æ–¹æ³•ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åœ¨ `Child` ç±»ä¸­ç”Ÿæˆä¸€ä¸ªæ¡¥æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹æ˜¯ `Object`ï¼Œå®ƒè¦†ç›–äº† `Parent` ç±»ä¸­çš„ `setData` æ–¹æ³•ã€‚è¿™ä¸ªæ¡¥æ–¹æ³•å†…éƒ¨ä¼šå°†å‚æ•°å¼ºåˆ¶è½¬æ¢ä¸º `Integer` ç±»å‹ï¼Œç„¶åè°ƒç”¨ `Child` ç±»ä¸­çš„ `setData(Integer)` æ–¹æ³•ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ `Parent` ç±»çš„å¼•ç”¨æ¥è°ƒç”¨ `Child` ç±»ä¸­çš„æ–¹æ³•äº†ï¼Œè€Œä¸ä¼šå‡ºç°ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ã€‚



#### ä¸ºäº†æ›´æ·±å±‚æ¬¡çš„ç†è§£ç±»å‹æ“¦é™¤ï¼Œé€‰å–äº†Stackoverflowçš„é«˜èµå›ç­”

åŸå¸–ï¼šhttps://stackoverflow.com/questions/339699/java-generics-type-erasure-when-and-what-happens

> ğŸ˜£é—®é¢˜æ˜¯ï¼š**When does type erasure occur?** At compile time or runtime? When the class is loaded? When the class is instantiated?
>
> ç±»å‹æ“¦é™¤ä½•æ—¶å‘ç”Ÿ? åœ¨ç¼–è¯‘æ—¶è¿˜æ˜¯è¿è¡Œæ—¶? å½“ç±»è¢«åŠ è½½æ—¶? å½“ç±»è¢«å®ä¾‹åŒ–æ—¶ï¼Ÿ

ğŸ§ç±»å‹æ“¦é™¤é€‚ç”¨äºæ³›å‹çš„ä½¿ç”¨ã€‚ç±»æ–‡ä»¶ä¸­è‚¯å®šæœ‰å…ƒæ•°æ®æ¥è¯´æ˜æ–¹æ³•/ç±»å‹æ˜¯å¦æ˜¯æ³›å‹ï¼Œä»¥åŠçº¦æŸæ˜¯ä»€ä¹ˆç­‰ç­‰ã€‚ä½†æ˜¯å½“ä½¿ç”¨æ³›å‹æ—¶ï¼Œå®ƒä»¬è¢«è½¬æ¢ä¸ºç¼–è¯‘æ—¶æ£€æŸ¥å’Œæ‰§è¡Œæ—¶å¼ºåˆ¶è½¬æ¢ã€‚æ‰€ä»¥è¿™ä¸ªä»£ç ï¼š

```java
List<String> list = new ArrayList<String>();
list.add("Hi");
String x = list.get(0);
```

è¢«ç¼–è¯‘æˆ

```java
List list = new ArrayList();
list.add("Hi");
String x = (String) list.get(0);
```

åœ¨æ‰§è¡Œæ—¶ï¼Œæ²¡æœ‰åŠæ³•æ‰¾å‡ºåˆ—è¡¨å¯¹è±¡çš„ T = String è¿™ä¸ªä¿¡æ¯å·²ç»æ¶ˆå¤±äº†ã€‚ä½†æ˜¯ List < T > ç•Œé¢æœ¬èº«ä»ç„¶å®£ç§°è‡ªå·±æ˜¯é€šç”¨çš„ã€‚

åŸå¸–ï¼šhttps://stackoverflow.com/questions/313584/what-is-the-concept-of-erasure-in-generics-in-java

> ğŸ˜£What is the concept of erasure in generics in Java?
>
> åœ¨ Javaçš„ç±»å‹æ“¦é™¤ä¸­ï¼Œæ“¦é™¤çš„æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ§è¿™åŸºæœ¬ä¸Šæ˜¯é€šè¿‡ç¼–è¯‘å™¨æŠ€å·§åœ¨ Java ä¸­å®ç°æ³›å‹çš„æ–¹å¼ã€‚ç¼–è¯‘åçš„æ³›å‹ä»£ç å®é™…ä¸Šåªä½¿ç”¨ java.langã€‚å¯¹è±¡ï¼Œè€Œä¸”æœ‰ä¸€äº›å…ƒæ•°æ®ï¼ˆsome metadataï¼‰å¯ä»¥å‘Šè¯‰ç¼–è¯‘å™¨å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ³›å‹ç±»å‹ã€‚

å½“ä½ é’ˆå¯¹ä¸€ä¸ªæ³›å‹ç±»å‹æˆ–æ–¹æ³•ç¼–è¯‘ä¸€äº›ä»£ç æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè®¡ç®—å‡ºä½ çš„çœŸæ­£æ„æ€(ä¾‹å¦‚ T çš„ç±»å‹å‚æ•°æ˜¯ä»€ä¹ˆ)  ï¼Œå¹¶åœ¨ç¼–è¯‘æ—¶éªŒè¯ä½ åšçš„æ˜¯æ­£ç¡®çš„äº‹æƒ…ï¼Œä½†æ˜¯å‘å‡ºçš„ä»£ç å†æ¬¡ä½¿ç”¨ java.langã€‚å¯¹è±¡-ç¼–è¯‘å™¨åœ¨å¿…è¦æ—¶ç”Ÿæˆé¢å¤–çš„å¼ºåˆ¶è½¬æ¢ã€‚åœ¨æ‰§è¡Œæ—¶ï¼ŒList  < String > å’Œ List < Date > å®Œå…¨ç›¸åŒ; ç¼–è¯‘å™¨å·²ç»æ“¦é™¤äº†é¢å¤–çš„ç±»å‹ä¿¡æ¯ã€‚

æ¯”è¾ƒä¸€ä¸‹ C # ï¼Œå®ƒåœ¨æ‰§è¡Œæ—¶ä¿ç•™ä¿¡æ¯ï¼Œå…è®¸ä»£ç åŒ…å«è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ typeof (T) ï¼Œå®ƒç­‰ä»·äº T  ç±»â€”â€”é™¤éåè€…æ˜¯æ— æ•ˆçš„ã€‚(ä¸¤è€…ä¹‹é—´è¿˜æœ‰è¿›ä¸€æ­¥çš„åŒºåˆ«ã€‚NET æ³›å‹å’Œ Java æ³›å‹ï¼Œè¯·æ³¨æ„ã€‚)åœ¨å¤„ç† Java  æ³›å‹æ—¶ï¼Œç±»å‹æ“¦é™¤æ˜¯è®¸å¤šâ€œå¥‡æ€ªâ€è­¦å‘Š/é”™è¯¯æ¶ˆæ¯çš„æ¥æºã€‚

> ğŸ¥±å†çœ‹ä¸€ä¸ªè¿™ä¸ªå›ç­”çš„å®æˆ˜å†…å®¹

æ“¦é™¤ï¼Œå­—é¢æ„æ€æ˜¯ä»å·²ç¼–è¯‘çš„å­—èŠ‚ç ä¸­æ“¦é™¤æºä»£ç ä¸­å­˜åœ¨çš„ç±»å‹ä¿¡æ¯ã€‚è®©æˆ‘ä»¬ç”¨ä¸€äº›ä»£ç æ¥ç†è§£è¿™ä¸€ç‚¹ã€‚

```java
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

public class GenericsErasure {
    public static void main(String args[]) {
        List<String> list = new ArrayList<String>();
        list.add("Hello");
        Iterator<String> iter = list.iterator();
        while(iter.hasNext()) {
            String s = iter.next();
            System.out.println(s);
        }
    }
}
```

å¦‚æœæ‚¨ç¼–è¯‘è¿™æ®µä»£ç ï¼Œç„¶åç”¨ Java åç¼–è¯‘å™¨åç¼–è¯‘å®ƒï¼Œæ‚¨å°†å¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„ä»£ç ã€‚æ³¨æ„ï¼Œåç¼–è¯‘çš„ä»£ç ä¸åŒ…å«åŸå§‹æºä»£ç ä¸­æ˜¾ç¤ºçš„ç±»å‹ä¿¡æ¯çš„è·Ÿè¸ªã€‚

```java
import java.io.PrintStream;
import java.util.*;

public class GenericsErasure
{

    public GenericsErasure()
    {
    }

    public static void main(String args[])
    {
        List list = new ArrayList();
        list.add("Hello");
        String s;
        for(Iterator iter = list.iterator(); iter.hasNext(); System.out.println(s))
            s = (String)iter.next();

    }
} 
```

### â­== ä¸ equals

å¯¹äº**åŸºæœ¬ç±»å‹**æ¥è¯´ï¼Œ== æ¯”è¾ƒçš„æ˜¯å€¼æ˜¯å¦ç›¸ç­‰ï¼›

å¯¹äº**å¼•ç”¨ç±»å‹**æ¥è¯´ï¼Œ== æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡åœ°å€ï¼ˆä¸¤è€…åœ¨å†…å­˜ä¸­å­˜æ”¾çš„åœ°å€ï¼ˆå †å†…å­˜åœ°å€ï¼‰æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªåœ°æ–¹ï¼‰ï¼›

equals ï¼šç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å†…å®¹æ˜¯å¦ç›¸ç­‰ã€‚æ³¨æ„ï¼šequals æ–¹æ³•ä¸èƒ½ç”¨äºæ¯”è¾ƒåŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡ã€‚å¦‚æœæ²¡æœ‰å¯¹ equals æ–¹æ³•è¿›è¡Œé‡å†™ï¼Œåˆ™æ¯”è¾ƒçš„æ˜¯å¼•ç”¨ç±»å‹çš„å˜é‡æ‰€æŒ‡å‘çš„å¯¹è±¡çš„åœ°å€ï¼ˆå¾ˆå¤šç±»é‡å†™äº† equals æ–¹æ³•ï¼Œæ¯”å¦‚ Stringã€Integer ç­‰æŠŠå®ƒå˜æˆäº†å€¼æ¯”è¾ƒï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ equals æ¯”è¾ƒçš„æ˜¯å€¼æ˜¯å¦ç›¸ç­‰ï¼‰

### hashCode ä¸ equals

1. å¦‚æœä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰ï¼Œåˆ™ hashcode ä¸€å®šä¹Ÿæ˜¯ç›¸åŒçš„
2. ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰,å¯¹ä¸¤ä¸ª equals() æ–¹æ³•è¿”å› true
3. ä¸¤ä¸ªå¯¹è±¡æœ‰ç›¸åŒçš„ hashcode å€¼ï¼Œå®ƒä»¬ä¹Ÿä¸ä¸€å®šæ˜¯ç›¸ç­‰çš„
4. ç»¼ä¸Šï¼Œ equals() æ–¹æ³•è¢«è¦†ç›–è¿‡ï¼Œåˆ™ hashCode() æ–¹æ³•ä¹Ÿå¿…é¡»è¢«è¦†ç›–
5. hashCode() çš„é»˜è®¤è¡Œä¸ºæ˜¯å¯¹å †ä¸Šçš„å¯¹è±¡äº§ç”Ÿç‹¬ç‰¹å€¼ã€‚å¦‚æœæ²¡æœ‰é‡å†™ hashCode() ï¼Œåˆ™è¯¥class çš„ä¸¤ä¸ªå¯¹è±¡æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰ï¼ˆå³ä½¿è¿™ä¸¤ä¸ªå¯¹è±¡æŒ‡å‘ç›¸åŒçš„æ•°æ®ï¼‰

### å¦‚ä½•å†³å®šä½¿ç”¨ HashMap è¿˜æ˜¯ TreeMapï¼Ÿ

> åŒºåˆ«ï¼š
> HashMapå®ç°Mapæ¥å£ï¼Œè€ŒTreeMapå®ç°SortedMapæ¥å£ï¼Œå®ƒæ˜¯Mapçš„å­æ¥å£ã€‚
> HashMapä½¿ç”¨å“ˆå¸Œæ¥å­˜å‚¨é”®å€¼å¯¹ï¼Œè€ŒTreeMapä½¿ç”¨çº¢é»‘æ ‘ï¼Œè¿™æ˜¯ä¸€ç§è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘ã€‚
> HashMapä¸ä¿è¯é”®æˆ–å€¼çš„ä»»ä½•é¡ºåºï¼Œè€ŒTreeMapæ ¹æ®é”®çš„è‡ªç„¶é¡ºåºæˆ–è‡ªå®šä¹‰æ¯”è¾ƒå™¨å¯¹é”®è¿›è¡Œæ’åºã€‚
> å¯¹äºå¤§å¤šæ•°æ“ä½œï¼Œå¦‚æ’å…¥ã€åˆ é™¤å’Œæ£€ç´¢ï¼ŒHashMapæ¯”TreeMapæ›´å¿«ï¼Œå› ä¸ºæ•£åˆ—æ¯”æ ‘éå†æ›´æœ‰æ•ˆã€‚ ä½†æ˜¯ï¼ŒTreeMapåœ¨æŸäº›æ“ä½œä¸Šæ¯”HashMapæ›´å¿«ï¼Œæ¯”å¦‚æŸ¥æ‰¾æœ€å°æˆ–æœ€å¤§é”®ï¼Œå› ä¸ºå®ƒä¸éœ€è¦æ‰«ææ•´ä¸ªæ˜ å°„ã€‚
> å‚è€ƒèµ„æ–™ï¼š
> 1. https://www.geeksforgeeks.org/hashmap-treemap-java/
> 2. https://howtodoinjava.com/java/collections/java-treemap-vs-hashmap/
> 3. https://stackoverflow.com/questions/2444359/what-is-the-difference-between-a-hashmap-and-a-treemap
> 4. https://www.javatpoint.com/difference-between-hashmap-and-treemap
> 5. https://www.baeldung.com/java-treemap-vs-hashmap

TreeMap å’ŒHashMap éƒ½ç»§æ‰¿è‡ªAbstractMap ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯TreeMapå®ƒè¿˜å®ç°äº†NavigableMapæ¥å£å’ŒSortedMap æ¥å£ã€‚

å®ç° NavigableMap æ¥å£è®© TreeMap æœ‰äº†å¯¹é›†åˆå†…å…ƒç´ çš„æœç´¢çš„èƒ½åŠ›ã€‚å®ç°SortedMapæ¥å£è®© TreeMap æœ‰äº†å¯¹é›†åˆä¸­çš„å…ƒç´ æ ¹æ®é”®æ’åºçš„èƒ½åŠ›ã€‚é»˜è®¤æ˜¯æŒ‰ key çš„å‡åºæ’åºï¼Œä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šæ’åºçš„æ¯”è¾ƒå™¨ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * @author shuang.kou
 * @createTime 2020å¹´06æœˆ15æ—¥ 17:02:00
 */
public class Person {
    private Integer age;

    public Person(Integer age) {
        this.age = age;
    }

    public Integer getAge() {
        return age;
    }


    public static void main(String[] args) {
        TreeMap<Person, String> treeMap = new TreeMap<>(new Comparator<Person>() {
            @Override
            public int compare(Person person1, Person person2) {
                int num = person1.getAge() - person2.getAge();
                return Integer.compare(num, 0);
            }
        });
        treeMap.put(new Person(3), "person1");
        treeMap.put(new Person(18), "person2");
        treeMap.put(new Person(35), "person3");
        treeMap.put(new Person(16), "person4");
        treeMap.entrySet().stream().forEach(personStringEntry -> {
            System.out.println(personStringEntry.getValue());
        });
    }
}
// person1
// person4
// person2
// person3

```
å¯ä»¥çœ‹å‡ºï¼ŒTreeMap ä¸­çš„å…ƒç´ å·²ç»æ˜¯æŒ‰ç…§ Person çš„ age å­—æ®µçš„å‡åºæ¥æ’åˆ—äº†ã€‚

ä¸Šé¢ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ä¼ å…¥åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼å®ç°çš„ï¼Œä½ å¯ä»¥å°†ä»£ç æ›¿æ¢æˆ Lambda è¡¨è¾¾å¼å®ç°çš„æ–¹å¼ï¼š

```java
TreeMap<Person, String> treeMap = new TreeMap<>((person1, person2) -> {
  int num = person1.getAge() - person2.getAge();
  return Integer.compare(num, 0);
});

```


**ç»“è®º**
å¦‚æœä½ éœ€è¦å¾—åˆ°ä¸€ä¸ªæœ‰åºçš„ç»“æœæ—¶å°±åº”è¯¥ä½¿ç”¨TreeMapï¼ˆå› ä¸ºHashMapä¸­å…ƒç´ çš„æ’åˆ—é¡ºåºæ˜¯ä¸å›ºå®šçš„ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºHashMapæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œæ‰€ä»¥å¤§å¤šä¸éœ€è¦æ’åºçš„æ—¶å€™æˆ‘ä»¬ä¼šä½¿ç”¨HashMapã€‚å¦å¤–ï¼Œç›¸æ¯”äºHashMapæ¥è¯´ TreeMap ä¸»è¦å¤šäº†å¯¹é›†åˆä¸­çš„å…ƒç´ æ ¹æ®é”®æ’åºçš„èƒ½åŠ›ä»¥åŠå¯¹é›†åˆå†…å…ƒç´ çš„æœç´¢çš„èƒ½åŠ›ã€‚

### â­HashMap çš„åº•å±‚å®ç°

#### JDK1.8 ä¹‹å‰

JDK1.8 ä¹‹å‰ `HashMap` åº•å±‚æ˜¯ **æ•°ç»„å’Œé“¾è¡¨** ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ä¹Ÿå°±æ˜¯ **é“¾è¡¨æ•£åˆ—**ã€‚**HashMap é€šè¿‡ key çš„ hashCode ç»è¿‡æ‰°åŠ¨å‡½æ•°å¤„ç†è¿‡åå¾—åˆ° hash å€¼ï¼Œç„¶åé€šè¿‡ (n - 1) & hash  åˆ¤æ–­å½“å‰å…ƒç´ å­˜æ”¾çš„ä½ç½®ï¼ˆè¿™é‡Œçš„ n æŒ‡çš„æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ï¼Œå¦‚æœå½“å‰ä½ç½®å­˜åœ¨å…ƒç´ çš„è¯ï¼Œå°±åˆ¤æ–­è¯¥å…ƒç´ ä¸è¦å­˜å…¥çš„å…ƒç´ çš„ hash å€¼ä»¥åŠ key  æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çªã€‚**

**æ‰€è°“æ‰°åŠ¨å‡½æ•°æŒ‡çš„å°±æ˜¯ HashMap çš„ hash æ–¹æ³•ã€‚ä½¿ç”¨ hash æ–¹æ³•ä¹Ÿå°±æ˜¯æ‰°åŠ¨å‡½æ•°æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›å®ç°æ¯”è¾ƒå·®çš„ hashCode() æ–¹æ³• æ¢å¥è¯è¯´ä½¿ç”¨æ‰°åŠ¨å‡½æ•°ä¹‹åå¯ä»¥å‡å°‘ç¢°æ’ã€‚**

**JDK 1.8 HashMap çš„ hash æ–¹æ³•æºç :**

JDK 1.8 çš„ hash æ–¹æ³• ç›¸æ¯”äº JDK 1.7 hash æ–¹æ³•æ›´åŠ ç®€åŒ–ï¼Œä½†æ˜¯åŸç†ä¸å˜ã€‚

```java
    static final int hash(Object key) {
      int h;
      // key.hashCode()ï¼šè¿”å›æ•£åˆ—å€¼ä¹Ÿå°±æ˜¯hashcode
      // ^ ï¼šæŒ‰ä½å¼‚æˆ–
      // >>>:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½
      return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
  }
```

å¯¹æ¯”ä¸€ä¸‹ JDK1.7 çš„ HashMap çš„ hash æ–¹æ³•æºç .

```java
static int hash(int h) {
    // This function ensures that hashCodes that differ only by
    // constant multiples at each bit position have a bounded
    // number of collisions (approximately 8 at default load factor).

    h ^= (h >>> 20) ^ (h >>> 12);
    return h ^ (h >>> 7) ^ (h >>> 4);
}
```

ç›¸æ¯”äº JDK1.8 çš„ hash æ–¹æ³• ï¼ŒJDK 1.7 çš„ hash æ–¹æ³•çš„æ€§èƒ½ä¼šç¨å·®ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºæ¯•ç«Ÿæ‰°åŠ¨äº† 4 æ¬¡ã€‚

æ‰€è°“ **â€œæ‹‰é“¾æ³•â€** å°±æ˜¯ï¼šå°†é“¾è¡¨å’Œæ•°ç»„ç›¸ç»“åˆã€‚ä¹Ÿå°±æ˜¯è¯´åˆ›å»ºä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸€æ ¼å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚è‹¥é‡åˆ°å“ˆå¸Œå†²çªï¼Œåˆ™å°†å†²çªçš„å€¼åŠ åˆ°é“¾è¡¨ä¸­å³å¯ã€‚

![image-20220616155615352](./personal_images/image-20220616155615352.webp)

#### JDK1.8 ä¹‹å

ç›¸æ¯”äºä¹‹å‰çš„ç‰ˆæœ¬ï¼Œ JDK1.8 ä¹‹ååœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚å¦‚æœæ˜¯çº¢é»‘æ ‘ï¼Œå½“å…ƒç´ æ•°é‡å°‘äº6æ—¶ï¼Œä¼šé€€åŒ–ä¸ºé“¾è¡¨ã€‚

![image-20220616155623710](./personal_images/image-20220616155623710.webp)

> TreeMapã€TreeSet ä»¥åŠ JDK1.8 ä¹‹åçš„ HashMap åº•å±‚éƒ½ç”¨åˆ°äº†çº¢é»‘æ ‘ã€‚çº¢é»‘æ ‘å°±æ˜¯ä¸ºäº†è§£å†³äºŒå‰æŸ¥æ‰¾æ ‘çš„ç¼ºé™·ï¼Œå› ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€€åŒ–æˆä¸€ä¸ªçº¿æ€§ç»“æ„ã€‚

> é¢è¯•å¯ä»¥è¿™æ ·å›ç­”ï¼šhashmapçš„åº•å±‚æ˜¯å“ˆå¸Œè¡¨ï¼Œæ˜¯åŸºäºhashç®—æ³•å®ç°çš„ï¼Œhashmapé€šè¿‡put(key,value)å­˜å‚¨ï¼Œé€šè¿‡get(key)è·å–ï¼Œå½“ä¼ å…¥keyæ—¶ï¼Œhashmapä¼šè°ƒç”¨key.hashcode()æ–¹æ³•è®¡ç®—å‡ºhashå€¼ï¼Œæ ¹æ® hash å€¼å°† value ä¿å­˜åœ¨ bucket é‡Œã€‚å½“è®¡ç®—
>
> å‡ºçš„ hash å€¼ç›¸åŒæ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º hash å†²çªï¼ŒHashMap çš„åšæ³•æ˜¯ç”¨é“¾è¡¨å’Œçº¢é»‘æ ‘å­˜å‚¨ç›¸åŒ hash å€¼çš„valueã€‚å½“ hash å†²çªçš„ä¸ªæ•°å°‘äºç­‰äº8ä¸ªæ—¶ï¼Œä½¿ç”¨é“¾è¡¨å¦åˆ™ä½¿ç”¨çº¢é»‘æ ‘ã€‚

### â­HashMapæºç åˆ†æ
> è¿™é‡Œæä¾›çš„æ˜¯open jdk11çš„æºç ï¼Œä½†æ˜¯å›¾æ²¡å˜è¿˜æ˜¯entryï¼ˆæ²¡æ‰¾åˆ°åˆé€‚çš„ï¼‰ï¼Œä½†æ˜¯åŸç†éƒ½å·®ä¸å¤šï¼Œæš‚æ—¶å…ˆç”¨ç€è¿™ä¸ªå›¾ï¼


#### è®¡ç®—å“ˆå¸Œå€¼ï¼šhash
```java
static final int hash(Object key) {
	int h;
	return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```
`(h = key.hashCode()) ^ (h >>> 16) `æ˜¯Javaä¸­çš„ä¸€ç§å“ˆå¸Œå€¼è®¡ç®—ç­–ç•¥ï¼Œç›®çš„æ˜¯å‡å°‘å“ˆå¸Œç¢°æ’å¹¶æ›´å¥½åœ°åˆ†å¸ƒæ•°æ®ã€‚
å…·ä½“æ¥è¯´ï¼š
- `(h = key.hashCode())`ï¼šè¿™ä¸€æ­¥è°ƒç”¨é”®ï¼ˆkeyï¼‰çš„hashCodeæ–¹æ³•ä»¥è·å–åŸå§‹çš„å“ˆå¸Œå€¼ã€‚
- `(h >>> 16)`ï¼šè¿™æ˜¯ä¸€ä¸ªæ— ç¬¦å·å³ç§»æ“ä½œï¼Œå°†å“ˆå¸Œå€¼çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼å‘å³ç§»åŠ¨16ä½ã€‚ç”±äºJavaçš„intç±»å‹æ˜¯32ä½çš„ï¼Œè¿™å®é™…ä¸Šæ˜¯å°†å“ˆå¸Œå€¼çš„é«˜16ä½ç§»åŠ¨åˆ°ä½16ä½ã€‚
- `(h = key.hashCode()) ^ (h >>> 16)`ï¼šè¿™æ˜¯ä¸€ä¸ªå¼‚æˆ–æ“ä½œï¼Œå®ƒå°†åŸå§‹çš„å“ˆå¸Œå€¼å’Œå³ç§»16ä½åçš„å“ˆå¸Œå€¼è¿›è¡Œå¼‚æˆ–æ“ä½œã€‚è¿™æ ·å¯ä»¥ä¿è¯åŸå“ˆå¸Œå€¼çš„é«˜ä½å’Œä½ä½éƒ½èƒ½å‚ä¸åˆ°æœ€ç»ˆçš„å“ˆå¸Œå€¼è®¡ç®—ä¸­

è¿™æ ·å¤„ç†çš„ä¸»è¦ç›®çš„æ˜¯åœ¨ä¸å¢åŠ è®¡ç®—å¤æ‚åº¦çš„å‰æä¸‹ï¼Œå°½å¯èƒ½å‡å°‘å“ˆå¸Œç¢°æ’å¹¶æ›´å¥½åœ°åˆ†å¸ƒæ•°æ®ã€‚å› ä¸ºHashMapä¸­çš„bucketé€‰æ‹©ä¸»è¦æ˜¯é€šè¿‡å“ˆå¸Œå€¼çš„ä½ä½è¿›è¡Œçš„ï¼Œå¦‚æœåŸå§‹å“ˆå¸Œå€¼çš„é«˜ä½å’Œä½ä½ç›¸ä¼¼ï¼Œé‚£ä¹ˆè¿›è¡Œè¿™æ ·çš„å¤„ç†èƒ½å¤Ÿå°†é«˜ä½çš„ä¿¡æ¯å¸¦å…¥åˆ°ä½ä½ï¼Œä»è€Œæé«˜bucketçš„é€‰æ‹©èŒƒå›´ï¼Œå‡å°‘ç¢°æ’ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š

å‡è®¾æœ‰ä¸€ä¸ª`String`å¯¹è±¡ï¼Œå…¶`hashCode()`æ–¹æ³•è¿”å›çš„å€¼ä¸º`123456789`ã€‚

åœ¨32ä½äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œè¿™ä¸ªæ•°å€¼çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```shell
0000 0111 0101 1011 1100 1101 0001 0101
```

å½“æˆ‘ä»¬å°†è¿™ä¸ªå€¼å³ç§»16ä½ï¼ˆ`>>> 16`ï¼‰åï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š

```shell
0000 0000 0000 0000 0000 0111 0101 1011
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿™ä¸¤ä¸ªå€¼è¿›è¡Œå¼‚æˆ–ï¼ˆ`^`ï¼‰æ“ä½œï¼š

```shell
0000 0111 0101 1011 1100 1101 0001 0101 (hashCode)
0000 0000 0000 0000 0000 0111 0101 1011 (hashCode >>> 16)
---------------------------------------
0000 0111 0101 1011 1100 1101 0110 1110 (result)
```

æœ€ç»ˆç»“æœå°±æ˜¯æ–°çš„å“ˆå¸Œå€¼ã€‚

ç°åœ¨ï¼Œä½ å¯èƒ½ä¼šé—®ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·çš„æ“ä½œã€‚åœ¨HashMapä¸­ï¼Œæˆ‘ä»¬`é€šå¸¸ä½¿ç”¨å“ˆå¸Œå€¼çš„ä½ä½æ¥å†³å®šä¸€ä¸ªå…ƒç´ å­˜æ”¾åœ¨å“ªä¸ªæ¡¶ä¸­ï¼Œé«˜ä½åˆ™ä¸å¸¸ç”¨`ã€‚å½“æˆ‘ä»¬å°†hashCodeå³ç§»16ä½åï¼ŒåŸæ¥çš„é«˜ä½è¢«æ”¾åˆ°äº†ä½ä½ã€‚ç„¶åæˆ‘ä»¬é€šè¿‡å¼‚æˆ–æ“ä½œï¼Œä½¿å¾—æ–°çš„ä½ä½åŒæ—¶å—åˆ°åŸå§‹çš„é«˜ä½å’Œä½ä½çš„å½±å“ï¼Œè¿™æ ·å°±`ä½¿å¾—åŸæ¥ä¸å¸¸ä½¿ç”¨çš„é«˜ä½ä¿¡æ¯ä¹Ÿèƒ½å‚ä¸åˆ°æ¡¶çš„é€‰æ‹©ä¸­`ï¼Œä»è€Œä½¿å¾—å…ƒç´ åœ¨å„ä¸ªæ¡¶ä¹‹é—´çš„åˆ†å¸ƒæ›´å‡åŒ€ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸å·§å¦™çš„è®¾è®¡ï¼Œæ—¢åˆ©ç”¨åˆ°äº†åŸå§‹çš„hashCodeä¿¡æ¯ï¼Œä¹Ÿæ”¹å–„äº†å“ˆå¸Œåˆ†å¸ƒã€‚



#### getNode()

`get(Object key)`æ–¹æ³•æ ¹æ®æŒ‡å®šçš„ `key`å€¼è¿”å›å¯¹åº”çš„ `value`ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº† `getEntry(Object key)`å¾—åˆ°ç›¸åº”çš„ `entry`ï¼Œç„¶åè¿”å› `entry.getValue()`ã€‚å› æ­¤ `getEntry()`æ˜¯ç®—æ³•çš„æ ¸å¿ƒã€‚ **ç®—æ³•æ€æƒ³**æ˜¯é¦–å…ˆé€šè¿‡ `hash()`å‡½æ•°å¾—åˆ°å¯¹åº” `bucket`çš„ä¸‹æ ‡ï¼Œç„¶åä¾æ¬¡éå†å†²çªé“¾è¡¨ï¼Œé€šè¿‡ `key.equals(k)`æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è¦æ‰¾çš„é‚£ä¸ª `entry`ã€‚

> getNodeæ–¹æ³•çš„ç®—æ³•æ€æƒ³å’ŒgetEntryç±»ä¼¼ï¼Œå®ƒä»¬éƒ½æ˜¯æ ¹æ®é”®æ¥å¯»æ‰¾å¯¹åº”çš„èŠ‚ç‚¹ã€‚ä¸»è¦åŒºåˆ«åœ¨äºï¼ŒJava 8åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ¡¶ä½ä¸­çš„èŠ‚ç‚¹æ•°ç›®è¶…è¿‡äº†ä¸€å®šçš„é˜ˆå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡¶ä½çš„å­˜å‚¨ç»“æ„ä¼šä»é“¾è¡¨è½¬å˜ä¸ºçº¢é»‘æ ‘ï¼Œä»¥æé«˜æŸ¥æ‰¾çš„æ•ˆç‡ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨Java 11ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•è¢«å‘½åä¸ºgetNodeï¼Œè€Œä¸å†æ˜¯getEntryï¼Œå› ä¸ºç°åœ¨ä¸ä»…æœ‰Entryï¼Œè¿˜å¯èƒ½æ˜¯TreeNodeã€‚

æ€»ç»“ä¸€ä¸‹ï¼š
1. æ ¹æ®é”®çš„å“ˆå¸Œå€¼æ‰¾åˆ°å¯¹åº”çš„æ¡¶ä½ã€‚è¿™ä¸ªè¿‡ç¨‹å’ŒgetEntryæ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡(n - 1) & hashè®¡ç®—ç´¢å¼•ï¼Œå…¶ä¸­næ˜¯å“ˆå¸Œè¡¨çš„é•¿åº¦ï¼Œhashæ˜¯é”®çš„å“ˆå¸Œå€¼ã€‚
2. åœ¨æ‰¾åˆ°çš„æ¡¶ä½ä¸­æŸ¥æ‰¾èŠ‚ç‚¹ã€‚å¦‚æœè¿™ä¸ªæ¡¶ä½çš„å­˜å‚¨ç»“æ„æ˜¯é“¾è¡¨ï¼Œé‚£ä¹ˆä¼šåƒgetEntryæ–¹æ³•ä¸€æ ·ï¼Œé€šè¿‡éå†é“¾è¡¨çš„æ–¹å¼æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ã€‚å¦‚æœæ¡¶ä½çš„å­˜å‚¨ç»“æ„æ˜¯çº¢é»‘æ ‘ï¼Œé‚£ä¹ˆä¼šé€šè¿‡çº¢é»‘æ ‘çš„æŸ¥æ‰¾ç®—æ³•æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ã€‚
3. å¯¹äºæ‰¾åˆ°çš„èŠ‚ç‚¹ï¼Œæ£€æŸ¥èŠ‚ç‚¹çš„é”®æ˜¯å¦ä¸è¾“å…¥çš„é”®ç›¸åŒã€‚å¦‚æœç›¸åŒï¼Œé‚£ä¹ˆå°±æ‰¾åˆ°äº†å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå°†å…¶è¿”å›ã€‚

æ‰€ä»¥ï¼ŒgetNodeæ–¹æ³•çš„ä¸»è¦æ€æƒ³æ˜¯æ ¹æ®é”®çš„å“ˆå¸Œå€¼å®šä½æ¡¶ä½ï¼Œç„¶ååœ¨æ¡¶ä½ä¸­æ ¹æ®å­˜å‚¨ç»“æ„çš„ä¸åŒï¼Œé‡‡ç”¨ä¸åŒçš„æŸ¥æ‰¾ç®—æ³•æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ã€‚è¿™ç§æ–¹æ³•æ—¢ä¿è¯äº†æ•°æ®çš„å¿«é€ŸæŸ¥æ‰¾ï¼Œåˆèƒ½å¤Ÿå¤„ç†å“ˆå¸Œå†²çªçš„æƒ…å†µã€‚

![image-20220616161400630](./personal_images/image-20220616161400630.webp)

**å®šä½æ¡¶ä½ï¼š**
```java
Node<K,V> p;
if ((p = tab[i = (n - 1) & hash]) == null)
    tab[i] = newNode(hash, key, value, null);
```
`n`æ˜¯å“ˆå¸Œè¡¨çš„é•¿åº¦ï¼Œå®ƒæ€»æ˜¯2çš„å¹‚ã€‚`(n - 1) & hash` æ˜¯è®¡ç®—**é”®å€¼åº”è¯¥å­˜æ”¾åœ¨å“ªä¸ªæ¡¶ï¼ˆå³æ•°ç»„çš„ç´¢å¼•ï¼‰** çš„å…¬å¼ã€‚è¿™é‡Œåˆ©ç”¨äº†å“ˆå¸Œè¡¨é•¿åº¦æ˜¯2çš„å¹‚çš„ç‰¹æ€§ï¼Œå°†å“ˆå¸Œå€¼ä¸`n-1`è¿›è¡Œä½ä¸è¿ç®—ï¼Œç­‰ä»·äºå¯¹å“ˆå¸Œè¡¨é•¿åº¦å–æ¨¡ï¼Œç»“æœå°±æ˜¯è¯¥é”®å€¼åº”è¯¥æ”¾åœ¨çš„ä½ç½®

åœ¨æ­¤ï¼Œ`(n - 1) & hash` è¿™ä¸ªæ“ä½œå¯ä»¥çœ‹ä½œæ˜¯å°†å“ˆå¸Œå€¼æ˜ å°„åˆ°å“ˆå¸Œè¡¨çš„é•¿åº¦èŒƒå›´å†…ã€‚ç”±äº`n` æ˜¯2çš„å¹‚ï¼Œ`n - 1` çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­æ‰€æœ‰çš„ä½éƒ½æ˜¯1ï¼ˆæ¯”å¦‚ï¼Œå‡è®¾table.lengthä¸º8ï¼ˆå³1000 in binaryï¼‰ï¼Œé‚£ä¹ˆtable.length - 1å°±æ˜¯7ï¼Œå³111 in binaryï¼‰ã€‚å› æ­¤ï¼Œ`(n - 1) & hash` çš„ç»“æœå°±ç›¸å½“äºä¿ç•™äº†å“ˆå¸Œå€¼çš„ä½ä½ï¼Œè¿™æ ·å¯ä»¥å°†å“ˆå¸Œå€¼å‡åŒ€åœ°åˆ†å¸ƒåœ¨æ•°ç»„çš„é•¿åº¦èŒƒå›´å†…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå“ˆå¸Œå€¼çš„æ¯ä¸ªå¯èƒ½å€¼éƒ½æœ‰å‡ç­‰çš„æœºä¼šè¢«æ˜ å°„åˆ°æ•°ç»„çš„ä»»ä½•ä½ç½®ã€‚

å¦‚æœè¿™ä¸ªä½ç½®å·²ç»æœ‰å€¼ï¼ˆå³ä¸ä¸ºnullï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªé”®å€¼å¯¹ä¼šä»¥é“¾è¡¨æˆ–è€…çº¢é»‘æ ‘çš„æ–¹å¼å­˜å‚¨åœ¨è¯¥ä½ç½®ã€‚å¦‚æœè¿™ä¸ªä½ç½®æ²¡æœ‰å€¼ï¼ˆå³ä¸ºnullï¼‰ï¼Œé‚£ä¹ˆç›´æ¥å­˜å‚¨åœ¨è¯¥ä½ç½®ã€‚

è¿™é‡Œçš„ `p = tab[i = (n - 1) & hash]` é¦–å…ˆè®¡ç®—ç´¢å¼• iï¼Œç„¶åå°è¯•ä»è¡¨ä¸­è·å–è¯¥ç´¢å¼•ä½ç½®çš„èŠ‚ç‚¹ pã€‚å¦‚æœ p ä¸º nullï¼Œé‚£å°±æ„å‘³ç€æ­¤ä½ç½®è¿˜æ²¡æœ‰å­˜æ”¾ä»»ä½•é”®å€¼å¯¹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ”¾ç½®æ–°çš„é”®å€¼å¯¹ã€‚

---

è¿™éƒ¨åˆ†æ£€æŸ¥æ¡¶ä½çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰çš„å“ˆå¸Œå€¼æ˜¯å¦ä¸è¾“å…¥çš„å“ˆå¸Œå€¼ç›¸åŒï¼ŒåŒæ—¶æ¯”è¾ƒèŠ‚ç‚¹çš„é”®æ˜¯å¦ä¸è¾“å…¥çš„é”®ç›¸ç­‰ã€‚å¦‚æœéƒ½ç›¸åŒï¼Œé‚£ä¹ˆå®ƒå°±æ‰¾åˆ°äº†å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è¿”å›
```java
if (first.hash == hash && ((k = first.key) == key || (key != null && key.equals(k))))
	return first;
```

---

è¿™éƒ¨åˆ†é¦–å…ˆæ£€æŸ¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆnextï¼‰æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œå†æ£€æŸ¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸€ä¸ªæ ‘èŠ‚ç‚¹ï¼ˆTreeNodeï¼‰ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥è¿™ä¸ªæ¡¶ä½æ˜¯å¦æ˜¯çº¢é»‘æ ‘çš„ç»“æ„ã€‚å¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå®ƒå°†é€šè¿‡çº¢é»‘æ ‘çš„æ–¹å¼è·å–å¯¹åº”çš„èŠ‚ç‚¹ã€‚
```java
if ((e = first.next) != null) {
    if (first instanceof TreeNode)
        return ((TreeNode<K,V>)first).getTreeNode(hash, key);
```

---

è¿™éƒ¨åˆ†æ˜¯å¯¹é“¾è¡¨è¿›è¡Œéå†ã€‚å¦‚æœæ¡¶ä½æ˜¯é“¾è¡¨çš„ç»“æ„ï¼Œé‚£ä¹ˆä¼šé€šè¿‡å¾ªç¯éå†é“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œæ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„å“ˆå¸Œå€¼å’Œé”®æ˜¯å¦ä¸è¾“å…¥çš„ç›¸åŒã€‚å¦‚æœæ‰¾åˆ°ç›¸åŒçš„ï¼Œé‚£ä¹ˆå°±è¿”å›å¯¹åº”çš„èŠ‚ç‚¹ã€‚å¦‚æœéå†å®Œé“¾è¡¨éƒ½æ²¡æœ‰æ‰¾åˆ°ç›¸åŒçš„ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€HashMapä¸­ä¸å­˜åœ¨å¯¹åº”çš„èŠ‚ç‚¹ã€‚
```java
do {
    if (e.hash == hash &&
        ((k = e.key) == key || (key != null && key.equals(k))))
        return e;
} while ((e = e.next) != null);
```

---

**ä»£ç æ€»è§ˆ**ï¼š
```java
final Node<K,V> getNode(int hash, Object key) {
	Node<K,V>[] tab; Node<K,V> first, e; int n; K k;
	if ((tab = table) != null && (n = tab.length) > 0 &&
		(first = tab[(n - 1) & hash]) != null) {
		if (first.hash == hash && // always check first node
			((k = first.key) == key || (key != null && key.equals(k))))
			return first;
		if ((e = first.next) != null) {
			if (first instanceof TreeNode)
				return ((TreeNode<K,V>)first).getTreeNode(hash, key);
			do {
				if (e.hash == hash &&
					((k = e.key) == key || (key != null && key.equals(k))))
					return e;
			} while ((e = e.next) != null);
		}
	}
	return null;
}
```

#### putVal()

`put(K key, V value)`æ–¹æ³•æ˜¯å°†æŒ‡å®šçš„ `key, value`å¯¹æ·»åŠ åˆ° `map`é‡Œã€‚è¯¥æ–¹æ³•é¦–å…ˆä¼šå¯¹ `map`åšä¸€æ¬¡æŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦åŒ…å«è¯¥å…ƒç»„ï¼Œå¦‚æœå·²ç»åŒ…å«åˆ™ç›´æ¥è¿”å›ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç±»ä¼¼äº `getEntry()`æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šé€šè¿‡ `addEntry(int hash, K key, V value, int bucketIndex)`æ–¹æ³•æ’å…¥æ–°çš„ `entry`ï¼Œæ’å…¥æ–¹å¼ä¸º**å¤´æ’æ³•**ã€‚

ç®—æ³•æ€è·¯ï¼š
1. **å“ˆå¸Œè®¡ç®—ä¸å®šä½æ¡¶ä½**ï¼š é¦–å…ˆï¼Œè®¡ç®—é”®ï¼ˆkeyï¼‰çš„å“ˆå¸Œå€¼ï¼Œç„¶åæ ¹æ®å“ˆå¸Œå€¼åœ¨å“ˆå¸Œè¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ¡¶ä½ã€‚è®¡ç®—æ¡¶ä½çš„ç´¢å¼•æ˜¯é€šè¿‡ (n - 1) & hashï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—å“ˆå¸Œå€¼å‡åŒ€åœ°åˆ†å¸ƒåœ¨æ•°ç»„çš„é•¿åº¦èŒƒå›´å†…ã€‚
2. **å¤„ç†æ¡¶ä½ä¸ºç©ºçš„æƒ…å†µ**ï¼š å¦‚æœæ‰¾åˆ°çš„æ¡¶ä½æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±ç›´æ¥åœ¨è¿™ä¸ªä½ç½®ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æ¥å­˜å‚¨é”®å€¼å¯¹ã€‚
3. **å¤„ç†æ¡¶ä½ä¸ä¸ºç©ºçš„æƒ…å†µ**ï¼š å¦‚æœæ¡¶ä½ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆéœ€è¦å¤„ç†å“ˆå¸Œå†²çªã€‚æ ¹æ®è¯¥æ¡¶ä½çš„æ•°æ®ç»“æ„ï¼ˆé“¾è¡¨æˆ–è€…çº¢é»‘æ ‘ï¼‰é‡‡ç”¨ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚
	1. **é“¾è¡¨**ï¼š éå†é“¾è¡¨ï¼Œå¦‚æœæ‰¾åˆ°äº†é”®å€¼ç›¸åŒçš„èŠ‚ç‚¹ï¼Œåˆ™æ›¿æ¢å…¶å€¼ã€‚å¦‚æœéå†å®Œé“¾è¡¨æ²¡æœ‰æ‰¾åˆ°ç›¸åŒçš„é”®ï¼Œé‚£ä¹ˆå°±åœ¨é“¾è¡¨çš„å°¾éƒ¨æ·»åŠ ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ã€‚
	2. **çº¢é»‘æ ‘**ï¼š åœ¨çº¢é»‘æ ‘ä¸­æ‰¾åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œå¦‚æœæ‰¾åˆ°äº†é”®å€¼ç›¸åŒçš„èŠ‚ç‚¹ï¼Œåˆ™æ›¿æ¢å…¶å€¼ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸åŒçš„é”®ï¼Œé‚£ä¹ˆå°±åœ¨æ­£ç¡®çš„ä½ç½®æ·»åŠ ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ã€‚
4. **å¤„ç†æ‰©å®¹**ï¼š æ’å…¥é”®å€¼å¯¹ä¹‹åï¼Œéœ€è¦æ£€æŸ¥å“ˆå¸Œè¡¨æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚å¦‚æœå½“å‰çš„èŠ‚ç‚¹æ•°é‡è¶…è¿‡äº†é˜ˆå€¼ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†å“ˆå¸Œè¡¨çš„å®¹é‡æ‰©å¤§ä¸€å€ï¼Œå¹¶é‡æ–°è®¡ç®—æ¯ä¸ªé”®å€¼å¯¹åœ¨å“ˆå¸Œè¡¨ä¸­çš„ä½ç½®ã€‚

![image-20220616161439305](./personal_images/image-20220616161439305.webp)

**æ’å…¥æˆ–æ›´æ–°èŠ‚ç‚¹**ï¼šè¯¥éƒ¨åˆ†æœ‰ç‚¹å¤æ‚ï¼Œå¤„ç†å„ç§æƒ…å†µï¼Œå¦‚é“¾è¡¨å’Œçº¢é»‘æ ‘ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå­˜åœ¨ç›¸åŒçš„é”®ï¼Œé‚£ä¹ˆå®ƒå°†æ›¿æ¢æ—§å€¼ã€‚
```java
Node<K,V> e; K k;
if (p.hash == hash &&
    ((k = p.key) == key || (key != null && key.equals(k))))
    e = p;
```

**å¤„ç†ä¸åŒæƒ…å†µï¼š**
- else if (p instanceof TreeNode)è¿™æ®µä»£ç æ˜¯å¤„ç†å½“å‰æ¡¶ä½æ•°æ®å·²ç»è½¬å˜ä¸ºçº¢é»‘æ ‘çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¢é»‘æ ‘çš„æ–¹å¼å°†é”®å€¼å¯¹æ’å…¥åˆ°æ ‘ä¸­ã€‚
- è€Œelseåé¢çš„ä»£ç åˆ™å¤„ç†é“¾è¡¨çš„æƒ…å†µã€‚å®ƒä¼šéå†é“¾è¡¨ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å’Œå½“å‰æ’å…¥é”®ç›¸åŒçš„èŠ‚ç‚¹ã€‚å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆå°±ç›´æ¥æ›¿æ¢èŠ‚ç‚¹çš„å€¼ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±åœ¨é“¾è¡¨çš„å°¾éƒ¨æ·»åŠ æ–°çš„èŠ‚ç‚¹ã€‚
- åœ¨æ·»åŠ æ–°èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ£€æŸ¥å½“å‰çš„é“¾è¡¨é•¿åº¦æ˜¯å¦è¾¾åˆ°äº†æ ‘åŒ–é˜ˆå€¼ï¼ˆTREEIFY_THRESHOLDï¼‰ã€‚å¦‚æœè¾¾åˆ°äº†ï¼Œé‚£ä¹ˆä¼šå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œè¿™æ˜¯ä¸ºäº†æé«˜åç»­çš„æŸ¥æ‰¾æ•ˆç‡ã€‚å› ä¸ºé“¾è¡¨çš„æŸ¥æ‰¾æ•ˆç‡æ˜¯O(n)ï¼Œè€Œçº¢é»‘æ ‘çš„æŸ¥æ‰¾æ•ˆç‡æ˜¯O(log n)ã€‚åœ¨å…ƒç´ æ•°é‡è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡ä¼šæ¯”é“¾è¡¨æ›´é«˜ã€‚

```java
static final int TREEIFY_THRESHOLD = 8;
```

```java
else if (p instanceof TreeNode)
    e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
else {
    for (int binCount = 0; ; ++binCount) {
        if ((e = p.next) == null) {
            p.next = newNode(hash, key, value, null);
            if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                treeifyBin(tab, hash);
            break;
        }
        if (e.hash == hash &&
            ((k = e.key) == key || (key != null && key.equals(k))))
            break;
        p = e;
    }
}
```

**æ‰©å®¹**ï¼šåœ¨æ·»åŠ å…ƒç´ åï¼Œå¦‚æœHashMapçš„å¤§å°è¶…è¿‡äº†é˜ˆå€¼ï¼Œé‚£ä¹ˆHashMapä¼šè¿›è¡Œæ‰©å®¹
```java
if (++size > threshold)
    resize();
```

>HashMapä¸ºä»€ä¹ˆè¦æ‰©å±•ä¸ºåŸæ¥çš„2å€è€Œä¸æ˜¯å…¶ä»–å€æ•°ï¼Ÿ

1. **è¿ç®—ç®€å•**ï¼šå°†å®¹é‡æ‰©å±•ä¸º 2 çš„å¹‚æ¬¡æ–¹æœ‰åŠ©äºæé«˜è®¡ç®—æ€§èƒ½ã€‚åœ¨è®¡ç®—æœºå†…éƒ¨ï¼Œä½æ“ä½œé€šå¸¸æ¯”å…¶ä»–ç®—æœ¯è¿ç®—æ›´å¿«ã€‚å½“å®¹é‡ä¸º 2 çš„å¹‚æ¬¡æ–¹æ—¶ï¼Œå¯¹åº”çš„å“ˆå¸Œå‡½æ•°å¯ä»¥é€šè¿‡ç®€å•çš„ä½æ“ä½œæ¥è®¡ç®—ï¼Œè€Œä¸éœ€è¦æ‰§è¡Œæ›´å¤æ‚çš„æ¨¡è¿ç®—ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå®¹é‡ä¸º 2^nï¼Œé‚£ä¹ˆè®¡ç®—å“ˆå¸Œå€¼çš„ç´¢å¼•å°±æ˜¯ index = hash & (2^n - 1)ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä½æ“ä½œã€‚
2. **åˆ†å¸ƒå‡åŒ€**ï¼šHashMapçš„æ•£åˆ—å‡½æ•°æ˜¯(n - 1) & hashã€‚å½“å®¹é‡ä¸º 2 çš„å¹‚æ•°æ—¶ï¼Œå“ˆå¸Œå€¼åœ¨åˆ†æ¡¶ä¸­çš„åˆ†å¸ƒæ›´å‡åŒ€ï¼ˆå¦‚æœæ‰©å®¹ä¸º2å€ï¼Œé‚£ä¹ˆn-1çš„ä½ä½å…¨ä¸º1ï¼Œä¸åŸæ¥å“ˆå¸Œå€¼çš„ä½ä½è¿›è¡Œä¸è¿ç®—ï¼Œå¯ä»¥ä¿è¯å“ˆå¸Œæ¡¶çš„åˆ†å¸ƒä¿æŒç›¸åŒï¼‰ã€‚å¦‚æœä½¿ç”¨å…¶ä»–å€æ•°ï¼Œä¾‹å¦‚ 3 çš„å¹‚æ¬¡æ–¹ï¼Œå¯èƒ½å¯¼è‡´åˆ†å¸ƒä¸å‡åŒ€ï¼ˆä½ä½ä¸å…¨ä¸º1ï¼Œå’ŒåŸæ¥å“ˆå¸Œå€¼è¿›è¡Œä¸è¿ç®—åï¼Œå“ˆå¸Œæ¡¶çš„åˆ†å¸ƒä¼šå‘ç”Ÿå˜åŒ–ï¼‰ï¼Œè¿›è€Œå½±å“åˆ° HashMap çš„æ€§èƒ½ã€‚
3. **é‡æ–°æ•£åˆ—çš„æˆæœ¬æ›´ä½**ï¼šå› ä¸ºn-1çš„ä½ä½å…¨ä¸º1ï¼Œç›¸å½“äºåªæ˜¯åœ¨é«˜ä½å¢åŠ äº†1bitï¼Œé‚£ä¹ˆåŸæ¥çš„é”®å€¼å¯¹åªéœ€è¦ç§»åŠ¨2æ¬¡(åŸç´¢å¼•+0å’ŒåŸç´¢å¼•+oldCap)å°±å¯ä»¥è¿ç§»åˆ°æ–°çš„tableä¸­æ­£ç¡®çš„ä½ç½®ã€‚å¦‚æœæ‰©å®¹ä¸æ˜¯2å€ï¼Œé”®å€¼å¯¹çš„è¿ç§»æˆæœ¬ä¼šæ›´é«˜ã€‚
4. **é“¾è¡¨è½¬çº¢é»‘æ ‘æ›´åˆé€‚**ï¼šHashMapçš„é“¾è¡¨è½¬çº¢é»‘æ ‘çš„é˜ˆå€¼æ˜¯8ï¼Œå¦‚æœæ‰©å®¹ä¸º2å€ï¼Œé‚£ä¹ˆåŸæ¥çš„é”®å€¼å¯¹è¿ç§»åˆ°æ–°çš„tableåï¼Œåœ¨åŸç´¢å¼•ä½ç½®å’ŒåŸç´¢å¼•+oldCapä½ç½®çš„é“¾è¡¨ä¸ªæ•°ä¹‹å’Œå°±å·²ç»è¾¾åˆ°8ä¸ªï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¿ç§»è¿‡ç¨‹ä¸­è¿›è¡Œæ ‘åŒ–ã€‚å¦‚æœæ‰©å®¹å€æ•°æ›´å¤§ï¼Œè¾¾åˆ°æ ‘åŒ–é˜ˆå€¼å°±è¦æ›´é•¿çš„é“¾è¡¨ï¼Œå½±å“æ€§èƒ½ã€‚

**ä»£ç æ€»è§ˆ**ï¼š
```java
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
	Node<K,V>[] tab; Node<K,V> p; int n, i;
	if ((tab = table) == null || (n = tab.length) == 0)
		n = (tab = resize()).length;
	if ((p = tab[i = (n - 1) & hash]) == null)
		tab[i] = newNode(hash, key, value, null);
	else {
		Node<K,V> e; K k;
		if (p.hash == hash &&
			((k = p.key) == key || (key != null && key.equals(k))))
			e = p;
		else if (p instanceof TreeNode)
			e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
		else {
			for (int binCount = 0; ; ++binCount) {
				if ((e = p.next) == null) {
					p.next = newNode(hash, key, value, null);
					if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
						treeifyBin(tab, hash);
					break;
				}
				if (e.hash == hash &&
					((k = e.key) == key || (key != null && key.equals(k))))
					break;
				p = e;
			}
		}
		if (e != null) { // existing mapping for key
			V oldValue = e.value;
			if (!onlyIfAbsent || oldValue == null)
				e.value = value;
			afterNodeAccess(e);
			return oldValue;
		}
	}
	++modCount;
	if (++size > threshold)
		resize();
	afterNodeInsertion(evict);
	return null;
}
```

#### removeNode()

`remove(Object key)`çš„ä½œç”¨æ˜¯åˆ é™¤ `key`å€¼å¯¹åº”çš„ `entry`ï¼Œè¯¥æ–¹æ³•çš„å…·ä½“é€»è¾‘æ˜¯åœ¨ `removeEntryForKey(Object key)`é‡Œå®ç°çš„ã€‚`removeEntryForKey()`æ–¹æ³•ä¼šé¦–å…ˆæ‰¾åˆ° `key`å€¼å¯¹åº”çš„ `entry`ï¼Œç„¶ååˆ é™¤è¯¥ `entry`(ä¿®æ”¹é“¾è¡¨çš„ç›¸åº”å¼•ç”¨)ã€‚æŸ¥æ‰¾è¿‡ç¨‹è·Ÿ `getEntry()`è¿‡ç¨‹ç±»ä¼¼ã€‚

![image-20220616161551183](./personal_images/image-20220616161551183.webp)

**ä»£ç æ€»è§ˆ**ï¼š
```java
final Node<K,V> removeNode(int hash, Object key, Object value,
                               boolean matchValue, boolean movable) {
	Node<K,V>[] tab; Node<K,V> p; int n, index;
	if ((tab = table) != null && (n = tab.length) > 0 &&
		(p = tab[index = (n - 1) & hash]) != null) {
		Node<K,V> node = null, e; K k; V v;
		if (p.hash == hash &&
			((k = p.key) == key || (key != null && key.equals(k))))
			node = p;
		else if ((e = p.next) != null) {
			if (p instanceof TreeNode)
				node = ((TreeNode<K,V>)p).getTreeNode(hash, key);
			else {
				do {
					if (e.hash == hash &&
						((k = e.key) == key ||
						 (key != null && key.equals(k)))) {
						node = e;
						break;
					}
					p = e;
				} while ((e = e.next) != null);
			}
		}
		if (node != null && (!matchValue || (v = node.value) == value ||
							 (value != null && value.equals(v)))) {
			if (node instanceof TreeNode)
				((TreeNode<K,V>)node).removeTreeNode(this, tab, movable);
			else if (node == p)
				tab[index] = node.next;
			else
				p.next = node.next;
			++modCount;
			--size;
			afterNodeRemoval(node);
			return node;
		}
	}
	return null;
}
```

### HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹

ä¸ºäº†èƒ½è®© HashMap å­˜å–é«˜æ•ˆï¼Œå°½é‡è¾ƒå°‘ç¢°æ’ï¼Œä¹Ÿå°±æ˜¯è¦å°½é‡æŠŠæ•°æ®åˆ†é…å‡åŒ€ã€‚æˆ‘ä»¬ä¸Šé¢ä¹Ÿè®²åˆ°äº†è¿‡äº†ï¼ŒHash  å€¼çš„èŒƒå›´å€¼-2147483648 åˆ° 2147483647ï¼Œå‰ååŠ èµ·æ¥å¤§æ¦‚ 40  äº¿çš„æ˜ å°„ç©ºé—´ï¼Œåªè¦å“ˆå¸Œå‡½æ•°æ˜ å°„å¾—æ¯”è¾ƒå‡åŒ€æ¾æ•£ï¼Œä¸€èˆ¬åº”ç”¨æ˜¯å¾ˆéš¾å‡ºç°ç¢°æ’çš„ã€‚ä½†é—®é¢˜æ˜¯ä¸€ä¸ª 40  äº¿é•¿åº¦çš„æ•°ç»„ï¼Œå†…å­˜æ˜¯æ”¾ä¸ä¸‹çš„ã€‚æ‰€ä»¥è¿™ä¸ªæ•£åˆ—å€¼æ˜¯ä¸èƒ½ç›´æ¥æ‹¿æ¥ç”¨çš„ã€‚ç”¨ä¹‹å‰è¿˜è¦å…ˆåšå¯¹æ•°ç»„çš„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰èƒ½ç”¨æ¥è¦å­˜æ”¾çš„ä½ç½®ä¹Ÿå°±æ˜¯å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚è¿™ä¸ªæ•°ç»„ä¸‹æ ‡çš„è®¡ç®—æ–¹æ³•æ˜¯â€œ `(n - 1) & hash`â€ã€‚ï¼ˆn ä»£è¡¨æ•°ç»„é•¿åº¦ï¼‰ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº† HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚

**è¿™ä¸ªç®—æ³•åº”è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿ**

æˆ‘ä»¬é¦–å…ˆå¯èƒ½ä¼šæƒ³åˆ°é‡‡ç”¨%å–ä½™çš„æ“ä½œæ¥å®ç°ã€‚ä½†æ˜¯ï¼Œé‡ç‚¹æ¥äº†ï¼š**â€œå–ä½™(%)æ“ä½œä¸­å¦‚æœé™¤æ•°æ˜¯ 2 çš„å¹‚æ¬¡åˆ™ç­‰ä»·äºä¸å…¶é™¤æ•°å‡ä¸€çš„ä¸(&)æ“ä½œï¼ˆä¹Ÿå°±æ˜¯è¯´ hash%length==hash&(length-1)çš„å‰ææ˜¯ length æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼›ï¼‰ã€‚â€** å¹¶ä¸” **é‡‡ç”¨äºŒè¿›åˆ¶ä½æ“ä½œ &ï¼Œç›¸å¯¹äº%èƒ½å¤Ÿæé«˜è¿ç®—æ•ˆç‡ï¼Œè¿™å°±è§£é‡Šäº† HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚**

ğŸ™‹â€â™‚ï¸æˆ‘è®¤ä¸ºGuideå†™çš„è¿™ä¸ªæ‘¸æ£±ä¸¤å¯ï¼Œæ‰€ä»¥æ‰¾äº†ä¸€ä¸ªStackOverFlowä¸­æè¿°æ›´ä¸ºæ¸…æ¥šçš„ç¿»è¯‘ä¸ºä¸‹ï¼š

> ğŸ§šâ€â™‚ï¸åŸå¸–ï¼šhttps://stackoverflow.com/questions/53526790/why-are-hashmaps-implemented-using-powers-of-two
>
> å½“ä½ ä»ä¸€ä¸ªå¹‚ä¸º2çš„æ•°å­—ä¸­å‡å»1å¾—åˆ°çš„æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶è¡¨ç¤ºéƒ½æ˜¯1çš„æ•°å­—ã€‚ä¾‹å¦‚16æ˜¯2çš„å¹‚ã€‚å¦‚æœä»ä¸­å‡å»1ï¼Œå¾—åˆ°15ï¼Œå®ƒçš„äºŒè¿›åˆ¶è¡¨ç¤ºæ˜¯1111ã€‚ç°åœ¨ï¼Œå¦‚æœä½ ç”¨1111å¯¹ä»»ä½•ä¸€ä¸ªæ•°å­—è¿›è¡Œä½ AND è¿ç®—ï¼Œä½ å°†å¾—åˆ°è¿™ä¸ªæ•°å­—çš„æœ€å4ä½ï¼Œæ¢å¥è¯è¯´ï¼Œå®ƒç­‰äºè¿™ä¸ªæ•°å­—ä¹˜ä»¥16çš„æ¨¡(é™¤æ³•è¿ç®—é€šå¸¸æ˜¯ä¸€ä¸ªæ˜‚è´µçš„è¿ç®—ã€‚å› æ­¤ï¼Œä½æ“ä½œé€šå¸¸æ¯”é™¤æ³•æ›´å—æ¬¢è¿)ã€‚æœ€åçš„4ä½å°†è®¡ç®—ä¸º0åˆ°15ä¹‹é—´çš„ä»»æ„æ•°å­—ï¼Œè¿™äº›æ•°å­—æ˜¯åŸºç¡€æ•°ç»„çš„ç´¢å¼•ã€‚
>
> æ”¹æˆ17æ—¶ï¼Œä»ä¸­å‡å»1å¾—åˆ°16ä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶çš„10000ã€‚ç°åœ¨ä½ å¯¹ä¸€ä¸ª16çš„æ•°åšANDï¼ˆä¸&ï¼‰è¿ç®—ï¼Œä½ ä¼šå¤±å»æ‰€æœ‰çš„ä½ï¼Œé™¤äº†ä»ç»“å°¾å¼€å§‹çš„ç¬¬5ä½ã€‚å› æ­¤ï¼Œæ— è®ºå–å¤šå°‘æ•°ï¼Œæ•°ç»„ç´¢å¼•éƒ½æ˜¯16æˆ–0ã€‚è¿™æ„å‘³ç€ä¼šæœ‰å¾ˆå¤šå†²çªï¼Œè¿™åè¿‡æ¥åˆæ„å‘³ç€æ€§èƒ½å¾ˆå·®ã€‚æ‚¨å°†éœ€è¦O(log n)è€Œä¸æ˜¯O(1)è¿›è¡Œæ£€ç´¢ï¼Œå› ä¸ºå½“å†²çªå‘ç”Ÿæ—¶ï¼Œç»™å®šæ¡¶ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å°†å­˜å‚¨åœ¨ä¸€ä¸ªçº¢é»‘æ ‘ä¸­ã€‚ä¸ä»…å¦‚æ­¤ã€‚å¦‚æœæ‚¨åœ¨ä¸€ä¸ªå¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨ConcurrentHashMapï¼Œé‚£ä¹ˆæ‚¨å°†ç»å†å¤§é‡çš„åŒæ­¥ï¼Œå› ä¸ºæ‰€æœ‰æ–°æ·»åŠ çš„å†…å®¹æœ€ç»ˆéƒ½ä¼šä»¥éå¸¸å°‘çš„å­˜å‚¨æ¡¶(åœ¨ä¸Šè¿°æƒ…å†µä¸‹åªæœ‰2-0å’Œ16ä¸ª)ç»“æŸï¼Œå¹¶ä¸”å½“æ‚¨åœ¨ä¸€ä¸ªå·²ç»æœ‰å…¶ä»–èŠ‚ç‚¹çš„å­˜å‚¨æ¡¶ä¸­æ·»åŠ æ–°èŠ‚ç‚¹æ—¶ï¼Œå­˜å‚¨æ¡¶å°†è¢«é”å®šï¼Œä»¥é¿å…ç”±äºå¤šä¸ªçº¿ç¨‹çš„ä¿®æ”¹è€Œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚å› æ­¤ï¼Œå°è¯•æ·»åŠ æ–°èŠ‚ç‚¹çš„å…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…å½“å‰çº¿ç¨‹é‡Šæ”¾é”ã€‚
>
> æœ€åï¼Œæˆ‘è¿˜åº”è¯¥æåˆ°ï¼ŒJava HashMapå®ç°è¿˜å°†é”®çš„å“ˆå¸Œä»£ç çš„16ä½å‘å³ç§»åŠ¨ï¼Œå¹¶åœ¨ç”¨(length-1)è¿›è¡Œä½ANDä¹‹å‰å¯¹åŸå“ˆå¸Œä»£ç è¿›è¡Œä½å¼‚æˆ–æ“ä½œï¼Œä»¥ç¡®ä¿é«˜é˜¶ä½çš„æ•ˆæœä¹Ÿè¢«æ•è·ã€‚
>
> å› æ­¤ï¼ŒåŸºæœ¬ä¸Šè¦ç‚¹æ˜¯ï¼Œå¦‚æœå¤§å°æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œé‚£ä¹ˆä¸å…¶ä»–ä»»ä½•ä¸æ˜¯2çš„å¤§å°ç›¸æ¯”ï¼Œé”®å°†æ›´å‡åŒ€åœ°åˆ†å¸ƒåœ¨æ•´ä¸ªæ•°ç»„ä¸­ï¼Œæœ€å°çš„å†²çªå°†å¯¼è‡´æ›´å¥½çš„æ£€ç´¢æ€§èƒ½(åœ¨ConcurrentHashMapçš„æƒ…å†µä¸‹ä¹Ÿæ›´å°‘çš„åŒæ­¥)ã€‚

ä¸ºä»€ä¹ˆèƒ½å‡å°‘ç¢°æ’ï¼Ÿè¿™æ˜¯å› ä¸ºhashmapçš„hashå€¼æ˜¯hashCodeå³ç§»16ä½å¾—åˆ°çš„ï¼Œè¿™ä¹ˆåšä½¿å¾—hashå€¼çš„ä½ä½ä¿ç•™äº†é«˜ä½çš„ä¿¡æ¯ï¼Œæ‰€ä»¥åªè¦ä½ä½å°±å¯ä»¥äº†ã€‚

ä¸€å¥è¯ï¼ŒHashMapçš„é•¿åº¦ä¸º2çš„å¹‚æ¬¡æ–¹çš„åŸå› æ˜¯ä¸ºäº†å‡å°‘Hashç¢°æ’ï¼Œå°½é‡ä½¿Hashç®—æ³•çš„ç»“æœå‡åŒ€åˆ†å¸ƒã€‚ï¼ˆåªæœ‰å½“é•¿åº¦æ˜¯2^næ—¶ï¼Œé•¿åº¦-1çš„äºŒè¿›åˆ¶ä½ä½æ‰å…¨éƒ¨æ˜¯1ï¼‰

> å®é™…åœºæ™¯å¯ä»¥è¿™æ ·å›ç­”

Hash å€¼çš„èŒƒå›´å€¼æ¯”è¾ƒå¤§ï¼Œä½¿ç”¨ä¹‹å‰éœ€è¦å…ˆå¯¹æ•°ç»„çš„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰æ˜¯å…ƒç´ å­˜æ”¾çš„ä½ç½®ä¹Ÿå°±æ˜¯å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚

è¿™ä¸ªæ•°ç»„ä¸‹æ ‡çš„è®¡ç®—æ–¹æ³•æ˜¯ `(n - 1) & hash`

å°†HashMapçš„é•¿åº¦å®šä¸º2 çš„å¹‚æ¬¡æ–¹ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ `(n - 1)&hash`ä½è¿ç®—ä»£æ›¿%å–ä½™çš„æ“ä½œï¼Œæé«˜æ€§èƒ½ã€‚

> æ‹“å±•ï¼š**HashMapé»˜è®¤åŠ è½½å› å­ä¸ºä»€ä¹ˆé€‰æ‹©0.75å‘¢ï¼Ÿ**

0.75æ˜¯å¯¹**ç©ºé—´å’Œæ—¶é—´æ•ˆç‡**çš„ä¸€ä¸ªå¹³è¡¡é€‰æ‹©ï¼Œæ ¹æ®æ³Šæ¾åˆ†å¸ƒï¼ŒloadFactor å–0.75ç¢°æ’æœ€å°ã€‚ä¸€èˆ¬ä¸ä¼šä¿®æ”¹ï¼Œé™¤éåœ¨æ—¶é—´å’Œç©ºé—´æ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µä¸‹ ï¼š

* å¦‚æœå†…å­˜ç©ºé—´å¾ˆå¤šè€Œåˆå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚å¾ˆé«˜ï¼Œå¯ä»¥é™ä½è´Ÿè½½å› å­Load factorçš„å€¼ ã€‚
* å¦‚æœå†…å­˜ç©ºé—´ç´§å¼ è€Œå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥å¢åŠ è´Ÿè½½å› å­loadFactorçš„å€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥å¤§äº1ã€‚



### HashMap å¤šçº¿ç¨‹æ“ä½œå¯¼è‡´æ­»å¾ªç¯é—®é¢˜

ä¸»è¦åŸå› åœ¨äºå¹¶å‘ä¸‹çš„ Rehash ä¼šé€ æˆå…ƒç´ ä¹‹é—´ä¼šå½¢æˆä¸€ä¸ªå¾ªç¯é“¾è¡¨ã€‚ä¸è¿‡ï¼Œjdk 1.8 åè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å»ºè®®åœ¨å¤šçº¿ç¨‹ä¸‹ä½¿ç”¨  HashMap,å› ä¸ºå¤šçº¿ç¨‹ä¸‹ä½¿ç”¨ HashMap è¿˜æ˜¯ä¼šå­˜åœ¨å…¶ä»–é—®é¢˜æ¯”å¦‚æ•°æ®ä¸¢å¤±ã€‚å¹¶å‘ç¯å¢ƒä¸‹æ¨èä½¿ç”¨ ConcurrentHashMap ã€‚

è¯¦æƒ…è¯·æŸ¥çœ‹ï¼šhttps://coolshell.cn/articles/9606.html

#### ä¸ºä»€ä¹ˆHashMapçº¿ç¨‹ä¸å®‰å…¨

##### putçš„æ—¶å€™å¯¼è‡´çš„å¤šçº¿ç¨‹æ•°æ®ä¸ä¸€è‡´

è¿™ä¸ªé—®é¢˜æ¯”è¾ƒå¥½æƒ³è±¡ï¼Œæ¯”å¦‚æœ‰ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBï¼Œé¦–å…ˆAå¸Œæœ›æ’å…¥ä¸€ä¸ªkey-valueå¯¹åˆ°HashMapä¸­ï¼Œé¦–å…ˆè®¡ç®—è®°å½•æ‰€è¦è½åˆ°çš„æ¡¶çš„ç´¢å¼•åæ ‡ï¼Œç„¶åè·å–åˆ°è¯¥æ¡¶é‡Œé¢çš„é“¾è¡¨å¤´ç»“ç‚¹ï¼Œæ­¤æ—¶çº¿ç¨‹Açš„æ—¶é—´ç‰‡ç”¨å®Œäº†ï¼Œè€Œæ­¤æ—¶çº¿ç¨‹Bè¢«è°ƒåº¦å¾—ä»¥æ‰§è¡Œï¼Œå’Œçº¿ç¨‹Aä¸€æ ·æ‰§è¡Œï¼Œåªä¸è¿‡çº¿ç¨‹BæˆåŠŸå°†è®°å½•æ’åˆ°äº†æ¡¶é‡Œé¢ï¼Œå‡è®¾çº¿ç¨‹Aæ’å…¥çš„è®°å½•è®¡ç®—å‡ºæ¥çš„æ¡¶ç´¢å¼•å’Œçº¿ç¨‹Bè¦æ’å…¥çš„è®°å½•è®¡ç®—å‡ºæ¥çš„æ¡¶ç´¢å¼•æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹BæˆåŠŸæ’å…¥ä¹‹åï¼Œçº¿ç¨‹Aå†æ¬¡è¢«è°ƒåº¦è¿è¡Œæ—¶ï¼Œå®ƒä¾ç„¶æŒæœ‰è¿‡æœŸçš„é“¾è¡¨å¤´ä½†æ˜¯å®ƒå¯¹æ­¤ä¸€æ— æ‰€çŸ¥ï¼Œä»¥è‡³äºå®ƒè®¤ä¸ºå®ƒåº”è¯¥è¿™æ ·åšï¼Œå¦‚æ­¤ä¸€æ¥å°±è¦†ç›–äº†çº¿ç¨‹Bæ’å…¥çš„è®°å½•ï¼Œè¿™æ ·çº¿ç¨‹Bæ’å…¥çš„è®°å½•å°±å‡­ç©ºæ¶ˆå¤±äº†ï¼Œé€ æˆäº†æ•°æ®ä¸ä¸€è‡´çš„è¡Œä¸ºã€‚

##### getæ“ä½œå¯èƒ½å› ä¸ºresizeè€Œå¼•èµ·æ­»å¾ªç¯

è§ä¸Šä¸€ä¸ªé—®é¢˜çš„å›ç­”



### ä¸ºä»€ä¹ˆJavaåªæœ‰å€¼ä¼ é€’

Java ä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå¦‚ `int`ã€`double`ã€`char` ç­‰ï¼‰å’Œå¯¹è±¡å¼•ç”¨éƒ½æ˜¯é€šè¿‡å€¼ä¼ é€’çš„ã€‚è¿™æ„å‘³ç€å½“æ‚¨å°†å˜é‡ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šä¼ é€’çš„æ˜¯å˜é‡çš„å‰¯æœ¬ï¼Œè€Œä¸æ˜¯å˜é‡æœ¬èº«ã€‚

1. **åŸºæœ¬æ•°æ®ç±»å‹**ï¼šå½“æˆ‘ä»¬å°†åŸºæœ¬æ•°æ®ç±»å‹ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬ä¼ é€’çš„æ˜¯è¯¥å˜é‡çš„å€¼ã€‚å› æ­¤ï¼Œå³ä½¿æ–¹æ³•å¯¹è¿™ä¸ªå‚æ•°æ‰§è¡Œäº†ä¿®æ”¹æ“ä½œï¼ŒåŸå§‹å˜é‡çš„å€¼ä¹Ÿä¸ä¼šæ”¹å˜ã€‚

```java
public static void main(String[] args) {
    int number = 5;
    modifyNumber(number);
    System.out.println(number); // è¾“å‡º 5ï¼Œå€¼æ²¡æœ‰å˜åŒ–
}

public static void modifyNumber(int number) {
    number = 10;
}
```

2. **å¯¹è±¡å¼•ç”¨**ï¼šå½“æˆ‘ä»¬å°†ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬ä¼ é€’çš„æ˜¯å¯¹è±¡å¼•ç”¨çš„å‰¯æœ¬ã€‚è¿™æ„å‘³ç€æ–¹æ³•ä¸­ä½¿ç”¨çš„å¼•ç”¨å’ŒåŸå§‹å¼•ç”¨æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚å› æ­¤ï¼Œå¦‚æœæ–¹æ³•ä¿®æ”¹äº†å¯¹è±¡çš„çŠ¶æ€ï¼Œé‚£ä¹ˆåœ¨æ–¹æ³•å¤–éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™äº›æ›´æ”¹ã€‚ç„¶è€Œï¼Œå¦‚æœæ–¹æ³•è®©å¼•ç”¨æŒ‡å‘ä¸€ä¸ªæ–°å¯¹è±¡ï¼ŒåŸå§‹å¼•ç”¨ä¸ä¼šå—åˆ°å½±å“ã€‚

```java
public static void main(String[] args) {
    StringBuilder sb = new StringBuilder("Hello");
    modifyObject(sb);
    System.out.println(sb); // è¾“å‡º "Hello World"ï¼Œå¯¹è±¡çš„çŠ¶æ€å·²ç»å‘ç”Ÿæ”¹å˜

    assignNewObject(sb);
    System.out.println(sb); // è¾“å‡º "Hello World"ï¼Œå¼•ç”¨æ²¡æœ‰å˜åŒ–
}

public static void modifyObject(StringBuilder sb) {
    sb.append(" World");
}

public static void assignNewObject(StringBuilder sb) {
    sb = new StringBuilder("New object");
}
```

å½“å°† `sb` ä½œä¸ºå‚æ•°ä¼ é€’ç»™ `assignNewObject` æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šä¼ é€’çš„æ˜¯å¼•ç”¨ `sb` çš„**å‰¯æœ¬**ã€‚è¿™æ„å‘³ç€åœ¨ `assignNewObject` æ–¹æ³•å†…éƒ¨ï¼Œæ“ä½œçš„æ˜¯åŸå§‹å¼•ç”¨çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œè€Œä¸æ˜¯åŸå§‹å¼•ç”¨æœ¬èº«ã€‚å› æ­¤ï¼Œå³ä½¿æ‚¨åœ¨æ–¹æ³•å†…éƒ¨è®©å¼•ç”¨å‰¯æœ¬æŒ‡å‘ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè¿™ä¹Ÿä¸ä¼šå½±å“åŸå§‹å¼•ç”¨ã€‚

åœ¨ `modifyObject` æ–¹æ³•ä¸­ï¼Œè™½ç„¶ä¼ é€’çš„ä¹Ÿæ˜¯å¼•ç”¨ `sb` çš„å‰¯æœ¬ï¼Œä½†ç”±äºå‰¯æœ¬å¼•ç”¨å’ŒåŸå§‹å¼•ç”¨éƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥åœ¨æ–¹æ³•å†…éƒ¨å¯¹å¯¹è±¡è¿›è¡Œçš„ä¿®æ”¹ä¼šå½±å“åˆ°å¯¹è±¡æœ¬èº«ã€‚è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯ï¼Œæ‚¨åœ¨ `modifyObject` æ–¹æ³•ä¸­å¯¹å¯¹è±¡çš„çŠ¶æ€è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œæ²¡æœ‰ä¿®æ”¹å¼•ç”¨æœ¬èº«ã€‚

### Javaä¸­çš„å†…å­˜æ³„æ¼é—®é¢˜

åœ¨ Java ä¸­ï¼ŒæŸäº›ç¼–ç¨‹å®è·µå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚å†…å­˜æ³„æ¼æŒ‡çš„æ˜¯ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­é€æ¸æ¶ˆè€—å†…å­˜èµ„æºï¼Œä½†æ— æ³•å°†è¿™äº›èµ„æºé‡Šæ”¾å›æ“ä½œç³»ç»Ÿï¼Œä»è€Œå¯¼è‡´å†…å­˜ä½¿ç”¨ä¸æ–­å¢åŠ ï¼Œç›´è‡³è€—å°½å¯ç”¨å†…å­˜ã€‚åœ¨ Java ä¸­ï¼Œå†…å­˜æ³„æ¼é€šå¸¸æ˜¯ç”±äºé•¿æ—¶é—´å­˜æ´»çš„å¯¹è±¡æŒæœ‰å¯¹ä¸å†éœ€è¦çš„å¯¹è±¡çš„å¼•ç”¨é€ æˆçš„ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„å†…å­˜æ³„æ¼ç¤ºä¾‹ï¼š

```java
import java.util.ArrayList;
import java.util.List;

public class MemoryLeakExample {

    private static List<Object> leakStorage = new ArrayList<>();

    public static void main(String[] args) {
        while (true) {
            Object data = createData();
            leakStorage.add(data);
        }
    }

    private static Object createData() {
        // åˆ›å»ºä¸€ä¸ªå¤§å¯¹è±¡ï¼Œä¾‹å¦‚ä¸€ä¸ªå¤§æ•°ç»„
        return new byte[1024 * 1024];
    }
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º `leakStorage` çš„é™æ€ `ArrayList`ï¼Œç”¨äºå­˜å‚¨å¤§å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œ1MB å¤§å°çš„å­—èŠ‚æ•°ç»„ï¼‰ã€‚`main` æ–¹æ³•ä¸­çš„ `while (true)` å¾ªç¯ä¸æ–­åˆ›å»ºæ–°çš„å¤§å¯¹è±¡å¹¶å°†å…¶æ·»åŠ åˆ° `leakStorage` åˆ—è¡¨ä¸­ã€‚

ç”±äº `leakStorage` æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼Œå®ƒä¼šåœ¨æ•´ä¸ªç¨‹åºç”Ÿå‘½å‘¨æœŸå†…ä¿æŒæ´»åŠ¨çŠ¶æ€ã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿æˆ‘ä»¬ä¸å†éœ€è¦è¿™äº›å¤§å¯¹è±¡ï¼Œå®ƒä»¬ä¹Ÿä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚éšç€ `leakStorage` åˆ—è¡¨ä¸­å¯¹è±¡æ•°é‡çš„å¢åŠ ï¼Œç¨‹åºå°†ä¸æ–­æ¶ˆè€—å†…å­˜ï¼Œç›´è‡³è€—å°½å¯ç”¨å†…å­˜ã€‚

è¦é¿å…å†…å­˜æ³„æ¼ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åŠæ—¶é‡Šæ”¾ä¸å†éœ€è¦çš„å¯¹è±¡çš„å¼•ç”¨ï¼Œä»¥ä¾¿åƒåœ¾å›æ”¶å™¨å¯ä»¥å›æ”¶å®ƒä»¬ã€‚åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œä¸€ç§å¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ä½¿ç”¨å®Œå¤§å¯¹è±¡åä» `leakStorage` åˆ—è¡¨ä¸­åˆ é™¤å®ƒä»¬ï¼Œæˆ–è€…ä½¿ç”¨å¼±å¼•ç”¨ï¼ˆ`java.lang.ref.WeakReference` ç±»ï¼‰æ¥å­˜å‚¨åˆ—è¡¨ä¸­çš„å¯¹è±¡ã€‚



åœ¨ Java ä¸­ï¼Œæ‚¨ä¸èƒ½åƒåœ¨ C æˆ– C++ ä¸­é‚£æ ·æ‰‹åŠ¨é‡Šæ”¾å¯¹è±¡ã€‚ç›¸åï¼ŒJava ä½¿ç”¨åƒåœ¾å›æ”¶å™¨ï¼ˆGarbage Collectorï¼ŒGCï¼‰æœºåˆ¶è‡ªåŠ¨å›æ”¶ä¸å†éœ€è¦çš„å¯¹è±¡ã€‚è¦ç¡®ä¿å¯¹è±¡èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ï¼Œæ‚¨éœ€è¦ç¡®ä¿æ²¡æœ‰æ´»åŠ¨çš„å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡ã€‚æ¢å¥è¯è¯´ï¼Œæ‚¨éœ€è¦å°†æ‰€æœ‰æŒ‡å‘è¯¥å¯¹è±¡çš„å¼•ç”¨è®¾ç½®ä¸º `null`ï¼Œæˆ–è€…è®©å¼•ç”¨è¶…å‡ºå…¶ä½œç”¨åŸŸã€‚

å¯¹äºå‰é¢æåˆ°çš„å†…å­˜æ³„æ¼ç¤ºä¾‹ï¼Œä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯åœ¨ä½¿ç”¨å®Œå¤§å¯¹è±¡åå°†å…¶ä» `leakStorage` åˆ—è¡¨ä¸­åˆ é™¤ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå®šæ—¶å™¨å®šæœŸæ¸…é™¤åˆ—è¡¨ä¸­çš„å¯¹è±¡ï¼š

```java
// ... å…¶ä»–ä»£ç  ...

public static void main(String[] args) {
    Timer timer = new Timer();
    timer.schedule(new TimerTask() {
        @Override
        public void run() {
            // åœ¨ä½¿ç”¨å®Œå¯¹è±¡ä¹‹åï¼Œä»åˆ—è¡¨ä¸­åˆ é™¤å¯¹è±¡
            if (!leakStorage.isEmpty()) {
                leakStorage.remove(0);
            }
        }
    }, 0, 1000); // æ¯éš” 1000 æ¯«ç§’ï¼ˆ1 ç§’ï¼‰æ‰§è¡Œä¸€æ¬¡

    while (true) {
        Object data = createData();
        leakStorage.add(data);
    }
}

// ... å…¶ä»–ä»£ç  ...
```





### å¼‚å¸¸å¤„ç†æ€»ç»“

finally å—ä¸ä¼šè¢«æ‰§è¡Œï¼š

1. åœ¨ try æˆ– finally å—ä¸­ç”¨äº† System.exit(int) é€€å‡ºç¨‹åºã€‚ä½†æ˜¯ï¼Œå¦‚æœ System.exit(int) åœ¨å¼‚å¸¸
   è¯­å¥ä¹‹åï¼Œ finally è¿˜æ˜¯ä¼šè¢«æ‰§è¡Œ
2. ç¨‹åºæ‰€åœ¨çš„çº¿ç¨‹æ­»äº¡ã€‚
3. å…³é—­ CPUã€‚
4. å¦‚æœ JVM å‘ç”Ÿå†…éƒ¨é”™è¯¯ï¼Œä½¿å¾—ç¨‹åºè¢«è¿«ç»ˆæ­¢ï¼Œé‚£ä¹ˆ `finally` å—å¯èƒ½ä¸ä¼šæ‰§è¡Œã€‚

ä¸‹é¢è¿™éƒ¨åˆ†å†…å®¹æ¥è‡ª issue:https://github.com/Snailclimb/JavaGuide/issues/190ã€‚
**æ³¨æ„ï¼š** å½“ try è¯­å¥å’Œ finally è¯­å¥ä¸­éƒ½æœ‰ return è¯­å¥æ—¶ï¼Œåœ¨æ–¹æ³•è¿”å›ä¹‹å‰ï¼Œfinally è¯­å¥çš„å†…å®¹å°†è¢«æ‰§è¡Œï¼Œå¹¶ä¸” finally è¯­å¥çš„è¿”å›å€¼å°†ä¼šè¦†ç›–åŸå§‹çš„è¿”å›å€¼ã€‚å¦‚ä¸‹ï¼š

```java
public static int f(int value) {
    try {
        return value * value;
    } finally {
        if (value == 2) {
            return 0;
        }
    }
}
```

ã€Šjavaæ ¸å¿ƒæŠ€æœ¯å·ä¸€ã€‹ä¸­æåˆ°è¿‡ï¼šå½“finallyå­å¥åŒ…å«return è¯­å¥æ—¶ï¼ˆå½“ç„¶åœ¨è®¾è®¡åŸåˆ™ä¸Šæ˜¯ä¸å…è®¸åœ¨finallyå—ä¸­æŠ›å‡ºå¼‚å¸¸æˆ–è€… æ‰§è¡Œreturnè¯­å¥çš„ï¼‰ï¼Œå°†ä¼šå‡ºç°ä¸€ç§æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚å‡è®¾åˆ©ç”¨returnè¯­å¥ä»try è¯­å¥å—ä¸­é€€å‡ºã€‚åœ¨æ–¹æ³•è¿”å›å‰ï¼Œfinallyå­å¥çš„å†…å®¹å°†è¢«æ‰§è¡Œã€‚å¦‚æœfinallyå­å¥ä¸­ä¹Ÿæœ‰ä¸€ä¸ªreturnè¯­å¥ï¼Œè¿™ä¸ªè¿”å›å€¼å°†ä¼šè¦†ç›–åŸå§‹çš„è¿”å›å€¼



### æœ‰å“ªäº›å¸¸è§çš„ IO æ¨¡å‹?

UNIX ç³»ç»Ÿä¸‹ï¼Œ IO æ¨¡å‹ä¸€å…±æœ‰ 5 ç§ï¼š åŒæ­¥é˜»å¡ I/Oã€åŒæ­¥éé˜»å¡ I/Oã€I/O å¤šè·¯å¤ç”¨ã€ä¿¡å·é©±åŠ¨ I/O å’Œå¼‚æ­¥ I/Oã€‚

> è¿™é‡Œè¿›è¡Œä¸€äº›åŒºåˆ†ï¼Œæ–¹ä¾¿ç†è§£ï¼š
> 1. **åŒæ­¥é˜»å¡ I/O**ï¼šè¦ä¸€ä¸ªä¸€ä¸ªå¤„ç†
> 2. **åŒæ­¥éé˜»å¡ I/O**ï¼šè¿›ç¨‹éœ€è¦ä¸æ–­åœ°**è½®è¯¢ï¼ˆpollingï¼‰æŸ¥è¯¢ I/O** æ˜¯å¦å®Œæˆ
> 3. **I/O å¤šè·¯å¤ç”¨**ï¼šåŒæ—¶ç›‘è§†å¤šä¸ª I/O è¯·æ±‚ï¼Œä¼šè¢«**æŒ‚èµ·**ï¼Œå½“ä»»ä½•ä¸€ä¸ª I/O è¯·æ±‚å°±ç»ªï¼ˆå³æ•°æ®å·²å‡†å¤‡å¥½ï¼‰ï¼Œè¿›ç¨‹ä¼šè¢«**å”¤é†’**å¼€å§‹å¤„ç†å°±ç»ªçš„ I/O è¯·æ±‚
> 4. **ä¿¡å·é©±åŠ¨ I/O**ï¼šå†…æ ¸ä¼šå‘è¿›ç¨‹å‘é€ä¸€ä¸ª**ä¿¡å·**ï¼Œè¿›ç¨‹æ¥æ”¶åˆ°ä¿¡å·åå¼€å§‹å¤„ç† I/O
> 5. **å¼‚æ­¥ I/O**ï¼šå°±ç±»ä¼¼å¹³æ—¶å†™çš„å¼‚æ­¥å‡½æ•°

#### é˜»å¡å¼ I/O

åº”ç”¨è¿›ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°æ•°æ®å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºä¸­æ‰è¿”å›ã€‚ åº”è¯¥æ³¨æ„åˆ°ï¼Œåœ¨é˜»å¡çš„è¿‡ç¨‹ä¸­ï¼Œå…¶å®ƒç¨‹åºè¿˜å¯ä»¥æ‰§è¡Œï¼Œå› æ­¤é˜»å¡ä¸æ„å‘³ç€æ•´ä¸ªæ“ä½œç³»ç»Ÿéƒ½è¢«é˜»å¡ã€‚å› ä¸ºå…¶ä»–ç¨‹åºè¿˜å¯ä»¥æ‰§è¡Œï¼Œå› æ­¤ä¸æ¶ˆè€— CPU æ—¶é—´ï¼Œè¿™ç§æ¨¡å‹çš„æ‰§è¡Œæ•ˆç‡ä¼šæ¯”è¾ƒé«˜ã€‚ ä¸‹å›¾ä¸­ï¼Œrecvfrom ç”¨äºæ¥æ”¶ Socket ä¼ æ¥çš„æ•°æ®ï¼Œå¹¶å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹çš„ç¼“å†²åŒº buf ä¸­ã€‚è¿™é‡ŒæŠŠ recvfrom() å½“æˆç³»ç»Ÿè°ƒç”¨ã€‚

![image-20220628221701308](./personal_images/image-20220628221701308.webp)

#### éé˜»å¡å¼ I/O

åº”ç”¨è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œå†…æ ¸è¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚åº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä½†æ˜¯éœ€è¦ä¸æ–­çš„æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ¥è·çŸ¥ I/O æ˜¯å¦å®Œæˆï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºè½®è¯¢(polling)ã€‚

ç”±äº CPU è¦å¤„ç†æ›´å¤šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤è¿™ç§æ¨¡å‹æ˜¯æ¯”è¾ƒä½æ•ˆçš„ã€‚

![image-20220628221710263](./personal_images/image-20220628221710263.webp)

#### I/O å¤ç”¨

**ä½¿ç”¨ select æˆ–è€… poll ç­‰å¾…æ•°æ®**ï¼Œå¹¶ä¸”å¯ä»¥ç­‰å¾…å¤šä¸ªå¥—æ¥å­—ä¸­çš„ä»»ä½•ä¸€ä¸ªå˜ä¸ºå¯è¯»ï¼Œè¿™ä¸€è¿‡ç¨‹ä¼šè¢«é˜»å¡ï¼Œå½“æŸä¸€ä¸ªå¥—æ¥å­—å¯è¯»æ—¶è¿”å›ã€‚ä¹‹åå†ä½¿ç”¨ recvfrom æŠŠæ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°è¿›ç¨‹ä¸­ã€‚

å®ƒå¯ä»¥è®©å•ä¸ªè¿›ç¨‹å…·æœ‰å¤„ç†å¤šä¸ª I/O äº‹ä»¶çš„èƒ½åŠ›ã€‚åˆè¢«ç§°ä¸º Event Driven I/Oï¼Œå³äº‹ä»¶é©±åŠ¨ I/Oã€‚

å¦‚æœä¸€ä¸ª Web æœåŠ¡å™¨æ²¡æœ‰ I/O å¤ç”¨ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ª Socket è¿æ¥éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ã€‚å¦‚æœåŒæ—¶æœ‰å‡ ä¸‡ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ›å»ºç›¸åŒæ•°é‡çš„çº¿ç¨‹ã€‚å¹¶ä¸”ç›¸æ¯”äºå¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æŠ€æœ¯ï¼ŒI/O å¤ç”¨ä¸éœ€è¦è¿›ç¨‹çº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢çš„å¼€é”€ï¼Œç³»ç»Ÿå¼€é”€æ›´å°ã€‚

![image-20220628221721484](./personal_images/image-20220628221721484.webp)

#### ä¿¡å·é©±åŠ¨ I/O

åº”ç”¨è¿›ç¨‹ä½¿ç”¨ sigaction ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸ç«‹å³è¿”å›ï¼Œåº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ç­‰å¾…æ•°æ®é˜¶æ®µåº”ç”¨è¿›ç¨‹æ˜¯éé˜»å¡çš„ã€‚å†…æ ¸åœ¨æ•°æ®åˆ°è¾¾æ—¶å‘åº”ç”¨è¿›ç¨‹å‘é€ SIGIO ä¿¡å·ï¼Œåº”ç”¨è¿›ç¨‹æ”¶åˆ°ä¹‹ååœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­è°ƒç”¨ recvfrom å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ä¸­ã€‚

ç›¸æ¯”äºéé˜»å¡å¼ I/O çš„è½®è¯¢æ–¹å¼ï¼Œä¿¡å·é©±åŠ¨ I/O çš„ CPU åˆ©ç”¨ç‡æ›´é«˜ã€‚

![image-20220628221734114](./personal_images/image-20220628221734114.webp)

#### å¼‚æ­¥ I/O

è¿›è¡Œ aio_readï¼ˆasynchronous readï¼‰ ç³»ç»Ÿè°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œåº”ç”¨è¿›ç¨‹ç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œå†…æ ¸ä¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆä¹‹åå‘åº”ç”¨è¿›ç¨‹å‘é€ä¿¡å·ã€‚

å¼‚æ­¥ I/O ä¸ä¿¡å·é©±åŠ¨ I/O çš„åŒºåˆ«åœ¨äºï¼Œå¼‚æ­¥ I/O çš„ä¿¡å·æ˜¯é€šçŸ¥åº”ç”¨è¿›ç¨‹ I/O å®Œæˆï¼Œè€Œä¿¡å·é©±åŠ¨ I/O çš„ä¿¡å·æ˜¯é€šçŸ¥åº”ç”¨è¿›ç¨‹å¯ä»¥å¼€å§‹ I/Oã€‚

![image-20220628221741472](./personal_images/image-20220628221741472.webp)

### â­BIO,NIO,AIO æœ‰ä»€ä¹ˆåŒºåˆ«

![image-20220615203937591](./personal_images/image-20220615203937591.webp)

> Java BIO[Blocking I/O] | åŒæ­¥é˜»å¡I/Oæ¨¡å¼

![image-20220731160638775](./personal_images/image-20220731160638775.webp)

BIO å…¨ç§°Block-IO æ˜¯ä¸€ç§åŒæ­¥ä¸”é˜»å¡çš„é€šä¿¡æ¨¡å¼ã€‚æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¼ ç»Ÿçš„é€šä¿¡æ–¹å¼ï¼Œæ¨¡å¼ç®€å•ï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚ä½†å¹¶å‘å¤„ç†èƒ½åŠ›ä½ï¼Œé€šä¿¡è€—æ—¶ï¼Œä¾èµ–ç½‘é€Ÿ

> Java NIO[New I/O] | åŒæ­¥éé˜»å¡æ¨¡å¼

![image-20220731160650184](./personal_images/image-20220731160650184.webp)

å¯ä»¥çœ‹ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ2016å¹´å†™çš„æ–‡ç« ï¼š[Java NIOæµ…æ](https://tech.meituan.com/2016/11/04/nio.html)

Java ä¸­çš„ NIO äº Java 1.4 ä¸­å¼•å…¥ï¼Œå¯¹åº” `java.nio` åŒ…ï¼Œæä¾›äº†Java NIOçš„å®ç°ä¸»è¦æ¶‰åŠä¸‰å¤§æ ¸å¿ƒå†…å®¹ï¼š `Channel` , `Selector`ï¼Œ`Buffer` ç­‰æŠ½è±¡ã€‚
- **é€šé“ï¼ˆChannelï¼‰**ï¼šé€šé“ä»£è¡¨äº†è¾“å…¥/è¾“å‡ºæºå’Œç›®æ ‡ã€‚å®ƒä»¬å¯ä»¥åŒå‘åœ°è¿›è¡Œæ•°æ®è¯»å–å’Œå†™å…¥ï¼Œæ”¯æŒå¼‚æ­¥æ“ä½œï¼Œå…è®¸å•ä¸ªçº¿ç¨‹åŒæ—¶ç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ã€‚è¿™ä¸æµï¼ˆStreamï¼‰ä¸åŒï¼Œå› ä¸ºæµåªèƒ½å•å‘ä¼ è¾“æ•°æ®ã€‚
- **ç¼“å†²åŒºï¼ˆBufferï¼‰**ï¼šç¼“å†²åŒºæ˜¯é€šé“è¯»å†™æ•°æ®çš„ä¸­è½¬åœ°ã€‚å‘é€ç«¯é€šè¿‡é€šé“å¾€ç¼“å†²åŒºå†™æ•°æ®ï¼Œæ¥æ”¶ç«¯é€šè¿‡é€šé“ä»ç¼“å†²åŒºè¯»æ•°æ®ã€‚å®é™…ä¸Šï¼Œç¼“å†²åŒºæ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨æ•°æ®çš„æ•°ç»„ã€‚
- **é€‰æ‹©å™¨ï¼ˆSelectorï¼‰**ï¼šé€‰æ‹©å™¨ç”¨äºç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ï¼Œä¾‹å¦‚è¿æ¥æ‰“å¼€ã€æ•°æ®åˆ°è¾¾ç­‰ã€‚è¿™ä½¿å¾—å•ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªé€šé“ã€‚å½“é€šé“ä¸Šå‘ç”Ÿäº‹ä»¶æ—¶ï¼Œçº¿ç¨‹å¯ä»¥è·å–è¯¥äº‹ä»¶å¹¶è¿›è¡Œåç»­æ“ä½œã€‚è¿™å®ç°äº†I/Oå¤šè·¯å¤ç”¨ï¼Œå³é€šè¿‡ä¸€ä¸ªçº¿ç¨‹ç®¡ç†å¤šä¸ªé€šé“ã€‚

ç»„ä»¶ä»£ç ç¤ºä¾‹ï¼š
Server
```java
import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.ServerSocketChannel;
import java.nio.channels.SocketChannel;
import java.util.Iterator;
import java.util.Set;

public class NIOServer {
    public static void main(String[] args) throws IOException {
        // åˆ›å»ºServerSocketChannel
        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
        serverSocketChannel.socket().bind(new InetSocketAddress(8080));
        serverSocketChannel.configureBlocking(false);

        // åˆ›å»ºSelector
        Selector selector = Selector.open();

        // å°†ServerSocketChannelæ³¨å†Œåˆ°Selectorï¼Œç›‘å¬è¿æ¥äº‹ä»¶
        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);

        while (true) {
            // ç­‰å¾…äº‹ä»¶å‘ç”Ÿ
            selector.select();

            // è·å–å‘ç”Ÿäº‹ä»¶çš„SelectionKeyé›†åˆ
            Set<SelectionKey> selectionKeys = selector.selectedKeys();
            Iterator<SelectionKey> iterator = selectionKeys.iterator();

            // éå†SelectionKeyé›†åˆ
            while (iterator.hasNext()) {
                SelectionKey key = iterator.next();
                iterator.remove();

                // å¤„ç†è¿æ¥äº‹ä»¶
                if (key.isAcceptable()) {
                    ServerSocketChannel channel = (ServerSocketChannel) key.channel();
                    SocketChannel socketChannel = channel.accept();
                    socketChannel.configureBlocking(false);

                    // å°†æ–°è¿æ¥çš„SocketChannelæ³¨å†Œåˆ°Selectorï¼Œç›‘å¬è¯»äº‹ä»¶
                    socketChannel.register(selector, SelectionKey.OP_READ);
                }

                // å¤„ç†è¯»äº‹ä»¶
                if (key.isReadable()) {
                    SocketChannel channel = (SocketChannel) key.channel();

                    // åˆ›å»ºBuffer
                    ByteBuffer buffer = ByteBuffer.allocate(256);

                    // è¯»å–æ•°æ®
                    int bytesRead = channel.read(buffer);

                    if (bytesRead > 0) {
                        String message = new String(buffer.array()).trim();
                        System.out.println("Received message: " + message);
                    } else {
                        channel.close();
                    }
                }
            }
        }
    }
}
```

Client
```java
import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SocketChannel;

public class NIOClient {
    public static void main(String[] args) throws IOException {
        // åˆ›å»ºSocketChannel
        SocketChannel socketChannel = SocketChannel.open();
        socketChannel.connect(new InetSocketAddress("localhost", 8080));

        // åˆ›å»ºBufferï¼Œå†™å…¥æ•°æ®
        ByteBuffer buffer = ByteBuffer.wrap("Hello, NIO server!".getBytes());

        // å°†Bufferä¸­çš„æ•°æ®å†™å…¥SocketChannel
        socketChannel.write(buffer);

        // å…³é—­SocketChannel
        socketChannel.close();
    }
}
```

è¿™æ®µä»£ç å¦‚æœå¯åŠ¨äº†å®¢æˆ·ç«¯å°±ä¼šå‡ºç°`Received message: Hello, NIO server!`

Java ä¸­çš„ NIO å¯ä»¥çœ‹ä½œæ˜¯ **I/O å¤šè·¯å¤ç”¨æ¨¡å‹**ã€‚ä¹Ÿæœ‰å¾ˆå¤šäººè®¤ä¸ºï¼ŒJava ä¸­çš„ NIO å±äºåŒæ­¥éé˜»å¡ IO æ¨¡å‹ã€‚

![image-20220615204150338](./personal_images/image-20220615204150338.webp)

åŒæ­¥éé˜»å¡ IO æ¨¡å‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¼š**ä¸€ç›´å‘èµ· read è°ƒç”¨ï¼Œç­‰å¾…æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„è¿™æ®µæ—¶é—´é‡Œï¼Œçº¿ç¨‹ä¾ç„¶æ˜¯é˜»å¡çš„ï¼Œç›´åˆ°åœ¨å†…æ ¸æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´**ã€‚

ç›¸æ¯”äºåŒæ­¥é˜»å¡ IO æ¨¡å‹ï¼ŒåŒæ­¥éé˜»å¡ IO æ¨¡å‹ç¡®å®æœ‰äº†å¾ˆå¤§æ”¹è¿›ã€‚é€šè¿‡è½®è¯¢æ“ä½œï¼Œé¿å…äº†ä¸€ç›´é˜»å¡ã€‚

ä½†æ˜¯ï¼Œè¿™ç§ IO æ¨¡å‹åŒæ ·å­˜åœ¨é—®é¢˜ï¼š**åº”ç”¨ç¨‹åºä¸æ–­è¿›è¡Œ I/O ç³»ç»Ÿè°ƒç”¨è½®è¯¢æ•°æ®æ˜¯å¦å·²ç»å‡†å¤‡å¥½çš„è¿‡ç¨‹æ˜¯ååˆ†æ¶ˆè€— CPU èµ„æºçš„ã€‚**

è¿™ä¸ªæ—¶å€™ï¼Œ**I/O å¤šè·¯å¤ç”¨æ¨¡å‹** å°±ä¸Šåœºäº†ã€‚

![image-20220615204200618](./personal_images/image-20220615204200618.webp)

IO å¤šè·¯å¤ç”¨æ¨¡å‹ä¸­ï¼Œçº¿ç¨‹**é¦–å…ˆå‘èµ· select è°ƒç”¨ï¼Œè¯¢é—®å†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å°±ç»ª**ï¼Œç­‰å†…æ ¸æŠŠæ•°æ®å‡†å¤‡å¥½äº†ï¼Œç”¨æˆ·çº¿ç¨‹å†å‘èµ· read è°ƒç”¨ã€‚**read è°ƒç”¨çš„è¿‡ç¨‹ï¼ˆæ•°æ®ä»å†…æ ¸ç©ºé—´ -> ç”¨æˆ·ç©ºé—´ï¼‰è¿˜æ˜¯é˜»å¡çš„**ã€‚

**IO å¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œé€šè¿‡å‡å°‘æ— æ•ˆçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå‡å°‘äº†å¯¹ CPU èµ„æºçš„æ¶ˆè€—ã€‚**

> ç›®å‰æ”¯æŒ IO å¤šè·¯å¤ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæœ‰ selectï¼Œepoll ç­‰ç­‰ã€‚select ç³»ç»Ÿè°ƒç”¨ï¼Œç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿä¸Šéƒ½æœ‰æ”¯æŒã€‚
>
> - **select è°ƒç”¨** ï¼šå†…æ ¸æä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒæ”¯æŒä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªç³»ç»Ÿè°ƒç”¨çš„å¯ç”¨çŠ¶æ€ã€‚å‡ ä¹æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒã€‚
> - **epoll è°ƒç”¨** ï¼šlinux 2.6 å†…æ ¸ï¼Œå±äº select è°ƒç”¨çš„å¢å¼ºç‰ˆæœ¬ï¼Œä¼˜åŒ–äº† IO çš„æ‰§è¡Œæ•ˆç‡ã€‚

![image-20220615204212255](./personal_images/image-20220615204212255.webp)

NIOå’ŒIOå¤šè·¯å¤ç”¨çš„åŒºåˆ«æ˜¯ï¼š
- åœ¨NIOä¸­ï¼Œä½¿ç”¨é€‰æ‹©å™¨ï¼ˆSelectorï¼‰æ¥ç›‘å¬å¤šä¸ªé€šé“ï¼ˆChannelï¼‰ä¸Šçš„äº‹ä»¶ã€‚é€‰æ‹©å™¨é€šè¿‡è½®è¯¢çš„æ–¹å¼æ¥æ£€æŸ¥é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿã€‚å½“è°ƒç”¨selector.select()æ–¹æ³•æ—¶ï¼Œé€‰æ‹©å™¨ä¼šé˜»å¡å¹¶ç­‰å¾…äº‹ä»¶å‘ç”Ÿï¼›ä¸€æ—¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œselect()æ–¹æ³•å°±ä¼šè¿”å›ï¼Œæ­¤æ—¶å¯ä»¥è·å–å·²å‘ç”Ÿäº‹ä»¶çš„é€šé“å¹¶å¤„ç†äº‹ä»¶ã€‚è¿™ç§è½®è¯¢æ£€æŸ¥äº‹ä»¶çš„æ–¹å¼ä½¿å¾—å•ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªé€šé“ä¸Šçš„äº‹ä»¶ã€‚
- IO å¤šè·¯å¤ç”¨æ˜¯ä¸€ç§åœ¨å•ä¸ªçº¿ç¨‹ä¸­ç®¡ç†å¤šä¸ªé€šé“çš„æŠ€æœ¯ã€‚åœ¨NIOä¸­ï¼Œé€‰æ‹©å™¨ï¼ˆSelectorï¼‰å®ç°äº†å¤šè·¯å¤ç”¨ã€‚å¤šè·¯å¤ç”¨å…è®¸å•ä¸ªçº¿ç¨‹ç›‘å¬å¤šä¸ªé€šé“ä¸Šçš„äº‹ä»¶ï¼Œå½“æŸä¸ªé€šé“ä¸Šçš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼ˆä¾‹å¦‚ï¼Œè¿æ¥å»ºç«‹ã€æ•°æ®åˆ°è¾¾ç­‰ï¼‰ï¼Œé€‰æ‹©å™¨ä¼šå”¤é†’ç›¸åº”çš„çº¿ç¨‹æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚å› æ­¤ï¼Œå¤šè·¯å¤ç”¨å¯ä»¥æé«˜I/Oæ“ä½œçš„æ•ˆç‡ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡ç­‰å¾…å•ä¸ªI/Oæ“ä½œçš„é—®é¢˜ã€‚

> Java AIO[Asynchronous I/O] | å¼‚æ­¥éé˜»å¡I/Oæ¨¡å‹

![image-20220731160701735](./personal_images/image-20220731160701735.webp)

AIO ä¹Ÿå°±æ˜¯ NIO 2ã€‚Java 7 ä¸­å¼•å…¥äº† NIO çš„æ”¹è¿›ç‰ˆ NIO 2,å®ƒæ˜¯å¼‚æ­¥ IO æ¨¡å‹ã€‚

å¼‚æ­¥ IO æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œã€‚

ä¸NIOçš„åŒºåˆ«ï¼š
- **I/Oæ¨¡å¼**ï¼šNIOé‡‡ç”¨çš„æ˜¯éé˜»å¡I/Oæ¨¡å¼ï¼Œå®ƒå…è®¸çº¿ç¨‹åœ¨ç­‰å¾…I/Oæ“ä½œæ—¶å¤„ç†å…¶ä»–ä»»åŠ¡ã€‚è€ŒAIOé‡‡ç”¨çš„æ˜¯å¼‚æ­¥I/Oæ¨¡å¼ï¼Œå®ƒå…è®¸I/Oæ“ä½œåœ¨åå°å®Œæˆï¼Œåº”ç”¨ç¨‹åºä¸éœ€è¦ç­‰å¾…I/Oæ“ä½œçš„ç»“æœã€‚
- **é€šçŸ¥æœºåˆ¶**ï¼šNIOä½¿ç”¨é€‰æ‹©å™¨ï¼ˆSelectorï¼‰æ¥ç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ï¼Œå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€‰æ‹©å™¨ä¼šé€šçŸ¥çº¿ç¨‹ã€‚AIOåˆ™ä½¿ç”¨**å›è°ƒæ–¹æ³•æ¥é€šçŸ¥äº‹ä»¶å‘ç”Ÿ**ï¼Œå½“I/Oæ“ä½œå®Œæˆæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨æŒ‡å®šçš„å›è°ƒæ–¹æ³•ã€‚

![image-20220615205139466](./personal_images/image-20220615205139466.webp)

ç›®å‰æ¥è¯´ AIO çš„åº”ç”¨è¿˜ä¸æ˜¯å¾ˆå¹¿æ³›ã€‚Netty ä¹‹å‰ä¹Ÿå°è¯•ä½¿ç”¨è¿‡ AIOï¼Œä¸è¿‡åˆæ”¾å¼ƒäº†ã€‚è¿™æ˜¯å› ä¸ºï¼ŒNetty ä½¿ç”¨äº† AIO ä¹‹åï¼Œåœ¨ Linux ç³»ç»Ÿä¸Šçš„æ€§èƒ½å¹¶æ²¡æœ‰å¤šå°‘æå‡ã€‚

æœåŠ¡å™¨ç«¯ï¼š
```java
import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.AsynchronousServerSocketChannel;
import java.nio.channels.AsynchronousSocketChannel;
import java.nio.channels.CompletionHandler;
import java.util.concurrent.Future;

public class AIOServer {
    public static void main(String[] args) throws IOException {
        // åˆ›å»ºAsynchronousServerSocketChannel
        AsynchronousServerSocketChannel server = AsynchronousServerSocketChannel.open();
        server.bind(new InetSocketAddress(8080));

        // æ¥å—è¿æ¥
        Future<AsynchronousSocketChannel> acceptFuture = server.accept();

        // å½“è¿æ¥å®Œæˆæ—¶ï¼Œå¤„ç†è¿æ¥
        acceptFuture.get().read(ByteBuffer.allocate(256), null, new CompletionHandler<Integer, Void>() {
            @Override
            public void completed(Integer bytesRead, Void attachment) {
                System.out.println("Received message, bytes read: " + bytesRead);
            }

            @Override
            public void failed(Throwable exc, Void attachment) {
                System.out.println("Failed to read message: " + exc.getMessage());
            }
        });

        // é˜»æ­¢ä¸»çº¿ç¨‹é€€å‡ºï¼Œä»¥ä¾¿å¼‚æ­¥æ“ä½œå¯ä»¥ç»§ç»­æ‰§è¡Œ
        System.in.read();
    }
}
```

å®¢æˆ·ç«¯ï¼š
```java
import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.AsynchronousSocketChannel;
import java.util.concurrent.Future;

public class AIOClient {
    public static void main(String[] args) throws IOException {
        // åˆ›å»ºAsynchronousSocketChannel
        AsynchronousSocketChannel client = AsynchronousSocketChannel.open();
        Future<Void> connectFuture = client.connect(new InetSocketAddress("localhost", 8080));

        // ç­‰å¾…è¿æ¥å®Œæˆ
        connectFuture.get();

        // åˆ›å»ºBufferï¼Œå†™å…¥æ•°æ®
        ByteBuffer buffer = ByteBuffer.wrap("Hello, AIO server!".getBytes());

        // å°†Bufferä¸­çš„æ•°æ®å†™å…¥AsynchronousSocketChannel
        client.write(buffer);

        // å…³é—­AsynchronousSocketChannel
        client.close();
    }
}
```

æœ€åï¼Œæ¥ä¸€å¼ å›¾ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ Java ä¸­çš„ BIOã€NIOã€AIOã€‚

![image-20220615205148242](./personal_images/image-20220615205148242.webp)



### â­Javaé›†åˆç±»æ¡†æ¶çš„åŸºæœ¬æ¥å£æœ‰å“ªäº›ï¼Ÿ

Javaä¸­çš„é›†åˆåˆ†ä¸ºvalueï¼ˆConllectionï¼‰ï¼Œkey-value(Map)ä¸¤ç§å­˜å‚¨ç»“æ„

> å­˜å‚¨valueæœ‰åˆ†ä¸ºList ã€Setã€Queue

Listï¼šæœ‰åºï¼Œå¯å­˜å‚¨é‡å¤å…ƒç´ 

Setï¼šæ— åºï¼Œå…ƒç´ ä¸å¯é‡å¤ã€‚æ ¹æ®equalså’Œhashcodeåˆ¤æ–­ï¼ˆå¦‚æœä¸€ä¸ªå¯¹è±¡è¦å­˜å‚¨åœ¨Setä¸­ï¼Œå¿…é¡»é‡å†™equalså’ŒhashCodeæ–¹æ³•ï¼‰

Queueï¼šé˜Ÿåˆ—

> å­˜å‚¨key-valueçš„ä¸ºmap

![image-20220609215207876](./personal_images/image-20220609215207876.webp)

![image-20220609215218381](./personal_images/image-20220609215218381.webp)

![image-20220609215224938](./personal_images/image-20220609215224938.webp)

### â­ Arraylist ä¸ LinkedList åŒºåˆ«

1. **æ˜¯å¦ä¿è¯çº¿ç¨‹å®‰å…¨**ï¼š ArrayList å’Œ LinkedList éƒ½æ˜¯ä¸åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ä¸ä¿è¯çº¿ç¨‹å®‰å…¨ï¼›
2. **åº•å±‚æ•°æ®ç»“æ„**ï¼š Arraylist åº•å±‚ä½¿ç”¨çš„æ˜¯ Object æ•°ç»„ï¼› LinkedList åº•å±‚ä½¿ç”¨çš„æ˜¯ åŒå‘é“¾è¡¨æ•°æ®ç»“æ„ï¼ˆJDK1.6 ä¹‹å‰ä¸ºå¾ªç¯é“¾è¡¨ï¼ŒJDK1.7 å–æ¶ˆäº†å¾ªç¯ã€‚æ³¨æ„åŒå‘é“¾è¡¨å’ŒåŒå‘å¾ªç¯é“¾è¡¨çš„åŒºåˆ«ï¼Œä¸‹é¢æœ‰ä»‹ç»åˆ°ï¼ï¼‰
3. **æ’å…¥å’Œåˆ é™¤æ˜¯å¦å—å…ƒç´ ä½ç½®çš„å½±å“**ï¼šâ‘ ArrayListé‡‡ç”¨æ•°ç»„å­˜å‚¨ï¼Œæ‰€ä»¥æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦å—å…ƒç´ ä½ç½®çš„å½±å“ã€‚æ¯”å¦‚ï¼šæ‰§è¡Œadd(Ee)æ–¹æ³•çš„æ—¶å€™ï¼ŒArrayListä¼šé»˜è®¤åœ¨å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ï¼Œè¿™ç§æƒ…å†µæ—¶é—´å¤æ‚åº¦å°±æ˜¯O(1)ã€‚ä½†æ˜¯å¦‚æœè¦åœ¨æŒ‡å®šä½ç½®iæ’å…¥å’Œåˆ é™¤å…ƒç´ çš„è¯ï¼ˆadd(intindex,Eelement)ï¼‰æ—¶é—´å¤æ‚åº¦å°±ä¸ºO(n-i)ã€‚å› ä¸ºåœ¨è¿›è¡Œä¸Šè¿°æ“ä½œçš„æ—¶å€™é›†åˆä¸­ç¬¬iå’Œç¬¬iä¸ªå…ƒç´ ä¹‹åçš„(n-i)ä¸ªå…ƒç´ éƒ½è¦æ‰§è¡Œå‘åä½/å‘å‰ç§»ä¸€ä½çš„æ“ä½œã€‚â‘¡LinkedListé‡‡ç”¨é“¾è¡¨å­˜å‚¨ï¼Œæ‰€ä»¥å¯¹äºadd(Ee)æ–¹æ³•çš„æ’å…¥ï¼Œåˆ é™¤å…ƒç´ æ—¶é—´å¤æ‚åº¦ä¸å—å…ƒç´ ä½ç½®çš„å½±å“ï¼Œè¿‘ä¼¼O(1)ï¼Œå¦‚æœæ˜¯è¦åœ¨æŒ‡å®šä½ç½®iæ’å…¥å’Œåˆ é™¤å…ƒç´ çš„è¯ï¼ˆ(add(intindex,Eelement)ï¼‰æ—¶é—´å¤æ‚åº¦è¿‘ä¼¼ä¸ºo(n))å› ä¸ºéœ€è¦å…ˆç§»åŠ¨åˆ°æŒ‡å®šä½ç½®å†æ’å…¥ã€‚
4. **æ˜¯å¦æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®**ï¼šLinkedListä¸æ”¯æŒé«˜æ•ˆçš„éšæœºå…ƒç´ è®¿é—®ï¼Œè€ŒArrayListæ”¯æŒã€‚å¿«é€Ÿéšæœºè®¿é—®å°±æ˜¯é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡(å¯¹åº”äºget(intindex)æ–¹æ³•)ã€‚
5. **å†…å­˜ç©ºé—´å ç”¨**ï¼šArrayListçš„ç©ºé—´æµªè´¹ä¸»è¦ä½“ç°åœ¨åœ¨liståˆ—è¡¨çš„ç»“å°¾ä¼šé¢„ç•™ä¸€å®šçš„å®¹é‡ç©ºé—´ï¼Œè€ŒLinkedListçš„ç©ºé—´èŠ±è´¹åˆ™ä½“ç°åœ¨å®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æ¶ˆè€—æ¯”ArrayListæ›´å¤šçš„ç©ºé—´ï¼ˆå› ä¸ºè¦å­˜æ”¾ç›´æ¥åç»§å’Œç›´æ¥å‰é©±ä»¥åŠæ•°æ®ï¼‰ã€‚



### HashMapå’ŒHashTableæœ‰ä»€ä¹ˆåŒºåˆ«
> å‚è€ƒï¼šhttps://www.javatpoint.com/difference-between-hashmap-and-hashtable
- **çº¿ç¨‹æ˜¯å¦å®‰å…¨**ï¼š HashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼ŒHashtable æ˜¯çº¿ç¨‹å®‰å…¨çš„,å› ä¸º Hashtable å†…éƒ¨çš„æ–¹æ³•åŸºæœ¬éƒ½ç»è¿‡synchronized ä¿®é¥°ã€‚ï¼ˆå¦‚æœä½ è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„è¯å°±ä½¿ç”¨ ConcurrentHashMap å§ï¼ï¼‰ï¼›
- **æ•ˆç‡**ï¼š å› ä¸ºçº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼ŒHashMap è¦æ¯” Hashtable æ•ˆç‡é«˜ä¸€ç‚¹ã€‚å¦å¤–ï¼ŒHashtable åŸºæœ¬è¢«æ·˜æ±°ï¼Œä¸è¦åœ¨ä»£ç ä¸­ä½¿ç”¨å®ƒï¼›
- **å¯¹ Null key å’Œ Null value çš„æ”¯æŒ**ï¼š HashMap å¯ä»¥å­˜å‚¨ null çš„ key å’Œ valueï¼Œä½† null ä½œä¸ºé”®åªèƒ½æœ‰ä¸€ä¸ªï¼Œnull ä½œä¸ºå€¼å¯ä»¥æœ‰å¤šä¸ªï¼›Hashtable ä¸å…è®¸æœ‰ null é”®å’Œ null å€¼ï¼Œå¦åˆ™ä¼šæŠ›å‡º NullPointerExceptionã€‚åˆå§‹å®¹é‡å¤§å°å’Œæ¯æ¬¡æ‰©å……å®¹é‡å¤§å°çš„ä¸åŒ ï¼š â‘  åˆ›å»ºæ—¶å¦‚æœä¸æŒ‡å®šå®¹é‡åˆå§‹å€¼ï¼ŒHashtable é»˜è®¤çš„åˆå§‹å¤§å°ä¸º 11ï¼Œä¹‹åæ¯æ¬¡æ‰©å……ï¼Œå®¹é‡å˜ä¸ºåŸæ¥çš„ 2n+1ã€‚HashMap é»˜è®¤çš„åˆå§‹åŒ–å¤§å°ä¸º 16ã€‚ä¹‹åæ¯æ¬¡æ‰©å……ï¼Œå®¹é‡å˜ä¸ºåŸæ¥çš„ 2 å€ã€‚â‘¡ åˆ›å»ºæ—¶å¦‚æœç»™å®šäº†å®¹é‡åˆå§‹å€¼ï¼Œé‚£ä¹ˆ Hashtable ä¼šç›´æ¥ä½¿ç”¨ä½ ç»™å®šçš„å¤§å°ï¼Œè€Œ HashMap ä¼šå°†å…¶æ‰©å……ä¸º 2 çš„å¹‚æ¬¡æ–¹å¤§å°ï¼ˆHashMap ä¸­çš„tableSizeFor()æ–¹æ³•ä¿è¯ï¼Œä¸‹é¢ç»™å‡ºäº†æºä»£ç ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ HashMap æ€»æ˜¯ä½¿ç”¨ 2 çš„å¹‚ä½œä¸ºå“ˆå¸Œè¡¨çš„å¤§å°,åé¢ä¼šä»‹ç»åˆ°ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚
- **åº•å±‚æ•°æ®ç»“æ„**ï¼š JDK1.8 ä»¥åçš„ HashMap åœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ï¼ˆåæ–‡ä¸­æˆ‘ä¼šç»“åˆæºç å¯¹è¿™ä¸€è¿‡ç¨‹è¿›è¡Œåˆ†æï¼‰ã€‚Hashtable æ²¡æœ‰è¿™æ ·çš„æœºåˆ¶ã€‚
- **å†å²ç»§æ‰¿**ï¼šHashtableä½¿ç”¨äº†é—ç•™ç±»ï¼Œå®ç°äº†è¿‡æ—¶çš„Dictionaryæ¥å£ï¼Œè€ŒHashMapç»§æ‰¿äº†è¾ƒæ–°çš„ç±»ï¼Œå®ç°äº†Mapæ¥å£ã€‚
- **éå†æ–¹å¼**ï¼šHashtableç”±Enumerationéå†ï¼Œè€ŒHashMapç”±Iteratoréå†ã€‚

HashMap ä¸­å¸¦æœ‰åˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°ï¼š

```java
    public HashMap(int initialCapacity, float loadFactor) {
        if (initialCapacity < 0)
            throw new IllegalArgumentException("Illegal initial capacity: " +
                                               initialCapacity);
        if (initialCapacity > MAXIMUM_CAPACITY)
            initialCapacity = MAXIMUM_CAPACITY;
        if (loadFactor <= 0 || Float.isNaN(loadFactor))
            throw new IllegalArgumentException("Illegal load factor: " +
                                               loadFactor);
        this.loadFactor = loadFactor;
        this.threshold = tableSizeFor(initialCapacity);
    }
     public HashMap(int initialCapacity) {
        this(initialCapacity, DEFAULT_LOAD_FACTOR);
    }

```

ä¸‹é¢è¿™ä¸ªæ–¹æ³•ä¿è¯äº† HashMap æ€»æ˜¯ä½¿ç”¨ 2 çš„å¹‚ä½œä¸ºå“ˆå¸Œè¡¨çš„å¤§å°ã€‚

```java
    /**
     * Returns a power of two size for the given target capacity.
     */
    static final int tableSizeFor(int cap) {
        int n = cap - 1;
        n |= n >>> 1;
        n |= n >>> 2;
        n |= n >>> 4;
        n |= n >>> 8;
        n |= n >>> 16;
        return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;
    }

```



### ConcurrentHashMap å’Œ Hashtable çš„åŒºåˆ«

`ConcurrentHashMap` å’Œ `Hashtable` çš„åŒºåˆ«ä¸»è¦ä½“ç°åœ¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ä¸Šä¸åŒã€‚

**åº•å±‚æ•°æ®ç»“æ„**ï¼šJDK1.7çš„ `ConcurrentHashMap`åº•å±‚é‡‡ç”¨**åˆ†æ®µçš„æ•°ç»„+é“¾è¡¨**å®ç°ï¼ŒJDK1.8é‡‡ç”¨çš„æ•°æ®ç»“æ„è·Ÿ `HashMap1.8`çš„ç»“æ„ä¸€æ ·ï¼Œ**æ•°ç»„+é“¾è¡¨/çº¢é»‘äºŒå‰æ ‘**ã€‚`Hashtable`å’ŒJDK1.8ä¹‹å‰çš„ `HashMap`çš„åº•å±‚æ•°æ®ç»“æ„ç±»ä¼¼éƒ½æ˜¯é‡‡ç”¨æ•°ç»„+é“¾è¡¨çš„å½¢å¼ï¼Œæ•°ç»„æ˜¯ `HashMap`çš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨çš„ï¼›

**å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ï¼ˆé‡è¦ï¼‰**ï¼š

1. åœ¨JDK1.7çš„æ—¶å€™ï¼ŒConcurrentHashMapï¼ˆåˆ†æ®µé”ï¼‰å¯¹æ•´ä¸ªæ¡¶æ•°ç»„è¿›è¡Œäº†åˆ†å‰²åˆ†æ®µ(Segment)ï¼Œæ¯ä¸€æŠŠé”åªé”å®¹å™¨å…¶ä¸­ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¤šçº¿ç¨‹è®¿é—®å®¹å™¨é‡Œä¸åŒæ•°æ®æ®µçš„æ•°æ®ï¼Œå°±ä¸ä¼šå­˜åœ¨é”ç«äº‰ï¼Œæé«˜å¹¶å‘è®¿é—®ç‡ã€‚åˆ°äº†JDK1.8çš„æ—¶å€™å·²ç»æ‘’å¼ƒäº†Segmentçš„æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥ç”¨Nodeæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨synchronizedå’ŒCASæ¥æ“ä½œã€‚ï¼ˆJDK1.6ä»¥åå¯¹synchronizedé”åšäº†å¾ˆå¤šä¼˜åŒ–ï¼‰æ•´ä¸ªçœ‹èµ·æ¥å°±åƒæ˜¯ä¼˜åŒ–è¿‡ä¸”çº¿ç¨‹å®‰å…¨çš„HashMapï¼Œè™½ç„¶åœ¨JDK1.8ä¸­è¿˜èƒ½çœ‹åˆ°Segmentçš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å·²ç»ç®€åŒ–äº†å±æ€§ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬ï¼›
2. åˆ°äº† JDK1.8 çš„æ—¶å€™ï¼ŒConcurrentHashMap å·²ç»æ‘’å¼ƒäº† Segment çš„æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥ç”¨ Node æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨ synchronized å’Œ CAS æ¥æ“ä½œã€‚ï¼ˆJDK1.6 ä»¥å synchronized é”åšäº†å¾ˆå¤šä¼˜åŒ–ï¼‰ æ•´ä¸ªçœ‹èµ·æ¥å°±åƒæ˜¯ä¼˜åŒ–è¿‡ä¸”çº¿ç¨‹å®‰å…¨çš„ HashMapï¼Œè™½ç„¶åœ¨ JDK1.8 ä¸­è¿˜èƒ½çœ‹åˆ° Segment çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å·²ç»ç®€åŒ–äº†å±æ€§ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬ï¼›
3. Hashtable(åŒä¸€æŠŠé”) :ä½¿ç”¨ synchronized æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿè®¿é—®åŒæ­¥æ–¹æ³•ï¼Œå¯èƒ½ä¼šè¿›å…¥é˜»å¡æˆ–è½®è¯¢çŠ¶æ€ï¼Œå¦‚ä½¿ç”¨ put æ·»åŠ å…ƒç´ ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸èƒ½ä½¿ç”¨ put æ·»åŠ å…ƒç´ ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨ getï¼Œç«äº‰ä¼šè¶Šæ¥è¶Šæ¿€çƒˆæ•ˆç‡è¶Šä½ã€‚

![image-20220606221411976](./personal_images/image-20220606221411976.webp)

JDK1.7 çš„ ConcurrentHashMapï¼š

![image-20220606221435298](./personal_images/image-20220606221435298.webp)

JDK1.8 çš„ ConcurrentHashMapï¼š
JDK1.8 çš„ ConcurrentHashMap ä¸åœ¨æ˜¯ Segment æ•°ç»„ + HashEntry æ•°ç»„ + é“¾è¡¨ï¼Œè€Œæ˜¯ Node æ•°ç»„ + é“¾è¡¨ / çº¢é»‘æ ‘ã€‚ä¸è¿‡ï¼ŒNode åªèƒ½ç”¨äºé“¾è¡¨çš„æƒ…å†µï¼Œçº¢é»‘æ ‘çš„æƒ…å†µéœ€è¦ä½¿ç”¨ TreeNode ã€‚å½“å†²çªé“¾è¡¨è¾¾åˆ°ä¸€å®šâ»“åº¦æ—¶ï¼Œé“¾è¡¨ä¼šè½¬æ¢æˆçº¢é»‘æ ‘ã€‚

### â­ConcurrentHashMapçº¿ç¨‹å®‰å…¨çš„å…·ä½“å®ç°æ–¹å¼/åº•å±‚å…·ä½“å®ç°

#### JDK1.7

![image-20220606221435298](./personal_images/image-20220606221435298.webp)

é¦–å…ˆå°†æ•°æ®åˆ†ä¸ºä¸€æ®µä¸€æ®µçš„å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®æ—¶ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚

`ConcurrentHashMap` æ˜¯ç”± `Segment `æ•°ç»„ç»“æ„å’Œ `HashEntry` æ•°ç»„ç»“æ„ç»„æˆã€‚

Segmentå®ç°äº†ReentrantLock,æ‰€ä»¥Segmentæ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œæ‰®æ¼”é”çš„â»†è‰²ã€‚HashEntryç”¨äºå­˜å‚¨é”®å€¼å¯¹æ•°æ®ã€‚

```JAVA
static class Segment<K,V> extends ReentrantLock implements Serializable {
}
```

ä¸€ä¸ª `ConcurrentHashMap`é‡ŒåŒ…å«ä¸€ä¸ª `Segment`æ•°ç»„ã€‚`Segment`çš„ç»“æ„å’Œ `HashMap`ç±»ä¼¼ï¼Œæ˜¯ä¸€ç§æ•°ç»„å’Œé“¾è¡¨ç»“æ„ï¼Œä¸€ä¸ª `Segment`åŒ…å«ä¸€ä¸ª `HashEntry`æ•°ç»„ï¼Œæ¯ä¸ª `HashEntry`æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„çš„å…ƒç´ ï¼Œæ¯ä¸ªSegmentå®ˆæŠ¤ç€ä¸€ä¸ª `HashEntry`æ•°ç»„é‡Œçš„å…ƒç´ ï¼Œå½“å¯¹ `HashEntry`æ•°ç»„çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¿…é¡»é¦–å…ˆè·å¾—å¯¹åº”çš„Segmentçš„é”ã€‚

#### JDK1.8

![image-20220606222144072](./personal_images/image-20220606222144072.webp)

`ConcurrentHashMap`å–æ¶ˆäº†Segmentåˆ†æ®µé”ï¼Œé‡‡ç”¨ `CAS`å’Œ `synchronized`æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚æ•°æ®ç»“æ„è·Ÿ `HashMap1.8`çš„ç»“æ„ç±»ä¼¼ï¼Œæ•°ç»„+é“¾è¡¨/çº¢é»‘äºŒå‰æ ‘ã€‚Java 8åœ¨é“¾è¡¨â»“åº¦è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼ˆ8ï¼‰æ—¶å°†é“¾è¡¨ï¼ˆå¯»å€æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼‰è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼ˆå¯»å€æ—¶é—´å¤æ‚åº¦ä¸ºO(log(N))ï¼‰synchronizedåªé”å®šå½“å‰é“¾è¡¨æˆ–çº¢é»‘äºŒå‰æ ‘çš„é¦–èŠ‚ç‚¹ï¼Œè¿™æ ·åªè¦hashä¸å†²çªï¼Œå°±ä¸ä¼šäº§ç”Ÿå¹¶å‘ï¼Œæ•ˆç‡åˆæå‡Nå€ã€‚

### åå°„ & åå°„åº•å±‚

#### åŸºæœ¬ç†è§£

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£`java.lang.Class`ç±»ã€‚æ¯ä¸ªç±»åœ¨åŠ è½½åéƒ½ä¼šç”Ÿæˆä¸€ä¸ª`Class`ç±»å‹çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­åŒ…å«äº†ä¸ç±»æœ‰å…³çš„æ‰€æœ‰ä¿¡æ¯ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–`Class`å¯¹è±¡ï¼š

1. ä½¿ç”¨`.class`å…³é”®å­—ï¼Œä¾‹å¦‚`Class clazz = String.class;`
2. é€šè¿‡å¯¹è±¡çš„`.getClass()`æ–¹æ³•ï¼Œä¾‹å¦‚`Class clazz = "Hello".getClass();`
3. é€šè¿‡ç±»çš„å…¨åè·å–ï¼Œä¾‹å¦‚`Class clazz = Class.forName("java.lang.String");`

é€šè¿‡åå°„ï¼Œæˆ‘ä»¬å¯ä»¥è·å–ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ„é€ å™¨ã€æ–¹æ³•ã€å­—æ®µç­‰ã€‚



**è·å–ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼ˆåŒ…æ‹¬ç»§æ‰¿å’Œå®ç°çš„ï¼‰ï¼š**

```java
Method[] methods = clazz.getMethods();
for (Method method : methods) {
    System.out.println(method);
}
```

**è·å–ç±»çš„æ‰€æœ‰å­—æ®µï¼ˆä»…æœ¬ç±»ï¼‰ï¼š**

```java
javaCopy codeField[] fields = clazz.getDeclaredFields();
for (Field field : fields) {
    System.out.println(field);
}
```

**è·å–ç±»çš„æ‰€æœ‰æ„é€ å™¨ï¼ˆä»…æœ¬ç±»ï¼‰ï¼š**

```java
javaCopy codeConstructor[] constructors = clazz.getDeclaredConstructors();
for (Constructor constructor : constructors) {
    System.out.println(constructor);
}
```

åœ¨è·å–ç±»çš„ä¿¡æ¯åï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨åå°„åŠ¨æ€åœ°åˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ–¹æ³•å’Œä¿®æ”¹å­—æ®µå€¼ã€‚

**åˆ›å»ºå¯¹è±¡ï¼š**

```java
javaCopy codeConstructor constructor = clazz.getConstructor(); // è·å–æ— å‚æ„é€ å™¨
Object obj = constructor.newInstance(); // é€šè¿‡æ„é€ å™¨åˆ›å»ºå¯¹è±¡
```

**è°ƒç”¨æ–¹æ³•ï¼š**

```java
javaCopy codeMethod method = clazz.getMethod("someMethod", parameterType); // è·å–æ–¹æ³•
Object returnValue = method.invoke(obj, arguments); // è°ƒç”¨æ–¹æ³•
```

**ä¿®æ”¹å­—æ®µå€¼ï¼š**

```java
javaCopy codeField field = clazz.getDeclaredField("someField"); // è·å–å­—æ®µ
field.setAccessible(true); // å¦‚æœå­—æ®µä¸ºç§æœ‰çš„ï¼Œéœ€è¦å…ˆè®¾ç½®å¯è®¿é—®
field.set(obj, value); // ä¿®æ”¹å­—æ®µå€¼
```

åå°„çš„ç¡®æœ‰æ€§èƒ½æŸè€—å’Œå®‰å…¨æ€§é—®é¢˜ï¼Œéœ€è¦åœ¨é€‚å½“çš„åœ°æ–¹ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œæ¡†æ¶çš„å¼€å‘è€…ä¼šä½¿ç”¨åå°„æ¥è§£ææ³¨è§£å’Œç”Ÿæˆä»£ç†ç±»ï¼Œä½†æ˜¯åœ¨æ—¥å¸¸çš„ä¸šåŠ¡ä»£ç ä¸­ï¼Œåå°„å¹¶ä¸å¸¸ç”¨ã€‚



#### åº•å±‚é—®é¢˜

åå°„çš„åº•å±‚åŸç†ä¸»è¦ä¾èµ–äºJavaçš„ç±»åŠ è½½æœºåˆ¶å’Œç±»çš„å…ƒæ•°æ®ã€‚å½“Javaè¿è¡Œç¨‹åºæ—¶ï¼Œä¼šåŠ è½½éœ€è¦çš„ç±»ï¼Œå¹¶ç”Ÿæˆç±»çš„å…ƒæ•°æ®ï¼ˆMetaDataï¼‰ï¼Œä¿å­˜åœ¨æ–¹æ³•åŒºä¸­ã€‚å…ƒæ•°æ®ä¸­åŒ…å«äº†ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»çš„åç§°ã€å­—æ®µã€æ–¹æ³•ã€æ„é€ å™¨ç­‰ã€‚`java.lang.Class`å¯¹è±¡å°±æ˜¯å¯¹å…ƒæ•°æ®çš„ä¸€ç§å°è£…ï¼Œæ¯ä¸ª`Class`å¯¹è±¡éƒ½å¯¹åº”ä¸€ä»½å…ƒæ•°æ®ã€‚

å½“æˆ‘ä»¬ä½¿ç”¨åå°„APIæ¥è·å–ç±»çš„ä¿¡æ¯æ—¶ï¼ŒJavaä¼šå»æ–¹æ³•åŒºä¸­æŸ¥æ‰¾å¯¹åº”çš„å…ƒæ•°æ®ï¼Œå¹¶è¿”å›ç›¸å…³ä¿¡æ¯ã€‚å½“æˆ‘ä»¬ä½¿ç”¨åå°„APIæ¥åˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ–¹æ³•æˆ–è€…ä¿®æ”¹å­—æ®µå€¼æ—¶ï¼ŒJavaä¼šæ ¹æ®å…ƒæ•°æ®æ¥æ“ä½œå¯¹åº”çš„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨`getMethod()`æ–¹æ³•ï¼ŒJavaå°±ä¼šåœ¨å…ƒæ•°æ®ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ–¹æ³•ï¼Œå¹¶è¿”å›ä¸€ä¸ª`Method`å¯¹è±¡ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨`newInstance()`æ–¹æ³•ï¼ŒJavaå°±ä¼šæ ¹æ®å…ƒæ•°æ®åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚

1. `Class.forName()`: æ­¤æ–¹æ³•ç”¨äºåŠ è½½å…·æœ‰ç»™å®šåç§°çš„ç±»ã€‚åœ¨åº•å±‚ï¼ŒJVM ä¼šè°ƒç”¨ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰çš„ `loadClass()` æ–¹æ³•åŠ è½½ç±»ã€‚ç±»åŠ è½½å™¨è´Ÿè´£è¯»å–å­—èŠ‚ç æ–‡ä»¶å¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒHotSpot è™šæ‹Ÿæœºä½¿ç”¨ C++ å®ç°ç±»åŠ è½½å™¨çš„éƒ¨åˆ†åŠŸèƒ½ã€‚åœ¨å®Œæˆç±»åŠ è½½åï¼Œ`forName()` æ–¹æ³•è¿”å›è¡¨ç¤ºè¯¥ç±»çš„ `Class` å¯¹è±¡ã€‚
2. `newInstance()`: åœ¨ Java 9 ä¹‹åï¼Œ`newInstance()` æ–¹æ³•å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ `Class.getDeclaredConstructor().newInstance()` æ›¿ä»£ã€‚è¿™äº›æ–¹æ³•çš„ä¸»è¦ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªç±»çš„æ–°å®ä¾‹ã€‚åœ¨åº•å±‚ï¼ŒJVM ä½¿ç”¨ C++ å®ç°å¯¹è±¡å®ä¾‹åŒ–çš„åŠŸèƒ½ã€‚æ­¤è¿‡ç¨‹åŒ…æ‹¬ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ã€è°ƒç”¨æ„é€ å‡½æ•°ä»¥åŠåˆå§‹åŒ–å¯¹è±¡çš„çŠ¶æ€ã€‚åœ¨æˆåŠŸåˆ›å»ºæ–°å®ä¾‹åï¼Œ`newInstance()` æ–¹æ³•è¿”å›æ–°åˆ›å»ºçš„å¯¹è±¡ã€‚

å¦å¤–ï¼Œåå°„APIçš„å®ç°ä¸»è¦ä¾èµ–äºJavaçš„æœ¬åœ°æ–¹æ³•ï¼ˆNative Methodï¼‰ã€‚æœ¬åœ°æ–¹æ³•æ˜¯ç”¨Cæˆ–C++ç­‰æœ¬åœ°è¯­è¨€å®ç°çš„æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æ“ä½œç³»ç»Ÿçš„èµ„æºå’Œåº•å±‚ç¡¬ä»¶ï¼Œä»è€Œå®ç°ä¸€äº›Javaè‡ªèº«éš¾ä»¥å®ç°çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œ`java.lang.Class`çš„`forName()`æ–¹æ³•å’Œ`newInstance()`æ–¹æ³•ï¼Œ`java.lang.reflect.Field`çš„`set()`å’Œ`get()`æ–¹æ³•ï¼Œ`java.lang.reflect.Method`çš„`invoke()`æ–¹æ³•ç­‰ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨æœ¬åœ°æ–¹æ³•æ¥å®ç°çš„ã€‚

å› æ­¤ï¼ŒJavaçš„åå°„æœºåˆ¶çš„å®ç°éœ€è¦ä¾èµ–äºç±»åŠ è½½æœºåˆ¶ã€å…ƒæ•°æ®å’Œæœ¬åœ°æ–¹æ³•ç­‰å¤šä¸ªå› ç´ ã€‚åå°„æœºåˆ¶ä½¿å¾—Javaå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°æ“ä½œå¯¹è±¡ï¼Œå¢åŠ äº†Javaçš„çµæ´»æ€§å’ŒåŠ¨æ€æ€§ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸€å®šçš„æ€§èƒ½æŸè€—å’Œå®‰å…¨éšæ‚£ã€‚

