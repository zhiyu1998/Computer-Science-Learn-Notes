---
sidebar_position: 2
title: 2022å…«è‚¡æ–‡ç²¾é€‰é›†
---
[toc]

## ğŸ‚ 2022å…«è‚¡æ–‡ç²¾é€‰é›†

æ•´ç†è‡ª

1. å´å¸ˆå…„çš„1000é“Java ç¨‹åºå‘˜å¿…å¤‡é¢è¯•é¢˜
2. JavaGuide
3. å°æ—coding
4. Java å…¨æ ˆçŸ¥è¯†ä½“ç³»
5. Javaå…«è‚¡æ–‡

é€‰å–ç†ç”±ï¼šæœ¬ç€æŸ¥ç¼ºè¡¥æ¼çš„æœ¨æ¡¶åŸç†ï¼Œåªé€‰å–é«˜é¢‘ï¼ˆâ­ï¸ã€ğŸŒ ã€ğŸŒŸã€âœ¨ã€ğŸ’«ã€ğŸ‡ã€ğŸ”¥ï¼‰å’Œä¸ä¼šçš„ï¼Œæ–¹ä¾¿é¢è¯•çªè¢­

## â˜•ï¸ JavaåŸºç¡€

### Java 8çš„æ¥â¼æ–°å¢äº†å“ªäº›ç‰¹æ€§ï¼Ÿ

å¢åŠ äº†defaultâ½…æ³•å’Œstaticâ½…æ³•ï¼Œè¿™2ç§â½…æ³•å¯ä»¥æœ‰â½…æ³•ä½“

### é‡è½½å’Œé‡å†™çš„åŒºåˆ«ï¼Ÿ

å‘ç”Ÿåœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œæ–¹æ³•åå¿…é¡»ç›¸åŒï¼Œå‚æ•°ç±»å‹ä¸åŒã€ä¸ªæ•°ä¸åŒã€é¡ºåºä¸åŒï¼Œæ–¹æ³•è¿”å›å€¼å’Œè®¿é—®
ä¿®é¥°ç¬¦å¯ä»¥ä¸åŒã€‚
ä¸‹é¢æ˜¯ã€ŠJava æ ¸å¿ƒæŠ€æœ¯ã€‹å¯¹é‡è½½è¿™ä¸ªæ¦‚å¿µçš„ä»‹ç»ï¼š

ç»¼ä¸Šï¼šé‡è½½å°±æ˜¯åŒä¸€ä¸ªç±»ä¸­å¤šä¸ªåŒåæ–¹æ³•æ ¹æ®ä¸åŒçš„ä¼ å‚æ¥æ‰§è¡Œä¸åŒçš„é€»è¾‘å¤„ç†ã€‚
é‡å†™ï¼š
é‡å†™å‘ç”Ÿåœ¨è¿è¡ŒæœŸï¼Œæ˜¯å­ç±»å¯¹çˆ¶ç±»çš„å…è®¸è®¿é—®çš„æ–¹æ³•çš„å®ç°è¿‡ç¨‹è¿›è¡Œé‡æ–°ç¼–å†™ã€‚

1. è¿”å›å€¼ç±»å‹ã€æ–¹æ³•åã€å‚æ•°åˆ—è¡¨å¿…é¡»ç›¸åŒï¼ŒæŠ›å‡ºçš„å¼‚å¸¸èŒƒå›´å°äºç­‰äºçˆ¶ç±»ï¼Œè®¿é—®ä¿®é¥°ç¬¦èŒƒå›´
   å¤§äºç­‰äºçˆ¶ç±»ã€‚
2. å¦‚æœçˆ¶ç±»æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦ä¸º private/final/static åˆ™å­ç±»å°±ä¸èƒ½é‡å†™è¯¥æ–¹æ³•ï¼Œä½†æ˜¯è¢« static ä¿®é¥°
   çš„æ–¹æ³•èƒ½å¤Ÿè¢«å†æ¬¡å£°æ˜ã€‚
3. æ„é€ æ–¹æ³•æ— æ³•è¢«é‡å†™
   ç»¼ä¸Šï¼šé‡å†™å°±æ˜¯å­ç±»å¯¹çˆ¶ç±»æ–¹æ³•çš„é‡æ–°æ”¹é€ ï¼Œå¤–éƒ¨æ ·å­ä¸èƒ½æ”¹å˜ï¼Œå†…éƒ¨é€»è¾‘å¯ä»¥æ”¹å˜

![image-20220617164632798](./images/image-20220617164632798.png)

![image-20220617164418584](./images/image-20220617164418584.png)

### å†…éƒ¨ç±»äº†è§£å—ï¼Ÿ

åœ¨Javaä¸­ï¼Œå¯ä»¥å°†â¼€ä¸ªç±»çš„å®šä¹‰æ”¾åœ¨å¦å¤–â¼€ä¸ªç±»çš„å®šä¹‰å†…éƒ¨ï¼Œè¿™å°±æ˜¯ å†…éƒ¨ç±» ã€‚å†…éƒ¨ç±»æœ¬èº«å°± æ˜¯ç±»çš„â¼€
ä¸ªå±æ€§ï¼Œä¸å…¶ä»–å±æ€§å®šä¹‰â½…å¼â¼€è‡´ã€‚

å†…éƒ¨ç±»å¯ä»¥åˆ†ä¸ºå››ç§ï¼š

æˆå‘˜å†…éƒ¨ç±»ï¼šåœ¨ä¸€ä¸ªç±»ä¸­ç›´æ¥å®šä¹‰çš„å†…éƒ¨ç±»ï¼Œæˆå‘˜å†…éƒ¨ç±»ä¸æ™®é€šç±»çš„æˆå‘˜æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå¯ä»¥ä¸æ™®é€šæˆå‘˜ä¸€æ ·è¿›è¡Œä¿®é¥°å’Œé™åˆ¶ã€‚

```java
class Circle {
    double radius = 0;
   
    public Circle(double radius) {
        this.radius = radius;
    }
   
    class Draw {     //å†…éƒ¨ç±»
        public void drawSahpe() {
            System.out.println("drawshape");
        }
    }
}
```

å±€éƒ¨å†…éƒ¨ç±»ï¼šåœ¨æ–¹æ³•ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ç§°ä¸ºå±€éƒ¨å†…éƒ¨ç±»ã€‚ä¸å±€éƒ¨å˜é‡ç±»ä¼¼

```java
class People{
    public People() {
       
    }
}
 
class Man{
    public Man(){
       
    }
   
    public People getWoman(){
        class Woman extends People{   //å±€éƒ¨å†…éƒ¨ç±»
            int age =0;
        }
        return new Woman();
    }
}
```

åŒ¿åå†…éƒ¨ç±»ï¼šåŒ¿åå†…éƒ¨ç±»å°±æ˜¯æ²¡æœ‰åå­—çš„å†…éƒ¨ç±»

é™æ€å†…éƒ¨ç±»ï¼ˆ**åµŒå¥—ç±»**ï¼‰ï¼šå¦‚æœä½ ä¸éœ€è¦å†…éƒ¨ç±»å¯¹è±¡ä¸å…¶å¤–å›´ç±»å¯¹è±¡ä¹‹é—´æœ‰è”ç³»ï¼Œé‚£ä½ å¯ä»¥å°†å†…éƒ¨ç±»å£°æ˜ä¸ºstatic

```java
public class Test {
    public static void main(String[] args)  {
        Outter.Inner inner = new Outter.Inner();
    }
}
 
class Outter {
    public Outter() {
       
    }
   
    static class Inner {
        public Inner() {
           
        }
    }
}
```

### HashSet å¦‚ä½•æ£€æŸ¥é‡å¤

æ€è·¯æ•´ç†ï¼šhashcodeç›¸åŒ -> equals() ä¸åŒ-> hashå†æ•£åˆ—

1. å½“ä½ æŠŠå¯¹è±¡åŠ â¼ŠHashSetæ—¶ï¼ŒHashSetä¼šå…ˆè®¡ç®—å¯¹è±¡çš„hashcodeå€¼æ¥åˆ¤æ–­å¯¹è±¡åŠ â¼Šçš„ä½ç½®ï¼ŒåŒæ—¶ä¹Ÿä¼šä¸å…¶ä»–å·²ç»åŠ â¼Šçš„å¯¹è±¡çš„hashcodeå€¼ä½œâ½è¾ƒ
2. å¦‚æœæ²¡æœ‰ç›¸ç¬¦çš„hashcodeï¼ŒHashSetä¼šå‡è®¾å¯¹è±¡æ²¡æœ‰é‡å¤å‡ºç°ã€‚ä½†æ˜¯**å¦‚æœå‘ç°æœ‰ç›¸åŒhashcodeå€¼çš„å¯¹è±¡ï¼Œè¿™æ—¶ä¼šè°ƒâ½¤equals()â½…æ³•**æ¥æ£€æŸ¥hashcodeç›¸ç­‰çš„å¯¹è±¡æ˜¯å¦çœŸçš„ç›¸åŒ
3. å¦‚æœä¸¤è€…ç›¸åŒï¼ŒHashSetå°±ä¸ä¼šè®©å…¶åŠ â¼Šæ“ä½œæˆåŠŸã€‚å¦‚æœä¸åŒçš„è¯ï¼Œå°±ä¼šé‡æ–°æ•£åˆ—åˆ°å…¶ä»–ä½ç½®ã€‚è¿™æ ·æˆ‘ä»¬å°±â¼¤â¼¤å‡å°‘äº†equalsçš„æ¬¡æ•°ï¼Œç›¸åº”å°±â¼¤â¼¤æâ¾¼äº†æ‰§â¾é€Ÿåº¦ã€‚

### æ„é€ â½…æ³•æœ‰å“ªäº›ç‰¹æ€§ï¼Ÿ

* åå­—ä¸ç±»åç›¸åŒ
* æ²¡æœ‰è¿”å›å€¼ï¼Œä½†ä¸èƒ½â½¤voidå£°æ˜æ„é€ å‡½æ•°
* â½£æˆç±»çš„å¯¹è±¡æ—¶â¾ƒåŠ¨æ‰§â¾ï¼Œâ½†éœ€è°ƒâ½¤

### final,static,this,super å…³é”®å­—æ€»ç»“

#### static

**static å…³é”®å­—ä¸»è¦æœ‰ä»¥ä¸‹å››ç§ä½¿ç”¨åœºæ™¯ï¼š**

1. **ä¿®é¥°æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•:** è¢« static ä¿®é¥°çš„æˆå‘˜å±äºç±»ï¼Œä¸å±äºå•ä¸ªè¿™ä¸ªç±»çš„æŸä¸ªå¯¹è±¡ï¼Œè¢«ç±»ä¸­æ‰€æœ‰å¯¹è±¡å…±äº«ï¼Œå¯ä»¥å¹¶ä¸”å»ºè®®é€šè¿‡ç±»åè°ƒç”¨ã€‚è¢« static å£°æ˜çš„æˆå‘˜å˜é‡å±äºé™æ€æˆå‘˜å˜é‡ï¼Œé™æ€å˜é‡ å­˜æ”¾åœ¨ Java å†…å­˜åŒºåŸŸçš„æ–¹æ³•åŒºã€‚è°ƒç”¨æ ¼å¼ï¼š`ç±»å.é™æ€å˜é‡å` `ç±»å.é™æ€æ–¹æ³•å()`
2. **é™æ€ä»£ç å—:** é™æ€ä»£ç å—å®šä¹‰åœ¨ç±»ä¸­æ–¹æ³•å¤–, é™æ€ä»£ç å—åœ¨éé™æ€ä»£ç å—ä¹‹å‰æ‰§è¡Œ(é™æ€ä»£ç å—â€”>éé™æ€ä»£ç å—â€”>æ„é€ æ–¹æ³•)ã€‚ è¯¥ç±»ä¸ç®¡åˆ›å»ºå¤šå°‘å¯¹è±¡ï¼Œé™æ€ä»£ç å—åªæ‰§è¡Œä¸€æ¬¡.
3. **é™æ€å†…éƒ¨ç±»ï¼ˆstatic ä¿®é¥°ç±»çš„è¯åªèƒ½ä¿®é¥°å†…éƒ¨ç±»ï¼‰ï¼š** é™æ€å†…éƒ¨ç±»ä¸éé™æ€å†…éƒ¨ç±»ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæœ€å¤§çš„åŒºåˆ«:  éé™æ€å†…éƒ¨ç±»åœ¨ç¼–è¯‘å®Œæˆä¹‹åä¼šéšå«åœ°ä¿å­˜ç€ä¸€ä¸ªå¼•ç”¨ï¼Œè¯¥å¼•ç”¨æ˜¯æŒ‡å‘åˆ›å»ºå®ƒçš„å¤–å›´ç±»ï¼Œä½†æ˜¯é™æ€å†…éƒ¨ç±»å´æ²¡æœ‰ã€‚æ²¡æœ‰è¿™ä¸ªå¼•ç”¨å°±æ„å‘³ç€ï¼š1.  å®ƒçš„åˆ›å»ºæ˜¯ä¸éœ€è¦ä¾èµ–å¤–å›´ç±»çš„åˆ›å»ºã€‚2. å®ƒä¸èƒ½ä½¿ç”¨ä»»ä½•å¤–å›´ç±»çš„é static æˆå‘˜å˜é‡å’Œæ–¹æ³•ã€‚
4. **é™æ€å¯¼åŒ…(ç”¨æ¥å¯¼å…¥ç±»ä¸­çš„é™æ€èµ„æºï¼Œ1.5 ä¹‹åçš„æ–°ç‰¹æ€§):** æ ¼å¼ä¸ºï¼š`import static` è¿™ä¸¤ä¸ªå…³é”®å­—è¿ç”¨å¯ä»¥æŒ‡å®šå¯¼å…¥æŸä¸ªç±»ä¸­çš„æŒ‡å®šé™æ€èµ„æºï¼Œå¹¶ä¸”ä¸éœ€è¦ä½¿ç”¨ç±»åè°ƒç”¨ç±»ä¸­é™æ€æˆå‘˜ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ç±»ä¸­é™æ€æˆå‘˜å˜é‡å’Œæˆå‘˜æ–¹æ³•ã€‚

#### final

**final å…³é”®å­—ï¼Œæ„æ€æ˜¯æœ€ç»ˆçš„ã€ä¸å¯ä¿®æ”¹çš„ï¼Œæœ€è§ä¸å¾—å˜åŒ– ï¼Œç”¨æ¥ä¿®é¥°ç±»ã€æ–¹æ³•å’Œå˜é‡ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š**

1. final ä¿®é¥°çš„ç±»ä¸èƒ½è¢«ç»§æ‰¿ï¼Œfinal ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•éƒ½ä¼šè¢«éšå¼çš„æŒ‡å®šä¸º final æ–¹æ³•ï¼›
2. final ä¿®é¥°çš„æ–¹æ³•ä¸èƒ½è¢«é‡å†™ï¼›
3. final ä¿®é¥°çš„å˜é‡æ˜¯å¸¸é‡ï¼Œå¦‚æœæ˜¯åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡ï¼Œåˆ™å…¶æ•°å€¼ä¸€æ—¦åœ¨åˆå§‹åŒ–ä¹‹åä¾¿ä¸èƒ½æ›´æ”¹ï¼›å¦‚æœæ˜¯å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œåˆ™åœ¨å¯¹å…¶åˆå§‹åŒ–ä¹‹åä¾¿ä¸èƒ½è®©å…¶æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡ã€‚

è¯´æ˜ï¼šä½¿ç”¨ final æ–¹æ³•çš„åŸå› æœ‰ä¸¤ä¸ªã€‚ç¬¬ä¸€ä¸ªåŸå› æ˜¯æŠŠæ–¹æ³•é”å®šï¼Œä»¥é˜²ä»»ä½•ç»§æ‰¿ç±»ä¿®æ”¹å®ƒçš„å«ä¹‰ï¼›ç¬¬äºŒä¸ªåŸå› æ˜¯æ•ˆç‡ã€‚åœ¨æ—©æœŸçš„ Java å®ç°ç‰ˆæœ¬ä¸­ï¼Œä¼šå°†  final æ–¹æ³•è½¬ä¸ºå†…åµŒè°ƒç”¨ã€‚ä½†æ˜¯å¦‚æœæ–¹æ³•è¿‡äºåºå¤§ï¼Œå¯èƒ½çœ‹ä¸åˆ°å†…åµŒè°ƒç”¨å¸¦æ¥çš„ä»»ä½•æ€§èƒ½æå‡ï¼ˆç°åœ¨çš„ Java ç‰ˆæœ¬å·²ç»ä¸éœ€è¦ä½¿ç”¨ final  æ–¹æ³•è¿›è¡Œè¿™äº›ä¼˜åŒ–äº†ï¼‰ã€‚ç±»ä¸­æ‰€æœ‰çš„ private æ–¹æ³•éƒ½éšå¼åœ°æŒ‡å®šä¸º finalã€‚

#### this

this å…³é”®å­—ç”¨äºå¼•ç”¨ç±»çš„å½“å‰å®ä¾‹ã€‚ ä¾‹å¦‚ï¼š

```java
class Manager {
    Employees[] employees;
    void manageEmployees() {
        int totalEmp = this.employees.length;
        System.out.println("Total employees: " + totalEmp);
        this.report();
    }
    void report() { }
}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œthis å…³é”®å­—ç”¨äºä¸¤ä¸ªåœ°æ–¹ï¼š

- this.employees.lengthï¼šè®¿é—®ç±» Manager çš„å½“å‰å®ä¾‹çš„å˜é‡ã€‚
- this.reportï¼ˆï¼‰ï¼šè°ƒç”¨ç±» Manager çš„å½“å‰å®ä¾‹çš„æ–¹æ³•ã€‚

æ­¤å…³é”®å­—æ˜¯å¯é€‰çš„ï¼Œè¿™æ„å‘³ç€å¦‚æœä¸Šé¢çš„ç¤ºä¾‹åœ¨ä¸ä½¿ç”¨æ­¤å…³é”®å­—çš„æƒ…å†µä¸‹è¡¨ç°ç›¸åŒã€‚ ä½†æ˜¯ï¼Œä½¿ç”¨æ­¤å…³é”®å­—å¯èƒ½ä¼šä½¿ä»£ç æ›´æ˜“è¯»æˆ–æ˜“æ‡‚ã€‚

#### super å…³é”®å­—

super å…³é”®å­—ç”¨äºä»å­ç±»è®¿é—®çˆ¶ç±»çš„å˜é‡å’Œæ–¹æ³•ã€‚ ä¾‹å¦‚ï¼š

```java
public class Super {
    protected int number;
    protected showNumber() {
        System.out.println("number = " + number);
    }
}
public class Sub extends Super {
    void bar() {
        super.number = 10;
        super.showNumber();
    }
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒSub ç±»è®¿é—®çˆ¶ç±»æˆå‘˜å˜é‡ number å¹¶è°ƒç”¨å…¶çˆ¶ç±» Super çš„ `showNumberï¼ˆï¼‰` æ–¹æ³•ã€‚

**ä½¿ç”¨ this å’Œ super è¦æ³¨æ„çš„é—®é¢˜ï¼š**

- åœ¨æ„é€ å™¨ä¸­ä½¿ç”¨ `super()` è°ƒç”¨çˆ¶ç±»ä¸­çš„å…¶ä»–æ„é€ æ–¹æ³•æ—¶ï¼Œè¯¥è¯­å¥å¿…é¡»å¤„äºæ„é€ å™¨çš„é¦–è¡Œï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚å¦å¤–ï¼Œthis è°ƒç”¨æœ¬ç±»ä¸­çš„å…¶ä»–æ„é€ æ–¹æ³•æ—¶ï¼Œä¹Ÿè¦æ”¾åœ¨é¦–è¡Œã€‚
- thisã€super ä¸èƒ½ç”¨åœ¨ static æ–¹æ³•ä¸­ã€‚

**ç®€å•è§£é‡Šä¸€ä¸‹ï¼š**

è¢« static ä¿®é¥°çš„æˆå‘˜å±äºç±»ï¼Œä¸å±äºå•ä¸ªè¿™ä¸ªç±»çš„æŸä¸ªå¯¹è±¡ï¼Œè¢«ç±»ä¸­æ‰€æœ‰å¯¹è±¡å…±äº«ã€‚è€Œ this ä»£è¡¨å¯¹æœ¬ç±»å¯¹è±¡çš„å¼•ç”¨ï¼ŒæŒ‡å‘æœ¬ç±»å¯¹è±¡ï¼›è€Œ super ä»£è¡¨å¯¹çˆ¶ç±»å¯¹è±¡çš„å¼•ç”¨ï¼ŒæŒ‡å‘çˆ¶ç±»å¯¹è±¡ï¼›æ‰€ä»¥ï¼Œ **this å’Œ super æ˜¯å±äºå¯¹è±¡èŒƒç•´çš„ä¸œè¥¿ï¼Œè€Œé™æ€æ–¹æ³•æ˜¯å±äºç±»èŒƒç•´çš„ä¸œè¥¿**ã€‚

### thisä¸superçš„åŒºåˆ«

* super:å®ƒå¼•â½¤å½“å‰å¯¹è±¡çš„ç›´æ¥â½—ç±»ä¸­çš„æˆå‘˜ï¼ˆâ½¤æ¥è®¿é—®ç›´æ¥â½—ç±»ä¸­è¢«éšè—çš„â½—ç±»ä¸­æˆå‘˜æ•°æ®æˆ–å‡½æ•°ï¼ŒåŸºç±»ä¸æ´¾â½£ç±»ä¸­æœ‰ç›¸åŒæˆå‘˜å®šä¹‰æ—¶å¦‚ï¼šsuper.å˜é‡åsuper.æˆå‘˜å‡½æ•°æ®åï¼ˆå®å‚ï¼‰
* thisï¼šå®ƒä»£è¡¨å½“å‰å¯¹è±¡åï¼ˆåœ¨ç¨‹åºä¸­æ˜“äº§â½£â¼†ä¹‰æ€§ä¹‹å¤„ï¼Œåº”ä½¿â½¤thisæ¥æŒ‡æ˜å½“å‰å¯¹è±¡ï¼›å¦‚æœå‡½æ•°çš„å½¢å‚ä¸ç±»ä¸­çš„æˆå‘˜æ•°æ®åŒåï¼Œè¿™æ—¶éœ€â½¤thisæ¥æŒ‡æ˜æˆå‘˜å˜é‡åï¼‰
* ğŸ‘»super()å’Œthis()ç±»ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼šsuper()åœ¨â¼¦ç±»ä¸­è°ƒâ½¤â½—ç±»çš„æ„é€ â½…æ³•ï¼Œthis()åœ¨æœ¬ç±»å†…è°ƒâ½¤æœ¬ç±»çš„å…¶å®ƒæ„é€ â½…æ³•ã€‚
* ğŸ‘»super()å’Œthis()å‡éœ€æ”¾åœ¨æ„é€ â½…æ³•å†…ç¬¬â¼€â¾ã€‚
* ğŸ‘»thiså’Œsuperä¸èƒ½åŒæ—¶å‡ºç°åœ¨â¼€ä¸ªæ„é€ å‡½æ•°â¾¥â¾¯ï¼Œå› ä¸ºthiså¿…ç„¶ä¼šè°ƒâ½¤å…¶å®ƒçš„æ„é€ å‡½æ•°ï¼Œå…¶å®ƒçš„æ„é€ å‡½æ•°å¿…ç„¶ä¹Ÿä¼šæœ‰superè¯­å¥çš„å­˜åœ¨ï¼Œæ‰€ä»¥åœ¨åŒâ¼€ä¸ªæ„é€ å‡½æ•°â¾¥â¾¯æœ‰ç›¸åŒçš„è¯­å¥ï¼Œå°±å¤±å»äº†è¯­å¥çš„æ„ä¹‰ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä¼šé€šè¿‡ã€‚
* this()å’Œsuper()éƒ½æŒ‡çš„æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥ï¼Œå‡ä¸å¯ä»¥åœ¨staticç¯å¢ƒä¸­ä½¿â½¤ã€‚åŒ…æ‹¬ï¼šstaticå˜é‡,staticâ½…æ³•ï¼Œstaticè¯­å¥å—ã€‚
* ğŸ‘»ä»æœ¬è´¨ä¸Šè®²ï¼Œthisæ˜¯â¼€ä¸ªæŒ‡å‘æœ¬å¯¹è±¡çš„æŒ‡é’ˆ,ç„¶â½½superæ˜¯â¼€ä¸ªJavaå…³é”®å­—ã€‚

### é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†

#### æ¦‚è¿°

ä»£ç†æ¨¡å¼å°±æ˜¯ **ä½¿ç”¨ä»£ç†å¯¹è±¡æ¥ä»£æ›¿å¯¹çœŸå®å¯¹è±¡çš„è®¿é—®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸ä¿®æ”¹åŸç›®æ ‡å¯¹è±¡çš„å‰æä¸‹ï¼Œæä¾›é¢å¤–çš„åŠŸèƒ½æ“ä½œï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚**

ä»£ç†æ¨¡å¼å¤§è‡´æœ‰ä¸‰ç§è§’è‰²ï¼š

- Real Subjectï¼šçœŸå®ç±»ï¼Œä¹Ÿå°±æ˜¯è¢«ä»£ç†ç±»ã€å§”æ‰˜ç±»ã€‚ç”¨æ¥çœŸæ­£å®Œæˆä¸šåŠ¡æœåŠ¡åŠŸèƒ½ï¼›
- Proxyï¼šä»£ç†ç±»ã€‚å°†è‡ªèº«çš„è¯·æ±‚ç”¨ Real Subject å¯¹åº”çš„åŠŸèƒ½æ¥å®ç°ï¼Œä»£ç†ç±»å¯¹è±¡å¹¶ä¸çœŸæ­£çš„å»å®ç°å…¶ä¸šåŠ¡åŠŸèƒ½ï¼›
- Subjectï¼šå®šä¹‰ RealSubject å’Œ Proxy è§’è‰²éƒ½åº”è¯¥å®ç°çš„æ¥å£ã€‚

![img](images/20210221222746.png)

é€šä¿—æ¥è¯´ï¼Œ**ä»£ç†æ¨¡å¼çš„ä¸»è¦ä½œç”¨æ˜¯æ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è¯´åœ¨ç›®æ ‡å¯¹è±¡çš„æŸä¸ªæ–¹æ³•æ‰§è¡Œå‰åä½ å¯ä»¥å¢åŠ ä¸€äº›é¢å¤–çš„æ“ä½œï¼Œå¹¶ä¸”ä¸ç”¨ä¿®æ”¹è¿™ä¸ªæ–¹æ³•çš„åŸæœ‰ä»£ç **ã€‚å¦‚æœå¤§å®¶å­¦è¿‡ Spring çš„ AOPï¼Œä¸€å®šèƒ½å¤Ÿå¾ˆå¥½çš„ç†è§£è¿™å¥è¯ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šä½ æ‰¾äº†å°çº¢æ¥å¸®ä½ å‘å°ç»¿é—®è¯ï¼Œå°çº¢å°±çœ‹ä½œæ˜¯ä»£ç†æˆ‘çš„ä»£ç†ç±» Proxyï¼Œè€Œä½ æ˜¯ Real Subjectï¼Œå› ä¸ºå°çº¢è¦ä¼ è¾¾çš„è¯å…¶å®æ˜¯ä½ è¯´çš„ã€‚é‚£ä¹ˆä½ å’Œå°çº¢éƒ½éœ€è¦å®ç°çš„æ¥å£ï¼ˆSubjectï¼‰å°±æ˜¯è¯´è¯ï¼Œç”±äºä½ ä¿©éƒ½èƒ½è¯´è¯ï¼Œåœ¨å¤–ç•Œçœ‹æ¥ä½ ä¿©å°±æ˜¯ä¸€æ ·çš„

![image-20220723002924420](images/image-20220723002924420.png)

çœ‹åˆ°è¿™é‡Œï¼Œä¸çŸ¥é“å¤§å®¶èƒ½ä¸èƒ½ç†è§£äº†ä¸ºä»€ä¹ˆå§”æ‰˜ç±»å’Œä»£ç†ç±»éƒ½éœ€è¦å®ç°ç›¸åŒçš„æ¥å£ï¼Ÿ

é‚£æ˜¯ä¸ºäº†ä¿æŒè¡Œä¸ºçš„ä¸€è‡´æ€§ï¼Œåœ¨è®¿é—®è€…çœ‹æ¥ä¸¤è€…ä¹‹é—´å°±æ²¡æœ‰åŒºåˆ«ã€‚è¿™æ ·ï¼Œé€šè¿‡ä»£ç†ç±»è¿™ä¸ªä¸­é—´å±‚ï¼Œå¾ˆå¥½åœ°éšè—å’Œä¿æŠ¤äº†å§”æ‰˜ç±»å¯¹è±¡ï¼Œèƒ½**æœ‰æ•ˆå±è”½å¤–ç•Œå¯¹å§”æ‰˜ç±»å¯¹è±¡çš„ç›´æ¥è®¿é—®**ã€‚åŒæ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨ä»£ç†ç±»ä¸ŠåŠ ä¸Šé¢å¤–çš„æ“ä½œï¼Œæ¯”å¦‚**å°çº¢åœ¨è¯´è¯ä¹‹å‰ä¼šè·³ä¸€æ®µèˆï¼Œå¤–ç•Œå°±ä¼šè§‰å¾—ä½ åœ¨è¯´è¯å‰ä¼šè·³ä¸€æ®µèˆï¼Œæ‰€ä»¥ï¼Œè¿™å°±å®ç°äº†å§”æ‰˜ç±»çš„åŠŸèƒ½å¢å¼º**ã€‚

ä»£ç†æ¨¡å¼æœ‰é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¸¤ç§å®ç°æ–¹å¼ã€‚

#### é™æ€ä»£ç†

å…ˆæ¥çœ‹é™æ€ä»£ç†çš„å®ç°æ­¥éª¤ï¼š

1ï¼‰å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ˆSubjectï¼‰

2ï¼‰åˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰å®ç°è¿™ä¸ªæ¥å£

3ï¼‰åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼ˆProxyï¼‰åŒæ ·å®ç°è¿™ä¸ªæ¥å£

4ï¼‰**å°†å§”æ‰˜ç±» Real Subject æ³¨å…¥è¿›ä»£ç†ç±» Proxy**ï¼Œåœ¨ä»£ç†ç±»çš„æ–¹æ³•ä¸­è°ƒç”¨ Real Subject ä¸­çš„å¯¹åº”æ–¹æ³•ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»£ç†ç±»å±è”½å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰ååšä¸€äº›è‡ªå·±æƒ³åšçš„äº‹æƒ…ã€‚

ä»å®ç°å’Œåº”ç”¨è§’åº¦æ¥è¯´ï¼Œé™æ€ä»£ç†ä¸­ï¼Œæˆ‘ä»¬å¯¹ç›®æ ‡å¯¹è±¡çš„æ¯ä¸ªæ–¹æ³•çš„å¢å¼ºéƒ½æ˜¯æ‰‹åŠ¨å®Œæˆçš„ï¼Œéå¸¸ä¸çµæ´»ï¼ˆæ¯”å¦‚æ¥å£ä¸€æ—¦æ–°å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹ï¼‰ä¸”éº»çƒ¦ï¼ˆéœ€è¦å¯¹æ¯ä¸ªç›®æ ‡ç±»éƒ½å•ç‹¬å†™ä¸€ä¸ªä»£ç†ç±»ï¼‰ã€‚ å®é™…åº”ç”¨åœºæ™¯éå¸¸éå¸¸å°‘ï¼Œæ—¥å¸¸å¼€å‘å‡ ä¹çœ‹ä¸åˆ°ä½¿ç”¨é™æ€ä»£ç†çš„åœºæ™¯ã€‚

ä» JVM å±‚é¢æ¥è¯´ï¼Œ **é™æ€ä»£ç†åœ¨ç¼–è¯‘æ—¶å°±å°†æ¥å£ã€å§”æ‰˜ç±»ã€ä»£ç†ç±»è¿™äº›éƒ½å˜æˆäº†ä¸€ä¸ªä¸ªå®é™…çš„ `.class` æ–‡ä»¶ã€‚**

1ï¼‰å®šä¹‰å‘é€çŸ­ä¿¡çš„æ¥å£

```java
public interface SmsService {
    String send(String message);
}
```

2ï¼‰åˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰å®ç°è¿™ä¸ªæ¥å£

```java
public class SmsServiceImpl implements SmsService {
    public String send(String message) {
        System.out.println("send message:" + message);
        return message;
    }
}
```

3ï¼‰åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼ˆProxyï¼‰åŒæ ·å®ç°è¿™ä¸ªæ¥å£

4ï¼‰å°†å§”æ‰˜ç±» Real Subject æ³¨å…¥è¿›ä»£ç†ç±» Proxyï¼Œåœ¨ä»£ç†ç±»çš„æ–¹æ³•ä¸­è°ƒç”¨ Real Subject ä¸­çš„å¯¹åº”æ–¹æ³•ã€‚è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»£ç†ç±»å±è”½å¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰ååšä¸€äº›è‡ªå·±æƒ³åšçš„äº‹æƒ…ã€‚

```java
public class SmsProxy implements SmsService {

    // å°†å§”æ‰˜ç±»æ³¨å…¥è¿›ä»£ç†ç±»
    private final SmsService smsService;

    public SmsProxy(SmsService smsService) {
        this.smsService = smsService;
    }

    @Override
    public String send(String message) {
        // è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("before method send()");
        // è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•
        smsService.send(message); 
        // è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("after method send()");
        return null;
    }
}
```

é‚£ä¹ˆï¼Œå¦‚ä½•ä½¿ç”¨è¿™ä¸ªè¢«å¢å¼ºçš„ `send` æ–¹æ³•å‘¢ï¼Ÿ

```java
public class Main {
    public static void main(String[] args) {
        SmsService smsService = new SmsServiceImpl();
        SmsProxy smsProxy = new SmsProxy(smsService);
        smsProxy.send("Java");
    }
}
```

è¿è¡Œä¸Šè¿°ä»£ç ä¹‹åï¼Œæ§åˆ¶å°æ‰“å°å‡ºï¼š

```bash
before method send()
send message:java
after method send()
```

ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å·²ç»å¢å¼ºäº†å§”æ‰˜ç±» `SmsServiceImpl`  çš„ `send()` æ–¹æ³•ã€‚

å½“ç„¶ï¼Œä»ä¸Šè¿°ä»£ç æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œé™æ€ä»£ç†å­˜åœ¨ä¸€å®šçš„å¼Šç«¯ã€‚å‡å¦‚è¯´æˆ‘ä»¬ç°åœ¨æ–°å¢äº†ä¸€ä¸ªå§”æ‰˜ç±»å®ç°äº† `SmsService` æ¥å£ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹è¿™ä¸ªå§”æ‰˜ç±»è¿›è¡Œå¢å¼ºï¼Œå°±éœ€è¦é‡æ–°å†™ä¸€ä¸ªä»£ç†ç±»ï¼Œç„¶åæ³¨å…¥è¿™ä¸ªæ–°çš„å§”æ‰˜ç±»ï¼Œéå¸¸ä¸çµæ´»ã€‚ä¹Ÿå°±æ˜¯è¯´é™æ€ä»£ç†æ˜¯ä¸€ä¸ªå§”æ‰˜äº†å¯¹åº”ä¸€ä¸ªä»£ç†ç±»ï¼Œèƒ½ä¸èƒ½**å°†ä»£ç†ç±»åšæˆä¸€ä¸ªé€šç”¨çš„**å‘¢ï¼Ÿä¸ºæ­¤ï¼ŒåŠ¨æ€ä»£ç†åº”ç”¨è€Œç”Ÿã€‚



#### Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶

åœ¨è®²è§£åŠ¨æ€ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦è¯¦ç»†è¯´ä¸€ä¸‹ `.class` å­—èŠ‚ç æ–‡ä»¶è¿™ä¸ªä¸œè¥¿ã€‚åŠ¨æ€ä»£ç†æœºåˆ¶å’Œ Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶æ¯æ¯ç›¸å…³ã€‚

åœ¨ä¸Šæ–‡åå°„ä¸­æˆ‘ä»¬æåˆ°ï¼Œä¸€ä¸ª `Class` ç±»å¯¹åº”ä¸€ä¸ª `.class` å­—èŠ‚ç æ–‡ä»¶ï¼Œä¹Ÿå°±è¯´å­—èŠ‚ç æ–‡ä»¶ä¸­å­˜å‚¨äº†ä¸€ä¸ªç±»çš„å…¨éƒ¨ä¿¡æ¯ã€‚å­—èŠ‚ç å…¶å®æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå†…å®¹æ˜¯åªæœ‰ JVM èƒ½å¤Ÿè¯†åˆ«çš„æœºå™¨ç ã€‚

è§£æè¿‡ç¨‹è¿™æ ·çš„ï¼šJVM è¯»å– `.class` å­—èŠ‚ç æ–‡ä»¶ï¼Œå–å‡ºäºŒè¿›åˆ¶æ•°æ®ï¼ŒåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè§£æå­—èŠ‚ç æ–‡ä»¶å†…çš„ä¿¡æ¯ï¼Œç”Ÿæˆå¯¹åº”çš„ `Class` ç±»å¯¹è±¡ï¼š

![image-20220723003010392](images/image-20220723003010392.png)

æ˜¾ç„¶ï¼Œä¸Šè¿°è¿™ä¸ªè¿‡ç¨‹æ˜¯åœ¨ç¼–è¯‘æœŸå°±å‘ç”Ÿçš„ã€‚

é‚£ä¹ˆï¼Œç”±äºJVM æ˜¯é€šè¿‡ `.class` å­—èŠ‚ç æ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶ä¿¡æ¯ï¼‰åŠ è½½ç±»çš„ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¿è¡ŒæœŸéµå¾ª Java ç¼–è¯‘ç³»ç»Ÿç»„ç»‡ `.class` å­—èŠ‚ç æ–‡ä»¶çš„æ ¼å¼å’Œç»“æ„ï¼Œç”Ÿæˆç›¸åº”çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œç„¶åå†æŠŠè¿™ä¸ªäºŒè¿›åˆ¶æ•°æ®åŠ è½½è½¬æ¢æˆå¯¹åº”çš„ç±»ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¸å°±å®Œæˆäº†åœ¨è¿è¡Œæ—¶åŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªç±»ã€‚è¿™ä¸ªæ€æƒ³å…¶å®ä¹Ÿå°±æ˜¯åŠ¨æ€ä»£ç†çš„æ€æƒ³ã€‚

![image-20220723003018675](images/image-20220723003018675.png)

åœ¨è¿è¡Œæ—¶æœŸæŒ‰ç…§ JVM è§„èŒƒå¯¹ `.class` å­—èŠ‚ç æ–‡ä»¶çš„ç»„ç»‡è§„åˆ™ï¼Œç”Ÿæˆå¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®ã€‚å½“å‰æœ‰å¾ˆå¤šå¼€æºæ¡†æ¶å¯ä»¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ï¼Œå¦‚

- ASM
- CGLIB
- Javassist
- ......

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**CGLIB æ˜¯åŸºäº ASM çš„**ã€‚ è¿™é‡Œç®€å•å¯¹æ¯”ä¸€ä¸‹ ASM å’Œ Javassistï¼š

- Javassist æºä»£ç çº§ API æ¯” ASM ä¸­å®é™…çš„å­—èŠ‚ç æ“ä½œæ›´å®¹æ˜“ä½¿ç”¨
- Javassist åœ¨å¤æ‚çš„å­—èŠ‚ç çº§æ“ä½œä¸Šæä¾›äº†æ›´é«˜çº§åˆ«çš„æŠ½è±¡å±‚ã€‚Javassist æºä»£ç çº§ API åªéœ€è¦å¾ˆå°‘çš„å­—èŠ‚ç çŸ¥è¯†ï¼Œç”šè‡³ä¸éœ€è¦ä»»ä½•å®é™…å­—èŠ‚ç çŸ¥è¯†ï¼Œå› æ­¤å®ç°èµ·æ¥æ›´å®¹æ˜“ã€æ›´å¿«ã€‚
- Javassist ä½¿ç”¨åå°„æœºåˆ¶ï¼Œè¿™ä½¿å¾—å®ƒæ¯” ASM æ…¢ã€‚

**æ€»çš„æ¥è¯´ ASM æ¯” Javassist å¿«å¾—å¤šï¼Œå¹¶ä¸”æä¾›äº†æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯ Javassist ç›¸å¯¹æ¥è¯´æ›´å®¹æ˜“ä½¿ç”¨**ï¼Œä¸¤è€…å„æœ‰åƒç§‹ã€‚

ä»¥ Javassist ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›æ¡†æ¶åœ¨è¿è¡Œæ—¶ç”Ÿæˆ `.class` å­—èŠ‚ç æ–‡ä»¶çš„å¼ºå¤§èƒ½åŠ›ã€‚

æ­£å¸¸æ¥è¯´ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```java
package com.samples;

public class Programmer {
    public void code(){
        System.out.println("I'm a Programmer,Just Coding.....");
    }
}
```

ä¸‹é¢é€šè¿‡ Javassist åˆ›å»ºå’Œä¸Šé¢ä¸€æ¨¡ä¸€æ ·çš„ `Programmer` ç±»çš„å­—èŠ‚ç ï¼š

```java
import javassist.ClassPool;
import javassist.CtClass;
import javassist.CtMethod;
import javassist.CtNewMethod;

public class MyGenerator {
    public static void main(String[] args) throws Exception {
        ClassPool pool = ClassPool.getDefault();
          // åˆ›å»º Programmer ç±»        
        CtClass cc= pool.makeClass("com.samples.Programmer");
        // å®šä¹‰æ–¹æ³•
        CtMethod method = CtNewMethod.make("public void code(){}", cc);
        // æ’å…¥æ–¹æ³•ä»£ç 
        method.insertBefore("System.out.println(\"I'm a Programmer,Just Coding.....\");");
        cc.addMethod(method);
        // ä¿å­˜ç”Ÿæˆçš„å­—èŠ‚ç 
        cc.writeFile("d://temp");
    }
}
```

é€šè¿‡åç¼–è¯‘å·¥å…·æ‰“å¼€ `Programmer.class` å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ä»£ç ï¼š

![image-20220723003032359](images/image-20220723003032359.png)



#### åŠ¨æ€ä»£ç†

äº†è§£äº† Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼Œå¯ä»¥å¼€å§‹å­¦ä¹ åŠ¨æ€ä»£ç†ï¼ˆDynamic Proxyï¼‰äº†ã€‚

å›é¡¾ä¸€ä¸‹é™æ€ä»£ç†ï¼Œæˆ‘ä»¬æŠŠé™æ€ä»£ç†çš„æ‰§è¡Œè¿‡ç¨‹æŠ½è±¡ä¸ºä¸‹å›¾ï¼š

![image-20220723003049255](images/image-20220723003049255.png)

å¯ä»¥çœ‹è§ï¼Œä»£ç†ç±»æ— éæ˜¯åœ¨è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•çš„å‰åå¢åŠ äº†ä¸€äº›æ“ä½œã€‚å§”æ‰˜ç±»çš„ä¸åŒï¼Œä¹Ÿå°±å¯¼è‡´ä»£ç†ç±»çš„ä¸åŒã€‚

é‚£ä¹ˆä¸ºäº†åšä¸€ä¸ªé€šç”¨æ€§çš„ä»£ç†ç±»å‡ºæ¥ï¼Œæˆ‘ä»¬æŠŠè°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•çš„è¿™ä¸ªåŠ¨ä½œæŠ½å–å‡ºæ¥ï¼ŒæŠŠå®ƒå°è£…æˆä¸€ä¸ªé€šç”¨æ€§çš„å¤„ç†ç±»ï¼Œäºæ˜¯å°±æœ‰äº†åŠ¨æ€ä»£ç†ä¸­çš„ `InvocationHandler` è§’è‰²ï¼ˆå¤„ç†ç±»ï¼‰ã€‚

äºæ˜¯ï¼Œåœ¨ä»£ç†ç±»å’Œå§”æ‰˜ç±»ä¹‹é—´å°±å¤šäº†ä¸€ä¸ªå¤„ç†ç±»çš„è§’è‰²ï¼Œè¿™ä¸ªè§’è‰²ä¸»è¦æ˜¯**å¯¹ä»£ç†ç±»è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•çš„è¿™ä¸ªåŠ¨ä½œè¿›è¡Œç»Ÿä¸€çš„è°ƒç”¨**ï¼Œä¹Ÿå°±æ˜¯ç”± `InvocationHandler` æ¥ç»Ÿä¸€å¤„ç†ä»£ç†ç±»è°ƒç”¨å§”æ‰˜ç±»æ–¹æ³•è¿™ä¸ªæ“ä½œã€‚çœ‹ä¸‹å›¾ï¼š

![image-20220723003057769](images/image-20220723003057769.png)

**ä» JVM è§’åº¦æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ `.class` å­—èŠ‚ç æ–‡ä»¶ ï¼Œå¹¶åŠ è½½åˆ° JVM ä¸­çš„**ã€‚è¿™ä¸ªæˆ‘ä»¬åœ¨ Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ä¸­å·²ç»æåˆ°è¿‡ã€‚

è™½ç„¶åŠ¨æ€ä»£ç†åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨çš„ç›¸å¯¹è¾ƒå°‘ï¼Œä½†æ˜¯åœ¨æ¡†æ¶ä¸­çš„å‡ ä¹æ˜¯å¿…ç”¨çš„ä¸€é—¨æŠ€æœ¯ã€‚å­¦ä¼šäº†åŠ¨æ€ä»£ç†ä¹‹åï¼Œå¯¹äºæˆ‘ä»¬ç†è§£å’Œå­¦ä¹ å„ç§æ¡†æ¶çš„åŸç†ä¹Ÿéå¸¸æœ‰å¸®åŠ©ï¼Œ**Spring AOPã€RPC ç­‰æ¡†æ¶çš„å®ç°éƒ½ä¾èµ–äº†åŠ¨æ€ä»£ç†**ã€‚

å°± Java æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ï¼š

- JDK åŠ¨æ€ä»£ç†
- CGLIB åŠ¨æ€ä»£ç†
- Javassit åŠ¨æ€ä»£ç†
- ......

ä¸‹é¢è¯¦ç»†è®²è§£è¿™ä¸‰ç§åŠ¨æ€ä»£ç†æœºåˆ¶ã€‚

#### JDK åŠ¨æ€ä»£ç†æœºåˆ¶

å…ˆæ¥çœ‹ä¸‹ JDK åŠ¨æ€ä»£ç†æœºåˆ¶çš„ä½¿ç”¨æ­¥éª¤ï¼š

1ï¼‰å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ˆSubjectï¼‰

2ï¼‰åˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰å®ç°è¿™ä¸ªæ¥å£

3ï¼‰åˆ›å»ºä¸€ä¸ªå¤„ç†ç±»å¹¶å®ç° `InvocationHandler` æ¥å£ï¼Œé‡å†™å…¶ `invoke` æ–¹æ³•ï¼ˆåœ¨ `invoke` æ–¹æ³•ä¸­åˆ©ç”¨åå°„æœºåˆ¶è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•ï¼Œå¹¶è‡ªå®šä¹‰ä¸€äº›å¤„ç†é€»è¾‘ï¼‰ï¼Œå¹¶å°†å§”æ‰˜ç±»æ³¨å…¥å¤„ç†ç±»

![image-20220723003128864](images/image-20220723003128864.png)

è¯¥æ–¹æ³•æœ‰ä¸‹é¢ä¸‰ä¸ªå‚æ•°ï¼š

- proxyï¼šä»£ç†ç±»å¯¹è±¡ï¼ˆè§ä¸‹ä¸€æ­¥ï¼‰
- methodï¼šè¿˜è®°å¾—æˆ‘ä»¬åœ¨ä¸Šç¯‡æ–‡ç« åå°„ä¸­è®²åˆ°çš„ `Method.invoke` å—ï¼Ÿå°±æ˜¯è¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•ï¼ˆåå°„ï¼‰

![image-20220723003137612](images/image-20220723003137612.png)

- argsï¼šä¼ ç»™å§”æ‰˜ç±»æ–¹æ³•çš„å‚æ•°åˆ—è¡¨

4ï¼‰åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ï¼šé€šè¿‡ `Proxy.newProxyInstance()` åˆ›å»ºå§”æ‰˜ç±»å¯¹è±¡çš„ä»£ç†å¯¹è±¡

![image-20220723003147365](images/image-20220723003147365.png)

è¿™ä¸ªæ–¹æ³•éœ€è¦ 3 ä¸ªå‚æ•°ï¼š

- ç±»åŠ è½½å™¨ ClassLoader
- å§”æ‰˜ç±»å®ç°çš„æ¥å£æ•°ç»„ï¼Œè‡³å°‘éœ€è¦ä¼ å…¥ä¸€ä¸ªæ¥å£è¿›å»
- è°ƒç”¨çš„ `InvocationHandler` å®ä¾‹å¤„ç†æ¥å£æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ 3 æ­¥æˆ‘ä»¬åˆ›å»ºçš„ç±»çš„å®ä¾‹ï¼‰

ä¹Ÿå°±æ˜¯è¯´ï¼šæˆ‘ä»¬åœ¨é€šè¿‡ `Proxy` ç±»çš„ `newProxyInstance()` åˆ›å»ºçš„ä»£ç†å¯¹è±¡åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…ä¼šè°ƒç”¨åˆ°å®ç°äº† `InvocationHandler` æ¥å£çš„å¤„ç†ç±»çš„ `invoke()`æ–¹æ³•ï¼Œå¯ä»¥åœ¨ `invoke()` æ–¹æ³•ä¸­è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ååšä»€ä¹ˆäº‹æƒ…ã€‚



1ï¼‰å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ˆSubjectï¼‰

```java
public interface SmsService {
    String send(String message);
}
```

2ï¼‰åˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰å®ç°è¿™ä¸ªæ¥å£

```java
public class SmsServiceImpl implements SmsService {
    public String send(String message) {
        System.out.println("send message:" + message);
        return message;
    }
}
```

3ï¼‰åˆ›å»ºä¸€ä¸ªå¤„ç†ç±»ï¼Œå¹¶å°†å§”æ‰˜ç±»æ³¨å…¥å¤„ç†ç±»ï¼Œå¦å¤–ï¼Œè¿™ä¸ªå¤„ç†ç±»éœ€è¦å®ç° `InvocationHandler` æ¥å£ï¼Œé‡å†™å…¶ `invoke` æ–¹æ³•ï¼ˆåœ¨ `invoke` æ–¹æ³•ä¸­åˆ©ç”¨åå°„æœºåˆ¶è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•ï¼Œå¹¶è‡ªå®šä¹‰ä¸€äº›å¤„ç†é€»è¾‘ï¼‰

```java
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;

public class DebugInvocationHandler implements InvocationHandler {

    // å°†å§”æ‰˜ç±»æ³¨å…¥å¤„ç†ç±»ï¼ˆè¿™é‡Œæˆ‘ä»¬ç”¨ Object ä»£æ›¿ï¼Œæ–¹ä¾¿æ‰©å±•ï¼‰
    private final Object target;

    public DebugInvocationHandler(Object target) {
        this.target = target;
    }

    // é‡å†™ invoke æ–¹æ³•
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws InvocationTargetException, IllegalAccessException {
        //è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("before method " + method.getName());
        Object result = method.invoke(target, args);
        //è°ƒç”¨æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("after method " + method.getName());
        return result;
    }
}
```

4ï¼‰å®šä¹‰ä¸€ä¸ªåˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰çš„å·¥å‚ç±»ï¼šé€šè¿‡ `Proxy.newProxyInstance()` åˆ›å»ºå§”æ‰˜ç±»å¯¹è±¡çš„ä»£ç†å¯¹è±¡

```java
public class JdkProxyFactory {
    public static Object getProxy(Object target) {
        return Proxy.newProxyInstance(
                target.getClass().getClassLoader(),
                target.getClass().getInterfaces(),
                new DebugInvocationHandler(target)
        );
    }
}
```

5ï¼‰å®é™…ä½¿ç”¨

```java
SmsService smsService = (SmsService) JdkProxyFactory.getProxy(new SmsServiceImpl());
smsService.send("Java");
```

è¿è¡Œä¸Šè¿°ä»£ç ä¹‹åï¼Œæ§åˆ¶å°æ‰“å°å‡ºï¼š

```text
before method send
send message:Java
after method send
```

#### CGLIB åŠ¨æ€ä»£ç†æœºåˆ¶

**JDK åŠ¨æ€ä»£ç†æœ‰ä¸€ä¸ªæœ€è‡´å‘½çš„é—®é¢˜æ˜¯å®ƒåªèƒ½ä»£ç†å®ç°äº†æŸä¸ªæ¥å£çš„å®ç°ç±»ï¼Œå¹¶ä¸”ä»£ç†ç±»ä¹Ÿåªèƒ½ä»£ç†æ¥å£ä¸­å®ç°çš„æ–¹æ³•ï¼Œè¦æ˜¯å®ç°ç±»ä¸­æœ‰è‡ªå·±ç§æœ‰çš„æ–¹æ³•ï¼Œè€Œæ¥å£ä¸­æ²¡æœ‰çš„è¯ï¼Œè¯¥æ–¹æ³•ä¸èƒ½è¿›è¡Œä»£ç†è°ƒç”¨**ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ CGLIB åŠ¨æ€ä»£ç†æœºåˆ¶ã€‚

ä¸Šæ–‡ä¹Ÿæåˆ°è¿‡ï¼ŒCGLIBï¼ˆCode Generation Libraryï¼‰æ˜¯ä¸€ä¸ªåŸºäº ASM çš„ Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹å’ŒåŠ¨æ€ç”Ÿæˆã€‚åŸç†å°±æ˜¯**é€šè¿‡å­—èŠ‚ç æŠ€æœ¯ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œå¹¶åœ¨å­ç±»ä¸­æ‹¦æˆªçˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œç»‡å…¥é¢å¤–çš„ä¸šåŠ¡é€»è¾‘**ã€‚å…³é”®è¯å¤§å®¶æ³¨æ„åˆ°æ²¡æœ‰ï¼Œæ‹¦æˆªï¼CGLIB å¼•å…¥ä¸€ä¸ªæ–°çš„è§’è‰²å°±æ˜¯**æ–¹æ³•æ‹¦æˆªå™¨** `MethodInterceptor`ã€‚å’Œ JDK ä¸­çš„å¤„ç†ç±» `InvocationHandler` å·®ä¸å¤šï¼Œä¹Ÿæ˜¯ç”¨æ¥å®ç°æ–¹æ³•çš„ç»Ÿä¸€è°ƒç”¨çš„ã€‚çœ‹ä¸‹å›¾ï¼š

![image-20220723003222393](images/image-20220723003222393.png)

å¦å¤–ç”±äº CGLIB é‡‡ç”¨**ç»§æ‰¿**çš„æ–¹å¼ï¼Œæ‰€ä»¥è¢«ä»£ç†çš„ç±»ä¸èƒ½è¢« `final` ä¿®é¥°ã€‚

å¾ˆå¤šçŸ¥åçš„å¼€æºæ¡†æ¶éƒ½ä½¿ç”¨åˆ°äº† CGLIBï¼Œ ä¾‹å¦‚ **Spring ä¸­çš„ AOP æ¨¡å—ä¸­ï¼šå¦‚æœç›®æ ‡å¯¹è±¡å®ç°äº†æ¥å£ï¼Œåˆ™é»˜è®¤é‡‡ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¦åˆ™é‡‡ç”¨ CGLIB åŠ¨æ€ä»£ç†**ã€‚

æ¥çœ‹ CGLIB åŠ¨æ€ä»£ç†çš„ä½¿ç”¨æ­¥éª¤ï¼š

1ï¼‰é¦–å…ˆåˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰

2ï¼‰åˆ›å»ºä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨å®ç°æ¥å£ `MethodInterceptor`ï¼Œå¹¶é‡å†™ `intercept` æ–¹æ³•ã€‚`intercept` ç”¨äºæ‹¦æˆªå¹¶å¢å¼ºå§”æ‰˜ç±»çš„æ–¹æ³•ï¼ˆå’Œ JDK åŠ¨æ€ä»£ç† `InvocationHandler` ä¸­çš„ `invoke` æ–¹æ³•ç±»ä¼¼ï¼‰

![image-20220723003232098](images/image-20220723003232098.png)

è¯¥æ–¹æ³•æ‹¥æœ‰å››ä¸ªå‚æ•°ï¼š

- Object var1ï¼šå§”æ‰˜ç±»å¯¹è±¡
- Method var2ï¼šè¢«æ‹¦æˆªçš„æ–¹æ³•ï¼ˆå§”æ‰˜ç±»ä¸­éœ€è¦å¢å¼ºçš„æ–¹æ³•ï¼‰
- Object[] var3ï¼šæ–¹æ³•å…¥å‚
- MethodProxy var4ï¼šç”¨äºè°ƒç”¨å§”æ‰˜ç±»çš„åŸå§‹æ–¹æ³•ï¼ˆåº•å±‚ä¹Ÿæ˜¯é€šè¿‡åå°„æœºåˆ¶ï¼Œä¸è¿‡ä¸æ˜¯ `Method.invoke` äº†ï¼Œè€Œæ˜¯ä½¿ç”¨ `MethodProxy.invokeSuper` æ–¹æ³•ï¼‰

![image-20220723003242424](images/image-20220723003242424.png)

3ï¼‰åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ï¼šé€šè¿‡ `Enhancer.create()` åˆ›å»ºå§”æ‰˜ç±»å¯¹è±¡çš„ä»£ç†å¯¹è±¡

![image-20220723003250555](images/image-20220723003250555.png)

ä¹Ÿå°±æ˜¯è¯´ï¼šæˆ‘ä»¬åœ¨é€šè¿‡ `Enhancer` ç±»çš„ `create()` åˆ›å»ºçš„ä»£ç†å¯¹è±¡åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…ä¼šè°ƒç”¨åˆ°å®ç°äº† `MethodInterceptor` æ¥å£çš„å¤„ç†ç±»çš„ `intercept()`æ–¹æ³•ï¼Œå¯ä»¥åœ¨ `intercept()` æ–¹æ³•ä¸­è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ååšä»€ä¹ˆäº‹æƒ…ã€‚

> å¯ä»¥å‘ç°ï¼ŒCGLIB åŠ¨æ€ä»£ç†æœºåˆ¶å’Œ JDK åŠ¨æ€ä»£ç†æœºåˆ¶çš„æ­¥éª¤å·®ä¸å¤šï¼ŒCGLIB åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒæ˜¯æ–¹æ³•æ‹¦æˆªå™¨ `MethodInterceptor` å’Œ `Enhancer`ï¼Œè€Œ JDK åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒæ˜¯å¤„ç†ç±» `InvocationHandler` å’Œ `Proxy`ã€‚

ä¸åŒäº JDK åŠ¨æ€ä»£ç†ä¸éœ€è¦é¢å¤–çš„ä¾èµ–ã€‚CGLIB æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå¦‚æœä½ è¦ä½¿ç”¨å®ƒçš„è¯ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ç›¸å…³ä¾èµ–ã€‚

```xml
<dependency>
  <groupId>cglib</groupId>
  <artifactId>cglib</artifactId>
  <version>3.3.0</version>
</dependency>
```

1ï¼‰é¦–å…ˆåˆ›å»ºä¸€ä¸ªå§”æ‰˜ç±»ï¼ˆReal Subjectï¼‰

```java
public class AliSmsService {
    public String send(String message) {
        System.out.println("send message:" + message);
        return message;
    }
}
```

2ï¼‰åˆ›å»ºä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨å®ç°æ¥å£ `MethodInterceptor`ï¼Œå¹¶é‡å†™ `intercept` æ–¹æ³•

```java
import net.sf.cglib.proxy.MethodInterceptor;
import net.sf.cglib.proxy.MethodProxy;
import java.lang.reflect.Method;

public class DebugMethodInterceptor implements MethodInterceptor {

    @Override
    public Object intercept(Object o, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {
        // è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("before method " + method.getName());
        // é€šè¿‡åå°„è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•
        Object object = methodProxy.invokeSuper(o, args);
        // è°ƒç”¨æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("after method " + method.getName());
        return object;
    }

}
```

3ï¼‰åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ï¼šé€šè¿‡ `Enhancer.create()` åˆ›å»ºå§”æ‰˜ç±»å¯¹è±¡çš„ä»£ç†å¯¹è±¡

```java
import net.sf.cglib.proxy.Enhancer;

public class CglibProxyFactory {
    public static Object getProxy(Class<?> clazz) {
        // åˆ›å»ºåŠ¨æ€ä»£ç†å¢å¼ºç±»
        Enhancer enhancer = new Enhancer();
        // è®¾ç½®ç±»åŠ è½½å™¨
        enhancer.setClassLoader(clazz.getClassLoader());
        // è®¾ç½®å§”æ‰˜ç±»ï¼ˆè®¾ç½®çˆ¶ç±»ï¼‰
        enhancer.setSuperclass(clazz);
        // è®¾ç½®æ–¹æ³•æ‹¦æˆªå™¨
        enhancer.setCallback(new DebugMethodInterceptor());
        // åˆ›å»ºä»£ç†ç±»
        return enhancer.create();
    }
}
```

> ä» `setSuperclass` æˆ‘ä»¬å°±èƒ½çœ‹å‡ºï¼Œä¸ºä»€ä¹ˆè¯´ CGLIB æ˜¯åŸºäºç»§æ‰¿çš„ã€‚

4ï¼‰å®é™…ä½¿ç”¨

```java
AliSmsService aliSmsService = 
    (AliSmsService) CglibProxyFactory.getProxy(AliSmsService.class);
aliSmsService.send("Java");
```

è¿è¡Œä¸Šè¿°ä»£ç ä¹‹åï¼Œæ§åˆ¶å°æ‰“å°å‡ºï¼š

```bash
before method send
send message:Java
after method send
```

#### JDK åŠ¨æ€ä»£ç†å’Œ CGLIB åŠ¨æ€ä»£ç†å¯¹æ¯”

1ï¼‰JDK åŠ¨æ€ä»£ç†æ˜¯åŸºäºå®ç°äº†æ¥å£çš„å§”æ‰˜ç±»ï¼Œé€šè¿‡æ¥å£å®ç°ä»£ç†ï¼›è€Œ CGLIB åŠ¨æ€ä»£ç†æ˜¯åŸºäºç»§æ‰¿äº†å§”æ‰˜ç±»çš„å­ç±»ï¼Œé€šè¿‡å­ç±»å®ç°ä»£ç†ã€‚

2ï¼‰JDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»ï¼Œä¸”åªèƒ½å¢å¼ºæ¥å£ä¸­ç°æœ‰çš„æ–¹æ³•ï¼›è€Œ CGLIB å¯ä»¥ä»£ç†æœªå®ç°ä»»ä½•æ¥å£çš„ç±»ã€‚

3ï¼‰å°±äºŒè€…çš„æ•ˆç‡æ¥è¯´ï¼Œå¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯ JDK åŠ¨æ€ä»£ç†çš„æ•ˆç‡æ›´é«˜ï¼Œéšç€ JDK ç‰ˆæœ¬çš„å‡çº§ï¼Œè¿™ä¸ªä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚

> æä¸€å˜´ï¼Œå¸¸è§çš„è¿˜æœ‰ **Javassist åŠ¨æ€ä»£ç†æœºåˆ¶**ã€‚å’Œ CGLIB ä¸€æ ·ï¼Œä½œä¸ºä¸€ä¸ª Java å­—èŠ‚ç ç”Ÿæˆæ¡†æ¶ï¼ŒJavassist å¤©ç”Ÿå°±æ‹¥æœ‰åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»çš„èƒ½åŠ›ï¼Œå®ç°åŠ¨æ€ä»£ç†è‡ªç„¶ä¸åœ¨è¯ä¸‹ã€‚ Dubbo å°±æ˜¯é»˜è®¤ä½¿ç”¨ Javassit æ¥è¿›è¡ŒåŠ¨æ€ä»£ç†çš„ã€‚

#### é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†å¯¹æ¯”

1. **çµæ´»æ€§** ï¼šåŠ¨æ€ä»£ç†æ›´åŠ çµæ´»ï¼Œä¸éœ€è¦å¿…é¡»å®ç°æ¥å£ï¼Œå¯ä»¥ç›´æ¥ä»£ç†å®ç°ç±»ï¼Œå¹¶ä¸”å¯ä»¥ä¸éœ€è¦é’ˆå¯¹æ¯ä¸ªç›®æ ‡ç±»éƒ½åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ã€‚å¦å¤–ï¼Œé™æ€ä»£ç†ä¸­ï¼Œæ¥å£ä¸€æ—¦æ–°å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ˜¯éå¸¸éº»çƒ¦çš„
2. **JVM å±‚é¢** ï¼šé™æ€ä»£ç†åœ¨ç¼–è¯‘æ—¶å°±å°†æ¥å£ã€å®ç°ç±»ã€ä»£ç†ç±»è¿™äº›éƒ½å˜æˆäº†ä¸€ä¸ªä¸ªå®é™…çš„ `.class` å­—èŠ‚ç æ–‡ä»¶ã€‚è€ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆç±»å­—èŠ‚ç ï¼Œå¹¶åŠ è½½åˆ° JVM ä¸­çš„ã€‚

#### ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨åŠ¨æ€ä»£ç†

1. è®¾è®¡æ¨¡å¼ä¸­æœ‰ä¸€ä¸ªè®¾è®¡åŸåˆ™æ˜¯**å¼€é—­åŸåˆ™**ï¼Œå³**å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾**ï¼Œæˆ‘ä»¬åœ¨å·¥ä½œä¸­æœ‰æ—¶ä¼šæ¥æ‰‹å¾ˆå¤šå‰äººçš„ä»£ç ï¼Œé‡Œé¢ä»£ç é€»è¾‘è®©äººæ‘¸ä¸ç€å¤´è„‘ï¼Œå°±å¾ˆéš¾å»ä¸‹æ‰‹ä¿®æ”¹ä»£ç ï¼Œé‚£ä¹ˆè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»£ç†å¯¹ç±»è¿›è¡Œå¢å¼ºã€‚
2. æˆ‘ä»¬åœ¨ä½¿ç”¨ **RPC æ¡†æ¶**çš„æ—¶å€™ï¼Œæ¡†æ¶æœ¬èº«å¹¶ä¸èƒ½æå‰çŸ¥é“å„ä¸ªä¸šåŠ¡æ–¹è¦è°ƒç”¨å“ªäº›æ¥å£çš„å“ªäº›æ–¹æ³• ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå°±å¯ç”¨é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼æ¥å»ºç«‹ä¸€ä¸ªä¸­é—´äººç»™å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œä¹Ÿæ–¹ä¾¿æ¡†æ¶è¿›è¡Œæ­å»ºé€»è¾‘ï¼ŒæŸç§ç¨‹åº¦ä¸Šä¹Ÿæ˜¯å®¢æˆ·ç«¯ä»£ç å’Œæ¡†æ¶æ¾è€¦åˆçš„ä¸€ç§è¡¨ç°ã€‚
3. **Spring çš„ AOP** æœºåˆ¶åŒæ ·ä¹Ÿæ˜¯é‡‡ç”¨äº†åŠ¨æ€ä»£ç†ï¼Œæ­¤å¤„ä¸åšè¯¦ç»†è®¨è®ºã€‚

#### æ€»ç»“

å…¨éƒ¨æ‹ä¸€éä¸‹æ¥è¿˜æ˜¯æ”¶è·è›®å¤šçš„ï¼Œæˆ‘æ„Ÿè§‰åªè¦ç†è§£äº†å­—èŠ‚ç åœ¨ç¼–è¯‘æœŸç”Ÿæˆè¿˜æ˜¯åœ¨è¿è¡ŒæœŸç”Ÿæˆï¼Œå°±å·®ä¸å¤šèƒ½å¤ŸæŠŠæ¡ä½é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†äº†ã€‚æ€»ç»“ä¸€ä¸‹é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¸­çš„è§’è‰²ï¼š

é™æ€ä»£ç†ï¼š

- Subjectï¼šå…¬å…±æ¥å£
- Real Subjectï¼šå§”æ‰˜ç±»
- Proxyï¼šä»£ç†ç±»

JDK åŠ¨æ€ä»£ç†ï¼š

- Subjectï¼šå…¬å…±æ¥å£
- Real Subjectï¼šå§”æ‰˜ç±»
- Proxyï¼šä»£ç†ç±»
- **InvocationHandler**ï¼šå¤„ç†ç±»ï¼Œç»Ÿä¸€è°ƒç”¨æ–¹æ³•

CGLIB åŠ¨æ€ä»£ç†ï¼š

- Subjectï¼šå…¬å…±æ¥å£
- Real Subjectï¼šå§”æ‰˜ç±»
- Proxyï¼šä»£ç†ç±»
- **MethodInterceptor**ï¼šæ–¹æ³•æ‹¦æˆªå™¨ï¼Œç»Ÿä¸€è°ƒç”¨æ–¹æ³•



### static{}é™æ€ä»£ç å—ä¸{}éé™æ€ä»£ç å—(æ„é€ ä»£ç å—)

**ç›¸åŒç‚¹**ï¼š éƒ½æ˜¯åœ¨ JVM åŠ è½½ç±»æ—¶ä¸”åœ¨æ„é€ æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œï¼Œåœ¨ç±»ä¸­éƒ½å¯ä»¥å®šä¹‰å¤šä¸ªï¼Œå®šä¹‰å¤šä¸ªæ—¶æŒ‰å®šä¹‰çš„é¡ºåºæ‰§è¡Œï¼Œä¸€èˆ¬åœ¨ä»£ç å—ä¸­å¯¹ä¸€äº› static å˜é‡è¿›è¡Œèµ‹å€¼ã€‚

**ä¸åŒç‚¹**ï¼š é™æ€ä»£ç å—åœ¨éé™æ€ä»£ç å—ä¹‹å‰æ‰§è¡Œ(é™æ€ä»£ç å— -> éé™æ€ä»£ç å— -> æ„é€ æ–¹æ³•)ã€‚é™æ€ä»£ç å—åªåœ¨ç¬¬ä¸€æ¬¡ new  æ‰§è¡Œä¸€æ¬¡ï¼Œä¹‹åä¸å†æ‰§è¡Œï¼Œè€Œéé™æ€ä»£ç å—åœ¨æ¯ new ä¸€æ¬¡å°±æ‰§è¡Œä¸€æ¬¡ã€‚ éé™æ€ä»£ç å—å¯åœ¨æ™®é€šæ–¹æ³•ä¸­å®šä¹‰(ä¸è¿‡ä½œç”¨ä¸å¤§)ï¼›è€Œé™æ€ä»£ç å—ä¸è¡Œã€‚

> ğŸ› **ä¿®æ­£**ï¼šé™æ€ä»£ç å—å¯èƒ½åœ¨ç¬¬ä¸€æ¬¡ new å¯¹è±¡çš„æ—¶å€™æ‰§è¡Œï¼Œä½†ä¸ä¸€å®šåªåœ¨ç¬¬ä¸€æ¬¡ new çš„æ—¶å€™æ‰§è¡Œã€‚æ¯”å¦‚é€šè¿‡ `Class.forName("ClassDemo")`åˆ›å»º Class å¯¹è±¡çš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡Œï¼Œå³ new æˆ–è€… `Class.forName("ClassDemo")` éƒ½ä¼šæ‰§è¡Œé™æ€ä»£ç å—ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹,å¦‚æœæœ‰äº›ä»£ç æ¯”å¦‚ä¸€äº›é¡¹ç›®æœ€å¸¸ç”¨çš„å˜é‡æˆ–å¯¹è±¡å¿…é¡»åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™å°±æ‰§è¡Œçš„æ—¶å€™,éœ€è¦ä½¿ç”¨é™æ€ä»£ç å—,è¿™ç§ä»£ç æ˜¯ä¸»åŠ¨æ‰§è¡Œçš„ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦è®¾è®¡ä¸éœ€è¦åˆ›å»ºå¯¹è±¡å°±å¯ä»¥è°ƒç”¨ç±»ä¸­çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š`Arrays` ç±»ï¼Œ`Character` ç±»ï¼Œ`String` ç±»ç­‰ï¼Œå°±éœ€è¦ä½¿ç”¨é™æ€æ–¹æ³•, ä¸¤è€…çš„åŒºåˆ«æ˜¯ é™æ€ä»£ç å—æ˜¯è‡ªåŠ¨æ‰§è¡Œçš„è€Œé™æ€æ–¹æ³•æ˜¯è¢«è°ƒç”¨çš„æ—¶å€™æ‰æ‰§è¡Œçš„.

Exampleï¼š

```java
public class Test {
    public Test() {
        System.out.print("é»˜è®¤æ„é€ æ–¹æ³•ï¼--");
    }
    //éé™æ€ä»£ç å—
    {
        System.out.print("éé™æ€ä»£ç å—ï¼--");
    }
    //é™æ€ä»£ç å—
    static {
        System.out.print("é™æ€ä»£ç å—ï¼--");
    }
    private static void test() {
        System.out.print("é™æ€æ–¹æ³•ä¸­çš„å†…å®¹! --");
        {
            System.out.print("é™æ€æ–¹æ³•ä¸­çš„ä»£ç å—ï¼--");
        }
    }
    public static void main(String[] args) {
        Test test = new Test();
        Test.test();//é™æ€ä»£ç å—ï¼--é™æ€æ–¹æ³•ä¸­çš„å†…å®¹! --é™æ€æ–¹æ³•ä¸­çš„ä»£ç å—ï¼--
    }
}
```

ä¸Šè¿°ä»£ç è¾“å‡ºï¼š

```text
é™æ€ä»£ç å—ï¼--éé™æ€ä»£ç å—ï¼--é»˜è®¤æ„é€ æ–¹æ³•ï¼--é™æ€æ–¹æ³•ä¸­çš„å†…å®¹! --é™æ€æ–¹æ³•ä¸­çš„ä»£ç å—ï¼--
```

å½“åªæ‰§è¡Œ `Test.test();` æ—¶è¾“å‡ºï¼š

```text
é™æ€ä»£ç å—ï¼--é™æ€æ–¹æ³•ä¸­çš„å†…å®¹! --é™æ€æ–¹æ³•ä¸­çš„ä»£ç å—ï¼--
```

å½“åªæ‰§è¡Œ `Test test = new Test();` æ—¶è¾“å‡ºï¼š

```text
é™æ€ä»£ç å—ï¼--éé™æ€ä»£ç å—ï¼--é»˜è®¤æ„é€ æ–¹æ³•ï¼--
```

éé™æ€ä»£ç å—ä¸æ„é€ å‡½æ•°çš„åŒºåˆ«æ˜¯ï¼š  éé™æ€ä»£ç å—æ˜¯ç»™æ‰€æœ‰å¯¹è±¡è¿›è¡Œç»Ÿä¸€åˆå§‹åŒ–ï¼Œè€Œæ„é€ å‡½æ•°æ˜¯ç»™å¯¹åº”çš„å¯¹è±¡åˆå§‹åŒ–ï¼Œå› ä¸ºæ„é€ å‡½æ•°æ˜¯å¯ä»¥å¤šä¸ªçš„ï¼Œè¿è¡Œå“ªä¸ªæ„é€ å‡½æ•°å°±ä¼šå»ºç«‹ä»€ä¹ˆæ ·çš„å¯¹è±¡ï¼Œä½†æ— è®ºå»ºç«‹å“ªä¸ªå¯¹è±¡ï¼Œéƒ½ä¼šå…ˆæ‰§è¡Œç›¸åŒçš„æ„é€ ä»£ç å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ„é€ ä»£ç å—ä¸­å®šä¹‰çš„æ˜¯ä¸åŒå¯¹è±¡å…±æ€§çš„åˆå§‹åŒ–å†…å®¹ã€‚

### charå‹å˜é‡ä¸­èƒ½å¦èƒ½ä¸èƒ½å­˜å‚¨â¼€ä¸ªä¸­â½‚æ±‰å­—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

charå¯ä»¥å­˜å‚¨â¼€ä¸ªä¸­â½‚æ±‰å­—ï¼Œå› ä¸ºJavaä¸­ä½¿â½¤çš„ç¼–ç æ˜¯Unicode(ä¸é€‰æ‹©ä»»ä½•ç‰¹å®šçš„ç¼–ç ï¼Œç›´æ¥ä½¿â½¤å­—ç¬¦åœ¨å­—ç¬¦é›†ä¸­çš„ç¼–å·ï¼Œè¿™æ˜¯ç»Ÿâ¼€çš„å”¯â¼€â½…æ³•ï¼‰ï¼Œâ¼€ä¸ªcharç±»å‹å 2ä¸ªå­—èŠ‚ï¼ˆ16â½ç‰¹ï¼‰ï¼Œæ‰€ä»¥æ”¾â¼€ä¸ªä¸­â½‚æ˜¯æ²¡é—®é¢˜çš„ã€‚

### æ˜¯å¦å¯ä»¥ç»§æ‰¿Stringç±»ï¼Ÿ

Stringç±»æ˜¯finalç±»ï¼Œä¸å¯ä»¥è¢«ç»§æ‰¿ã€‚

è¡¥å……ï¼šç»§æ‰¿Stringæœ¬èº«å°±æ˜¯â¼€ä¸ªé”™è¯¯çš„â¾ä¸ºï¼Œå¯¹Stringç±»å‹æœ€å¥½çš„é‡â½¤â½…å¼æ˜¯å…³è”å…³ç³»ï¼ˆHas-Aï¼‰å’Œä¾èµ–å…³ç³»ï¼ˆUse-Aï¼‰â½½ä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼ˆIs-Aï¼‰ã€‚

### è°ˆè°ˆä½ å¯¹å¤šæ€çš„ç†è§£ï¼Ÿ

å¤šæ€çš„æ¦‚å¿µå¹¶ä¸éš¾ï¼Œå¹¶ä¸”åœ¨å®é™…ç¼–ç ä¸­å¯ä»¥è¯´æ˜¯æœ€æœ€é«˜é¢‘ä½¿ç”¨ç‡ã€‚å¤šæ€å°±æ˜¯**ä½¿å¾—åŒä¸€ä¸ªè¡Œä¸ºå…·æœ‰å¤šä¸ªä¸åŒè¡¨ç°å½¢å¼æˆ–å½¢æ€çš„èƒ½åŠ›**ã€‚ä¸¾ä¸ªå½¢è±¡ç‚¹çš„ä¾‹å­ï¼šå¯¹äº â€œæ‰“å°â€ è¿™ä¸ªè¡Œä¸ºï¼Œä½¿ç”¨å½©è‰²æ‰“å°æœº â€œæ‰“å°â€ å‡ºæ¥çš„æ•ˆæœå°±æ˜¯å½©è‰²çš„ï¼Œè€Œä½¿ç”¨é»‘ç™½æ‰“å°æœº â€œæ‰“å°â€ å‡ºæ¥çš„æ•ˆæœå°±æ˜¯é»‘ç™½çš„ã€‚æˆ‘ä»¬å°±ç§° â€œæ‰“å°â€ è¿™ä¸ªè¡Œä¸ºæ˜¯å¤šæ€çš„ï¼Œå½©è‰²æ‰“å°æ•ˆæœå’Œé»‘ç™½æ‰“å°æ•ˆæœå°±æ˜¯ â€œæ‰“å°â€ è¿™ä¸ªè¡Œä¸ºçš„ä¸¤ä¸ªä¸åŒçš„è¡¨ç°å½¢å¼ã€‚

![image-20220618172157050](./images/image-20220618172157050.png)

è¿˜å¯ä»¥è¿™æ ·ç†è§£ï¼Œ**åŒä¸€ä¸ªè¡Œä¸ºåœ¨ä¸åŒçš„å¯¹è±¡ä¸Šä¼šäº§ç”Ÿä¸åŒçš„ç»“æœ**ã€‚å†ä¸¾ä¸ªå½¢è±¡ç‚¹çš„ä¾‹å­ï¼šæ¯”å¦‚æˆ‘ä»¬æŒ‰ä¸‹ F1 é”®è¿™ä¸ªè¡Œä¸ºï¼šå¦‚æœå½“å‰åœ¨ Word ä¸‹å¼¹å‡ºçš„å°±æ˜¯ Word å¸®åŠ©å’Œæ”¯æŒï¼›åœ¨ Windows ä¸‹å¼¹å‡ºçš„å°±æ˜¯ Windows å¸®åŠ©å’Œæ”¯æŒã€‚

#### å¤šæ€å‘ç”Ÿçš„ä¸‰ä¸ªå¿…è¦æ¡ä»¶

å…ˆçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåŸºç±» `Shape`ï¼Œä¸‰ä¸ªå­ç±»ï¼Œå¹¶ä¸”éƒ½é‡å†™äº†åŸºç±»çš„ `draw` æ–¹æ³•ï¼š

```java
class Shape {
    void draw() {}
}
 
class Circle extends Shape {
    void draw() {
        System.out.println("Circle.draw()");
    }
}
 
class Square extends Shape {
    void draw() {
        System.out.println("Square.draw()");
    }
}
 
class Triangle extends Shape {
    void draw() {
        System.out.println("Triangle.draw()");
    }
}
```

ä¸‹é¢è¿™å‡ è¡Œä»£ç å°±å……åˆ†ä½“ç°äº†å¤šæ€æ€§ï¼š

```java
Shape circle = new Circle();
Shape square = new Square();
Shape triangle = new Triangle();
```

å¤§å®¶åº”è¯¥ä¸ä¼šå¤ªé™Œç”Ÿï¼Œå°±æ˜¯**å‘ä¸Šè½¬å‹**ï¼Œæ²¡é”™ï¼Œå®ƒå°±æ˜¯å¤šæ€çš„ä½“ç°ã€‚åŒæ ·çš„ä¸€ä¸ª draw æ–¹æ³•ï¼Œåœ¨è¿™ä¸‰ä¸ªä¸åŒçš„å¯¹è±¡ä¸Šäº§ç”Ÿäº†ä¸‰ç§ä¸åŒçš„è¡Œä¸ºï¼Œå¤šæ€åœ¨æ­¤ä½“ç°çš„æ·‹æ¼“å°½è‡´ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½¿ç”¨å¤šæ€æ–¹å¼è°ƒç”¨æ–¹æ³•æ—¶ï¼Œç¼–è¯‘å™¨ä¼šé¦–å…ˆæ£€æŸ¥çˆ¶ç±»ä¸­æ˜¯å¦æœ‰è¯¥æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ç¼–è¯‘é”™è¯¯ï¼›å¦‚æœçˆ¶ç±»ä¸­æœ‰è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”è¢«å­ç±»é‡å†™ï¼Œå°±ä¼šè°ƒç”¨å­ç±»çš„è¿™ä¸ªæ–¹æ³•ï¼›å¦‚æœçˆ¶ç±»çš„æ–¹æ³•æ²¡æœ‰è¢«å­ç±»é‡å†™ï¼Œå°±ä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•ã€‚

```java
Shape circle = new Circle();
circle.draw(); // è°ƒç”¨çš„æ˜¯ Circle çš„ eat
```

ç®€å•æ¥è¯´ï¼š**å½“çˆ¶ç±»å¼•ç”¨å˜é‡æŒ‡å‘å­ç±»å¯¹è±¡åï¼ˆå¤šæ€ï¼‰ï¼Œåªèƒ½ä½¿ç”¨çˆ¶ç±»å·²å£°æ˜çš„æ–¹æ³•ï¼Œä½†æ–¹æ³•å¦‚æœè¢«é‡å†™ä¼šæ‰§è¡Œå­ç±»çš„æ–¹æ³•ï¼Œå¦‚æœæ–¹æ³•æœªè¢«é‡å†™é‚£ä¹ˆå°†æ‰§è¡Œçˆ¶ç±»çš„æ–¹æ³•**ã€‚

ç»“åˆä¸Šè¿°è¿™æ®µç®€å•çš„ä»£ç ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹å¤šæ€äº§ç”Ÿçš„å¿…è¦æ¡ä»¶ï¼š

- 1ï¼‰ç»§æ‰¿
- 2ï¼‰é‡å†™
- 3ï¼‰çˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡ï¼š`Parent p = new Child();`

![image-20220618172217768](./images/image-20220618172217768.png)

#### å¤šæ€æ˜¯å¦‚ä½•å‘ç”Ÿçš„

â“ é‚£ä¹ˆï¼Œå¤šæ€åˆ°åº•æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿç¼–è¯‘å™¨æ˜¯å¦‚ä½•çŸ¥é“çˆ¶ç±» Shape å¼•ç”¨æŒ‡å‘çš„æ˜¯ Circle è€Œä¸æ˜¯ Triangle æˆ– Square å‘¢ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„æ¦‚å¿µã€‚ä»€ä¹ˆæ˜¯**ç»‘å®š**ï¼Ÿå°†ä¸€ä¸ªæ–¹æ³•è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ä¸»ä½“å…³è”èµ·æ¥çš„è¿‡ç¨‹å°±ç§°ä½œç»‘å®šã€‚

è‹¥ç»‘å®šå‘ç”Ÿåœ¨ç¨‹åºè¿è¡Œå‰ï¼Œå«åš**é™æ€ç»‘å®š**ï¼Œä¹Ÿç§°**å‰æœŸç»‘å®š**ã€‚ä½ å¯èƒ½ä»æ¥æ²¡æœ‰å¬è¯´è¿™ä¸ªæœ¯è¯­ï¼Œå› ä¸ºå®ƒæ˜¯**é¢å‘è¿‡ç¨‹**è¯­è¨€ä¸éœ€é€‰æ‹©é»˜è®¤çš„ç»‘å®šæ–¹å¼ï¼Œä¾‹å¦‚åœ¨ C è¯­è¨€ä¸­å°±åªæœ‰å‰æœŸç»‘å®šè¿™ä¸€ç§æ–¹æ³•è°ƒç”¨ã€‚

é‚£ä¹ˆå¯¹äºè¿™æ®µä»£ç ï¼š

```java
Shape circle = new Circle();
Shape square = new Square();
circle.draw(); 
```

Shape å³å¼•ç”¨ç±»å‹åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸ä¼šè¢«æ”¹å˜ï¼Œè€Œ Circle ä½œä¸ºå®ä¾‹å¯¹è±¡ç±»å‹åœ¨è¿è¡ŒæœŸæ‰å¯çŸ¥ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥å¦‚æœä½¿ç”¨å‰æœŸç»‘å®šï¼Œåœ¨è¿è¡Œä¹‹å‰ï¼Œç¼–è¯‘å™¨åªçŸ¥é“æœ‰ä¸€ä¸ª Shape å¼•ç”¨ï¼Œå®ƒæ— æ³•å¾—çŸ¥ç©¶ç«Ÿä¼šè°ƒç”¨å“ªä¸ªæ–¹æ³•ã€‚

è§£å†³æ–¹æ³•å°±æ˜¯**åŠ¨æ€ç»‘å®š** Dynamic Bindingï¼Œåœ¨è¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„ç±»å‹è‡ªåŠ¨çš„è¿›è¡Œç»‘å®šï¼Œæ‰€ä»¥åŠ¨æ€ç»‘å®šä¹Ÿç§°**è¿è¡Œæ—¶ç»‘å®š**ã€‚åŠ¨æ€ç»‘å®šæ˜¯å¤šæ€çš„åŸºç¡€ã€‚

æ³¨æ„ï¼šJava ä¸­é™¤äº† `static`å’Œ `final`æ–¹æ³•ï¼ˆ`private`æ–¹æ³•å±äº `final`æ–¹æ³•ï¼‰ä¹‹å¤–ï¼Œå…¶ä»–æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯åŠ¨æ€ç»‘å®šã€‚è¿™æ„å‘³ç€é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦åˆ¤æ–­åŠ¨æ€ç»‘å®šæ˜¯å¦ä¼šå‘ç”Ÿï¼Œå®ƒæ˜¯è‡ªåŠ¨å‘ç”Ÿçš„ã€‚

> `final` å’Œ `static` å…³é”®å­—åç»­ä¼šå•ç‹¬å‡ºæ–‡ç« è®²è§£ï¼Œæ­¤å¤„å°±ç¬¼ç»Ÿçš„æ¦‚è¿°ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªå…³é”®å­—ä¿®é¥°çš„æ–¹æ³•æ˜¯é™æ€ç»‘å®šçš„ï¼š
>
> - `final` ä¸å…è®¸æ–¹æ³•é‡å†™ï¼Œè€Œå¤šæ€å‘ç”Ÿçš„æ¡ä»¶ä¹‹ä¸€å°±æ˜¯é‡å†™ï¼Œæ‰€ä»¥ `final` æ–¹æ³•ä¼šåœ¨ç¼–è¯‘æœŸé—´å°±è¿›è¡Œç»‘å®šï¼Œå³é™æ€ç»‘å®š
> - `static` æ–¹æ³•æ˜¯ç±»ç›´æ¥æ‹¥æœ‰çš„çš„ï¼Œä¸è¯¥ç±»çš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡éƒ½æ— å…³ï¼ˆè¯¥ç±»çš„æ‰€æœ‰å¯¹è±¡å…±åŒç»´æŠ¤ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯é™æ€ç»‘å®š

#### é‡è½½å’Œé‡å†™

é‡è½½å’Œé‡å†™åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­éƒ½è¯´è¿‡äº†ï¼Œæ­¤å¤„æ­£å¥½å€Ÿç€å¤šæ€è¿™ä¸ªä¸»é¢˜å°†è¿™ä¸¤ä¸ªå®¹æ˜“æ··æ·†çš„æ¦‚å¿µæ€»ç»“ä¸€æ³¢ã€‚

æ–¹æ³•çš„**é‡å†™ Overriding** å’Œ**é‡è½½ Overloading** éƒ½æ˜¯æ˜¯ Java å¤šæ€æ€§çš„è¡¨ç°ã€‚

ğŸ”¸ 1ï¼‰**æ–¹æ³•é‡å†™æ˜¯çˆ¶ç±»ä¸å­ç±»ä¹‹é—´å¤šæ€æ€§çš„è¡¨ç°**ã€‚å…¶å­ç±»å’Œçˆ¶ç±»æ–¹æ³•çš„åå­—ç›¸åŒï¼Œå‚æ•°ä¸ªæ•°ç›¸åŒï¼Œè¿”å›ç±»å‹ä¹Ÿç›¸åŒï¼Œå¹¶ä¸”å­ç±»çš„è®¿é—®æƒé™ä¸èƒ½æ¯”çˆ¶ç±»çš„ä¸¥æ ¼ï¼Œæ¯”å¦‚çˆ¶ç±»æ˜¯ publicï¼Œé‚£ä¹ˆå­ç±»ä¹Ÿåªèƒ½æ˜¯ publicï¼Œä¸èƒ½æ¯” public æ›´ä¸¥æ ¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**æ–¹æ³•é‡å†™ï¼Œåªæœ‰æ–¹æ³•ä½“æ˜¯ä¸ä¸€æ ·çš„ï¼Œè®¿é—®æƒé™å¯ä»¥æœ‰é™åˆ¶çš„ä¿®æ”¹**ã€‚

```java
class Shape {
    public void draw() {}
}
 
class Circle extends Shape {
    public void draw() {
        System.out.println("Circle.draw()");
    }
}
```

ğŸš¨ å…¶å®ï¼Œä¸Šé¢è¯´çš„è¿”å›ç±»å‹å®Œå…¨ç›¸åŒå¹¶ä¸ä¸¥æ ¼æ­£ç¡®ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“**æ–¹æ³•çš„åå­—å’Œå‚æ•°åˆ—è¡¨ç§°ä¸ºæ–¹æ³•çš„ç­¾å**ã€‚ä¾‹å¦‚ï¼Œ`draw()`  å’Œ  `draw(String)` æ˜¯ä¸¤ä¸ªå…·æœ‰ç›¸åŒåå­—ï¼Œ ä¸åŒç­¾åçš„æ–¹æ³•ã€‚å¦‚æœåœ¨å­ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªä¸è¶…ç±»ç­¾åç›¸åŒçš„æ–¹æ³•ï¼Œ é‚£ä¹ˆå­ç±»ä¸­çš„è¿™ä¸ªæ–¹æ³•å°±è¦†ç›–/é‡å†™äº†è¶…ç±»ä¸­çš„è¿™ä¸ªç›¸åŒç­¾åçš„æ–¹æ³•ã€‚

ä¸è¿‡ï¼Œ**è¿”å›ç±»å‹ä¸æ˜¯ç­¾åçš„ä¸€éƒ¨åˆ†**ï¼Œ å› æ­¤ï¼Œåœ¨è¦†ç›–/é‡å†™æ–¹æ³•æ—¶ï¼Œ ä¸€å®šè¦ä¿è¯è¿”å›ç±»çš„å…¼å®¹æ€§ã€‚ **å…è®¸å­ç±»å°†è¦†ç›–æ–¹æ³•çš„è¿”å›ç±»å‹å®šä¹‰ä¸ºåŸè¿”å›ç±»å‹çš„å­ç±»å‹**ã€‚

ä¾‹å¦‚ï¼Œ å‡è®¾ `Shape` ç±»æœ‰

```java
class Shape {
    public Shape draw() {
    	......
    }
}
```

åœ¨åé¢çš„å­ç±» `Circle` ä¸­ï¼Œ å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ‰€ç¤ºçš„æ–¹å¼è¦†ç›–è¿™ä¸ªæ–¹æ³•

```java
class Circle extends Shape {
    public Circle draw() {
        ......
    }
}
```

ç”¨ä¸“ä¸šæœ¯è¯­æ¥è¯´ï¼Œè¿™ä¸¤ä¸ª `draw` æ–¹æ³•å…·æœ‰**å¯åå˜çš„è¿”å›ç±»å‹**ã€‚

ğŸ”¸ 2ï¼‰æ–¹æ³•é‡è½½å¹¶éå¤šæ€çš„å¿…è¦æ¡ä»¶ï¼Œä¸è¿‡å¯ä»¥ç†è§£æˆ**æŸä¸ªç±»çš„å¤šæ€æ€§çš„è¡¨ç°**ã€‚æ‰€è°“æ–¹æ³•é‡è½½ï¼Œå°±æ˜¯ä¸€ä¸ªç±»ä¸­å®šä¹‰äº†å¤šä¸ªæ–¹æ³•åç›¸åŒï¼Œä½†æ˜¯å‚æ•°çš„æ•°é‡æˆ–è€…ç±»å‹ä¸åŒã€‚æ–¹æ³•çš„è¿”å›ç±»å‹å’Œè®¿é—®æƒé™å¯ä»¥ä»»æ„ä¿®æ”¹ï¼Œä¸ä»¥å®ƒä¿©ä½œä¸ºæ–¹æ³•é‡è½½çš„æ ‡å¿—ã€‚

```java
class Circle extends Shape {
    public void draw() {
        System.out.println("Circle.draw()");
    }
  
    public void draw(int i) {
        System.out.println("Circle.draw()" + i);
    }
}
```

![image-20220618172249142](./images/image-20220618172249142.png)

æ€»ç»“ä¸€ä¸‹æ–¹æ³•é‡è½½å’Œé‡å†™ï¼š

|            | æ–¹æ³•é‡è½½ |                      æ–¹æ³•é‡å†™                      |
| :--------: | :------: | :------------------------------------------------: |
|   æ–¹æ³•å   |   ç›¸åŒ   |                        ç›¸åŒ                        |
|  å‚æ•°åˆ—è¡¨  | å¿…é¡»ä¸åŒ |                      å¿…é¡»ç›¸åŒ                      |
|  è¿”å›ç±»å‹  | å¯ä»¥ä¸åŒ | å­ç±»æ–¹æ³•çš„è¿”å›ç±»å‹å¯ä»¥æ˜¯åŸçˆ¶ç±»æ–¹æ³•è¿”å›ç±»å‹çš„å­ç±»å‹ |
| è®¿é—®ä¿®é¥°ç¬¦ | å¯ä»¥ä¸åŒ |       å­ç±»ä¸èƒ½åšæ›´ä¸¥æ ¼çš„é™åˆ¶ï¼ˆå¯ä»¥é™ä½é™åˆ¶ï¼‰       |

#### main æ–¹æ³•æ˜¯å¦å¯ä»¥é‡è½½

IBM æ—©äº›å¹´å‡ºè¿‡è¿™æ–¹é¢çš„é¢˜ï¼Œè€ƒå€’äº†ä¸€ç‰‡äººã€‚é¦–å…ˆï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œmain æ—¢ç„¶ä½œä¸ºä¸€ä¸ªæ–¹æ³•ï¼Œé‚£å®ƒå½“ç„¶å¯ä»¥è¢«é‡è½½ã€‚

ä½†æ˜¯ï¼Œ**å¦‚æœæ˜¯ä½œä¸ºç¨‹åºçš„å…¥å£ï¼Œé‚£ä¹ˆ main å‡½æ•°åªæœ‰ä¸€ç§å†™æ³•ï¼ŒJava è™šæ‹Ÿæœºåœ¨è¿è¡Œçš„æ—¶å€™åªä¼šè°ƒç”¨å¸¦æœ‰å‚æ•°æ˜¯ String æ•°ç»„çš„é‚£ä¸ª `main()` æ–¹æ³•**ï¼Œè€Œå…¶ä»–é‡è½½çš„å†™æ³•è™šæ‹Ÿæœºæ˜¯ä¸è®¤çš„ï¼Œåªèƒ½äººä¸ºçš„è°ƒç”¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```java
class Test {
	public static void main(String[] args) {
		main(1);
	}
	public static void main(int i) {
		System.out.println("é‡è½½çš„ main æ–¹æ³•");
	}
}
```

è¯¥ç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```text
é‡è½½çš„ main æ–¹æ³•
```

å¯ä»¥çœ‹å‡ºç¬¬ä¸€ä¸ª main æ–¹æ³•æ­£å¸¸è°ƒç”¨äº†é‡è½½çš„ç¬¬äºŒä¸ª main æ–¹æ³•ï¼Œå³ main æ–¹æ³•èƒ½å¤Ÿè¢«å®Œç¾é‡è½½ã€‚ä½†æ˜¯ç¨‹åºçš„å…¥å£ä»ç„¶æ˜¯ç¬¬ä¸€ä¸ª main æ–¹æ³•å³å‚æ•°ä¸º String æ•°ç»„ã€‚

![image-20220618172317736](./images/image-20220618172317736.png)

### æ„é€ å™¨ï¼ˆconstructorï¼‰æ˜¯å¦å¯è¢«é‡å†™ï¼ˆoverrideï¼‰ï¼Ÿ

æ„é€ å™¨ä¸èƒ½è¢«ç»§æ‰¿ï¼Œå› æ­¤ä¸èƒ½è¢«é‡å†™ï¼Œä½†å¯ä»¥è¢«é‡è½½

### Java ä¸­æ“ä½œå­—ç¬¦ä¸²éƒ½æœ‰å“ªäº›ç±»ï¼Ÿå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

æ“ä½œå­—ç¬¦ä¸²çš„ç±»æœ‰ï¼š**Stringã€StringBufferã€StringBuilder**ã€‚

ç¬¬ä¸€ç‚¹: å¯å˜å’Œé€‚ç”¨èŒƒå›´ã€‚Stringå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œè€ŒStringBufferå’ŒStringBuilderæ˜¯å¯å˜å­—ç¬¦åºåˆ—ã€‚æ¯æ¬¡å¯¹Stringçš„æ“ä½œç›¸å½“äºç”Ÿæˆä¸€ä¸ªæ–°çš„Stringå¯¹è±¡ï¼Œè€Œå¯¹StringBufferå’ŒStringBuilderçš„æ“ä½œæ˜¯å¯¹å¯¹è±¡æœ¬èº«çš„æ“ä½œï¼Œè€Œä¸ä¼šç”Ÿæˆæ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹äºé¢‘ç¹æ”¹å˜å†…å®¹çš„å­—ç¬¦ä¸²é¿å…ä½¿ç”¨Stringï¼Œå› ä¸ºé¢‘ç¹çš„ç”Ÿæˆå¯¹è±¡å°†ä¼šå¯¹ç³»ç»Ÿæ€§èƒ½äº§ç”Ÿå½±å“ã€‚

ç¬¬äºŒç‚¹: çº¿ç¨‹å®‰å…¨ã€‚Stringç”±äºæœ‰finalä¿®é¥°ï¼Œæ˜¯immutableçš„ï¼Œå®‰å…¨æ€§æ˜¯ç®€å•è€Œçº¯ç²¹çš„ã€‚StringBuilderå’ŒStringBufferçš„åŒºåˆ«åœ¨äºStringBuilderä¸ä¿è¯åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœéœ€è¦çº¿ç¨‹å®‰å…¨éœ€è¦ä½¿ç”¨StringBufferï¼Œä¸éœ€è¦åŒæ­¥çš„StringBuilderæ•ˆç‡æ›´é«˜

|              | å¯å˜æ€§ | çº¿ç¨‹å®‰å…¨                                                                                                                             |
| :-----------: | :----: | ------------------------------------------------------------------------------------------------------------------------------------ |
|    String    | ä¸å¯å˜ | å› ä¸ºä¸å¯å˜ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„                                                                                                         |
| StringBuffer |  å¯å˜  | çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå…¶å†…éƒ¨å¤§å¤šæ•°æ–¹æ³•éƒ½ä½¿ç”¨ `synchronized`è¿›è¡ŒåŒæ­¥ã€‚å…¶æ•ˆç‡è¾ƒä½                                                          |
| StringBuilder |  å¯å˜  | ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºæ²¡æœ‰ä½¿ç”¨ `synchronized`è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¹Ÿæ˜¯å…¶æ•ˆç‡é«˜äº StringBuffer  çš„åŸå› ã€‚å•çº¿ç¨‹ä¸‹ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ StringBuilderã€‚ |

### String str = "i" å’ŒString str = new String("1")â¼€æ ·å—ï¼Ÿ

ä¸â¼€æ ·ï¼Œå› ä¸ºå†…å­˜çš„åˆ†é…â½…å¼ä¸â¼€æ ·ã€‚String str="i"çš„â½…å¼ï¼ŒJVMä¼šå°†å…¶åˆ†é…åˆ°å¸¸é‡æ± ä¸­ï¼›â½½String str=new String("i")ï¼ŒJVMä¼šå°†å…¶åˆ†é…åˆ°å †å†…å­˜ä¸­ã€‚

### ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ååºåˆ—åŒ–?

å¦‚æœæˆ‘ä»¬éœ€è¦æŒä¹…åŒ– Java å¯¹è±¡æ¯”å¦‚å°† Java å¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç½‘ç»œä¼ è¾“ Java å¯¹è±¡ï¼Œè¿™äº›åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ã€‚

ç®€å•æ¥è¯´ï¼š

- **åºåˆ—åŒ–**ï¼š å°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹
- **ååºåˆ—åŒ–**ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµè½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹

å¯¹äº Java è¿™ç§é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€æ¥è¯´ï¼Œæˆ‘ä»¬åºåˆ—åŒ–çš„éƒ½æ˜¯å¯¹è±¡ï¼ˆObjectï¼‰ä¹Ÿå°±æ˜¯å®ä¾‹åŒ–åçš„ç±»(Class)ï¼Œä½†æ˜¯åœ¨ C++è¿™ç§åŠé¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ï¼Œstruct(ç»“æ„ä½“)å®šä¹‰çš„æ˜¯æ•°æ®ç»“æ„ç±»å‹ï¼Œè€Œ class å¯¹åº”çš„æ˜¯å¯¹è±¡ç±»å‹ã€‚

ç»´åŸºç™¾ç§‘æ˜¯å¦‚æ˜¯ä»‹ç»åºåˆ—åŒ–çš„ï¼š

> **åºåˆ—åŒ–**ï¼ˆserializationï¼‰åœ¨è®¡ç®—æœºç§‘å­¦çš„æ•°æ®å¤„ç†ä¸­ï¼Œæ˜¯æŒ‡å°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡çŠ¶æ€è½¬æ¢æˆå¯å–ç”¨æ ¼å¼ï¼ˆä¾‹å¦‚å­˜æˆæ–‡ä»¶ï¼Œå­˜äºç¼“å†²ï¼Œæˆ–ç»ç”±ç½‘ç»œä¸­å‘é€ï¼‰ï¼Œä»¥ç•™å¾…åç»­åœ¨ç›¸åŒæˆ–å¦ä¸€å°è®¡ç®—æœºç¯å¢ƒä¸­ï¼Œèƒ½æ¢å¤åŸå…ˆçŠ¶æ€çš„è¿‡ç¨‹ã€‚ä¾ç…§åºåˆ—åŒ–æ ¼å¼é‡æ–°è·å–å­—èŠ‚çš„ç»“æœæ—¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥äº§ç”Ÿä¸åŸå§‹å¯¹è±¡ç›¸åŒè¯­ä¹‰çš„å‰¯æœ¬ã€‚å¯¹äºè®¸å¤šå¯¹è±¡ï¼Œåƒæ˜¯ä½¿ç”¨å¤§é‡å¼•ç”¨çš„å¤æ‚å¯¹è±¡ï¼Œè¿™ç§åºåˆ—åŒ–é‡å»ºçš„è¿‡ç¨‹å¹¶ä¸å®¹æ˜“ã€‚é¢å‘å¯¹è±¡ä¸­çš„å¯¹è±¡åºåˆ—åŒ–ï¼Œå¹¶ä¸æ¦‚æ‹¬ä¹‹å‰åŸå§‹å¯¹è±¡æ‰€å…³ç³»çš„å‡½æ•°ã€‚è¿™ç§è¿‡ç¨‹ä¹Ÿç§°ä¸ºå¯¹è±¡ç¼–ç»„ï¼ˆmarshallingï¼‰ã€‚ä»ä¸€ç³»åˆ—å­—èŠ‚æå–æ•°æ®ç»“æ„çš„åå‘æ“ä½œï¼Œæ˜¯ååºåˆ—åŒ–ï¼ˆä¹Ÿç§°ä¸ºè§£ç¼–ç»„ã€deserializationã€unmarshallingï¼‰ã€‚

ç»¼ä¸Šï¼š**åºåˆ—åŒ–çš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡ç½‘ç»œä¼ è¾“å¯¹è±¡æˆ–è€…è¯´æ˜¯å°†å¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“ã€å†…å­˜ä¸­ã€‚**

![image-20220620170922943](./images/image-20220620170922943.png)

### final finally finalizeçš„åŒºåˆ«

* finalå¯ä»¥ä¿®é¥°ç±»ã€å˜é‡ã€â½…æ³•ï¼Œä¿®é¥°ç±»è¡¨ç¤ºè¯¥ç±»ä¸èƒ½è¢«ç»§æ‰¿ã€ä¿®é¥°â½…æ³•è¡¨ç¤ºè¯¥â½…æ³•ä¸èƒ½è¢«é‡å†™ã€ä¿®é¥°å˜é‡è¡¨ç¤ºè¯¥å˜é‡æ˜¯â¼€ä¸ªå¸¸é‡ä¸èƒ½è¢«é‡æ–°èµ‹å€¼ã€‚
* finallyâ¼€èˆ¬ä½œâ½¤åœ¨try-catchä»£ç å—ä¸­ï¼Œåœ¨å¤„ç†å¼‚å¸¸çš„æ—¶å€™ï¼Œé€šå¸¸æˆ‘ä»¬å°†â¼€å®šè¦æ‰§â¾çš„ä»£ç â½…æ³•finallyä»£ç å—ä¸­ï¼Œè¡¨ç¤ºä¸ç®¡æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œè¯¥ä»£ç å—éƒ½ä¼šæ‰§â¾ï¼Œâ¼€èˆ¬â½¤æ¥å­˜æ”¾â¼€äº›å…³é—­èµ„æºçš„ä»£ç ã€‚

> âš ï¸ç‰¹æ®Šæƒ…å†µï¼šå½“finallyä¸­åŒ…å«return
>
> ![image-20220619143704353](./images/image-20220619143704353.png)

* finalizeæ˜¯â¼€ä¸ªâ½…æ³•ï¼Œå±äºObjectç±»çš„â¼€ä¸ªâ½…æ³•ï¼Œâ½½Objectç±»æ˜¯æ‰€æœ‰ç±»çš„â½—ç±»ï¼Œè¯¥â½…æ³•â¼€èˆ¬ç”±åƒåœ¾å›æ”¶å™¨æ¥è°ƒâ½¤ï¼Œå½“æˆ‘ä»¬è°ƒâ½¤System.gc()â½…æ³•çš„æ—¶å€™ï¼Œç”±åƒåœ¾å›æ”¶å™¨è°ƒâ½¤finalize()ï¼Œå›æ”¶åƒåœ¾ï¼Œâ¼€ä¸ªå¯¹è±¡æ˜¯å¦å¯å›æ”¶çš„æœ€ååˆ¤æ–­ã€‚

> âš ï¸æ³¨ï¼š
>
> - Java è¯­è¨€æä¾›äº†å¯¹è±¡ç»ˆæ­¢ï¼ˆfinalizationï¼‰æœºåˆ¶æ¥å…è®¸å¼€å‘äººå‘˜æä¾›å¯¹è±¡è¢«é”€æ¯ä¹‹å‰çš„è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚
> - å½“åƒåœ¾å›æ”¶å™¨å‘ç°æ²¡æœ‰å¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå³ï¼šåƒåœ¾å›æ”¶æ­¤å¯¹è±¡ä¹‹å‰ï¼Œæ€»ä¼šå…ˆè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ `finalize( )` æ–¹æ³•ã€‚
> - `finalize( )` æ–¹æ³•å…è®¸åœ¨å­ç±»ä¸­è¢«é‡å†™ï¼Œç”¨äºåœ¨å¯¹è±¡è¢«å›æ”¶æ—¶è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾å’Œæ¸…ç†çš„å·¥ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶ã€å¥—æ¥å­—å’Œæ•°æ®åº“è¿æ¥ç­‰ã€‚
> - **æ°¸è¿œä¸è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå¯¹è±¡çš„ finalize ( ) æ–¹æ³•ï¼Œåº”è¯¥äº¤ç»™åƒåœ¾å›æ”¶æœºåˆ¶è°ƒç”¨**ã€‚ç†ç”±åŒ…æ‹¬ä¸‹é¢ä¸‰ç‚¹ï¼š
>   - åœ¨ `finalize( )` æ‰§è¡Œæ—¶å¯èƒ½ä¼šå¯¼è‡´å¯¹è±¡å¤æ´»ã€‚
>   - `finalize( )` æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´æ˜¯æ²¡æœ‰ä¿éšœçš„ï¼Œå®ƒå®Œå…¨ç”± GC çº¿ç¨‹å†³å®šï¼Œæç«¯æƒ…å†µä¸‹ï¼Œè‹¥ä¸å‘ç”Ÿ GCï¼Œåˆ™ `finalize( )` æ–¹æ³•å°†æ²¡æœ‰æ‰§è¡Œæœºä¼šã€‚
>   - ä¸€ä¸ªç³Ÿç³•çš„ `finalize( )` ä¼šä¸¥é‡å½±å“ GC çš„æ€§èƒ½ã€‚
> - ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œ`finalize( )` æ–¹æ³•ä¸ C++ ä¸­çš„ææ„å‡½æ•°æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ˜¯ Java é‡‡ç”¨çš„æ˜¯åŸºäºåƒåœ¾å›æ”¶å™¨çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥ `finalize( )` æ–¹æ³•åœ¨æœ¬è´¨ä¸Šä¸åŒäº C++ ä¸­çš„ææ„å‡½æ•°ã€‚
> - ç”±äº `finalize( )` æ–¹æ³•çš„å­˜åœ¨ï¼Œè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ä¸€èˆ¬å¤„äºä¸‰ç§å¯èƒ½çš„çŠ¶æ€

### â­Javaæœ‰å“ªäº›æ•°æ®ç±»å‹

* ğŸ”¢ æ•°å€¼ï¼šbyteï¼Œshortï¼Œintï¼Œlong
* ğŸ§¿ æµ®ç‚¹ï¼šfloatï¼Œdouble
* ğŸ”£ å­—ç¬¦ï¼šchar
* â˜‘ï¸ å¸ƒå°”ï¼šboolean

è¿™å…«ç§åŸºæœ¬ç±»å‹éƒ½æœ‰å¯¹åº”çš„åŒ…è£…ç±»åˆ†åˆ«ä¸ºï¼šByteã€Shortã€Integerã€Longã€Floatã€Doubleã€Characterã€Boolean

#### åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»å‹çš„åŒºåˆ«ï¼Ÿ

- åŒ…è£…ç±»å‹ä¸èµ‹å€¼å°±æ˜¯ `null` ï¼Œè€ŒåŸºæœ¬ç±»å‹æœ‰é»˜è®¤å€¼ä¸”ä¸æ˜¯ `null`ã€‚
- åŒ…è£…ç±»å‹å¯ç”¨äºæ³›å‹ï¼Œè€ŒåŸºæœ¬ç±»å‹ä¸å¯ä»¥ã€‚
- åŸºæœ¬æ•°æ®ç±»å‹çš„å±€éƒ¨å˜é‡å­˜æ”¾åœ¨ Java è™šæ‹Ÿæœºæ ˆä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹çš„æˆå‘˜å˜é‡ï¼ˆæœªè¢« `static` ä¿®é¥° ï¼‰å­˜æ”¾åœ¨ Java è™šæ‹Ÿæœºçš„å †ä¸­ã€‚åŒ…è£…ç±»å‹å±äºå¯¹è±¡ç±»å‹ï¼Œæˆ‘ä»¬çŸ¥é“å‡ ä¹æ‰€æœ‰å¯¹è±¡å®ä¾‹éƒ½å­˜åœ¨äºå †ä¸­ã€‚
- ç›¸æ¯”äºå¯¹è±¡ç±»å‹ï¼Œ åŸºæœ¬æ•°æ®ç±»å‹å ç”¨çš„ç©ºé—´éå¸¸å°ã€‚

**ä¸ºä»€ä¹ˆè¯´æ˜¯å‡ ä¹æ‰€æœ‰å¯¹è±¡å®ä¾‹å‘¢ï¼Ÿ** è¿™æ˜¯å› ä¸º HotSpot è™šæ‹Ÿæœºå¼•å…¥äº† JIT ä¼˜åŒ–ä¹‹åï¼Œä¼šå¯¹å¯¹è±¡è¿›è¡Œé€ƒé€¸åˆ†æï¼Œå¦‚æœå‘ç°æŸä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸åˆ°æ–¹æ³•å¤–éƒ¨ï¼Œé‚£ä¹ˆå°±å¯èƒ½é€šè¿‡æ ‡é‡æ›¿æ¢æ¥å®ç°æ ˆä¸Šåˆ†é…ï¼Œè€Œé¿å…å †ä¸Šåˆ†é…å†…å­˜

âš ï¸æ³¨æ„ ï¼š **åŸºæœ¬æ•°æ®ç±»å‹å­˜æ”¾åœ¨æ ˆä¸­æ˜¯ä¸€ä¸ªå¸¸è§çš„è¯¯åŒºï¼** åŸºæœ¬æ•°æ®ç±»å‹çš„æˆå‘˜å˜é‡å¦‚æœæ²¡æœ‰è¢« `static` ä¿®é¥°çš„è¯ï¼ˆä¸å»ºè®®è¿™ä¹ˆä½¿ç”¨ï¼Œåº”è¯¥è¦ä½¿ç”¨åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åŒ…è£…ç±»å‹ï¼‰ï¼Œå°±å­˜æ”¾åœ¨å †ä¸­ã€‚

```java
class BasicTypeVar{
  private int x;
}
```

#### åŒ…è£…ç±»å‹çš„ç¼“å­˜æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

Java åŸºæœ¬æ•°æ®ç±»å‹çš„åŒ…è£…ç±»å‹çš„å¤§éƒ¨åˆ†éƒ½ç”¨åˆ°äº†ç¼“å­˜æœºåˆ¶æ¥æå‡æ€§èƒ½ã€‚

`Byte`,`Short`,`Integer`,`Long` è¿™ 4 ç§åŒ…è£…ç±»é»˜è®¤åˆ›å»ºäº†æ•°å€¼ **[-128ï¼Œ127]** çš„ç›¸åº”ç±»å‹çš„ç¼“å­˜æ•°æ®ï¼Œ`Character` åˆ›å»ºäº†æ•°å€¼åœ¨ **[0,127]** èŒƒå›´çš„ç¼“å­˜æ•°æ®ï¼Œ`Boolean` ç›´æ¥è¿”å› `True` or `False`ã€‚

#### â­ï¸å ç”¨çš„ç©ºé—´å¤§å°

ğŸ‘¨â€ğŸ’»é¢è¯•å®˜ ï¼š å®ƒä»¬çš„é»˜è®¤å€¼å’Œå ç”¨çš„ç©ºé—´å¤§å°çŸ¥é“ä¸ï¼Ÿ

ğŸ™‹ æˆ‘ ï¼šè¿™ 8 ç§åŸºæœ¬æ•°æ®ç±»å‹çš„é»˜è®¤å€¼ä»¥åŠæ‰€å ç©ºé—´çš„å¤§å°å¦‚ä¸‹ï¼š

| åŸºæœ¬ç±»å‹ | ä½æ•° | å­—èŠ‚ | é»˜è®¤å€¼  |
| -------- | ---- | ---- | ------- |
| int      | 32   | 4    | 0       |
| short    | 16   | 2    | 0       |
| long     | 64   | 8    | 0L      |
| byte     | 8    | 1    | 0       |
| char     | 16   | 2    | 'u0000' |
| float    | 32   | 4    | 0f      |
| double   | 64   | 8    | 0d      |
| boolean  | 1    |      | false   |

å¦å¤–ï¼Œå¯¹äº booleanï¼Œå®˜æ–¹æ–‡æ¡£æœªæ˜ç¡®å®šä¹‰ï¼Œå®ƒä¾èµ–äº JVM å‚å•†çš„å…·ä½“å®ç°ã€‚é€»è¾‘ä¸Šç†è§£æ˜¯å ç”¨ 1 ä½ï¼Œä½†æ˜¯å®é™…ä¸­ä¼šè€ƒè™‘è®¡ç®—æœºé«˜æ•ˆå­˜å‚¨å› ç´ ã€‚



#### Java ä¸­ boolean å å¤šå°‘å­—èŠ‚ï¼Ÿ

Oracle å®˜æ–¹æ–‡æ¡£åœ°å€åœ¨æ­¤ï¼šhttps://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html

![img](images/image-20220706230119388.png)

æ€»å…± 8 å¤§åŸºç¡€æ•°æ®ç±»å‹ï¼Œå…¶ä½™ 7 ä¸ªéƒ½éå¸¸æ˜ç¡®çš„æ ‡æ˜äº†å ç”¨å¤šå°‘å­—èŠ‚ï¼Œåªæœ‰ boolean æ¨¡æ£±ä¸¤å¯ï¼š

> **boolean**: The `boolean` data type has only two possible values: `true` and `false`. Use this data type for simple flags that track true/false conditions. This data type represents one bit of information, but its "size" isn't something that's precisely defined.

ç¿»è¯‘ä¸‹åˆ’çº¿éƒ¨åˆ†ï¼šè¿™ä¸ªæ•°æ®ç±»å‹è¡¨ç¤º 1 bit çš„ä¿¡æ¯ï¼ˆtrue or falseï¼Œç¼–è¯‘åç”¨ 0 æˆ– 1 æ¥è¡¨ç¤ºï¼‰ï¼Œä½†æ˜¯å®ƒçš„ size å¹¶æ²¡æœ‰è¢«ç²¾ç¡®åœ°å®šä¹‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸ç®¡å®ƒå å¤šå¤§çš„ç©ºé—´ï¼Œåªæœ‰ 1 ä¸ª bit çš„ä¿¡æ¯æ˜¯æœ‰æ„ä¹‰çš„ã€‚**

äº‹å®ä¸Šï¼Œboolean åˆ°åº•å ç”¨å¤šå°‘å¤§å°çš„ç©ºé—´ï¼Œâ€œIt's virtual machine dependent.â€ï¼Œ**å®Œå…¨å–å†³äº Java è™šæ‹Ÿæœºæœ¬èº«çš„è®¾è®¡**ã€‚

ä¸è¿‡æ˜¾ç„¶ boolean æ˜¯è‚¯å®šä¸å¯èƒ½åªå ç”¨ 1 ä¸ª bit çš„ï¼Œæœ€èµ·ç ä¹Ÿæ˜¯ 1 ä¸ª Bytesï¼ˆå­—èŠ‚ï¼‰ï¼Œå› ä¸ºè®¡ç®—æœºå¤„ç†æ•°æ®çš„æœ€å°å•ä½æ˜¯ 1 ä¸ªå­—èŠ‚

ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹äº boolean åˆ°åº•å ç”¨å¤šå°‘ç©ºé—´æä¾›äº†ä¸€å®šçš„å»ºè®®ï¼ˆåªæ˜¯å»ºè®®ï¼Œå…·ä½“çš„å®ç°ä»ç„¶å–å†³äºæ¯ä¸ªè™šæ‹Ÿæœºæ˜¯å¦æŒ‰ç…§è§„èŒƒæ¥ï¼‰ï¼Œå®˜æ–¹æ–‡æ¡£åœ¨è¿™é‡Œï¼šhttps://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.3.4

> Although the Java Virtual Machine defines a `boolean` type, it only provides very limited support for it. There are no Java Virtual Machine instructions solely dedicated to operations on `boolean` values. Instead, expressions in the Java programming language that operate on `boolean` values are compiled to use values of the Java Virtual Machine `int` data type.

å°½ç®¡ Java è™šæ‹Ÿæœºå®šä¹‰äº†ä¸€ä¸ªå¸ƒå°”ç±»å‹ï¼Œä½†æ˜¯å®ƒåªæä¾›äº†éå¸¸æœ‰é™çš„æ”¯æŒï¼Œ**å¹¶ã€æ²¡æœ‰ã€‘ä¸“é—¨ç”¨äºå¯¹ã€boolean å€¼ã€‘è¿›è¡Œæ“ä½œçš„ Java è™šæ‹ŸæœºæŒ‡ä»¤**ã€‚ç›¸åï¼Œ**Java ä¸­æ“ä½œ boolean å€¼çš„è¡¨è¾¾å¼è¢«ç¼–è¯‘ä¸ºä½¿ç”¨ int æ•°æ®ç±»å‹çš„å€¼**ã€‚

> The Java Virtual Machine does directly support `boolean` arrays. Its `newarray` instruction (`newarray`) enables creation of `boolean` arrays. Arrays of type `boolean` are accessed and modified using the `byte` array instructions `baload` and `bastore`.

ä¸è¿‡ï¼Œ**Java è™šæ‹Ÿæœºã€ç›´æ¥æ”¯æŒã€‘ã€boolean æ•°ç»„ã€‘**ï¼Œé€šè¿‡ `newarray` æŒ‡ä»¤åˆ›å»º boolean æ•°ç»„ï¼Œç„¶åé€šè¿‡ byte æ•°ç»„æŒ‡ä»¤ `baload` å’Œ `bastore` æ¥è®¿é—®å’Œä¿®æ”¹ boolean æ•°ç»„ã€‚

- `newarray` æŒ‡ä»¤ï¼šCreate new array
- `baload` æŒ‡ä»¤ï¼šLoad `byte` or `boolean` from array
- `bastore` æŒ‡ä»¤ï¼šStore into `byte` or `boolean` array

> In Oracleâ€™s Java Virtual Machine implementation, `boolean` arrays in the Java programming language are encoded as Java Virtual Machine `byte` arrays, using 8 bits per `boolean` element.

**åœ¨ Oracle çš„ Java è™šæ‹Ÿæœºå®ç°ä¸­ï¼ŒJava ä¸­çš„ boolean æ•°ç»„è¢«ç¼–ç ä¸º byte æ•°ç»„ï¼Œæ¯ä¸ª boolean å…ƒç´ ä½¿ç”¨ 1 å­—èŠ‚ï¼ˆ8 bitï¼‰**ã€‚

æ€»ç»“ä¸‹ï¼ŒJava è™šæ‹Ÿæœºè§„èŒƒæè®®ï¼š

- å¦‚æœ boolean æ˜¯ â€œå•ç‹¬ä½¿ç”¨â€ï¼šboolean è¢«ç¼–è¯‘ä¸º int ç±»å‹ï¼Œå  **4** ä¸ªå­—èŠ‚
- å¦‚æœboolean æ˜¯ä»¥ â€œboolean æ•°ç»„â€ çš„å½¢å¼ä½¿ç”¨ï¼šboolean å  **1** ä¸ªå­—èŠ‚ï¼ŒJava è™šæ‹Ÿæœºç›´æ¥æ”¯æŒ boolean æ•°ç»„ï¼Œé€šè¿‡ `newarray` æŒ‡ä»¤åˆ›å»º boolean æ•°ç»„ï¼Œç„¶åé€šè¿‡ byte æ•°ç»„æŒ‡ä»¤ `baload` å’Œ `bastore` æ¥è®¿é—®å’Œä¿®æ”¹ boolean æ•°ç»„



### float f=3.4;æ˜¯å¦æ­£ç¡®ï¼Ÿ

ä¸æ­£ç¡®ï¼Œèµ‹å€¼è¿ç®—ç¬¦ "=" å·¦å³ä¸¤è¾¹çš„ç²¾åº¦ç±»å‹ä¸åŒ¹é…ã€‚

Javaä¸­ï¼Œæœ‰å°æ•°ç‚¹çš„é»˜è®¤è¢«å­˜å‚¨ä¸ºdoubleç±»å‹ï¼Œå³åŒç²¾åº¦ï¼›è€Œfloatç±»å‹çš„å˜é‡ä¸ºå•ç²¾åº¦ã€‚

å¯ä»¥ä½¿ç”¨å¼ºè½¬æˆ–åŠ fï¼Œå³ float f = (folat)3.4ï¼Œfloat f = 3.4fã€‚

æµ‹è¯•ï¼š

```java
public static void main(String[] args) {
    float f = 3.14222222222222222222222;
    double d = 3.4;
    System.out.println(f);
    System.out.println(d);
}
-------------------------------------------
1.java:3: é”™è¯¯: ä¸å…¼å®¹çš„ç±»å‹: ä»doubleè½¬æ¢åˆ°floatå¯èƒ½ä¼šæœ‰æŸå¤±
float f = 3.14222222222222222222222;
      ^
1 ä¸ªé”™è¯¯
```

> æ‹“å±•ï¼šInteger a = 1000ï¼ŒInteger b = 1000ï¼Œa==b çš„ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿé‚£å¦‚æœ aï¼Œb éƒ½ä¸º1ï¼Œç»“æœåˆæ˜¯ä»€ä¹ˆï¼Ÿ

Integer a = 1000ï¼ŒInteger b = 1000ï¼Œa==b ç»“æœä¸º**false**

Integer a = 1ï¼ŒInteger b = 1ï¼Œa==b ç»“æœä¸º**true**

è¿™é“é¢˜ä¸»è¦è€ƒå¯Ÿ Integer åŒ…è£…ç±»ç¼“å­˜çš„èŒƒå›´,**åœ¨-128~127ä¹‹é—´ä¼šç¼“å­˜èµ·æ¥**,æ¯”è¾ƒçš„æ˜¯ç›´æ¥ç¼“å­˜çš„æ•°æ®,åœ¨æ­¤ä¹‹å¤–æ¯”è¾ƒçš„æ˜¯å¯¹è±¡

### æˆå‘˜å˜é‡ä¸å±€éƒ¨å˜é‡çš„åŒºåˆ«æœ‰å“ªäº›ï¼Ÿ

1. ä»**è¯­æ³•å½¢å¼ä¸Š**çœ‹:æˆå‘˜å˜é‡æ˜¯å±äºç±»çš„ï¼Œè€Œå±€éƒ¨å˜é‡æ˜¯åœ¨æ–¹æ³•ä¸­å®šä¹‰çš„å˜é‡æˆ–æ˜¯æ–¹æ³•çš„å‚æ•°ï¼›æˆå‘˜å˜é‡å¯ä»¥è¢«public,private,staticç­‰ä¿®é¥°ç¬¦æ‰€ä¿®é¥°ï¼Œè€Œ**å±€éƒ¨å˜é‡ä¸èƒ½è¢«è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦åŠstaticæ‰€ä¿®é¥°**ï¼›ä½†æ˜¯ï¼Œæˆå‘˜å˜é‡å’Œå±€éƒ¨å˜é‡éƒ½èƒ½è¢«finalæ‰€ä¿®é¥°ã€‚
2. ä»å˜é‡**åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼**æ¥çœ‹:å¦‚æœæˆå‘˜å˜é‡æ˜¯ä½¿ç”¨staticä¿®é¥°çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæˆå‘˜å˜é‡æ˜¯å±äºç±»çš„ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨staticä¿®é¥°ï¼Œè¿™ä¸ªæˆå‘˜å˜é‡æ˜¯å±äºå®ä¾‹çš„ã€‚å¯¹è±¡å­˜äºå †å†…å­˜ï¼Œå¦‚æœå±€éƒ¨å˜é‡ç±»å‹ä¸ºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆå­˜å‚¨åœ¨æ ˆå†…å­˜ï¼Œå¦‚æœä¸ºå¼•ç”¨æ•°æ®ç±»å‹ï¼Œé‚£å­˜æ”¾çš„æ˜¯æŒ‡å‘å †å†…å­˜å¯¹è±¡çš„å¼•ç”¨æˆ–è€…æ˜¯æŒ‡å‘å¸¸é‡æ± ä¸­çš„åœ°å€ã€‚
3. ä»å˜é‡åœ¨**å†…å­˜ä¸­çš„ç”Ÿå­˜æ—¶é—´ä¸Š**çœ‹:æˆå‘˜å˜é‡æ˜¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒéšç€å¯¹è±¡çš„åˆ›å»ºè€Œå­˜åœ¨ï¼Œè€Œå±€éƒ¨å˜é‡éšç€æ–¹æ³•çš„è°ƒç”¨è€Œè‡ªåŠ¨æ¶ˆå¤±ã€‚
4. æˆå‘˜å˜é‡**å¦‚æœæ²¡æœ‰è¢«èµ‹åˆå€¼**:åˆ™ä¼šè‡ªåŠ¨ä»¥ç±»å‹çš„é»˜è®¤å€¼è€Œèµ‹å€¼ï¼ˆä¸€ç§æƒ…å†µä¾‹å¤–:è¢«finalä¿®é¥°çš„æˆå‘˜å˜é‡ä¹Ÿå¿…é¡»æ˜¾å¼åœ°èµ‹å€¼ï¼‰ï¼Œè€Œ**å±€éƒ¨å˜é‡åˆ™ä¸ä¼šè‡ªåŠ¨èµ‹å€¼**ã€‚

### â­æ¥å£å’ŒæŠ½è±¡ç±»çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

1. æ¥å£çš„æ–¹æ³•é»˜è®¤æ˜¯publicï¼Œæ‰€æœ‰æ–¹æ³•åœ¨æ¥å£ä¸­ä¸èƒ½æœ‰å®ç°(Java8å¼€å§‹æ¥å£æ–¹æ³•å¯ä»¥æœ‰é»˜è®¤å®ç°ï¼‰ï¼Œè€ŒæŠ½è±¡ç±»å¯ä»¥æœ‰éæŠ½è±¡çš„æ–¹æ³•ã€‚
2. æ¥å£ä¸­é™¤äº†staticã€finalå˜é‡ï¼Œä¸èƒ½æœ‰å…¶ä»–å˜é‡ï¼Œè€ŒæŠ½è±¡ç±»ä¸­åˆ™ä¸ä¸€å®šã€‚
3. ä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œä½†åªèƒ½å®ç°ä¸€ä¸ªæŠ½è±¡ç±»ã€‚æ¥å£è‡ªå·±æœ¬èº«å¯ä»¥é€šè¿‡extendså…³é”®å­—æ‰©å±•å¤šä¸ªæ¥å£ã€‚
4. æ¥å£æ–¹æ³•é»˜è®¤ä¿®é¥°ç¬¦æ˜¯publicï¼ŒæŠ½è±¡æ–¹æ³•å¯ä»¥æœ‰publicã€protectedå’Œdefaultè¿™äº›ä¿®é¥°ç¬¦ï¼ˆæŠ½è±¡æ–¹æ³•å°±æ˜¯ä¸ºäº†è¢«é‡å†™æ‰€ä»¥ä¸èƒ½ä½¿ç”¨privateå…³é”®å­—ä¿®é¥°ï¼ï¼‰ã€‚
5. ä»è®¾è®¡å±‚é¢æ¥è¯´ï¼ŒæŠ½è±¡æ˜¯å¯¹ç±»çš„æŠ½è±¡ï¼Œæ˜¯ä¸€ç§æ¨¡æ¿è®¾è®¡ï¼Œè€Œæ¥å£æ˜¯å¯¹è¡Œä¸ºçš„æŠ½è±¡ï¼Œæ˜¯ä¸€ç§è¡Œä¸ºçš„è§„èŒƒã€‚

### ğŸŒ Java æ³›å‹äº†è§£ä¹ˆï¼Ÿæ³›å‹çš„ä½œç”¨ï¼Ÿä»€ä¹ˆæ˜¯ç±»å‹æ“¦é™¤ï¼Ÿ

**Java æ³›å‹ï¼ˆGenericsï¼‰** æ˜¯ JDK 5 ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°ç‰¹æ€§ã€‚ä½¿ç”¨æ³›å‹å‚æ•°ï¼Œå¯ä»¥å¢å¼ºä»£ç çš„å¯è¯»æ€§ä»¥åŠç¨³å®šæ€§ã€‚

ç¼–è¯‘å™¨å¯ä»¥å¯¹æ³›å‹å‚æ•°è¿›è¡Œæ£€æµ‹ï¼Œå¹¶ä¸”é€šè¿‡æ³›å‹å‚æ•°å¯ä»¥æŒ‡å®šä¼ å…¥çš„å¯¹è±¡ç±»å‹ã€‚æ¯”å¦‚ `ArrayList<Persion> persons = new ArrayList<Persion>()` è¿™è¡Œä»£ç å°±æŒ‡æ˜äº†è¯¥ `ArrayList` å¯¹è±¡åªèƒ½ä¼ å…¥ `Persion` å¯¹è±¡ï¼Œå¦‚æœä¼ å…¥å…¶ä»–ç±»å‹çš„å¯¹è±¡å°±ä¼šæŠ¥é”™ã€‚

```java
ArrayList<E> extends AbstractList<E>
```

å¹¶ä¸”ï¼ŒåŸç”Ÿ `List` è¿”å›ç±»å‹æ˜¯ `Object` ï¼Œéœ€è¦æ‰‹åŠ¨è½¬æ¢ç±»å‹æ‰èƒ½ä½¿ç”¨ï¼Œä½¿ç”¨æ³›å‹åç¼–è¯‘å™¨è‡ªåŠ¨è½¬æ¢ã€‚

æ³›å‹ä¸€èˆ¬æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼:**æ³›å‹ç±»**ã€**æ³›å‹æ¥å£**ã€**æ³›å‹æ–¹æ³•**ã€‚

Javaæ³›å‹çš„å®ç°é‡‡å–äº†â€œä¼ªæ³›å‹â€çš„ç­–ç•¥ï¼Œå³Javaåœ¨è¯­æ³•ä¸Šæ”¯æŒæ³›å‹ï¼Œä½†æ˜¯**åœ¨ç¼–è¯‘é˜¶æ®µä¼šè¿›è¡Œæ‰€è°“çš„â€œç±»å‹æ“¦é™¤â€ï¼ˆType  Erasureï¼‰**ï¼Œå°†æ‰€æœ‰çš„æ³›å‹è¡¨ç¤ºï¼ˆå°–æ‹¬å·ä¸­çš„å†…å®¹ï¼‰éƒ½æ›¿æ¢ä¸ºå…·ä½“çš„ç±»å‹ï¼ˆå…¶å¯¹åº”çš„åŸç”Ÿæ€ç±»å‹ï¼‰ï¼Œå°±åƒå®Œå…¨æ²¡æœ‰æ³›å‹ä¸€æ ·ã€‚ç†è§£**ç±»å‹æ“¦é™¤**å¯¹äºç”¨å¥½æ³›å‹æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå°¤å…¶æ˜¯ä¸€äº›çœ‹èµ·æ¥â€œç–‘éš¾æ‚ç—‡â€çš„é—®é¢˜ï¼Œå¼„æ˜ç™½äº†ç±»å‹æ“¦é™¤ä¹Ÿå°±è¿åˆƒè€Œè§£äº†ã€‚

æ³›å‹çš„ç±»å‹æ“¦é™¤åŸåˆ™æ˜¯ï¼š

- æ¶ˆé™¤ç±»å‹å‚æ•°å£°æ˜ï¼Œå³åˆ é™¤ `<>`åŠå…¶åŒ…å›´çš„éƒ¨åˆ†ã€‚
- æ ¹æ®ç±»å‹å‚æ•°çš„ä¸Šä¸‹ç•Œæ¨æ–­å¹¶æ›¿æ¢æ‰€æœ‰çš„ç±»å‹å‚æ•°ä¸ºåŸç”Ÿæ€ç±»å‹ï¼šå¦‚æœç±»å‹å‚æ•°æ˜¯æ— é™åˆ¶é€šé…ç¬¦æˆ–æ²¡æœ‰ä¸Šä¸‹ç•Œé™å®šåˆ™æ›¿æ¢ä¸ºObjectï¼Œå¦‚æœå­˜åœ¨ä¸Šä¸‹ç•Œé™å®šåˆ™æ ¹æ®å­ç±»æ›¿æ¢åŸåˆ™å–ç±»å‹å‚æ•°çš„æœ€å·¦è¾¹é™å®šç±»å‹ï¼ˆå³çˆ¶ç±»ï¼‰ã€‚
- ä¸ºäº†ä¿è¯ç±»å‹å®‰å…¨ï¼Œå¿…è¦æ—¶æ’å…¥å¼ºåˆ¶ç±»å‹è½¬æ¢ä»£ç ã€‚
- è‡ªåŠ¨äº§ç”Ÿâ€œæ¡¥æ¥æ–¹æ³•â€ä»¥ä¿è¯æ“¦é™¤ç±»å‹åçš„ä»£ç ä»ç„¶å…·æœ‰æ³›å‹çš„â€œå¤šæ€æ€§â€ã€‚

#### æ“¦é™¤ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°

**æ— é™åˆ¶ç±»å‹æ“¦é™¤**  å½“ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°æ²¡æœ‰ä»»ä½•é™åˆ¶æ—¶ï¼Œåœ¨ç±»å‹æ“¦é™¤ä¸­ç›´æ¥è¢«æ›¿æ¢ä¸ºObjectï¼Œå³å½¢å¦‚ `<T>`å’Œ `<?>`çš„ç±»å‹å‚æ•°éƒ½è¢«æ›¿æ¢ä¸ºObject

![image-20220617165626034](./images/image-20220617165626034.png)

**æœ‰é™åˆ¶ç±»å‹æ“¦é™¤**  å½“ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°å­˜åœ¨é™åˆ¶ï¼ˆä¸Šä¸‹ç•Œï¼‰æ—¶ï¼Œåœ¨ç±»å‹æ“¦é™¤ä¸­æ›¿æ¢ä¸ºç±»å‹å‚æ•°çš„ä¸Šç•Œæˆ–è€…ä¸‹ç•Œï¼Œæ¯”å¦‚å½¢å¦‚ `<T extends Number>`å’Œ `<? extends Number>`çš„ç±»å‹å‚æ•°è¢«æ›¿æ¢ä¸ºNumberï¼Œ`<? super  Number>`è¢«æ›¿æ¢ä¸ºObject

![image-20220617165706253](./images/image-20220617165706253.png)

#### æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°

æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°åŸåˆ™å’Œæ“¦é™¤ç±»å®šä¹‰ä¸­çš„ç±»å‹å‚æ•°æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä»…ä»¥æ“¦é™¤æ–¹æ³•å®šä¹‰ä¸­çš„æœ‰é™åˆ¶ç±»å‹å‚æ•°ä¸ºä¾‹

![image-20220617165721328](./images/image-20220617165721328.png)

#### æ¡¥æ¥æ–¹æ³•å’Œæ³›å‹çš„å¤šæ€

http://softlab.sdut.edu.cn/blog/subaochen/2017/01/generics-type-erasure/

ç”±äºåŸæ–‡çš„ç¯‡å¹…è¿‡é•¿ï¼Œè¿›è¡Œä»¥ä¸‹æ€»ç»“ï¼š

æ‰€è°“çš„â€œæ¡¥æ¥æ–¹æ³•â€ï¼ˆbridge methodï¼‰æ¥æ»¡è¶³Javaè¯­æ³•çš„è¦æ±‚ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†åŸºäºæ³›å‹çš„å¤šæ€èƒ½å¤Ÿæœ‰æ•ˆ

è¿è¡Œçš„æ—¶å€™ï¼Œä¼šå¯¹ `Child`ç±»çš„æ–¹æ³•è¡¨è¿›è¡Œæœç´¢ï¼Œå…ˆåˆ†æä¸€ä¸‹ `Child`ç±»çš„æ–¹æ³•è¡¨é‡Œæœ‰å“ªäº›ä¸œè¥¿ï¼š

```java
1. sayHello(Object value) : ä»ç±»å‹è¢«æ“¦é™¤åçš„è¶…ç±»ä¸­ç»§æ‰¿è¿‡æ¥
2. sayHello(String value) : è‡ªå·±æ–°å¢çš„æ–¹æ³•ï¼Œå’Œè¶…ç±»æ¯«æ— è”ç³»
```

![image-20220622211220694](./images/image-20220622211220694.png)

#### ä¸ºäº†æ›´æ·±å±‚æ¬¡çš„ç†è§£ç±»å‹æ“¦é™¤ï¼Œé€‰å–äº†Stackoverflowçš„é«˜èµå›ç­”

åŸå¸–ï¼šhttps://stackoverflow.com/questions/339699/java-generics-type-erasure-when-and-what-happens

> ğŸ˜£é—®é¢˜æ˜¯ï¼š**When does type erasure occur?** At compile time or runtime? When the class is loaded? When the class is instantiated?
>
> ç±»å‹æ“¦é™¤ä½•æ—¶å‘ç”Ÿ? åœ¨ç¼–è¯‘æ—¶è¿˜æ˜¯è¿è¡Œæ—¶? å½“ç±»è¢«åŠ è½½æ—¶? å½“ç±»è¢«å®ä¾‹åŒ–æ—¶ï¼Ÿ

ğŸ§ç±»å‹æ“¦é™¤é€‚ç”¨äºæ³›å‹çš„ä½¿ç”¨ã€‚ç±»æ–‡ä»¶ä¸­è‚¯å®šæœ‰å…ƒæ•°æ®æ¥è¯´æ˜æ–¹æ³•/ç±»å‹æ˜¯å¦æ˜¯æ³›å‹ï¼Œä»¥åŠçº¦æŸæ˜¯ä»€ä¹ˆç­‰ç­‰ã€‚ä½†æ˜¯å½“ä½¿ç”¨æ³›å‹æ—¶ï¼Œå®ƒä»¬è¢«è½¬æ¢ä¸ºç¼–è¯‘æ—¶æ£€æŸ¥å’Œæ‰§è¡Œæ—¶å¼ºåˆ¶è½¬æ¢ã€‚æ‰€ä»¥è¿™ä¸ªä»£ç ï¼š

```java
List<String> list = new ArrayList<String>();
list.add("Hi");
String x = list.get(0);
```

è¢«ç¼–è¯‘æˆ

```java
List list = new ArrayList();
list.add("Hi");
String x = (String) list.get(0);
```

åœ¨æ‰§è¡Œæ—¶ï¼Œæ²¡æœ‰åŠæ³•æ‰¾å‡ºåˆ—è¡¨å¯¹è±¡çš„ T = String è¿™ä¸ªä¿¡æ¯å·²ç»æ¶ˆå¤±äº†ã€‚ä½†æ˜¯ List < T > ç•Œé¢æœ¬èº«ä»ç„¶å®£ç§°è‡ªå·±æ˜¯é€šç”¨çš„ã€‚

åŸå¸–ï¼šhttps://stackoverflow.com/questions/313584/what-is-the-concept-of-erasure-in-generics-in-java

> ğŸ˜£What is the concept of erasure in generics in Java?
>
> åœ¨ Javaçš„ç±»å‹æ“¦é™¤ä¸­ï¼Œæ“¦é™¤çš„æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ§è¿™åŸºæœ¬ä¸Šæ˜¯é€šè¿‡ç¼–è¯‘å™¨æŠ€å·§åœ¨ Java ä¸­å®ç°æ³›å‹çš„æ–¹å¼ã€‚ç¼–è¯‘åçš„æ³›å‹ä»£ç å®é™…ä¸Šåªä½¿ç”¨ java.langã€‚å¯¹è±¡ï¼Œè€Œä¸”æœ‰ä¸€äº›å…ƒæ•°æ®ï¼ˆsome metadataï¼‰å¯ä»¥å‘Šè¯‰ç¼–è¯‘å™¨å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ³›å‹ç±»å‹ã€‚

å½“ä½ é’ˆå¯¹ä¸€ä¸ªæ³›å‹ç±»å‹æˆ–æ–¹æ³•ç¼–è¯‘ä¸€äº›ä»£ç æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè®¡ç®—å‡ºä½ çš„çœŸæ­£æ„æ€(ä¾‹å¦‚ T çš„ç±»å‹å‚æ•°æ˜¯ä»€ä¹ˆ)  ï¼Œå¹¶åœ¨ç¼–è¯‘æ—¶éªŒè¯ä½ åšçš„æ˜¯æ­£ç¡®çš„äº‹æƒ…ï¼Œä½†æ˜¯å‘å‡ºçš„ä»£ç å†æ¬¡ä½¿ç”¨ java.langã€‚å¯¹è±¡-ç¼–è¯‘å™¨åœ¨å¿…è¦æ—¶ç”Ÿæˆé¢å¤–çš„å¼ºåˆ¶è½¬æ¢ã€‚åœ¨æ‰§è¡Œæ—¶ï¼ŒList  < String > å’Œ List < Date > å®Œå…¨ç›¸åŒ; ç¼–è¯‘å™¨å·²ç»æ“¦é™¤äº†é¢å¤–çš„ç±»å‹ä¿¡æ¯ã€‚

æ¯”è¾ƒä¸€ä¸‹ C # ï¼Œå®ƒåœ¨æ‰§è¡Œæ—¶ä¿ç•™ä¿¡æ¯ï¼Œå…è®¸ä»£ç åŒ…å«è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ typeof (T) ï¼Œå®ƒç­‰ä»·äº T  ç±»â€”â€”é™¤éåè€…æ˜¯æ— æ•ˆçš„ã€‚(ä¸¤è€…ä¹‹é—´è¿˜æœ‰è¿›ä¸€æ­¥çš„åŒºåˆ«ã€‚NET æ³›å‹å’Œ Java æ³›å‹ï¼Œè¯·æ³¨æ„ã€‚)åœ¨å¤„ç† Java  æ³›å‹æ—¶ï¼Œç±»å‹æ“¦é™¤æ˜¯è®¸å¤šâ€œå¥‡æ€ªâ€è­¦å‘Š/é”™è¯¯æ¶ˆæ¯çš„æ¥æºã€‚

> ğŸ¥±å†çœ‹ä¸€ä¸ªè¿™ä¸ªå›ç­”çš„å®æˆ˜å†…å®¹

æ“¦é™¤ï¼Œå­—é¢æ„æ€æ˜¯ä»å·²ç¼–è¯‘çš„å­—èŠ‚ç ä¸­æ“¦é™¤æºä»£ç ä¸­å­˜åœ¨çš„ç±»å‹ä¿¡æ¯ã€‚è®©æˆ‘ä»¬ç”¨ä¸€äº›ä»£ç æ¥ç†è§£è¿™ä¸€ç‚¹ã€‚

```java
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

public class GenericsErasure {
    public static void main(String args[]) {
        List<String> list = new ArrayList<String>();
        list.add("Hello");
        Iterator<String> iter = list.iterator();
        while(iter.hasNext()) {
            String s = iter.next();
            System.out.println(s);
        }
    }
}
```

å¦‚æœæ‚¨ç¼–è¯‘è¿™æ®µä»£ç ï¼Œç„¶åç”¨ Java åç¼–è¯‘å™¨åç¼–è¯‘å®ƒï¼Œæ‚¨å°†å¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„ä»£ç ã€‚æ³¨æ„ï¼Œåç¼–è¯‘çš„ä»£ç ä¸åŒ…å«åŸå§‹æºä»£ç ä¸­æ˜¾ç¤ºçš„ç±»å‹ä¿¡æ¯çš„è·Ÿè¸ªã€‚

```java
import java.io.PrintStream;
import java.util.*;

public class GenericsErasure
{

    public GenericsErasure()
    {
    }

    public static void main(String args[])
    {
        List list = new ArrayList();
        list.add("Hello");
        String s;
        for(Iterator iter = list.iterator(); iter.hasNext(); System.out.println(s))
            s = (String)iter.next();

    }
} 
```

### â­== ä¸ equals

å¯¹äº**åŸºæœ¬ç±»å‹**æ¥è¯´ï¼Œ== æ¯”è¾ƒçš„æ˜¯å€¼æ˜¯å¦ç›¸ç­‰ï¼›

å¯¹äº**å¼•ç”¨ç±»å‹**æ¥è¯´ï¼Œ== æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡åœ°å€ï¼ˆä¸¤è€…åœ¨å†…å­˜ä¸­å­˜æ”¾çš„åœ°å€ï¼ˆå †å†…å­˜åœ°å€ï¼‰æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªåœ°æ–¹ï¼‰ï¼›

equals ï¼šç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å†…å®¹æ˜¯å¦ç›¸ç­‰ã€‚æ³¨æ„ï¼šequals æ–¹æ³•ä¸èƒ½ç”¨äºæ¯”è¾ƒåŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡ã€‚å¦‚æœæ²¡æœ‰å¯¹ equals æ–¹æ³•è¿›è¡Œé‡å†™ï¼Œåˆ™æ¯”è¾ƒçš„æ˜¯å¼•ç”¨ç±»å‹çš„å˜é‡æ‰€æŒ‡å‘çš„å¯¹è±¡çš„åœ°å€ï¼ˆå¾ˆå¤šç±»é‡å†™äº† equals æ–¹æ³•ï¼Œæ¯”å¦‚ Stringã€Integer ç­‰æŠŠå®ƒå˜æˆäº†å€¼æ¯”è¾ƒï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ equals æ¯”è¾ƒçš„æ˜¯å€¼æ˜¯å¦ç›¸ç­‰ï¼‰

### hashCode ä¸ equals

1. å¦‚æœä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰ï¼Œåˆ™ hashcode ä¸€å®šä¹Ÿæ˜¯ç›¸åŒçš„
2. ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰,å¯¹ä¸¤ä¸ª equals() æ–¹æ³•è¿”å› true
3. ä¸¤ä¸ªå¯¹è±¡æœ‰ç›¸åŒçš„ hashcode å€¼ï¼Œå®ƒä»¬ä¹Ÿä¸ä¸€å®šæ˜¯ç›¸ç­‰çš„
4. ç»¼ä¸Šï¼Œ equals() æ–¹æ³•è¢«è¦†ç›–è¿‡ï¼Œåˆ™ hashCode() æ–¹æ³•ä¹Ÿå¿…é¡»è¢«è¦†ç›–
5. hashCode() çš„é»˜è®¤è¡Œä¸ºæ˜¯å¯¹å †ä¸Šçš„å¯¹è±¡äº§ç”Ÿç‹¬ç‰¹å€¼ã€‚å¦‚æœæ²¡æœ‰é‡å†™ hashCode() ï¼Œåˆ™è¯¥class çš„ä¸¤ä¸ªå¯¹è±¡æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šç›¸ç­‰ï¼ˆå³ä½¿è¿™ä¸¤ä¸ªå¯¹è±¡æŒ‡å‘ç›¸åŒçš„æ•°æ®ï¼‰

### å¦‚ä½•å†³å®šä½¿ç”¨ HashMap è¿˜æ˜¯ TreeMapï¼Ÿ

`TreeMap<K,V>`çš„Keyå€¼æ˜¯è¦æ±‚å®ç°java.lang.Comparableï¼Œæ‰€ä»¥è¿­ä»£çš„æ—¶å€™TreeMapé»˜è®¤æ˜¯æŒ‰ç…§Keyå€¼å‡åºæ’åºçš„ï¼›TreeMapçš„å®ç°æ˜¯åŸºäºçº¢é»‘æ ‘ç»“æ„ã€‚é€‚ç”¨äºæŒ‰è‡ªç„¶é¡ºåºæˆ–è‡ªå®šä¹‰é¡ºåºéå†é”®ï¼ˆkeyï¼‰ã€‚

`HashMap<K,V>`çš„Keyå€¼å®ç°æ•£åˆ—hashCode()ï¼Œåˆ†å¸ƒæ˜¯æ•£åˆ—çš„ã€å‡åŒ€çš„ï¼Œä¸æ”¯æŒæ’åºï¼›æ•°æ®ç»“æ„ä¸»è¦æ˜¯æ¡¶(æ•°ç»„)ï¼Œé“¾è¡¨æˆ–çº¢é»‘æ ‘ã€‚é€‚ç”¨äºåœ¨Mapä¸­æ’å…¥ã€åˆ é™¤å’Œå®šä½å…ƒç´ ã€‚

**ç»“è®º**
å¦‚æœä½ éœ€è¦å¾—åˆ°ä¸€ä¸ªæœ‰åºçš„ç»“æœæ—¶å°±åº”è¯¥ä½¿ç”¨TreeMapï¼ˆå› ä¸ºHashMapä¸­å…ƒç´ çš„æ’åˆ—é¡ºåºæ˜¯ä¸å›ºå®šçš„ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºHashMapæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œæ‰€ä»¥å¤§å¤šä¸éœ€è¦æ’åºçš„æ—¶å€™æˆ‘ä»¬ä¼šä½¿ç”¨HashMapã€‚

### â­HashMap çš„åº•å±‚å®ç°

#### JDK1.8 ä¹‹å‰

JDK1.8 ä¹‹å‰ `HashMap` åº•å±‚æ˜¯ **æ•°ç»„å’Œé“¾è¡¨** ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ä¹Ÿå°±æ˜¯ **é“¾è¡¨æ•£åˆ—**ã€‚**HashMap é€šè¿‡ key çš„ hashCode ç»è¿‡æ‰°åŠ¨å‡½æ•°å¤„ç†è¿‡åå¾—åˆ° hash å€¼ï¼Œç„¶åé€šè¿‡ (n - 1) & hash  åˆ¤æ–­å½“å‰å…ƒç´ å­˜æ”¾çš„ä½ç½®ï¼ˆè¿™é‡Œçš„ n æŒ‡çš„æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ï¼Œå¦‚æœå½“å‰ä½ç½®å­˜åœ¨å…ƒç´ çš„è¯ï¼Œå°±åˆ¤æ–­è¯¥å…ƒç´ ä¸è¦å­˜å…¥çš„å…ƒç´ çš„ hash å€¼ä»¥åŠ key  æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çªã€‚**

**æ‰€è°“æ‰°åŠ¨å‡½æ•°æŒ‡çš„å°±æ˜¯ HashMap çš„ hash æ–¹æ³•ã€‚ä½¿ç”¨ hash æ–¹æ³•ä¹Ÿå°±æ˜¯æ‰°åŠ¨å‡½æ•°æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›å®ç°æ¯”è¾ƒå·®çš„ hashCode() æ–¹æ³• æ¢å¥è¯è¯´ä½¿ç”¨æ‰°åŠ¨å‡½æ•°ä¹‹åå¯ä»¥å‡å°‘ç¢°æ’ã€‚**

**JDK 1.8 HashMap çš„ hash æ–¹æ³•æºç :**

JDK 1.8 çš„ hash æ–¹æ³• ç›¸æ¯”äº JDK 1.7 hash æ–¹æ³•æ›´åŠ ç®€åŒ–ï¼Œä½†æ˜¯åŸç†ä¸å˜ã€‚

```java
    static final int hash(Object key) {
      int h;
      // key.hashCode()ï¼šè¿”å›æ•£åˆ—å€¼ä¹Ÿå°±æ˜¯hashcode
      // ^ ï¼šæŒ‰ä½å¼‚æˆ–
      // >>>:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½
      return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
  }
```

å¯¹æ¯”ä¸€ä¸‹ JDK1.7 çš„ HashMap çš„ hash æ–¹æ³•æºç .

```java
static int hash(int h) {
    // This function ensures that hashCodes that differ only by
    // constant multiples at each bit position have a bounded
    // number of collisions (approximately 8 at default load factor).

    h ^= (h >>> 20) ^ (h >>> 12);
    return h ^ (h >>> 7) ^ (h >>> 4);
}
```

ç›¸æ¯”äº JDK1.8 çš„ hash æ–¹æ³• ï¼ŒJDK 1.7 çš„ hash æ–¹æ³•çš„æ€§èƒ½ä¼šç¨å·®ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºæ¯•ç«Ÿæ‰°åŠ¨äº† 4 æ¬¡ã€‚

æ‰€è°“ **â€œæ‹‰é“¾æ³•â€** å°±æ˜¯ï¼šå°†é“¾è¡¨å’Œæ•°ç»„ç›¸ç»“åˆã€‚ä¹Ÿå°±æ˜¯è¯´åˆ›å»ºä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸€æ ¼å°±æ˜¯ä¸€ä¸ªé“¾è¡¨ã€‚è‹¥é‡åˆ°å“ˆå¸Œå†²çªï¼Œåˆ™å°†å†²çªçš„å€¼åŠ åˆ°é“¾è¡¨ä¸­å³å¯ã€‚

![image-20220616155615352](./images/image-20220616155615352.png)

#### JDK1.8 ä¹‹å

ç›¸æ¯”äºä¹‹å‰çš„ç‰ˆæœ¬ï¼Œ JDK1.8 ä¹‹ååœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚

![image-20220616155623710](./images/image-20220616155623710.png)

> TreeMapã€TreeSet ä»¥åŠ JDK1.8 ä¹‹åçš„ HashMap åº•å±‚éƒ½ç”¨åˆ°äº†çº¢é»‘æ ‘ã€‚çº¢é»‘æ ‘å°±æ˜¯ä¸ºäº†è§£å†³äºŒå‰æŸ¥æ‰¾æ ‘çš„ç¼ºé™·ï¼Œå› ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€€åŒ–æˆä¸€ä¸ªçº¿æ€§ç»“æ„ã€‚

> é¢è¯•å¯ä»¥è¿™æ ·å›ç­”ï¼šhashmapçš„åº•å±‚æ˜¯å“ˆå¸Œè¡¨ï¼Œæ˜¯åŸºäºhashç®—æ³•å®ç°çš„ï¼Œhashmapé€šè¿‡put(key,value)å­˜å‚¨ï¼Œé€šè¿‡get(key)è·å–ï¼Œå½“ä¼ å…¥keyæ—¶ï¼Œhashmapä¼šè°ƒç”¨key.hashcode()æ–¹æ³•è®¡ç®—å‡ºhashå€¼ï¼Œæ ¹æ® hash å€¼å°† value ä¿å­˜åœ¨ bucket é‡Œã€‚å½“è®¡ç®—
>
> å‡ºçš„ hash å€¼ç›¸åŒæ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º hash å†²çªï¼ŒHashMap çš„åšæ³•æ˜¯ç”¨é“¾è¡¨å’Œçº¢é»‘æ ‘å­˜å‚¨ç›¸åŒ hash å€¼çš„valueã€‚å½“ hash å†²çªçš„ä¸ªæ•°å°‘äºç­‰äº8ä¸ªæ—¶ï¼Œä½¿ç”¨é“¾è¡¨å¦åˆ™ä½¿ç”¨çº¢é»‘æ ‘ã€‚

### â­HashMapæºç åˆ†æ

#### get()

`get(Object key)`æ–¹æ³•æ ¹æ®æŒ‡å®šçš„ `key`å€¼è¿”å›å¯¹åº”çš„ `value`ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº† `getEntry(Object key)`å¾—åˆ°ç›¸åº”çš„ `entry`ï¼Œç„¶åè¿”å› `entry.getValue()`ã€‚å› æ­¤ `getEntry()`æ˜¯ç®—æ³•çš„æ ¸å¿ƒã€‚ **ç®—æ³•æ€æƒ³**æ˜¯é¦–å…ˆé€šè¿‡ `hash()`å‡½æ•°å¾—åˆ°å¯¹åº” `bucket`çš„ä¸‹æ ‡ï¼Œç„¶åä¾æ¬¡éå†å†²çªé“¾è¡¨ï¼Œé€šè¿‡ `key.equals(k)`æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è¦æ‰¾çš„é‚£ä¸ª `entry`ã€‚

![image-20220616161400630](./images/image-20220616161400630.png)

ä¸Šå›¾ä¸­ `hash(k)&(table.length-1)`ç­‰ä»·äº `hash(k)%table.length`ï¼ŒåŸå› æ˜¯*HashMap*è¦æ±‚ `table.length`å¿…é¡»æ˜¯2çš„æŒ‡æ•°ï¼Œå› æ­¤ `table.length-1`å°±æ˜¯äºŒè¿›åˆ¶ä½ä½å…¨æ˜¯1ï¼Œè·Ÿ `hash(k)`ç›¸ä¸ä¼šå°†å“ˆå¸Œå€¼çš„é«˜ä½å…¨æŠ¹æ‰ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä½™æ•°äº†ã€‚

```java
//getEntry()æ–¹æ³•
final Entry<K,V> getEntry(Object key) {
	......
	int hash = (key == null) ? 0 : hash(key);
    for (Entry<K,V> e = table[hash&(table.length-1)];//å¾—åˆ°å†²çªé“¾è¡¨
         e != null; e = e.next) {//ä¾æ¬¡éå†å†²çªé“¾è¡¨ä¸­çš„æ¯ä¸ªentry
        Object k;
        //ä¾æ®equals()æ–¹æ³•åˆ¤æ–­æ˜¯å¦ç›¸ç­‰
        if (e.hash == hash &&
            ((k = e.key) == key || (key != null && key.equals(k))))
            return e;
    }
    return null;
}
```

#### put()

`put(K key, V value)`æ–¹æ³•æ˜¯å°†æŒ‡å®šçš„ `key, value`å¯¹æ·»åŠ åˆ° `map`é‡Œã€‚è¯¥æ–¹æ³•é¦–å…ˆä¼šå¯¹ `map`åšä¸€æ¬¡æŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦åŒ…å«è¯¥å…ƒç»„ï¼Œå¦‚æœå·²ç»åŒ…å«åˆ™ç›´æ¥è¿”å›ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç±»ä¼¼äº `getEntry()`æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šé€šè¿‡ `addEntry(int hash, K key, V value, int bucketIndex)`æ–¹æ³•æ’å…¥æ–°çš„ `entry`ï¼Œæ’å…¥æ–¹å¼ä¸º**å¤´æ’æ³•**ã€‚

![image-20220616161439305](./images/image-20220616161439305.png)

```java
//addEntry()
void addEntry(int hash, K key, V value, int bucketIndex) {
    if ((size >= threshold) && (null != table[bucketIndex])) {
        resize(2 * table.length);//è‡ªåŠ¨æ‰©å®¹ï¼Œå¹¶é‡æ–°å“ˆå¸Œ
        hash = (null != key) ? hash(key) : 0;
        bucketIndex = hash & (table.length-1);//hash%table.length
    }
    //åœ¨å†²çªé“¾è¡¨å¤´éƒ¨æ’å…¥æ–°çš„entry
    Entry<K,V> e = table[bucketIndex];
    table[bucketIndex] = new Entry<>(hash, key, value, e);
    size++;
}


```

#### remove()

`remove(Object key)`çš„ä½œç”¨æ˜¯åˆ é™¤ `key`å€¼å¯¹åº”çš„ `entry`ï¼Œè¯¥æ–¹æ³•çš„å…·ä½“é€»è¾‘æ˜¯åœ¨ `removeEntryForKey(Object key)`é‡Œå®ç°çš„ã€‚`removeEntryForKey()`æ–¹æ³•ä¼šé¦–å…ˆæ‰¾åˆ° `key`å€¼å¯¹åº”çš„ `entry`ï¼Œç„¶ååˆ é™¤è¯¥ `entry`(ä¿®æ”¹é“¾è¡¨çš„ç›¸åº”å¼•ç”¨)ã€‚æŸ¥æ‰¾è¿‡ç¨‹è·Ÿ `getEntry()`è¿‡ç¨‹ç±»ä¼¼ã€‚

![image-20220616161551183](./images/image-20220616161551183.png)

```java
//removeEntryForKey()
final Entry<K,V> removeEntryForKey(Object key) {
	......
	int hash = (key == null) ? 0 : hash(key);
    int i = indexFor(hash, table.length);//hash&(table.length-1)
    Entry<K,V> prev = table[i];//å¾—åˆ°å†²çªé“¾è¡¨
    Entry<K,V> e = prev;
    while (e != null) {//éå†å†²çªé“¾è¡¨
        Entry<K,V> next = e.next;
        Object k;
        if (e.hash == hash &&
            ((k = e.key) == key || (key != null && key.equals(k)))) {//æ‰¾åˆ°è¦åˆ é™¤çš„entry
            modCount++; size--;
            if (prev == e) table[i] = next;//åˆ é™¤çš„æ˜¯å†²çªé“¾è¡¨çš„ç¬¬ä¸€ä¸ªentry
            else prev.next = next;
            return e;
        }
        prev = e; e = next;
    }
    return e;
}
```

### HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹

ä¸ºäº†èƒ½è®© HashMap å­˜å–é«˜æ•ˆï¼Œå°½é‡è¾ƒå°‘ç¢°æ’ï¼Œä¹Ÿå°±æ˜¯è¦å°½é‡æŠŠæ•°æ®åˆ†é…å‡åŒ€ã€‚æˆ‘ä»¬ä¸Šé¢ä¹Ÿè®²åˆ°äº†è¿‡äº†ï¼ŒHash  å€¼çš„èŒƒå›´å€¼-2147483648 åˆ° 2147483647ï¼Œå‰ååŠ èµ·æ¥å¤§æ¦‚ 40  äº¿çš„æ˜ å°„ç©ºé—´ï¼Œåªè¦å“ˆå¸Œå‡½æ•°æ˜ å°„å¾—æ¯”è¾ƒå‡åŒ€æ¾æ•£ï¼Œä¸€èˆ¬åº”ç”¨æ˜¯å¾ˆéš¾å‡ºç°ç¢°æ’çš„ã€‚ä½†é—®é¢˜æ˜¯ä¸€ä¸ª 40  äº¿é•¿åº¦çš„æ•°ç»„ï¼Œå†…å­˜æ˜¯æ”¾ä¸ä¸‹çš„ã€‚æ‰€ä»¥è¿™ä¸ªæ•£åˆ—å€¼æ˜¯ä¸èƒ½ç›´æ¥æ‹¿æ¥ç”¨çš„ã€‚ç”¨ä¹‹å‰è¿˜è¦å…ˆåšå¯¹æ•°ç»„çš„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰èƒ½ç”¨æ¥è¦å­˜æ”¾çš„ä½ç½®ä¹Ÿå°±æ˜¯å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚è¿™ä¸ªæ•°ç»„ä¸‹æ ‡çš„è®¡ç®—æ–¹æ³•æ˜¯â€œ `(n - 1) & hash`â€ã€‚ï¼ˆn ä»£è¡¨æ•°ç»„é•¿åº¦ï¼‰ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº† HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚

**è¿™ä¸ªç®—æ³•åº”è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿ**

æˆ‘ä»¬é¦–å…ˆå¯èƒ½ä¼šæƒ³åˆ°é‡‡ç”¨%å–ä½™çš„æ“ä½œæ¥å®ç°ã€‚ä½†æ˜¯ï¼Œé‡ç‚¹æ¥äº†ï¼š**â€œå–ä½™(%)æ“ä½œä¸­å¦‚æœé™¤æ•°æ˜¯ 2 çš„å¹‚æ¬¡åˆ™ç­‰ä»·äºä¸å…¶é™¤æ•°å‡ä¸€çš„ä¸(&)æ“ä½œï¼ˆä¹Ÿå°±æ˜¯è¯´ hash%length==hash&(length-1)çš„å‰ææ˜¯ length æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼›ï¼‰ã€‚â€** å¹¶ä¸” **é‡‡ç”¨äºŒè¿›åˆ¶ä½æ“ä½œ &ï¼Œç›¸å¯¹äº%èƒ½å¤Ÿæé«˜è¿ç®—æ•ˆç‡ï¼Œè¿™å°±è§£é‡Šäº† HashMap çš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ã€‚**

ğŸ™‹â€â™‚ï¸ç¬”è€…è®¤ä¸ºGuideå†™çš„è¿™ä¸ªæ‘¸æ£±ä¸¤å¯ï¼Œæ‰€ä»¥æ‰¾äº†ä¸€ä¸ªStackOverFlowä¸­æè¿°æ›´ä¸ºæ¸…æ¥šçš„ç¿»è¯‘ä¸ºä¸‹ï¼š

> ğŸ§šâ€â™‚ï¸åŸå¸–ï¼šhttps://stackoverflow.com/questions/53526790/why-are-hashmaps-implemented-using-powers-of-two
>
> å½“ä½ ä»ä¸€ä¸ªå¹‚ä¸º2çš„æ•°å­—ä¸­å‡å»1å¾—åˆ°çš„æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶è¡¨ç¤ºéƒ½æ˜¯1çš„æ•°å­—ã€‚ä¾‹å¦‚16æ˜¯2çš„å¹‚ã€‚å¦‚æœä»ä¸­å‡å»1ï¼Œå¾—åˆ°15ï¼Œå®ƒçš„äºŒè¿›åˆ¶è¡¨ç¤ºæ˜¯1111ã€‚ç°åœ¨ï¼Œå¦‚æœä½ ç”¨1111å¯¹ä»»ä½•ä¸€ä¸ªæ•°å­—è¿›è¡Œä½ AND  è¿ç®—ï¼Œä½ å°†å¾—åˆ°è¿™ä¸ªæ•°å­—çš„æœ€å4ä½ï¼Œæ¢å¥è¯è¯´ï¼Œå®ƒç­‰äºè¿™ä¸ªæ•°å­—ä¹˜ä»¥16çš„æ¨¡(é™¤æ³•è¿ç®—é€šå¸¸æ˜¯ä¸€ä¸ªæ˜‚è´µçš„è¿ç®—ã€‚å› æ­¤ï¼Œä½æ“ä½œé€šå¸¸æ¯”é™¤æ³•æ›´å—æ¬¢è¿)ã€‚æœ€åçš„4ä½å°†è®¡ç®—ä¸º0åˆ°15ä¹‹é—´çš„ä»»æ„æ•°å­—ï¼Œè¿™äº›æ•°å­—æ˜¯åŸºç¡€æ•°ç»„çš„ç´¢å¼•ã€‚
>
> ä½ å¯ä»¥æ”¹æˆ17ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»ä¸­å‡å»1å¾—åˆ°16ä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶çš„10000ã€‚ç°åœ¨ä½ å¯¹ä¸€ä¸ª16çš„æ•°åš ANDï¼ˆä¸&ï¼‰  è¿ç®—ï¼Œä½ ä¼šå¤±å»æ‰€æœ‰çš„ä½ï¼Œé™¤äº†ä»ç»“å°¾å¼€å§‹çš„ç¬¬5ä½ã€‚å› æ­¤ï¼Œæ— è®ºå–å¤šå°‘æ•°ï¼Œæ•°ç»„ç´¢å¼•éƒ½æ˜¯16æˆ–0ã€‚è¿™æ„å‘³ç€ä¼šæœ‰å¾ˆå¤šå†²çªï¼Œè¿™åè¿‡æ¥åˆæ„å‘³ç€æ€§èƒ½å¾ˆå·®ã€‚æ‚¨å°†éœ€è¦ O (log n)è€Œä¸æ˜¯ O  (1)è¿›è¡Œæ£€ç´¢ï¼Œå› ä¸ºå½“å†²çªå‘ç”Ÿæ—¶ï¼Œç»™å®šæ¡¶ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å°†å­˜å‚¨åœ¨ä¸€ä¸ªçº¢é»‘è‰²æ ‘ä¸­ã€‚ä¸ä»…å¦‚æ­¤ã€‚å¦‚æœæ‚¨åœ¨ä¸€ä¸ªå¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨  ConcurrentHashMapï¼Œé‚£ä¹ˆæ‚¨å°†ç»å†å¤§é‡çš„åŒæ­¥ï¼Œå› ä¸ºæ‰€æœ‰æ–°æ·»åŠ çš„å†…å®¹æœ€ç»ˆéƒ½ä¼šä»¥éå¸¸å°‘çš„å­˜å‚¨æ¡¶(åœ¨ä¸Šè¿°æƒ…å†µä¸‹åªæœ‰2-0å’Œ16ä¸ª)ç»“æŸï¼Œå¹¶ä¸”å½“æ‚¨åœ¨ä¸€ä¸ªå·²ç»æœ‰å…¶ä»–èŠ‚ç‚¹çš„å­˜å‚¨æ¡¶ä¸­æ·»åŠ æ–°èŠ‚ç‚¹æ—¶ï¼Œå­˜å‚¨æ¡¶å°†è¢«é”å®šï¼Œä»¥é¿å…ç”±äºå¤šä¸ªçº¿ç¨‹çš„ä¿®æ”¹è€Œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚å› æ­¤ï¼Œå°è¯•æ·»åŠ æ–°èŠ‚ç‚¹çš„å…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…å½“å‰çº¿ç¨‹é‡Šæ”¾é”ã€‚
>
> æœ€åï¼Œæˆ‘è¿˜åº”è¯¥æåˆ°ï¼ŒJava HashMap å®ç°è¿˜å°†é”®çš„å“ˆå¸Œä»£ç çš„16ä½å‘å³ç§»åŠ¨ï¼Œå¹¶åœ¨ç”¨(length-1)è¿›è¡Œä½ AND ä¹‹å‰å¯¹åŸå“ˆå¸Œä»£ç è¿›è¡Œä½å¼‚æˆ–æ“ä½œï¼Œä»¥ç¡®ä¿é«˜é˜¶ä½çš„æ•ˆæœä¹Ÿè¢«æ•è·ã€‚
>
> å› æ­¤ï¼ŒåŸºæœ¬ä¸Šè¦ç‚¹æ˜¯ï¼Œå¦‚æœå¤§å°æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œé‚£ä¹ˆä¸å…¶ä»–ä»»ä½•ä¸æ˜¯2çš„å¤§å°ç›¸æ¯”ï¼Œé”®å°†æ›´å‡åŒ€åœ°åˆ†å¸ƒåœ¨æ•´ä¸ªæ•°ç»„ä¸­ï¼Œæœ€å°çš„å†²çªå°†å¯¼è‡´æ›´å¥½çš„æ£€ç´¢æ€§èƒ½(åœ¨ConcurrentHashMap çš„æƒ…å†µä¸‹ä¹Ÿæ›´å°‘çš„åŒæ­¥)ã€‚

ä¸ºä»€ä¹ˆèƒ½å‡å°‘ç¢°æ’ï¼Ÿè¿™æ˜¯å› ä¸ºhashmapçš„hashå€¼æ˜¯hashCodeå³ç§»16ä½å¾—åˆ°çš„ï¼Œè¿™ä¹ˆåšä½¿å¾—hashå€¼çš„ä½ä½ä¿ç•™äº†é«˜ä½çš„ä¿¡æ¯ï¼Œæ‰€ä»¥åªè¦ä½ä½å°±å¯ä»¥äº†ã€‚

ä¸€å¥è¯ï¼ŒHashMapçš„é•¿åº¦ä¸º2çš„å¹‚æ¬¡æ–¹çš„åŸå› æ˜¯ä¸ºäº†å‡å°‘Hashç¢°æ’ï¼Œå°½é‡ä½¿Hashç®—æ³•çš„ç»“æœå‡åŒ€åˆ†å¸ƒã€‚ï¼ˆåªæœ‰å½“é•¿åº¦æ˜¯2^næ—¶ï¼Œé•¿åº¦-1çš„äºŒè¿›åˆ¶ä½ä½æ‰å…¨éƒ¨æ˜¯1ï¼‰

> å®é™…åœºæ™¯å¯ä»¥è¿™æ ·å›ç­”

Hash å€¼çš„èŒƒå›´å€¼æ¯”è¾ƒå¤§ï¼Œä½¿ç”¨ä¹‹å‰éœ€è¦å…ˆå¯¹æ•°ç»„çš„é•¿åº¦å–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ä½™æ•°æ‰æ˜¯å…ƒç´ å­˜æ”¾çš„ä½ç½®ä¹Ÿå°±æ˜¯å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ã€‚

è¿™ä¸ªæ•°ç»„ä¸‹æ ‡çš„è®¡ç®—æ–¹æ³•æ˜¯ `(n - 1) & hash`

å°†HashMapçš„é•¿åº¦å®šä¸º2 çš„å¹‚æ¬¡æ–¹ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ `(n - 1)&hash`ä½è¿ç®—ä»£æ›¿%å–ä½™çš„æ“ä½œï¼Œæé«˜æ€§èƒ½ã€‚

> æ‹“å±•ï¼š**HashMapé»˜è®¤åŠ è½½å› å­ä¸ºä»€ä¹ˆé€‰æ‹©0.75å‘¢ï¼Ÿ**

0.75æ˜¯å¯¹**ç©ºé—´å’Œæ—¶é—´æ•ˆç‡**çš„ä¸€ä¸ªå¹³è¡¡é€‰æ‹©ï¼Œæ ¹æ®æ³Šæ¾åˆ†å¸ƒï¼ŒloadFactor å–0.75ç¢°æ’æœ€å°ã€‚ä¸€èˆ¬ä¸ä¼šä¿®æ”¹ï¼Œé™¤éåœ¨æ—¶é—´å’Œç©ºé—´æ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µä¸‹ ï¼š

* å¦‚æœå†…å­˜ç©ºé—´å¾ˆå¤šè€Œåˆå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚å¾ˆé«˜ï¼Œå¯ä»¥é™ä½è´Ÿè½½å› å­Load factorçš„å€¼ ã€‚
* å¦‚æœå†…å­˜ç©ºé—´ç´§å¼ è€Œå¯¹æ—¶é—´æ•ˆç‡è¦æ±‚ä¸é«˜ï¼Œå¯ä»¥å¢åŠ è´Ÿè½½å› å­loadFactorçš„å€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥å¤§äº1ã€‚



### HashMap å¤šçº¿ç¨‹æ“ä½œå¯¼è‡´æ­»å¾ªç¯é—®é¢˜

ä¸»è¦åŸå› åœ¨äºå¹¶å‘ä¸‹çš„ Rehash ä¼šé€ æˆå…ƒç´ ä¹‹é—´ä¼šå½¢æˆä¸€ä¸ªå¾ªç¯é“¾è¡¨ã€‚ä¸è¿‡ï¼Œjdk 1.8 åè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å»ºè®®åœ¨å¤šçº¿ç¨‹ä¸‹ä½¿ç”¨  HashMap,å› ä¸ºå¤šçº¿ç¨‹ä¸‹ä½¿ç”¨ HashMap è¿˜æ˜¯ä¼šå­˜åœ¨å…¶ä»–é—®é¢˜æ¯”å¦‚æ•°æ®ä¸¢å¤±ã€‚å¹¶å‘ç¯å¢ƒä¸‹æ¨èä½¿ç”¨ ConcurrentHashMap ã€‚

è¯¦æƒ…è¯·æŸ¥çœ‹ï¼šhttps://coolshell.cn/articles/9606.html

### ä¸ºä»€ä¹ˆJavaåªæœ‰å€¼ä¼ é€’

ä¸ªäººç†è§£ï¼Œä¸ç®¡åœ¨æ–¹æ³•ä¸­å¦‚ä½•è°ƒç”¨éƒ½æ˜¯åªæ‹·è´ã€‚ä¾‹å¦‚ï¼ˆint a, int bï¼‰å°±æ˜¯æ‹·è´ä¼ å…¥çš„å€¼åˆ°å¦å¤–ä¸€ä¸ªåœ°å€ï¼›å¦‚æœä¼ å…¥çš„æ˜¯ï¼ˆint[] arrï¼‰æˆ–è€…ï¼ˆInteger aï¼‰åˆ™å°±æ˜¯æ‹·è´è¿™ä¸ªçš„åœ°å€åˆ°å¦å¤–ä¸€ä¸ªåœ°å€ï¼Œå®è´¨ä¸Šä¸¤ä¸ªï¼ˆåŸå€¼å’Œæ‹·è´çš„åœ°å€ï¼‰éƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚

### å¼‚å¸¸å¤„ç†æ€»ç»“

finally å—ä¸ä¼šè¢«æ‰§è¡Œï¼š

1. åœ¨ try æˆ– finally å—ä¸­ç”¨äº† System.exit(int) é€€å‡ºç¨‹åºã€‚ä½†æ˜¯ï¼Œå¦‚æœ System.exit(int) åœ¨å¼‚å¸¸
   è¯­å¥ä¹‹åï¼Œ finally è¿˜æ˜¯ä¼šè¢«æ‰§è¡Œ
2. ç¨‹åºæ‰€åœ¨çš„çº¿ç¨‹æ­»äº¡ã€‚
3. å…³é—­ CPUã€‚

ä¸‹é¢è¿™éƒ¨åˆ†å†…å®¹æ¥è‡ª issue:https://github.com/Snailclimb/JavaGuide/issues/190ã€‚
**æ³¨æ„ï¼š** å½“ try è¯­å¥å’Œ finally è¯­å¥ä¸­éƒ½æœ‰ return è¯­å¥æ—¶ï¼Œåœ¨æ–¹æ³•è¿”å›ä¹‹å‰ï¼Œfinally è¯­å¥çš„å†…å®¹å°†è¢«æ‰§è¡Œï¼Œå¹¶ä¸” finally è¯­å¥çš„è¿”å›å€¼å°†ä¼šè¦†ç›–åŸå§‹çš„è¿”å›å€¼ã€‚å¦‚ä¸‹ï¼š

```java
public static int f(int value) {
	try {
		return value * value;
	} finally {
	if (value == 2) {
		return 0;
	}
}
```

ã€Šjavaæ ¸å¿ƒæŠ€æœ¯å·ä¸€ã€‹ä¸­æåˆ°è¿‡ï¼šå½“finallyå­å¥åŒ…å«return è¯­å¥æ—¶ï¼ˆå½“ç„¶åœ¨è®¾è®¡åŸåˆ™ä¸Šæ˜¯ä¸å…è®¸åœ¨finallyå—ä¸­æŠ›å‡ºå¼‚å¸¸æˆ–è€… æ‰§è¡Œreturnè¯­å¥çš„ï¼‰ï¼Œå°†ä¼šå‡ºç°ä¸€ç§æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚å‡è®¾åˆ©ç”¨returnè¯­å¥ä»try è¯­å¥å—ä¸­é€€å‡ºã€‚åœ¨æ–¹æ³•è¿”å›å‰ï¼Œfinallyå­å¥çš„å†…å®¹å°†è¢«æ‰§è¡Œã€‚å¦‚æœfinallyå­å¥ä¸­ä¹Ÿæœ‰ä¸€ä¸ªreturnè¯­å¥ï¼Œè¿™ä¸ªè¿”å›å€¼å°†ä¼šè¦†ç›–åŸå§‹çš„è¿”å›å€¼ã€‚

### æœ‰å“ªäº›å¸¸è§çš„ IO æ¨¡å‹?

UNIX ç³»ç»Ÿä¸‹ï¼Œ IO æ¨¡å‹ä¸€å…±æœ‰ 5 ç§ï¼š åŒæ­¥é˜»å¡ I/Oã€åŒæ­¥éé˜»å¡ I/Oã€I/O å¤šè·¯å¤ç”¨ã€ä¿¡å·é©±åŠ¨ I/O å’Œå¼‚æ­¥ I/Oã€‚

#### é˜»å¡å¼ I/O

åº”ç”¨è¿›ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°æ•°æ®å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºä¸­æ‰è¿”å›ã€‚ åº”è¯¥æ³¨æ„åˆ°ï¼Œåœ¨é˜»å¡çš„è¿‡ç¨‹ä¸­ï¼Œå…¶å®ƒç¨‹åºè¿˜å¯ä»¥æ‰§è¡Œï¼Œå› æ­¤é˜»å¡ä¸æ„å‘³ç€æ•´ä¸ªæ“ä½œç³»ç»Ÿéƒ½è¢«é˜»å¡ã€‚å› ä¸ºå…¶ä»–ç¨‹åºè¿˜å¯ä»¥æ‰§è¡Œï¼Œå› æ­¤ä¸æ¶ˆè€— CPU æ—¶é—´ï¼Œè¿™ç§æ¨¡å‹çš„æ‰§è¡Œæ•ˆç‡ä¼šæ¯”è¾ƒé«˜ã€‚ ä¸‹å›¾ä¸­ï¼Œrecvfrom ç”¨äºæ¥æ”¶ Socket ä¼ æ¥çš„æ•°æ®ï¼Œå¹¶å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹çš„ç¼“å†²åŒº buf ä¸­ã€‚è¿™é‡ŒæŠŠ recvfrom() å½“æˆç³»ç»Ÿè°ƒç”¨ã€‚

![image-20220628221701308](./images/image-20220628221701308.png)

#### éé˜»å¡å¼ I/O

åº”ç”¨è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œå†…æ ¸è¿”å›ä¸€ä¸ªé”™è¯¯ç ã€‚åº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä½†æ˜¯éœ€è¦ä¸æ–­çš„æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ¥è·çŸ¥ I/O æ˜¯å¦å®Œæˆï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºè½®è¯¢(polling)ã€‚

ç”±äº CPU è¦å¤„ç†æ›´å¤šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤è¿™ç§æ¨¡å‹æ˜¯æ¯”è¾ƒä½æ•ˆçš„ã€‚

![image-20220628221710263](./images/image-20220628221710263.png)

#### I/O å¤ç”¨

**ä½¿ç”¨ select æˆ–è€… poll ç­‰å¾…æ•°æ®**ï¼Œå¹¶ä¸”å¯ä»¥ç­‰å¾…å¤šä¸ªå¥—æ¥å­—ä¸­çš„ä»»ä½•ä¸€ä¸ªå˜ä¸ºå¯è¯»ï¼Œè¿™ä¸€è¿‡ç¨‹ä¼šè¢«é˜»å¡ï¼Œå½“æŸä¸€ä¸ªå¥—æ¥å­—å¯è¯»æ—¶è¿”å›ã€‚ä¹‹åå†ä½¿ç”¨ recvfrom æŠŠæ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°è¿›ç¨‹ä¸­ã€‚

å®ƒå¯ä»¥è®©å•ä¸ªè¿›ç¨‹å…·æœ‰å¤„ç†å¤šä¸ª I/O äº‹ä»¶çš„èƒ½åŠ›ã€‚åˆè¢«ç§°ä¸º Event Driven I/Oï¼Œå³äº‹ä»¶é©±åŠ¨ I/Oã€‚

å¦‚æœä¸€ä¸ª Web æœåŠ¡å™¨æ²¡æœ‰ I/O å¤ç”¨ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ª Socket è¿æ¥éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ã€‚å¦‚æœåŒæ—¶æœ‰å‡ ä¸‡ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ›å»ºç›¸åŒæ•°é‡çš„çº¿ç¨‹ã€‚å¹¶ä¸”ç›¸æ¯”äºå¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æŠ€æœ¯ï¼ŒI/O å¤ç”¨ä¸éœ€è¦è¿›ç¨‹çº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢çš„å¼€é”€ï¼Œç³»ç»Ÿå¼€é”€æ›´å°ã€‚

![image-20220628221721484](./images/image-20220628221721484.png)

#### ä¿¡å·é©±åŠ¨ I/O

åº”ç”¨è¿›ç¨‹ä½¿ç”¨ sigaction ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸ç«‹å³è¿”å›ï¼Œåº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ç­‰å¾…æ•°æ®é˜¶æ®µåº”ç”¨è¿›ç¨‹æ˜¯éé˜»å¡çš„ã€‚å†…æ ¸åœ¨æ•°æ®åˆ°è¾¾æ—¶å‘åº”ç”¨è¿›ç¨‹å‘é€ SIGIO ä¿¡å·ï¼Œåº”ç”¨è¿›ç¨‹æ”¶åˆ°ä¹‹ååœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­è°ƒç”¨ recvfrom å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ä¸­ã€‚

ç›¸æ¯”äºéé˜»å¡å¼ I/O çš„è½®è¯¢æ–¹å¼ï¼Œä¿¡å·é©±åŠ¨ I/O çš„ CPU åˆ©ç”¨ç‡æ›´é«˜ã€‚

![image-20220628221734114](./images/image-20220628221734114.png)

#### å¼‚æ­¥ I/O

è¿›è¡Œ aio_readï¼ˆasynchronous readï¼‰ ç³»ç»Ÿè°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œåº”ç”¨è¿›ç¨‹ç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œå†…æ ¸ä¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆä¹‹åå‘åº”ç”¨è¿›ç¨‹å‘é€ä¿¡å·ã€‚

å¼‚æ­¥ I/O ä¸ä¿¡å·é©±åŠ¨ I/O çš„åŒºåˆ«åœ¨äºï¼Œå¼‚æ­¥ I/O çš„ä¿¡å·æ˜¯é€šçŸ¥åº”ç”¨è¿›ç¨‹ I/O å®Œæˆï¼Œè€Œä¿¡å·é©±åŠ¨ I/O çš„ä¿¡å·æ˜¯é€šçŸ¥åº”ç”¨è¿›ç¨‹å¯ä»¥å¼€å§‹ I/Oã€‚

![image-20220628221741472](./images/image-20220628221741472.png)

### â­BIO,NIO,AIO æœ‰ä»€ä¹ˆåŒºåˆ«

![image-20220615203937591](./images/image-20220615203937591.png)

> Java BIO[Blocking I/O] | åŒæ­¥é˜»å¡I/Oæ¨¡å¼

BIO å…¨ç§°Block-IO æ˜¯ä¸€ç§åŒæ­¥ä¸”é˜»å¡çš„é€šä¿¡æ¨¡å¼ã€‚æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¼ ç»Ÿçš„é€šä¿¡æ–¹å¼ï¼Œæ¨¡å¼ç®€å•ï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚ä½†å¹¶å‘å¤„ç†èƒ½åŠ›ä½ï¼Œé€šä¿¡è€—æ—¶ï¼Œä¾èµ–ç½‘é€Ÿ

> Java NIO[New I/O] | åŒæ­¥éé˜»å¡æ¨¡å¼

ä¼ ç»Ÿçš„NIOï¼š

åœ¨éé˜»å¡æ¨¡å¼ä¸­ï¼Œå‘å‡º Socket çš„ `accept()` å’Œ `read()` æ“ä½œæ—¶ï¼Œå¦‚æœå†…æ ¸ä¸­çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œé‚£ä¹ˆå®ƒå¹¶ä¸ä¼šé˜»å¡ç”¨æˆ·è¿›ç¨‹ï¼Œè€Œæ˜¯ç«‹åˆ»è¿”å›ä¸€ä¸ªä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´è¿›ç¨‹å‘èµ·ä¸€ä¸ª read æ“ä½œåï¼Œå¹¶ä¸éœ€è¦ä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œè€Œæ˜¯é©¬ä¸Šå°±å¾—åˆ°äº†ä¸€ä¸ªç»“æœã€‚ å¦‚æœç»“æœå‘ç°æ•°æ®å‡†å¤‡å®Œæ¯•å°±å¯ä»¥è¯»å–æ•°æ®ï¼Œç„¶åæ‹·è´åˆ°ç”¨æˆ·å†…å­˜ã€‚å¦‚æœç»“æœå‘ç°æ•°æ®æ²¡æœ‰å°±ç»ªä¹Ÿä¼šè¿”å›ï¼Œè¿›ç¨‹ç»§ç»­ä¸æ–­çš„ `ä¸»åŠ¨è¯¢é—®`æ•°æ®çš„å‡†å¤‡æƒ…å†µæ˜¯éé˜»å¡æ¨¡å¼çš„ä¸€ä¸ªç‰¹ç‚¹ã€‚

![image-20220622215041962](./images/image-20220622215041962.png)

* **æ•°æ®å‡†å¤‡é˜¶æ®µï¼š** åœ¨è¿™ä¸ªé˜¶æ®µï¼Œç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾ç½‘å¡ï¼Œé€šè¿‡ `DMA` çš„æ–¹å¼å°†æ•°æ®åŒ…æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œç„¶åç»è¿‡ç¡¬ä¸­æ–­ï¼Œè½¯ä¸­æ–­ï¼Œæ¥ç€é€šè¿‡å†…æ ¸çº¿ç¨‹ `ksoftirqd`ç»è¿‡å†…æ ¸åè®®æ ˆçš„å¤„ç†ï¼Œæœ€ç»ˆå°†æ•°æ®å‘é€åˆ° `å†…æ ¸Socket`çš„æ¥æ”¶ç¼“å†²åŒºä¸­
* **æ•°æ®æ‹·è´é˜¶æ®µï¼š** å½“æ•°æ®åˆ°è¾¾ `å†…æ ¸Socket`çš„æ¥æ”¶ç¼“å†²åŒºä¸­æ—¶ï¼Œæ­¤æ—¶æ•°æ®å­˜åœ¨äº `å†…æ ¸ç©ºé—´`ä¸­ï¼Œéœ€è¦å°†æ•°æ® `æ‹·è´`åˆ° `ç”¨æˆ·ç©ºé—´`ä¸­ï¼Œæ‰èƒ½å¤Ÿè¢«åº”ç”¨ç¨‹åºè¯»å–ã€‚

å¯ä»¥çœ‹ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ2016å¹´å†™çš„æ–‡ç« ï¼š[Java NIOæµ…æ](https://tech.meituan.com/2016/11/04/nio.html)

Java ä¸­çš„ NIO äº Java 1.4 ä¸­å¼•å…¥ï¼Œå¯¹åº” `java.nio` åŒ…ï¼Œæä¾›äº†Java NIOçš„å®ç°ä¸»è¦æ¶‰åŠä¸‰å¤§æ ¸å¿ƒå†…å®¹ï¼š `Channel` , `Selector`ï¼Œ`Buffer` ç­‰æŠ½è±¡ã€‚Selectorç”¨äºç›‘å¬å¤šä¸ªChannelçš„äº‹ä»¶ï¼Œæ¯”å¦‚è¿æ¥æ‰“å¼€æˆ–æ•°æ®åˆ°è¾¾ï¼Œå› æ­¤ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å®ç°å¯¹å¤šä¸ªæ•°æ®Channelçš„ç®¡ç†ã€‚ä¼ ç»ŸI/OåŸºäºæ•°æ®æµè¿›è¡ŒI/Oè¯»å†™æ“ä½œï¼›è€ŒJava NIOåŸºäºChannelå’ŒBufferè¿›è¡ŒI/Oè¯»å†™æ“ä½œï¼Œå¹¶ä¸”æ•°æ®æ€»æ˜¯è¢«ä»Channelè¯»å–åˆ°Bufferä¸­ï¼Œæˆ–è€…ä»Bufferå†™å…¥Channelä¸­ã€‚

Java ä¸­çš„ NIO å¯ä»¥çœ‹ä½œæ˜¯ **I/O å¤šè·¯å¤ç”¨æ¨¡å‹**ã€‚ä¹Ÿæœ‰å¾ˆå¤šäººè®¤ä¸ºï¼ŒJava ä¸­çš„ NIO å±äºåŒæ­¥éé˜»å¡ IO æ¨¡å‹ã€‚

![image-20220615204150338](./images/image-20220615204150338.png)

åŒæ­¥éé˜»å¡ IO æ¨¡å‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¼š**ä¸€ç›´å‘èµ· read è°ƒç”¨ï¼Œç­‰å¾…æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„è¿™æ®µæ—¶é—´é‡Œï¼Œçº¿ç¨‹ä¾ç„¶æ˜¯é˜»å¡çš„ï¼Œç›´åˆ°åœ¨å†…æ ¸æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´**ã€‚

ç›¸æ¯”äºåŒæ­¥é˜»å¡ IO æ¨¡å‹ï¼ŒåŒæ­¥éé˜»å¡ IO æ¨¡å‹ç¡®å®æœ‰äº†å¾ˆå¤§æ”¹è¿›ã€‚é€šè¿‡è½®è¯¢æ“ä½œï¼Œé¿å…äº†ä¸€ç›´é˜»å¡ã€‚

ä½†æ˜¯ï¼Œè¿™ç§ IO æ¨¡å‹åŒæ ·å­˜åœ¨é—®é¢˜ï¼š**åº”ç”¨ç¨‹åºä¸æ–­è¿›è¡Œ I/O ç³»ç»Ÿè°ƒç”¨è½®è¯¢æ•°æ®æ˜¯å¦å·²ç»å‡†å¤‡å¥½çš„è¿‡ç¨‹æ˜¯ååˆ†æ¶ˆè€— CPU èµ„æºçš„ã€‚**

è¿™ä¸ªæ—¶å€™ï¼Œ**I/O å¤šè·¯å¤ç”¨æ¨¡å‹** å°±ä¸Šåœºäº†ã€‚

![image-20220615204200618](./images/image-20220615204200618.png)

IO å¤šè·¯å¤ç”¨æ¨¡å‹ä¸­ï¼Œçº¿ç¨‹**é¦–å…ˆå‘èµ· select è°ƒç”¨ï¼Œè¯¢é—®å†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å°±ç»ª**ï¼Œç­‰å†…æ ¸æŠŠæ•°æ®å‡†å¤‡å¥½äº†ï¼Œç”¨æˆ·çº¿ç¨‹å†å‘èµ· read è°ƒç”¨ã€‚**read è°ƒç”¨çš„è¿‡ç¨‹ï¼ˆæ•°æ®ä»å†…æ ¸ç©ºé—´ -> ç”¨æˆ·ç©ºé—´ï¼‰è¿˜æ˜¯é˜»å¡çš„**ã€‚

> ç›®å‰æ”¯æŒ IO å¤šè·¯å¤ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæœ‰ selectï¼Œepoll ç­‰ç­‰ã€‚select ç³»ç»Ÿè°ƒç”¨ï¼Œç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿä¸Šéƒ½æœ‰æ”¯æŒã€‚
>
> - **select è°ƒç”¨** ï¼šå†…æ ¸æä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒæ”¯æŒä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªç³»ç»Ÿè°ƒç”¨çš„å¯ç”¨çŠ¶æ€ã€‚å‡ ä¹æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒã€‚
> - **epoll è°ƒç”¨** ï¼šlinux 2.6 å†…æ ¸ï¼Œå±äº select è°ƒç”¨çš„å¢å¼ºç‰ˆæœ¬ï¼Œä¼˜åŒ–äº† IO çš„æ‰§è¡Œæ•ˆç‡ã€‚

**IO å¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œé€šè¿‡å‡å°‘æ— æ•ˆçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå‡å°‘äº†å¯¹ CPU èµ„æºçš„æ¶ˆè€—ã€‚**

Java ä¸­çš„ NIO ï¼Œæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„**é€‰æ‹©å™¨ ( Selector )** çš„æ¦‚å¿µï¼Œä¹Ÿå¯ä»¥è¢«ç§°ä¸º **å¤šè·¯å¤ç”¨å™¨**ã€‚é€šè¿‡å®ƒï¼Œåªéœ€è¦ä¸€ä¸ªçº¿ç¨‹ä¾¿å¯ä»¥ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å½“å®¢æˆ·ç«¯æ•°æ®åˆ°äº†ä¹‹åï¼Œæ‰ä¼šä¸ºå…¶æœåŠ¡ã€‚

![image-20220615204212255](./images/image-20220615204212255.png)

> Java AIO[Asynchronous I/O] | å¼‚æ­¥éé˜»å¡I/Oæ¨¡å‹

AIO ä¹Ÿå°±æ˜¯ NIO 2ã€‚Java 7 ä¸­å¼•å…¥äº† NIO çš„æ”¹è¿›ç‰ˆ NIO 2,å®ƒæ˜¯å¼‚æ­¥ IO æ¨¡å‹ã€‚

å¼‚æ­¥ IO æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œã€‚

![image-20220615205139466](./images/image-20220615205139466.png)

ç›®å‰æ¥è¯´ AIO çš„åº”ç”¨è¿˜ä¸æ˜¯å¾ˆå¹¿æ³›ã€‚Netty ä¹‹å‰ä¹Ÿå°è¯•ä½¿ç”¨è¿‡ AIOï¼Œä¸è¿‡åˆæ”¾å¼ƒäº†ã€‚è¿™æ˜¯å› ä¸ºï¼ŒNetty ä½¿ç”¨äº† AIO ä¹‹åï¼Œåœ¨ Linux ç³»ç»Ÿä¸Šçš„æ€§èƒ½å¹¶æ²¡æœ‰å¤šå°‘æå‡ã€‚

æœ€åï¼Œæ¥ä¸€å¼ å›¾ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ Java ä¸­çš„ BIOã€NIOã€AIOã€‚

![image-20220615205148242](./images/image-20220615205148242.png)

### ğŸ’«I/O å¤šè·¯å¤ç”¨ï¼šselect/poll/epoll

#### æœ€åŸºæœ¬çš„ Socket æ¨¡å‹

è¦æƒ³å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨èƒ½åœ¨ç½‘ç»œä¸­é€šä¿¡ï¼Œé‚£å¿…é¡»å¾—ä½¿ç”¨ Socket  ç¼–ç¨‹ï¼Œå®ƒæ˜¯è¿›ç¨‹é—´é€šä¿¡é‡Œæ¯”è¾ƒç‰¹åˆ«çš„æ–¹å¼ï¼Œç‰¹åˆ«ä¹‹å¤„åœ¨äºå®ƒæ˜¯å¯ä»¥è·¨ä¸»æœºé—´é€šä¿¡ã€‚

Socket  çš„ä¸­æ–‡åå«ä½œæ’å£ï¼Œå’‹ä¸€çœ‹è¿˜æŒºè¿·æƒ‘çš„ã€‚äº‹å®ä¸Šï¼ŒåŒæ–¹è¦è¿›è¡Œç½‘ç»œé€šä¿¡å‰ï¼Œå„è‡ªå¾—åˆ›å»ºä¸€ä¸ª  Socketï¼Œè¿™ç›¸å½“äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½å¼€äº†ä¸€ä¸ªâ€œå£å­â€ï¼ŒåŒæ–¹è¯»å–å’Œå‘é€æ•°æ®çš„æ—¶å€™ï¼Œéƒ½é€šè¿‡è¿™ä¸ªâ€œå£å­â€ã€‚è¿™æ ·ä¸€çœ‹ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—å¾ˆåƒå¼„äº†ä¸€æ ¹ç½‘çº¿ï¼Œä¸€å¤´æ’åœ¨å®¢æˆ·ç«¯ï¼Œä¸€å¤´æ’åœ¨æœåŠ¡ç«¯ï¼Œç„¶åè¿›è¡Œé€šä¿¡ã€‚

åˆ›å»º Socket çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šç½‘ç»œå±‚ä½¿ç”¨çš„æ˜¯ IPv4 è¿˜æ˜¯ IPv6ï¼Œä¼ è¾“å±‚ä½¿ç”¨çš„æ˜¯ TCP è¿˜æ˜¯ UDPã€‚

UDP çš„ Socket ç¼–ç¨‹ç›¸å¯¹ç®€å•äº›ï¼Œè¿™é‡Œæˆ‘ä»¬åªä»‹ç»åŸºäº TCP çš„ Socket ç¼–ç¨‹ã€‚

æœåŠ¡å™¨çš„ç¨‹åºè¦å…ˆè·‘èµ·æ¥ï¼Œç„¶åç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥å’Œæ•°æ®ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æœåŠ¡ç«¯çš„ Socket ç¼–ç¨‹è¿‡ç¨‹æ˜¯æ€æ ·çš„ã€‚

æœåŠ¡ç«¯é¦–å…ˆè°ƒç”¨ `socket()` å‡½æ•°ï¼Œåˆ›å»ºç½‘ç»œåè®®ä¸º IPv4ï¼Œä»¥åŠä¼ è¾“åè®®ä¸º TCP çš„ Socket ï¼Œæ¥ç€è°ƒç”¨ `bind()` å‡½æ•°ï¼Œç»™è¿™ä¸ª Socket ç»‘å®šä¸€ä¸ª **IP åœ°å€å’Œç«¯å£**ï¼Œç»‘å®šè¿™ä¸¤ä¸ªçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ

- ç»‘å®šç«¯å£çš„ç›®çš„ï¼šå½“å†…æ ¸æ”¶åˆ° TCP æŠ¥æ–‡ï¼Œé€šè¿‡ TCP å¤´é‡Œé¢çš„ç«¯å£å·ï¼Œæ¥æ‰¾åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œç„¶åæŠŠæ•°æ®ä¼ é€’ç»™æˆ‘ä»¬ã€‚
- ç»‘å®š IP åœ°å€çš„ç›®çš„ï¼šä¸€å°æœºå™¨æ˜¯å¯ä»¥æœ‰å¤šä¸ªç½‘å¡çš„ï¼Œæ¯ä¸ªç½‘å¡éƒ½æœ‰å¯¹åº”çš„ IP åœ°å€ï¼Œå½“ç»‘å®šä¸€ä¸ªç½‘å¡æ—¶ï¼Œå†…æ ¸åœ¨æ”¶åˆ°è¯¥ç½‘å¡ä¸Šçš„åŒ…ï¼Œæ‰ä¼šå‘ç»™æˆ‘ä»¬ï¼›

ç»‘å®šå®Œ IP åœ°å€å’Œç«¯å£åï¼Œå°±å¯ä»¥è°ƒç”¨ `listen()` å‡½æ•°è¿›è¡Œç›‘å¬ï¼Œæ­¤æ—¶å¯¹åº” TCP çŠ¶æ€å›¾ä¸­çš„ `listen`ï¼Œå¦‚æœæˆ‘ä»¬è¦åˆ¤å®šæœåŠ¡å™¨ä¸­ä¸€ä¸ªç½‘ç»œç¨‹åºæœ‰æ²¡æœ‰å¯åŠ¨ï¼Œå¯ä»¥é€šè¿‡ `netstat` å‘½ä»¤æŸ¥çœ‹å¯¹åº”çš„ç«¯å£å·æ˜¯å¦æœ‰è¢«ç›‘å¬ã€‚

æœåŠ¡ç«¯è¿›å…¥äº†ç›‘å¬çŠ¶æ€åï¼Œé€šè¿‡è°ƒç”¨ `accept()` å‡½æ•°ï¼Œæ¥ä»å†…æ ¸è·å–å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆ™ä¼šé˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥çš„åˆ°æ¥ã€‚

é‚£å®¢æˆ·ç«¯æ˜¯æ€ä¹ˆå‘èµ·è¿æ¥çš„å‘¢ï¼Ÿå®¢æˆ·ç«¯åœ¨åˆ›å»ºå¥½ Socket åï¼Œè°ƒç”¨ `connect()` å‡½æ•°å‘èµ·è¿æ¥ï¼Œè¯¥å‡½æ•°çš„å‚æ•°è¦æŒ‡æ˜æœåŠ¡ç«¯çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œç„¶åä¸‡ä¼—æœŸå¾…çš„ TCP ä¸‰æ¬¡æ¡æ‰‹å°±å¼€å§‹äº†ã€‚

åœ¨  TCP è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡å™¨çš„å†…æ ¸å®é™…ä¸Šä¸ºæ¯ä¸ª Socket ç»´æŠ¤äº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼š

- ä¸€ä¸ªæ˜¯è¿˜æ²¡å®Œå…¨å»ºç«‹è¿æ¥çš„é˜Ÿåˆ—ï¼Œç§°ä¸º **TCP åŠè¿æ¥é˜Ÿåˆ—**ï¼Œè¿™ä¸ªé˜Ÿåˆ—éƒ½æ˜¯æ²¡æœ‰å®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å¤„äº `syn_rcvd` çš„çŠ¶æ€ï¼›
- ä¸€ä¸ªæ˜¯ä¸€ä»¶å»ºç«‹è¿æ¥çš„é˜Ÿåˆ—ï¼Œç§°ä¸º **TCP å…¨è¿æ¥é˜Ÿåˆ—**ï¼Œè¿™ä¸ªé˜Ÿåˆ—éƒ½æ˜¯å®Œæˆäº†ä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å¤„äº `established` çŠ¶æ€ï¼›

å½“ TCP å…¨è¿æ¥é˜Ÿåˆ—ä¸ä¸ºç©ºåï¼ŒæœåŠ¡ç«¯çš„ `accept()` å‡½æ•°ï¼Œå°±ä¼šä»å†…æ ¸ä¸­çš„ TCP å…¨è¿æ¥é˜Ÿåˆ—é‡Œæ‹¿å‡ºä¸€ä¸ªå·²ç»å®Œæˆè¿æ¥çš„  Socket è¿”å›åº”ç”¨ç¨‹åºï¼Œåç»­æ•°æ®ä¼ è¾“éƒ½ç”¨è¿™ä¸ª Socketã€‚

æ³¨æ„ï¼Œç›‘å¬çš„ Socket å’ŒçœŸæ­£ç”¨æ¥ä¼ æ•°æ®çš„ Socket æ˜¯ä¸¤ä¸ªï¼š

- ä¸€ä¸ªå«ä½œ**ç›‘å¬ Socket**ï¼›
- ä¸€ä¸ªå«ä½œ**å·²è¿æ¥ Socket**ï¼›

è¿æ¥å»ºç«‹åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±å¼€å§‹ç›¸äº’ä¼ è¾“æ•°æ®äº†ï¼ŒåŒæ–¹éƒ½å¯ä»¥é€šè¿‡ `read()` å’Œ `write()` å‡½æ•°æ¥è¯»å†™æ•°æ®ã€‚

è‡³æ­¤ï¼Œ TCP åè®®çš„ Socket ç¨‹åºçš„è°ƒç”¨è¿‡ç¨‹å°±ç»“æŸäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![image-20220717162534775](./images/image-20220717162534775.png)

çœ‹åˆ°è¿™ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰è§‰å¾—è¯»å†™ Socket  çš„æ–¹å¼ï¼Œå¥½åƒè¯»å†™æ–‡ä»¶ä¸€æ ·ã€‚

æ˜¯çš„ï¼ŒåŸºäº Linux ä¸€åˆ‡çš†æ–‡ä»¶çš„ç†å¿µï¼Œåœ¨å†…æ ¸ä¸­ Socket ä¹Ÿæ˜¯ä»¥ã€Œæ–‡ä»¶ã€çš„å½¢å¼å­˜åœ¨çš„ï¼Œä¹Ÿæ˜¯æœ‰å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚

> PS : ä¸‹é¢ä¼šè¯´åˆ°å†…æ ¸é‡Œçš„æ•°æ®ç»“æ„ï¼Œä¸æ„Ÿå…´è¶£çš„å¯ä»¥è·³è¿‡è¿™ä¸€éƒ¨åˆ†ï¼Œä¸ä¼šå¯¹åç»­çš„å†…å®¹æœ‰å½±å“ã€‚

æ–‡ä»¶æè¿°ç¬¦çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªæ•°æ®ç»“æ„ `task_struct`ï¼Œè¯¥ç»“æ„ä½“é‡Œæœ‰ä¸€ä¸ªæŒ‡å‘ã€Œæ–‡ä»¶æè¿°ç¬¦æ•°ç»„ã€çš„æˆå‘˜æŒ‡é’ˆã€‚è¯¥æ•°ç»„é‡Œåˆ—å‡ºè¿™ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚æ•°ç»„çš„ä¸‹æ ‡æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œæ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œè€Œæ•°ç»„çš„å†…å®¹æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å†…æ ¸ä¸­æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶çš„åˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´å†…æ ¸å¯ä»¥é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ‰¾åˆ°å¯¹åº”æ‰“å¼€çš„æ–‡ä»¶ã€‚

ç„¶åæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª inodeï¼ŒSocket æ–‡ä»¶çš„ inode æŒ‡å‘äº†å†…æ ¸ä¸­çš„ Socket ç»“æ„ï¼Œåœ¨è¿™ä¸ªç»“æ„ä½“é‡Œæœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œåˆ†åˆ«æ˜¯**å‘é€é˜Ÿåˆ—**å’Œ**æ¥æ”¶é˜Ÿåˆ—**ï¼Œè¿™ä¸ªä¸¤ä¸ªé˜Ÿåˆ—é‡Œé¢ä¿å­˜çš„æ˜¯ä¸€ä¸ªä¸ª `struct sk_buff`ï¼Œç”¨é“¾è¡¨çš„ç»„ç»‡å½¢å¼ä¸²èµ·æ¥ã€‚

sk_buff å¯ä»¥è¡¨ç¤ºå„ä¸ªå±‚çš„æ•°æ®åŒ…ï¼Œåœ¨åº”ç”¨å±‚æ•°æ®åŒ…å« dataï¼Œåœ¨ TCP å±‚æˆ‘ä»¬ç§°ä¸º segmentï¼Œåœ¨ IP å±‚æˆ‘ä»¬å« packetï¼Œåœ¨æ•°æ®é“¾è·¯å±‚ç§°ä¸º frameã€‚

ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆå…¨éƒ¨æ•°æ®åŒ…åªç”¨ä¸€ä¸ªç»“æ„ä½“æ¥æè¿°å‘¢ï¼Ÿåè®®æ ˆé‡‡ç”¨çš„æ˜¯åˆ†å±‚ç»“æ„ï¼Œä¸Šå±‚å‘ä¸‹å±‚ä¼ é€’æ•°æ®æ—¶éœ€è¦å¢åŠ åŒ…å¤´ï¼Œä¸‹å±‚å‘ä¸Šå±‚æ•°æ®æ—¶åˆéœ€è¦å»æ‰åŒ…å¤´ï¼Œå¦‚æœæ¯ä¸€å±‚éƒ½ç”¨ä¸€ä¸ªç»“æ„ä½“ï¼Œé‚£åœ¨å±‚ä¹‹é—´ä¼ é€’æ•°æ®çš„æ—¶å€™ï¼Œå°±è¦å‘ç”Ÿå¤šæ¬¡æ‹·è´ï¼Œè¿™å°†å¤§å¤§é™ä½ CPU æ•ˆç‡ã€‚

äºæ˜¯ï¼Œä¸ºäº†åœ¨å±‚çº§ä¹‹é—´ä¼ é€’æ•°æ®æ—¶ï¼Œä¸å‘ç”Ÿæ‹·è´ï¼Œåªç”¨ sk_buff ä¸€ä¸ªç»“æ„ä½“æ¥æè¿°æ‰€æœ‰çš„ç½‘ç»œåŒ…ï¼Œé‚£å®ƒæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿæ˜¯é€šè¿‡è°ƒæ•´ sk_buff ä¸­ `data` çš„æŒ‡é’ˆï¼Œæ¯”å¦‚ï¼š

- å½“æ¥æ”¶æŠ¥æ–‡æ—¶ï¼Œä»ç½‘å¡é©±åŠ¨å¼€å§‹ï¼Œé€šè¿‡åè®®æ ˆå±‚å±‚å¾€ä¸Šä¼ é€æ•°æ®æŠ¥ï¼Œé€šè¿‡å¢åŠ  skb->data çš„å€¼ï¼Œæ¥é€æ­¥å‰¥ç¦»åè®®é¦–éƒ¨ã€‚
- å½“è¦å‘é€æŠ¥æ–‡æ—¶ï¼Œåˆ›å»º sk_buff ç»“æ„ä½“ï¼Œæ•°æ®ç¼“å­˜åŒºçš„å¤´éƒ¨é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´ï¼Œç”¨æ¥å¡«å……å„å±‚é¦–éƒ¨ï¼Œåœ¨ç»è¿‡å„ä¸‹å±‚åè®®æ—¶ï¼Œé€šè¿‡å‡å°‘ skb->data çš„å€¼æ¥å¢åŠ åè®®é¦–éƒ¨ã€‚

ä½ å¯ä»¥ä»ä¸‹é¢è¿™å¼ å›¾çœ‹åˆ°ï¼Œå½“å‘é€æŠ¥æ–‡æ—¶ï¼Œdata æŒ‡é’ˆçš„ç§»åŠ¨è¿‡ç¨‹ã€‚

![image-20220717161851452](./images/image-20220717161851452.png)

#### å¦‚ä½•æœåŠ¡æ›´å¤šçš„ç”¨æˆ·ï¼Ÿ

å‰é¢æåˆ°çš„ TCP Socket è°ƒç”¨æµç¨‹æ˜¯æœ€ç®€å•ã€æœ€åŸºæœ¬çš„ï¼Œå®ƒåŸºæœ¬åªèƒ½ä¸€å¯¹ä¸€é€šä¿¡ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯åŒæ­¥é˜»å¡çš„æ–¹å¼ï¼Œå½“æœåŠ¡ç«¯åœ¨è¿˜æ²¡å¤„ç†å®Œä¸€ä¸ªå®¢æˆ·ç«¯çš„ç½‘ç»œ I/O æ—¶ï¼Œæˆ–è€… è¯»å†™æ“ä½œå‘ç”Ÿé˜»å¡æ—¶ï¼Œå…¶ä»–å®¢æˆ·ç«¯æ˜¯æ— æ³•ä¸æœåŠ¡ç«¯è¿æ¥çš„ã€‚

å¯å¦‚æœæˆ‘ä»¬æœåŠ¡å™¨åªèƒ½æœåŠ¡ä¸€ä¸ªå®¢æˆ·ï¼Œé‚£è¿™æ ·å°±å¤ªæµªè´¹èµ„æºäº†ï¼Œäºæ˜¯æˆ‘ä»¬è¦æ”¹è¿›è¿™ä¸ªç½‘ç»œ I/O æ¨¡å‹ï¼Œä»¥æ”¯æŒæ›´å¤šçš„å®¢æˆ·ç«¯ã€‚

åœ¨æ”¹è¿›ç½‘ç»œ I/O æ¨¡å‹å‰ï¼Œæˆ‘å…ˆæ¥æä¸€ä¸ªé—®é¢˜ï¼Œä½ çŸ¥é“æœåŠ¡å™¨å•æœºç†è®ºæœ€å¤§èƒ½è¿æ¥å¤šå°‘ä¸ªå®¢æˆ·ç«¯ï¼Ÿ

ç›¸ä¿¡ä½ çŸ¥é“ TCP è¿æ¥æ˜¯ç”±å››å…ƒç»„å”¯ä¸€ç¡®è®¤çš„ï¼Œè¿™ä¸ªå››å…ƒç»„å°±æ˜¯ï¼š**æœ¬æœºIP, æœ¬æœºç«¯å£, å¯¹ç«¯IP, å¯¹ç«¯ç«¯å£**ã€‚

æœåŠ¡å™¨ä½œä¸ºæœåŠ¡æ–¹ï¼Œé€šå¸¸ä¼šåœ¨æœ¬åœ°å›ºå®šç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚å› æ­¤æœåŠ¡å™¨çš„æœ¬åœ° IP å’Œç«¯å£æ˜¯å›ºå®šçš„ï¼Œäºæ˜¯å¯¹äºæœåŠ¡ç«¯ TCP è¿æ¥çš„å››å…ƒç»„åªæœ‰å¯¹ç«¯ IP å’Œç«¯å£æ˜¯ä¼šå˜åŒ–çš„ï¼Œæ‰€ä»¥**æœ€å¤§ TCP è¿æ¥æ•° = å®¢æˆ·ç«¯ IP æ•°Ã—å®¢æˆ·ç«¯ç«¯å£æ•°**ã€‚

å¯¹äº IPv4ï¼Œå®¢æˆ·ç«¯çš„ IP æ•°æœ€å¤šä¸º 2 çš„ 32 æ¬¡æ–¹ï¼Œå®¢æˆ·ç«¯çš„ç«¯å£æ•°æœ€å¤šä¸º 2 çš„ 16 æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯**æœåŠ¡ç«¯å•æœºæœ€å¤§ TCP è¿æ¥æ•°çº¦ä¸º 2 çš„ 48 æ¬¡æ–¹**ã€‚

è¿™ä¸ªç†è®ºå€¼ç›¸å½“â€œä¸°æ»¡â€ï¼Œä½†æ˜¯æœåŠ¡å™¨è‚¯å®šæ‰¿è½½ä¸äº†é‚£ä¹ˆå¤§çš„è¿æ¥æ•°ï¼Œä¸»è¦ä¼šå—ä¸¤ä¸ªæ–¹é¢çš„é™åˆ¶ï¼š

- **æ–‡ä»¶æè¿°ç¬¦**ï¼ŒSocket å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±ä¼šå¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚åœ¨ Linux ä¸‹ï¼Œå•ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œæ²¡æœ‰ç»è¿‡ä¿®æ”¹çš„å€¼ä¸€èˆ¬éƒ½æ˜¯ 1024ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡ ulimit å¢å¤§æ–‡ä»¶æè¿°ç¬¦çš„æ•°ç›®ï¼›
- **ç³»ç»Ÿå†…å­˜**ï¼Œæ¯ä¸ª TCP è¿æ¥åœ¨å†…æ ¸ä¸­éƒ½æœ‰å¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œæ„å‘³ç€æ¯ä¸ªè¿æ¥éƒ½æ˜¯ä¼šå ç”¨ä¸€å®šå†…å­˜çš„ï¼›

é‚£å¦‚æœæœåŠ¡å™¨çš„å†…å­˜åªæœ‰ 2 GBï¼Œç½‘å¡æ˜¯åƒå…†çš„ï¼Œèƒ½æ”¯æŒå¹¶å‘ 1 ä¸‡è¯·æ±‚å—ï¼Ÿ

å¹¶å‘ 1 ä¸‡è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ç»å…¸çš„ C10K é—®é¢˜ ï¼ŒC æ˜¯ Client å•è¯é¦–å­—æ¯ç¼©å†™ï¼ŒC10K å°±æ˜¯å•æœºåŒæ—¶å¤„ç† 1 ä¸‡ä¸ªè¯·æ±‚çš„é—®é¢˜ã€‚

ä»ç¡¬ä»¶èµ„æºè§’åº¦çœ‹ï¼Œå¯¹äº 2GB å†…å­˜åƒå…†ç½‘å¡çš„æœåŠ¡å™¨ï¼Œå¦‚æœæ¯ä¸ªè¯·æ±‚å¤„ç†å ç”¨ä¸åˆ° 200KB çš„å†…å­˜å’Œ 100Kbit çš„ç½‘ç»œå¸¦å®½å°±å¯ä»¥æ»¡è¶³å¹¶å‘ 1 ä¸‡ä¸ªè¯·æ±‚ã€‚

ä¸è¿‡ï¼Œè¦æƒ³çœŸæ­£å®ç° C10K çš„æœåŠ¡å™¨ï¼Œè¦è€ƒè™‘çš„åœ°æ–¹åœ¨äºæœåŠ¡å™¨çš„ç½‘ç»œ I/O æ¨¡å‹ï¼Œæ•ˆç‡ä½çš„æ¨¡å‹ï¼Œä¼šåŠ é‡ç³»ç»Ÿå¼€é”€ï¼Œä»è€Œä¼šç¦» C10K çš„ç›®æ ‡è¶Šæ¥è¶Šè¿œã€‚

#### å¤šè¿›ç¨‹æ¨¡å‹

åŸºäºæœ€åŸå§‹çš„é˜»å¡ç½‘ç»œ I/Oï¼Œ å¦‚æœæœåŠ¡å™¨è¦æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯ï¼Œå…¶ä¸­æ¯”è¾ƒä¼ ç»Ÿçš„æ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨**å¤šè¿›ç¨‹æ¨¡å‹**ï¼Œä¹Ÿå°±æ˜¯ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…ä¸€ä¸ªè¿›ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚

æœåŠ¡å™¨çš„ä¸»è¿›ç¨‹è´Ÿè´£ç›‘å¬å®¢æˆ·çš„è¿æ¥ï¼Œä¸€æ—¦ä¸å®¢æˆ·ç«¯è¿æ¥å®Œæˆï¼Œaccept() å‡½æ•°å°±ä¼šè¿”å›ä¸€ä¸ªã€Œå·²è¿æ¥ Socketã€ï¼Œè¿™æ—¶å°±é€šè¿‡ `fork()` å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå®é™…ä¸Šå°±æŠŠçˆ¶è¿›ç¨‹æ‰€æœ‰ç›¸å…³çš„ä¸œè¥¿éƒ½**å¤åˆ¶**ä¸€ä»½ï¼ŒåŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜åœ°å€ç©ºé—´ã€ç¨‹åºè®¡æ•°å™¨ã€æ‰§è¡Œçš„ä»£ç ç­‰ã€‚

è¿™ä¸¤ä¸ªè¿›ç¨‹åˆšå¤åˆ¶å®Œçš„æ—¶å€™ï¼Œå‡ ä¹ä¸€æ‘¸ä¸€æ ·ã€‚ä¸è¿‡ï¼Œä¼šæ ¹æ®**è¿”å›å€¼**æ¥åŒºåˆ†æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ï¼Œå¦‚æœè¿”å›å€¼æ˜¯ 0ï¼Œåˆ™æ˜¯å­è¿›ç¨‹ï¼›å¦‚æœè¿”å›å€¼æ˜¯å…¶ä»–çš„æ•´æ•°ï¼Œå°±æ˜¯çˆ¶è¿›ç¨‹ã€‚

æ­£å› ä¸ºå­è¿›ç¨‹ä¼š**å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦**ï¼Œäºæ˜¯å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€Œå·²è¿æ¥ Socket ã€å’Œå®¢æˆ·ç«¯é€šä¿¡äº†ï¼Œ

å¯ä»¥å‘ç°ï¼Œå­è¿›ç¨‹ä¸éœ€è¦å…³å¿ƒã€Œç›‘å¬ Socketã€ï¼Œåªéœ€è¦å…³å¿ƒã€Œå·²è¿æ¥ Socketã€ï¼›çˆ¶è¿›ç¨‹åˆ™ç›¸åï¼Œå°†å®¢æˆ·æœåŠ¡äº¤ç»™å­è¿›ç¨‹æ¥å¤„ç†ï¼Œå› æ­¤çˆ¶è¿›ç¨‹ä¸éœ€è¦å…³å¿ƒã€Œå·²è¿æ¥ Socketã€ï¼Œåªéœ€è¦å…³å¿ƒã€Œç›‘å¬ Socketã€ã€‚

ä¸‹é¢è¿™å¼ å›¾æè¿°äº†ä»è¿æ¥è¯·æ±‚åˆ°è¿æ¥å»ºç«‹ï¼Œçˆ¶è¿›ç¨‹åˆ›å»ºç”Ÿå­è¿›ç¨‹ä¸ºå®¢æˆ·æœåŠ¡ã€‚

![image-20220717163910297](./images/image-20220717163910297.png)

å¦å¤–ï¼Œå½“ã€Œå­è¿›ç¨‹ã€é€€å‡ºæ—¶ï¼Œå®é™…ä¸Šå†…æ ¸é‡Œè¿˜ä¼šä¿ç•™è¯¥è¿›ç¨‹çš„ä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿæ˜¯ä¼šå ç”¨å†…å­˜çš„ï¼Œå¦‚æœä¸åšå¥½â€œå›æ”¶â€å·¥ä½œï¼Œå°±ä¼šå˜æˆ**åƒµå°¸è¿›ç¨‹**ï¼Œéšç€åƒµå°¸è¿›ç¨‹è¶Šå¤šï¼Œä¼šæ…¢æ…¢è€—å°½æˆ‘ä»¬çš„ç³»ç»Ÿèµ„æºã€‚

> ä¸€ä¸ªå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦åœ¨å­è¿›ç¨‹é€€å‡ºæ—¶ä¸ä¼šé‡Šæ”¾ï¼Œåªæœ‰å½“çˆ¶è¿›ç¨‹é€šè¿‡ wait() æˆ– waitpid() è·å–äº†å­è¿›ç¨‹ä¿¡æ¯åæ‰ä¼šé‡Šæ”¾ã€‚å¦‚æœå­è¿›ç¨‹é€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨ wait() æˆ– waitpid()ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­ï¼Œè¿™ç§è¿›ç¨‹ç§°ä¹‹ä¸ºåƒµå°¸è¿›ç¨‹ã€‚

å› æ­¤ï¼Œçˆ¶è¿›ç¨‹è¦â€œå–„åâ€å¥½è‡ªå·±çš„å­©å­ï¼Œæ€ä¹ˆå–„åå‘¢ï¼Ÿé‚£ä¹ˆæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥åœ¨å­è¿›ç¨‹é€€å‡ºåå›æ”¶èµ„æºï¼Œåˆ†åˆ«æ˜¯è°ƒç”¨ `wait()` å’Œ `waitpid()` å‡½æ•°ã€‚

è¿™ç§ç”¨å¤šä¸ªè¿›ç¨‹æ¥åº”ä»˜å¤šä¸ªå®¢æˆ·ç«¯çš„æ–¹å¼ï¼Œåœ¨åº”å¯¹ 100 ä¸ªå®¢æˆ·ç«¯è¿˜æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å½“å®¢æˆ·ç«¯æ•°é‡é«˜è¾¾ä¸€ä¸‡æ—¶ï¼Œè‚¯å®šæ‰›ä¸ä½çš„ï¼Œå› ä¸ºæ¯äº§ç”Ÿä¸€ä¸ªè¿›ç¨‹ï¼Œå¿…ä¼šå æ®ä¸€å®šçš„ç³»ç»Ÿèµ„æºï¼Œè€Œä¸”è¿›ç¨‹é—´ä¸Šä¸‹æ–‡åˆ‡æ¢çš„â€œåŒ…è¢±â€æ˜¯å¾ˆé‡çš„ï¼Œæ€§èƒ½ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚

è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸ä»…åŒ…å«äº†è™šæ‹Ÿå†…å­˜ã€æ ˆã€å…¨å±€å˜é‡ç­‰ç”¨æˆ·ç©ºé—´çš„èµ„æºï¼Œè¿˜åŒ…æ‹¬äº†å†…æ ¸å †æ ˆã€å¯„å­˜å™¨ç­‰å†…æ ¸ç©ºé—´çš„èµ„æºã€‚

#### å¤šçº¿ç¨‹æ¨¡å‹

æ—¢ç„¶è¿›ç¨‹é—´ä¸Šä¸‹æ–‡åˆ‡æ¢çš„â€œåŒ…è¢±â€å¾ˆé‡ï¼Œé‚£æˆ‘ä»¬å°±æä¸ªæ¯”è¾ƒè½»é‡çº§çš„æ¨¡å‹æ¥åº”å¯¹å¤šç”¨æˆ·çš„è¯·æ±‚ â€”â€” **å¤šçº¿ç¨‹æ¨¡å‹**ã€‚

çº¿ç¨‹æ˜¯è¿è¡Œåœ¨è¿›ç¨‹ä¸­çš„ä¸€ä¸ªâ€œé€»è¾‘æµâ€ï¼Œå•è¿›ç¨‹ä¸­å¯ä»¥è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼ŒåŒè¿›ç¨‹é‡Œçš„çº¿ç¨‹å¯ä»¥å…±äº«è¿›ç¨‹çš„éƒ¨åˆ†èµ„æºçš„ï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ã€è¿›ç¨‹ç©ºé—´ã€ä»£ç ã€å…¨å±€æ•°æ®ã€å †ã€å…±äº«åº“ç­‰ï¼Œè¿™äº›å…±äº«äº›èµ„æºåœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶æ˜¯ä¸éœ€è¦åˆ‡æ¢ï¼Œè€Œåªéœ€è¦åˆ‡æ¢çº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€å¯„å­˜å™¨ç­‰ä¸å…±äº«çš„æ•°æ®ï¼Œå› æ­¤åŒä¸€ä¸ªè¿›ç¨‹ä¸‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€è¦æ¯”è¿›ç¨‹å°å¾—å¤šã€‚

å½“æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ TCP å®Œæˆè¿æ¥åï¼Œé€šè¿‡ `pthread_create()` å‡½æ•°åˆ›å»ºçº¿ç¨‹ï¼Œç„¶åå°†ã€Œå·²è¿æ¥ Socketã€çš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™çº¿ç¨‹å‡½æ•°ï¼Œæ¥ç€åœ¨çº¿ç¨‹é‡Œå’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œä»è€Œè¾¾åˆ°å¹¶å‘å¤„ç†çš„ç›®çš„ã€‚

å¦‚æœæ¯æ¥ä¸€ä¸ªè¿æ¥å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹è¿è¡Œå®Œåï¼Œè¿˜å¾—æ“ä½œç³»ç»Ÿè¿˜å¾—é”€æ¯çº¿ç¨‹ï¼Œè™½è¯´çº¿ç¨‹åˆ‡æ¢çš„ä¸Šå†™æ–‡å¼€é”€ä¸å¤§ï¼Œä½†æ˜¯å¦‚æœé¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œç³»ç»Ÿå¼€é”€ä¹Ÿæ˜¯ä¸å°çš„ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨**çº¿ç¨‹æ± **çš„æ–¹å¼æ¥é¿å…çº¿ç¨‹çš„é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ï¼Œæ‰€è°“çš„çº¿ç¨‹æ± ï¼Œå°±æ˜¯æå‰åˆ›å»ºè‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·å½“ç”±æ–°è¿æ¥å»ºç«‹æ—¶ï¼Œå°†è¿™ä¸ªå·²è¿æ¥çš„ Socket æ”¾å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œç„¶åçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹è´Ÿè´£ä»é˜Ÿåˆ—ä¸­å–å‡ºå·²è¿æ¥ Socket è¿›ç¨‹å¤„ç†ã€‚

![image-20220717163933495](./images/image-20220717163933495.png)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯å…¨å±€çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ“ä½œï¼Œä¸ºäº†é¿å…å¤šçº¿ç¨‹ç«äº‰ï¼Œçº¿ç¨‹åœ¨æ“ä½œè¿™ä¸ªé˜Ÿåˆ—å‰è¦åŠ é”ã€‚

ä¸Šé¢åŸºäºè¿›ç¨‹æˆ–è€…çº¿ç¨‹æ¨¡å‹çš„ï¼Œå…¶å®è¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚æ–°åˆ°æ¥ä¸€ä¸ª TCP è¿æ¥ï¼Œå°±éœ€è¦åˆ†é…ä¸€ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œé‚£ä¹ˆå¦‚æœè¦è¾¾åˆ° C10Kï¼Œæ„å‘³ç€è¦ä¸€å°æœºå™¨ç»´æŠ¤ 1 ä¸‡ä¸ªè¿æ¥ï¼Œç›¸å½“äºè¦ç»´æŠ¤ 1 ä¸‡ä¸ªè¿›ç¨‹/çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿå°±ç®—æ­»æ‰›ä¹Ÿæ˜¯æ‰›ä¸ä½çš„ã€‚

#### I/O å¤šè·¯å¤ç”¨

æ—¢ç„¶ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹çš„æ–¹å¼ä¸åˆé€‚ï¼Œé‚£æœ‰æ²¡æœ‰å¯èƒ½åªä½¿ç”¨ä¸€ä¸ªè¿›ç¨‹æ¥ç»´æŠ¤å¤šä¸ª Socket å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œé‚£å°±æ˜¯ **I/O å¤šè·¯å¤ç”¨**æŠ€æœ¯ã€‚

![image-20220717165055763](./images/image-20220717165055763.png)

ä¸€ä¸ªè¿›ç¨‹è™½ç„¶ä»»ä¸€æ—¶åˆ»åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯å¤„ç†æ¯ä¸ªè¯·æ±‚çš„äº‹ä»¶æ—¶ï¼Œè€—æ—¶æ§åˆ¶åœ¨ 1 æ¯«ç§’ä»¥å†…ï¼Œè¿™æ · 1 ç§’å†…å°±å¯ä»¥å¤„ç†ä¸Šåƒä¸ªè¯·æ±‚ï¼ŒæŠŠæ—¶é—´æ‹‰é•¿æ¥çœ‹ï¼Œå¤šä¸ªè¯·æ±‚å¤ç”¨äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™å°±æ˜¯å¤šè·¯å¤ç”¨ï¼Œè¿™ç§æ€æƒ³å¾ˆç±»ä¼¼ä¸€ä¸ª CPU å¹¶å‘å¤šä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥ä¹Ÿå«åšæ—¶åˆ†å¤šè·¯å¤ç”¨ã€‚

æˆ‘ä»¬ç†Ÿæ‚‰çš„ select/poll/epoll å†…æ ¸æä¾›ç»™ç”¨æˆ·æ€çš„å¤šè·¯å¤ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œ**è¿›ç¨‹å¯ä»¥é€šè¿‡ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ä»å†…æ ¸ä¸­è·å–å¤šä¸ªäº‹ä»¶**ã€‚

select/poll/epoll æ˜¯å¦‚ä½•è·å–ç½‘ç»œäº‹ä»¶çš„å‘¢ï¼Ÿåœ¨è·å–äº‹ä»¶æ—¶ï¼Œå…ˆæŠŠæ‰€æœ‰è¿æ¥ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ä¼ ç»™å†…æ ¸ï¼Œå†ç”±å†…æ ¸è¿”å›äº§ç”Ÿäº†äº‹ä»¶çš„è¿æ¥ï¼Œç„¶ååœ¨ç”¨æˆ·æ€ä¸­å†å¤„ç†è¿™äº›è¿æ¥å¯¹åº”çš„è¯·æ±‚å³å¯ã€‚

select/poll/epoll è¿™æ˜¯ä¸‰ä¸ªå¤šè·¯å¤ç”¨æ¥å£ï¼Œéƒ½èƒ½å®ç° C10K å—ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«è¯´è¯´å®ƒä»¬ã€‚

#### select/poll

select å®ç°å¤šè·¯å¤ç”¨çš„æ–¹å¼æ˜¯ï¼Œå°†å·²è¿æ¥çš„ Socket éƒ½æ”¾åˆ°ä¸€ä¸ª**æ–‡ä»¶æè¿°ç¬¦é›†åˆ**ï¼Œç„¶åè°ƒç”¨ select å‡½æ•°å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆ**æ‹·è´**åˆ°å†…æ ¸é‡Œï¼Œè®©å†…æ ¸æ¥æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œäº‹ä»¶äº§ç”Ÿï¼Œæ£€æŸ¥çš„æ–¹å¼å¾ˆç²—æš´ï¼Œå°±æ˜¯é€šè¿‡**éå†**æ–‡ä»¶æè¿°ç¬¦é›†åˆçš„æ–¹å¼ï¼Œå½“æ£€æŸ¥åˆ°æœ‰äº‹ä»¶äº§ç”Ÿåï¼Œå°†æ­¤ Socket æ ‡è®°ä¸ºå¯è¯»æˆ–å¯å†™ï¼Œ æ¥ç€å†æŠŠæ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆ**æ‹·è´**å›ç”¨æˆ·æ€é‡Œï¼Œç„¶åç”¨æˆ·æ€è¿˜éœ€è¦å†é€šè¿‡**éå†**çš„æ–¹æ³•æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œç„¶åå†å¯¹å…¶å¤„ç†ã€‚

æ‰€ä»¥ï¼Œå¯¹äº select è¿™ç§æ–¹å¼ï¼Œéœ€è¦è¿›è¡Œ **2 æ¬¡ã€Œéå†ã€æ–‡ä»¶æè¿°ç¬¦é›†åˆ**ï¼Œä¸€æ¬¡æ˜¯åœ¨å†…æ ¸æ€é‡Œï¼Œä¸€ä¸ªæ¬¡æ˜¯åœ¨ç”¨æˆ·æ€é‡Œ ï¼Œè€Œä¸”è¿˜ä¼šå‘ç”Ÿ **2 æ¬¡ã€Œæ‹·è´ã€æ–‡ä»¶æè¿°ç¬¦é›†åˆ**ï¼Œå…ˆä»ç”¨æˆ·ç©ºé—´ä¼ å…¥å†…æ ¸ç©ºé—´ï¼Œç”±å†…æ ¸ä¿®æ”¹åï¼Œå†ä¼ å‡ºåˆ°ç”¨æˆ·ç©ºé—´ä¸­ã€‚

select ä½¿ç”¨å›ºå®šé•¿åº¦çš„ BitsMapï¼Œè¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œè€Œä¸”æ‰€æ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œåœ¨ Linux ç³»ç»Ÿä¸­ï¼Œç”±å†…æ ¸ä¸­çš„ FD_SETSIZE é™åˆ¶ï¼Œ é»˜è®¤æœ€å¤§å€¼ä¸º `1024`ï¼Œåªèƒ½ç›‘å¬ 0~1023 çš„æ–‡ä»¶æè¿°ç¬¦ã€‚

poll ä¸å†ç”¨ BitsMap æ¥å­˜å‚¨æ‰€å…³æ³¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå–è€Œä»£ä¹‹ç”¨åŠ¨æ€æ•°ç»„ï¼Œä»¥é“¾è¡¨å½¢å¼æ¥ç»„ç»‡ï¼Œçªç ´äº† select çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°é™åˆ¶ï¼Œå½“ç„¶è¿˜ä¼šå—åˆ°ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦é™åˆ¶ã€‚

ä½†æ˜¯ poll å’Œ select å¹¶æ²¡æœ‰å¤ªå¤§çš„æœ¬è´¨åŒºåˆ«ï¼Œ**éƒ½æ˜¯ä½¿ç”¨ã€Œçº¿æ€§ç»“æ„ã€å­˜å‚¨è¿›ç¨‹å…³æ³¨çš„ Socket é›†åˆï¼Œå› æ­¤éƒ½éœ€è¦éå†æ–‡ä»¶æè¿°ç¬¦é›†åˆæ¥æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œè€Œä¸”ä¹Ÿéœ€è¦åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´æ‹·è´æ–‡ä»¶æè¿°ç¬¦é›†åˆ**ï¼Œè¿™ç§æ–¹å¼éšç€å¹¶å‘æ•°ä¸Šæ¥ï¼Œæ€§èƒ½çš„æŸè€—ä¼šå‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚

#### epoll

å…ˆå¤ä¹ ä¸‹ epoll çš„ç”¨æ³•ã€‚å¦‚ä¸‹çš„ä»£ç ä¸­ï¼Œå…ˆç”¨e poll_create åˆ›å»ºä¸€ä¸ª epol lå¯¹è±¡ epfdï¼Œå†é€šè¿‡ epoll_ctl å°†éœ€è¦ç›‘è§†çš„ socket æ·»åŠ åˆ°epfdä¸­ï¼Œæœ€åè°ƒç”¨ epoll_wait ç­‰å¾…æ•°æ®ã€‚

```c
int s = socket(AF_INET, SOCK_STREAM, 0);
bind(s, ...);
listen(s, ...)

int epfd = epoll_create(...);
epoll_ctl(epfd, ...); //å°†æ‰€æœ‰éœ€è¦ç›‘å¬çš„socketæ·»åŠ åˆ°epfdä¸­

while(1) {
    int n = epoll_wait(...);
    for(æ¥æ”¶åˆ°æ•°æ®çš„socket){
        //å¤„ç†
    }
}
```

epoll é€šè¿‡ä¸¤ä¸ªæ–¹é¢ï¼Œå¾ˆå¥½è§£å†³äº† select/poll çš„é—®é¢˜ã€‚

*ç¬¬ä¸€ç‚¹*ï¼Œepoll åœ¨å†…æ ¸é‡Œä½¿ç”¨**çº¢é»‘æ ‘æ¥è·Ÿè¸ªè¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°å­—**ï¼ŒæŠŠéœ€è¦ç›‘æ§çš„ socket é€šè¿‡ `epoll_ctl()` å‡½æ•°åŠ å…¥å†…æ ¸ä¸­çš„çº¢é»‘æ ‘é‡Œï¼Œçº¢é»‘æ ‘æ˜¯ä¸ªé«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹ä¸€èˆ¬æ—¶é—´å¤æ‚åº¦æ˜¯ `O(logn)`ã€‚è€Œ select/poll å†…æ ¸é‡Œæ²¡æœ‰ç±»ä¼¼ epoll çº¢é»‘æ ‘è¿™ç§ä¿å­˜æ‰€æœ‰å¾…æ£€æµ‹çš„ socket çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ select/poll  æ¯æ¬¡æ“ä½œæ—¶éƒ½ä¼ å…¥æ•´ä¸ª socket é›†åˆç»™å†…æ ¸ï¼Œè€Œ epoll å› ä¸ºåœ¨å†…æ ¸ç»´æŠ¤äº†çº¢é»‘æ ‘ï¼Œå¯ä»¥ä¿å­˜æ‰€æœ‰å¾…æ£€æµ‹çš„ socket  ï¼Œæ‰€ä»¥åªéœ€è¦ä¼ å…¥ä¸€ä¸ªå¾…æ£€æµ‹çš„ socketï¼Œå‡å°‘äº†å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å¤§é‡çš„æ•°æ®æ‹·è´å’Œå†…å­˜åˆ†é…ã€‚

*ç¬¬äºŒç‚¹*ï¼Œ epoll ä½¿ç”¨**äº‹ä»¶é©±åŠ¨**çš„æœºåˆ¶ï¼Œå†…æ ¸é‡Œ**ç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶**ï¼Œå½“æŸä¸ª socket æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šè¿‡**å›è°ƒå‡½æ•°**å†…æ ¸ä¼šå°†å…¶åŠ å…¥åˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶åˆ—è¡¨ä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨ `epoll_wait()` å‡½æ•°æ—¶ï¼Œåªä¼šè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œä¸éœ€è¦åƒ select/poll é‚£æ ·è½®è¯¢æ‰«ææ•´ä¸ª socket é›†åˆï¼Œå¤§å¤§æé«˜äº†æ£€æµ‹çš„æ•ˆç‡ã€‚

ä»ä¸‹å›¾ä½ å¯ä»¥çœ‹åˆ° epoll ç›¸å…³çš„æ¥å£ä½œç”¨ï¼š

![image-20220717165140152](./images/image-20220717165140152.png)

epoll çš„æ–¹å¼å³ä½¿ç›‘å¬çš„ Socket æ•°é‡è¶Šå¤šçš„æ—¶å€™ï¼Œæ•ˆç‡ä¸ä¼šå¤§å¹…åº¦é™ä½ï¼Œèƒ½å¤ŸåŒæ—¶ç›‘å¬çš„ Socket çš„æ•°ç›®ä¹Ÿéå¸¸çš„å¤šäº†ï¼Œä¸Šé™å°±ä¸ºç³»ç»Ÿå®šä¹‰çš„è¿›ç¨‹æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚å› è€Œï¼Œ**epoll è¢«ç§°ä¸ºè§£å†³ C10K é—®é¢˜çš„åˆ©å™¨**ã€‚

æ’ä¸ªé¢˜å¤–è¯ï¼Œç½‘ä¸Šæ–‡ç« ä¸å°‘è¯´ï¼Œ`epoll_wait` è¿”å›æ—¶ï¼Œå¯¹äºå°±ç»ªçš„äº‹ä»¶ï¼Œepoll ä½¿ç”¨çš„æ˜¯å…±äº«å†…å­˜çš„æ–¹å¼ï¼Œå³ç”¨æˆ·æ€å’Œå†…æ ¸æ€éƒ½æŒ‡å‘äº†å°±ç»ªé“¾è¡¨ï¼Œæ‰€ä»¥å°±é¿å…äº†å†…å­˜æ‹·è´æ¶ˆè€—ã€‚

è¿™æ˜¯é”™çš„ï¼çœ‹è¿‡ epoll å†…æ ¸æºç çš„éƒ½çŸ¥é“ï¼Œ**å‹æ ¹å°±æ²¡æœ‰ä½¿ç”¨å…±äº«å†…å­˜è¿™ä¸ªç©æ„**ã€‚ä½ å¯ä»¥ä»ä¸‹é¢è¿™ä»½ä»£ç çœ‹åˆ°ï¼Œ epoll_wait å®ç°çš„å†…æ ¸ä»£ç ä¸­è°ƒç”¨äº† `__put_user` å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚

![image-20220717165148621](./images/image-20220717165148621.png)

##### è¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘

è¿™ä¸¤ä¸ªæœ¯è¯­è¿˜æŒºæŠ½è±¡çš„ï¼Œå…¶å®å®ƒä»¬çš„åŒºåˆ«è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚

- ä½¿ç”¨è¾¹ç¼˜è§¦å‘æ¨¡å¼æ—¶ï¼Œå½“è¢«ç›‘æ§çš„ Socket æè¿°ç¬¦ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ**æœåŠ¡å™¨ç«¯åªä¼šä» epoll_wait ä¸­è‹é†’ä¸€æ¬¡**ï¼Œå³ä½¿è¿›ç¨‹æ²¡æœ‰è°ƒç”¨ read å‡½æ•°ä»å†…æ ¸è¯»å–æ•°æ®ï¼Œä¹Ÿä¾ç„¶åªè‹é†’ä¸€æ¬¡ï¼Œå› æ­¤æˆ‘ä»¬ç¨‹åºè¦ä¿è¯ä¸€æ¬¡æ€§å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®è¯»å–å®Œï¼›
- ä½¿ç”¨æ°´å¹³è§¦å‘æ¨¡å¼æ—¶ï¼Œå½“è¢«ç›‘æ§çš„ Socket ä¸Šæœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ**æœåŠ¡å™¨ç«¯ä¸æ–­åœ°ä» epoll_wait ä¸­è‹é†’ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºæ•°æ®è¢« read å‡½æ•°è¯»å®Œæ‰ç»“æŸ**ï¼Œç›®çš„æ˜¯å‘Šè¯‰æˆ‘ä»¬æœ‰æ•°æ®éœ€è¦è¯»å–ï¼›

ä¸¾ä¸ªä¾‹å­ï¼Œä½ çš„å¿«é€’è¢«æ”¾åˆ°äº†ä¸€ä¸ªå¿«é€’ç®±é‡Œï¼Œå¦‚æœå¿«é€’ç®±åªä¼šé€šè¿‡çŸ­ä¿¡é€šçŸ¥ä½ ä¸€æ¬¡ï¼Œå³ä½¿ä½ ä¸€ç›´æ²¡æœ‰å»å–ï¼Œå®ƒä¹Ÿä¸ä¼šå†å‘é€ç¬¬äºŒæ¡çŸ­ä¿¡æé†’ä½ ï¼Œè¿™ä¸ªæ–¹å¼å°±æ˜¯è¾¹ç¼˜è§¦å‘ï¼›å¦‚æœå¿«é€’ç®±å‘ç°ä½ çš„å¿«é€’æ²¡æœ‰è¢«å–å‡ºï¼Œå®ƒå°±ä¼šä¸åœåœ°å‘çŸ­ä¿¡é€šçŸ¥ä½ ï¼Œç›´åˆ°ä½ å–å‡ºäº†å¿«é€’ï¼Œå®ƒæ‰æ¶ˆåœï¼Œè¿™ä¸ªå°±æ˜¯æ°´å¹³è§¦å‘çš„æ–¹å¼ã€‚

è¿™å°±æ˜¯ä¸¤è€…çš„åŒºåˆ«ï¼Œæ°´å¹³è§¦å‘çš„æ„æ€æ˜¯åªè¦æ»¡è¶³äº‹ä»¶çš„æ¡ä»¶ï¼Œæ¯”å¦‚å†…æ ¸ä¸­æœ‰æ•°æ®éœ€è¦è¯»ï¼Œå°±ä¸€ç›´ä¸æ–­åœ°æŠŠè¿™ä¸ªäº‹ä»¶ä¼ é€’ç»™ç”¨æˆ·ï¼›è€Œè¾¹ç¼˜è§¦å‘çš„æ„æ€æ˜¯åªæœ‰ç¬¬ä¸€æ¬¡æ»¡è¶³æ¡ä»¶çš„æ—¶å€™æ‰è§¦å‘ï¼Œä¹‹åå°±ä¸ä¼šå†ä¼ é€’åŒæ ·çš„äº‹ä»¶äº†ã€‚

å¦‚æœä½¿ç”¨æ°´å¹³è§¦å‘æ¨¡å¼ï¼Œå½“å†…æ ¸é€šçŸ¥æ–‡ä»¶æè¿°ç¬¦å¯è¯»å†™æ—¶ï¼Œæ¥ä¸‹æ¥è¿˜å¯ä»¥ç»§ç»­å»æ£€æµ‹å®ƒçš„çŠ¶æ€ï¼Œçœ‹å®ƒæ˜¯å¦ä¾ç„¶å¯è¯»æˆ–å¯å†™ã€‚æ‰€ä»¥åœ¨æ”¶åˆ°é€šçŸ¥åï¼Œæ²¡å¿…è¦ä¸€æ¬¡æ‰§è¡Œå°½å¯èƒ½å¤šçš„è¯»å†™æ“ä½œã€‚

å¦‚æœä½¿ç”¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼ŒI/O äº‹ä»¶å‘ç”Ÿæ—¶åªä¼šé€šçŸ¥ä¸€æ¬¡ï¼Œè€Œä¸”æˆ‘ä»¬ä¸çŸ¥é“åˆ°åº•èƒ½è¯»å†™å¤šå°‘æ•°æ®ï¼Œæ‰€ä»¥åœ¨æ”¶åˆ°é€šçŸ¥ååº”å°½å¯èƒ½åœ°è¯»å†™æ•°æ®ï¼Œä»¥å…é”™å¤±è¯»å†™çš„æœºä¼šã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¼š**å¾ªç¯**ä»æ–‡ä»¶æè¿°ç¬¦è¯»å†™æ•°æ®ï¼Œé‚£ä¹ˆå¦‚æœæ–‡ä»¶æè¿°ç¬¦æ˜¯é˜»å¡çš„ï¼Œæ²¡æœ‰æ•°æ®å¯è¯»å†™æ—¶ï¼Œè¿›ç¨‹ä¼šé˜»å¡åœ¨è¯»å†™å‡½æ•°é‚£é‡Œï¼Œç¨‹åºå°±æ²¡åŠæ³•ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œ**è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸€èˆ¬å’Œéé˜»å¡ I/O æ­é…ä½¿ç”¨**ï¼Œç¨‹åºä¼šä¸€ç›´æ‰§è¡Œ I/O æ“ä½œï¼Œç›´åˆ°ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ `read` å’Œ `write`ï¼‰è¿”å›é”™è¯¯ï¼Œé”™è¯¯ç±»å‹ä¸º `EAGAIN` æˆ– `EWOULDBLOCK`ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œè¾¹ç¼˜è§¦å‘çš„æ•ˆç‡æ¯”æ°´å¹³è§¦å‘çš„æ•ˆç‡è¦é«˜ï¼Œå› ä¸ºè¾¹ç¼˜è§¦å‘å¯ä»¥å‡å°‘ epoll_wait çš„ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ï¼Œç³»ç»Ÿè°ƒç”¨ä¹Ÿæ˜¯æœ‰ä¸€å®šçš„å¼€é”€çš„çš„ï¼Œæ¯•ç«Ÿä¹Ÿå­˜åœ¨ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ã€‚

select/poll åªæœ‰æ°´å¹³è§¦å‘æ¨¡å¼ï¼Œepoll é»˜è®¤çš„è§¦å‘æ¨¡å¼æ˜¯æ°´å¹³è§¦å‘ï¼Œä½†æ˜¯å¯ä»¥æ ¹æ®åº”ç”¨åœºæ™¯è®¾ç½®ä¸ºè¾¹ç¼˜è§¦å‘æ¨¡å¼ã€‚

å¦å¤–ï¼Œä½¿ç”¨ I/O å¤šè·¯å¤ç”¨æ—¶ï¼Œæœ€å¥½æ­é…éé˜»å¡ I/O ä¸€èµ·ä½¿ç”¨ï¼ŒLinux æ‰‹å†Œå…³äº select çš„å†…å®¹ä¸­æœ‰å¦‚ä¸‹è¯´æ˜ï¼š

> Under Linux, select() may report a socket file descriptor as "ready for  reading", while nevertheless a subsequent read blocks. This could for  example happen when data has arrived but upon examination has wrong  checksum and is discarded. There may be other circumstances in which a  file descriptor is spuriously reported as ready. Thus it may be safer to use O_NONBLOCK on sockets that should not block.

æˆ‘è°·æ­Œç¿»è¯‘çš„ç»“æœï¼š

> åœ¨Linuxä¸‹ï¼Œselect() å¯èƒ½ä¼šå°†ä¸€ä¸ª socket æ–‡ä»¶æè¿°ç¬¦æŠ¥å‘Šä¸º  "å‡†å¤‡è¯»å–"ï¼Œè€Œåç»­çš„è¯»å–å—å´æ²¡æœ‰ã€‚ä¾‹å¦‚ï¼Œå½“æ•°æ®å·²ç»åˆ°è¾¾ï¼Œä½†ç»æ£€æŸ¥åå‘ç°æœ‰é”™è¯¯çš„æ ¡éªŒå’Œè€Œè¢«ä¸¢å¼ƒæ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ä¹Ÿæœ‰å¯èƒ½åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œæ–‡ä»¶æè¿°ç¬¦è¢«é”™è¯¯åœ°æŠ¥å‘Šä¸ºå°±ç»ªã€‚å› æ­¤ï¼Œåœ¨ä¸åº”è¯¥é˜»å¡çš„ socket ä¸Šä½¿ç”¨ O_NONBLOCK å¯èƒ½æ›´å®‰å…¨ã€‚

ç®€å•ç‚¹ç†è§£ï¼Œå°±æ˜¯**å¤šè·¯å¤ç”¨ API è¿”å›çš„äº‹ä»¶å¹¶ä¸ä¸€å®šå¯è¯»å†™çš„**ï¼Œå¦‚æœä½¿ç”¨é˜»å¡ I/Oï¼Œ é‚£ä¹ˆåœ¨è°ƒç”¨ read/write æ—¶åˆ™ä¼šå‘ç”Ÿç¨‹åºé˜»å¡ï¼Œå› æ­¤æœ€å¥½æ­é…éé˜»å¡ I/Oï¼Œä»¥ä¾¿åº”å¯¹æå°‘æ•°çš„ç‰¹æ®Šæƒ…å†µã€‚

#### æ€»ç»“

æœ€åŸºç¡€çš„ TCP çš„ Socket ç¼–ç¨‹ï¼Œå®ƒæ˜¯é˜»å¡ I/O æ¨¡å‹ï¼ŒåŸºæœ¬ä¸Šåªèƒ½ä¸€å¯¹ä¸€é€šä¿¡ï¼Œé‚£ä¸ºäº†æœåŠ¡æ›´å¤šçš„å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦æ”¹è¿›ç½‘ç»œ I/O æ¨¡å‹ã€‚

æ¯”è¾ƒä¼ ç»Ÿçš„æ–¹å¼æ˜¯ä½¿ç”¨å¤šè¿›ç¨‹/çº¿ç¨‹æ¨¡å‹ï¼Œæ¯æ¥ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå°±åˆ†é…ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹ï¼Œç„¶ååç»­çš„è¯»å†™éƒ½åœ¨å¯¹åº”çš„è¿›ç¨‹/çº¿ç¨‹ï¼Œè¿™ç§æ–¹å¼å¤„ç† 100 ä¸ªå®¢æˆ·ç«¯æ²¡é—®é¢˜ï¼Œä½†æ˜¯å½“å®¢æˆ·ç«¯å¢å¤§åˆ° 10000  ä¸ªæ—¶ï¼Œ10000 ä¸ªè¿›ç¨‹/çº¿ç¨‹çš„è°ƒåº¦ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ä»¥åŠå®ƒä»¬å ç”¨çš„å†…å­˜ï¼Œéƒ½ä¼šæˆä¸ºç“¶é¢ˆã€‚

ä¸ºäº†è§£å†³ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œå°±å‡ºç°äº† I/O çš„å¤šè·¯å¤ç”¨ï¼Œå¯ä»¥åªåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œå¤„ç†å¤šä¸ªæ–‡ä»¶çš„  I/Oï¼ŒLinux ä¸‹æœ‰ä¸‰ç§æä¾› I/O å¤šè·¯å¤ç”¨çš„ APIï¼Œåˆ†åˆ«æ˜¯ï¼š selectã€pollã€epollã€‚

select å’Œ poll å¹¶æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼Œå®ƒä»¬å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨ã€Œçº¿æ€§ç»“æ„ã€æ¥å­˜å‚¨è¿›ç¨‹å…³æ³¨çš„ Socket é›†åˆã€‚

åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦æŠŠå…³æ³¨çš„ Socket é›†åˆé€šè¿‡ select/poll ç³»ç»Ÿè°ƒç”¨ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œç„¶åç”±å†…æ ¸æ£€æµ‹äº‹ä»¶ï¼Œå½“æœ‰ç½‘ç»œäº‹ä»¶äº§ç”Ÿæ—¶ï¼Œå†…æ ¸éœ€è¦éå†è¿›ç¨‹å…³æ³¨  Socket é›†åˆï¼Œæ‰¾åˆ°å¯¹åº”çš„ Socketï¼Œå¹¶è®¾ç½®å…¶çŠ¶æ€ä¸ºå¯è¯»/å¯å†™ï¼Œç„¶åæŠŠæ•´ä¸ª Socket  é›†åˆä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œç”¨æˆ·æ€è¿˜è¦ç»§ç»­éå†æ•´ä¸ª Socket é›†åˆæ‰¾åˆ°å¯è¯»/å¯å†™çš„ Socketï¼Œç„¶åå¯¹å…¶å¤„ç†ã€‚

å¾ˆæ˜æ˜¾å‘ç°ï¼Œselect å’Œ poll çš„ç¼ºé™·åœ¨äºï¼Œå½“å®¢æˆ·ç«¯è¶Šå¤šï¼Œä¹Ÿå°±æ˜¯ Socket é›†åˆè¶Šå¤§ï¼ŒSocket é›†åˆçš„éå†å’Œæ‹·è´ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ï¼Œå› æ­¤ä¹Ÿå¾ˆéš¾åº”å¯¹ C10Kã€‚

epoll æ˜¯è§£å†³ C10K é—®é¢˜çš„åˆ©å™¨ï¼Œé€šè¿‡ä¸¤ä¸ªæ–¹é¢è§£å†³äº† select/poll çš„é—®é¢˜ã€‚

- epoll åœ¨å†…æ ¸é‡Œä½¿ç”¨ã€Œçº¢é»‘æ ‘ã€æ¥å…³æ³¨è¿›ç¨‹æ‰€æœ‰å¾…æ£€æµ‹çš„ Socketï¼Œçº¢é»‘æ ‘æ˜¯ä¸ªé«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå¢åˆ æ”¹ä¸€èˆ¬æ—¶é—´å¤æ‚åº¦æ˜¯  O(logn)ï¼Œé€šè¿‡å¯¹è¿™æ£µé»‘çº¢æ ‘çš„ç®¡ç†ï¼Œä¸éœ€è¦åƒ select/poll åœ¨æ¯æ¬¡æ“ä½œæ—¶éƒ½ä¼ å…¥æ•´ä¸ª Socket  é›†åˆï¼Œå‡å°‘äº†å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å¤§é‡çš„æ•°æ®æ‹·è´å’Œå†…å­˜åˆ†é…ã€‚
- epoll ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶ï¼Œå†…æ ¸é‡Œç»´æŠ¤äº†ä¸€ä¸ªã€Œé“¾è¡¨ã€æ¥è®°å½•å°±ç»ªäº‹ä»¶ï¼Œåªå°†æœ‰äº‹ä»¶å‘ç”Ÿçš„ Socket é›†åˆä¼ é€’ç»™åº”ç”¨ç¨‹åºï¼Œä¸éœ€è¦åƒ select/poll é‚£æ ·è½®è¯¢æ‰«ææ•´ä¸ªé›†åˆï¼ˆåŒ…å«æœ‰å’Œæ— äº‹ä»¶çš„ Socket ï¼‰ï¼Œå¤§å¤§æé«˜äº†æ£€æµ‹çš„æ•ˆç‡ã€‚

è€Œä¸”ï¼Œepoll æ”¯æŒè¾¹ç¼˜è§¦å‘å’Œæ°´å¹³è§¦å‘çš„æ–¹å¼ï¼Œè€Œ select/poll åªæ”¯æŒæ°´å¹³è§¦å‘ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œè¾¹ç¼˜è§¦å‘çš„æ–¹å¼ä¼šæ¯”æ°´å¹³è§¦å‘çš„æ•ˆç‡é«˜ã€‚

### â­Javaé›†åˆç±»æ¡†æ¶çš„åŸºæœ¬æ¥å£æœ‰å“ªäº›ï¼Ÿ

Javaä¸­çš„é›†åˆåˆ†ä¸ºvalueï¼ˆConllectionï¼‰ï¼Œkey-value(Map)ä¸¤ç§å­˜å‚¨ç»“æ„

> å­˜å‚¨valueæœ‰åˆ†ä¸ºList ã€Setã€Queue

Listï¼šæœ‰åºï¼Œå¯å­˜å‚¨é‡å¤å…ƒç´ 

Setï¼šæ— åºï¼Œå…ƒç´ ä¸å¯é‡å¤ã€‚æ ¹æ®equalså’Œhashcodeåˆ¤æ–­ï¼ˆå¦‚æœä¸€ä¸ªå¯¹è±¡è¦å­˜å‚¨åœ¨Setä¸­ï¼Œå¿…é¡»é‡å†™equalså’ŒhashCodeæ–¹æ³•ï¼‰

Queueï¼šé˜Ÿåˆ—

> å­˜å‚¨key-valueçš„ä¸ºmap

![image-20220609215207876](./images/image-20220609215207876.png)

![image-20220609215218381](./images/image-20220609215218381.png)

![image-20220609215224938](./images/image-20220609215224938.png)

### â­ Arraylist ä¸ LinkedList åŒºåˆ«

1. **æ˜¯å¦ä¿è¯çº¿ç¨‹å®‰å…¨**ï¼š ArrayList å’Œ LinkedList éƒ½æ˜¯ä¸åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ä¸ä¿è¯çº¿ç¨‹å®‰å…¨ï¼›
2. **åº•å±‚æ•°æ®ç»“æ„**ï¼š Arraylist åº•å±‚ä½¿ç”¨çš„æ˜¯ Object æ•°ç»„ï¼› LinkedList åº•å±‚ä½¿ç”¨çš„æ˜¯ åŒå‘é“¾è¡¨æ•°æ®ç»“æ„ï¼ˆJDK1.6 ä¹‹å‰ä¸ºå¾ªç¯é“¾è¡¨ï¼ŒJDK1.7 å–æ¶ˆäº†å¾ªç¯ã€‚æ³¨æ„åŒå‘é“¾è¡¨å’ŒåŒå‘å¾ªç¯é“¾è¡¨çš„åŒºåˆ«ï¼Œä¸‹é¢æœ‰ä»‹ç»åˆ°ï¼ï¼‰
3. **æ’å…¥å’Œåˆ é™¤æ˜¯å¦å—å…ƒç´ ä½ç½®çš„å½±å“**ï¼šâ‘ ArrayListé‡‡ç”¨æ•°ç»„å­˜å‚¨ï¼Œæ‰€ä»¥æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦å—å…ƒç´ ä½ç½®çš„å½±å“ã€‚æ¯”å¦‚ï¼šæ‰§è¡Œadd(Ee)æ–¹æ³•çš„æ—¶å€™ï¼ŒArrayListä¼šé»˜è®¤åœ¨å°†æŒ‡å®šçš„å…ƒç´ è¿½åŠ åˆ°æ­¤åˆ—è¡¨çš„æœ«å°¾ï¼Œè¿™ç§æƒ…å†µæ—¶é—´å¤æ‚åº¦å°±æ˜¯O(1)ã€‚ä½†æ˜¯å¦‚æœè¦åœ¨æŒ‡å®šä½ç½®iæ’å…¥å’Œåˆ é™¤å…ƒç´ çš„è¯ï¼ˆadd(intindex,Eelement)ï¼‰æ—¶é—´å¤æ‚åº¦å°±ä¸ºO(n-i)ã€‚å› ä¸ºåœ¨è¿›è¡Œä¸Šè¿°æ“ä½œçš„æ—¶å€™é›†åˆä¸­ç¬¬iå’Œç¬¬iä¸ªå…ƒç´ ä¹‹åçš„(n-i)ä¸ªå…ƒç´ éƒ½è¦æ‰§è¡Œå‘åä½/å‘å‰ç§»ä¸€ä½çš„æ“ä½œã€‚â‘¡LinkedListé‡‡ç”¨é“¾è¡¨å­˜å‚¨ï¼Œæ‰€ä»¥å¯¹äºadd(Ee)æ–¹æ³•çš„æ’å…¥ï¼Œåˆ é™¤å…ƒç´ æ—¶é—´å¤æ‚åº¦ä¸å—å…ƒç´ ä½ç½®çš„å½±å“ï¼Œè¿‘ä¼¼O(1)ï¼Œå¦‚æœæ˜¯è¦åœ¨æŒ‡å®šä½ç½®iæ’å…¥å’Œåˆ é™¤å…ƒç´ çš„è¯ï¼ˆ(add(intindex,Eelement)ï¼‰æ—¶é—´å¤æ‚åº¦è¿‘ä¼¼ä¸ºo(n))å› ä¸ºéœ€è¦å…ˆç§»åŠ¨åˆ°æŒ‡å®šä½ç½®å†æ’å…¥ã€‚
4. **æ˜¯å¦æ”¯æŒå¿«é€Ÿéšæœºè®¿é—®**ï¼šLinkedListä¸æ”¯æŒé«˜æ•ˆçš„éšæœºå…ƒç´ è®¿é—®ï¼Œè€ŒArrayListæ”¯æŒã€‚å¿«é€Ÿéšæœºè®¿é—®å°±æ˜¯é€šè¿‡å…ƒç´ çš„åºå·å¿«é€Ÿè·å–å…ƒç´ å¯¹è±¡(å¯¹åº”äºget(intindex)æ–¹æ³•)ã€‚
5. **å†…å­˜ç©ºé—´å ç”¨**ï¼šArrayListçš„ç©ºé—´æµªè´¹ä¸»è¦ä½“ç°åœ¨åœ¨liståˆ—è¡¨çš„ç»“å°¾ä¼šé¢„ç•™ä¸€å®šçš„å®¹é‡ç©ºé—´ï¼Œè€ŒLinkedListçš„ç©ºé—´èŠ±è´¹åˆ™ä½“ç°åœ¨å®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æ¶ˆè€—æ¯”ArrayListæ›´å¤šçš„ç©ºé—´ï¼ˆå› ä¸ºè¦å­˜æ”¾ç›´æ¥åç»§å’Œç›´æ¥å‰é©±ä»¥åŠæ•°æ®ï¼‰ã€‚



### HashMapå’ŒHashTableæœ‰ä»€ä¹ˆåŒºåˆ«

1. **HashMap**å¯ä»¥æ¥å—ä¸ºnullçš„keyå’Œvalueï¼Œkeyä¸ºnullçš„é”®å€¼å¯¹æ”¾åœ¨ä¸‹æ ‡ä¸º0çš„å¤´ç»“ç‚¹çš„é“¾è¡¨ä¸­ï¼Œè€Œ**Hashtable**åˆ™ä¸è¡Œã€‚
2. HashMapæ˜¯**éçº¿ç¨‹å®‰å…¨**çš„ï¼ŒHashTableæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚Jdk1.5æä¾›äº†**ConcurrentHashMap**ï¼Œå®ƒæ˜¯HashTableçš„æ›¿ä»£ã€‚
3. **Hashtable**å¾ˆå¤šæ–¹æ³•æ˜¯**åŒæ­¥**æ–¹æ³•ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹å®ƒæ¯”HashMapè¦æ…¢ã€‚
4. **å“ˆå¸Œå€¼çš„ä½¿ç”¨**ä¸åŒï¼ŒHashTableç›´æ¥ä½¿ç”¨å¯¹è±¡çš„hashCodeã€‚è€ŒHashMapé‡æ–°è®¡ç®—hashå€¼ã€‚



### ConcurrentHashMap å’Œ Hashtable çš„åŒºåˆ«

`ConcurrentHashMap` å’Œ `Hashtable` çš„åŒºåˆ«ä¸»è¦ä½“ç°åœ¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ä¸Šä¸åŒã€‚

åº•å±‚æ•°æ®ç»“æ„ï¼šJDK1.7çš„ `ConcurrentHashMap`åº•å±‚é‡‡ç”¨**åˆ†æ®µçš„æ•°ç»„+é“¾è¡¨**å®ç°ï¼ŒJDK1.8é‡‡ç”¨çš„æ•°æ®ç»“æ„è·Ÿ `HashMap1.8`çš„ç»“æ„ä¸€æ ·ï¼Œ**æ•°ç»„+é“¾è¡¨/çº¢é»‘äºŒå‰æ ‘**ã€‚`Hashtable`å’ŒJDK1.8ä¹‹å‰çš„ `HashMap`çš„åº•å±‚æ•°æ®ç»“æ„ç±»ä¼¼éƒ½æ˜¯é‡‡ç”¨æ•°ç»„+é“¾è¡¨çš„å½¢å¼ï¼Œæ•°ç»„æ˜¯ `HashMap`çš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨çš„ï¼›

å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ï¼ˆé‡è¦ï¼‰ï¼š

1. åœ¨JDK1.7çš„æ—¶å€™ï¼ŒConcurrentHashMapï¼ˆåˆ†æ®µé”ï¼‰å¯¹æ•´ä¸ªæ¡¶æ•°ç»„è¿›è¡Œäº†åˆ†å‰²åˆ†æ®µ(Segment)ï¼Œæ¯ä¸€æŠŠé”åªé”å®¹å™¨å…¶ä¸­ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¤šçº¿ç¨‹è®¿é—®å®¹å™¨é‡Œä¸åŒæ•°æ®æ®µçš„æ•°æ®ï¼Œå°±ä¸ä¼šå­˜åœ¨é”ç«äº‰ï¼Œæé«˜å¹¶å‘è®¿é—®ç‡ã€‚åˆ°äº†JDK1.8çš„æ—¶å€™å·²ç»æ‘’å¼ƒäº†Segmentçš„æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥ç”¨Nodeæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨synchronizedå’ŒCASæ¥æ“ä½œã€‚ï¼ˆJDK1.6ä»¥åå¯¹synchronizedé”åšäº†å¾ˆå¤šä¼˜åŒ–ï¼‰æ•´ä¸ªçœ‹èµ·æ¥å°±åƒæ˜¯ä¼˜åŒ–è¿‡ä¸”çº¿ç¨‹å®‰å…¨çš„HashMapï¼Œè™½ç„¶åœ¨JDK1.8ä¸­è¿˜èƒ½çœ‹åˆ°Segmentçš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å·²ç»ç®€åŒ–äº†å±æ€§ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬ï¼›
2. HashTableå’ŒHashMapçš„å®ç°åŸç†å‡ ä¹ä¸€æ ·ï¼Œå·®åˆ«æ— éæ˜¯**1.HashTableä¸å…è®¸keyå’Œvalueä¸ºnullï¼›2.HashTableæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚**ä½†æ˜¯HashTableçº¿ç¨‹å®‰å…¨çš„ç­–ç•¥å®ç°ä»£ä»·å´å¤ªå¤§äº†ï¼Œç®€å•ç²—æš´ï¼Œget/putæ‰€æœ‰ç›¸å…³æ“ä½œéƒ½æ˜¯synchronizedçš„ï¼Œè¿™ç›¸å½“äºç»™æ•´ä¸ªå“ˆå¸Œè¡¨åŠ äº†ä¸€æŠŠ**å¤§é”**ï¼Œå¤šçº¿ç¨‹è®¿é—®æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®æˆ–æ“ä½œè¯¥å¯¹è±¡ï¼Œé‚£å…¶ä»–çº¿ç¨‹åªèƒ½é˜»å¡ï¼Œç›¸å½“äºå°†æ‰€æœ‰çš„æ“ä½œ**ä¸²è¡ŒåŒ–**ï¼Œåœ¨ç«äº‰æ¿€çƒˆçš„å¹¶å‘åœºæ™¯ä¸­æ€§èƒ½å°±ä¼šéå¸¸å·®ã€‚

![image-20220606221411976](./images/image-20220606221411976.png)

JDK1.7 çš„ ConcurrentHashMapï¼š

![image-20220606221435298](./images/image-20220606221435298.png)

JDK1.8 çš„ ConcurrentHashMapï¼š
JDK1.8 çš„ ConcurrentHashMap ä¸åœ¨æ˜¯ Segment æ•°ç»„ + HashEntry æ•°ç»„ + é“¾è¡¨ï¼Œè€Œæ˜¯ Node æ•°ç»„ + é“¾è¡¨ / çº¢é»‘æ ‘ã€‚ä¸è¿‡ï¼ŒNode åªèƒ½ç”¨äºé“¾è¡¨çš„æƒ…å†µï¼Œçº¢é»‘æ ‘çš„æƒ…å†µéœ€è¦ä½¿ç”¨ TreeNode ã€‚å½“å†²çªé“¾è¡¨è¾¾åˆ°ä¸€å®šâ»“åº¦æ—¶ï¼Œé“¾è¡¨ä¼šè½¬æ¢æˆçº¢é»‘æ ‘ã€‚

### â­ConcurrentHashMapçº¿ç¨‹å®‰å…¨çš„å…·ä½“å®ç°æ–¹å¼/åº•å±‚å…·ä½“å®ç°

#### JDK1.7

![image-20220606221435298](./images/image-20220606221435298.png)

é¦–å…ˆå°†æ•°æ®åˆ†ä¸ºä¸€æ®µä¸€æ®µçš„å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®æ—¶ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚

`ConcurrentHashMap` æ˜¯ç”± `Segment `æ•°ç»„ç»“æ„å’Œ `HashEntry` æ•°ç»„ç»“æ„ç»„æˆã€‚

Segmentå®ç°äº†ReentrantLock,æ‰€ä»¥Segmentæ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œæ‰®æ¼”é”çš„â»†è‰²ã€‚HashEntryç”¨äºå­˜å‚¨é”®å€¼å¯¹æ•°æ®ã€‚

```JAVA
static class Segment<K,V> extends ReentrantLock implements Serializable {
}
```

ä¸€ä¸ª `ConcurrentHashMap`é‡ŒåŒ…å«ä¸€ä¸ª `Segment`æ•°ç»„ã€‚`Segment`çš„ç»“æ„å’Œ `HashMap`ç±»ä¼¼ï¼Œæ˜¯ä¸€ç§æ•°ç»„å’Œé“¾è¡¨ç»“æ„ï¼Œä¸€ä¸ª `Segment`åŒ…å«ä¸€ä¸ª `HashEntry`æ•°ç»„ï¼Œæ¯ä¸ª `HashEntry`æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„çš„å…ƒç´ ï¼Œæ¯ä¸ªSegmentå®ˆæŠ¤ç€ä¸€ä¸ª `HashEntry`æ•°ç»„é‡Œçš„å…ƒç´ ï¼Œå½“å¯¹ `HashEntry`æ•°ç»„çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¿…é¡»é¦–å…ˆè·å¾—å¯¹åº”çš„Segmentçš„é”ã€‚

#### JDK1.8

![image-20220606222144072](./images/image-20220606222144072.png)

`ConcurrentHashMap`å–æ¶ˆäº†Segmentåˆ†æ®µé”ï¼Œé‡‡ç”¨ `CAS`å’Œ `synchronized`æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚æ•°æ®ç»“æ„è·Ÿ `HashMap1.8`çš„ç»“æ„ç±»ä¼¼ï¼Œæ•°ç»„+é“¾è¡¨/çº¢é»‘äºŒå‰æ ‘ã€‚Java 8åœ¨é“¾è¡¨â»“åº¦è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼ˆ8ï¼‰æ—¶å°†é“¾è¡¨ï¼ˆå¯»å€æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼‰è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼ˆå¯»å€æ—¶é—´å¤æ‚åº¦ä¸ºO(log(N))ï¼‰synchronizedåªé”å®šå½“å‰é“¾è¡¨æˆ–çº¢é»‘äºŒå‰æ ‘çš„é¦–èŠ‚ç‚¹ï¼Œè¿™æ ·åªè¦hashä¸å†²çªï¼Œå°±ä¸ä¼šäº§ç”Ÿå¹¶å‘ï¼Œæ•ˆç‡åˆæå‡Nå€ã€‚

### è¯´ä¸€è¯´Javaåå°„ï¼Ÿ

åå°„æ˜¯åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§ï¼›è¿™ç§åŠ¨æ€è·å–çš„ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•çš„åŠŸèƒ½ç§°ä¸º Java è¯­è¨€çš„åå°„æœºåˆ¶ã€‚

- ä¼˜ç‚¹ï¼šèƒ½å¤Ÿè¿è¡Œæ—¶åŠ¨æ€è·å–ç±»çš„å®ä¾‹ï¼Œæé«˜çµæ´»æ€§ï¼›å¯ä¸åŠ¨æ€ç¼–è¯‘ç»“åˆ`Class.forName('com.mysql.jdbc.Driver.class');`ï¼ŒåŠ è½½[MySQL](https://www.wkcto.com/courses/mysql.html)çš„é©±åŠ¨ç±»ã€‚
- ç¼ºç‚¹ï¼šä½¿ç”¨åå°„æ€§èƒ½è¾ƒä½ï¼Œéœ€è¦è§£æå­—èŠ‚ç ï¼Œå°†å†…å­˜ä¸­çš„å¯¹è±¡è¿›è¡Œè§£æã€‚å…¶è§£å†³æ–¹æ¡ˆæ˜¯ï¼šé€šè¿‡setAccessible(true)å…³é—­JDKçš„å®‰å…¨æ£€æŸ¥æ¥æå‡åå°„é€Ÿåº¦ï¼›å¤šæ¬¡åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹æ—¶ï¼Œæœ‰ç¼“å­˜ä¼šå¿«å¾ˆå¤šï¼›ReflflectASMå·¥å…·ç±»ï¼Œé€šè¿‡å­—èŠ‚ç ç”Ÿæˆçš„æ–¹å¼åŠ å¿«åå°„é€Ÿåº¦ã€‚

> åº”ç”¨åœºæ™¯

1. JDBCè¿æ¥æ•°æ®åº“æ—¶ä½¿ç”¨`Class.forName()`é€šè¿‡åå°„åŠ è½½æ•°æ®åº“çš„é©±åŠ¨ç¨‹åº
2. Eclispeã€IDEAç­‰å¼€å‘å·¥å…·åˆ©ç”¨åå°„åŠ¨æ€è§£æå¯¹è±¡çš„ç±»å‹ä¸ç»“æ„ï¼ŒåŠ¨æ€æç¤ºå¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•
3. WebæœåŠ¡å™¨ä¸­åˆ©ç”¨åå°„è°ƒç”¨äº†Sevletçš„`service`æ–¹æ³•
4. JDKåŠ¨æ€ä»£ç†åº•å±‚ä¾èµ–åå°„å®ç°



## ğŸ•™ Javaå¹¶å‘

### è¯·ç®€è¦æè¿°çº¿ç¨‹ä¸è¿›ç¨‹çš„å…³ç³»,åŒºåˆ«åŠä¼˜ç¼ºç‚¹ï¼Ÿ

#### å›¾è§£è¿›ç¨‹å’Œçº¿ç¨‹çš„å…³ç³»

![image-20220607152830775](./images/image-20220607152830775.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †å’Œæ–¹æ³•åŒº(JDK1.8ä¹‹åçš„å…ƒç©ºé—´)**èµ„æºï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„**ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆ**ã€‚

æ€»ç»“ï¼šçº¿ç¨‹æ˜¯è¿›ç¨‹åˆ’åˆ†æˆçš„æ›´å°çš„è¿è¡Œå•ä½ã€‚çº¿ç¨‹å’Œè¿›ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºåŸºæœ¬ä¸Šå„è¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œå„çº¿ç¨‹åˆ™ä¸ä¸€å®šï¼Œå› ä¸ºåŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹ææœ‰å¯èƒ½ä¼šç›¸äº’å½±å“ã€‚çº¿ç¨‹æ‰§è¡Œå¼€é”€å°ï¼Œä½†ä¸åˆ©äºèµ„æºçš„ç®¡ç†å’Œä¿æŠ¤ï¼›è€Œè¿›ç¨‹æ­£ç›¸å

#### ç¨‹åºè®¡æ•°å™¨ä¸ºä»€ä¹ˆæ˜¯ç§æœ‰çš„?

ç¨‹åºè®¡æ•°å™¨ä¸»è¦æœ‰ä¸‹é¢ä¸¤ä¸ªä½œç”¨ï¼š

1. å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨æ¥ä¾æ¬¡è¯»å–æŒ‡ä»¤ï¼Œä»è€Œå®ç°ä»£ç çš„æµç¨‹æ§åˆ¶ï¼Œå¦‚ï¼šé¡ºåºæ‰§
   è¡Œã€é€‰æ‹©ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†ã€‚
2. åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œç¨‹åºè®¡æ•°å™¨ç”¨äºè®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œä»è€Œå½“çº¿ç¨‹è¢«åˆ‡æ¢å›æ¥çš„æ—¶
   å€™èƒ½å¤ŸçŸ¥é“è¯¥çº¿ç¨‹ä¸Šæ¬¡è¿è¡Œåˆ°å“ªå„¿äº†ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯nativeæ–¹æ³•ï¼Œé‚£ä¹ˆç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ˜¯undefinedåœ°å€ï¼Œåªæœ‰æ‰§è¡Œçš„æ˜¯Javaä»£ç æ—¶ç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ‰æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æ‰€ä»¥ï¼Œç¨‹åºè®¡æ•°å™¨ç§æœ‰ä¸»è¦æ˜¯ä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ã€‚

#### è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºä»€ä¹ˆæ˜¯ç§æœ‰çš„?

* è™šæ‹Ÿæœºæ ˆï¼šæ¯ä¸ªJavaæ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å¸¸é‡æ± å¼•ç”¨ç­‰ä¿¡æ¯ã€‚ä»æ–¹æ³•è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨Javaè™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚
* æœ¬åœ°æ–¹æ³•æ ˆï¼šå’Œè™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼šè™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡ŒJavaæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„Nativeæ–¹æ³•æœåŠ¡ã€‚åœ¨HotSpotè™šæ‹Ÿæœºä¸­å’ŒJavaè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚

æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯çº¿ç¨‹ä¸­çš„å±€éƒ¨å˜é‡ä¸è¢«åˆ«çš„çº¿ç¨‹è®¿é—®åˆ°ï¼Œè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚

#### ä¸€å¥è¯ç®€å•äº†è§£å †å’Œæ–¹æ³•åŒº

å †å’Œæ–¹æ³•åŒºæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„èµ„æºï¼Œå…¶ä¸­å †æ˜¯è¿›ç¨‹ä¸­æœ€å¤§çš„ä¸€å—å†…å­˜ï¼Œä¸»è¦ç”¨äºå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡(æ‰€æœ‰å¯¹è±¡éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜)ï¼Œæ–¹æ³•åŒºä¸»è¦ç”¨äºå­˜æ”¾å·²è¢«åŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚

> ç²¾ç®€ç‰ˆ

**è¿›ç¨‹æ˜¯ç³»ç»Ÿèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½**ï¼Œå®ƒèƒ½å¹¶å‘æ‰§è¡Œè¾ƒé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡.

**çº¿ç¨‹**æ˜¯**æ¯”è¿›ç¨‹æ›´å°**çš„èƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½,åˆ›å»ºã€é”€æ¯ã€åˆ‡æ¢æˆæœ¬è¦å°äºè¿›ç¨‹,å¯ä»¥å‡å°‘ç¨‹åºå¹¶å‘æ‰§è¡Œæ—¶çš„æ—¶é—´å’Œç©ºé—´å¼€é”€ï¼Œä½¿å¾—æ“ä½œç³»ç»Ÿå…·æœ‰æ›´å¥½çš„å¹¶å‘æ€§ã€‚

### Javaçº¿ç¨‹çš„åˆ›å»ºæ–¹å¼

æœ‰**å››ç§**æ–¹å¼å¯ä»¥ç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼š

- ç»§æ‰¿**Thread**ç±»
- å®ç°**Runnable**æ¥å£
- **Callable**å’Œ**FutureTask**åˆ›å»ºçº¿ç¨‹ï¼šä¸ºäº†è§£å†³å¼‚æ­¥æ‰§è¡Œçš„ç»“æœé—®é¢˜ï¼ŒJavaè¯­è¨€åœ¨1.5ç‰ˆæœ¬ä¹‹åæä¾›äº†ä¸€ç§æ–°çš„å¤šçº¿ç¨‹åˆ›å»ºæ–¹æ³•ï¼šé€šè¿‡Callableæ¥å£å’ŒFutureTaskç±»ç›¸ç»“åˆåˆ›å»ºçº¿ç¨‹ã€‚
- **çº¿ç¨‹æ± **åˆ›å»ºçº¿ç¨‹
  - ä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± 

å®ç°Runnableæ¥å£è¿™ç§æ–¹å¼æ›´å—æ¬¢è¿ï¼Œå› ä¸ºè¿™ä¸éœ€è¦ç»§æ‰¿Threadç±»ã€‚åœ¨åº”ç”¨è®¾è®¡ä¸­å·²ç»ç»§æ‰¿äº†åˆ«çš„å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œè¿™éœ€è¦å¤šç»§æ‰¿ï¼ˆè€ŒJavaä¸æ”¯æŒå¤šç»§æ‰¿ï¼‰ï¼Œåªèƒ½å®ç°æ¥å£ã€‚åŒæ—¶ï¼Œçº¿ç¨‹æ± ä¹Ÿæ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œå¾ˆå®¹æ˜“å®ç°å’Œä½¿ç”¨ã€‚

### JMM æ˜¯ä»€ä¹ˆï¼Ÿ

ç½‘ä¸Šçš„æ¦‚å¿µé±¼é¾™æ··æ‚ï¼Œç¬”è€…ç›´æ¥æ‘˜å½•éƒ¨åˆ†ã€ŠJavaé«˜å¹¶å‘æ ¸å¿ƒç¼–ç¨‹ã€‹å’Œã€ŠJavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ä¸­çš„ä»‹ç»ï¼š

> JMMï¼ˆJava Memory Model and Thread Specificationï¼‰ï¼šå®šä¹‰äº†ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡å†™å…¥æ—¶ï¼Œå¦‚ä½•ç¡®ä¿å¯¹å¦ä¸€ä¸ªçº¿ç¨‹æ˜¯å¯è§çš„ã€‚å®é™…ä¸Šï¼ŒJMMæä¾›äº†åˆç†çš„ç¦ç”¨ç¼“å­˜ä»¥åŠç¦æ­¢é‡æ’åºçš„æ–¹æ³•ï¼Œæ‰€ä»¥å…¶æ ¸å¿ƒçš„ä»·å€¼åœ¨äºè§£å†³å¯è§æ€§å’Œæœ‰åºæ€§ã€‚

    Javaå†…å­˜æ¨¡å‹è§„å®šæ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å­˜ä¸­ï¼ŒJMMçš„ä¸»å­˜ç±»ä¼¼äºç‰©ç†å†…å­˜ï¼Œä½†æœ‰åŒºåˆ«ï¼Œè¿˜èƒ½åŒ…å«éƒ¨åˆ†å…±äº«ç¼“å­˜ã€‚æ¯ä¸ªJavaçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆç±»ä¼¼äºCPUé«˜é€Ÿç¼“å­˜ï¼Œä½†ä¹Ÿæœ‰åŒºåˆ«ï¼‰

1. ä¸»å­˜ï¼šä¸»è¦å­˜å‚¨çš„æ˜¯Javaå®ä¾‹å¯¹è±¡ï¼Œæ‰€æœ‰çº¿ç¨‹åˆ›å»ºçš„å®ä¾‹å¯¹è±¡éƒ½å­˜æ”¾åœ¨ä¸»å­˜ä¸­ï¼Œæ— è®ºè¯¥å®ä¾‹å¯¹è±¡æ˜¯æˆå‘˜å˜é‡è¿˜æ˜¯æ–¹æ³•ä¸­çš„æœ¬åœ°å˜é‡ï¼ˆä¹Ÿç§°å±€éƒ¨å˜é‡ï¼‰ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬å…±äº«çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€‚ç”±äºæ˜¯å…±äº«æ•°æ®åŒºåŸŸï¼Œå› æ­¤å¤šæ¡çº¿ç¨‹å¯¹åŒä¸€ä¸ªå˜é‡è¿›è¡Œè®¿é—®å¯èƒ½ä¼šå‘ç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
2. å·¥ä½œå†…å­˜ï¼šä¸»è¦å­˜å‚¨å½“å‰æ–¹æ³•çš„æ‰€æœ‰æœ¬åœ°å˜é‡ä¿¡æ¯ï¼ˆå·¥ä½œå†…å­˜ä¸­å­˜å‚¨ç€ä¸»å­˜ä¸­çš„å˜é‡å‰¯æœ¬ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹åªèƒ½è®¿é—®è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå³çº¿ç¨‹ä¸­çš„æœ¬åœ°å˜é‡å¯¹å…¶ä»–çº¿ç¨‹æ˜¯ä¸å¯è§çš„ï¼Œå³ä½¿ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ˜¯åŒä¸€æ®µä»£ç ï¼Œå®ƒä»¬ä¹Ÿä¼šå„è‡ªåœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­åˆ›å»ºå±äºå½“å‰çº¿ç¨‹çš„æœ¬åœ°å˜é‡ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬å­—èŠ‚ç è¡Œå·æŒ‡ç¤ºå™¨ã€ç›¸å…³Nativeæ–¹æ³•çš„ä¿¡æ¯ã€‚æ³¨æ„ï¼Œç”±äºå·¥ä½œå†…å­˜æ˜¯æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œçº¿ç¨‹é—´æ— æ³•ç›¸äº’è®¿é—®å·¥ä½œå†…å­˜ï¼Œå› æ­¤å­˜å‚¨åœ¨å·¥ä½œå†…å­˜çš„æ•°æ®ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

JMMè§„å®šï¼š

1. æ‰€æœ‰å˜é‡å­˜å‚¨åœ¨ä¸»å­˜ä¸­
2. æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œä¸”å¯¹å˜é‡çš„æ“ä½œéƒ½æ˜¯åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œçš„
3. ä¸åŒçº¿ç¨‹ä¹‹é—´æ— æ³•ç›´æ¥è®¿é—®å½¼æ­¤å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œè¦æƒ³è®¿é—®åªèƒ½é€šè¿‡ä¸»å­˜æ¥ä¼ é€’ã€‚

![image-20220624105619768](./images/image-20220624105619768.png)

    JMMå°†æ‰€æœ‰çš„å˜é‡éƒ½å­˜æ”¾åœ¨å…¬å…±ä¸»å­˜ä¸­ï¼Œå½“çº¿ç¨‹ä½¿ç”¨å˜é‡æ—¶ï¼Œä¼šæŠŠå…¬å…±ä¸»å­˜ä¸­çš„å˜é‡å¤åˆ¶åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆæˆ–è€…å«ä½œç§æœ‰å†…å­˜ï¼‰ä¸­ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„è¯»å†™æ“ä½œæ˜¯è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­çš„å˜é‡å‰¯æœ¬ã€‚å› æ­¤ï¼ŒJMMæ¨¡å‹ä¹Ÿéœ€è¦è§£å†³ä»£ç é‡æ’åºå’Œç¼“å­˜å¯è§æ€§é—®é¢˜ã€‚JMMæä¾›äº†ä¸€å¥—è‡ªå·±çš„æ–¹æ¡ˆå»ç¦ç”¨ç¼“å­˜ä»¥åŠç¦æ­¢é‡æ’åºæ¥è§£å†³è¿™äº›å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜ã€‚JMMæä¾›çš„æ–¹æ¡ˆåŒ…æ‹¬å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰çš„volatileã€synchronizedã€finalç­‰ã€‚JMMå®šä¹‰äº†ä¸€äº›å†…å­˜æ“ä½œçš„æŠ½è±¡æŒ‡ä»¤é›†ï¼Œç„¶åå°†è¿™äº›æŠ½è±¡æŒ‡ä»¤åŒ…å«åˆ°Javaçš„volatileã€synchronizedç­‰å…³é”®å­—çš„è¯­ä¹‰ä¸­ï¼Œå¹¶è¦æ±‚JVMåœ¨å®ç°è¿™äº›å…³é”®å­—æ—¶å¿…é¡»å…·å¤‡å…¶åŒ…å«çš„JMMæŠ½è±¡æŒ‡ä»¤çš„èƒ½åŠ›ã€‚

ä¸¾ä¸ªğŸŒ° å¦‚æœçº¿ç¨‹Aä¸çº¿ç¨‹Bä¹‹é—´è¦é€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»å†ä¸‹é¢2ä¸ªæ­¥éª¤ã€‚

1ï¼‰çº¿ç¨‹AæŠŠæœ¬åœ°å†…å­˜Aä¸­æ›´æ–°è¿‡çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚

2ï¼‰çº¿ç¨‹Båˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹Aä¹‹å‰å·²æ›´æ–°è¿‡çš„å…±äº«å˜é‡ã€‚

![image-20220624112700211](./images/image-20220624112700211.png)

æ³¨æ„ï¼Œæ ¹æ®JMMçš„è§„å®šï¼Œ**çº¿ç¨‹å¯¹å…±äº«å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨è‡ªå·±çš„æœ¬åœ°å†…å­˜ä¸­è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥ä»ä¸»å†…å­˜ä¸­è¯»å–**ã€‚

æ‰€ä»¥çº¿ç¨‹Bå¹¶ä¸æ˜¯ç›´æ¥å»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡çš„å€¼ï¼Œè€Œæ˜¯å…ˆåœ¨æœ¬åœ°å†…å­˜Bä¸­æ‰¾åˆ°è¿™ä¸ªå…±äº«å˜é‡ï¼Œå‘ç°è¿™ä¸ªå…±äº«å˜é‡å·²ç»è¢«æ›´æ–°äº†ï¼Œç„¶åæœ¬åœ°å†…å­˜Bå»ä¸»å†…å­˜ä¸­è¯»å–è¿™ä¸ªå…±äº«å˜é‡çš„æ–°å€¼ï¼Œå¹¶æ‹·è´åˆ°æœ¬åœ°å†…å­˜Bä¸­ï¼Œæœ€åçº¿ç¨‹Bå†è¯»å–æœ¬åœ°å†…å­˜Bä¸­çš„æ–°å€¼ã€‚

é‚£ä¹ˆæ€ä¹ˆçŸ¥é“è¿™ä¸ªå…±äº«å˜é‡çš„è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°äº†å‘¢ï¼Ÿè¿™å°±æ˜¯JMMçš„åŠŸåŠ³äº†ï¼Œä¹Ÿæ˜¯JMMå­˜åœ¨çš„å¿…è¦æ€§ä¹‹ä¸€ã€‚**JMMé€šè¿‡æ§åˆ¶ä¸»å†…å­˜ä¸æ¯ä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¹‹é—´çš„äº¤äº’ï¼Œæ¥æä¾›å†…å­˜å¯è§æ€§ä¿è¯**ã€‚

> è§£å†³æ··æ·†é—®é¢˜ï¼šJVMå’ŒJMMçš„åŒºåˆ«ï¼Ÿ

- åŒºåˆ«

  ä¸¤è€…æ˜¯ä¸åŒçš„æ¦‚å¿µå±‚æ¬¡ã€‚JMMæ˜¯æŠ½è±¡çš„ï¼Œä»–æ˜¯ç”¨æ¥æè¿°ä¸€ç»„è§„åˆ™ï¼Œé€šè¿‡è¿™ä¸ªè§„åˆ™æ¥æ§åˆ¶å„ä¸ªå˜é‡çš„è®¿é—®æ–¹å¼ï¼Œå›´ç»•åŸå­æ€§ã€æœ‰åºæ€§ã€å¯è§æ€§ç­‰å±•å¼€çš„ã€‚è€ŒJavaè¿è¡Œæ—¶å†…å­˜çš„åˆ’åˆ†æ˜¯å…·ä½“çš„ï¼Œæ˜¯JVMè¿è¡ŒJavaç¨‹åºæ—¶ï¼Œå¿…è¦çš„å†…å­˜åˆ’åˆ†ã€‚

- è”ç³»

  éƒ½å­˜åœ¨ç§æœ‰æ•°æ®åŒºåŸŸå’Œå…±äº«æ•°æ®åŒºåŸŸã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒJMMä¸­çš„ä¸»å†…å­˜å±äºå…±äº«æ•°æ®åŒºåŸŸï¼Œä»–æ˜¯åŒ…å«äº†å †å’Œæ–¹æ³•åŒºï¼›åŒæ ·ï¼ŒJMMä¸­çš„æœ¬åœ°å†…å­˜å±äºç§æœ‰æ•°æ®åŒºåŸŸï¼ŒåŒ…å«äº†ç¨‹åºè®¡æ•°å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆã€è™šæ‹Ÿæœºæ ˆã€‚

æœ€åå†é™„ä¸ŠJVMçš„è¿è¡Œæ—¶æ•°æ®åŒº

![image-20220624110312966](./images/image-20220624110312966.png)

#### é‡æ’åº

ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’ŒCPUå¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚é‡æ’åºä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šç¼–è¯‘å™¨é‡æ’åºå’ŒCPUé‡æ’åº

![image-20220626134324559](./images/image-20220626134324559.png)

**ç¼–è¯‘å™¨é‡æ’åº**æŒ‡çš„æ˜¯åœ¨ä»£ç ç¼–è¯‘é˜¶æ®µè¿›è¡ŒæŒ‡ä»¤é‡æ’ï¼Œä¸æ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„æƒ…å†µä¸‹ï¼Œä¸ºäº†æå‡æ•ˆç‡ï¼Œç¼–è¯‘å™¨å¯¹æŒ‡ä»¤è¿›è¡Œä¹±åºï¼ˆOut-of-Orderï¼‰çš„ç¼–è¯‘ã€‚

ç¼–è¯‘å™¨ä¸ºä»€ä¹ˆè¦é‡æ’åºï¼ˆRe-Orderï¼‰å‘¢ï¼Ÿå®ƒçš„ç›®çš„ä¸ºï¼šä¸å…¶ç­‰å¾…é˜»å¡æŒ‡ä»¤ï¼ˆå¦‚ç­‰å¾…ç¼“å­˜åˆ·å…¥ï¼‰å®Œæˆï¼Œä¸å¦‚å…ˆå»æ‰§è¡Œå…¶ä»–æŒ‡ä»¤ã€‚ä¸CPUä¹±åºæ‰§è¡Œç›¸æ¯”ï¼Œç¼–è¯‘å™¨é‡æ’åºèƒ½å¤Ÿå®Œæˆæ›´å¤§èŒƒå›´ã€æ•ˆæœæ›´å¥½çš„ä¹±åºä¼˜åŒ–ã€‚

**CPUé‡æ’åº**åŒ…æ‹¬ä¸¤ç±»ï¼šæŒ‡ä»¤çº§é‡æ’åºå’Œå†…å­˜ç³»ç»Ÿé‡æ’åº

* æŒ‡ä»¤çº§é‡æ’åºã€‚åœ¨ä¸å½±å“ç¨‹åºæ‰§è¡Œç»“æœçš„æƒ…å†µä¸‹ï¼ŒCPUå†…æ ¸é‡‡ç”¨ILPï¼ˆInstruction-Level Parallelismï¼ŒæŒ‡ä»¤çº§å¹¶è¡Œè¿ç®—ï¼‰æŠ€æœ¯æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œï¼Œä¸»è¦æ˜¯ä¸ºäº†æå‡æ•ˆç‡ã€‚å¦‚æœæŒ‡ä»¤ä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼ŒCPUå°±å¯ä»¥æ”¹å˜è¯­å¥çš„å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåº
* å†…å­˜ç³»ç»Ÿé‡æ’åºï¼šå¯¹äºç°ä»£çš„CPUæ¥è¯´ï¼Œåœ¨CPUå†…æ ¸å’Œä¸»å­˜ä¹‹é—´éƒ½å…·å¤‡ä¸€ä¸ªé«˜é€Ÿç¼“å­˜ï¼Œé«˜é€Ÿç¼“å­˜çš„ä½œç”¨ä¸»è¦æ˜¯å‡å°‘CPUå†…æ ¸å’Œä¸»å­˜çš„äº¤äº’ï¼ˆCPUå†…æ ¸çš„å¤„ç†é€Ÿåº¦è¦å¿«å¾—å¤šï¼‰ï¼Œåœ¨CPUå†…æ ¸è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œå¦‚æœç¼“å­˜æ²¡æœ‰çš„è¯å°±ä»ä¸»å­˜å–ï¼Œè€Œå¯¹äºå†™æ“ä½œéƒ½æ˜¯å…ˆå†™åœ¨ç¼“å­˜ä¸­ï¼Œæœ€åå†ä¸€æ¬¡æ€§å†™å…¥ä¸»å­˜ï¼ŒåŸå› æ˜¯å‡å°‘è·Ÿä¸»å­˜äº¤äº’æ—¶CPUå†…æ ¸çš„çŸ­æš‚å¡é¡¿ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œå†…å­˜ç³»ç»Ÿé‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜â€”â€”æ•°æ®ä¸ä¸€è‡´ã€‚

#### As-if-Serialè§„åˆ™

åœ¨å•æ ¸CPUçš„åœºæ™¯ä¸‹ï¼Œå½“æŒ‡ä»¤è¢«é‡æ’åºä¹‹åï¼Œå¦‚ä½•ä¿éšœè¿è¡Œçš„æ­£ç¡®æ€§å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œç¼–è¯‘å™¨å’ŒCPUéƒ½éœ€è¦éµå®ˆAs-if-Serialè§„åˆ™ã€‚

As-if-Serialè§„åˆ™çš„å…·ä½“å†…å®¹ä¸ºï¼šæ— è®ºå¦‚ä½•é‡æ’åºï¼Œéƒ½å¿…é¡»ä¿è¯ä»£ç åœ¨å•çº¿ç¨‹ä¸‹è¿è¡Œæ­£ç¡®ã€‚

ä¸ºäº†éµå®ˆAs-if-Serialè§„åˆ™ï¼Œç¼–è¯‘å™¨å’ŒCPUä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œè¿›è¡Œé‡æ’åºï¼Œå› ä¸ºè¿™ç§é‡æ’åºä¼šæ”¹å˜æ‰§è¡Œç»“æœã€‚ä½†æ˜¯ï¼Œå¦‚æœæŒ‡ä»¤ä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œè¿™äº›æŒ‡ä»¤å¯èƒ½è¢«ç¼–è¯‘å™¨å’ŒCPUé‡æ’åºã€‚

As-if-Serialè§„åˆ™åªèƒ½ä¿éšœå•å†…æ ¸æŒ‡ä»¤é‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœæ­£ç¡®ï¼Œä¸èƒ½ä¿éšœå¤šå†…æ ¸ä»¥åŠè·¨CPUæŒ‡ä»¤é‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœæ­£ç¡®ã€‚

#### Happens-Beforeè§„åˆ™

> **ç¨‹åºæ¬¡åºè§„åˆ™**ï¼ˆProgram Order Ruleï¼‰ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§æ§åˆ¶æµé¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿï¼ˆHappens-beforeï¼‰äºä¹¦å†™åœ¨åé¢çš„æ“ä½œã€‚æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯æ§åˆ¶æµé¡ºåºè€Œä¸æ˜¯ç¨‹åºä»£ç é¡ºåºï¼Œå› ä¸ºè¦è€ƒè™‘åˆ†æ”¯ã€å¾ªç¯ç­‰ç»“æ„ã€‚

ä¸¾çš„ä¾‹å­ï¼š

```java
int a = 1; 		// A
int b = 2;		// B
int c = a + b;	// C
```

æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼Œä¸Šè¿°ä»£ç å­˜åœ¨ 3 ä¸ª Happens-before å…³ç³»ï¼š

- A Happens-before B
- B Happens-before C
- A Happens-before C

> **ç®¡ç¨‹é”å®šè§„åˆ™**ï¼ˆMonitor Lock Ruleï¼‰ï¼šä¸€ä¸ª unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚è¿™é‡Œå¿…é¡»å¼ºè°ƒçš„æ˜¯ â€œåŒä¸€ä¸ªé”â€ï¼Œè€Œ â€œåé¢â€ æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåã€‚

è¿™ä¸ªè§„åˆ™å…¶å®å°±æ˜¯é’ˆå¯¹ synchronized çš„ã€‚JVM å¹¶æ²¡æœ‰æŠŠ `lock` å’Œ `unlock` æ“ä½œç›´æ¥å¼€æ”¾ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œä½†æ˜¯å´æä¾›äº†æ›´é«˜å±‚æ¬¡çš„å­—èŠ‚ç æŒ‡ä»¤ `monitorenter` å’Œ `monitorexit` æ¥éšå¼åœ°ä½¿ç”¨è¿™ä¸¤ä¸ªæ“ä½œã€‚è¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤åæ˜ åˆ° Java ä»£ç ä¸­å°±æ˜¯åŒæ­¥å— â€” `synchronized`ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

```java
synchronized (this) { // æ­¤å¤„è‡ªåŠ¨åŠ é”
	if (x > 1) {
        x = 1;
    }    
} // æ­¤å¤„è‡ªåŠ¨è§£é”
```

æ ¹æ®ç®¡ç¨‹é”å®šè§„åˆ™ï¼Œå‡è®¾ x çš„åˆå§‹å€¼æ˜¯ 10ï¼Œçº¿ç¨‹ A æ‰§è¡Œå®Œä»£ç å—å x çš„å€¼ä¼šå˜æˆ 1ï¼Œæ‰§è¡Œå®Œè‡ªåŠ¨é‡Šæ”¾é”ï¼Œçº¿ç¨‹ B è¿›å…¥ä»£ç å—æ—¶ï¼Œèƒ½å¤Ÿçœ‹åˆ°çº¿ç¨‹ A å¯¹ x çš„å†™æ“ä½œï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ B èƒ½å¤Ÿçœ‹åˆ° x == 1ã€‚

> **volatile å˜é‡è§„åˆ™**ï¼ˆVolatile Variable Ruleï¼‰ï¼šå¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œï¼Œè¿™é‡Œçš„ â€œåé¢â€ åŒæ ·æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåã€‚

è¿™ä¸ªè§„åˆ™å°±æ˜¯ JDK 1.5 ç‰ˆæœ¬å¯¹ volatile è¯­ä¹‰çš„å¢å¼ºï¼Œå…¶æ„ä¹‰ä¹‹é‡å¤§ï¼Œé ç€è¿™ä¸ªè§„åˆ™æå®šå¯è§æ€§æ˜“å¦‚åæŒã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

![image-20220626135043138](./images/image-20220626135043138.png)

å‡è®¾çº¿ç¨‹ A æ‰§è¡Œ writer() æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹ B æ‰§è¡Œ reader() æ–¹æ³•ã€‚

æ ¹æ®æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼š1 Happens-before 2ï¼›3 Happens-before 4ã€‚

æ ¹æ® volatile å˜é‡è§„åˆ™ï¼š2 Happens-before 3ã€‚

æ ¹æ®ä¼ é€’æ€§è§„åˆ™ï¼š1 Happens-before 3ï¼›1 Happens-before 4ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœçº¿ç¨‹ B è¯»åˆ°äº† â€œflag==trueâ€ æˆ–è€… â€œint i = aâ€ é‚£ä¹ˆçº¿ç¨‹ A è®¾ç½®çš„â€œa=42â€å¯¹çº¿ç¨‹ B æ˜¯å¯è§çš„ã€‚

çœ‹ä¸‹å›¾ï¼š

![image-20220626135050496](./images/image-20220626135050496.png)

> **çº¿ç¨‹å¯åŠ¨è§„åˆ™**ï¼ˆThread Start Ruleï¼‰ï¼šThread å¯¹è±¡çš„ start() æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚

> **çº¿ç¨‹ç»ˆæ­¢è§„åˆ™**ï¼ˆThread Termination Ruleï¼‰ï¼šçº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºå¯¹æ­¤çº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Thread å¯¹è±¡çš„ join() æ–¹æ³•æ˜¯å¦ç»“æŸã€Thread å¯¹è±¡çš„ isAlive() çš„è¿”å›å€¼ç­‰æ‰‹æ®µæ£€æµ‹çº¿ç¨‹æ˜¯å¦å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚

> **çº¿ç¨‹ä¸­æ–­è§„åˆ™**ï¼ˆThread Interruption Ruleï¼‰ï¼šå¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡ Thread å¯¹è±¡çš„ interrupted() æ–¹æ³•æ£€æµ‹åˆ°æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚

> **å¯¹è±¡ç»ˆç»“è§„åˆ™**ï¼ˆFinalizer Ruleï¼‰ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼ˆæ„é€ å‡½æ•°æ‰§è¡Œç»“æŸï¼‰å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹ã€‚

> **ä¼ é€’æ€§**ï¼ˆTransitivityï¼‰ï¼šå¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œæ“ä½œ B å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œé‚£å°±å¯ä»¥å¾—å‡ºæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ C çš„ç»“è®ºã€‚

### èŠèŠvolatile

å…ˆè¦ä» **CPU ç¼“å­˜æ¨¡å‹** è¯´èµ·

**ä¸ºä»€ä¹ˆè¦å¼„ä¸€ä¸ª CPU é«˜é€Ÿç¼“å­˜å‘¢ï¼Ÿ** **CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ã€‚**

ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€ä¸ªç®€å•çš„ CPU Cache ç¤ºæ„å›¾å¦‚ä¸‹ï¼ˆå®é™…ä¸Šï¼Œç°ä»£çš„ CPU Cache é€šå¸¸åˆ†ä¸ºä¸‰å±‚ï¼Œåˆ†åˆ«å« L1,L2,L3 Cacheï¼‰:

![image-20220624113325156](./images/image-20220624113325156.png)

**CPU Cache çš„å·¥ä½œæ–¹å¼ï¼š**

å…ˆå¤åˆ¶ä¸€ä»½æ•°æ®åˆ° CPU Cache ä¸­ï¼Œå½“ CPU éœ€è¦ç”¨åˆ°çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä» CPU Cache ä¸­è¯»å–æ•°æ®ï¼Œå½“è¿ç®—å®Œæˆåï¼Œå†å°†è¿ç®—å¾—åˆ°çš„æ•°æ®å†™å› Main Memory ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™æ ·å­˜åœ¨ **å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§çš„é—®é¢˜** ï¼æ¯”å¦‚æˆ‘æ‰§è¡Œä¸€ä¸ª i++æ“ä½œçš„è¯ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œçš„è¯ï¼Œå‡è®¾ä¸¤ä¸ªçº¿ç¨‹ä» CPU Cache ä¸­è¯»å–çš„ i=1ï¼Œä¸¤ä¸ªçº¿ç¨‹åšäº† 1++è¿ç®—å®Œä¹‹åå†å†™å› Main Memory ä¹‹å i=2ï¼Œè€Œæ­£ç¡®ç»“æœåº”è¯¥æ˜¯ i=3ã€‚

**CPU ä¸ºäº†è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜å¯ä»¥é€šè¿‡åˆ¶å®šç¼“å­˜ä¸€è‡´åè®®æˆ–è€…å…¶ä»–æ‰‹æ®µæ¥è§£å†³ã€‚**

å‰é¢ä»‹ç»è¿‡ï¼Œä¸ºäº†è§£å†³CPUè®¿é—®ä¸»å­˜æ—¶ä¸»å­˜è¯»å†™æ€§èƒ½çš„çŸ­æ¿ï¼Œåœ¨CPUä¸­å¢åŠ äº†é«˜é€Ÿç¼“å­˜ï¼Œä½†è¿™å¸¦æ¥äº†å¯è§æ€§é—®é¢˜ã€‚è€ŒJavaçš„**volatileå…³é”®å­—å¯ä»¥ä¿è¯å…±äº«å˜é‡çš„ä¸»å­˜å¯è§æ€§ï¼Œä¹Ÿå°±æ˜¯å°†å…±äº«å˜é‡çš„æ”¹åŠ¨å€¼ç«‹å³åˆ·æ–°å›ä¸»å­˜**ã€‚åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œç³»ç»Ÿæ“ä½œå¹¶ä¸ä¼šæ ¡éªŒå…±äº«å˜é‡çš„ç¼“å­˜ä¸€è‡´æ€§ï¼Œåªæœ‰å½“å…±äº«å˜é‡ç”¨volatileå…³é”®å­—ä¿®é¥°äº†ï¼Œè¯¥å˜é‡æ‰€åœ¨çš„ç¼“å­˜è¡Œæ‰è¢«è¦æ±‚è¿›è¡Œç¼“å­˜ä¸€è‡´æ€§çš„æ ¡éªŒã€‚

> ğŸ“–ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ä¸­è¿™æ ·è¯´åˆ°ï¼š
>
>     Javaè¯­è¨€æä¾›äº†ä¸€ç§ç¨å¼±çš„åŒæ­¥æœºåˆ¶ï¼Œå³volatileå˜é‡ï¼Œç”¨æ¥ç¡®ä¿å°†å˜é‡çš„æ›´æ–°æ“ä½œé€šçŸ¥åˆ°å…¶ä»–çº¿ç¨‹ã€‚å½“æŠŠå˜é‡å£°æ˜ä¸ºvolatileç±»å‹åï¼Œç¼–è¯‘å™¨ä¸è¿è¡Œæ—¶éƒ½ä¼šæ³¨æ„åˆ°è¿™ä¸ªå˜é‡æ˜¯å…±äº«çš„ï¼Œå› æ­¤ä¸ä¼šå°†è¯¥å˜é‡ä¸Šçš„æ“ä½œä¸å…¶ä»–å†…å­˜æ“ä½œä¸€èµ·é‡æ’åºã€‚volatileå˜é‡ä¸ä¼šè¢«ç¼“å­˜åœ¨å¯„å­˜å™¨æˆ–è€…å¯¹å…¶ä»–å¤„ç†å™¨ä¸å¯è§çš„åœ°æ–¹ï¼Œå› æ­¤åœ¨è¯»å–volatileç±»å‹çš„å˜é‡æ—¶æ€»ä¼šè¿”å›æœ€æ–°å†™å…¥çš„å€¼
>
>     volatileå˜é‡å¯¹å¯è§æ€§çš„å½±å“æ¯”volatileå˜é‡æœ¬èº«æ›´ä¸ºé‡è¦ã€‚å½“çº¿ç¨‹Aé¦–å…ˆå†™å…¥ä¸€ä¸ªvolatileå˜é‡å¹¶ä¸”çº¿ç¨‹Béšåè¯»å–è¯¥å˜é‡æ—¶ï¼Œåœ¨å†™å…¥volatileå˜é‡ä¹‹å‰å¯¹Aå¯è§çš„æ‰€æœ‰å˜é‡çš„å€¼ï¼Œåœ¨Bè¯»å–äº†volatileå˜é‡åï¼Œå¯¹Bä¹Ÿæ˜¯å¯è§çš„ã€‚å› æ­¤ï¼Œ**ä»å†…å­˜å¯è§æ€§çš„è§’åº¦æ¥çœ‹ï¼Œå†™å…¥volatileå˜é‡ç›¸å½“äºé€€å‡ºåŒæ­¥ä»£ç å—ï¼Œè€Œè¯»å–volatileå˜é‡å°±ç›¸å½“äºè¿›å…¥åŒæ­¥ä»£ç å—**ã€‚

### CAS æ˜¯ä»€ä¹ˆï¼Ÿ

cas å«åš CompareAndSwapï¼Œ**æ¯”è¾ƒå¹¶äº¤æ¢**ï¼Œå¾ˆå¤šåœ°æ–¹ä½¿ç”¨åˆ°äº†å®ƒï¼Œæ¯”å¦‚é”å‡çº§ä¸­è‡ªæ—‹é”å°±æœ‰ç”¨åˆ°ï¼Œä¸»è¦æ˜¯**é€šè¿‡å¤„ç†å™¨çš„æŒ‡ä»¤æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§**ï¼Œå®ƒä¸»è¦åŒ…å«ä¸‰ä¸ªå˜é‡ï¼š

- **1.å˜é‡å†…å­˜åœ°å€**
- **2.æ—§çš„é¢„æœŸå€¼ A**
- **3.å‡†å¤‡è®¾ç½®çš„æ–°å€¼ B**

å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦ä¿®æ”¹ä¸€ä¸ªå…±äº«å˜é‡çš„å€¼ï¼Œå®Œæˆè¿™ä¸ªæ“ä½œéœ€è¦å…ˆå–å‡ºå…±äº«å˜é‡çš„å€¼ï¼Œèµ‹ç»™ Aï¼ŒåŸºäº A è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°æ–°å€¼ Bï¼Œåœ¨ç”¨é¢„æœŸåŸå€¼ A å’Œå†…å­˜ä¸­çš„å…±äº«å˜é‡å€¼è¿›è¡Œæ¯”è¾ƒï¼Œ**å¦‚æœç›¸åŒå°±è®¤ä¸ºå…¶ä»–çº¿ç¨‹æ²¡æœ‰è¿›è¡Œä¿®æ”¹**ï¼Œè€Œå°†æ–°å€¼å†™å…¥å†…å­˜

**CASçš„ç¼ºç‚¹**

- **CPUå¼€é”€æ¯”è¾ƒå¤§**ï¼šåœ¨å¹¶å‘é‡æ¯”è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œå¦‚æœè®¸å¤šçº¿ç¨‹åå¤å°è¯•æ›´æ–°æŸä¸€ä¸ªå˜é‡ï¼Œå´åˆä¸€ç›´æ›´æ–°ä¸æˆåŠŸï¼Œåˆå› ä¸º**è‡ªæ—‹**çš„æ—¶å€™ä¼šä¸€ç›´å ç”¨CPUï¼Œå¦‚æœCASä¸€ç›´æ›´æ–°ä¸æˆåŠŸå°±ä¼šä¸€ç›´å ç”¨ï¼Œé€ æˆCPUçš„æµªè´¹ã€‚
- **ABA é—®é¢˜**ï¼šæ¯”å¦‚çº¿ç¨‹ A å»ä¿®æ”¹ 1 è¿™ä¸ªå€¼ï¼Œä¿®æ”¹æˆåŠŸäº†ï¼Œä½†æ˜¯ä¸­é—´ çº¿ç¨‹ B ä¹Ÿä¿®æ”¹äº†è¿™ä¸ªå€¼ï¼Œä½†æ˜¯ä¿®æ”¹åçš„ç»“æœè¿˜æ˜¯ 1ï¼Œæ‰€ä»¥ä¸å½±å“ A çš„æ“ä½œï¼Œè¿™å°±ä¼šæœ‰é—®é¢˜ã€‚å¯ä»¥ç”¨**ç‰ˆæœ¬å·**æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
- **åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§**

> ğŸ“–ã€Šofferæ¥äº†ã€‹è¿™æ ·å®šä¹‰CASçš„ï¼š**CASï¼ˆCompare And Swapï¼‰**æŒ‡æ¯”è¾ƒå¹¶äº¤æ¢ã€‚CASç®—æ³•CAS(V, E, N)åŒ…å«3ä¸ªå‚æ•°ï¼ŒVè¡¨ç¤ºè¦æ›´æ–°çš„å˜é‡ï¼ŒEè¡¨ç¤ºé¢„æœŸçš„å€¼ï¼ŒNè¡¨ç¤ºæ–°å€¼ã€‚åœ¨ä¸”ä»…åœ¨Vå€¼ç­‰äº Eå€¼æ—¶ï¼Œæ‰ä¼šå°†Vå€¼è®¾ä¸º Nï¼Œå¦‚æœ Vå€¼å’Œ Eå€¼ä¸åŒï¼Œåˆ™è¯´æ˜å·²ç»æœ‰å…¶ä»–çº¿ç¨‹åšäº†æ›´æ–°ï¼Œå½“å‰çº¿ç¨‹ä»€ä¹ˆéƒ½ä¸åšã€‚æœ€åï¼ŒCASè¿”å›å½“å‰Vçš„çœŸå®å€¼ã€‚
>
> * CASçš„ç‰¹æ€§ï¼šä¹è§‚é”
> * CASè‡ªæ—‹ç­‰å¾…ï¼šåœ¨JDKçš„åŸå­åŒ…java.util.concurrent.atomicé‡Œé¢æä¾›äº†ä¸€ç»„åŸå­ç±»ï¼Œè¿™äº›åŸå­ç±»çš„åŸºæœ¬ç‰¹æ€§å°±æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåœ¨æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œè¿™äº›ç±»çš„å®ä¾‹åŒ…å«çš„æ–¹æ³•æ—¶ï¼Œä¼šæœ‰æ’ä»–æ€§ã€‚å…¶å†…éƒ¨ä¾¿æ˜¯åŸºäºCASç®—æ³•å®ç°çš„ï¼Œå³åœ¨æŸä¸ªçº¿ç¨‹è¿›å…¥æ–¹æ³•ä¸­æ‰§è¡Œå…¶ä¸­çš„æŒ‡ä»¤æ—¶ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ï¼›è€Œåˆ«çš„çº¿ç¨‹å°±åƒè‡ªæ—‹é”ä¸€æ ·ï¼Œä¸€ç›´ç­‰åˆ°è¯¥æ–¹æ³•æ‰§è¡Œå®Œæˆæ‰ç”±JVMä»ç­‰å¾…çš„é˜Ÿåˆ—ä¸­é€‰æ‹©å¦ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ã€‚

> ğŸ™‹ç¬”è€…è®¤ä¸ºä»‹ç»CASæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä¸¾ä¸ªğŸŒ°ç»™é¢è¯•å®˜å¬ï¼š
>
> å‡å¦‚æŸä¸ªå†…å­˜åœ°å€ï¼ˆæŸå¯¹è±¡çš„å±æ€§ï¼‰çš„å€¼ä¸º100ï¼Œç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼ˆçº¿ç¨‹Aå’Œçº¿ç¨‹Bï¼‰ä½¿ç”¨CASæ— é”ç¼–ç¨‹å¯¹è¯¥å†…å­˜åœ°å€è¿›è¡Œæ›´æ–°ï¼Œçº¿ç¨‹Aæ¬²å°†å…¶å€¼æ›´æ–°ä¸º200ï¼Œçº¿ç¨‹Bæ¬²å°†å…¶å€¼æ›´æ–°ä¸º300ï¼Œå¦‚å›¾3-1æ‰€ç¤ºã€‚
>
> çº¿ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œè°éƒ½æœ‰å¯èƒ½å…ˆæ‰§è¡Œã€‚ä½†æ˜¯CASæ˜¯åŸå­æ“ä½œï¼Œå¯¹åŒä¸€ä¸ªå†…å­˜åœ°å€çš„CASæ“ä½œåœ¨åŒä¸€æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€ä¸ªã€‚å› æ­¤ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¦ä¹ˆçº¿ç¨‹Aå…ˆæ‰§è¡Œï¼Œè¦ä¹ˆçº¿ç¨‹Bå…ˆæ‰§è¡Œã€‚å‡è®¾çº¿ç¨‹Açš„CAS(100,200)æ‰§è¡Œåœ¨å‰ï¼Œç”±äºå†…å­˜åœ°å€çš„æ—§å€¼100ä¸è¯¥CASçš„æœŸæœ›å€¼100ç›¸ç­‰ï¼Œå› æ­¤çº¿ç¨‹Aä¼šæ“ä½œæˆåŠŸï¼Œå†…å­˜åœ°å€çš„å€¼è¢«æ›´æ–°ä¸º200ã€‚ï¼ˆå›¾æ¥è‡ªã€ŠJavaé«˜å¹¶å‘æ ¸å¿ƒç¼–ç¨‹ã€‹ï¼‰
>
> ![image-20220626202716155](./images/image-20220626202716155.png)
>
> çº¿ç¨‹Aæ‰§è¡ŒCAS(100,200)æˆåŠŸä¹‹åï¼Œå†…å­˜åœ°å€çš„
>
> ![image-20220626202746011](./images/image-20220626202746011.png)
>
> æ¥ä¸‹æ¥æ‰§è¡Œçº¿ç¨‹Bçš„CAS(100,300)æ“ä½œï¼Œæ­¤æ—¶å†…å­˜åœ°å€çš„å€¼ä¸º200ï¼Œä¸ç­‰äºCASçš„æœŸæœ›å€¼100ï¼Œçº¿ç¨‹Bæ“ä½œå¤±è´¥ã€‚çº¿ç¨‹Båªèƒ½è‡ªæ—‹ï¼Œå¼€å§‹æ–°çš„å¾ªç¯ï¼Œè¿™ä¸€è½®å¾ªç¯é¦–å…ˆè·å–åˆ°å†…å­˜åœ°å€çš„å€¼200ï¼Œç„¶åè¿›è¡ŒCAS(200,300)æ“ä½œï¼Œè¿™ä¸€æ¬¡å†…å­˜åœ°å€çš„å€¼ä¸CASçš„é¢„æœŸå€¼ï¼ˆoldValueï¼‰ç›¸ç­‰ï¼Œçº¿ç¨‹Bæ“ä½œæˆåŠŸã€‚

#### ABAé—®é¢˜

ABA æ˜¯ CAS æ“ä½œçš„ä¸€ä¸ªç»å…¸é—®é¢˜ï¼Œå‡è®¾æœ‰ä¸€ä¸ªå˜é‡åˆå§‹å€¼ä¸º Aï¼Œä¿®æ”¹ä¸º Bï¼Œç„¶ååˆä¿®æ”¹ä¸º Aï¼Œè¿™ä¸ªå˜é‡å®é™…è¢«ä¿®æ”¹è¿‡äº†ï¼Œä½†æ˜¯ CAS æ“ä½œå¯èƒ½æ— æ³•æ„ŸçŸ¥åˆ°ã€‚

å¦‚æœæ˜¯æ•´å½¢è¿˜å¥½ï¼Œä¸ä¼šå½±å“æœ€ç»ˆç»“æœï¼Œä½†å¦‚æœæ˜¯å¯¹è±¡çš„å¼•ç”¨ç±»å‹åŒ…å«äº†å¤šä¸ªå˜é‡ï¼Œå¼•ç”¨æ²¡æœ‰å˜å®é™…ä¸ŠåŒ…å«çš„å˜é‡å·²ç»è¢«ä¿®æ”¹ï¼Œè¿™å°±ä¼šé€ æˆå¤§é—®é¢˜ã€‚

å¦‚ä½•è§£å†³ï¼Ÿæ€è·¯å…¶å®å¾ˆç®€å•ï¼Œåœ¨å˜é‡å‰åŠ ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°äº†å°±æŠŠç‰ˆæœ¬å·åŠ ä¸€ï¼Œç»“æœå¦‚ä¸‹ï¼š

![image-20220627105538790](./images/image-20220627105538790.png)

æœ€ç»ˆç»“æœéƒ½æ˜¯ A ä½†æ˜¯ç‰ˆæœ¬å·æ”¹å˜äº†ã€‚

ä» JDK 1.5 å¼€å§‹æä¾›äº† `AtomicStampedReference`ç±»ï¼Œè¿™ä¸ªç±»çš„ `compareAndSe `æ–¹æ³•é¦–å…ˆæ£€æŸ¥ `å½“å‰å¼•ç”¨`æ˜¯å¦ç­‰äº `é¢„æœŸå¼•ç”¨`ï¼Œå¹¶ä¸” `å½“å‰æ ‡å¿—`æ˜¯å¦ç­‰äº `é¢„æœŸæ ‡å¿—`ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚

#### è‡ªæ—‹å¼€é”€é—®é¢˜

CAS å‡ºç°å†²çªåå°±ä¼šå¼€å§‹ `è‡ªæ—‹`æ“ä½œï¼Œå¦‚æœèµ„æºç«äº‰éå¸¸æ¿€çƒˆï¼Œè‡ªæ—‹é•¿æ—¶é—´ä¸èƒ½æˆåŠŸå°±ä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„å¼€é”€ã€‚

è§£å†³æ–¹æ¡ˆï¼šå¯ä»¥è€ƒè™‘é™åˆ¶è‡ªæ—‹çš„æ¬¡æ•°ï¼Œé¿å…è¿‡åº¦æ¶ˆè€— CPUï¼›å¦å¤–è¿˜å¯ä»¥è€ƒè™‘å»¶è¿Ÿæ‰§è¡Œã€‚

#### åªèƒ½ä¿è¯å•ä¸ªå˜é‡çš„åŸå­æ€§

å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ CAS æ¥ä¿è¯åŸå­æ€§ï¼Œä½†æ˜¯å¦‚æœè¦å¯¹å¤šä¸ªå…±äº«å˜é‡è¿›è¡Œæ“ä½œæ—¶ï¼ŒCAS æ˜¯æ— æ³•ä¿è¯åŸå­æ€§çš„ï¼Œæ¯”å¦‚éœ€è¦å°† i å’Œ j åŒæ—¶åŠ  1ï¼š

i++ï¼›j++ï¼›

è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ synchronized è¿›è¡ŒåŠ é”ï¼Œæœ‰æ²¡æœ‰å…¶ä»–åŠæ³•å‘¢ï¼Ÿæœ‰ï¼Œå°†å¤šä¸ªå˜é‡æ“ä½œåˆæˆä¸€ä¸ªå˜é‡æ“ä½œã€‚ä» JDK1.5 å¼€å§‹æä¾›äº† `AtomicReference` ç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œä½ å¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡ŒCASæ“ä½œã€‚

### ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Ÿ

å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äºCPUæ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ªCPUæ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPUé‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼š**å½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®ŒCPUæ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚**ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„CPUæ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚

Linuxç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±»Unixç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚

### è¯´è¯´ sleep() æ–¹æ³•å’Œ wait() æ–¹æ³•åŒºåˆ«å’Œå…±åŒç‚¹?

- ä¸¤è€…æœ€ä¸»è¦çš„åŒºåˆ«åœ¨äºï¼š**`sleep()` æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ `wait()` æ–¹æ³•é‡Šæ”¾äº†é”** ã€‚
- ä¸¤è€…éƒ½å¯ä»¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œã€‚
- `wait()` é€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’/é€šä¿¡ï¼Œ`sleep() `é€šå¸¸è¢«ç”¨äºæš‚åœæ‰§è¡Œã€‚
- `wait()` æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ `notify() `æˆ–è€… `notifyAll()` æ–¹æ³•ã€‚`sleep() `æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚æˆ–è€…å¯ä»¥ä½¿ç”¨ `wait(long timeout)` è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚

### ä¸ºä»€ä¹ˆæˆ‘ä»¬è°ƒç”¨ start() æ–¹æ³•æ—¶ä¼šæ‰§è¡Œ run() æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨ run() æ–¹æ³•ï¼Ÿ

è¿™æ˜¯å¦ä¸€ä¸ªéå¸¸ç»å…¸çš„ Java å¤šçº¿ç¨‹é¢è¯•é—®é¢˜ï¼Œè€Œä¸”åœ¨é¢è¯•ä¸­ä¼šç»å¸¸è¢«é—®åˆ°ã€‚å¾ˆç®€å•ï¼Œä½†æ˜¯å¾ˆå¤šäººéƒ½ä¼šç­”ä¸ä¸Šæ¥ï¼

new ä¸€ä¸ª Threadï¼Œçº¿ç¨‹è¿›å…¥äº†æ–°å»ºçŠ¶æ€ã€‚è°ƒç”¨ `start()`æ–¹æ³•ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥äº†å°±ç»ªçŠ¶æ€ï¼Œå½“åˆ†é…åˆ°æ—¶é—´ç‰‡åå°±å¯ä»¥å¼€å§‹è¿è¡Œäº†ã€‚ `start()` ä¼šæ‰§è¡Œçº¿ç¨‹çš„ç›¸åº”å‡†å¤‡å·¥ä½œï¼Œç„¶åè‡ªåŠ¨æ‰§è¡Œ `run()` æ–¹æ³•çš„å†…å®¹ï¼Œè¿™æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹å·¥ä½œã€‚ ä½†æ˜¯ï¼Œç›´æ¥æ‰§è¡Œ `run()` æ–¹æ³•ï¼Œä¼šæŠŠ `run()` æ–¹æ³•å½“æˆä¸€ä¸ª main çº¿ç¨‹ä¸‹çš„æ™®é€šæ–¹æ³•å»æ‰§è¡Œï¼Œå¹¶ä¸ä¼šåœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œæ‰€ä»¥è¿™å¹¶ä¸æ˜¯å¤šçº¿ç¨‹å·¥ä½œã€‚

**æ€»ç»“ï¼š è°ƒç”¨ `start()` æ–¹æ³•æ–¹å¯å¯åŠ¨çº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œç›´æ¥æ‰§è¡Œ `run()` æ–¹æ³•çš„è¯ä¸ä¼šä»¥å¤šçº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œã€‚**

### synchronizedæ±‡æ€»

#### è¯´ä¸€è¯´è‡ªå·±å¯¹äº synchronized å…³é”®å­—çš„äº†è§£

**`synchronized` å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼Œ`synchronized`å…³é”®å­—å¯ä»¥ä¿è¯è¢«å®ƒä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åœ¨ä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚**

å¦å¤–ï¼Œåœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œ`synchronized` å±äº **é‡é‡çº§é”**ï¼Œæ•ˆç‡ä½ä¸‹ã€‚

**ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ**

å› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ `Mutex Lock` æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚

åº†å¹¸çš„æ˜¯åœ¨ Java 6 ä¹‹å Java å®˜æ–¹å¯¹ä» JVM å±‚é¢å¯¹ `synchronized` è¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„ `synchronized` é”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ã€‚JDK1.6 å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ã€‚

æ‰€ä»¥ï¼Œä½ ä¼šå‘ç°ç›®å‰çš„è¯ï¼Œä¸è®ºæ˜¯å„ç§å¼€æºæ¡†æ¶è¿˜æ˜¯ JDK æºç éƒ½å¤§é‡ä½¿ç”¨äº† `synchronized` å…³é”®å­—ã€‚

> ç¬”è€…ä¸ªäººè®¤ä¸ºã€Šofferæ¥äº†ã€‹é‡Œé¢è§£é‡ŠJavaä¸­çš„å…³é”®å­—æ˜¯çœŸçš„ä¸é”™ï¼Œä¸Šè¿°æˆªå–çš„Guideï¼Œä½†æ˜¯è¿‡äºæ™¦æ¶©ï¼Œæ‰€ä»¥æˆªå–äº†é‡Œé¢å¯¹synchronized çš„è§£é‡Šï¼š
>
> ğŸ™‹â€â™‚ï¸**synchronized**å…³é”®å­—ç”¨äºä¸ºJavaå¯¹è±¡ã€æ–¹æ³•ã€ä»£ç å—æä¾›çº¿ç¨‹å®‰å…¨çš„æ“ä½œã€‚synchronizedå±äºç‹¬å å¼çš„æ‚²è§‚é”ï¼ŒåŒæ—¶å±äºå¯é‡å…¥é”ã€‚åœ¨ä½¿ç”¨synchronizedä¿®é¥°å¯¹è±¡æ—¶ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹è¯¥å¯¹è±¡è¿›è¡Œè®¿é—®ï¼›åœ¨synchronizedä¿®é¥°æ–¹æ³•ã€ä»£ç å—æ—¶ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥æ–¹æ³•ä½“æˆ–ä»£ç å—ï¼Œå…¶ä»–çº¿ç¨‹åªæœ‰ç­‰å¾…å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•å¹¶é‡Šæ”¾é”èµ„æºåæ‰èƒ½è®¿é—®è¯¥å¯¹è±¡æˆ–æ‰§è¡ŒåŒæ­¥ä»£ç å—ã€‚Javaä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸ªmonitorå¯¹è±¡ï¼ŒåŠ é”å°±æ˜¯åœ¨ç«äº‰monitorï¼ˆç›‘è§†å™¨é”ï¼‰å¯¹è±¡ã€‚å¯¹ä»£ç å—åŠ é”æ˜¯é€šè¿‡åœ¨å‰ååˆ†åˆ«åŠ ä¸Šmonitorenterå’ŒmonitorexitæŒ‡ä»¤å®ç°çš„ï¼Œå¯¹æ–¹æ³•æ˜¯å¦åŠ é”æ˜¯é€šè¿‡ä¸€ä¸ªæ ‡è®°ä½æ¥åˆ¤æ–­çš„ã€‚

#### è®²ä¸€ä¸‹ synchronized å…³é”®å­—çš„åº•å±‚åŸç†

##### synchronized åŒæ­¥è¯­å¥å—çš„æƒ…å†µ

```java
public class SynchronizedDemo {
    public void method() {
        synchronized (this) {
            System.out.println("synchronized ä»£ç å—");
        }
    }
}
```

é€šè¿‡ JDK è‡ªå¸¦çš„ `javap` å‘½ä»¤æŸ¥çœ‹ `SynchronizedDemo` ç±»çš„ç›¸å…³å­—èŠ‚ç ä¿¡æ¯ï¼šé¦–å…ˆåˆ‡æ¢åˆ°ç±»çš„å¯¹åº”ç›®å½•æ‰§è¡Œ `javac SynchronizedDemo.java` å‘½ä»¤ç”Ÿæˆç¼–è¯‘åçš„ .class æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ `javap -c -s -v -l SynchronizedDemo.class`ã€‚

![image-20220620224445896](./images/image-20220620224445896.png)

ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š**`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚**

å½“æ‰§è¡Œ `monitorenter` æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å– **å¯¹è±¡ç›‘è§†å™¨ `monitor`** çš„æŒæœ‰æƒã€‚

> åœ¨ Java è™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitor æ˜¯åŸºäº C++å®ç°çš„ï¼Œç”±[ObjectMonitor](https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp)

> å®ç°çš„ã€‚æ¯ä¸ªå¯¹è±¡ä¸­éƒ½å†…ç½®äº†ä¸€ä¸ª `ObjectMonitor`å¯¹è±¡ã€‚
>
> å¦å¤–ï¼Œ`wait/notify`ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº `monitor`å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨ `wait/notify`ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º `java.lang.IllegalMonitorStateException`çš„å¼‚å¸¸çš„åŸå› ã€‚

åœ¨æ‰§è¡Œ `monitorenter`æ—¶ï¼Œä¼šå°è¯•è·å–å¯¹è±¡çš„é”ï¼Œå¦‚æœé”çš„è®¡æ•°å™¨ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ä»¥è¢«è·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º 1 ä¹Ÿå°±æ˜¯åŠ  1ã€‚

![image-20220620224454145](./images/image-20220620224454145.png)

å¯¹è±¡é”çš„çš„æ‹¥æœ‰è€…çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œ `monitorexit` æŒ‡ä»¤æ¥é‡Šæ”¾é”ã€‚åœ¨æ‰§è¡Œ `monitorexit` æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º 0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ã€‚

![image-20220620224500833](./images/image-20220620224500833.png)

å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚

##### synchronized ä¿®é¥°æ–¹æ³•çš„çš„æƒ…å†µ

```java
public class SynchronizedDemo2 {
    public synchronized void method() {
        System.out.println("synchronized æ–¹æ³•");
    }
}
```

![image-20220620224531013](./images/image-20220620224531013.png)

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚JVM é€šè¿‡è¯¥ `ACC_SYNCHRONIZED` è®¿é—®æ ‡å¿—æ¥è¾¨åˆ«ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨ã€‚

å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å®ä¾‹å¯¹è±¡çš„é”ã€‚å¦‚æœæ˜¯é™æ€æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å½“å‰ class çš„é”ã€‚

##### æ€»ç»“

`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚

**ä¸è¿‡ä¸¤è€…çš„æœ¬è´¨éƒ½æ˜¯å¯¹å¯¹è±¡ç›‘è§†å™¨ monitor çš„è·å–ã€‚**

#### è¯´è¯´ synchronized å…³é”®å­—å’Œ volatile å…³é”®å­—çš„åŒºåˆ«

`synchronized` å…³é”®å­—å’Œ `volatile` å…³é”®å­—æ˜¯ä¸¤ä¸ªäº’è¡¥çš„å­˜åœ¨ï¼Œè€Œä¸æ˜¯å¯¹ç«‹çš„å­˜åœ¨ï¼

- **`volatile` å…³é”®å­—**æ˜¯çº¿ç¨‹åŒæ­¥çš„**è½»é‡çº§å®ç°**ï¼Œæ‰€ä»¥ **`volatile `æ€§èƒ½è‚¯å®šæ¯” `synchronized`å…³é”®å­—è¦å¥½** ã€‚ä½†æ˜¯ **`volatile` å…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œ `synchronized`   \**åŒæ­¥çš„\**  å…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å—** ã€‚
- **`volatile` å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚`synchronized` å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚**
- **`volatile`å…³é”®å­—ä¸»è¦ç”¨äºè§£å†³å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œè€Œ `synchronized` å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ã€‚**

#### synchronized é”å‡çº§çš„è¿‡ç¨‹

åœ¨ Java1.6 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œsynchronized å±äºé‡é‡çº§é”ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œ**é”æ˜¯** cpu ä¸€ä¸ª**æ€»é‡çº§çš„èµ„æº**ï¼Œæ¯æ¬¡è·å–é”éƒ½è¦å’Œ cpu ç”³è¯·ï¼Œéå¸¸æ¶ˆè€—æ€§èƒ½ã€‚

åœ¨ **jdk1.6 ä¹‹å** Java å®˜æ–¹å¯¹ä» JVM å±‚é¢å¯¹ synchronized è¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„ synchronized é”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ï¼ŒJdk1.6 ä¹‹åï¼Œä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”æ‰€å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œå¼•å…¥äº†åå‘é”å’Œè½»é‡çº§é”ï¼Œå¢åŠ äº†é”å‡çº§çš„è¿‡ç¨‹ï¼Œç”±**æ— é”->åå‘é”->è‡ªæ—‹é”->é‡é‡çº§é”**

å¢åŠ é”å‡çº§çš„è¿‡ç¨‹ä¸»è¦æ˜¯**å‡å°‘ç”¨æˆ·æ€åˆ°æ ¸å¿ƒæ€çš„åˆ‡æ¢ï¼Œæé«˜é”çš„æ•ˆç‡ï¼Œä» jvm å±‚é¢ä¼˜åŒ–é”**ï¼ˆå›¾æºï¼šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼ˆç¬¬2ç‰ˆï¼‰ï¼‰

![image-20220711140002491](./images/image-20220711140002491.png)

![image-20220711135916289](./images/image-20220711135916289.png)

##### åå‘é”ç®€ä»‹

**åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¦‚æœä¸€ä¸ªåŒæ­¥å—ï¼ˆæˆ–æ–¹æ³•ï¼‰æ²¡æœ‰å¤šä¸ªçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡é‡å…¥è·å–é”**ï¼Œå¦‚æœæ¯æ¬¡è¿˜æœ‰é˜»å¡çº¿ç¨‹ï¼Œå”¤é†’CPUä»ç”¨æˆ·æ€è½¬ä¸ºæ ¸å¿ƒæ€ï¼Œé‚£ä¹ˆå¯¹äºCPUæ˜¯ä¸€ç§èµ„æºçš„æµªè´¹ï¼Œä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜ï¼Œå°±å¼•å…¥äº†åå‘é”çš„æ¦‚å¿µã€‚

**åå‘é”**  æ˜¯æŒ‡ä¸€æ®µåŒæ­¥ä»£ç ä¸€ç›´è¢«åŒä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šè‡ªåŠ¨è·å–é”ï¼Œé™ä½è·å–é”çš„ä»£ä»·ã€‚å¦‚æœå†…ç½®é”å¤„äºåå‘çŠ¶æ€ï¼Œå½“æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥ç«äº‰é”æ—¶ï¼Œå…ˆç”¨åå‘é”ï¼Œè¡¨ç¤ºå†…ç½®é”åçˆ±è¿™ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹è¦æ‰§è¡Œè¯¥é”å…³è”çš„åŒæ­¥ä»£ç æ—¶ï¼Œä¸éœ€è¦å†åšä»»ä½•æ£€æŸ¥å’Œåˆ‡æ¢ã€‚åå‘é”åœ¨ç«äº‰ä¸æ¿€çƒˆçš„æƒ…å†µä¸‹æ•ˆç‡éå¸¸é«˜ã€‚

åå‘é”çš„ç¼ºç‚¹ï¼šå¦‚æœé”å¯¹è±¡æ—¶å¸¸è¢«å¤šä¸ªçº¿ç¨‹ç«äº‰ï¼Œåå‘é”å°±æ˜¯å¤šä½™çš„ï¼Œå¹¶ä¸”å…¶æ’¤é”€çš„è¿‡ç¨‹ä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½å¼€é”€ã€‚

> æ ¸å¿ƒåŸç†æ˜¯ï¼šå¦‚æœä¸å­˜åœ¨çº¿ç¨‹ç«äº‰çš„ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†é”ï¼Œé‚£ä¹ˆé”å°±è¿›å…¥åå‘çŠ¶æ€ï¼Œæ­¤æ—¶Mark Wordçš„ç»“æ„å˜ä¸ºåå‘é”ç»“æ„ï¼Œé”å¯¹è±¡çš„é”æ ‡å¿—ä½ï¼ˆlockï¼‰è¢«æ”¹ä¸º01ï¼Œåå‘æ ‡å¿—ä½ï¼ˆbiased_lockï¼‰è¢«æ”¹ä¸º1ï¼Œç„¶åçº¿ç¨‹çš„IDè®°å½•åœ¨é”å¯¹è±¡çš„Mark Wordä¸­ï¼ˆä½¿ç”¨CASæ“ä½œå®Œæˆï¼‰ã€‚ä»¥åè¯¥çº¿ç¨‹è·å–é”æ—¶åˆ¤æ–­ä¸€ä¸‹çº¿ç¨‹IDå’Œæ ‡å¿—ä½ï¼Œå°±å¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ï¼Œè¿CASæ“ä½œéƒ½ä¸éœ€è¦ï¼Œè¿™æ ·å°±çœå»äº†å¤§é‡æœ‰å…³é”ç”³è¯·çš„æ“ä½œï¼Œä»è€Œä¹Ÿå°±æå‡äº†ç¨‹åºçš„æ€§èƒ½ã€‚
>
> ![image-20220710203331089](./images/image-20220710203331089.png)

##### è½»é‡çº§é”ç®€ä»‹

**è½»é‡é”å­˜åœ¨çš„ç›®çš„æ˜¯å°½å¯èƒ½ä¸åŠ¨ç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„äº’æ–¥é”ï¼Œå› ä¸ºå…¶æ€§èƒ½æ¯”è¾ƒå·®ã€‚çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’éœ€è¦CPUä»ç”¨æˆ·æ€è½¬ä¸ºæ ¸å¿ƒæ€ï¼Œé¢‘ç¹åœ°é˜»å¡å’Œå”¤é†’å¯¹CPUæ¥è¯´æ˜¯ä¸€ä»¶è´Ÿæ‹…å¾ˆé‡çš„å·¥ä½œ**ã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¾ˆå¤šå¯¹è±¡é”çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œä¾‹å¦‚æ•´æ•°çš„è‡ªåŠ æ“ä½œï¼Œåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…é˜»å¡å¹¶å”¤é†’çº¿ç¨‹æ˜¾ç„¶ä¸å€¼å¾—ï¼Œä¸ºæ­¤å¼•å…¥äº†è½»é‡çº§é”ã€‚*è½»é‡çº§é”æ˜¯ä¸€ç§è‡ªæ—‹é”*ï¼Œå› ä¸ºJVMæœ¬èº«å°±æ˜¯ä¸€ä¸ªåº”ç”¨ï¼Œæ‰€ä»¥å¸Œæœ›åœ¨åº”ç”¨å±‚é¢ä¸Šé€šè¿‡è‡ªæ—‹è§£å†³çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚

è½»é‡çº§é”çš„æ‰§è¡Œè¿‡ç¨‹ï¼šåœ¨æŠ¢é”çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºä¹‹å‰ï¼Œå¦‚æœå†…ç½®é”ï¼ˆä¸´ç•ŒåŒºçš„åŒæ­¥å¯¹è±¡ï¼‰æ²¡æœ‰è¢«é”å®šï¼ŒJVMé¦–å…ˆå°†åœ¨æŠ¢é”çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªé”è®°å½•ï¼ˆLock Recordï¼‰ï¼Œç”¨äºå­˜å‚¨å¯¹è±¡ç›®å‰Mark Wordçš„æ‹·è´ï¼Œè¿™æ—¶çš„çº¿ç¨‹å †æ ˆä¸å†…ç½®é”å¯¹è±¡å¤´å¤§è‡´å¦‚å›¾

![image-20220710203524080](./images/image-20220710203524080.png)

ç„¶åæŠ¢é”çº¿ç¨‹å°†ä½¿ç”¨CASè‡ªæ—‹æ“ä½œï¼Œå°è¯•å°†å†…ç½®é”å¯¹è±¡å¤´çš„Mark Wordçš„ptr_to_lock_recordï¼ˆé”è®°å½•æŒ‡é’ˆï¼‰æ›´æ–°ä¸ºæŠ¢é”çº¿ç¨‹æ ˆå¸§ä¸­é”è®°å½•çš„åœ°å€ï¼Œå¦‚æœè¿™ä¸ªæ›´æ–°æ‰§è¡ŒæˆåŠŸäº†ï¼Œè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¿™ä¸ªå¯¹è±¡é”ã€‚ç„¶åJVMå°†Mark Wordä¸­çš„lockæ ‡è®°ä½æ”¹ä¸º00ï¼ˆè½»é‡çº§é”æ ‡å¿—ï¼‰ï¼Œå³è¡¨ç¤ºè¯¥å¯¹è±¡å¤„äºè½»é‡çº§é”çŠ¶æ€ã€‚æŠ¢é”æˆåŠŸä¹‹åï¼ŒJVMä¼šå°†Mark Wordä¸­åŸæ¥çš„é”å¯¹è±¡ä¿¡æ¯ï¼ˆå¦‚å“ˆå¸Œç ç­‰ï¼‰ä¿å­˜åœ¨æŠ¢é”çº¿ç¨‹é”è®°å½•çš„Displaced Mark Wordï¼ˆå¯ä»¥ç†è§£ä¸ºæ”¾é”™åœ°æ–¹çš„Mark Wordï¼‰å­—æ®µä¸­ï¼Œå†å°†æŠ¢é”çº¿ç¨‹ä¸­é”è®°å½•çš„owneræŒ‡é’ˆæŒ‡å‘é”å¯¹è±¡ã€‚

åœ¨è½»é‡çº§é”æŠ¢å æˆåŠŸä¹‹åï¼Œé”è®°å½•å’Œå¯¹è±¡å¤´çš„çŠ¶æ€å¦‚å›¾

![image-20220710203611913](./images/image-20220710203611913.png)

é”è®°å½•æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä»½é”è®°å½•ï¼Œåœ¨åˆ›å»ºå®Œé”è®°å½•åï¼Œä¼šå°†å†…ç½®é”å¯¹è±¡çš„Mark Wordå¤åˆ¶åˆ°é”è®°å½•çš„Displaced Mark Wordå­—æ®µã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå†…ç½®é”å¯¹è±¡çš„Mark Wordçš„ç»“æ„ä¼šæœ‰æ‰€å˜åŒ–ï¼ŒMark Wordå°†ä¼šå‡ºç°ä¸€ä¸ªæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆï¼Œè€Œä¸å†å­˜ç€æ— é”çŠ¶æ€ä¸‹çš„é”å¯¹è±¡å“ˆå¸Œç ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥å¿…é¡»å°†è¿™äº›ä¿¡æ¯æš‚å­˜èµ·æ¥ï¼Œä¾›åé¢åœ¨é”é‡Šæ”¾æ—¶ä½¿ç”¨

##### é‡é‡çº§é”ç®€ä»‹

JVMä¸­æ¯ä¸ªå¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ªç›‘è§†å™¨ï¼Œç›‘è§†å™¨å’Œå¯¹è±¡ä¸€èµ·åˆ›å»ºã€é”€æ¯ã€‚ç›‘è§†å™¨ç›¸å½“äºä¸€ä¸ªç”¨æ¥ç›‘è§†è¿™äº›çº¿ç¨‹è¿›å…¥çš„ç‰¹æ®Šæˆ¿é—´ï¼Œå…¶ä¹‰åŠ¡æ˜¯ä¿è¯ï¼ˆåŒä¸€æ—¶é—´ï¼‰åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è¢«ä¿æŠ¤çš„ä¸´ç•ŒåŒºä»£ç å—ã€‚

æœ¬è´¨ä¸Šï¼Œç›‘è§†å™¨æ˜¯ä¸€ç§åŒæ­¥å·¥å…·ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯ï¼š

ï¼ˆ1ï¼‰åŒæ­¥ã€‚ç›‘è§†å™¨æ‰€ä¿æŠ¤çš„ä¸´ç•ŒåŒºä»£ç æ˜¯äº’æ–¥åœ°æ‰§è¡Œçš„ã€‚ä¸€ä¸ªç›‘è§†å™¨æ˜¯ä¸€ä¸ªè¿è¡Œè®¸å¯ï¼Œä»»ä¸€çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºä»£ç éƒ½éœ€è¦è·å¾—è¿™ä¸ªè®¸å¯ï¼Œç¦»å¼€æ—¶æŠŠè®¸å¯å½’è¿˜ã€‚

ï¼ˆ2ï¼‰åä½œã€‚ç›‘è§†å™¨æä¾›Signalæœºåˆ¶ï¼Œå…è®¸æ­£æŒæœ‰è®¸å¯çš„çº¿ç¨‹æš‚æ—¶æ”¾å¼ƒè®¸å¯è¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹å‘é€Signalå»å”¤é†’ï¼›å…¶ä»–æ‹¥æœ‰è®¸å¯çš„çº¿ç¨‹å¯ä»¥å‘é€Signalï¼Œå”¤é†’æ­£åœ¨é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œè®©å®ƒå¯ä»¥é‡æ–°è·å¾—è®¸å¯å¹¶å¯åŠ¨æ‰§è¡Œã€‚

#### è°ˆè°ˆ synchronized å’Œ ReentrantLock çš„åŒºåˆ«

##### ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”

**â€œå¯é‡å…¥é”â€**  æŒ‡çš„æ˜¯è‡ªå·±å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœæ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚åŒä¸€ä¸ªçº¿ç¨‹æ¯æ¬¡è·å–é”ï¼Œé”çš„è®¡æ•°å™¨éƒ½è‡ªå¢ 1ï¼Œæ‰€ä»¥è¦ç­‰åˆ°é”çš„è®¡æ•°å™¨ä¸‹é™ä¸º 0 æ—¶æ‰èƒ½é‡Šæ”¾é”ã€‚

##### synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API

`synchronized` æ˜¯**ä¾èµ–äº JVM å®ç°**çš„ï¼Œå‰é¢æˆ‘ä»¬ä¹Ÿè®²åˆ°äº† è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨ JDK1.6 ä¸º `synchronized` å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™æˆ‘ä»¬ã€‚`ReentrantLock` æ˜¯ **JDK å±‚é¢å®ç°**çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹å®ƒçš„æºä»£ç ï¼Œæ¥çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚

##### ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½

ç›¸æ¯” `synchronized`ï¼Œ`ReentrantLock`å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š

- **ç­‰å¾…å¯ä¸­æ–­** : `ReentrantLock`æä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡ `lock.lockInterruptibly()` æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´*æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…*ã€‚
- **å¯å®ç°å…¬å¹³é”** : `ReentrantLock`å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œ `synchronized`åªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚`ReentrantLock`é»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ `ReentrantLock`ç±»çš„ `ReentrantLock(boolean fair)`æ„é€ æ–¹æ³•æ¥åˆ¶å®šæ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚
- **å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰**: `synchronized`å…³é”®å­—ä¸ `wait()`å’Œ `notify()`/`notifyAll()`æ–¹æ³•ç›¸ç»“åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚`ReentrantLock`ç±»å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯éœ€è¦å€ŸåŠ©äº `Condition`æ¥å£ä¸ `newCondition()`æ–¹æ³•ã€‚

> `Condition`æ˜¯ JDK1.5 ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ª `Lock`å¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ª `Condition`å®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œ**çº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„ `Condition`ä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨ `notify()/notifyAll()`æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨ `ReentrantLock`ç±»ç»“åˆ `Condition`å®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€** ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯ Condition æ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œ `synchronized`å…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ª Lock å¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ª `Condition`å®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡Œ `notifyAll()`æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹è¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ï¼Œè€Œ `Condition`å®ä¾‹çš„ `signalAll()`æ–¹æ³• åªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥ `Condition`å®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚

**å¦‚æœä½ æƒ³ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œé‚£ä¹ˆé€‰æ‹© ReentrantLock æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æ€§èƒ½å·²ä¸æ˜¯é€‰æ‹©æ ‡å‡†**

### â­ThreadLocal åŸç†

**å¦‚æœæƒ³å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸“å±æœ¬åœ°å˜é‡è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ** JDK ä¸­æä¾›çš„ `ThreadLocal`ç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚ **`ThreadLocal`ç±»ä¸»è¦è§£å†³çš„å°±æ˜¯è®©æ¯ä¸ªçº¿ç¨‹ç»‘å®šè‡ªå·±çš„å€¼ï¼Œå¯ä»¥å°† `ThreadLocal`ç±»å½¢è±¡çš„æ¯”å–»æˆå­˜æ”¾æ•°æ®çš„ç›’å­ï¼Œç›’å­ä¸­å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚**

ä¸‹é¢æ˜¯ThreadLocalçš„æºç ï¼š

```java
public class Thread implements Runnable {
    //......
    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„ThreadLocalå€¼ã€‚ç”±ThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap threadLocals = null;

    //ä¸æ­¤çº¿ç¨‹æœ‰å…³çš„InheritableThreadLocalå€¼ã€‚ç”±InheritableThreadLocalç±»ç»´æŠ¤
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    //......
}

```

å¯ä»¥çœ‹å‡º **æœ€ç»ˆçš„å˜é‡æ˜¯æ”¾åœ¨äº†å½“å‰çº¿ç¨‹çš„ `ThreadLocalMap` ä¸­ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ `ThreadLocal` ä¸Šï¼Œ`ThreadLocal` å¯ä»¥ç†è§£ä¸ºåªæ˜¯ `ThreadLocalMap`çš„å°è£…ï¼Œä¼ é€’äº†å˜é‡å€¼ã€‚** `ThrealLocal` ç±»ä¸­å¯ä»¥é€šè¿‡ `Thread.currentThread()`è·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡åï¼Œç›´æ¥é€šè¿‡ `getMap(Thread t)`å¯ä»¥è®¿é—®åˆ°è¯¥çº¿ç¨‹çš„ `ThreadLocalMap`å¯¹è±¡ã€‚

**æ¯ä¸ª `Thread`ä¸­éƒ½å…·å¤‡ä¸€ä¸ª `ThreadLocalMap`ï¼Œè€Œ `ThreadLocalMap`å¯ä»¥å­˜å‚¨ä»¥ `ThreadLocal`ä¸º key ï¼ŒObject å¯¹è±¡ä¸º value çš„é”®å€¼å¯¹ã€‚**

![image-20220608223419067](./images/image-20220608223419067.png)

> æ³¨ï¼š`ThreadLocalMap`æ˜¯ `ThreadLocal`çš„é™æ€å†…éƒ¨ç±»ã€‚

ã€æ‰©å±•ã€‘ ThreadLocalçš„å†…å­˜æ³„éœ²ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

å…·ä½“è¯¦ç»†çœ‹Guideï¼š[ThreadLocalçš„å†…å­˜æ³„éœ²](https://javaguide.cn/java/concurrent/java-concurrent-questions-02.html#threadlocal-%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98)

`ThreadLocalMap` ä¸­ä½¿ç”¨çš„ key ä¸º `ThreadLocal` çš„å¼±å¼•ç”¨,è€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ `ThreadLocal` æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œkey ä¼šè¢«æ¸…ç†æ‰ï¼Œè€Œ value ä¸ä¼šè¢«æ¸…ç†æ‰ã€‚

### å®ç° Runnable æ¥å£å’Œ Callable æ¥å£çš„åŒºåˆ«

ç»§æ‰¿Threadç±»æˆ–è€…å®ç°Runnableæ¥å£è¿™ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹ç±»ï¼Œä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼æœ‰ä¸€ä¸ªå…±åŒçš„ç¼ºé™·ï¼šä¸èƒ½è·å–å¼‚æ­¥æ‰§è¡Œçš„ç»“æœã€‚Callableæ¥å£ç±»ä¼¼äºRunnableã€‚ä¸åŒçš„æ˜¯ï¼ŒRunnableçš„å”¯ä¸€æŠ½è±¡æ–¹æ³•run()æ²¡æœ‰è¿”å›å€¼ï¼Œä¹Ÿæ²¡æœ‰å—æ£€å¼‚å¸¸çš„å¼‚å¸¸å£°æ˜ã€‚æ¯”è¾ƒè€Œè¨€ï¼ŒCallableæ¥å£çš„call()æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”å£°æ˜äº†å—æ£€å¼‚å¸¸ï¼Œå…¶åŠŸèƒ½æ›´å¼ºå¤§ä¸€äº›ã€‚

`Runnable`è‡ª Java 1.0 ä»¥æ¥ä¸€ç›´å­˜åœ¨ï¼Œä½† `Callable`ä»…åœ¨ Java 1.5 ä¸­å¼•å…¥,ç›®çš„å°±æ˜¯ä¸ºäº†æ¥å¤„ç† `Runnable`ä¸æ”¯æŒçš„ç”¨ä¾‹ã€‚**`Runnable` æ¥å£** ä¸ä¼šè¿”å›ç»“æœæˆ–æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸ï¼Œä½†æ˜¯ **`Callable` æ¥å£** å¯ä»¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœä»»åŠ¡ä¸éœ€è¦è¿”å›ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸æ¨èä½¿ç”¨ **`Runnable` æ¥å£** ï¼Œè¿™æ ·ä»£ç çœ‹èµ·æ¥ä¼šæ›´åŠ ç®€æ´ã€‚

### æ‰§è¡Œ execute()æ–¹æ³•å’Œ submit()æ–¹æ³•çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

1. **`execute()`æ–¹æ³•ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸä¸å¦ï¼›**
2. **`submit()`æ–¹æ³•ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ª `Future` ç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª `Future` å¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸ**ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ `Future` çš„ `get()`æ–¹æ³•æ¥è·å–è¿”å›å€¼ï¼Œ`get()`æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼Œè€Œä½¿ç”¨ `get(long timeoutï¼ŒTimeUnit unit)`æ–¹æ³•åˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ä¸€æ®µæ—¶é—´åç«‹å³è¿”å›ï¼Œè¿™æ—¶å€™æœ‰å¯èƒ½ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œã€‚

Execute()æºç 

```java
public void execute(Runnable command) {
  ...
}
```

submitå¤§è‡´æºç 

```java
public Future<?> submit(Runnable task) {
    if (task == null) throw new NullPointerException();
    RunnableFuture<Void> ftask = newTaskFor(task, null);
    execute(ftask);
    return ftask;
}

protected <T> RunnableFuture<T> newTaskFor(Runnable runnable, T value) {
    return new FutureTask<T>(runnable, value);
}

```

`newTaskFor` æ–¹æ³•è¿”å›äº†ä¸€ä¸ª `FutureTask` å¯¹è±¡ã€‚

### â­å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± 

ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

> Executors è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š
>
> - **FixedThreadPool å’Œ SingleThreadExecutor** ï¼š å…è®¸è¯·æ±‚çš„é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUE ï¼Œå¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
> - **CachedThreadPool å’Œ ScheduledThreadPool** ï¼š å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUE ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

![image-20220609154049166](./images/image-20220609154049166.png)

æºç ï¼š

```java
/**
 * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
 */
public ThreadPoolExecutor(int corePoolSize, //çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                      int maximumPoolSize, //çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                      long keepAliveTime, //å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                      TimeUnit unit, //æ—¶é—´å•ä½
                      BlockingQueue<Runnable> workQueue, //ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                      ThreadFactory threadFactory, //çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                      RejectedExecutionHandler handler //æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                         ) {
    if (corePoolSize < 0 ||
        maximumPoolSize <= 0 ||
        maximumPoolSize < corePoolSize ||
        keepAliveTime < 0)
            throw new IllegalArgumentException();
    if (workQueue == null || threadFactory == null || handler == null)
        throw new NullPointerException();
    this.corePoolSize = corePoolSize;
    this.maximumPoolSize = maximumPoolSize;
    this.workQueue = workQueue;
    this.keepAliveTime = unit.toNanos(keepAliveTime);
    this.threadFactory = threadFactory;
    this.handler = handler;
}

```

---

<details>
    <summary>ThreadPoolExecutor 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š</summary>
<p>
    corePoolSize : æ ¸å¿ƒçº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
    </p>
<p>
    maximumPoolSize : å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
    </p>
<p>
    workQueue: å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚
    </p>
</details>
<details>
    <summary>`ThreadPoolExecutor`å…¶ä»–å¸¸è§å‚æ•°</summary>
    <p>
    keepAliveTime: å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯ï¼›
    </p>
    <p>
    unit: å‚æ•°çš„æ—¶é—´å•ä½
    </p>
    <p>
    threadFactory: executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°
    </p>
    <p>
    handler: æ‹’ç»ç­–ç•¥
    <p>
    1. `ThreadPoolExecutor.AbortPolicy`: æŠ›å‡º RejectedExecutionExceptionæ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚
    </p>
    <p>
    2. `ThreadPoolExecutor.CallerRunsPolicy`: æäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±å»æ‰§è¡Œè¯¥ä»»åŠ¡
    </p>
    <p>
    3. `ThreadPoolExecutor.DiscardPolicy`:  ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
    </p>
    <p>
    4. `ThreadPoolExecutor.DiscardOldestPolicy`:  æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚
    </p>
    </p>
</details>

### JUC åŒ…ä¸­çš„åŸå­ç±»æ˜¯å“ª 4 ç±»?

**åŸºæœ¬ç±»å‹**

ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°åŸºæœ¬ç±»å‹

- `AtomicInteger`ï¼šæ•´å‹åŸå­ç±»
- `AtomicLong`ï¼šé•¿æ•´å‹åŸå­ç±»
- `AtomicBoolean`ï¼šå¸ƒå°”å‹åŸå­ç±»

**æ•°ç»„ç±»å‹**

ä½¿ç”¨åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æŸä¸ªå…ƒç´ 

- `AtomicIntegerArray`ï¼šæ•´å‹æ•°ç»„åŸå­ç±»
- `AtomicLongArray`ï¼šé•¿æ•´å‹æ•°ç»„åŸå­ç±»
- `AtomicReferenceArray`ï¼šå¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»

**å¼•ç”¨ç±»å‹**

- `AtomicReference`ï¼šå¼•ç”¨ç±»å‹åŸå­ç±»
- `AtomicStampedReference`ï¼šåŸå­æ›´æ–°å¸¦æœ‰**ç‰ˆæœ¬å·**çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºè§£å†³åŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚
- `AtomicMarkableReference` ï¼šåŸå­æ›´æ–°å¸¦æœ‰**æ ‡è®°ä½**çš„å¼•ç”¨ç±»å‹

**å¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹**

- `AtomicIntegerFieldUpdater`ï¼šåŸå­æ›´æ–°æ•´å‹å­—æ®µçš„æ›´æ–°å™¨
- `AtomicLongFieldUpdater`ï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨
- `AtomicReferenceFieldUpdater`ï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹å­—æ®µçš„æ›´æ–°å™¨

### èƒ½ä¸èƒ½ç»™æˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹ AtomicInteger ç±»

å¸¸ç”¨ç±»

```java
public final int get() //è·å–å½“å‰çš„å€¼
public final int getAndSet(int newValue)//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼
public final int getAndIncrement()//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢
public final int getAndDecrement() //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡
public final int getAndAdd(int delta) //è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼
boolean compareAndSet(int expect, int update) //å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰
public final void lazySet(int newValue)//æœ€ç»ˆè®¾ç½®ä¸ºnewValue,ä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚
```

AtomicInteger ç±»ä¸»è¦åˆ©ç”¨ CAS (compare and swap) + volatile å’Œ native æ–¹æ³•æ¥ä¿è¯åŸå­æ“ä½œï¼Œä»è€Œé¿å… synchronized çš„é«˜å¼€é”€ï¼Œæ‰§è¡Œæ•ˆç‡å¤§ä¸ºæå‡ã€‚

AtomicInteger ç±»çš„éƒ¨åˆ†æºç ï¼š

```java
// setup to use Unsafe.compareAndSwapInt for updatesï¼ˆæ›´æ–°æ“ä½œæ—¶æä¾›â€œæ¯”è¾ƒå¹¶æ›¿æ¢â€çš„ä½œç”¨ï¼‰
private static final Unsafe unsafe = Unsafe.getUnsafe();
private static final long valueOffset;

static {
    try {
        valueOffset = unsafe.objectFieldOffset
            (AtomicInteger.class.getDeclaredField("value"));
    } catch (Exception ex) { throw new Error(ex); }
}

private volatile int value;
```

CAS çš„åŸç†æ˜¯æ‹¿æœŸæœ›çš„å€¼å’ŒåŸæœ¬çš„ä¸€ä¸ªå€¼ä½œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒåˆ™æ›´æ–°æˆæ–°çš„å€¼ã€‚UnSafe ç±»çš„ objectFieldOffset()  æ–¹æ³•æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ‹¿åˆ°â€œåŸæ¥çš„å€¼â€çš„å†…å­˜åœ°å€ï¼Œè¿”å›å€¼æ˜¯ valueOffsetã€‚å¦å¤– value æ˜¯ä¸€ä¸ª volatile  å˜é‡ï¼Œåœ¨å†…å­˜ä¸­å¯è§ï¼Œå› æ­¤ JVM å¯ä»¥ä¿è¯ä»»ä½•æ—¶åˆ»ä»»ä½•çº¿ç¨‹æ€»èƒ½æ‹¿åˆ°è¯¥å˜é‡çš„æœ€æ–°å€¼ã€‚

### ğŸ”¥ è¯·ä½ è¯´ä¸€ä¸‹è‡ªå·±å¯¹äº AQS åŸç†çš„ç†è§£

#### å‰æï¼šLockSupport

> Basic thread blocking primitives (åŸå§‹) for creating locks and other synchronization (åŒæ­¥) classes.
>
> This class associates, with each thread that uses it, a permit (in the sense of the Semaphore class). A call to park will return immediately if the permit is available, consuming it in the process; otherwise it may block. A call to unpark makes the permit available, if it was not already available. (Unlike with Semaphores (æ——è¯­) though, permits do not accumulate (ç§¯ç´¯) . There is at most one.)

ç®€è€Œè¨€ä¹‹å°±æ˜¯wait/notifyçš„åŠ å¼ºç‰ˆï¼Œå¸¸ç”¨çš„ä¸¤ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š

* park()
* unpark()

å…¶ä»–è®©çº¿ç¨‹é˜»å¡å”¤é†’çš„æ–¹æ³•ï¼š

![image-20220718201745624](./images/image-20220718201745624.png)

> éœ€è¦æ³¨æ„çš„æ˜¯
>
> 1. waitå’Œnotifyå¿…é¡»è¦åœ¨synchronizedä»£ç å—ä¸­å¦åˆ™ä¼šæŠ¥é”™
> 2. awaitå’Œsignalå¿…é¡»æ˜¯åœ¨lockï¼ˆä¾‹å¦‚ReentrantLocké‡Œé¢ï¼‰æ‰è¡Œï¼Œå¦åˆ™æŠ¥é”™

LockSupportç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå½“è°ƒç”¨LockSupport.parkæ—¶ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹å°†ä¼šç­‰å¾…ï¼Œç›´è‡³è·å¾—è®¸å¯ï¼Œå½“è°ƒç”¨LockSupport.unparkæ—¶ï¼Œå¿…é¡»æŠŠç­‰å¾…è·å¾—è®¸å¯çš„çº¿ç¨‹ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ï¼Œå¥½è®©æ­¤çº¿ç¨‹ç»§ç»­è¿è¡Œã€‚

```java
public static void park() {
    UNSAFE.park(false, 0L);
}
public static void park(Object blocker) {
    Thread t = Thread.currentThread();
    setBlocker(t, blocker);
    UNSAFE.park(false, 0L);
    setBlocker(t, null);
}

...
public static void unpark(Thread thread) {
    if (thread != null)
        UNSAFE.unpark(thread);
}
```

permité»˜è®¤æ˜¯0ï¼Œæ‰€ä»¥ä¸€å¼€å§‹è°ƒç”¨park()æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œç›´åˆ°åˆ«çš„çº¿ç¨‹å°†å½“å‰çº¿ç¨‹çš„permitè®¾ç½®ä¸º1æ—¶ï¼Œparkæ–¹æ³•ä¼šè¢«å”¤é†’ï¼Œç„¶åä¼šå°†permitå†æ¬¡è®¾ç½®ä¸º0å¹¶è¿”å›ã€‚

unpark(Thread thread) - å”¤é†’å¤„äºé˜»å¡çŠ¶æ€çš„æŒ‡å®šçº¿ç¨‹

è°ƒç”¨unpark(thread)æ–¹æ³•åï¼Œå°±ä¼šå°†threadçº¿ç¨‹çš„è®¸å¯permitè®¾ç½®æˆ1ï¼ˆæ³¨æ„å¤šæ¬¡è°ƒç”¨unparkæ–¹æ³•ï¼Œä¸ä¼šç´¯åŠ ï¼Œpemitå€¼è¿˜æ˜¯1ï¼‰ä¼šè‡ªåŠ¨å”¤é†’theadçº¿ç¨‹ï¼Œå³ä¹‹å‰é˜»å¡ä¸­çš„LockSupport.park()æ–¹æ³•ä¼šç«‹å³è¿”å›ã€‚

#### è®¾è®¡æ¨¡å¼ä¹‹æ¨¡æ¿æ–¹æ³•

> è¯¥å°èŠ‚å‚è€ƒäº†ã€Šç§’æ‡‚è®¾è®¡æ¨¡å¼ã€‹ã€ã€Šè®¾è®¡æ¨¡å¼ä¹‹ç¦…ã€‹ã€ã€Šå›¾è§£è®¾è®¡æ¨¡å¼ã€‹

Define the skeleton of an algorithm in an operation,deferring some steps to subclasses.Template Method lets subclasses redefine certain steps of an algorithm without changing the algorithm's structure.ï¼ˆå®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„æ¡†æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚ï¼‰

![image-20220627130052162](./images/image-20220627130052162.png)

æ¨¡æ¿æ¨¡å¼çš„å…³é”®åœ¨äºï¼šçˆ¶ç±»æä¾›æ¡†æ¶æ€§çš„å…¬å…±é€»è¾‘ï¼Œå­ç±»æä¾›ä¸ªæ€§åŒ–çš„å®šåˆ¶é€»è¾‘ã€‚

æ¨¡æ¿æ–¹æ³•æ¨¡å¼ç¡®å®éå¸¸ç®€å•ï¼Œä»…ä»…ä½¿ç”¨äº†Javaçš„ç»§æ‰¿æœºåˆ¶ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªåº”ç”¨éå¸¸å¹¿æ³›çš„æ¨¡å¼ã€‚å…¶ä¸­ï¼ŒAbstractClasså«åšæŠ½è±¡æ¨¡æ¿ï¼Œå®ƒçš„æ–¹æ³•åˆ†ä¸ºä¸¤ç±»ï¼š

* åŸºæœ¬æ–¹æ³•

  * åŸºæœ¬æ–¹æ³•ä¹Ÿå«åšåŸºæœ¬æ“ä½œï¼Œæ˜¯ç”±å­ç±»å®ç°çš„æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨æ¨¡æ¿æ–¹æ³•è¢«è°ƒç”¨ã€‚
* æ¨¡æ¿æ–¹æ³•

  * å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å‡ ä¸ªï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå…·ä½“æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå®ç°å¯¹åŸºæœ¬æ–¹æ³•çš„è°ƒåº¦ï¼Œå®Œæˆå›ºå®šçš„é€»è¾‘ã€‚

> æ³¨æ„ã€€ä¸ºäº†é˜²æ­¢æ¶æ„çš„æ“ä½œï¼Œä¸€èˆ¬æ¨¡æ¿æ–¹æ³•éƒ½åŠ ä¸Šfinalå…³é”®å­—ï¼Œä¸å…è®¸è¢«è¦†å†™

> ä»£ç ç¤ºä¾‹

æ—¢ç„¶é²¸ã€äººç±»ã€è™è éƒ½æ˜¯åŠ¨ç‰©ï¼Œé‚£ä¹ˆä¸€å®šå¾—å…·å¤‡åŠ¨ç‰©æœ€åŸºæœ¬çš„ç”Ÿå­˜æŠ€èƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬å»ºæ¨¡æ—¶è¦ä½“ç°å…¶â€œåŠ¨â€ä¸â€œåƒâ€è¿™ä¸¤ç§æœ¬èƒ½è¡Œä¸ºï¼Œç¼ºä¸€ä¸å¯

å®šä¹‰ä¸€ä¸ªè¡Œä¸ºï¼ˆæ¨¡æ¿ï¼‰

```java
public abstract class Mammal {
	public abstract void move( );
	public abstract void eat( );
	public final void live() {
		move();
		eat();
	}
}
```

é²¸é±¼ç±»

```java
class Whale extends Mammal {
    @Override
    public void move() {
        System.out.print("é²¸åœ¨æ°´é‡Œæ¸¸ç€...");
    }
    @Override
    public void eat() {
        System . out. println("æ•é±¼åƒã€‚");
    }
}
```

äººç±»

```java
class Human extends Mammal {
    @Override
    public void move() {
        System.out.print("äººç±»åœ¨è·¯ä¸Šå¼€ç€è½¦...");
    }
    @Override
    public void eat() {
        System. out. println("å»å…¬å¸æŒ£é’±åƒé¥­ã€‚");
    }
}
```

å“ºä¹³åŠ¨ç‰©ç»Ÿä¸€è°ƒç”¨äº†é€šç”¨çš„æ¨¡æ¿æ–¹æ³•live()ï¼Œä»¥æ­¤ä½œä¸ºç”Ÿå­˜æ³•åˆ™å°±èƒ½å¾ˆå¥½åœ°å­˜æ´»ä¸‹å»

AQSçš„æ¨¡æ¿æ–¹æ³•

åŠ é”ï¼š

![image-20220719142312335](./images/image-20220719142312335.png)

é‡Šæ”¾é”ï¼š

![image-20220719142348103](./images/image-20220719142348103.png)

#### AQSåŸºæœ¬åŸç†

AQSä¸ºæ¯ä¸ªå…±äº«èµ„æºéƒ½è®¾ç½®ä¸€ä¸ªå…±äº«èµ„æºé”ï¼Œçº¿ç¨‹åœ¨éœ€è¦è®¿é—®å…±äº«èµ„æºæ—¶é¦–å…ˆéœ€è¦è·å–å…±äº«èµ„æºé”ï¼Œå¦‚æœè·å–åˆ°äº†å…±äº«èµ„æºé”ï¼Œä¾¿å¯ä»¥åœ¨å½“å‰çº¿ç¨‹ä¸­ä½¿ç”¨è¯¥å…±äº«èµ„æºï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™å°†è¯¥çº¿ç¨‹æ”¾å…¥çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡èµ„æºè°ƒåº¦ï¼Œå…·ä½“çš„æµç¨‹å¦‚å›¾ã€‚è®¸å¤šåŒæ­¥ç±»çš„å®ç°éƒ½ä¾èµ–äºAQSï¼Œä¾‹å¦‚å¸¸ç”¨çš„ReentrantLockã€Semaphoreå’ŒCountDownLatchã€‚ï¼ˆå›¾ç‰‡æ¥æºäºã€Šofferæ¥äº†ã€‹ï¼‰

![image-20220626111741892](./images/image-20220626111741892.png)

**stateï¼šçŠ¶æ€** Abstract Queued Synchronizerç»´æŠ¤äº†ä¸€ä¸ªvolatile intç±»å‹çš„å˜é‡ï¼Œç”¨äºè¡¨ç¤ºå½“å‰çš„åŒæ­¥çŠ¶æ€ã€‚Volatileè™½ç„¶ä¸èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œä½†æ˜¯èƒ½ä¿è¯å½“å‰å˜é‡stateçš„å¯è§æ€§ã€‚stateçš„è®¿é—®æ–¹å¼æœ‰ä¸‰ç§ï¼šgetState()ã€setState()å’ŒcompareAndSetState()ï¼Œå‡æ˜¯åŸå­æ“ä½œï¼Œå…¶ä¸­ï¼ŒcompareAndSetStateçš„å®ç°ä¾èµ–äºUnsafeçš„compareAndSwapInt()ã€‚å…·ä½“çš„JDKä»£ç å®ç°å¦‚ä¸‹ï¼š

```java
// è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼ã€‚æ­¤æ“ä½œå…·æœ‰volatileè¯»å–åŸå­æ“ä½œã€‚
protected final long getState() {
    return state;
}
// è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼ã€‚æ­¤æ“ä½œå…·æœ‰volatileå†™å…¥åŸå­æ“ä½œã€‚
protected final void setState(long newState) {
    state = newState;
}
//è‡ªåŠ¨å°†åŒæ­¥çŠ¶æ€è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°çŠ¶æ€å€¼(å¦‚æœå½“å‰çŠ¶æ€å€¼ç­‰äºé¢„æœŸå€¼)
//æ­¤æ“ä½œçš„å†…å­˜è¯­ä¹‰ä¸ºvolatileä¿®é¥°çš„åŸå­è¯»å†™æ“ä½œ
protected final boolean compareAndSetState(long expect, long update) {
    // See below for intrinsics setup to support this
    return unsafe.compareAndSwapLong(this, stateOffset, expect, update);
}
```

#### AQSæ•°æ®ç»“æ„

##### CLH

AbstractQueuedSynchronizerç±»åº•å±‚çš„æ•°æ®ç»“æ„æ˜¯ä½¿ç”¨ `CLH(Craig,Landin,and Hagersten)é˜Ÿåˆ—`æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—(è™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»)ã€‚AQSæ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªCLHé”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹(Node)æ¥å®ç°é”çš„åˆ†é…ã€‚

![image-20220626113216377](./images/image-20220626113216377.png)

##### Node

Nodeå³ä¸ºä¸Šé¢CLHå˜ä½“é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ã€‚

![img](./images/960271cf2b5c8a185eed23e98b72c75538637.png)

è§£é‡Šä¸€ä¸‹å‡ ä¸ªæ–¹æ³•å’Œå±æ€§å€¼çš„å«ä¹‰ï¼š

| æ–¹æ³•å’Œå±æ€§å€¼ | å«ä¹‰                                                                                         |
| :----------- | :------------------------------------------------------------------------------------------- |
| waitStatus   | å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€                                                                       |
| thread       | è¡¨ç¤ºå¤„äºè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹                                                                         |
| prev         | å‰é©±æŒ‡é’ˆ                                                                                     |
| predecessor  | è¿”å›å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰çš„è¯æŠ›å‡ºnpe                                                                |
| nextWaiter   | æŒ‡å‘ä¸‹ä¸€ä¸ªå¤„äºCONDITIONçŠ¶æ€çš„èŠ‚ç‚¹ï¼ˆç”±äºæœ¬ç¯‡æ–‡ç« ä¸è®²è¿°Condition Queueé˜Ÿåˆ—ï¼Œè¿™ä¸ªæŒ‡é’ˆä¸å¤šä»‹ç»ï¼‰ |
| next         | åç»§æŒ‡é’ˆ                                                                                     |

çº¿ç¨‹ä¸¤ç§é”çš„æ¨¡å¼ï¼š

| æ¨¡å¼      | å«ä¹‰                           |
| :-------- | :----------------------------- |
| SHARED    | è¡¨ç¤ºçº¿ç¨‹ä»¥å…±äº«çš„æ¨¡å¼ç­‰å¾…é”     |
| EXCLUSIVE | è¡¨ç¤ºçº¿ç¨‹æ­£åœ¨ä»¥ç‹¬å çš„æ–¹å¼ç­‰å¾…é” |

waitStatusæœ‰ä¸‹é¢å‡ ä¸ªæšä¸¾å€¼ï¼š

| æšä¸¾      | å«ä¹‰                                           |
| :-------- | :--------------------------------------------- |
| 0         | å½“ä¸€ä¸ªNodeè¢«åˆå§‹åŒ–çš„æ—¶å€™çš„é»˜è®¤å€¼               |
| CANCELLED | ä¸º1ï¼Œè¡¨ç¤ºçº¿ç¨‹è·å–é”çš„è¯·æ±‚å·²ç»å–æ¶ˆäº†            |
| CONDITION | ä¸º-2ï¼Œè¡¨ç¤ºèŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…å”¤é†’   |
| PROPAGATE | ä¸º-3ï¼Œå½“å‰çº¿ç¨‹å¤„åœ¨SHAREDæƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µæ‰ä¼šä½¿ç”¨ |
| SIGNAL    | ä¸º-1ï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œå°±ç­‰èµ„æºé‡Šæ”¾äº†     |

#### AQSçš„èµ„æºçš„å…±äº«æ–¹å¼

AQSå®šä¹‰äº†ä¸¤ç§èµ„æºå…±äº«æ–¹å¼ï¼š

* Exclusiveï¼ˆç‹¬äº«é”ï¼‰ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å æœ‰é”èµ„æºï¼Œå¦‚ReentrantLockã€‚ç‹¬äº«é”åˆå¯åˆ†ä¸ºå…¬å¹³é”å’Œéå…¬å¹³é”ã€‚

![image-20220626113011580](./images/image-20220626113011580.png)

* Shareï¼ˆå…±äº«é”ï¼‰ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶å æœ‰é”èµ„æºï¼Œå¦‚Semaphoreã€CountDownLatchã€CyclicBarrierã€ReadWriteLockçš„Readé”ã€‚

![image-20220626113018340](./images/image-20220626113018340.png)

#### AQSåŠ é”è¿‡ç¨‹

ä»¥ReentrantLockä¸ºä¾‹

![image-20220719155205627](./images/image-20220719155205627.png)

##### !tryAcquire(arg)

![image-20220719154816995](./images/image-20220719154816995.png)

![image-20220719155237924](./images/image-20220719155237924.png)

##### addWaiter

![image-20220719154834850](./images/image-20220719154834850.png)

##### acquireQueued

![image-20220719154855457](./images/image-20220719154855457.png)

#### AQSæŠ¢é”åŸç†

##### æ¨¡æ¿æ–¹æ³•ï¼šacquire

acquireæ˜¯AQSå°è£…å¥½çš„è·å–èµ„æºçš„å…¬å…±å…¥å£ï¼Œå®ƒæ˜¯AQSæä¾›çš„åˆ©ç”¨ç‹¬å çš„æ–¹å¼è·å–èµ„æºçš„æ–¹æ³•ï¼Œæºç å®ç°å¦‚ä¸‹ï¼š

```java
public final void acquire(int arg) {
    if (!tryAcquire(arg) &&
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```

é€šè¿‡æºç å¯ä»¥å‘ç°ï¼Œacquire(arg)è‡³å°‘æ‰§è¡Œä¸€æ¬¡tryAcquire(arg)é’©å­æ–¹æ³•ã€‚tryAcquire(arg)æ–¹æ³•AQSé»˜è®¤æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå…·ä½“çš„è·å–ç‹¬å èµ„æºstateçš„é€»è¾‘éœ€è¦é’©å­æ–¹æ³•æ¥å®ç°ã€‚è‹¥è°ƒç”¨tryAcquire(arg)å°è¯•æˆåŠŸï¼Œåˆ™acquire()å°†ç›´æ¥è¿”å›ï¼Œè¡¨ç¤ºå·²ç»æŠ¢åˆ°é”ï¼›è‹¥ä¸æˆåŠŸï¼Œåˆ™å°†çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚

##### é’©å­æ–¹æ³•ï¼štryAcquire

tryAcquire(int) ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚

```java
protected boolean tryAcquire(int unused) {
            //CASæ“ä½œï¼Œæ›´æ–°æˆåŠŸï¼Œåˆ™è®¾ç½®çº¿ç¨‹ç‹¬å ï¼Œè¿”å›true
            if (compareAndSetState(0, 1)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }
```

##### ç›´æ¥å…¥é˜Ÿï¼šaddWaiter

åœ¨acquireæ¨¡æ¿æ–¹æ³•ä¸­ï¼Œå¦‚æœé’©å­æ–¹æ³•tryAcquireå°è¯•è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„è¯ï¼Œå°±æ„é€ åŒæ­¥èŠ‚ç‚¹ï¼ˆç‹¬å å¼èŠ‚ç‚¹æ¨¡å¼ä¸ºNode.EXCLUSIVEï¼‰ï¼Œé€šè¿‡addWaiter(Node node,int args)æ–¹æ³•å°†è¯¥èŠ‚ç‚¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„é˜Ÿå°¾ã€‚

```java
private Node addWaiter(Node mode) {
        Node node = new Node(Thread.currentThread(), mode);
        // Try the fast path of enq; backup to full enq on failure
        Node pred = tail;
        if (pred != null) {
            node.prev = pred;
            if (compareAndSetTail(pred, node)) {
                pred.next = node;
                return node;
            }
        }
        enq(node);
        return node;
    }
```

##### è‡ªæ—‹å…¥é˜Ÿï¼šenq

addWaiter()ç¬¬ä¸€æ¬¡å°è¯•åœ¨å°¾éƒ¨æ·»åŠ èŠ‚ç‚¹å¤±è´¥ï¼Œæ„å‘³ç€æœ‰å¹¶å‘æŠ¢é”å‘ç”Ÿï¼Œéœ€è¦è¿›è¡Œè‡ªæ—‹ã€‚enq()æ–¹æ³•é€šè¿‡CASè‡ªæ—‹å°†èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚

> èŠ‚ç‚¹åœ¨ç¬¬ä¸€æ¬¡å…¥é˜Ÿå¤±è´¥åï¼Œå°±ä¼šå¼€å§‹è‡ªæ—‹å…¥é˜Ÿï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š
>
> ï¼ˆ1ï¼‰å¦‚æœAQSçš„é˜Ÿåˆ—éç©ºï¼Œæ–°èŠ‚ç‚¹å…¥é˜Ÿçš„æ’å…¥ä½ç½®åœ¨é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶ä¸”é€šè¿‡CASæ–¹å¼æ’å…¥ï¼Œæ’å…¥ä¹‹åAQSçš„tailå°†æŒ‡å‘æ–°çš„å°¾èŠ‚ç‚¹ã€‚
>
> ï¼ˆ2ï¼‰å¦‚æœAQSçš„é˜Ÿåˆ—ä¸ºç©ºï¼Œæ–°èŠ‚ç‚¹å…¥é˜Ÿæ—¶ï¼ŒAQSé€šè¿‡CASæ–¹æ³•å°†æ–°èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹headï¼Œå¹¶ä¸”å°†tailæŒ‡é’ˆæŒ‡å‘æ–°èŠ‚ç‚¹ã€‚
>
> ```java
> private Node enq(final Node node) {
>              for (;;) { //è‡ªæ—‹å…¥é˜Ÿ
>                  Node t = tail;
>                  if (t == null) {
>                       //é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆå§‹åŒ–å°¾èŠ‚ç‚¹å’Œå¤´èŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹
>                      if (compareAndSetHead(new Node()))
>                          tail = head;
>                  } else {
>                      //å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°†æ–°èŠ‚ç‚¹æ’å…¥é˜Ÿåˆ—å°¾éƒ¨
>                      node.prev = t; 
>                      if (compareAndSetTail(t, node)) {
>                          t.next = node;
>                          return t;
>                      }
>                  }
>              }
>          }
> ```

> èŠ‚ç‚¹å‡ºé˜Ÿçš„ç®—æ³•åœ¨acquireQueued()æ–¹æ³•ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¨¡æ¿æ–¹æ³•ã€‚acquireQueued()æ–¹æ³•ä¸æ–­åœ¨å‰é©±èŠ‚ç‚¹ä¸Šè‡ªæ—‹ï¼ˆforæ­»å¾ªç¯ï¼‰ï¼Œå¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹å¹¶ä¸”å½“å‰çº¿ç¨‹ä½¿ç”¨é’©å­æ–¹æ³•tryAcquire(arg)è·å¾—äº†é”ï¼Œå°±ç§»é™¤å¤´èŠ‚ç‚¹ï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ã€‚
>
> ```java
> final boolean acquireQueued(final Node node, int arg) {
>              boolean failed = true;
>              try {
>                  boolean interrupted = false;
>                  // åœ¨å‰é©±èŠ‚ç‚¹ä¸Šè‡ªæ—‹
>                  for (;;) {
>                      // è·å–èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹
>                      final Node p = node.predecessor();
>                      // ï¼ˆ1ï¼‰å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹
>                      // ï¼ˆ2ï¼‰é€šè¿‡å­ç±»çš„tryAcquire()é’©å­å®ç°æŠ¢å æˆåŠŸ
>                      if (p == head && tryAcquire(arg)) {
>                          // å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼Œä¹‹å‰çš„å¤´èŠ‚ç‚¹å‡ºé˜Ÿ
>                          setHead(node);
>                          p.next = null; // help GC
>                          failed = false;
>                          return interrupted;
>                      }
>                     // çœç•¥parkï¼ˆæ— é™æœŸé˜»å¡ï¼‰çº¿ç¨‹çš„ä»£ç 
>                }
>              } finally {
>                 // çœç•¥å…¶ä»– 
>              }
>       }
> ```

##### è‡ªæ—‹æŠ¢å ï¼šacquireQueued()

åœ¨èŠ‚ç‚¹å…¥é˜Ÿä¹‹åï¼Œå¯åŠ¨è‡ªæ—‹æŠ¢é”çš„æµç¨‹ã€‚acquireQueued()æ–¹æ³•çš„ä¸»è¦é€»è¾‘ï¼šå½“å‰NodeèŠ‚ç‚¹çº¿ç¨‹åœ¨æ­»å¾ªç¯ä¸­ä¸æ–­è·å–åŒæ­¥çŠ¶æ€ï¼Œå¹¶ä¸”ä¸æ–­åœ¨å‰é©±èŠ‚ç‚¹ä¸Šè‡ªæ—‹ï¼Œåªæœ‰å½“å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹æ—¶æ‰èƒ½å°è¯•è·å–é”ï¼ŒåŸå› æ˜¯ï¼š

1. å¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼ˆé”ï¼‰çš„èŠ‚ç‚¹ï¼Œè€Œå¤´èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä»¥åï¼Œå°†ä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼Œåç»§èŠ‚ç‚¹çš„çº¿ç¨‹è¢«å”¤é†’åè¦æ£€æŸ¥è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹ã€‚
2. ç»´æŠ¤åŒæ­¥é˜Ÿåˆ—çš„FIFOåŸåˆ™ï¼ŒèŠ‚ç‚¹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¹‹åï¼Œå°±è¿›å…¥äº†è‡ªæ—‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½åœ¨ä¸æ–­åœ°æ‰§è¡Œforæ­»å¾ªç¯ã€‚

```java
final boolean acquireQueued(final Node node, int arg) {
        boolean failed = true;
        try {
            boolean interrupted = false;
            for (;;) {
                final Node p = node.predecessor();
                if (p == head && tryAcquire(arg)) {
                    setHead(node);
                    p.next = null; // help GC
                    failed = false;
                    return interrupted;
                }
                //èŠ‚ç‚¹pä¸æ˜¯headèŠ‚ç‚¹ï¼Œæˆ–è€…æŠ¢é”å¤±è´¥ï¼Œæ‰§è¡Œè¿™é‡Œï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹
                if (shouldParkAfterFailedAcquire(p, node) && parkAndCheckInterrupt())
                    interrupted = true;
            }
        } finally {
            //å¦‚æœæŒ‚èµ·ç°åœºå¼‚å¸¸ï¼Œåˆ™æ‰§è¡Œå–æ¶ˆæŠ¢é”æ“ä½œ
            if (failed)
                cancelAcquire(node);
        }
    }
```

##### æŒ‚èµ·é¢„åˆ¤ï¼šshouldParkAfterFailedAcquire()

acquireQueued()è‡ªæ—‹åœ¨é˜»å¡è‡ªå·±çš„çº¿ç¨‹ä¹‹å‰ä¼šè¿›è¡ŒæŒ‚èµ·é¢„åˆ¤ã€‚shouldParkAfterFailedAcquire()æ–¹æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼šå°†å½“å‰èŠ‚ç‚¹çš„æœ‰æ•ˆå‰é©±èŠ‚ç‚¹ï¼ˆæ˜¯æŒ‡æœ‰æ•ˆèŠ‚ç‚¹ä¸æ˜¯CANCELLEDç±»å‹çš„èŠ‚ç‚¹ï¼‰æ‰¾åˆ°ï¼Œå¹¶ä¸”å°†æœ‰æ•ˆå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸ºSIGNALï¼Œä¹‹åè¿”å›trueä»£è¡¨å½“å‰çº¿ç¨‹å¯ä»¥é©¬ä¸Šè¢«é˜»å¡äº†ã€‚

å…·ä½“å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š

1. å¦‚æœå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º?1ï¼ˆSIGNALï¼‰ï¼Œè¯´æ˜å‰é©±çš„ç­‰å¾…æ ‡å¿—å·²è®¾å¥½ï¼Œè¿”å›trueè¡¨ç¤ºè®¾ç½®å®Œæ¯•ã€‚
2. å¦‚æœå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º1ï¼ˆCANCELLEDï¼‰ï¼Œè¯´æ˜å‰é©±èŠ‚ç‚¹æœ¬èº«ä¸å†ç­‰å¾…äº†ï¼Œéœ€è¦è·¨è¶Šè¿™äº›èŠ‚ç‚¹ï¼Œç„¶åæ‰¾åˆ°ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ï¼Œå†æŠŠå½“å‰èŠ‚ç‚¹å’Œè¿™ä¸ªæœ‰æ•ˆèŠ‚ç‚¹çš„å”¤é†’å…³ç³»å»ºç«‹å¥½ï¼šè°ƒæ•´å‰é©±èŠ‚ç‚¹çš„nextæŒ‡é’ˆä¸ºè‡ªå·±ã€‚
3. å¦‚æœæ˜¯å…¶ä»–æƒ…å†µï¼š?3ï¼ˆPROPAGATEï¼Œå…±äº«é”ç­‰å¾…ï¼‰ã€?2ï¼ˆCONDITIONï¼Œæ¡ä»¶ç­‰å¾…ï¼‰ã€0ï¼ˆåˆå§‹çŠ¶æ€ï¼‰ï¼Œé‚£ä¹ˆé€šè¿‡CASå°è¯•è®¾ç½®å‰é©±èŠ‚ç‚¹ä¸ºSIGNALï¼Œè¡¨ç¤ºåªè¦å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”ï¼Œå½“å‰èŠ‚ç‚¹å°±å¯ä»¥æŠ¢å é”äº†ã€‚

```java
private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
        int ws = pred.waitStatus;
        if (ws == Node.SIGNAL)
            /*
             * This node has already set status asking a release
             * to signal it, so it can safely park.
             */
            return true;
        if (ws > 0) {
            /*
             * Predecessor was cancelled. Skip over predecessors and
             * indicate retry.
             */
            do {
                node.prev = pred = pred.prev;
            } while (pred.waitStatus > 0);
            pred.next = node;
        } else {
            /*
             * waitStatus must be 0 or PROPAGATE.  Indicate that we
             * need a signal, but don't park yet.  Caller will need to
             * retry to make sure it cannot acquire before parking.
             */
            compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
        }
        return false;
    }
```

##### çº¿ç¨‹æŒ‚èµ·ï¼šparkAndCheckInterrupt()

parkAndCheckInterrupt()çš„ä¸»è¦ä»»åŠ¡æ˜¯æš‚åœå½“å‰çº¿ç¨‹

```java
private final boolean parkAndCheckInterrupt() {
        LockSupport.park(this);
        return Thread.interrupted();
    }
```

#### AQSé‡Šæ”¾é”åŸç†

##### AQSæ¨¡æ¿æ–¹æ³•ï¼šrelease()

SimpleMockLockçš„unlock()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šè°ƒç”¨AQSçš„release(â€¦)çš„æ¨¡æ¿æ–¹æ³•ã€‚AQSçš„release(â€¦)çš„æ¨¡æ¿æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

```java
public final boolean release(long arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}
```

##### é’©å­å®ç°ï¼štryRelease()

tryRelease()æ–¹æ³•æ˜¯éœ€è¦å­ç±»æä¾›å®ç°çš„ä¸€ä¸ªé’©å­æ–¹æ³•ï¼Œéœ€è¦å­ç±»æ ¹æ®å…·ä½“ä¸šåŠ¡è¿›è¡Œå…·ä½“çš„å®ç°ã€‚

```java
protected final boolean tryRelease(int releases) {
  
    // é¦–å…ˆå°†å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ä¸ªæ•°å‡1(å›æº¯åˆ°è°ƒç”¨æºå¤´sync.release(1)å¯çŸ¥, releasesçš„å€¼ä¸º1)
    // è¿™é‡Œçš„æ“ä½œä¸»è¦æ˜¯é’ˆå¯¹å¯é‡å…¥é”çš„æƒ…å†µä¸‹, cå¯èƒ½å¤§äº1
    int c = getState() - releases; 
  
    // é‡Šæ”¾é”çš„çº¿ç¨‹å½“å‰å¿…é¡»æ˜¯æŒæœ‰é”çš„çº¿ç¨‹
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
  
    // å¦‚æœcä¸º0äº†, è¯´æ˜é”å·²ç»å®Œå…¨é‡Šæ”¾äº†
    boolean free = false;
    if (c == 0) {
        free = true;
        setExclusiveOwnerThread(null);
    }
    setState(c);
    return free;
}
```

##### å”¤é†’åç»§ï¼šunparkSuccessor()

release()é’©å­æ‰§è¡ŒtryRelease()é’©å­æˆåŠŸä¹‹åï¼Œä½¿ç”¨unparkSuccessor()å”¤é†’åç»§èŠ‚ç‚¹

```java
private void unparkSuccessor(Node node) {
    int ws = node.waitStatus;
  
    // å¦‚æœheadèŠ‚ç‚¹çš„wsæ¯”0å°, åˆ™ç›´æ¥å°†å®ƒè®¾ä¸º0
    if (ws < 0)
        compareAndSetWaitStatus(node, ws, 0);

    // é€šå¸¸æƒ…å†µä¸‹, è¦å”¤é†’çš„èŠ‚ç‚¹å°±æ˜¯è‡ªå·±çš„åç»§èŠ‚ç‚¹
    // å¦‚æœåç»§èŠ‚ç‚¹å­˜åœ¨ä¸”ä¹Ÿåœ¨ç­‰å¾…é”, é‚£å°±ç›´æ¥å”¤é†’å®ƒ
    // ä½†æ˜¯æœ‰å¯èƒ½å­˜åœ¨ åç»§èŠ‚ç‚¹å–æ¶ˆç­‰å¾…é” çš„æƒ…å†µ
    // æ­¤æ—¶ä»å°¾èŠ‚ç‚¹å¼€å§‹å‘å‰æ‰¾èµ·, ç›´åˆ°æ‰¾åˆ°è·ç¦»headèŠ‚ç‚¹æœ€è¿‘çš„ws<=0çš„èŠ‚ç‚¹
    Node s = node.next;
    if (s == null || s.waitStatus > 0) {
        s = null;
        for (Node t = tail; t != null && t != node; t = t.prev)
            if (t.waitStatus <= 0)
                s = t; // æ³¨æ„! è¿™é‡Œæ‰¾åˆ°äº†ä¹‹å¹¶æœ‰return, è€Œæ˜¯ç»§ç»­å‘å‰æ‰¾
    }
    // å¦‚æœæ‰¾åˆ°äº†è¿˜åœ¨ç­‰å¾…é”çš„èŠ‚ç‚¹,åˆ™å”¤é†’å®ƒ
    if (s != null)
        LockSupport.unpark(s.thread);
}
```

### èŠèŠ ReentrantLock

ReentrantLock æŒ‡çš„æ˜¯ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå¯¹ä¸€ä¸ªä¸´ç•Œèµ„æºé‡å¤åŠ é”ã€‚ReentrantLockç»§æ‰¿äº†Lockæ¥å£å¹¶å®ç°äº†åœ¨æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªå¯é‡å…¥çš„ç‹¬å é”ã€‚ReentrantLocké€šè¿‡è‡ªå®šä¹‰é˜Ÿåˆ—åŒæ­¥å™¨ï¼ˆAbstract Queued Sychronizedï¼ŒAQSï¼‰æ¥å®ç°é”çš„è·å–ä¸é‡Šæ”¾ã€‚

> ç‹¬å é”æŒ‡è¯¥é”åœ¨åŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è·å–ï¼Œè€Œè·å–é”çš„å…¶ä»–çº¿ç¨‹åªèƒ½åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼›å¯é‡å…¥é”æŒ‡è¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªèµ„æºæ‰§è¡Œå¤šæ¬¡åŠ é”æ“ä½œã€‚

    ReentrantLockä¸ä½†æä¾›äº†synchronizedå¯¹é”çš„æ“ä½œåŠŸèƒ½ï¼Œè¿˜æä¾›äº†è¯¸å¦‚å¯å“åº”ä¸­æ–­é”ã€å¯è½®è¯¢é”è¯·æ±‚ã€å®šæ—¶é”ç­‰é¿å…å¤šçº¿ç¨‹æ­»é”çš„æ–¹æ³•ã€‚
    
    ReentrantLockä¹‹æ‰€ä»¥è¢«ç§°ä¸ºå¯é‡å…¥é”ï¼Œæ˜¯å› ä¸ºReentrantLocké”å¯ä»¥åå¤è¿›å…¥ã€‚å³å…è®¸è¿ç»­ä¸¤æ¬¡è·å¾—åŒä¸€æŠŠé”ï¼Œä¸¤æ¬¡é‡Šæ”¾åŒä¸€æŠŠé”ã€‚å°†ä¸Šè¿°ä»£ç ä¸­çš„æ³¨é‡Šéƒ¨åˆ†å»æ‰åï¼Œç¨‹åºä»ç„¶å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚å¦‚æœé‡Šæ”¾é”çš„æ¬¡æ•°å°‘äºè·å–é”çš„æ¬¡æ•°ï¼Œè¯¥çº¿ç¨‹å°±ä¼šä¸€ç›´æŒæœ‰è¯¥é”ï¼Œå…¶ä»–çº¿ç¨‹å°†æ— æ³•è·å–é”èµ„æºã€‚

> å¯é‡å…¥é”ä¸»è¦ç†è§£ä¸¤ä¸ªæ¦‚å¿µï¼š
>
> 1ï¼‰å¯é‡å…¥çš„å«ä¹‰ï¼šè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è¿›å…¥åŒä¸€ä¸ªé”æ‰€åŒæ­¥çš„ä¸´ç•ŒåŒºä»£ç å—ã€‚æ¯”å¦‚ï¼ŒåŒä¸€çº¿ç¨‹åœ¨å¤–å±‚å‡½æ•°è·å¾—é”åï¼Œåœ¨å†…å±‚å‡½æ•°èƒ½å†æ¬¡è·å–è¯¥é”ï¼Œç”šè‡³å¤šæ¬¡æŠ¢å åˆ°åŒä¸€æŠŠé”ã€‚
>
> 2ï¼‰ç‹¬å çš„å«ä¹‰ï¼šåœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”ï¼Œè€Œå…¶ä»–è·å–é”çš„çº¿ç¨‹åªèƒ½ç­‰å¾…ï¼Œåªæœ‰æ‹¥æœ‰é”çš„çº¿ç¨‹é‡Šæ”¾äº†é”åï¼Œå…¶ä»–çš„çº¿ç¨‹æ‰èƒ½å¤Ÿè·å–é”ã€‚

æ•²é»‘æ¿ï¼šå¯é‡å…¥é”çš„ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä¸€å®šç¨‹åº¦é¿å…æ­»é”ã€‚

#### é¿å…æ­»é”

**å“åº”ä¸­æ–­**  åœ¨synchronizedä¸­å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–ä¸€æŠŠé”ï¼Œåˆ™å…¶ç»“æœæ˜¯è¦ä¹ˆè·å–é”ç»§ç»­æ‰§è¡Œï¼Œè¦ä¹ˆä¿æŒç­‰å¾…ã€‚ReentrantLockè¿˜æä¾›äº†å¯å“åº”ä¸­æ–­çš„å¯èƒ½ï¼Œå³åœ¨ç­‰å¾…é”çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å¯ä»¥æ ¹æ®éœ€è¦å–æ¶ˆå¯¹é”çš„è¯·æ±‚ã€‚

**å¯è½®è¯¢é”**  é€šè¿‡boolean tryLock()è·å–é”ã€‚å¦‚æœæœ‰å¯ç”¨é”ï¼Œåˆ™è·å–è¯¥é”å¹¶è¿”å›trueï¼Œå¦‚æœæ— å¯ç”¨é”ï¼Œåˆ™ç«‹å³è¿”å›falseã€‚

**å®šæ—¶é”**  é€šè¿‡boolean tryLock(long time,TimeUnit unit) throws InterruptedExceptionè·å–å®šæ—¶é”ã€‚å¦‚æœåœ¨ç»™å®šçš„æ—¶é—´å†…è·å–åˆ°äº†å¯ç”¨é”ï¼Œä¸”å½“å‰çº¿ç¨‹æœªè¢«ä¸­æ–­ï¼Œåˆ™è·å–è¯¥é”å¹¶è¿”å›trueã€‚å¦‚æœåœ¨ç»™å®šçš„æ—¶é—´å†…è·å–ä¸åˆ°å¯ç”¨é”ï¼Œå°†ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”åœ¨å‘ç”Ÿä»¥ä¸‹ä¸‰ç§æƒ…å†µä¹‹å‰ï¼Œè¯¥çº¿ç¨‹ä¸€ç›´å¤„äºä¼‘çœ çŠ¶æ€ã€‚

* å½“å‰çº¿ç¨‹è·å–åˆ°äº†å¯ç”¨é”å¹¶è¿”å›trueã€‚
* å½“å‰çº¿ç¨‹åœ¨è¿›å…¥æ­¤æ–¹æ³•æ—¶è®¾ç½®äº†è¯¥çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œæˆ–è€…å½“å‰çº¿ç¨‹åœ¨è·å–é”æ—¶è¢«ä¸­æ–­ï¼Œåˆ™å°†æŠ›å‡ºInterruptedExceptionï¼Œå¹¶æ¸…é™¤å½“å‰çº¿ç¨‹çš„å·²ä¸­æ–­çŠ¶æ€ã€‚
* å½“å‰çº¿ç¨‹è·å–é”çš„æ—¶é—´è¶…è¿‡äº†æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ï¼Œåˆ™å°†è¿”å›falseã€‚å¦‚æœè®¾å®šçš„æ—¶é—´å°äºç­‰äº0ï¼Œåˆ™è¯¥æ–¹æ³•å°†å®Œå…¨ä¸ç­‰å¾…ã€‚

#### éå…¬å¹³é”

ä»€ä¹ˆæ˜¯éå…¬å¹³é”å‘¢ï¼Ÿéå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºå¹¶ä¸ä¸€å®šæ˜¯å…¶ç”³è¯·é”çš„é¡ºåºï¼Œæœ‰å¯èƒ½åç”³è¯·çš„çº¿ç¨‹æ¯”å…ˆç”³è¯·çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ï¼ŒæŠ¢é”æˆåŠŸçš„æ¬¡åºä¸ä¸€å®šä½“ç°ä¸ºFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰é¡ºåºã€‚éå…¬å¹³é”çš„ä¼˜ç‚¹åœ¨äºååé‡æ¯”å…¬å¹³é”å¤§ï¼Œå®ƒçš„ç¼ºç‚¹æ˜¯æœ‰å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹ä¼˜å…ˆçº§åè½¬æˆ–è€…çº¿ç¨‹é¥¥é¥¿ç°è±¡ã€‚

![image-20220626120704721](./images/image-20220626120704721.png)

```java
/**
* åˆ›å»ºä¸€ä¸ªå¯é‡å…¥é”ï¼Œtrue è¡¨ç¤ºå…¬å¹³é”ï¼Œfalse è¡¨ç¤ºéå…¬å¹³é”ã€‚é»˜è®¤éå…¬å¹³é”
*/
Lock lock = new ReentrantLock(false);
```

#### å…¬å¹³é”

ä»€ä¹ˆæ˜¯å…¬å¹³é”å‘¢ï¼Ÿå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼ŒæŠ¢é”æˆåŠŸçš„æ¬¡åºä½“ç°ä¸ºFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰é¡ºåºã€‚è™½ç„¶ReentrantLocké”é»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œä½†å¯ä»¥é€šè¿‡æ„é€ å™¨æŒ‡å®šè¯¥é”ä¸ºå…¬å¹³é”

![image-20220626120658184](./images/image-20220626120658184.png)

```java
/**
* åˆ›å»ºä¸€ä¸ªå¯é‡å…¥é”ï¼Œtrue è¡¨ç¤ºå…¬å¹³é”ï¼Œfalse è¡¨ç¤ºéå…¬å¹³é”ã€‚é»˜è®¤éå…¬å¹³é”
*/
Lock lock = new ReentrantLock(true);
```

### CyclicBarrier å’Œ CountDownLatch çš„åŒºåˆ«

`CountDownLatch` æ˜¯è®¡æ•°å™¨ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè€Œ `CyclicBarrier` çš„è®¡æ•°å™¨æä¾› `reset` åŠŸèƒ½ï¼Œå¯ä»¥å¤šæ¬¡ä½¿ç”¨ã€‚ä½†æ˜¯æˆ‘ä¸é‚£ä¹ˆè®¤ä¸ºå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ä»…ä»…å°±æ˜¯è¿™ä¹ˆç®€å•çš„ä¸€ç‚¹ã€‚æˆ‘ä»¬æ¥ä» jdk ä½œè€…è®¾è®¡çš„ç›®çš„æ¥çœ‹ï¼Œjavadoc æ˜¯è¿™ä¹ˆæè¿°å®ƒä»¬çš„ï¼š

> CountDownLatch: A synchronization aid that allows one or more threads to wait until a  set of operations being performed in other threads  completes.(CountDownLatch: ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ï¼Œç­‰å¾…å…¶ä»–å¤šä¸ªçº¿ç¨‹å®ŒæˆæŸä»¶äº‹æƒ…ä¹‹åæ‰èƒ½æ‰§è¡Œï¼›) CyclicBarrier : A synchronization aid that allows a set of threads to all wait for  each other to reach a common barrier point.(CyclicBarrier :  å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾åŒä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œå†ç»§ç»­ä¸€èµ·æ‰§è¡Œã€‚)

å¯¹äº `CountDownLatch` æ¥è¯´ï¼Œé‡ç‚¹æ˜¯â€œä¸€ä¸ªçº¿ç¨‹ï¼ˆå¤šä¸ªçº¿ç¨‹ï¼‰ç­‰å¾…â€ï¼Œè€Œå…¶ä»–çš„ N ä¸ªçº¿ç¨‹åœ¨å®Œæˆâ€œæŸä»¶äº‹æƒ…â€ä¹‹åï¼Œå¯ä»¥ç»ˆæ­¢ï¼Œä¹Ÿå¯ä»¥ç­‰å¾…ã€‚è€Œå¯¹äº `CyclicBarrier`ï¼Œé‡ç‚¹æ˜¯å¤šä¸ªçº¿ç¨‹ï¼Œåœ¨ä»»æ„ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰å®Œæˆï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚

`CountDownLatch` æ˜¯è®¡æ•°å™¨ï¼Œçº¿ç¨‹å®Œæˆä¸€ä¸ªè®°å½•ä¸€ä¸ªï¼Œåªä¸è¿‡è®¡æ•°ä¸æ˜¯é€’å¢è€Œæ˜¯é€’å‡ï¼Œè€Œ `CyclicBarrier` æ›´åƒæ˜¯ä¸€ä¸ªé˜€é—¨ï¼Œéœ€è¦æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾ï¼Œé˜€é—¨æ‰èƒ½æ‰“å¼€ï¼Œç„¶åç»§ç»­æ‰§è¡Œã€‚

### ä¹è§‚é”å’Œæ‚²è§‚é”çš„åŒºåˆ«

#### ä¹è§‚é”

åŸç†ï¼šè¯»å¤šå†™å°‘ï¼Œä¹è§‚è®¤ä¸ºå¹¶å‘å¯èƒ½æ€§å°ã€‚ä¹è§‚é”ä¸€ç§æ¯”è¾ƒå…¸å‹çš„å°±æ˜¯CASåŸå­æ“ä½œï¼ŒJUCå¼ºå¤§çš„é«˜å¹¶å‘æ€§èƒ½æ˜¯å»ºç«‹åœ¨CASåŸå­ä¹‹ä¸Šçš„ã€‚ï¼ˆCASï¼šCompare And Setï¼‰ã€‚

ä¹è§‚é”æ˜¯ä¸€ç§æ€æƒ³ï¼Œè€ŒCASæ˜¯è¿™ç§æ€æƒ³çš„ä¸€ç§å®ç°ã€‚

å®é™…ä¸Šï¼Œå¦‚æœéœ€è¦å®Œæˆæ•°æ®çš„æœ€ç»ˆæ›´æ–°ï¼Œä»…ä»…è¿›è¡Œä¸€æ¬¡CASæ“ä½œæ˜¯ä¸å¤Ÿçš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéœ€è¦è¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œå³ä¸æ–­åœ°å¾ªç¯é‡è¯•CASæ“ä½œç›´åˆ°æˆåŠŸï¼Œè¿™ä¹Ÿå«CASè‡ªæ—‹ã€‚

é€šè¿‡CASè‡ªæ—‹ï¼Œåœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹å®ç°å¤šçº¿ç¨‹ä¹‹é—´çš„å˜é‡åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ²¡æœ‰çº¿ç¨‹è¢«é˜»å¡çš„æƒ…å†µä¸‹å®ç°å˜é‡çš„åŒæ­¥ï¼Œè¿™å«ä½œâ€œéé˜»å¡åŒæ­¥â€ï¼ˆNon-Blocking Synchronizationï¼‰ï¼Œæˆ–è€…è¯´â€œæ— é”åŒæ­¥â€ã€‚ä½¿ç”¨åŸºäºCASè‡ªæ—‹çš„ä¹è§‚é”è¿›è¡ŒåŒæ­¥æ§åˆ¶ï¼Œå±äºæ— é”ç¼–ç¨‹ï¼ˆLock Freeï¼‰çš„ä¸€ç§å®è·µã€‚

#### æ‚²è§‚é”

åŸç†ï¼šå†™å¤šè¯»å°‘ï¼Œç‹¬å é”å…¶å®å°±æ˜¯ä¸€ç§æ‚²è§‚é”ï¼ŒJavaçš„synchronizedæ˜¯æ‚²è§‚é”ã€‚æ‚²è§‚é”å¯ä»¥ç¡®ä¿æ— è®ºå“ªä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œéƒ½èƒ½ç‹¬å å¼è®¿é—®ä¸´ç•ŒåŒºã€‚è™½ç„¶æ‚²è§‚é”çš„é€»è¾‘éå¸¸ç®€å•ï¼Œä½†æ˜¯å­˜åœ¨ä¸å°‘é—®é¢˜ã€‚æ‚²è§‚é”æ€»æ˜¯å‡è®¾ä¼šå‘ç”Ÿæœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡çº¿ç¨‹è¯»å–æ•°æ®æ—¶ï¼Œä¹Ÿä¼šä¸Šé”ã€‚è¿™æ ·å…¶ä»–çº¿ç¨‹åœ¨è¯»å–æ•°æ®æ—¶å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å®ƒæ‹¿åˆ°é”ã€‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ç”¨åˆ°äº†å¾ˆå¤šæ‚²è§‚é”ï¼Œæ¯”å¦‚è¡Œé”ã€è¡¨é”ã€è¯»é”ã€å†™é”ç­‰ï¼›ç›´æ¥åŠ Synchronizeï¼ŒAQSæ¡†æ¶æ˜¯å…ˆCASè·å–é”ï¼Œè·å–ä¸åˆ°ååŠ Synchronizeæ‚²è§‚é” egï¼šReentranLockã€‚

> æ‹“å±•ï¼šè‡ªæ—‹é”
>
> åŸç†ï¼šå¦‚æœæŒæœ‰é”çš„çº¿ç¨‹å¾ˆå¿«å°±é‡Šæ”¾é”èµ„æºï¼Œé‚£ä¹ˆè¿™äº›ç­‰å¾…ç«äº‰é”çš„å¾…é‡Šæ”¾å†é‡æ–°è¢«é”ä¸Šçš„çº¿ç¨‹ä¸ç”¨åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„å½±å“ä¸‹åˆ‡æ¢å¹¶è¿›å…¥é˜»å¡æŒ‚èµ·çŠ¶æ€ï¼Œä»–ä»¬åªéœ€è¦è‡ªæ—‹ç­‰ä¸€ä¼šç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”åç«‹å³è·å–é”ã€‚

## â™»ï¸ JVM

å›å¿†å¤§çº²å›¾ï¼ˆæ”¾å¤§çœ‹å›å¿†çš„æ›´åŠ æ¸…æ¥šå™¢ï¼‰

![JVMç®€åŒ–ç‰ˆæ¶æ„](./images/JVM%E7%AE%80%E5%8C%96%E7%89%88%E6%9E%B6%E6%9E%84.png)

### å›¾è§£JVMç»“æ„

#### æ•´ä½“æ¶æ„å›¾ï¼šå»ºè®®é»˜å†™

![image-20220629110459744](./images/image-20220629110459744.png)

#### ç¨‹åºè®¡æ•°å™¨

ç¨‹åºè®¡æ•°å™¨æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå®ƒå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚**å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆ**ã€‚

ç”±äº Java è™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢ã€åˆ†é…å¤„ç†å™¨æ‰§è¡Œæ—¶é—´çš„æ–¹å¼æ¥å®ç°çš„ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨ï¼ˆå¯¹äºå¤šæ ¸å¤„ç†å™¨æ¥è¯´æ˜¯ä¸€ä¸ªå†…æ ¸ï¼‰éƒ½åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„æŒ‡ä»¤ã€‚

**å› æ­¤ï¼Œä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´çš„è®¡æ•°å™¨äº’ä¸å½±å“**ã€‚

é‚£ä¹ˆç¨‹åºè®¡æ•°å™¨é‡Œå­˜çš„åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ

- å¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ª Java æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€
- å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨å€¼åˆ™åº”ä¸ºç©ºï¼ˆUndefinedï¼‰ã€‚è‡³äºä»€ä¹ˆæ˜¯ Native æ–¹æ³•ï¼Œåœ¨æœ¬åœ°æ–¹æ³•æ ˆé‚£ä¸€å°èŠ‚ä¼šè¯¦ç»†è§£é‡Š

> æ³¨æ„ï¼æ­¤å†…å­˜åŒºåŸŸæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ²¡æœ‰è§„å®šä»»ä½• OutOfMemoryErrorï¼ˆå†…å­˜æº¢å‡ºï¼‰æƒ…å†µçš„åŒºåŸŸã€‚è¿™ä¸ªé—®é¢˜ä¹Ÿç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„é¢è¯•é¢˜äº†

#### è™šæ‹Ÿæœºæ ˆ

æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºçš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„æ ˆå¸§(Stack Frameï¼‰

æ¯ä¸ª**æ ˆå¸§**ï¼ˆStack Frameï¼‰ä¸­å­˜å‚¨ç€ï¼š

- å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰
- æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰(æˆ–ç§°ä¸ºè¡¨è¾¾å¼æ ˆ)
- åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ï¼šæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨
- æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰ï¼šæ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸é€€å‡ºçš„åœ°å€
- ä¸€äº›é™„åŠ ä¿¡æ¯

![image-20220628171657570](./images/image-20220628171657570.png)

#### æœ¬åœ°æ–¹æ³•æ ˆ

æœ¬åœ°æ–¹æ³•æ ˆå’Œä¸Šé¢æˆ‘ä»¬æ‰€è¯´çš„è™šæ‹Ÿæœºæ ˆä½œç”¨åŸºæœ¬ä¸€æ ·ï¼ŒåŒºåˆ«åªä¸è¿‡æ˜¯æœ¬åœ°æ–¹æ³•æ ˆä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„ Native æ–¹æ³•æœåŠ¡ï¼Œè€Œè™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œ Java æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ã€‚

è¿™é‡Œè§£é‡Šä¸€ä¸‹ **Native æ–¹æ³•**çš„æ¦‚å¿µï¼Œå…¶å®ä¸ä»… Javaï¼Œå¾ˆå¤šè¯­è¨€ä¸­éƒ½æœ‰è¿™ä¸ªæ¦‚å¿µã€‚

"A native method is a Java method whose implementation is provided by non-java code."

å°±æ˜¯è¯´ä¸€ä¸ª Native æ–¹æ³•å…¶å®å°±æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä½†æ˜¯å®ƒçš„å…·ä½“å®ç°æ˜¯åœ¨å¤–éƒ¨ç”±é Java è¯­è¨€æ¯”å¦‚ C æˆ– C++ ç­‰æ¥å†™çš„ã€‚Java é€šè¿‡ JNI  æ¥è°ƒç”¨æœ¬åœ°æ–¹æ³•ï¼Œ è€Œæœ¬åœ°æ–¹æ³•æ˜¯ä»¥åº“æ–‡ä»¶çš„å½¢å¼å­˜æ”¾çš„ï¼ˆåœ¨ WINDOWS å¹³å°ä¸Šæ˜¯ DLL æ–‡ä»¶å½¢å¼ï¼Œåœ¨ UNIX æœºå™¨ä¸Šæ˜¯ SO æ–‡ä»¶å½¢å¼ï¼‰ã€‚

æ‰€ä»¥åŒä¸€ä¸ª Native æ–¹æ³•ï¼Œå¦‚æœç”¨ä¸åŒçš„è™šæ‹Ÿæœºå»è°ƒç”¨å®ƒï¼Œé‚£ä¹ˆå¾—åˆ°çš„ç»“æœå’Œè¿è¡Œæ•ˆç‡å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› ä¸ºä¸åŒçš„è™šæ‹Ÿæœºå¯¹äºæŸä¸ª Native æ–¹æ³•éƒ½æœ‰è‡ªå·±çš„å®ç°ï¼Œæ¯”å¦‚ Object ç±»çš„ `hashCode` æ–¹æ³•ã€‚

**é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦ Native æ–¹æ³•å‘¢**ï¼Ÿ

å…¶ä¸»è¦åŸå› å°±æ˜¯ Java è™½ç„¶ä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æœ‰äº›å±‚æ¬¡çš„ä»»åŠ¡ç”¨ Java å®ç°èµ·æ¥ä¸å®¹æ˜“ï¼Œæˆ–è€…å¯¹ç¨‹åºçš„æ•ˆç‡æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚æ—¶ï¼ŒJava  è¯­è¨€å¯èƒ½å¹¶ä¸æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚æ‰€ä»¥ Native æ–¹æ³•ä½¿å¾— Java ç¨‹åºèƒ½å¤Ÿè¶…è¶Š Java è¿è¡Œæ—¶çš„ç•Œé™ï¼Œæœ‰æ•ˆåœ°æ‰©å……äº† JVMã€‚

> ä¸è™šæ‹Ÿæœºæ ˆä¸€æ ·ï¼Œæœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šåœ¨æ ˆæ·±åº¦æº¢å‡ºæˆ–è€…æ ˆæ‰©å±•å¤±è´¥æ—¶åˆ†åˆ«æŠ›å‡º StackOverflowError å’Œ OutOfMemoryError å¼‚å¸¸

#### å †

Java å †æ˜¯è™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚**å †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œâ€œå‡ ä¹â€ æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜**ã€‚

æ³¨æ„ï¼è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯å‡ ä¹ï¼ŒæŠ€æœ¯å‘å±•è‡³ä»Šï¼Œ**å…¶å®å¹¶éæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½ä¼šåˆ†é…åˆ°å †ä¸Š**ï¼Œæ¯”å¦‚é€ƒé€¸æŠ€æœ¯ï¼Œè¿™ä¸ªæˆ‘ä»¬åç»­æ–‡ç« æˆ‘å†åšè§£é‡Š~

å †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„å†…å­˜åŒºåŸŸï¼Œå› æ­¤ä¸€äº›èµ„æ–™ä¸­å®ƒä¹Ÿè¢«ç§°ä½œ â€œGC å †â€ï¼ˆGarbage Collected Heapï¼‰ã€‚

å¯¹äºå †è¿™ä¸ªæ¦‚å¿µå°ä¼™ä¼´ä»¬è‚¯å®šè¿˜å¬è¯´è¿‡å„ç§è¯¸å¦‚æ–°ç”Ÿä»£ã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ã€Eden ç©ºé—´ã€From Survivor ç©ºé—´ã€To Survivor ç©ºé—´ç­‰åè¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**è¿™äº›åŒºåŸŸåˆ’åˆ†ä»…ä»…æ˜¯ä¸€éƒ¨åˆ†åƒåœ¾æ”¶é›†å™¨çš„å…±åŒç‰¹æ€§æˆ–è€…è¯´è®¾è®¡é£æ ¼è€Œå·²ï¼Œåªæ˜¯ä¸ºäº†é€šè¿‡è¿™ç§åˆ†ä»£è®¾è®¡æ¥æ›´å¥½åœ°å›æ”¶å†…å­˜ï¼Œæˆ–è€…æ›´å¿«åœ°åˆ†é…å†…å­˜ï¼Œè€ŒéæŸä¸ª Java è™šæ‹Ÿæœºå…·ä½“å®ç°çš„å›ºæœ‰å†…å­˜å¸ƒå±€ï¼Œæ›´ä¸æ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹é‡Œå¯¹ Java å †çš„è¿›ä¸€æ­¥ç»†è‡´åˆ’åˆ†**

æ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„è§„å®šï¼ŒJava  å †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šå®ƒåº”è¯¥è¢«è§†ä¸ºè¿ç»­çš„ï¼Œè¿™ç‚¹å°±åƒæˆ‘ä»¬ç”¨ç£ç›˜ç©ºé—´å»å­˜å‚¨æ–‡ä»¶ä¸€æ ·ï¼Œå¹¶ä¸è¦æ±‚æ¯ä¸ªæ–‡ä»¶éƒ½è¿ç»­å­˜æ”¾ã€‚ä½†å¯¹äºå¤§å¯¹è±¡ï¼ˆå…¸å‹çš„å¦‚æ•°ç»„å¯¹è±¡ï¼‰ï¼Œå¤šæ•°è™šæ‹Ÿæœºå®ç°å‡ºäºå®ç°ç®€å•ã€å­˜å‚¨é«˜æ•ˆçš„è€ƒè™‘ï¼Œå¾ˆå¯èƒ½ä¼šè¦æ±‚è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚

Java å †æ—¢å¯ä»¥è¢«å®ç°æˆå›ºå®šå¤§å°çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯æ‰©å±•çš„ï¼Œå½“å‰ä¸»æµçš„ Java è™šæ‹Ÿæœºéƒ½æ˜¯æŒ‰ç…§å¯æ‰©å±•æ¥å®ç°çš„ï¼ˆé€šè¿‡å‚æ•° `-Xmx` å’Œ `-Xms` è®¾å®šï¼‰

> å¦‚æœåœ¨å †ä¸­æ²¡æœ‰å†…å­˜æ¥å®Œæˆå¯¹è±¡å®ä¾‹çš„åˆ†é…ï¼Œå¹¶ä¸”å †ä¹Ÿæ— æ³•å†æ‰©å±•æ—¶ï¼ŒJVM å°±ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸

![image-20220628162509521](./images/image-20220628162509521.png)

![image-20220628164028744](./images/image-20220628164028744.png)



#### æ–¹æ³•åŒº 

**æ–¹æ³•åŒºé€šä¿—ç‚¹ç†è§£å°±æ˜¯ï¼Œåœ¨è™šæ‹Ÿæœºå®Œæˆç±»åŠ è½½ä¹‹åï¼Œå­˜å‚¨è¿™ä¸ªç±»ç›¸å…³çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰æ•°æ®**ã€‚

> It stores `per-class structures` such as the `run-time constant pool`, `field` and `method data`, and `the code for methods and constructors`, including the special methods used in class and instance initialization and interface initialization.  å®ƒå­˜å‚¨æ¯ä¸ªç±»çš„ç»“æ„ï¼Œå¦‚è¿è¡Œæ—¶çš„å¸¸é‡æ± ã€å­—æ®µå’Œæ–¹æ³•æ•°æ®ï¼Œä»¥åŠæ–¹æ³•å’Œæ„é€ å‡½æ•°çš„ä»£ç ï¼ŒåŒ…æ‹¬ç±»å’Œå®ä¾‹åˆå§‹åŒ–å’Œæ¥å£åˆå§‹åŒ–ä¸­ä½¿ç”¨çš„ç‰¹æ®Šæ–¹æ³•

ä¸¾ä¸ªç®€å•çš„å°ä¾‹å­ï¼š

![image-20220725144553583](images/image-20220725144553583.png)

æ–¹æ³•åŒºå…¶å®æœ¬èº«å¾ˆå¥½ç†è§£ï¼Œä½†æ˜¯ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹/ ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹æåˆ°çš„ä¸€å¥è¯ï¼š**æ–¹æ³•åŒºæ˜¯å †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†**ï¼ŒçœŸçš„æ˜¯è®©æˆ‘å›°æƒ‘äº†å¾ˆé•¿æ—¶é—´ã€‚

ä¸‹é¢æˆ‘æ¥ç»“åˆæˆ‘çš„ç†è§£ç»™å¤§å®¶è§£é‡Šä¸‹ï¼Œæˆ‘è§‰å¾—è¿™ä¸ª â€œæ–¹æ³•åŒºæ˜¯å †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†â€ åº”è¯¥é€‚ç”¨äº JDK 8 ä»¥å‰ï¼Œè€Œä¸é€‚ç”¨ JDK 8

å…ˆæ¥çœ‹ JDK 8 ä¹‹å‰:

![image-20220725144601249](images/image-20220725144601249.png)

å¯ä»¥çœ‹åˆ°ï¼Œ**JDK 8 ä¹‹å‰ï¼Œå †å’Œæ–¹æ³•åŒºå…¶å®æ˜¯è¿åœ¨ä¸€èµ·çš„ï¼Œæˆ–è€…è¯´ï¼Œæ–¹æ³•åŒºå°±æ˜¯å †çš„ä¸€éƒ¨åˆ†**ã€‚

ä½†æ˜¯å‘¢ï¼Œ**æ–¹æ³•åŒºå­˜å‚¨çš„ä¸œè¥¿åˆæœ‰äº›ç‰¹åˆ«**ï¼Œåœ¨è¿‡å»è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä½¿ç”¨ä¸æ™®éçš„æ—¶å€™ï¼Œç±»å‡ ä¹æ˜¯ â€œé™æ€çš„â€ å¹¶ä¸”å¾ˆå°‘è¢«å¸è½½å’Œå›æ”¶ï¼Œå› æ­¤ç±»ä¹Ÿå¯ä»¥è¢«çœ‹æˆ â€œæ°¸ä¹…çš„â€ï¼ˆè¿™ä¹Ÿå°±æ˜¯æ°¸ä¹…ä»£çš„å«ä¹‰ï¼‰ï¼Œå¦å¤–ç”±äºç±»ä½œä¸º JVM å®ç°çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬ä¸ç”±ç¨‹åºæ¥åˆ›å»ºï¼Œ**æ‰€ä»¥ä¸ºäº†å’Œå †åŒºåˆ†å¼€æ¥å‘¢**ï¼Œå°±ç»™äº† â€œæ–¹æ³•åŒºâ€ è¿™æ ·ä¸€ä¸ªåå­—ç”¨æ¥å­˜å‚¨ç±»çš„ä¿¡æ¯ï¼Œä¹Ÿæœ‰äººæŠŠæ–¹æ³•åŒºç§°ä¸º â€œéå †â€ã€‚

â­ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**æ— è®ºæ˜¯æ–¹æ³•åŒºè¿˜æ˜¯éå †ï¼Œå…¶å®éƒ½åªæ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œåœ¨ JDK 8 ä¹‹å‰ï¼Œå…¶å…·ä½“çš„å®ç°æ–¹æ³•æ˜¯æ°¸ä¹…ä»£**ã€‚

æ°¸ä¹…ä»£æ˜¯ HotSpot è™šæ‹Ÿæœºç»™å‡ºçš„å®ç°ï¼Œä½†æ˜¯å¯¹äºå…¶ä»–è™šæ‹Ÿæœºå®ç°ï¼Œè­¬å¦‚ BEA JRockitã€IBM J9 ç­‰æ¥è¯´ï¼Œæ˜¯ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„æ¦‚å¿µçš„ã€‚

![image-20220725144641131](images/image-20220725144641131.png)

**æ°¸ä¹…ä»£æ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´**ï¼Œæˆ‘ä»¬åœ¨ JVM å¯åŠ¨ä¹‹å‰å¯ä»¥é€šè¿‡è®¾ç½® `-XX:MaxPermSize` çš„å€¼æ¥æ§åˆ¶æ°¸ä¹…ä»£çš„å¤§å°ï¼Œ32 ä½æœºå™¨é»˜è®¤çš„æ°¸ä¹…ä»£çš„å¤§å°ä¸º 64Mï¼Œ64 ä½çš„æœºå™¨åˆ™ä¸º 85Mã€‚

**æ°¸ä¹…ä»£çš„åƒåœ¾å›æ”¶å’Œè€å¹´ä»£çš„åƒåœ¾å›æ”¶æ˜¯ç»‘å®šçš„ï¼Œä¸€æ—¦å…¶ä¸­ä¸€ä¸ªåŒºåŸŸè¢«å æ»¡ï¼Œè¿™ä¸¤ä¸ªåŒºéƒ½è¦è¿›è¡Œåƒåœ¾å›æ”¶**ã€‚

æ˜¾ç„¶è¿™ç§è®¾è®¡å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„ä¸»æ„ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥é€šè¿‡ `â€‘XX:MaxPermSize` è®¾ç½®æ°¸ä¹…ä»£çš„å¤§å°ï¼Œä¸€æ—¦ç±»çš„å…ƒæ•°æ®è¶…è¿‡äº†è®¾å®šçš„å¤§å°ï¼Œç¨‹åºå°±ä¼šè€—å°½å†…å­˜ï¼Œå¹¶å‡ºç°å†…å­˜æº¢å‡ºé”™è¯¯ (`java.lang.OutOfMemoryError: PermGen space`)ã€‚

**è€Œä¸”æœ‰æå°‘æ•°çš„æ–¹æ³•**ï¼ˆä¾‹å¦‚é€‚ç”¨ `String`çš„ `intern()`æ–¹æ³•å¯ä»¥åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ‰‹åŠ¨çš„å°†å­—ç¬¦ä¸²æ·»åŠ åˆ° å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œåœ¨ JDK1.7 ä¹‹å‰çš„ HotSpot è™šæ‹Ÿæœºä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± è¢«å­˜å‚¨åœ¨æ°¸ä¹…ä»£ä¸­ï¼‰**ä¼šå› æ°¸ä¹…ä»£çš„åŸå› è€Œå¯¼è‡´ä¸åŒè™šæ‹Ÿæœºä¸‹æœ‰ä¸åŒçš„è¡¨ç°**ï¼ˆæ¯”å¦‚ JRockit è™šæ‹Ÿæœºå°±æ²¡æœ‰æ°¸ä¹…ä»£çš„æ¦‚å¿µï¼‰

æ‰€ä»¥æˆ‘ä»¬æ€»ç»“ä¸‹ HotSpots åœ¨ JDK 8 æŠ›å¼ƒæ°¸ä¹…ä»£ï¼Œè½¬è€Œç”¨å…ƒç©ºé—´æ¥å®ç°æ–¹æ³•åŒºçš„**ä¸¤å¤§åŸå› **ï¼š

1. ç”±äºæ°¸ä¹…ä»£çš„åƒåœ¾å›æ”¶å’Œè€å¹´ä»£çš„åƒåœ¾å›æ”¶æ˜¯ç»‘å®šçš„ï¼Œä¸€æ—¦å…¶ä¸­ä¸€ä¸ªåŒºåŸŸè¢«å æ»¡ï¼Œè¿™ä¸¤ä¸ªåŒºéƒ½è¦è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå¢å¤§äº† OOM å‘ç”Ÿçš„æ¦‚ç‡
2. æœ‰å°‘æ•°çš„æ–¹æ³•ä¾‹å¦‚ `String` çš„ `intern()` æ–¹æ³•ä¼šå› æ°¸ä¹…ä»£çš„åŸå› è€Œå¯¼è‡´ä¸åŒè™šæ‹Ÿæœºä¸‹æœ‰ä¸åŒçš„è¡¨ç°ï¼Œä¸åˆ©äºä»£ç è¿ç§»

é‚£ä¹ˆå…ƒç©ºé—´åˆ°åº•æ˜¯ä¸ªå•¥ï¼Œå’Œæ–¹æ³•åŒºæœ‰å•¥åŒºåˆ«ï¼Ÿ

**å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´ä¸å†ä¸å †è¿ç»­ï¼Œå¹¶ä¸”æ˜¯å­˜åœ¨äºæœ¬åœ°å†…å­˜ï¼ˆNative memoryï¼‰ä¸­çš„**ã€‚

![image-20220725144655251](images/image-20220725144655251.png)

è¿è¡Œæ—¶æ•°æ®åŒºåŸŸçš„å¯¹æ¯”å¦‚ä¸‹å›¾ï¼š

![image-20220725144703356](images/image-20220725144703356.png)

> **å…ƒç©ºé—´å­˜åœ¨äºæœ¬åœ°å†…å­˜ï¼Œæ„å‘³ç€åªè¦æœ¬åœ°å†…å­˜è¶³å¤Ÿï¼Œå®ƒå°±ä¸ä¼š OOM**ï¼Œä¸ä¼šå‡ºç°åƒæ°¸ä¹…ä»£ä¸­çš„ `java.lang.OutOfMemoryError: PermGenspace`



##### è¿è¡Œæ—¶å¸¸é‡æ± 

**è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†**ã€‚ä¸Šé¢æˆ‘ä»¬è¯´è¿‡æ–¹æ³•åŒºåŒ…å«ç±»ä¿¡æ¯ï¼Œè€Œæè¿°ç±»ä¿¡æ¯çš„ Class æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯**å¸¸é‡æ± è¡¨ (Constant Pool Table)**ï¼Œç”¨äºå­˜æ”¾**ç¼–è¯‘æœŸ**ç”Ÿæˆçš„å„ç§å­—é¢é‡ï¼ˆå­—é¢é‡ç›¸å½“äº Java è¯­è¨€å±‚é¢å¸¸é‡çš„æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå£°æ˜ä¸º final çš„å¸¸é‡å€¼ç­‰ï¼‰ä¸ç¬¦å·å¼•ç”¨ã€‚æœ‰ä¸€äº›æ–‡ç« ä¼šæŠŠ class å¸¸é‡æ± è¡¨ç§°ä¸º**é™æ€å¸¸é‡æ± **ã€‚

éƒ½æ˜¯å¸¸é‡æ± ï¼Œå¸¸é‡æ± è¡¨å’Œè¿è¡Œæ—¶å¸¸é‡æ± æœ‰å•¥å…³ç³»å—ï¼Ÿè¿è¡Œæ—¶å¸¸é‡æ± æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ

**è¿è¡Œæ—¶å¸¸é‡æ± å¯ä»¥åœ¨è¿è¡ŒæœŸé—´å°† class å¸¸é‡æ± è¡¨ä¸­çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨**ã€‚ç®€å•æ¥è¯´ï¼Œclass å¸¸é‡æ± è¡¨å°±ç›¸å½“äºä¸€å †ç´¢å¼•ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± æ ¹æ®è¿™äº›ç´¢å¼•æ¥æŸ¥æ‰¾å¯¹åº”æ–¹æ³•æˆ–å­—æ®µæ‰€å±çš„ç±»å‹ä¿¡æ¯å’Œåç§°åŠæè¿°ç¬¦ä¿¡æ¯

ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ± è¿™ä¸ªä¸œè¥¿å‘¢ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†é¿å…é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯å¯¹è±¡è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ï¼Œå…¶å®ç°äº†å¯¹è±¡çš„å…±äº«ã€‚ä»¥**å­—ç¬¦ä¸²å¸¸é‡æ± **ä¸ºä¾‹ï¼Œå­—ç¬¦ä¸² `String` æ—¢ç„¶ä½œä¸º `Java` ä¸­çš„ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆå®ƒå’Œå…¶ä»–çš„å¯¹è±¡åˆ†é…ä¸€æ ·ï¼Œéœ€è¦è€—è´¹é«˜æ˜‚çš„æ—¶é—´ä¸ç©ºé—´ä»£ä»·ï¼Œä½œä¸ºæœ€åŸºç¡€æœ€å¸¸ç”¨çš„æ•°æ®ç±»å‹ï¼Œå¤§é‡é¢‘ç¹çš„åˆ›å»ºå­—ç¬¦ä¸²ï¼Œå°†ä¼šæå¤§ç¨‹åº¦çš„å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚ä¸ºæ­¤ï¼ŒJVM ä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å¼€é”€ï¼Œåœ¨å®ä¾‹åŒ–å­—ç¬¦ä¸²å¸¸é‡çš„æ—¶å€™è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼š

- ä¸ºå­—ç¬¦ä¸²å¼€è¾Ÿäº†ä¸€ä¸ª**å­—ç¬¦ä¸²å¸¸é‡æ±  String Pool**ï¼Œå¯ä»¥ç†è§£ä¸ºç¼“å­˜åŒº
- åˆ›å»ºå­—ç¬¦ä¸²å¸¸é‡æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å­˜åœ¨è¯¥å­—ç¬¦ä¸²
- **è‹¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­˜åœ¨è¯¥å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥å¼•ç”¨å®ä¾‹ï¼Œæ— éœ€é‡æ–°å®ä¾‹åŒ–**ï¼›è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å®ä¾‹åŒ–è¯¥å­—ç¬¦ä¸²å¹¶æ”¾å…¥æ± ä¸­ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± çš„ä½ç½®åœ¨ JDK 1.7 å‰åæœ‰æ‰€å˜åŒ–ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ è¡¨ï¼š

![image-20220725144724148](images/image-20220725144724148.png)

### â­ï¸ç±»çš„ç”Ÿå‘½å‘¨æœŸã€ç±»åŠ è½½çš„è¿‡ç¨‹

#### ç±»çš„ç”Ÿå‘½å‘¨æœŸ

![image-20220628160331611](./images/image-20220628160331611.png)

#### ç±»çš„åŠ è½½è¿‡ç¨‹

ç²—ç•¥

![image-20220628160442776](./images/image-20220628160442776.png)

è¯¦ç»†è¿‡ç¨‹

![image-20220628160739969](./images/image-20220628160739969.png)

### JDK ä¸­æœ‰å“ªäº›é»˜è®¤çš„ç±»åŠ è½½å™¨

> è¿™é‡Œå‚è€ƒäº†[JVM åº•å±‚åŸç†æœ€å…¨çŸ¥è¯†æ€»ç»“](https://doocs.github.io/jvm/)

![image-20220628161228908](./images/image-20220628161228908.png)

ç³»ç»Ÿæä¾›äº† 3 ç§ç±»åŠ è½½å™¨ï¼š

- å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼š è´Ÿè´£å°†å­˜æ”¾åœ¨ `<JAVA_HOME>\lib` ç›®å½•ä¸­çš„ï¼Œå¹¶ä¸”èƒ½è¢«è™šæ‹Ÿæœºè¯†åˆ«çš„ï¼ˆä»…æŒ‰ç…§æ–‡ä»¶åè¯†åˆ«ï¼Œå¦‚ rt.jarï¼Œåå­—ä¸ç¬¦åˆçš„ç±»åº“å³ä½¿æ”¾åœ¨ lib ç›®å½•ä¸­ä¹Ÿä¸ä¼šè¢«åŠ è½½ï¼‰ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­ã€‚
- æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼š è´Ÿè´£åŠ è½½ `<JAVA_HOME>\lib\ext` ç›®å½•ä¸­çš„æ‰€æœ‰ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨ã€‚
- åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰ï¼š ç”±äºè¿™ä¸ªç±»åŠ è½½å™¨æ˜¯ ClassLoader ä¸­çš„ `getSystemClassLoader()` æ–¹æ³•çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¹Ÿç§°å®ƒä¸ºâ€œç³»ç»Ÿç±»åŠ è½½å™¨â€ã€‚å®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ï¼ˆclasspathï¼‰ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚

### å¦‚ä½•å¯¹æ ˆè¿›è¡Œå‚æ•°è°ƒä¼˜

* å¯ä»¥é€šè¿‡-Xssï¼šè°ƒæ•´æ¯ä¸ªçº¿ç¨‹æ ˆç©ºé—´çš„å¤§å°
* -XXThreadStackSizeï¼šè®¾ç½®çº¿ç¨‹æ ˆçš„å¤§å°

### è¯´ä¸€ä¸‹æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»

æ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£ä»¥åŠå…ƒç©ºé—´çš„å…³ç³»å¾ˆåƒ Java  ä¸­æ¥å£å’Œç±»çš„å…³ç³»ï¼Œç±»å®ç°äº†æ¥å£ï¼Œè¿™é‡Œçš„ç±»å°±å¯ä»¥çœ‹ä½œæ˜¯æ°¸ä¹…ä»£å’Œå…ƒç©ºé—´ï¼Œæ¥å£å¯ä»¥çœ‹ä½œæ˜¯æ–¹æ³•åŒºï¼Œä¹Ÿå°±æ˜¯è¯´æ°¸ä¹…ä»£ä»¥åŠå…ƒç©ºé—´æ˜¯ HotSpot  è™šæ‹Ÿæœºå¯¹è™šæ‹Ÿæœºè§„èŒƒä¸­æ–¹æ³•åŒºçš„ä¸¤ç§å®ç°æ–¹å¼ã€‚å¹¶ä¸”ï¼Œæ°¸ä¹…ä»£æ˜¯ JDK 1.8 ä¹‹å‰çš„æ–¹æ³•åŒºå®ç°ï¼ŒJDK 1.8 åŠä»¥åæ–¹æ³•åŒºçš„å®ç°å˜æˆäº†å…ƒç©ºé—´ã€‚

![image-20220628171430898](./images/image-20220628171430898.png)

### å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ­»äº¡

#### å¼•ç”¨è®¡æ•°æ³•

åœ¨å¯¹è±¡å¤´ç»´æŠ¤ç€ä¸€ä¸ª counter è®¡æ•°å™¨ï¼Œå¯¹è±¡è¢«å¼•ç”¨ä¸€æ¬¡åˆ™è®¡æ•°å™¨ +1ï¼›è‹¥å¼•ç”¨å¤±æ•ˆåˆ™è®¡æ•°å™¨ -1ã€‚å½“è®¡æ•°å™¨ä¸º 0 æ—¶ï¼Œå°±è®¤ä¸ºè¯¥å¯¹è±¡æ— æ•ˆäº†ã€‚

å¼•ç”¨è®¡æ•°ç®—æ³•çš„å®ç°ç®€å•ï¼Œåˆ¤å®šæ•ˆç‡ä¹Ÿå¾ˆé«˜ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹å®ƒéƒ½æ˜¯ä¸€ä¸ªä¸é”™çš„ç®—æ³•ã€‚ä½†æ˜¯ä¸»æµçš„ Java è™šæ‹Ÿæœºé‡Œæ²¡æœ‰é€‰ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•æ¥ç®¡ç†å†…å­˜ï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒå¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚ï¼ˆè™½ç„¶å¾ªç¯å¼•ç”¨çš„é—®é¢˜å¯é€šè¿‡ Recycler ç®—æ³•è§£å†³ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¼•ç”¨è®¡æ•°å˜æ›´ä¹Ÿè¦è¿›è¡Œæ˜‚è´µçš„åŒæ­¥æ“ä½œï¼Œæ€§èƒ½è¾ƒä½ï¼Œæ—©æœŸçš„ç¼–ç¨‹è¯­è¨€ä¼šé‡‡ç”¨æ­¤ç®—æ³•ã€‚ï¼‰

#### å¯è¾¾æ€§åˆ†æ

å¯è¾¾æ€§åˆ†ææ˜¯é€šè¿‡ä¸€ç³»åˆ—è¢«ç§°ä¸º `GC Roots` çš„æ ¹å¯¹è±¡ä½œä¸ºèµ·å§‹èŠ‚ç‚¹é›†ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹ï¼Œæ ¹æ®å¼•ç”¨å…³ç³»å‘ä¸‹æœç´¢ï¼Œæœç´¢è¿‡ç¨‹æ‰€èµ°è¿‡çš„è·¯å¾„è¢«ç§°ä¸ºå¼•ç”¨é“¾ï¼ˆReference Chainï¼‰ï¼Œå¦‚æœæŸä¸ªå¯¹è±¡åˆ° `GC Roots` é—´æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œè¿™ä»£è¡¨ `GC Roots` åˆ°è¯¥å¯¹è±¡ä¸å¯è¾¾ï¼Œ æ­¤æ—¶è¯æ˜æ­¤è¯¥å¯¹è±¡ä¸å¯èƒ½å†è¢«ä½¿ç”¨ã€‚

GC Roots æ˜¯æŒ‡ï¼š

- **è™šæ‹Ÿæœºæ ˆ**ï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡
- **æœ¬åœ°æ–¹æ³•æ ˆ**ä¸­å¼•ç”¨çš„å¯¹è±¡
- **æ–¹æ³•åŒº**ä¸­**å¸¸é‡**å¼•ç”¨çš„å¯¹è±¡
- æ–¹æ³•åŒºä¸­ç±»**é™æ€**å±æ€§å¼•ç”¨çš„å¯¹è±¡

GC Roots å¹¶ä¸åŒ…æ‹¬å †ä¸­å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚

![image-20220624223650067](./images/image-20220624223650067.png)

â˜ ï¸è¦çœŸæ­£å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œéœ€è¦ç»è¿‡è‡³å°‘âœŒï¸æ¬¡æ ‡è®°è¿‡ç¨‹ï¼š

- 1ï¸âƒ£å¦‚æœå¯¹è±¡åœ¨è¿›è¡Œå¯è¾¾æ€§åˆ†æåå‘ç° `GC Roots` ä¸å¯è¾¾ï¼Œå°†ä¼šè¿›è¡Œç¬¬ä¸€æ¬¡æ ‡è®°ï¼›
- 2ï¸âƒ£éšåè¿›è¡Œä¸€æ¬¡ç­›é€‰ï¼Œç­›é€‰çš„æ¡ä»¶æ˜¯æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œ `finalized()` æ–¹æ³•ã€‚å¦‚æœå¯¹è±¡æ²¡æœ‰è¦†ç›– `finalized()` æ–¹æ³•ï¼Œæˆ–è€… `finalized()` å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šè§†ä¸ºæ²¡æœ‰å¿…è¦æ‰§è¡Œã€‚å¦‚æœåˆ¤å®šç»“æœæ˜¯æœ‰å¿…è¦æ‰§è¡Œï¼Œæ­¤æ—¶å¯¹è±¡ä¼šè¢«æ”¾å…¥åä¸º `F-Queue` çš„é˜Ÿåˆ—ï¼Œç­‰å¾… Finalizer çº¿ç¨‹æ‰§è¡Œå…¶ `finalized()` æ–¹æ³•ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ”¶é›†å™¨ä¼šè¿›è¡Œç¬¬äºŒæ¬¡å°è§„æ¨¡çš„æ ‡è®°ï¼Œå¦‚æœå¯¹è±¡åœ¨ `finalized()` æ–¹æ³•ä¸­é‡æ–°å°†è‡ªå·±ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡è¿›è¡Œäº†å…³è”ï¼Œå¦‚å°†è‡ªå·±ï¼ˆthis å…³é”®å­—ï¼‰èµ‹å€¼ç»™æŸä¸ªç±»å˜é‡æˆ–è€…å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œæ­¤æ—¶å®ƒå°±å®ç°äº†è‡ªæˆ‘æ‹¯æ•‘ï¼Œåˆ™ç¬¬äºŒæ¬¡æ ‡è®°ä¼šå°†å…¶ç§»é™¤ â€œå³å°†å›æ”¶â€ çš„é›†åˆï¼Œå¦åˆ™è¯¥å¯¹è±¡å°±å°†è¢«çœŸæ­£å›æ”¶ï¼Œèµ°å‘æ­»äº¡ã€‚

### â­ï¸è™šå¼•ç”¨ä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨çš„åŒºåˆ«

* **è™šå¼•ç”¨**ï¼šè™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ã€‚å½“åƒåœ¾å›æ”¶å™¨å‡†å¤‡å›æ”¶ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœå‘ç°å®ƒè¿˜æœ‰è™šå¼•ç”¨ï¼Œå°±ä¼šåœ¨å›æ”¶å¯¹è±¡çš„å†…å­˜ä¹‹å‰ï¼ŒæŠŠè¿™ä¸ªè™šå¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚ç¨‹åºå¯ä»¥é€šè¿‡åˆ¤æ–­å¼•ç”¨é˜Ÿåˆ—ä¸­æ˜¯å¦å·²ç»åŠ å…¥äº†è™šå¼•ç”¨ï¼Œæ¥äº†è§£è¢«å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦å°†è¦è¢«åƒåœ¾å›æ”¶ã€‚ç¨‹åºå¦‚æœå‘ç°æŸä¸ªè™šå¼•ç”¨å·²ç»è¢«åŠ å…¥åˆ°å¼•ç”¨é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨æ‰€å¼•ç”¨çš„å¯¹è±¡çš„å†…å­˜è¢«å›æ”¶ä¹‹å‰é‡‡å–å¿…è¦çš„è¡ŒåŠ¨ã€‚

  * **è™šå¼•ç”¨ä¸»è¦ç”¨æ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨**ã€‚
* **è½¯å¼•ç”¨**ï¼šå¦‚æœå†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶å®ƒï¼Œå¦‚æœå†…å­˜ç©ºé—´ä¸è¶³äº†ï¼Œå°±ä¼šå›æ”¶è¿™äº›å¯¹è±¡çš„å†…å­˜

  * å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜
* **å¼±å¼•ç”¨**ï¼šåªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡æ‹¥æœ‰æ›´çŸ­æš‚çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒæ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å®ƒçš„å†…å­˜ã€‚ä¸è¿‡ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨æ˜¯ä¸€ä¸ªä¼˜å…ˆçº§å¾ˆä½çš„çº¿ç¨‹ï¼Œ å› æ­¤ä¸ä¸€å®šä¼šå¾ˆå¿«å‘ç°é‚£äº›åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚

### å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡

1. JDK1.7 ä¹‹å‰è¿è¡Œæ—¶å¸¸é‡æ± é€»è¾‘åŒ…å«å­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ–¹æ³•åŒº, æ­¤æ—¶ hotspot è™šæ‹Ÿæœºå¯¹æ–¹æ³•åŒºçš„å®ç°ä¸ºæ°¸ä¹…ä»£
2. JDK1.7 å­—ç¬¦ä¸²å¸¸é‡æ± è¢«ä»æ–¹æ³•åŒºæ‹¿åˆ°äº†å †ä¸­, è¿™é‡Œæ²¡æœ‰æåˆ°è¿è¡Œæ—¶å¸¸é‡æ± ,ä¹Ÿå°±æ˜¯è¯´å­—ç¬¦ä¸²å¸¸é‡æ± è¢«å•ç‹¬æ‹¿åˆ°å †,è¿è¡Œæ—¶å¸¸é‡æ± å‰©ä¸‹çš„ä¸œè¥¿è¿˜åœ¨æ–¹æ³•åŒº, ä¹Ÿå°±æ˜¯ hotspot ä¸­çš„æ°¸ä¹…ä»£
3. JDK1.8 hotspot ç§»é™¤äº†æ°¸ä¹…ä»£ç”¨å…ƒç©ºé—´(Metaspace)å–è€Œä»£ä¹‹, è¿™æ—¶å€™å­—ç¬¦ä¸²å¸¸é‡æ± è¿˜åœ¨å †, è¿è¡Œæ—¶å¸¸é‡æ± è¿˜åœ¨æ–¹æ³•åŒº, åªä¸è¿‡æ–¹æ³•åŒºçš„å®ç°ä»æ°¸ä¹…ä»£å˜æˆäº†å…ƒç©ºé—´(Metaspace)

å‡å¦‚åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­˜åœ¨å­—ç¬¦ä¸² "abc"ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ä»»ä½• String å¯¹è±¡å¼•ç”¨è¯¥å­—ç¬¦ä¸²å¸¸é‡çš„è¯ï¼Œå°±è¯´æ˜å¸¸é‡ "abc" å°±æ˜¯åºŸå¼ƒå¸¸é‡ï¼Œå¦‚æœè¿™æ—¶å‘ç”Ÿå†…å­˜å›æ”¶çš„è¯è€Œä¸”æœ‰å¿…è¦çš„è¯ï¼Œ"abc" å°±ä¼šè¢«ç³»ç»Ÿæ¸…ç†å‡ºå¸¸é‡æ± äº†ã€‚

### åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿå¦‚æœæˆ‘ä»¬ä¸æƒ³ç”¨åŒäº²å§”æ´¾æ¨¡å‹æ€ä¹ˆåŠï¼Ÿ

æ¯ä¸€ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªå¯¹åº”å®ƒçš„ç±»åŠ è½½å™¨ã€‚ç³»ç»Ÿä¸­çš„ ClassLoader åœ¨ååŒå·¥ä½œçš„æ—¶å€™ä¼šé»˜è®¤ä½¿ç”¨ **åŒäº²å§”æ´¾æ¨¡å‹** ã€‚å³åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ã€‚åŠ è½½çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šæŠŠè¯¥è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨çš„ `loadClass()` å¤„ç†ï¼Œå› æ­¤æ‰€æœ‰çš„è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ `BootstrapClassLoader` ä¸­ã€‚å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•å¤„ç†æ—¶ï¼Œæ‰ç”±è‡ªå·±æ¥å¤„ç†ã€‚å½“çˆ¶ç±»åŠ è½½å™¨ä¸º null æ—¶ï¼Œä¼šä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨ `BootstrapClassLoader` ä½œä¸ºçˆ¶ç±»åŠ è½½å™¨ã€‚

![image-20220628172850425](./images/image-20220628172850425.png)

**å¦‚æœæˆ‘ä»¬ä¸æƒ³ç”¨åŒäº²å§”æ´¾æ¨¡å‹æ€ä¹ˆåŠ**

è‡ªå®šä¹‰åŠ è½½å™¨çš„è¯ï¼Œéœ€è¦ç»§æ‰¿ `ClassLoader` ã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå°±é‡å†™ `ClassLoader` ç±»ä¸­çš„ `findClass()` æ–¹æ³•å³å¯ï¼Œæ— æ³•è¢«çˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æœ€ç»ˆä¼šé€šè¿‡è¿™ä¸ªæ–¹æ³•è¢«åŠ è½½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹åˆ™éœ€è¦é‡å†™ `loadClass()` æ–¹æ³•

### å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»

- è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚
- åŠ è½½è¯¥ç±»çš„ `ClassLoader` å·²ç»è¢«å›æ”¶ã€‚
- è¯¥ç±»å¯¹åº”çš„ `java.lang.Class` å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚

### â­ï¸åƒåœ¾æ”¶é›†æœ‰å“ªäº›ç®—æ³•ï¼Œå„è‡ªçš„ç‰¹ç‚¹

- æ ‡è®°-æ¸…é™¤ç®—æ³•
- æ ‡è®°-å¤åˆ¶ç®—æ³•
- æ ‡è®°-æ•´ç†ç®—æ³•

#### æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ŒMark-Sweep

å®ƒæ˜¯æœ€åŸºç¡€çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ”¶é›†è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šé¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåï¼Œç»Ÿä¸€å›æ”¶æ‰æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ï¼›ä¹Ÿå¯ä»¥åè¿‡æ¥ï¼Œæ ‡è®°å­˜æ´»å¯¹è±¡ï¼Œç»Ÿä¸€å›æ”¶æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡ã€‚

![image-20220628153301516](./images/image-20220628153301516.png)

å®ƒä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªç¼ºç‚¹ï¼š

- æ‰§è¡Œæ•ˆç‡ä¸ç¨³å®šï¼šå¦‚æœ Java å †ä¸ŠåŒ…å«å¤§é‡éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåˆ™éœ€è¦è¿›è¡Œå¤§é‡æ ‡è®°å’Œæ¸…é™¤åŠ¨ä½œï¼›
- å†…å­˜ç©ºé—´ç¢ç‰‡åŒ–ï¼šæ ‡è®°æ¸…é™¤åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„ç©ºé—´ï¼Œä»è€Œå¯èƒ½å¯¼è‡´æ— æ³•ä¸ºå¤§å¯¹è±¡åˆ†é…è¶³å¤Ÿçš„è¿ç»­å†…å­˜ã€‚

![image-20220629095233918](./images/image-20220629095233918.png)

#### æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼ŒMark-Copy

æ ‡è®°-å¤åˆ¶ç®—æ³•åŸºäº â€åŠåŒºå¤åˆ¶â€œ  ç®—æ³•ï¼šå®ƒå°†å¯ç”¨å†…å­˜æŒ‰å®¹é‡åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œå½“è¿™ä¸€å—çš„å†…å­˜ä½¿ç”¨å®Œäº†ï¼Œå°±å°†è¿˜å­˜æ´»ç€çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šé¢ï¼Œç„¶åå†æŠŠå·²ç»ä½¿ç”¨è¿‡çš„é‚£å—å†…å­˜ç©ºé—´ä¸€æ¬¡æ€§æ¸…ç†æ‰ã€‚å…¶ä¼˜ç‚¹åœ¨äºé¿å…äº†å†…å­˜ç©ºé—´ç¢ç‰‡åŒ–çš„é—®é¢˜ï¼Œå…¶ç¼ºç‚¹å¦‚ä¸‹ï¼š

- å¦‚æœå†…å­˜ä¸­å¤šæ•°å¯¹è±¡éƒ½æ˜¯å­˜æ´»çš„ï¼Œè¿™ç§ç®—æ³•å°†äº§ç”Ÿå¤§é‡çš„å¤åˆ¶å¼€é”€ï¼›
- æµªè´¹å†…å­˜ç©ºé—´ï¼Œå†…å­˜ç©ºé—´å˜ä¸ºäº†åŸæœ‰çš„ä¸€åŠã€‚

![image-20220628153316648](./images/image-20220628153316648.png)

åŸºäºæ–°ç”Ÿä»£ â€œæœç”Ÿå¤•ç­â€ çš„ç‰¹ç‚¹ï¼Œå¤§å¤šæ•°è™šæ‹Ÿæœºéƒ½ä¸ä¼šæŒ‰ç…§ 1:1 çš„æ¯”ä¾‹æ¥è¿›è¡Œå†…å­˜åˆ’åˆ†ï¼Œä¾‹å¦‚ HotSpot è™šæ‹Ÿæœºä¼šå°†å†…å­˜ç©ºé—´åˆ’åˆ†ä¸ºä¸€å—è¾ƒå¤§çš„ `Eden` å’Œ ä¸¤å—è¾ƒå°çš„ `Survivor` ç©ºé—´ï¼Œå®ƒä»¬ä¹‹é—´çš„æ¯”ä¾‹æ˜¯ 8:1:1 ã€‚ æ¯æ¬¡åˆ†é…æ—¶åªä¼šä½¿ç”¨ `Eden` å’Œå…¶ä¸­çš„ä¸€å— `Survivor` ï¼Œå‘ç”Ÿåƒåœ¾å›æ”¶æ—¶ï¼Œåªéœ€è¦å°†å­˜æ´»çš„å¯¹è±¡ä¸€æ¬¡æ€§å¤åˆ¶åˆ°å¦å¤–ä¸€å— `Survivor` ä¸Šï¼Œè¿™æ ·åªæœ‰ 10% çš„å†…å­˜ç©ºé—´ä¼šè¢«æµªè´¹æ‰ã€‚å½“ `Survivor` ç©ºé—´ä¸è¶³ä»¥å®¹çº³ä¸€æ¬¡ `Minor GC` æ—¶ï¼Œæ­¤æ—¶ç”±å…¶ä»–å†…å­˜åŒºåŸŸï¼ˆé€šå¸¸æ˜¯è€å¹´ä»£ï¼‰æ¥è¿›è¡Œåˆ†é…æ‹…ä¿ã€‚

![image-20220629095353992](./images/image-20220629095353992.png)

#### æ ‡è®°-æ•´ç†ç®—æ³•ï¼ŒMark-Compact

æ ‡è®°-æ•´ç†ç®—æ³•æ˜¯åœ¨æ ‡è®°å®Œæˆåï¼Œè®©æ‰€æœ‰å­˜æ´»å¯¹è±¡éƒ½å‘å†…å­˜çš„ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰è¾¹ç•Œä»¥å¤–çš„å†…å­˜ã€‚å…¶ä¼˜ç‚¹åœ¨äºå¯ä»¥é¿å…å†…å­˜ç©ºé—´ç¢ç‰‡åŒ–çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥å……åˆ†åˆ©ç”¨å†…å­˜ç©ºé—´ï¼›å…¶ç¼ºç‚¹åœ¨äºæ ¹æ®æ‰€ä½¿ç”¨çš„æ”¶é›†å™¨çš„ä¸åŒï¼Œåœ¨ç§»åŠ¨å­˜æ´»å¯¹è±¡æ—¶å¯èƒ½è¦å…¨ç¨‹æš‚åœç”¨æˆ·ç¨‹åºï¼š

![image-20220628153332879](./images/image-20220628153332879.png)

![image-20220629095251304](./images/image-20220629095251304.png)

#### ğŸ™…ã€Ignoreã€‘æ ‡è®° - å‹ç¼©ï¼ˆæ•´ç†ï¼‰ç®—æ³•ï¼ŒMark - Compact

- ç¬¬ä¸€é˜¶æ®µå’Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨å¯¹è±¡
- ç¬¬äºŒé˜¶æ®µå°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ï¼ŒæŒ‰é¡ºåºæ’æ”¾ã€‚
- ä¹‹åï¼Œæ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´ã€‚

> æ ‡è®°æ¸…é™¤å’Œæ ‡è®°å‹ç¼©çš„åŒºåˆ«

* æ ‡è®° - å‹ç¼©ç®—æ³•çš„æœ€ç»ˆæ•ˆæœç­‰åŒäºæ ‡è®° - æ¸…é™¤ç®—æ³•æ‰§è¡Œå®Œæˆåï¼Œå†è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†ï¼Œå› æ­¤ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒç§°ä¸º**æ ‡è®° - æ¸…é™¤ - å‹ç¼©ï¼ˆMark-Sweep-Compactï¼‰ç®—æ³•ã€‚**
* äºŒè€…çš„æœ¬è´¨å·®å¼‚åœ¨äºæ ‡è®° - æ¸…é™¤ç®—æ³•æ˜¯ä¸€ç§**éç§»åŠ¨å¼çš„å›æ”¶ç®—æ³•**ï¼Œæ ‡è®° - å‹ç¼©æ˜¯**ç§»åŠ¨å¼çš„**ã€‚æ˜¯å¦ç§»åŠ¨å›æ”¶åçš„å­˜æ´»å¯¹è±¡æ˜¯ä¸€é¡¹ä¼˜ç¼ºç‚¹å¹¶å­˜çš„é£é™©å†³ç­–ã€‚
* å¯ä»¥çœ‹åˆ°ï¼Œæ ‡è®°çš„å­˜æ´»å¯¹è±¡å°†ä¼šè¢«æ•´ç†ï¼ŒæŒ‰ç…§å†…å­˜åœ°å€ä¾æ¬¡æ’åˆ—ï¼Œè€Œæœªè¢«æ ‡è®°çš„å†…å­˜ä¼šè¢«æ¸…ç†æ‰ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“æˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVM åªéœ€è¦æŒæœ‰ä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ï¼Œè¿™æ¯”ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ˜¾ç„¶å°‘äº†è®¸å¤šå¼€é”€

> æ ‡è®°å‹ç¼©ç®—æ³•å†…éƒ¨ä½¿ç”¨æŒ‡é’ˆç¢°æ’

å¦‚æœå†…å­˜ç©ºé—´ä»¥è§„æ•´å’Œæœ‰åºçš„æ–¹å¼åˆ†å¸ƒï¼Œå³å·²ç”¨å’Œæœªç”¨çš„å†…å­˜éƒ½å„è‡ªä¸€è¾¹ï¼Œå½¼æ­¤ä¹‹é—´ç»´ç³»ç€ä¸€ä¸ªè®°å½•ä¸‹ä¸€æ¬¡åˆ†é…èµ·å§‹ç‚¹çš„æ ‡è®°æŒ‡é’ˆï¼Œå½“ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œåªéœ€è¦é€šè¿‡ä¿®æ”¹æŒ‡é’ˆçš„åç§»é‡å°†æ–°å¯¹è±¡åˆ†é…åœ¨ç¬¬ä¸€ä¸ªç©ºé—²å†…å­˜ä½ç½®ä¸Šï¼Œè¿™ç§åˆ†é…æ–¹å¼å°±å«åšæŒ‡é’ˆç¢°æ’ï¼ˆBump the Pointerï¼‰

![image-20220628153345486](./images/image-20220628153345486.png)

> ä¼˜ç‚¹

- æ¶ˆé™¤äº†æ ‡è®° - æ¸…é™¤ç®—æ³•å½“ä¸­ï¼Œå†…å­˜åŒºåŸŸåˆ†æ•£çš„ç¼ºç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVM åªéœ€è¦æŒæœ‰ä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ã€‚
- æ¶ˆé™¤äº†å¤åˆ¶ç®—æ³•å½“ä¸­ï¼Œå†…å­˜å‡åŠçš„é«˜é¢ä»£ä»·ã€‚

> ç¼ºç‚¹

- ä»æ•ˆç‡ä¸Šæ¥è¯´ï¼Œæ ‡è®° - æ•´ç†ç®—æ³•è¦ä½äºå¤åˆ¶ç®—æ³•ï¼Œç”šè‡³è¦ä½äºæ ‡è®° - æ¸…é™¤ç®—æ³•
- ç§»åŠ¨å¯¹è±¡çš„åŒæ—¶ï¼Œå¦‚æœå¯¹è±¡è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œåˆ™è¿˜éœ€è¦è°ƒæ•´å¼•ç”¨çš„åœ°å€
- ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å…¨ç¨‹æš‚åœç”¨æˆ·åº”ç”¨ç¨‹åºã€‚å³ï¼šSTW

### HotSpot ä¸ºä»€ä¹ˆè¦åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£

ä¸ºäº†è¿›è¡Œé«˜æ•ˆçš„åƒåœ¾å›æ”¶ï¼Œè™šæ‹ŸæœºæŠŠå †å†…å­˜**é€»è¾‘ä¸Š**åˆ’åˆ†æˆä¸‰å—åŒºåŸŸï¼ˆåˆ†ä»£çš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¼˜åŒ– GC æ€§èƒ½ï¼‰

### â­ï¸å¸¸è§çš„åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›

#### Serial æ”¶é›†å™¨

Serialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾æ”¶é›†å™¨äº†ã€‚å¤§å®¶çœ‹åå­—å°±çŸ¥é“è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨äº†ã€‚å®ƒçš„ **â€œå•çº¿ç¨‹â€** çš„æ„ä¹‰ä¸ä»…ä»…æ„å‘³ç€å®ƒåªä¼šä½¿ç”¨ä¸€æ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯å®ƒåœ¨è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œçš„æ—¶å€™å¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼ˆ **"Stop The World"** ï¼‰ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚

ğŸ‘¶**æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼ŒğŸ‘´è€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**

![image-20220628153037233](./images/image-20220628153037233.png)

#### ParNew æ”¶é›†å™¨

**ParNew æ”¶é›†å™¨å…¶å®å°±æ˜¯ Serial æ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œé™¤äº†ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å¤–ï¼Œå…¶ä½™è¡Œä¸ºï¼ˆæ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€å›æ”¶ç­–ç•¥ç­‰ç­‰ï¼‰å’Œ Serial æ”¶é›†å™¨å®Œå…¨ä¸€æ ·ã€‚**

ğŸ‘¶**æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼ŒğŸ‘´è€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**

![image-20220628153046946](./images/image-20220628153046946.png)

#### Parallel Scavenge æ”¶é›†å™¨

Parallel Scavenge æ”¶é›†å™¨ä¹Ÿæ˜¯ä½¿ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•çš„å¤šçº¿ç¨‹æ”¶é›†å™¨ï¼Œå®ƒçœ‹ä¸Šå»å‡ ä¹å’Œ ParNew éƒ½ä¸€æ ·ã€‚ **é‚£ä¹ˆå®ƒæœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„å‘¢ï¼Ÿ**

```text
-XX:+UseParallelGC

    ä½¿ç”¨ Parallel æ”¶é›†å™¨+ è€å¹´ä»£ä¸²è¡Œ

-XX:+UseParallelOldGC

    ä½¿ç”¨ Parallel æ”¶é›†å™¨+ è€å¹´ä»£å¹¶è¡Œ
```

**Parallel Scavenge æ”¶é›†å™¨å…³æ³¨ç‚¹æ˜¯ååé‡ï¼ˆé«˜æ•ˆç‡çš„åˆ©ç”¨ CPUï¼‰ã€‚CMS ç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰ã€‚æ‰€è°“ååé‡å°±æ˜¯ CPU ä¸­ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸ CPU æ€»æ¶ˆè€—æ—¶é—´çš„æ¯”å€¼ã€‚** Parallel Scavenge  æ”¶é›†å™¨æä¾›äº†å¾ˆå¤šå‚æ•°ä¾›ç”¨æˆ·æ‰¾åˆ°æœ€åˆé€‚çš„åœé¡¿æ—¶é—´æˆ–æœ€å¤§ååé‡ï¼Œå¦‚æœå¯¹äºæ”¶é›†å™¨è¿ä½œä¸å¤ªäº†è§£ï¼Œæ‰‹å·¥ä¼˜åŒ–å­˜åœ¨å›°éš¾çš„æ—¶å€™ï¼Œä½¿ç”¨ Parallel  Scavenge æ”¶é›†å™¨é…åˆè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ï¼ŒæŠŠå†…å­˜ç®¡ç†ä¼˜åŒ–äº¤ç»™è™šæ‹Ÿæœºå»å®Œæˆä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

**æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚**

![image-20220628153114059](./images/image-20220628153114059.png)

**è¿™æ˜¯ JDK1.8 é»˜è®¤æ”¶é›†å™¨**

ä½¿ç”¨ java -XX:+PrintCommandLineFlags -version å‘½ä»¤æŸ¥çœ‹

```text
-XX:InitialHeapSize=262921408 -XX:MaxHeapSize=4206742528 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC
java version "1.8.0_211"
Java(TM) SE Runtime Environment (build 1.8.0_211-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode)
```

JDK1.8  é»˜è®¤ä½¿ç”¨çš„æ˜¯ Parallel Scavenge + Parallel Oldï¼Œå¦‚æœæŒ‡å®šäº†-XX:+UseParallelGC  å‚æ•°ï¼Œåˆ™é»˜è®¤æŒ‡å®šäº†-XX:+UseParallelOldGCï¼Œå¯ä»¥ä½¿ç”¨-XX:-UseParallelOldGC æ¥ç¦ç”¨è¯¥åŠŸèƒ½

#### Serial Old æ”¶é›†å™¨

**Serial æ”¶é›†å™¨çš„ğŸ‘´è€å¹´ä»£ç‰ˆæœ¬**ï¼Œå®ƒåŒæ ·æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨ã€‚å®ƒä¸»è¦æœ‰ä¸¤å¤§ç”¨é€”ï¼šä¸€ç§ç”¨é€”æ˜¯åœ¨ JDK1.5 ä»¥åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ä¸ Parallel Scavenge æ”¶é›†å™¨æ­é…ä½¿ç”¨ï¼Œå¦ä¸€ç§ç”¨é€”æ˜¯ä½œä¸º CMS æ”¶é›†å™¨çš„åå¤‡æ–¹æ¡ˆã€‚

![image-20220628153028054](./images/image-20220628153028054.png)

#### Paralled Old æ”¶é›†å™¨

**Parallel Scavenge æ”¶é›†å™¨çš„ğŸ‘´è€å¹´ä»£ç‰ˆæœ¬**ã€‚ä½¿ç”¨å¤šçº¿ç¨‹å’Œâ€œæ ‡è®°-æ•´ç†â€ç®—æ³•ã€‚åœ¨æ³¨é‡ååé‡ä»¥åŠ CPU èµ„æºçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavenge æ”¶é›†å™¨å’Œ Parallel Old æ”¶é›†å™¨ã€‚

![image-20220628153107883](./images/image-20220628153107883.png)

#### CMS æ”¶é›†å™¨

**CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ã€‚å®ƒéå¸¸ç¬¦åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨ã€‚**

**CMSï¼ˆConcurrent Mark Sweepï¼‰æ”¶é›†å™¨æ˜¯ HotSpot è™šæ‹Ÿæœºç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘æ”¶é›†å™¨ï¼Œå®ƒç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹ï¼ˆåŸºæœ¬ä¸Šï¼‰åŒæ—¶å·¥ä½œã€‚**

ä»åå­—ä¸­çš„**Mark Sweep**è¿™ä¸¤ä¸ªè¯å¯ä»¥çœ‹å‡ºï¼ŒCMS æ”¶é›†å™¨æ˜¯ä¸€ç§ **â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•**å®ç°çš„ï¼Œå®ƒçš„è¿ä½œè¿‡ç¨‹ç›¸æ¯”äºå‰é¢å‡ ç§åƒåœ¾æ”¶é›†å™¨æ¥è¯´æ›´åŠ å¤æ‚ä¸€äº›ã€‚æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š

1. **åˆå§‹æ ‡è®° (inital mark)**ï¼šæ ‡è®° `GC Roots` èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œè€—æ—¶çŸ­ä½†éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼›
2. **å¹¶å‘æ ‡è®° (concurrent mark)**ï¼šä» `GC Roots` èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾ï¼Œè€—æ—¶é•¿ä½†ä¸éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼›
3. **é‡æ–°æ ‡è®° (remark)**ï¼šé‡‡ç”¨å¢é‡æ›´æ–°ç®—æ³•ï¼Œå¯¹å¹¶å‘æ ‡è®°é˜¶æ®µå› ä¸ºç”¨æˆ·çº¿ç¨‹è¿è¡Œè€Œäº§ç”Ÿå˜åŠ¨çš„é‚£éƒ¨åˆ†å¯¹è±¡è¿›è¡Œé‡æ–°æ ‡è®°ï¼Œè€—æ—¶æ¯”åˆå§‹æ ‡è®°ç¨é•¿ä¸”éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼›
4. **å¹¶å‘æ¸…é™¤ (inital sweep)**ï¼šå¹¶å‘æ¸…é™¤æ‰å·²ç»æ­»äº¡çš„å¯¹è±¡ï¼Œè€—æ—¶é•¿ä½†ä¸éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ã€‚

![image-20220628153004557](./images/image-20220628153004557.png)

ä»å®ƒçš„åå­—å°±å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸»è¦ä¼˜ç‚¹ï¼š**å¹¶å‘æ”¶é›†ã€ä½åœé¡¿**ã€‚ä½†æ˜¯å®ƒæœ‰ä¸‹é¢ä¸‰ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ï¼š

- **å¯¹ CPU èµ„æºæ•æ„Ÿï¼›**
- **æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ï¼›**
- **å®ƒä½¿ç”¨çš„å›æ”¶ç®—æ³•-â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¼šå¯¼è‡´æ”¶é›†ç»“æŸæ—¶ä¼šæœ‰å¤§é‡ç©ºé—´ç¢ç‰‡äº§ç”Ÿã€‚**

> CMSé€šå¸¸æœ‰ä¸¤ä¸ªé˜¶æ®µä¼šè¿›è¡ŒSTW

ç¬¬ä¸€é˜¶æ®µå’Œç¬¬ä¸‰é˜¶æ®µ

* **åˆå§‹æ ‡è®°ï¼ˆInitial-Markï¼‰é˜¶æ®µ**ï¼šåœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œç¨‹åºä¸­æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ (ç”¨æˆ·çº¿ç¨‹) éƒ½å°†ä¼šå› ä¸º  â€œStop-The-Worldâ€ æœºåˆ¶è€Œå‡ºç°çŸ­æš‚çš„æš‚åœï¼Œè¿™ä¸ªé˜¶æ®µçš„ä¸»è¦ä»»åŠ¡ä»…ä»…åªæ˜¯æ ‡è®°å‡º GC Roots  èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ã€‚ä¸€æ—¦æ ‡è®°å®Œæˆä¹‹åå°±ä¼šæ¢å¤ä¹‹å‰è¢«æš‚åœçš„æ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚ç”±äºç›´æ¥å…³è”å¯¹è±¡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€Ÿåº¦éå¸¸å¿«ã€‚

* **é‡æ–°æ ‡è®°ï¼ˆRemarkï¼‰é˜¶æ®µ**ï¼šç”±äºåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µä¸­ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹ä¼šå’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œï¼Œå› æ­¤ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´é€šå¸¸ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µç¨é•¿ä¸€äº›ï¼Œä½†ä¹Ÿè¿œæ¯”å¹¶å‘æ ‡è®°é˜¶æ®µçš„æ—¶é—´çŸ­ã€‚



#### G1 æ”¶é›†å™¨

Garbage Firstï¼ˆç®€ç§° G1ï¼‰æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¹Ÿæ˜¯ JDK 9  æœåŠ¡ç«¯æ¨¡å¼ä¸‹é»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ï¼Œå®ƒçš„è¯ç”Ÿå…·æœ‰é‡Œç¨‹ç¢‘å¼çš„æ„ä¹‰ã€‚G1 è™½ç„¶ä¹Ÿéµå¾ªåˆ†ä»£æ”¶é›†ç†è®ºï¼Œä½†ä¸å†ä»¥å›ºå®šå¤§å°å’Œå›ºå®šæ•°é‡æ¥åˆ’åˆ†åˆ†ä»£åŒºåŸŸï¼Œè€Œæ˜¯æŠŠè¿ç»­çš„  Java å †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ã€‚æ¯ä¸€ä¸ª Region éƒ½å¯ä»¥æ ¹æ®ä¸åŒçš„éœ€æ±‚æ¥æ‰®æ¼”æ–°ç”Ÿä»£çš„ `Eden` ç©ºé—´ã€`Survivor` ç©ºé—´æˆ–è€…è€å¹´ä»£ç©ºé—´ï¼Œæ”¶é›†å™¨ä¼šæ ¹æ®å…¶æ‰®æ¼”è§’è‰²çš„ä¸åŒè€Œé‡‡ç”¨ä¸åŒçš„æ”¶é›†ç­–ç•¥ã€‚

![image-20220624224020148](./images/image-20220624224020148.png)

ä¸Šé¢è¿˜æœ‰ä¸€äº› Region ä½¿ç”¨ H è¿›è¡Œæ ‡æ³¨ï¼Œå®ƒä»£è¡¨ Humongousï¼Œè¡¨ç¤ºè¿™äº› Region ç”¨äºå­˜å‚¨å¤§å¯¹è±¡ï¼ˆhumongous objectï¼ŒH-objï¼‰ï¼Œå³å¤§å°å¤§äºç­‰äº region ä¸€åŠçš„å¯¹è±¡ã€‚G1 æ”¶é›†å™¨çš„è¿è¡Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š

1. **åˆå§‹æ ‡è®° (Inital Marking)**ï¼šæ ‡è®° `GC Roots` èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œå¹¶ä¸”ä¿®æ”¹ TAMSï¼ˆTop at Mark Startï¼‰æŒ‡é’ˆçš„å€¼ï¼Œè®©ä¸‹ä¸€é˜¶æ®µç”¨æˆ·çº¿ç¨‹å¹¶å‘è¿è¡Œæ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®çš„åœ¨ Reigin ä¸­åˆ†é…æ–°å¯¹è±¡ã€‚G1 ä¸ºæ¯ä¸€ä¸ª Reigin éƒ½è®¾è®¡äº†ä¸¤ä¸ªåä¸º TAMS  çš„æŒ‡é’ˆï¼Œæ–°åˆ†é…çš„å¯¹è±¡å¿…é¡»ä½äºè¿™ä¸¤ä¸ªæŒ‡é’ˆä½ç½®ä»¥ä¸Šï¼Œä½äºè¿™ä¸¤ä¸ªæŒ‡é’ˆä½ç½®ä»¥ä¸Šçš„å¯¹è±¡é»˜è®¤è¢«éšå¼æ ‡è®°ä¸ºå­˜æ´»çš„ï¼Œä¸ä¼šçº³å…¥å›æ”¶èŒƒå›´ï¼›
2. **å¹¶å‘æ ‡è®° (Concurrent Marking)**ï¼šä» `GC Roots` èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾ã€‚éå†å®Œæˆåï¼Œè¿˜éœ€è¦å¤„ç† SATB  è®°å½•ä¸­å˜åŠ¨çš„å¯¹è±¡ã€‚SATBï¼ˆsnapshot-at-the-beginningï¼Œå¼€å§‹é˜¶æ®µå¿«ç…§ï¼‰èƒ½å¤Ÿæœ‰æ•ˆçš„è§£å†³å¹¶å‘æ ‡è®°é˜¶æ®µå› ä¸ºç”¨æˆ·çº¿ç¨‹è¿è¡Œè€Œå¯¼è‡´çš„å¯¹è±¡å˜åŠ¨ï¼Œå…¶æ•ˆç‡æ¯” CMS é‡æ–°æ ‡è®°é˜¶æ®µæ‰€ä½¿ç”¨çš„å¢é‡æ›´æ–°ç®—æ³•æ•ˆç‡æ›´é«˜ï¼›
3. **æœ€ç»ˆæ ‡è®° (Final Marking)**ï¼šå¯¹ç”¨æˆ·çº¿ç¨‹åšä¸€ä¸ªçŸ­æš‚çš„æš‚åœï¼Œç”¨äºå¤„ç†å¹¶å‘é˜¶æ®µç»“æŸåä»é—ç•™ä¸‹æ¥çš„å°‘é‡çš„ STAB è®°å½•ã€‚è™½ç„¶å¹¶å‘æ ‡è®°é˜¶æ®µä¼šå¤„ç† SATB è®°å½•ï¼Œä½†ç”±äºå¤„ç†æ—¶ç”¨æˆ·çº¿ç¨‹ä¾ç„¶æ˜¯è¿è¡Œä¸­çš„ï¼Œå› æ­¤ä¾ç„¶ä¼šæœ‰å°‘é‡çš„å˜åŠ¨ï¼Œæ‰€ä»¥éœ€è¦æœ€ç»ˆæ ‡è®°æ¥å¤„ç†ï¼›
4. **ç­›é€‰å›æ”¶ (Live Data Counting and Evacuation)**ï¼šè´Ÿè´£æ›´æ–° Regin ç»Ÿè®¡æ•°æ®ï¼ŒæŒ‰ç…§å„ä¸ª Regin çš„å›æ”¶ä»·å€¼å’Œæˆæœ¬è¿›è¡Œæ’åºï¼Œåœ¨æ ¹æ®ç”¨æˆ·æœŸæœ›çš„åœé¡¿æ—¶é—´è¿›è¡Œæ¥æŒ‡å®šå›æ”¶è®¡åˆ’ï¼Œå¯ä»¥é€‰æ‹©ä»»æ„å¤šä¸ª Regin æ„æˆå›æ”¶é›†ã€‚ç„¶åå°†å›æ”¶é›†ä¸­ Regin çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ç©ºçš„ Regin ä¸­ï¼Œå†æ¸…ç†æ‰æ•´ä¸ªæ—§çš„ Regin  ã€‚æ­¤æ—¶å› ä¸ºæ¶‰åŠåˆ°å­˜æ´»å¯¹è±¡çš„ç§»åŠ¨ï¼Œæ‰€ä»¥éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œå¹¶ç”±å¤šä¸ªæ”¶é›†çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚

![image-20220628152953093](./images/image-20220628152953093.png)

#### ZGC æ”¶é›†å™¨

ä¸ CMS ä¸­çš„ ParNew å’Œ G1 ç±»ä¼¼ï¼ŒZGC ä¹Ÿé‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œä¸è¿‡ ZGC å¯¹è¯¥ç®—æ³•åšäº†é‡å¤§æ”¹è¿›ã€‚

åœ¨ ZGC ä¸­å‡ºç° Stop The World çš„æƒ…å†µä¼šæ›´å°‘ï¼

> æ‹“å±•

![image-20220612165223576](./images/image-20220612165223576.png)

- ä¸¤ä¸ªæ”¶é›†å™¨é—´æœ‰è¿çº¿ï¼Œè¡¨æ˜å®ƒä»¬å¯ä»¥æ­é…ä½¿ç”¨ï¼šSerial/Serial Oldã€Serial/CMSã€ParNew/Serial  Oldã€ParNew/CMSã€Parallel Scavenge/Serial Oldã€Parallel Scavenge/Parallel  Oldã€G1ã€‚
- å…¶ä¸­ Serial Old ä½œä¸º CMS å‡ºç°"Concurrent Mode Failure"å¤±è´¥çš„åå¤‡é¢„æ¡ˆã€‚
- **ï¼ˆçº¢è‰²è™šçº¿ï¼‰**ç”±äºç»´æŠ¤å’Œå…¼å®¹æ€§æµ‹è¯•çš„æˆæœ¬ï¼Œåœ¨ JDK 8 æ—¶å°† Serial + CMSã€ParNew + Serial Old è¿™ä¸¤ä¸ªç»„åˆå£°æ˜ä¸ºåºŸå¼ƒï¼ˆJEP173ï¼‰ï¼Œå¹¶åœ¨ JDK 9 ä¸­å®Œå…¨å–æ¶ˆäº†è¿™äº›ç»„åˆçš„æ”¯æŒï¼ˆJEP214ï¼‰ï¼Œå³ï¼šç§»é™¤ã€‚
- **ï¼ˆç»¿è‰²è™šçº¿ï¼‰**JDK 14 ä¸­ï¼šå¼ƒç”¨ Parallel Scavenge å’Œ Serialold GC ç»„åˆï¼ˆJEP366ï¼‰ã€‚
- **ï¼ˆé’è‰²è™šçº¿ï¼‰**JDK 14 ä¸­ï¼šåˆ é™¤ CMS åƒåœ¾å›æ”¶å™¨ï¼ˆJEP363ï¼‰ã€‚

### Minor Gc å’Œ Full GC æœ‰ä»€ä¹ˆä¸åŒå‘¢

æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinor GC / Young GCï¼‰ï¼šåªå¯¹æ–°ç”Ÿä»£è¿›è¡Œåƒåœ¾æ”¶é›†

æ•´å †æ”¶é›† (Full GC)ï¼šæ”¶é›†æ•´ä¸ª Java å †å’Œæ–¹æ³•åŒº

> æ‹“å±•1ï¼šæœ‰å“ªäº›å¸¸è§çš„ GCï¼Ÿ

é’ˆå¯¹ HotSpot VM çš„å®ç°ï¼Œå®ƒé‡Œé¢çš„ GC å…¶å®å‡†ç¡®åˆ†ç±»åªæœ‰ä¸¤å¤§ç§ï¼š

éƒ¨åˆ†æ”¶é›† (Partial GC)ï¼š

- æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinor GC / Young GCï¼‰ï¼šåªå¯¹æ–°ç”Ÿä»£è¿›è¡Œåƒåœ¾æ”¶é›†ï¼›
- è€å¹´ä»£æ”¶é›†ï¼ˆMajor GC / Old GCï¼‰ï¼šåªå¯¹è€å¹´ä»£è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ Major GC åœ¨æœ‰çš„è¯­å¢ƒä¸­ä¹Ÿç”¨äºæŒ‡ä»£æ•´å †æ”¶é›†ï¼›
- æ··åˆæ”¶é›†ï¼ˆMixed GCï¼‰ï¼šå¯¹æ•´ä¸ªæ–°ç”Ÿä»£å’Œéƒ¨åˆ†è€å¹´ä»£è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚

æ•´å †æ”¶é›† (Full GC)ï¼šæ”¶é›†æ•´ä¸ª Java å †å’Œæ–¹æ³•åŒºã€‚

> æ‹“å±•2ï¼šè°ˆè°ˆä½ å¯¹ Minor GCã€è¿˜æœ‰ Full GC çš„ç†è§£ã€‚Minor GC ä¸ Full GC åˆ†åˆ«åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿ Minor GC ä¼šå‘ç”Ÿ STW(stop the world) ç°è±¡å—ï¼Ÿ

 **Minor GC**

* å½“å¹´è½»ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šè§¦å‘Minor GCï¼Œè¿™é‡Œçš„å¹´è½»ä»£æ»¡æŒ‡çš„æ˜¯ `EdenåŒºæ»¡`ï¼ŒSurvivoråŒºæ»¡ä¸ä¼šè§¦å‘GCã€‚ï¼ˆæ¯æ¬¡Minor GCä¼šæ¸…ç†å¹´è½»ä»£çš„å†…å­˜ï¼‰
* å› ä¸ºJavaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡æœç”Ÿå¤•ç­çš„ç‰¹æ€§ï¼Œæ‰€ä»¥**Minor GCéå¸¸é¢‘ç¹**ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚è¿™ä¸€å®šä¹‰æ—¢æ¸…æ™°åˆæ˜“äºç†è§£ã€‚
* Minor GCä¼šå¼•å‘ `STW`ï¼Œ`æš‚åœå…¶å®ƒç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰å¾…åƒåœ¾å›æ”¶çº¿ç¨‹ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œ`

**Major GC**

* æŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„GCï¼Œå¯¹è±¡ä»è€å¹´ä»£æ¶ˆå¤±æ—¶ï¼Œæˆ‘ä»¬è¯´ â€œMajor Gcâ€ æˆ– â€œFull GCâ€ å‘ç”Ÿäº†
* å‡ºç°äº†MajorGcï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GC
  * ä½†éç»å¯¹çš„ï¼Œåœ¨Parallel Scavengeæ”¶é›†å™¨çš„æ”¶é›†ç­–ç•¥é‡Œå°±æœ‰ç›´æ¥è¿›è¡ŒMajor GCçš„ç­–ç•¥é€‰æ‹©è¿‡ç¨‹
  * ä¹Ÿå°±æ˜¯åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šå…ˆå°è¯•è§¦å‘Minor GCï¼Œå¦‚æœä¹‹åç©ºé—´è¿˜ä¸è¶³ï¼Œåˆ™è§¦å‘Major GC
* **Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Š**ï¼ŒSTWçš„æ—¶é—´æ›´é•¿
* å¦‚æœMajor GCåï¼Œå†…å­˜è¿˜ä¸è¶³ï¼Œå°±æŠ¥OOMäº†

**Full GC**

* è°ƒç”¨System.gc( )æ—¶ï¼Œç³»ç»Ÿå»ºè®®æ‰§è¡ŒFull GCï¼Œä½†æ˜¯ä¸å¿…ç„¶æ‰§è¡Œ
* è€å¹´ä»£ç©ºé—´ä¸è¶³
* æ–¹æ³•åŒºç©ºé—´ä¸è¶³
* **é€šè¿‡Minor GCåè¿›å…¥è€å¹´ä»£çš„å¹³å‡å¤§å° å¤§äº è€å¹´ä»£çš„å¯ç”¨å†…å­˜**
* ç”±EdenåŒºã€survivor space0ï¼ˆFrom Spaceï¼‰åŒº å‘survivor space1ï¼ˆTo Spaceï¼‰åŒºå¤åˆ¶æ—¶ï¼Œå¯¹è±¡å¤§å°å¤§äºTo Spaceå¯ç”¨å†…å­˜ï¼Œåˆ™æŠŠè¯¥å¯¹è±¡è½¬å­˜åˆ°è€å¹´ä»£ï¼Œä¸”è€å¹´ä»£çš„å¯ç”¨å†…å­˜ å°äº è¯¥å¯¹è±¡å¤§å°

### â­ï¸å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹

#### æ¦‚è¿°

é¦–å…ˆåœ¨æ–‡ä»¶å†…åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡

```java
public class VM {
}
```

å†éšä¾¿newä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå°±å¯ä»¥çœ‹åˆ°å®ƒçš„å­—èŠ‚ç 

```java
public class newObject {

    public static void main(String[] args) {
        VM vm = new VM();
    }
}
```

```java
0 new #2 <cn/zhiyucs/test/VM>
3 dup
4 invokespecial #3 <cn/zhiyucs/test/VM.<init> : ()V>
7 astore_1
8 return
```

**newæŒ‡ä»¤**ç›¸å½“äºå»å¯¹åº”çš„å†…å­˜ç©ºé—´ç”³è¯·ä¸€å—å†…å­˜å¤§å° ç”¨äºå­˜æ”¾å¯¹è±¡æ•°æ® å¯¹è±¡çš„å¤§å°æ˜¯å¯ä»¥ç¡®å®šçš„ æ¯”å¦‚intå ç”¨4ä¸ªå­—èŠ‚ å¼•ç”¨ä¹Ÿå ç”¨4ä¸ªå­—èŠ‚ æ‰€ä»¥è¿™ä¸ªæ—¶å€™ç”³è¯·çš„å†…å­˜ç©ºé—´å¤§å°æ˜¯å›ºå®šçš„

**dup**ç›¸å½“äºå°†å¯¹åº”çš„å†…å­˜åœ°å€çš„å¼•ç”¨å¤åˆ¶äº†ä¸€ä»½å‹åˆ°æ ˆä¸­,é‚£ä¹ˆå¯¹åº”æ ˆä¸­ä¼šæœ‰2ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™2ä¸ªå¯¹è±¡çš„å¼•ç”¨ä¸€ä¸ªç”¨äºæ“ä½œå¯¹è±¡èµ‹å€¼ï¼Œä¸€ä¸ªç”¨äºå¯¹è±¡çš„æ–¹æ³•è°ƒç”¨

**invokespecialæŒ‡ä»¤**æ˜¯è°ƒç”¨å¯¹è±¡çš„æ„é€ å™¨åˆå§‹åŒ–å¯¹è±¡ æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯é»˜è®¤æ„é€ å™¨ ç©ºå‚æ„é€  ä¸€èˆ¬ç”¨äºåˆå§‹åŒ–å¯¹è±¡æ•°æ®ï¼Œåœ¨ `new`çš„æ—¶å€™JVMä¼šç»™å¯¹è±¡çš„å…¨å±€å˜é‡èµ‹é»˜è®¤å€¼

**astoreæŒ‡ä»¤**å°±æ˜¯å°†å¯¹åº”å¯¹è±¡çš„å¼•ç”¨å­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­

#### ä»JVMå±‚é¢åˆ†æ

##### 1ï¸âƒ£ç±»åŠ è½½

å…·ä½“æ¥è¯´ï¼Œå½“ Java è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡å­—èŠ‚ç  new æŒ‡ä»¤æ—¶ï¼š

1ï¼‰é¦–å…ˆæ£€æŸ¥æ ¹æ® class æ–‡ä»¶ä¸­çš„å¸¸é‡æ± è¡¨ï¼ˆConstant Pool Tableï¼‰èƒ½å¦æ‰¾åˆ°è¿™ä¸ªç±»å¯¹åº”çš„ç¬¦å·å¼•ç”¨

> æ­¤å¤„å¯ä»¥å›é¡¾ä¸€æ³¢**å¸¸é‡æ± è¡¨ (Constant Pool Table)** çš„æ¦‚å¿µï¼š
>
> ç”¨äºå­˜æ”¾**ç¼–è¯‘æœŸ**ç”Ÿæˆçš„å„ç§å­—é¢é‡ï¼ˆå­—é¢é‡ç›¸å½“äº Java è¯­è¨€å±‚é¢å¸¸é‡çš„æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå£°æ˜ä¸º final çš„å¸¸é‡å€¼ç­‰ï¼‰ä¸ç¬¦å·å¼•ç”¨ã€‚æœ‰ä¸€äº›æ–‡ç« ä¼šæŠŠ class å¸¸é‡æ± è¡¨ç§°ä¸º**é™æ€å¸¸é‡æ± **ã€‚
>
> éƒ½æ˜¯å¸¸é‡æ± ï¼Œå¸¸é‡æ± è¡¨å’Œæ–¹æ³•åŒºä¸­çš„è¿è¡Œæ—¶å¸¸é‡æ± æœ‰å•¥å…³ç³»å—ï¼Ÿè¿è¡Œæ—¶å¸¸é‡æ± æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿ
>
> **è¿è¡Œæ—¶å¸¸é‡æ± å¯ä»¥åœ¨è¿è¡ŒæœŸé—´å°† class å¸¸é‡æ± è¡¨ä¸­çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨**ã€‚ç®€å•æ¥è¯´ï¼Œclass å¸¸é‡æ± è¡¨å°±ç›¸å½“äºä¸€å †ç´¢å¼•ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± æ ¹æ®è¿™äº›ç´¢å¼•æ¥æŸ¥æ‰¾å¯¹åº”æ–¹æ³•æˆ–å­—æ®µæ‰€å±çš„ç±»å‹ä¿¡æ¯å’Œåç§°åŠæè¿°ç¬¦ä¿¡æ¯

2ï¼‰ç„¶åå»æ–¹æ³•åŒºä¸­çš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­æŸ¥æ‰¾è¯¥ç¬¦å·å¼•ç”¨æ‰€æŒ‡å‘çš„ç±»æ˜¯å¦å·²è¢« JVM åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–è¿‡

- å¦‚æœæ²¡æœ‰ï¼Œé‚£å°±å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹
- å¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¿›å…¥ä¸‹ä¸€æ­¥ï¼Œä¸ºæ–°ç”Ÿå¯¹è±¡åˆ†é…å†…å­˜

##### 2ï¸âƒ£åˆ†é…å†…å­˜ï¼ˆå¯¹è±¡åœ¨å †ä¸Šåˆ†é…çš„ä¸¤ç§æ–¹å¼ï¼‰

æ ¹æ®å †ä¸­çš„å†…å­˜æ˜¯å¦è§„æ•´ï¼Œæœ‰ä¸¤ç§åˆ’åˆ†æ–¹å¼ï¼Œæˆ–è€…è¯´å¯¹è±¡åœ¨å †ä¸Šçš„åˆ†é…æœ‰ä¸¤ç§æ–¹å¼ï¼š

1ï¼‰**å‡è®¾ Java å †ä¸­å†…å­˜æ˜¯ç»å¯¹è§„æ•´çš„**ï¼Œæ‰€æœ‰è¢«ä½¿ç”¨è¿‡çš„å†…å­˜éƒ½è¢«æ”¾åœ¨ä¸€è¾¹ï¼Œç©ºé—²çš„å†…å­˜è¢«æ”¾åœ¨å¦ä¸€è¾¹ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œé‚£æ‰€åˆ†é…å†…å­˜å°±ä»…ä»…æ˜¯æŠŠè¿™ä¸ªæŒ‡é’ˆ å‘ ç©ºé—²ç©ºé—´æ–¹å‘ æŒªåŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»ï¼Œè¿™ç§åˆ†é…æ–¹å¼ç§°ä¸º **æŒ‡é’ˆç¢°æ’**ï¼ˆBump The Pointerï¼‰

![image-20220628113523166](./images/image-20220628113523166.png)

2ï¼‰**å¦‚æœ Java å †ä¸­çš„å†…å­˜å¹¶ä¸æ˜¯è§„æ•´çš„**ï¼Œå·²è¢«ä½¿ç”¨çš„å†…å­˜å’Œç©ºé—²çš„å†…å­˜ç›¸äº’äº¤é”™åœ¨ä¸€èµ·ï¼Œé‚£å°±æ²¡æœ‰åŠæ³•ç®€å•åœ°è¿›è¡ŒæŒ‡é’ˆç¢°æ’äº†ï¼Œè™šæ‹Ÿæœºå°±å¿…é¡»ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½•å“ªäº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œåœ¨åˆ†é…çš„æ—¶å€™ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´åˆ’åˆ†ç»™è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„è®°å½•ï¼Œè¿™ç§åˆ†é…æ–¹å¼ç§°ä¸º **ç©ºé—²åˆ—è¡¨**ï¼ˆFree Listï¼‰ã€‚

> é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”± Java å †æ˜¯å¦è§„æ•´å†³å®šï¼Œé‚£åˆæœ‰åŒå­¦ä¼šé—®äº†ï¼Œå †æ˜¯å¦è§„æ•´åˆç”±è°æ¥å†³å®šå‘¢ï¼Ÿ
>
> Java å †æ˜¯å¦è§„æ•´ç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰ç©ºé—´å‹ç¼©æ•´ç†ï¼ˆCompactï¼‰çš„èƒ½åŠ›å†³å®šçš„ï¼ˆæˆ–è€…è¯´ç”±åƒåœ¾æ”¶é›†å™¨é‡‡ç”¨çš„åƒåœ¾æ”¶é›†ç®—æ³•æ¥å†³å®šçš„ï¼Œå…·ä½“åƒåœ¾æ”¶é›†ç®—æ³•è§åç»­æ–‡ç« ï¼‰ï¼š
>
> - å› æ­¤ï¼Œå½“ä½¿ç”¨ Serialã€ParNew ç­‰å¸¦å‹ç¼©æ•´ç†è¿‡ç¨‹çš„æ”¶é›†å™¨æ—¶ï¼Œç³»ç»Ÿé‡‡ç”¨çš„åˆ†é…ç®—æ³•æ˜¯æŒ‡é’ˆç¢°æ’ï¼Œæ—¢ç®€å•åˆé«˜æ•ˆ
> - è€Œå½“ä½¿ç”¨ CMS è¿™ç§åŸºäºæ¸…é™¤ï¼ˆSweepï¼‰ç®—æ³•çš„æ”¶é›†å™¨æ—¶ï¼Œç†è®ºä¸Šå°±åªèƒ½é‡‡ç”¨è¾ƒä¸ºå¤æ‚çš„ç©ºé—²åˆ—è¡¨æ¥åˆ†é…å†…å­˜

![image-20220628113934143](./images/image-20220628113934143.png)

##### 3ï¸âƒ£åˆå§‹åŒ–é›¶å€¼

ä¸¾ä¸ªğŸŒ°

```java
public class VM  {

    private int value = 100;
    private Object data;

}
```

æ¯”å¦‚æˆ‘ä»¬å¯¹è±¡ä¸­ å®šä¹‰äº† `value`å’Œ `data`

JVMä¸ºäº†å®ç°æˆ‘ä»¬ä¸åšèµ‹å€¼æ“ä½œçš„å¯¹è±¡ä¹Ÿå¯ä»¥æ‹¿æ¥ç›´æ¥ä½¿ç”¨åœ¨ç”³è¯·ç©ºé—´çš„ä¼šç»™å¯¹è±¡èµ‹å€¼ä¸º `null`ï¼Œ**åŸºæœ¬æ•°æ®ç±»å‹ä¼šèµ‹å€¼ä¸ºé»˜è®¤å€¼,å¼•ç”¨æ•°æ®ä¸ºèµ‹å€¼ä¸ºnull**

æ¯”å¦‚ä¸Šé¢ä»£ç  `value`ä¼šèµ‹å€¼ä¸º `0` ,`data`ä¼šèµ‹å€¼ä¸º `null` ,è¿™é‡Œæ˜¯èµ‹ä¸ºé»˜è®¤å€¼ï¼Œä¸æ˜¯èµ‹å€¼

è¿™æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨ Java ä»£ç ä¸­å¯ä»¥ä¸èµ‹åˆå§‹å€¼å°±ç›´æ¥ä½¿ç”¨ï¼Œä½¿ç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼ã€‚

> å¦‚æœä½¿ç”¨äº† TLAB çš„è¯ï¼Œåˆå§‹åŒ–é›¶å€¼è¿™é¡¹å·¥ä½œå¯ä»¥æå‰è‡³ TLAB åˆ†é…æ—¶å°±é¡ºä¾¿è¿›è¡Œäº†

##### 4ï¸âƒ£è®¾ç½®å¯¹è±¡å¤´

å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å¯ä»¥åˆ†ä¸º 3 å—åŒºåŸŸï¼šå¯¹è±¡å¤´ï¼ˆObject Headerï¼‰ã€å®ä¾‹æ•°æ®å’Œå¯¹é½å¡«å……

å¯¹é½å¡«å……å¹¶ä¸æ˜¯ä»€ä¹ˆæœ‰æ„ä¹‰çš„æ•°æ®ï¼Œå®ä¾‹æ•°æ®æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥æ“ä½œä¸­è¿›è¡Œäº†åˆå§‹åŒ–é›¶å€¼ï¼Œé‚£ä¹ˆå¯¹äºå‰©ä¸‹çš„å¯¹è±¡å¤´ä¸­çš„ä¿¡æ¯æ¥è¯´ï¼Œè‡ªç„¶ä¸å¿…å¤šè¯´ï¼Œä¹Ÿæ˜¯è¦è¿›è¡Œä¸€äº›èµ‹å€¼æ“ä½œçš„ï¼šä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ã€å¯¹è±¡çš„å“ˆå¸Œç ã€å¯¹è±¡çš„ GC åˆ†ä»£å¹´é¾„ç­‰ä¿¡æ¯ã€‚æ ¹æ®è™šæ‹Ÿæœºå½“å‰è¿è¡ŒçŠ¶æ€çš„ä¸åŒï¼Œå¦‚æ˜¯å¦å¯ç”¨åå‘é”ç­‰ï¼Œå¯¹è±¡å¤´ä¼šæœ‰ä¸åŒçš„è®¾ç½®æ–¹å¼ã€‚

> å¯¹è±¡å¤´

![image-20220628152051756](./images/image-20220628152051756.png)

##### 5ï¸âƒ£æ‰§è¡Œinit

ä¸Šé¢å››ä¸ªæ­¥éª¤éƒ½èµ°å®Œä¹‹åï¼Œä» JVM çš„è§†è§’æ¥çœ‹ï¼Œå…¶å®ä¸€ä¸ªæ–°çš„å¯¹è±¡å·²ç»æˆåŠŸè¯ç”Ÿäº†ã€‚

ä½†æ˜¯ä»æˆ‘ä»¬ç¨‹åºå‘˜çš„è§†è§’æ¥çœ‹ï¼Œè¿™ä¸ªå¯¹è±¡ç¡®å®æ˜¯åˆ›å»ºå‡ºæ¥äº†ï¼Œä½†æ˜¯è¿˜æ²¡æŒ‰ç…§æˆ‘ä»¬å®šä¹‰çš„æ„é€ å‡½æ•°æ¥è¿›è¡Œèµ‹å€¼å‘¢ï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½è¿˜æ˜¯é»˜è®¤çš„é›¶å€¼å•Šã€‚

æ„é€ å‡½æ•°å³ Class æ–‡ä»¶ä¸­çš„ `<init>()` æ–¹æ³•ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œnew æŒ‡ä»¤ä¹‹åä¼šæ¥ç€æ‰§è¡Œ `<init>()` æ–¹æ³•ï¼ŒæŒ‰ç…§æ„é€ å‡½æ•°çš„æ„å›¾å¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡æ‰ç®—å®Œå…¨åœ°è¢«æ„é€ å‡ºæ¥äº†

ä¸¾ä¸ªğŸŒ°ï¼Œä¸Šè¿°ä»£ç ç¼–è¯‘æˆå­—èŠ‚ç ä¹‹å

```java
 0 aload_0
 1 invokespecial #1 <java/lang/Object.<init> : ()V>
 4 aload_0
 5 bipush 100
 7 putfield #2 <cn/zhiyucs/test/VM.value : I>
 10 return
```

##### ğŸ¤æ€»è§ˆ

![image-20220628151926533](./images/image-20220628151926533.png)

> å¯¹è±¡åˆ›å»ºæ—¶å€™çš„å¹¶å‘å®‰å…¨é—®é¢˜

å¦å¤–ï¼Œåœ¨ä¸ºå¯¹è±¡åˆ›å»ºå†…å­˜çš„æ—¶å€™ï¼Œè¿˜éœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼š**å¹¶å‘å®‰å…¨é—®é¢˜**ã€‚

å¯¹è±¡åˆ›å»ºåœ¨è™šæ‹Ÿæœºä¸­æ˜¯éå¸¸é¢‘ç¹çš„è¡Œä¸ºï¼Œä»¥ä¸Šé¢ä»‹ç»çš„æŒ‡é’ˆç¢°æ’æ³•ä¸ºä¾‹ï¼Œå³ä½¿åªä¿®æ”¹ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„ä½ç½®ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ä¹Ÿå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½å‡ºç°æŸä¸ªçº¿ç¨‹æ­£åœ¨ç»™å¯¹è±¡ A åˆ†é…å†…å­˜ï¼ŒæŒ‡é’ˆè¿˜æ²¡æ¥å¾—åŠä¿®æ”¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºäº†å¯¹è±¡ B åˆåŒæ—¶ä½¿ç”¨äº†åŸæ¥çš„æŒ‡é’ˆæ¥åˆ†é…å†…å­˜çš„æƒ…å†µã€‚

è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§å¯é€‰æ–¹æ¡ˆï¼š

- æ–¹æ¡ˆ 1ï¼š**CAS + å¤±è´¥é‡è¯•**ï¼šCAS å¤§ä¼™åº”è¯¥éƒ½ç†Ÿæ‚‰ï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼Œä¹è§‚é”æ–¹æ¡ˆï¼Œå¦‚æœå¤±è´¥å°±é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢
- æ–¹æ¡ˆ 2ï¼š**æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²**ï¼ˆThread Local Allocation Bufferï¼Œ`TLAB`ï¼‰ï¼šæ¯ä¸ªçº¿ç¨‹åœ¨å †ä¸­é¢„å…ˆåˆ†é…ä¸€å°å—å†…å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰çš„è¿™ä¸€å°å—å†…å­˜å°±ç§°ä¸º TLABã€‚å“ªä¸ªçº¿ç¨‹è¦åˆ†é…å†…å­˜äº†ï¼Œå°±åœ¨å“ªä¸ªçº¿ç¨‹çš„ TLAB ä¸­è¿›è¡Œåˆ†é…ï¼Œè¿™æ ·å„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ä¸å¹²æ‰°ã€‚å¦‚æœæŸä¸ªçº¿ç¨‹çš„ TLAB  ç”¨å®Œäº†ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±éœ€è¦ä¸ºå®ƒåˆ†é…æ–°çš„ TLABï¼Œè¿™æ—¶æ‰éœ€è¦è¿›è¡ŒåŒæ­¥é”å®šã€‚å¯ä»¥é€šè¿‡ `-XXï¼š+/-UseTLAB` å‚æ•°æ¥è®¾å®šæ˜¯å¦ä½¿ç”¨ TLABã€‚

### å¯¹è±¡è®¿é—®æ–¹å¼

æˆ–æ˜¯è¿™æ ·é—®ä½ ï¼šğŸ‘©â€ğŸ’»å¯¹è±¡çš„è®¿é—®å®šä½çš„ä¸¤ç§æ–¹å¼çŸ¥é“å—ï¼Ÿå„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹

#### å¥æŸ„æ± 

å¦‚æœä½¿ç”¨å¥æŸ„çš„è¯ï¼Œé‚£ä¹ˆJavaå †ä¸­å°†ä¼šåˆ’åˆ†å‡ºä¸€å—å†…å­˜æ¥ä½œä¸ºå¥æŸ„æ± ï¼Œreference ä¸­å­˜å‚¨çš„å°±æ˜¯å¯¹è±¡çš„å¥æŸ„åœ°å€ï¼Œè€Œå¥æŸ„ä¸­åŒ…å«äº†å¯¹è±¡å®ä¾‹æ•°æ®ä¸ç±»å‹æ•°æ®å„è‡ªçš„å…·ä½“åœ°å€ä¿¡æ¯

![image-20220628152456384](./images/image-20220628152456384.png)

ç¼ºç‚¹ æ˜¾ç„¶è€Œè§ éœ€è¦å•ç‹¬å¼€è¾Ÿä¸€å—ç©ºé—´è®°å½•å¥æŸ„æ± å­˜å‚¨,å¹¶ä¸”è®¿é—®çš„æ—¶å€™éœ€è¦ä¸­è½¬ è®¿é—®æ•ˆç‡åä½ä¸€ç‚¹

ä¼˜ç‚¹ å½“å¯¹è±¡æ•°æ®å˜æ›´çš„æ—¶å€™æ¯”å¦‚åƒåœ¾å›æ”¶å™¨ éœ€è¦æ•´ç†å¯¹è±¡ éœ€è¦ç§»åŠ¨å¤åˆ¶ï¼ŒStackæ ˆç©ºé—´ä¸­çš„å¼•ç”¨ æ˜¯ä¸éœ€è¦ä¿®æ”¹çš„ åªéœ€è¦ä¿®æ”¹å¥æŸ„æ± ä¸­çš„å¼•ç”¨

#### ç›´æ¥å¼•ç”¨

å¦‚æœä½¿ç”¨ç›´æ¥æŒ‡é’ˆè®¿é—®ï¼Œé‚£ä¹ˆ Java å †å¯¹è±¡çš„å¸ƒå±€ä¸­å°±å¿…é¡»è€ƒè™‘å¦‚ä½•æ”¾ç½®è®¿é—®ç±»å‹æ•°æ®çš„ç›¸å…³ä¿¡æ¯ï¼Œè€Œreference ä¸­å­˜å‚¨çš„ç›´æ¥å°±æ˜¯å¯¹è±¡çš„åœ°å€ã€‚

![image-20220628152505040](./images/image-20220628152505040.png)

ç¼ºç‚¹ å½“å¯¹è±¡æ•°æ®å˜æ›´å¼•ç”¨çš„æ—¶å€™ éœ€è¦ä¿®æ”¹Stackçš„æŒ‡é’ˆ

ä¼˜ç‚¹ ä¸éœ€è¦é¢å¤–çš„å¼€è¾Ÿä¸€å—ç©ºé—´å­˜å‚¨å¼•ç”¨ï¼Œåœ¨åŸæœ‰å¯¹è±¡å¤´ä¸­æ·»åŠ æŒ‡é’ˆæŒ‡å‘å³å¯ï¼Œè®¿é—®å¯¹è±¡å®ä½“æ•°æ®çš„æ—¶å€™æ•ˆç‡é«˜

### å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºå„ä»£è¡¨ä»€ä¹ˆï¼Ÿ

> æœ¬èŠ‚å†…å®¹æ‘˜è‡ªå‘¨å¿—æ˜è€å¸ˆçš„ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹å†…å®¹

#### OopMap

ç”±äºç›®å‰ä¸»æµJavaè™šæ‹Ÿæœºä½¿ç”¨çš„éƒ½æ˜¯å‡†ç¡®å¼åƒåœ¾æ”¶é›†ï¼ˆè¿™ä¸ªæ¦‚å¿µåœ¨ç¬¬1ç« ä»‹ç»Exact VMç›¸å¯¹äºClassic VMçš„æ”¹è¿›æ—¶ä»‹ç»è¿‡ï¼‰ï¼Œæ‰€ä»¥å½“ç”¨æˆ·çº¿ç¨‹åœé¡¿ä¸‹æ¥ä¹‹åï¼Œå…¶å®å¹¶ä¸éœ€è¦ä¸€ä¸ªä¸æ¼åœ°æ£€æŸ¥å®Œæ‰€æœ‰æ‰§è¡Œä¸Šä¸‹æ–‡å’Œå…¨å±€çš„å¼•ç”¨ä½ç½®ï¼Œè™šæ‹Ÿæœºåº”å½“æ˜¯æœ‰åŠæ³•ç›´æ¥å¾—åˆ°å“ªäº›åœ°æ–¹å­˜æ”¾ç€å¯¹è±¡å¼•ç”¨çš„ã€‚åœ¨HotSpotçš„è§£å†³æ–¹æ¡ˆé‡Œï¼Œæ˜¯ä½¿ç”¨ä¸€ç»„ç§°ä¸ºOopMapï¼ˆOopæ˜¯æ™®é€šå¯¹è±¡æŒ‡é’ˆçš„æ„æ€ï¼šordinary object pointerï¼‰çš„æ•°æ®ç»“æ„æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚ä¸€æ—¦ç±»åŠ è½½åŠ¨ä½œå®Œæˆçš„æ—¶å€™ï¼ŒHotSpotå°±ä¼šæŠŠå¯¹è±¡å†…ä»€ä¹ˆåç§»é‡ä¸Šæ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®è®¡ç®—å‡ºæ¥ï¼Œåœ¨å³æ—¶ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šåœ¨ç‰¹å®šçš„ä½ç½®è®°å½•ä¸‹æ ˆé‡Œå’Œå¯„å­˜å™¨é‡Œå“ªäº›ä½ç½®æ˜¯å¼•ç”¨ã€‚è¿™æ ·æ”¶é›†å™¨åœ¨æ‰«ææ—¶å°±å¯ä»¥ç›´æ¥å¾—çŸ¥è¿™äº›ä¿¡æ¯äº†ï¼Œå¹¶ä¸éœ€è¦çœŸæ­£ä¸€ä¸ªä¸æ¼åœ°ä»æ–¹æ³•åŒºç­‰GC Rootså¼€å§‹æŸ¥æ‰¾ã€‚å› æ­¤ï¼Œåœ¨ HotSpot ä¸­é‡‡å–äº†ç©ºé—´æ¢æ—¶é—´çš„æ–¹æ³•ï¼Œä½¿ç”¨ OopMap æ¥å­˜å‚¨æ ˆä¸Šçš„å¯¹è±¡å¼•ç”¨çš„ä¿¡æ¯ã€‚

åœ¨ GC Roots æšä¸¾æ—¶ï¼Œåªéœ€è¦éå†æ¯ä¸ªæ ˆæ¡¢çš„ OopMapï¼Œé€šè¿‡ OopMap å­˜å‚¨çš„ä¿¡æ¯ï¼Œå¿«æ·åœ°æ‰¾åˆ° GC Rootsã€‚

OopMap ä¸­å­˜å‚¨äº†ä¸¤ç§å¯¹è±¡çš„å¼•ç”¨ï¼š

> â—‰ æ ˆé‡Œå’Œå¯„å­˜å™¨å†…çš„å¼•ç”¨
> åœ¨å³æ—¶ç¼–è¯‘ä¸­ï¼Œåœ¨ç‰¹å®šçš„ä½ç½®è®°å½•ä¸‹æ ˆé‡Œå’Œå¯„å­˜å™¨é‡Œå“ªäº›ä½ç½®æ˜¯å¼•ç”¨
>  
> â—‰ å¯¹è±¡å†…çš„å¼•ç”¨
> ç±»åŠ è½½åŠ¨ä½œå®Œæˆæ—¶ï¼ŒHotSpot å°±ä¼šè®¡ç®—å‡ºå¯¹è±¡å†…ä»€ä¹ˆåç§»é‡ä¸Šæ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®
> æ³¨ï¼šæŠŠå­˜å‚¨å•å…ƒçš„å®é™…åœ°å€ä¸å…¶æ‰€åœ¨æ®µçš„æ®µåœ°å€ä¹‹é—´çš„è·ç¦»ç§°ä¸ºæ®µå†…åç§»ï¼Œä¹Ÿç§°ä¸ºæœ‰æ•ˆåœ°å€æˆ–åç§»é‡ï¼Œå› æ­¤ï¼Œå®é™…åœ°å€=æ‰€åœ¨æ®µçš„èµ·å§‹åœ°å€+åç§»é‡

åœ¨ JVMä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸ºä¸€ä¸ªæ ˆï¼Œä¸€ä¸ªæ ˆç”±å¤šä¸ªæ ˆæ¡¢ç»„æˆï¼Œä¸€ä¸ªæ ˆæ¡¢å¯¹åº”ä¸€ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ ˆå¸§å¯èƒ½æœ‰å¤šä¸ª OopMapã€‚

å‡è®¾ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½åªæœ‰ä¸€ä¸ª OopMapï¼Œå¹¶ä¸”æ˜¯åœ¨æ–¹æ³•è¿”å›ä¹‹å‰ï¼š

```java
// æ–¹æ³•1å­˜å‚¨åœ¨æ ˆå¸§3
public void testMethod1() {
    // æ ˆé‡Œå’Œå¯„å­˜å™¨å†…çš„å¼•ç”¨
    DemoD demoD = new DemoD();
}

// æ–¹æ³•2å­˜å‚¨åœ¨æ ˆå¸§8
public void testMethod2() {
    // æ ˆé‡Œå’Œå¯„å­˜å™¨å†…çš„å¼•ç”¨
    DemoA demoA = new DemoA();
    // å¯¹è±¡å†…çš„å¼•ç”¨
    demoA.setDemoC(new DemoC());
    
    // æ ˆé‡Œå’Œå¯„å­˜å™¨å†…çš„å¼•ç”¨
    DemoA demoB = new DemoB();
} 
```

é‚£ä¹ˆ testMethod1() å’Œ testMethod2() çš„ OopMap å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220723173000230](images/image-20220723173000230.png)



#### å®‰å…¨ç‚¹

åœ¨ OopMap çš„ååŠ©ä¸‹ï¼ŒHotSpot å¯ä»¥å¿«é€Ÿå®Œæˆæ ¹èŠ‚ç‚¹æšä¸¾äº†ï¼Œä½†ä¸€ä¸ªå¾ˆç°å®çš„é—®é¢˜éšä¹‹è€Œæ¥ï¼šç”±äºå¼•ç”¨å…³ç³»å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™å°±ä¼šå¯¼è‡´  OopMap å†…å®¹å˜åŒ–çš„æŒ‡ä»¤éå¸¸å¤šï¼Œå¦‚æœä¸ºæ¯ä¸€æ¡æŒ‡ä»¤éƒ½ç”Ÿæˆå¯¹åº”çš„  OopMapï¼Œé‚£å°†ä¼šéœ€è¦å¤§é‡çš„é¢å¤–å­˜å‚¨ç©ºé—´ï¼Œè¿™æ ·åƒåœ¾æ”¶é›†ä¼´éšè€Œæ¥çš„ç©ºé—´æˆæœ¬å°±ä¼šå˜å¾—æ— æ³•å¿å—çš„é«˜æ˜‚ã€‚

æ‰€ä»¥å®é™…ä¸Š HotSpot ä¹Ÿç¡®å®æ²¡æœ‰ä¸ºæ¯æ¡æŒ‡ä»¤éƒ½ç”Ÿæˆ OopMapï¼Œåªæ˜¯åœ¨ â€œç‰¹å®šçš„ä½ç½®â€ ç”Ÿæˆ OopMapï¼Œæ¢å¥è¯è¯´ï¼Œåªæœ‰åœ¨æŸäº› â€ç‰¹å®šçš„ä½ç½®â€œ ä¸Šæ‰ä¼šæŠŠå¯¹è±¡å¼•ç”¨çš„ç›¸å…³ä¿¡æ¯ç»™è®°å½•ä¸‹æ¥ï¼Œè¿™äº›ä½ç½®ä¹Ÿè¢«ç§°ä¸º**å®‰å…¨ç‚¹**ï¼ˆSafepointï¼‰ã€‚

æœ‰äº†å®‰å…¨ç‚¹çš„è®¾å®šï¼Œä¹Ÿå°±å†³å®šäº†ç”¨æˆ·ç¨‹åºæ‰§è¡Œæ—¶å¹¶ä¸æ˜¯éšä¾¿å“ªä¸ªæ—¶å€™éƒ½èƒ½å¤Ÿåœé¡¿ä¸‹æ¥å¼€å§‹ GC çš„ï¼Œè€Œæ˜¯å¼ºåˆ¶è¦æ±‚**ç¨‹åºå¿…é¡»æ‰§è¡Œåˆ°è¾¾å®‰å…¨ç‚¹åæ‰èƒ½å¤Ÿè¿›è¡Œ GC**ï¼ˆå› ä¸ºä¸åˆ°è¾¾å®‰å…¨ç‚¹è¯ï¼Œæ²¡æœ‰ OopMapï¼Œè™šæ‹Ÿæœºå°±æ²¡æ³•å¿«é€ŸçŸ¥é“å¯¹è±¡å¼•ç”¨çš„ä½ç½®å‘€ï¼Œæ²¡æ³•è¿›è¡Œæ ¹èŠ‚ç‚¹æšä¸¾ï¼‰ã€‚

![image-20220628203702554](./images/image-20220628203702554.png)

å› æ­¤ï¼Œ**å®‰å…¨ç‚¹çš„è®¾å®šæ—¢ä¸èƒ½å¤ªå°‘ä»¥è‡³äºè®©åƒåœ¾æ”¶é›†å™¨ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œä¹Ÿä¸èƒ½å¤ªå¤šä»¥è‡³äºé¢‘ç¹è¿›è¡Œåƒåœ¾æ”¶é›†ä»è€Œå¯¼è‡´è¿è¡Œæ—¶çš„å†…å­˜è´Ÿè·å¤§å¹…å¢å¤§**ã€‚æ‰€ä»¥ï¼Œå®‰å…¨ç‚¹çš„é€‰å®šåŸºæœ¬ä¸Šæ˜¯ä»¥ â€œ**æ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾**â€ ä¸ºæ ‡å‡†è¿›è¡Œé€‰å®šçš„ï¼Œæœ€å…¸å‹çš„å°±æ˜¯**æŒ‡ä»¤åºåˆ—çš„å¤ç”¨**ï¼šä¾‹å¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ã€å¼‚å¸¸è·³è½¬ç­‰ï¼Œæ‰€ä»¥åªæœ‰å…·æœ‰è¿™äº›åŠŸèƒ½çš„æŒ‡ä»¤æ‰ä¼šäº§ç”Ÿå®‰å…¨ç‚¹ã€‚

å¯¹äºå®‰å…¨ç‚¹ï¼Œå¦å¤–ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„é—®é¢˜æ˜¯ï¼Œ**å¦‚ä½•åœ¨ GC å‘ç”Ÿæ—¶è®©æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹éƒ½æ‰§è¡Œåˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹ï¼Œç„¶ååœé¡¿ä¸‹æ¥å‘¢ï¼Ÿ**ã€‚è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼š

1. **æŠ¢å…ˆå¼ä¸­æ–­**ï¼ˆPreemptive Suspensionï¼‰ï¼šè¿™ç§æ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ GC å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿå…ˆæŠŠæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹å…¨éƒ¨ä¸­æ–­æ‰ã€‚ç„¶åå¦‚æœå‘ç°æœ‰ç”¨æˆ·çº¿ç¨‹ä¸­æ–­çš„ä½ç½®ä¸åœ¨å®‰å…¨ç‚¹ä¸Šï¼Œå°±æ¢å¤è¿™æ¡çº¿ç¨‹æ‰§è¡Œï¼Œç›´åˆ°è·‘åˆ°å®‰å…¨ç‚¹ä¸Šå†é‡æ–°ä¸­æ–­ã€‚

   æŠ¢å…ˆå¼ä¸­æ–­çš„æœ€å¤§é—®é¢˜æ˜¯æ—¶é—´æˆæœ¬çš„ä¸å¯æ§ï¼Œè¿›è€Œå¯¼è‡´æ€§èƒ½ä¸ç¨³å®šå’Œååé‡çš„æ³¢åŠ¨ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è¿™æ˜¯éå¸¸è‡´å‘½çš„ï¼Œæ‰€ä»¥ç°åœ¨å‡ ä¹æ²¡æœ‰è™šæ‹Ÿæœºå®ç°é‡‡ç”¨æŠ¢å…ˆå¼ä¸­æ–­æ¥æš‚åœçº¿ç¨‹å“åº” GC äº‹ä»¶
2. **ä¸»åŠ¨å¼ä¸­æ–­**ï¼ˆVoluntary Suspensionï¼‰ï¼šä¸»åŠ¨å¼ä¸­æ–­ä¸ä¼šç›´æ¥ä¸­æ–­çº¿ç¨‹ï¼Œè€Œæ˜¯å…¨å±€è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½ï¼Œç”¨æˆ·çº¿ç¨‹ä¼šä¸æ–­çš„è½®è¯¢è¿™ä¸ªæ ‡å¿—ä½ï¼Œå½“å‘ç°æ ‡å¿—ä½ä¸ºçœŸæ—¶ï¼Œçº¿ç¨‹ä¼šåœ¨æœ€è¿‘çš„ä¸€ä¸ªå®‰å…¨ç‚¹ä¸»åŠ¨ä¸­æ–­æŒ‚èµ·ã€‚ç°åœ¨çš„è™šæ‹ŸæœºåŸºæœ¬éƒ½æ˜¯ç”¨è¿™ç§æ–¹å¼

#### å®‰å…¨åŒºåŸŸ Safe Region

å®‰å…¨ç‚¹æœºåˆ¶ä¿è¯äº†ç¨‹åºæ‰§è¡Œæ—¶ï¼Œåœ¨ä¸å¤ªé•¿çš„æ—¶é—´å†…å°±ä¼šé‡åˆ°å¯è¿›å…¥åƒåœ¾æ”¶é›†è¿‡ç¨‹çš„å®‰å…¨ç‚¹ã€‚

å¯¹äºä¸»åŠ¨å¼ä¸­æ–­æ¥è¯´ï¼Œç”¨æˆ·çº¿ç¨‹éœ€è¦ä¸æ–­åœ°å»è½®è¯¢æ ‡å¿—ä½ï¼Œé‚£å¯¹äºé‚£äº›å¤„äº sleep æˆ–è€… blocked çŠ¶æ€çš„çº¿ç¨‹ï¼ˆä¸åœ¨æ´»è·ƒçŠ¶æ€çš„çº¿ç¨‹ï¼‰æ¥è¯´æ€ä¹ˆåŠï¼Ÿ

è¿™äº›ä¸åœ¨æ´»è·ƒçŠ¶æ€çš„çº¿ç¨‹æ²¡æœ‰è·å¾— CPU æ—¶é—´ï¼Œæ²¡æ³•å»è½®è¯¢æ ‡å¿—ä½ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æ³•æ‰¾åˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹ä¸»åŠ¨ä¸­æ–­æŒ‚èµ·äº†ã€‚

æ¢å¥è¯è¯´ï¼Œå¯¹äºè¿™äº›ä¸æ´»è·ƒçš„çº¿ç¨‹ï¼Œæˆ‘ä»¬æ²¡æ³•æŒæ§å®ƒä»¬é†’è¿‡æ¥çš„æ—¶é—´ã€‚å¾ˆå¯èƒ½å…¶ä»–çº¿ç¨‹éƒ½å·²ç»é€šè¿‡è½®è¯¢æ ‡å¿—ä½åˆ°è¾¾å®‰å…¨ç‚¹è¢«ä¸­æ–­äº†ï¼Œç„¶åè™šæ‹Ÿæœºå¼€å§‹æ ¹èŠ‚ç‚¹æšä¸¾äº†ï¼ˆæ ¹èŠ‚ç‚¹æšä¸¾éœ€è¦æš‚åœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ï¼‰ï¼Œä½†æ˜¯è¿™æ—¶å€™é‚£äº›æœ¬ä¸æ´»è·ƒçš„ç”¨æˆ·çº¿ç¨‹åˆé†’è¿‡æ¥äº†å¼€å§‹æ‰§è¡Œï¼Œç ´åäº†å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼Œé‚£æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚

å¯¹äºè¿™ç§æƒ…å†µï¼Œå°±å¿…é¡»å¼•å…¥**å®‰å…¨åŒºåŸŸ**ï¼ˆSafe Regionï¼‰æ¥è§£å†³ã€‚

å®‰å…¨åŒºåŸŸçš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼šç¡®ä¿åœ¨æŸä¸€æ®µä»£ç ç‰‡æ®µä¹‹ä¸­ï¼Œå¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»æ„åœ°æ–¹å¼€å§‹ GC éƒ½æ˜¯å®‰å…¨çš„ã€‚

å¯ä»¥ç®€å•åœ°æŠŠå®‰å…¨åŒºåŸŸçœ‹ä½œ**è¢«æ‹‰é•¿äº†çš„å®‰å…¨ç‚¹**ã€‚

**å½“ç”¨æˆ·çº¿ç¨‹æ‰§è¡Œåˆ°å®‰å…¨åŒºåŸŸé‡Œé¢çš„ä»£ç æ—¶ï¼Œé¦–å…ˆä¼šæ ‡è¯†è‡ªå·±å·²ç»è¿›å…¥äº†å®‰å…¨åŒºåŸŸã€‚é‚£æ ·å½“è¿™æ®µæ—¶é—´é‡Œè™šæ‹Ÿæœºè¦å‘èµ· GC  æ—¶ï¼Œå°±ä¸å¿…å»ç®¡è¿™äº›åœ¨å®‰å…¨åŒºåŸŸå†…çš„çº¿ç¨‹äº†ã€‚**

å½“å®‰å…¨åŒºåŸŸä¸­çš„çº¿ç¨‹è¢«å”¤é†’å¹¶ç¦»å¼€å®‰å…¨åŒºåŸŸæ—¶ï¼Œå®ƒéœ€è¦æ£€æŸ¥ä¸‹ä¸»åŠ¨å¼ä¸­æ–­ç­–ç•¥çš„æ ‡å¿—ä½æ˜¯å¦ä¸ºçœŸï¼ˆè™šæ‹Ÿæœºæ˜¯å¦å¤„äº  STW çŠ¶æ€

* å¦‚æœä¸ºçœŸåˆ™ç»§ç»­æŒ‚èµ·ç­‰å¾…ï¼ˆé˜²æ­¢æ ¹èŠ‚ç‚¹æšä¸¾è¿‡ç¨‹ä¸­è¿™äº›è¢«å”¤é†’çº¿ç¨‹çš„æ‰§è¡Œç ´åäº†å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼‰
* å¦‚æœä¸ºå‡åˆ™æ ‡è¯†è¿˜æ²¡å¼€å§‹ STW æˆ–è€… STW åˆšåˆšç»“æŸï¼Œé‚£ä¹ˆçº¿ç¨‹å°±å¯ä»¥è¢«å”¤é†’ç„¶åç»§ç»­æ‰§è¡Œã€‚

### ä¸‰è‰²æ ‡è®°æ³•

å¯è¾¾æ€§åˆ†æå¯ä»¥åˆ†æˆä¸¤ä¸ªé˜¶æ®µ

1. æ ¹èŠ‚ç‚¹æšä¸¾
2. ä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†å¯¹è±¡å›¾

åœ¨å¯è¾¾æ€§åˆ†æä¸­ï¼Œç¬¬ä¸€é˜¶æ®µ â€æ ¹èŠ‚ç‚¹æšä¸¾â€œ æ˜¯å¿…é¡» STW  çš„ï¼Œä¸ç„¶å¦‚æœåˆ†æè¿‡ç¨‹ä¸­ç”¨æˆ·è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´æ ¹èŠ‚ç‚¹é›†åˆçš„å¯¹è±¡å¼•ç”¨å…³ç³»ä¸æ–­å˜åŒ–ï¼Œè¿™æ ·å¯è¾¾æ€§åˆ†æç»“æœçš„å‡†ç¡®æ€§æ˜¾ç„¶ä¹Ÿå°±æ— æ³•ä¿è¯äº†ï¼›è€Œç¬¬äºŒé˜¶æ®µ  â€ä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†å¯¹è±¡å›¾â€œï¼Œå¦‚æœä¸è¿›è¡Œ STW çš„è¯ï¼Œä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œç”±äºç¬¬äºŒé˜¶æ®µæ—¶é—´æ¯”è¾ƒé•¿ï¼Œé•¿æ—¶é—´çš„ STW  å¾ˆå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥å¤§ä½¬ä»¬è®¾è®¡äº†ä¸€äº›è§£å†³æ–¹æ¡ˆï¼Œä»è€Œä½¿å¾—è¿™ä¸ªç¬¬äºŒé˜¶æ®µå¯ä»¥ä¸ç”¨ STWï¼Œå¤§å¹…å‡å°‘æ—¶é—´

#### å‰è¨€

äº‹å®ä¸Šï¼ŒGC Roots ç›¸æ¯”èµ·æ•´ä¸ª Java å †ä¸­å…¨éƒ¨çš„å¯¹è±¡æ¯•ç«Ÿè¿˜ç®—æ˜¯æå°‘æ•°ï¼Œä¸”åœ¨å„ç§ä¼˜åŒ–æŠ€å·§ï¼ˆæ¯”å¦‚ OopMapï¼‰çš„åŠ æŒä¸‹ï¼Œå®ƒå¸¦æ¥çš„åœé¡¿å·²ç»æ˜¯éå¸¸çŸ­æš‚ä¸”ç›¸å¯¹å›ºå®šçš„äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**â€œæ ¹èŠ‚ç‚¹æšä¸¾â€ é˜¶æ®µçš„åœé¡¿æ—¶é—´ä¸ä¼šéšç€å †å®¹é‡çš„å¢é•¿è€Œå¢åŠ **ã€‚

å½“æˆ‘ä»¬æšä¸¾å®Œäº†æ‰€æœ‰çš„ GC Rootsï¼Œå°±å¾—è¿›å…¥ç¬¬äºŒé˜¶æ®µç»§ç»­å¾€ä¸‹éå†å¯¹è±¡å›¾äº†ï¼Œè¿™ä¸€æ­¥éª¤åŒæ ·éœ€è¦ STWï¼Œå¹¶ä¸”åœé¡¿æ—¶é—´ä¸ Java å †å®¹é‡ç›´æ¥æˆæ­£æ¯”ä¾‹å…³ç³»ï¼šå †è¶Šå¤§ï¼Œå­˜å‚¨çš„å¯¹è±¡è¶Šå¤šï¼Œå¯¹è±¡å›¾ç»“æ„è¶Šå¤æ‚ï¼Œè¦æ ‡è®°æ›´å¤šå¯¹è±¡è€Œäº§ç”Ÿçš„åœé¡¿æ—¶é—´è‡ªç„¶å°±æ›´é•¿ï¼Œè¿™æ˜¯ç†æ‰€å½“ç„¶çš„äº‹æƒ…

ä¹Ÿå°±æ˜¯è¯´ï¼Œ**â€œä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†å¯¹è±¡å›¾â€ é˜¶æ®µçš„åœé¡¿æ—¶é—´éšç€å †å®¹é‡çš„å¢é•¿è€Œå¢åŠ **ã€‚

è¦çŸ¥é“åŒ…å«â€œæ ‡è®°â€é˜¶æ®µï¼ˆä¹Ÿå°±æ˜¯å¯è¾¾æ€§åˆ†æï¼‰æ˜¯æ‰€æœ‰è¿½è¸ªå¼åƒåœ¾æ”¶é›†ç®—æ³•çš„å…±åŒç‰¹å¾ï¼Œå¦‚æœè¿™ä¸ªé˜¶æ®µä¼šéšç€å †å˜å¤§è€Œç­‰æ¯”ä¾‹å¢åŠ åœé¡¿æ—¶é—´ï¼Œå…¶å½±å“å°±ä¼šæ³¢åŠå‡ ä¹æ‰€æœ‰çš„åƒåœ¾æ”¶é›†å™¨ã€‚å¦‚æœèƒ½å¤Ÿå‡å°‘è¿™éƒ¨åˆ†åœé¡¿æ—¶é—´çš„è¯ï¼Œé‚£æ”¶ç›Šä¹Ÿå°†ä¼šæ˜¯å·¨å¤§çš„

æƒ³é™ä½ STW æ—¶é—´ç”šè‡³æ˜¯é¿å… STWï¼Œæˆ‘ä»¬å°±**è¦å…ˆææ¸…æ¥šä¸ºä»€ä¹ˆå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ä¿éšœä¸€è‡´æ€§çš„å¿«ç…§ä¸Šæ‰èƒ½è¿›è¡Œå¯¹è±¡å›¾çš„éå†**ï¼Ÿ

ä¸ºäº†èƒ½è§£é‡Šæ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œå¤§ä½¬ä»¬å¼•å…¥äº†ä¸‰è‰²æ ‡è®°æ³•ï¼ˆTri-color Markingï¼‰è¿™ä¸ªå·¥å…·

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸‰è‰²æ ‡è®°æ³•åªæ˜¯è¾…åŠ©æˆ‘ä»¬åˆ†æçš„å·¥å…·ï¼Œå¹¶ä¸æ˜¯æŸä¸ªåƒåœ¾æ”¶é›†å™¨å…·ä½“ä½¿ç”¨çš„ç®—æ³•ï¼ï¼ï¼ï¼ï¼æ›´ä¸æ˜¯é™ä½ STW æ—¶é—´ or æ¶ˆé™¤ STW çš„æ–¹æ³•ï¼Œå…·ä½“è§£å†³æ–¹æ³•ä¸‹é¢è¿˜ä¼šä»‹ç»
>
> åœ¨è¿™é‡Œï¼Œä¸‰è‰²æ ‡è®°æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬ææ¸…æ¥šåœ¨å¯è¾¾æ€§åˆ†æçš„ç¬¬äºŒé˜¶æ®µï¼ˆä¹Ÿå°±æ˜¯éå†å¯¹è±¡å›¾ï¼‰ï¼Œå¦‚æœç”¨æˆ·çº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿›è¡Œï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜

#### è¾…åŠ©åˆ†æçš„å·¥å…·ï¼šä¸‰è‰²æ ‡è®°æ³•

æ‰€è°“ä¸‰è‰²æ ‡è®°æ³•ï¼Œå°±æ˜¯æŠŠéå†å¯¹è±¡å›¾è¿‡ç¨‹ä¸­é‡åˆ°çš„å¯¹è±¡ï¼ŒæŒ‰ç…§ â€œæ˜¯å¦è®¿é—®è¿‡â€ è¿™ä¸ªæ¡ä»¶æ ‡è®°æˆä»¥ä¸‹ä¸‰ç§é¢œè‰²ï¼š

- **ç™½è‰²**ï¼šè¡¨ç¤ºå¯¹è±¡å°šæœªè¢«åƒåœ¾æ”¶é›†å™¨è®¿é—®è¿‡ã€‚æ˜¾ç„¶åœ¨å¯è¾¾æ€§åˆ†æåˆšåˆšå¼€å§‹çš„é˜¶æ®µï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ç™½è‰²çš„ï¼Œè‹¥åœ¨åˆ†æç»“æŸçš„é˜¶æ®µï¼Œä»ç„¶æ˜¯ç™½è‰²çš„å¯¹è±¡ï¼Œå³ä»£è¡¨ä¸å¯è¾¾ï¼ˆå¯è¾¾æ€§åˆ†æåˆ°ä¸äº†çš„å¯¹è±¡ï¼Œå°±æ˜¯æ­»äº¡å¯¹è±¡ï¼Œéœ€è¦è¢«å›æ”¶ï¼‰

- **é»‘è‰²**ï¼šè¡¨ç¤ºå¯¹è±¡å·²ç»è¢«åƒåœ¾æ”¶é›†å™¨è®¿é—®è¿‡ï¼Œä¸”è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½å·²ç»æ‰«æè¿‡ã€‚é»‘è‰²çš„å¯¹è±¡ä»£è¡¨å·²ç»æ‰«æè¿‡ï¼Œå®ƒæ˜¯å®‰å…¨å­˜æ´»çš„ï¼Œå¦‚æœæœ‰å…¶ä»–å¯¹è±¡å¼•ç”¨æŒ‡å‘äº†é»‘è‰²å¯¹è±¡ï¼Œæ— é¡»é‡æ–°æ‰«æä¸€éã€‚é»‘è‰²å¯¹è±¡ä¸å¯èƒ½ç›´æ¥ï¼ˆä¸ç»è¿‡ç°è‰²å¯¹è±¡ï¼‰æŒ‡å‘æŸä¸ªç™½è‰²å¯¹è±¡ã€‚

- **ç°è‰²**ï¼šè¡¨ç¤ºå¯¹è±¡å·²ç»è¢«åƒåœ¾æ”¶é›†å™¨è®¿é—®è¿‡ï¼Œä½†è¿™ä¸ªå¯¹è±¡ä¸Šè‡³å°‘å­˜åœ¨ä¸€ä¸ªå¼•ç”¨è¿˜æ²¡æœ‰è¢«æ‰«æè¿‡

  > ç°è‰²å¯èƒ½ä¸å¥½ç†è§£ï¼Œè¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼šA(GC roots) â†’ B â†’ Cï¼Œå¦‚æœ B å·²ç»è¢«æ‰«æè¿‡ï¼Œä½†æ˜¯ B çš„å¼•ç”¨ C è¿˜æ²¡æœ‰è¢«æ‰«æè¿‡ï¼Œé‚£ä¹ˆ B å°±æ˜¯ç°è‰²çš„ï¼ŒC ç”±äºè¿˜æ²¡æœ‰è¢«æ‰«æï¼Œæ‰€ä»¥æ˜¯ç™½è‰²çš„

æ‰€ä»¥å¯¹è±¡å›¾éå†çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯ç”±ç°è‰²ä»é»‘å‘ç™½æ¨è¿›çš„è¿‡ç¨‹ï¼Œç°è‰²æ˜¯é»‘å’Œç™½çš„åˆ†ç•Œçº¿ã€‚

ä¸‹é¢æˆ‘ä»¬å°±ç”¨ä¸‰è‰²æ ‡è®°æ³•æ¥åˆ†æä¸‹ï¼Œå¦‚æœåœ¨å¯¹è±¡å›¾éå†è¿™ä¸ªé˜¶æ®µç”¨æˆ·çº¿ç¨‹ä¸æ”¶é›†å™¨å¹¶å‘å·¥ä½œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜

#### é—®é¢˜ 1ï¼šæµ®åŠ¨åƒåœ¾

æ‰€è°“æµ®åŠ¨åƒåœ¾ï¼Œå°±æ˜¯ç”±äºåƒåœ¾æ”¶é›†å’Œç”¨æˆ·çº¿ç¨‹æ˜¯å¹¶è¡Œçš„ï¼Œè¿™ä¸ªå¯¹è±¡å®é™…å·²ç»æ­»äº¡äº†ï¼Œå·²ç»æ²¡æœ‰å…¶ä»–äººå¼•ç”¨å®ƒäº†ï¼Œä½†æ˜¯**è¢«åƒåœ¾æ”¶é›†å™¨é”™è¯¯åœ°æ ‡è®°æˆäº†å­˜æ´»å¯¹è±¡**

ä¸¾ä¸ªä¾‹å­ï¼Œa å¼•ç”¨äº† bï¼Œæ­¤æ—¶ b è¢«æ‰«æä¸ºå¯è¾¾ï¼Œä½†æ˜¯ç”¨æˆ·çº¿ç¨‹éšååˆæ‰§è¡Œäº† a.b = nullï¼Œè¿™ä¸ªæ—¶å€™å…¶å® b å·²ç»æ˜¯æ­»äº¡çš„åƒåœ¾å¯¹è±¡äº†ï¼Œä½†æ˜¯ç”±äº**é»‘è‰²å¯¹è±¡ä¸ä¼šè¢«é‡æ–°æ‰«æ**ï¼Œæ‰€ä»¥åœ¨åƒåœ¾æ”¶é›†é‡Œ b ä¾ç„¶ä½œä¸ºå­˜æ´»å¯¹è±¡è¢«æ ‡è®°æˆé»‘è‰²ï¼Œå› æ­¤å°±æˆäº†æµ®åŠ¨åƒåœ¾ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220725143217373](images/image-20220725143217373.png)

æµ®åŠ¨åƒåœ¾å½“ç„¶ä¸æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œä½†å…¶å®æ˜¯å¯ä»¥å®¹å¿çš„ï¼Œå› ä¸ºè¿™åªä¸è¿‡äº§ç”Ÿäº†ä¸€ç‚¹é€ƒè¿‡æœ¬æ¬¡æ”¶é›†çš„æµ®åŠ¨åƒåœ¾è€Œå·²ï¼Œåæ­£è¿˜ä¼šæœ‰ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†ï¼Œåˆ°æ—¶å€™å°±ä¼šè¢«æ ‡è®°ä¸ºåƒåœ¾è¢«æ¸…ç†æ‰äº†

#### é—®é¢˜ 2ï¼šå¯¹è±¡æ¶ˆå¤±

å¯¹è±¡æ¶ˆå¤±å’Œæµ®åŠ¨åƒåœ¾æ°æ°ç›¸åï¼Œå¯¹è±¡æ¶ˆå¤±æ˜¯**æŠŠåŸæœ¬å­˜æ´»çš„å¯¹è±¡é”™è¯¯æ ‡è®°ä¸ºå·²æ¶ˆäº¡**ï¼Œè¿™å°±æ˜¯éå¸¸è‡´å‘½çš„åæœäº†ï¼Œç¨‹åºè‚¯å®šä¼šå› æ­¤å‘ç”Ÿé”™è¯¯ï¼Œä¸‹é¢è¡¨æ¼”ç¤ºäº†è¿™æ ·çš„è‡´å‘½é”™è¯¯å…·ä½“æ˜¯å¦‚ä½•äº§ç”Ÿçš„

![image-20220725143235602](images/image-20220725143235602.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œb -> c çš„å¼•ç”¨è¢«åˆ‡æ–­ï¼Œä½†åŒæ—¶ç”¨æˆ·çº¿ç¨‹å»ºç«‹äº†ä¸€ä¸ªæ–°çš„ä» a -> c çš„å¼•ç”¨ï¼Œç”±äºå·²ç»éå†åˆ°äº†  bï¼Œä¸å¯èƒ½å†å›å»éå† aï¼ˆé»‘è‰²å¯¹è±¡ä¸ä¼šè¢«é‡æ–°æ‰«æï¼‰ï¼Œå†éå† cï¼Œæ‰€ä»¥è¿™ä¸ª c  å®é™…æ˜¯å­˜æ´»çš„å¯¹è±¡ï¼Œä½†ç”±äºæ²¡æœ‰è¢«åƒåœ¾æ”¶é›†å™¨æ‰«æåˆ°ï¼Œè¢«é”™è¯¯åœ°æ ‡è®°æˆäº†ç™½è‰²ã€‚

æ€»ç»“ä¸‹å¯¹è±¡æ¶ˆå¤±é—®é¢˜çš„ä¸¤ä¸ªæ¡ä»¶ï¼š

1. æ’å…¥äº†ä¸€æ¡æˆ–å¤šæ¡ä»é»‘è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„æ–°å¼•ç”¨
2. åˆ é™¤äº†å…¨éƒ¨ä»ç°è‰²å¯¹è±¡åˆ°è¯¥ç™½è‰²å¯¹è±¡çš„ç›´æ¥æˆ–é—´æ¥å¼•ç”¨

Wilson äº 1994 å¹´åœ¨ç†è®ºä¸Šè¯æ˜äº†ï¼Œå½“ä¸”ä»…å½“ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ï¼Œæ‰ä¼šäº§ç”Ÿ â€œå¯¹è±¡æ¶ˆå¤±â€ çš„é—®é¢˜ï¼Œå³åŸæœ¬åº”è¯¥æ˜¯é»‘è‰²çš„å¯¹è±¡è¢«è¯¯æ ‡ä¸ºç™½è‰²

#### éå†å¯¹è±¡å›¾ä¸éœ€è¦ STW çš„è§£å†³æ–¹æ¡ˆ

å¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœéå†å¯¹è±¡å›¾çš„è¿‡ç¨‹ä¸ STW çš„è¯ï¼Œç¬¬ä¸€ä¸ªæµ®åŠ¨åƒåœ¾çš„é—®é¢˜å¾ˆå¥½å¤„ç†ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªå¯¹è±¡æ¶ˆå¤±é—®é¢˜å°±å¾ˆæ£˜æ‰‹äº†ã€‚

ä½†æ˜¯å‘¢ï¼Œéå†å¯¹è±¡å›¾çš„è¿‡ç¨‹åˆå®åœ¨å¤ªé•¿ï¼Œè®¾è®¡ JVM çš„å¤§ä½¬ä»¬ä¸å¾—ä¸æƒ³å‡ºä¸€äº›åŠæ³•æ¥è§£å†³å¯¹è±¡æ¶ˆå¤±é—®é¢˜ï¼Œä½¿å¾—åœ¨éå†å¯¹è±¡å›¾çš„è¿‡ç¨‹ä¸­ä¸ç”¨è¿›è¡Œ STWï¼ˆä¹Ÿå°±æ˜¯ç”¨æˆ·çº¿ç¨‹å’Œå¯¹è±¡çº¿ç¨‹å¯ä»¥åŒæ—¶å·¥ä½œï¼‰ï¼Œä»è€Œæå‡å¯è¾¾æ€§åˆ†æçš„æ•ˆç‡

ä¸Šé¢æ€»ç»“äº†å¯¹è±¡æ¶ˆå¤±é—®é¢˜çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è§£å†³å¹¶å‘æ‰«ææ—¶çš„å¯¹è±¡æ¶ˆå¤±é—®é¢˜ï¼Œåªéœ€ç ´åè¿™ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªå³å¯ã€‚ç”±æ­¤åˆ†åˆ«äº§ç”Ÿäº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

1. **å¢é‡æ›´æ–°**ï¼ˆIncremental Updateï¼‰ï¼šå¢é‡æ›´æ–°ç ´åçš„æ˜¯ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œå½“é»‘è‰²å¯¹è±¡æ’å…¥æ–°çš„æŒ‡å‘ç™½è‰²å¯¹è±¡çš„å¼•ç”¨å…³ç³»æ—¶ï¼ˆå°±æ˜¯ä¸Šå›¾ä¸­çš„ a -> c  å¼•ç”¨å…³ç³»ï¼‰ï¼Œå°±å°†è¿™ä¸ªæ–°æ’å…¥çš„å¼•ç”¨è®°å½•ä¸‹æ¥ï¼Œç­‰å¹¶å‘æ‰«æç»“æŸä¹‹åï¼Œå†å°†è¿™äº›è®°å½•è¿‡çš„å¼•ç”¨å…³ç³»ä¸­çš„é»‘è‰²å¯¹è±¡ï¼ˆaï¼‰ä¸ºæ ¹ï¼Œé‡æ–°æ‰«æä¸€æ¬¡ã€‚è¿™å¯ä»¥ç®€åŒ–ç†è§£ä¸ºï¼Œ**é»‘è‰²å¯¹è±¡ä¸€æ—¦æ–°æ’å…¥äº†æŒ‡å‘ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ä¹‹åï¼Œå®ƒå°±å˜å›ç°è‰²å¯¹è±¡äº†**ã€‚
2. **åŸå§‹å¿«ç…§**ï¼ˆSnapshot At The Beginningï¼ŒSATBï¼‰ï¼šåŸå§‹å¿«ç…§è¦ç ´åçš„æ˜¯ç¬¬äºŒä¸ªæ¡ä»¶ï¼Œå½“ç°è‰²å¯¹è±¡è¦åˆ é™¤æŒ‡å‘ç™½è‰²å¯¹è±¡çš„å¼•ç”¨å…³ç³»æ—¶ï¼ˆä¸Šå›¾ä¸­çš„ b -> c  å¼•ç”¨å…³ç³»ï¼‰ï¼Œå°±å°†è¿™ä¸ªè¦åˆ é™¤çš„å¼•ç”¨è®°å½•ä¸‹æ¥ï¼Œåœ¨å¹¶å‘æ‰«æç»“æŸä¹‹åï¼Œå†å°†è¿™äº›è®°å½•è¿‡çš„å¼•ç”¨å…³ç³»ä¸­çš„ç°è‰²å¯¹è±¡ï¼ˆbï¼‰ä¸ºæ ¹ï¼Œé‡æ–°æ‰«æä¸€æ¬¡ã€‚è¿™ä¹Ÿå¯ä»¥ç®€åŒ–ç†è§£ä¸ºï¼Œ**æ— è®ºå¼•ç”¨å…³ç³»åˆ é™¤ä¸å¦ï¼Œéƒ½ä¼šæŒ‰ç…§åˆšåˆšå¼€å§‹æ‰«æé‚£ä¸€åˆ»çš„å¯¹è±¡å›¾å¿«ç…§æ¥è¿›è¡Œæœç´¢**ã€‚

åœ¨ HotSpot è™šæ‹Ÿæœºä¸­ï¼Œå¢é‡æ›´æ–°å’ŒåŸå§‹å¿«ç…§è¿™ä¸¤ç§è§£å†³æ–¹æ¡ˆéƒ½æœ‰å®é™…åº”ç”¨ï¼ŒCMS æ˜¯åŸºäºå¢é‡æ›´æ–°æ¥åšå¹¶å‘æ ‡è®°çš„ï¼ŒG1ã€Shenandoah åˆ™æ˜¯ç”¨åŸå§‹å¿«ç…§æ¥å®ç°



### ä»€ä¹ˆæ˜¯å­—èŠ‚ç ï¼Ÿç±»æ–‡ä»¶ç»“æ„çš„ç»„æˆäº†è§£å—ï¼Ÿ

**Java å­—èŠ‚ç **ï¼ˆè‹±è¯­ï¼šJava bytecodeï¼‰æ˜¯[Javaè™šæ‹Ÿæœº](https://zh.wikipedia.org/wiki/Javaè™šæ‹Ÿæœº)æ‰§è¡Œçš„ä¸€ç§[æŒ‡ä»¤](https://zh.wikipedia.org/wiki/æŒ‡ä»¤)æ ¼å¼ã€‚å¤§å¤šæ•°[æ“ä½œç ](https://zh.wikipedia.org/w/index.php?title=æ“ä½œç &action=edit&redlink=1)éƒ½æ˜¯ä¸€ä¸ª[å­—èŠ‚](https://zh.wikipedia.org/wiki/å­—èŠ‚)é•¿ï¼Œè€Œæœ‰äº›æ“ä½œéœ€è¦å‚æ•°ï¼Œå¯¼è‡´äº†æœ‰ä¸€äº›å¤šå­—èŠ‚çš„æ“ä½œç ã€‚è€Œä¸”å¹¶ä¸æ˜¯æ‰€æœ‰å¯èƒ½çš„256ä¸ªæ“ä½œç éƒ½è¢«ä½¿ç”¨ï¼›å…¶ä¸­æœ‰51ä¸ªæ“ä½œç è¢«ä¿ç•™åšå°†æ¥ä½¿ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒåŸå§‹[Javaå¹³å°](https://zh.wikipedia.org/wiki/Javaå¹³å°)å¼€å‘å•†ï¼Œ[å¤ªé˜³å¾®ç³»ç»Ÿ](https://zh.wikipedia.org/wiki/æ˜‡é™½å¾®ç³»çµ±)ï¼Œé¢å¤–ä¿ç•™äº†3ä¸ªä»£ç æ°¸ä¹…ä¸ä½¿ç”¨ã€‚

> ä¸€ä¸ª[Java](https://zh.wikipedia.org/wiki/Java)ç¨‹åºå‘˜å¹¶ä¸éœ€è¦ç†è§£æ‰€æœ‰çš„Javaå­—èŠ‚ç ã€‚ä½†æ˜¯ï¼Œå°±åƒ[IBM](https://zh.wikipedia.org/wiki/IBM) developerWorkså‘¨åˆŠå»ºè®®çš„é‚£æ ·ï¼šâ€œç†è§£å­—èŠ‚ç ä»¥åŠç†è§£Javaç¼–è¯‘å™¨å¦‚ä½•ç”ŸæˆJavaå­—èŠ‚ç ä¸å­¦ä¹ [æ±‡ç¼–](https://zh.wikipedia.org/wiki/æ±‡ç¼–è¯­è¨€)çŸ¥è¯†å¯¹äº[C](https://zh.wikipedia.org/wiki/C)/[C++](https://zh.wikipedia.org/wiki/C%2B%2B)ç¨‹åºå‘˜æœ‰ä¸€æ ·çš„æ„ä¹‰ã€‚â€



#### Class æ–‡ä»¶ç»“æ„æ€»ç»“

æ ¹æ® Java è™šæ‹Ÿæœºè§„èŒƒï¼ŒClass æ–‡ä»¶é€šè¿‡ `ClassFile` å®šä¹‰ï¼Œæœ‰ç‚¹ç±»ä¼¼ C è¯­è¨€çš„ç»“æ„ä½“ã€‚

`ClassFile` çš„ç»“æ„å¦‚ä¸‹ï¼š

```java
ClassFile {
    u4             magic; //Class æ–‡ä»¶çš„æ ‡å¿—
    u2             minor_version;//Class çš„å°ç‰ˆæœ¬å·
    u2             major_version;//Class çš„å¤§ç‰ˆæœ¬å·
    u2             constant_pool_count;//å¸¸é‡æ± çš„æ•°é‡
    cp_info        constant_pool[constant_pool_count-1];//å¸¸é‡æ± 
    u2             access_flags;//Class çš„è®¿é—®æ ‡è®°
    u2             this_class;//å½“å‰ç±»
    u2             super_class;//çˆ¶ç±»
    u2             interfaces_count;//æ¥å£
    u2             interfaces[interfaces_count];//ä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£
    u2             fields_count;//Class æ–‡ä»¶çš„å­—æ®µå±æ€§
    field_info     fields[fields_count];//ä¸€ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªå­—æ®µ
    u2             methods_count;//Class æ–‡ä»¶çš„æ–¹æ³•æ•°é‡
    method_info    methods[methods_count];//ä¸€ä¸ªç±»å¯ä»¥æœ‰ä¸ªå¤šä¸ªæ–¹æ³•
    u2             attributes_count;//æ­¤ç±»çš„å±æ€§è¡¨ä¸­çš„å±æ€§æ•°
    attribute_info attributes[attributes_count];//å±æ€§è¡¨é›†åˆ
}
```

é€šè¿‡åˆ†æ `ClassFile` çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥çŸ¥é“ class æ–‡ä»¶çš„ç»„æˆã€‚

![image-20220723173831486](images/image-20220723173831486.png)

ä¸‹é¢è¿™å¼ å›¾æ˜¯é€šè¿‡ IDEA æ’ä»¶ `jclasslib` æŸ¥çœ‹çš„ï¼Œä½ å¯ä»¥æ›´ç›´è§‚çœ‹åˆ° Class æ–‡ä»¶ç»“æ„ã€‚

![image-20220723173839688](images/image-20220723173839688.png)

ä½¿ç”¨ `jclasslib` ä¸å…‰å¯ä»¥ç›´è§‚åœ°æŸ¥çœ‹æŸä¸ªç±»å¯¹åº”çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹ç±»çš„åŸºæœ¬ä¿¡æ¯ã€å¸¸é‡æ± ã€æ¥å£ã€å±æ€§ã€å‡½æ•°ç­‰ä¿¡æ¯ã€‚

ä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ Class æ–‡ä»¶ç»“æ„æ¶‰åŠåˆ°çš„ä¸€äº›ç»„ä»¶ã€‚

#### é­”æ•°ï¼ˆMagic Numberï¼‰

```java
    u4             magic; //Class æ–‡ä»¶çš„æ ‡å¿—
```

æ¯ä¸ª Class æ–‡ä»¶çš„å¤´ 4 ä¸ªå­—èŠ‚ç§°ä¸ºé­”æ•°ï¼ˆMagic Numberï¼‰,å®ƒçš„å”¯ä¸€ä½œç”¨æ˜¯**ç¡®å®šè¿™ä¸ªæ–‡ä»¶æ˜¯å¦ä¸ºä¸€ä¸ªèƒ½è¢«è™šæ‹Ÿæœºæ¥æ”¶çš„ Class æ–‡ä»¶**ã€‚

ç¨‹åºè®¾è®¡è€…å¾ˆå¤šæ—¶å€™éƒ½å–œæ¬¢ç”¨ä¸€äº›ç‰¹æ®Šçš„æ•°å­—è¡¨ç¤ºå›ºå®šçš„æ–‡ä»¶ç±»å‹æˆ–è€…å…¶å®ƒç‰¹æ®Šçš„å«ä¹‰ã€‚

#### Class æ–‡ä»¶ç‰ˆæœ¬å·ï¼ˆMinor&Major Versionï¼‰

```java
    u2             minor_version;//Class çš„å°ç‰ˆæœ¬å·
    u2             major_version;//Class çš„å¤§ç‰ˆæœ¬å·
```

ç´§æ¥ç€é­”æ•°çš„å››ä¸ªå­—èŠ‚å­˜å‚¨çš„æ˜¯ Class æ–‡ä»¶çš„ç‰ˆæœ¬å·ï¼šç¬¬ 5 å’Œç¬¬ 6 ä½æ˜¯**æ¬¡ç‰ˆæœ¬å·**ï¼Œç¬¬ 7 å’Œç¬¬ 8 ä½æ˜¯**ä¸»ç‰ˆæœ¬å·**ã€‚

æ¯å½“ Java å‘å¸ƒå¤§ç‰ˆæœ¬ï¼ˆæ¯”å¦‚ Java 8ï¼ŒJava9ï¼‰çš„æ—¶å€™ï¼Œä¸»ç‰ˆæœ¬å·éƒ½ä¼šåŠ  1ã€‚ä½ å¯ä»¥ä½¿ç”¨ `javap -v` å‘½ä»¤æ¥å¿«é€ŸæŸ¥çœ‹ Class æ–‡ä»¶çš„ç‰ˆæœ¬å·ä¿¡æ¯ã€‚

é«˜ç‰ˆæœ¬çš„ Java è™šæ‹Ÿæœºå¯ä»¥æ‰§è¡Œä½ç‰ˆæœ¬ç¼–è¯‘å™¨ç”Ÿæˆçš„ Class æ–‡ä»¶ï¼Œä½†æ˜¯ä½ç‰ˆæœ¬çš„ Java è™šæ‹Ÿæœºä¸èƒ½æ‰§è¡Œé«˜ç‰ˆæœ¬ç¼–è¯‘å™¨ç”Ÿæˆçš„ Class æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å®é™…å¼€å‘çš„æ—¶å€™è¦ç¡®ä¿å¼€å‘çš„çš„ JDK ç‰ˆæœ¬å’Œç”Ÿäº§ç¯å¢ƒçš„ JDK ç‰ˆæœ¬ä¿æŒä¸€è‡´ã€‚

#### å¸¸é‡æ± ï¼ˆConstant Poolï¼‰

```java
    u2             constant_pool_count;//å¸¸é‡æ± çš„æ•°é‡
    cp_info        constant_pool[constant_pool_count-1];//å¸¸é‡æ± 
```

ç´§æ¥ç€ä¸»æ¬¡ç‰ˆæœ¬å·ä¹‹åçš„æ˜¯å¸¸é‡æ± ï¼Œå¸¸é‡æ± çš„æ•°é‡æ˜¯ `constant_pool_count-1`ï¼ˆ**å¸¸é‡æ± è®¡æ•°å™¨æ˜¯ä» 1 å¼€å§‹è®¡æ•°çš„ï¼Œå°†ç¬¬ 0 é¡¹å¸¸é‡ç©ºå‡ºæ¥æ˜¯æœ‰ç‰¹æ®Šè€ƒè™‘çš„ï¼Œç´¢å¼•å€¼ä¸º 0 ä»£è¡¨â€œä¸å¼•ç”¨ä»»ä½•ä¸€ä¸ªå¸¸é‡æ± é¡¹â€**ï¼‰ã€‚

å¸¸é‡æ± ä¸»è¦å­˜æ”¾ä¸¤å¤§å¸¸é‡ï¼šå­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡æ¯”è¾ƒæ¥è¿‘äº Java è¯­è¨€å±‚é¢çš„çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€å£°æ˜ä¸º final çš„å¸¸é‡å€¼ç­‰ã€‚è€Œç¬¦å·å¼•ç”¨åˆ™å±äºç¼–è¯‘åŸç†æ–¹é¢çš„æ¦‚å¿µã€‚åŒ…æ‹¬ä¸‹é¢ä¸‰ç±»å¸¸é‡ï¼š

- ç±»å’Œæ¥å£çš„å…¨é™å®šå
- å­—æ®µçš„åç§°å’Œæè¿°ç¬¦
- æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦

å¸¸é‡æ± ä¸­æ¯ä¸€é¡¹å¸¸é‡éƒ½æ˜¯ä¸€ä¸ªè¡¨ï¼Œè¿™ 14 ç§è¡¨æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹ï¼š**å¼€å§‹çš„ç¬¬ä¸€ä½æ˜¯ä¸€ä¸ª u1 ç±»å‹çš„æ ‡å¿—ä½ -tag æ¥æ ‡è¯†å¸¸é‡çš„ç±»å‹ï¼Œä»£è¡¨å½“å‰è¿™ä¸ªå¸¸é‡å±äºå“ªç§å¸¸é‡ç±»å‹ï¼**

|               ç±»å‹               | æ ‡å¿—ï¼ˆtagï¼‰ |          æè¿°          |
| :------------------------------: | :---------: | :--------------------: |
|        CONSTANT_utf8_info        |      1      |   UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²   |
|      CONSTANT_Integer_info       |      3      |       æ•´å½¢å­—é¢é‡       |
|       CONSTANT_Float_info        |      4      |      æµ®ç‚¹å‹å­—é¢é‡      |
|        CONSTANT_Long_info        |     ï¼•      |      é•¿æ•´å‹å­—é¢é‡      |
|       CONSTANT_Double_info       |     ï¼–      |   åŒç²¾åº¦æµ®ç‚¹å‹å­—é¢é‡   |
|       CONSTANT_Class_info        |     ï¼—      |   ç±»æˆ–æ¥å£çš„ç¬¦å·å¼•ç”¨   |
|       CONSTANT_String_info       |     ï¼˜      |    å­—ç¬¦ä¸²ç±»å‹å­—é¢é‡    |
|      CONSTANT_Fieldref_info      |     ï¼™      |     å­—æ®µçš„ç¬¦å·å¼•ç”¨     |
|     CONSTANT_Methodref_info      |     10      |   ç±»ä¸­æ–¹æ³•çš„ç¬¦å·å¼•ç”¨   |
| CONSTANT_InterfaceMethodref_info |     11      |  æ¥å£ä¸­æ–¹æ³•çš„ç¬¦å·å¼•ç”¨  |
|    CONSTANT_NameAndType_info     |     12      |  å­—æ®µæˆ–æ–¹æ³•çš„ç¬¦å·å¼•ç”¨  |
|     CONSTANT_MothodType_info     |     16      |      æ ‡å¿—æ–¹æ³•ç±»å‹      |
|    CONSTANT_MethodHandle_info    |     15      |      è¡¨ç¤ºæ–¹æ³•å¥æŸ„      |
|   CONSTANT_InvokeDynamic_info    |     18      | è¡¨ç¤ºä¸€ä¸ªåŠ¨æ€æ–¹æ³•è°ƒç”¨ç‚¹ |

`.class` æ–‡ä»¶å¯ä»¥é€šè¿‡`javap -v classç±»å` æŒ‡ä»¤æ¥çœ‹ä¸€ä¸‹å…¶å¸¸é‡æ± ä¸­çš„ä¿¡æ¯(`javap -v classç±»å-> temp.txt` ï¼šå°†ç»“æœè¾“å‡ºåˆ° temp.txt æ–‡ä»¶)ã€‚

#### è®¿é—®æ ‡å¿—(Access Flags)

åœ¨å¸¸é‡æ± ç»“æŸä¹‹åï¼Œç´§æ¥ç€çš„ä¸¤ä¸ªå­—èŠ‚ä»£è¡¨è®¿é—®æ ‡å¿—ï¼Œè¿™ä¸ªæ ‡å¿—ç”¨äºè¯†åˆ«ä¸€äº›ç±»æˆ–è€…æ¥å£å±‚æ¬¡çš„è®¿é—®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šè¿™ä¸ª Class æ˜¯ç±»è¿˜æ˜¯æ¥å£ï¼Œæ˜¯å¦ä¸º `public` æˆ–è€… `abstract` ç±»å‹ï¼Œå¦‚æœæ˜¯ç±»çš„è¯æ˜¯å¦å£°æ˜ä¸º `final` ç­‰ç­‰ã€‚

ç±»è®¿é—®å’Œå±æ€§ä¿®é¥°ç¬¦:

![image-20220723173943684](images/image-20220723173943684.png)

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª Employee ç±»

```java
package top.snailclimb.bean;
public class Employee {
   ...
}
```

é€šè¿‡`javap -v classç±»å` æŒ‡ä»¤æ¥çœ‹ä¸€ä¸‹ç±»çš„è®¿é—®æ ‡å¿—ã€‚

![image-20220723173952132](images/image-20220723173952132.png)

#### å½“å‰ç±»ï¼ˆThis Classï¼‰ã€çˆ¶ç±»ï¼ˆSuper Classï¼‰ã€æ¥å£ï¼ˆInterfacesï¼‰ç´¢å¼•é›†åˆ

```java
    u2             this_class;//å½“å‰ç±»
    u2             super_class;//çˆ¶ç±»
    u2             interfaces_count;//æ¥å£
    u2             interfaces[interfaces_count];//ä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£
```

ç±»ç´¢å¼•ç”¨äºç¡®å®šè¿™ä¸ªç±»çš„å…¨é™å®šåï¼Œçˆ¶ç±»ç´¢å¼•ç”¨äºç¡®å®šè¿™ä¸ªç±»çš„çˆ¶ç±»çš„å…¨é™å®šåï¼Œç”±äº Java è¯­è¨€çš„å•ç»§æ‰¿ï¼Œæ‰€ä»¥çˆ¶ç±»ç´¢å¼•åªæœ‰ä¸€ä¸ªï¼Œé™¤äº† `java.lang.Object` ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ java ç±»éƒ½æœ‰çˆ¶ç±»ï¼Œå› æ­¤é™¤äº† `java.lang.Object` å¤–ï¼Œæ‰€æœ‰ Java ç±»çš„çˆ¶ç±»ç´¢å¼•éƒ½ä¸ä¸º 0ã€‚

æ¥å£ç´¢å¼•é›†åˆç”¨æ¥æè¿°è¿™ä¸ªç±»å®ç°äº†é‚£äº›æ¥å£ï¼Œè¿™äº›è¢«å®ç°çš„æ¥å£å°†æŒ‰ `implements` (å¦‚æœè¿™ä¸ªç±»æœ¬èº«æ˜¯æ¥å£çš„è¯åˆ™æ˜¯`extends`) åçš„æ¥å£é¡ºåºä»å·¦åˆ°å³æ’åˆ—åœ¨æ¥å£ç´¢å¼•é›†åˆä¸­ã€‚

#### å­—æ®µè¡¨é›†åˆï¼ˆFieldsï¼‰

```java
    u2             fields_count;//Class æ–‡ä»¶çš„å­—æ®µçš„ä¸ªæ•°
    field_info     fields[fields_count];//ä¸€ä¸ªç±»ä¼šå¯ä»¥æœ‰ä¸ªå­—æ®µ
```

å­—æ®µè¡¨ï¼ˆfield infoï¼‰ç”¨äºæè¿°æ¥å£æˆ–ç±»ä¸­å£°æ˜çš„å˜é‡ã€‚å­—æ®µåŒ…æ‹¬ç±»çº§å˜é‡ä»¥åŠå®ä¾‹å˜é‡ï¼Œä½†ä¸åŒ…æ‹¬åœ¨æ–¹æ³•å†…éƒ¨å£°æ˜çš„å±€éƒ¨å˜é‡ã€‚

**field info(å­—æ®µè¡¨) çš„ç»“æ„:**

![image-20220723174020945](images/image-20220723174020945.png)

- **access_flags:** å­—æ®µçš„ä½œç”¨åŸŸï¼ˆ`public` ,`private`,`protected`ä¿®é¥°ç¬¦ï¼‰ï¼Œæ˜¯å®ä¾‹å˜é‡è¿˜æ˜¯ç±»å˜é‡ï¼ˆ`static`ä¿®é¥°ç¬¦ï¼‰,å¯å¦è¢«åºåˆ—åŒ–ï¼ˆtransient ä¿®é¥°ç¬¦ï¼‰,å¯å˜æ€§ï¼ˆfinalï¼‰,å¯è§æ€§ï¼ˆvolatile ä¿®é¥°ç¬¦ï¼Œæ˜¯å¦å¼ºåˆ¶ä»ä¸»å†…å­˜è¯»å†™ï¼‰ã€‚
- **name_index:** å¯¹å¸¸é‡æ± çš„å¼•ç”¨ï¼Œè¡¨ç¤ºçš„å­—æ®µçš„åç§°ï¼›
- **descriptor_index:** å¯¹å¸¸é‡æ± çš„å¼•ç”¨ï¼Œè¡¨ç¤ºå­—æ®µå’Œæ–¹æ³•çš„æè¿°ç¬¦ï¼›
- **attributes_count:** ä¸€ä¸ªå­—æ®µè¿˜ä¼šæ‹¥æœ‰ä¸€äº›é¢å¤–çš„å±æ€§ï¼Œattributes_count å­˜æ”¾å±æ€§çš„ä¸ªæ•°ï¼›
- **attributes[attributes_count]:** å­˜æ”¾å…·ä½“å±æ€§å…·ä½“å†…å®¹ã€‚

ä¸Šè¿°è¿™äº›ä¿¡æ¯ä¸­ï¼Œå„ä¸ªä¿®é¥°ç¬¦éƒ½æ˜¯å¸ƒå°”å€¼ï¼Œè¦ä¹ˆæœ‰æŸä¸ªä¿®é¥°ç¬¦ï¼Œè¦ä¹ˆæ²¡æœ‰ï¼Œå¾ˆé€‚åˆä½¿ç”¨æ ‡å¿—ä½æ¥è¡¨ç¤ºã€‚è€Œå­—æ®µå«ä»€ä¹ˆåå­—ã€å­—æ®µè¢«å®šä¹‰ä¸ºä»€ä¹ˆæ•°æ®ç±»å‹è¿™äº›éƒ½æ˜¯æ— æ³•å›ºå®šçš„ï¼Œåªèƒ½å¼•ç”¨å¸¸é‡æ± ä¸­å¸¸é‡æ¥æè¿°ã€‚

**å­—æ®µçš„ access_flag çš„å–å€¼:**

![image-20220723174028527](images/image-20220723174028527.png)

#### æ–¹æ³•è¡¨é›†åˆï¼ˆMethodsï¼‰

```java
    u2             methods_count;//Class æ–‡ä»¶çš„æ–¹æ³•çš„æ•°é‡
    method_info    methods[methods_count];//ä¸€ä¸ªç±»å¯ä»¥æœ‰ä¸ªå¤šä¸ªæ–¹æ³•
```

methods_count è¡¨ç¤ºæ–¹æ³•çš„æ•°é‡ï¼Œè€Œ method_info è¡¨ç¤ºæ–¹æ³•è¡¨ã€‚

Class æ–‡ä»¶å­˜å‚¨æ ¼å¼ä¸­å¯¹æ–¹æ³•çš„æè¿°ä¸å¯¹å­—æ®µçš„æè¿°å‡ ä¹é‡‡ç”¨äº†å®Œå…¨ä¸€è‡´çš„æ–¹å¼ã€‚æ–¹æ³•è¡¨çš„ç»“æ„å¦‚åŒå­—æ®µè¡¨ä¸€æ ·ï¼Œä¾æ¬¡åŒ…æ‹¬äº†è®¿é—®æ ‡å¿—ã€åç§°ç´¢å¼•ã€æè¿°ç¬¦ç´¢å¼•ã€å±æ€§è¡¨é›†åˆå‡ é¡¹ã€‚

**method_info(æ–¹æ³•è¡¨çš„) ç»“æ„:**

![image-20220723174041110](images/image-20220723174041110.png)

æ–¹æ³•è¡¨çš„ access_flag å–å€¼ï¼š

![image-20220723174047943](images/image-20220723174047943.png)

æ³¨æ„ï¼šå› ä¸º`volatile`ä¿®é¥°ç¬¦å’Œ`transient`ä¿®é¥°ç¬¦ä¸å¯ä»¥ä¿®é¥°æ–¹æ³•ï¼Œæ‰€ä»¥æ–¹æ³•è¡¨çš„è®¿é—®æ ‡å¿—ä¸­æ²¡æœ‰è¿™ä¸¤ä¸ªå¯¹åº”çš„æ ‡å¿—ï¼Œä½†æ˜¯å¢åŠ äº†`synchronized`ã€`native`ã€`abstract`ç­‰å…³é”®å­—ä¿®é¥°æ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿå°±å¤šäº†è¿™äº›å…³é”®å­—å¯¹åº”çš„æ ‡å¿—ã€‚

#### å±æ€§è¡¨é›†åˆï¼ˆAttributesï¼‰

```java
   u2             attributes_count;//æ­¤ç±»çš„å±æ€§è¡¨ä¸­çš„å±æ€§æ•°
   attribute_info attributes[attributes_count];//å±æ€§è¡¨é›†åˆ
```

åœ¨  Class æ–‡ä»¶ï¼Œå­—æ®µè¡¨ï¼Œæ–¹æ³•è¡¨ä¸­éƒ½å¯ä»¥æºå¸¦è‡ªå·±çš„å±æ€§è¡¨é›†åˆï¼Œä»¥ç”¨äºæè¿°æŸäº›åœºæ™¯ä¸“æœ‰çš„ä¿¡æ¯ã€‚ä¸ Class  æ–‡ä»¶ä¸­å…¶å®ƒçš„æ•°æ®é¡¹ç›®è¦æ±‚çš„é¡ºåºã€é•¿åº¦å’Œå†…å®¹ä¸åŒï¼Œå±æ€§è¡¨é›†åˆçš„é™åˆ¶ç¨å¾®å®½æ¾ä¸€äº›ï¼Œä¸å†è¦æ±‚å„ä¸ªå±æ€§è¡¨å…·æœ‰ä¸¥æ ¼çš„é¡ºåºï¼Œå¹¶ä¸”åªè¦ä¸ä¸å·²æœ‰çš„å±æ€§åé‡å¤ï¼Œä»»ä½•äººå®ç°çš„ç¼–è¯‘å™¨éƒ½å¯ä»¥å‘å±æ€§è¡¨ä¸­å†™ å…¥è‡ªå·±å®šä¹‰çš„å±æ€§ä¿¡æ¯ï¼ŒJava è™šæ‹Ÿæœºè¿è¡Œæ—¶ä¼šå¿½ç•¥æ‰å®ƒä¸è®¤è¯†çš„å±æ€§ã€‚



## ğŸ•¸ï¸Netty

### Reactoræ¨¡å‹

#### å‰è¨€

å¦‚æœè¦è®©æœåŠ¡å™¨æœåŠ¡å¤šä¸ªå®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆæœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯ä¸ºæ¯ä¸€æ¡è¿æ¥åˆ›å»ºçº¿ç¨‹ã€‚

å…¶å®åˆ›å»ºè¿›ç¨‹ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ï¼Œè¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«åœ¨äºçº¿ç¨‹æ¯”è¾ƒè½»é‡çº§äº›ï¼Œçº¿ç¨‹çš„åˆ›å»ºå’Œçº¿ç¨‹é—´åˆ‡æ¢çš„æˆæœ¬è¦å°äº›ï¼Œä¸ºäº†æè¿°ç®€è¿°ï¼Œåé¢éƒ½ä»¥çº¿ç¨‹ä¸ºä¾‹ã€‚

å¤„ç†å®Œä¸šåŠ¡é€»è¾‘åï¼Œéšç€è¿æ¥å…³é—­åçº¿ç¨‹ä¹ŸåŒæ ·è¦é”€æ¯äº†ï¼Œä½†æ˜¯è¿™æ ·ä¸åœåœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œä¸ä»…ä¼šå¸¦æ¥æ€§èƒ½å¼€é”€ï¼Œä¹Ÿä¼šé€ æˆæµªè´¹èµ„æºï¼Œè€Œä¸”å¦‚æœè¦è¿æ¥å‡ ä¸‡æ¡è¿æ¥ï¼Œåˆ›å»ºå‡ ä¸‡ä¸ªçº¿ç¨‹å»åº”å¯¹ä¹Ÿæ˜¯ä¸ç°å®çš„ã€‚

è¦è¿™ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ã€Œèµ„æºå¤ç”¨ã€çš„æ–¹å¼ã€‚

ä¹Ÿå°±æ˜¯ä¸ç”¨å†ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªã€Œçº¿ç¨‹æ± ã€ï¼Œå°†è¿æ¥åˆ†é…ç»™çº¿ç¨‹ï¼Œç„¶åä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ã€‚

ä¸è¿‡ï¼Œè¿™æ ·åˆå¼•æ¥ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œçº¿ç¨‹æ€æ ·æ‰èƒ½é«˜æ•ˆåœ°å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ï¼Ÿ

å½“ä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹ä¸€èˆ¬é‡‡ç”¨ã€Œread -> ä¸šåŠ¡å¤„ç† -> sendã€çš„å¤„ç†æµç¨‹ï¼Œå¦‚æœå½“å‰è¿æ¥æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šé˜»å¡åœ¨ `read` æ“ä½œä¸Šï¼ˆ socket é»˜è®¤æƒ…å†µæ˜¯é˜»å¡ I/Oï¼‰ï¼Œä¸è¿‡è¿™ç§é˜»å¡æ–¹å¼å¹¶ä¸å½±å“å…¶ä»–çº¿ç¨‹ã€‚

ä½†æ˜¯å¼•å…¥äº†çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆä¸€ä¸ªçº¿ç¨‹è¦å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ï¼Œçº¿ç¨‹åœ¨å¤„ç†æŸä¸ªè¿æ¥çš„ `read` æ“ä½œæ—¶ï¼Œå¦‚æœé‡åˆ°æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œå°±ä¼šå‘ç”Ÿé˜»å¡ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±æ²¡åŠæ³•ç»§ç»­å¤„ç†å…¶ä»–è¿æ¥çš„ä¸šåŠ¡ã€‚

è¦è§£å†³è¿™ä¸€ä¸ªé—®é¢˜ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯å°† socket æ”¹æˆéé˜»å¡ï¼Œç„¶åçº¿ç¨‹ä¸æ–­åœ°è½®è¯¢è°ƒç”¨ `read` æ“ä½œæ¥åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®ï¼Œè¿™ç§æ–¹å¼è™½ç„¶è¯¥èƒ½å¤Ÿè§£å†³é˜»å¡çš„é—®é¢˜ï¼Œä½†æ˜¯è§£å†³çš„æ–¹å¼æ¯”è¾ƒç²—æš´ï¼Œå› ä¸ºè½®è¯¢æ˜¯è¦æ¶ˆè€— CPU çš„ï¼Œè€Œä¸”éšç€ä¸€ä¸ª çº¿ç¨‹å¤„ç†çš„è¿æ¥è¶Šå¤šï¼Œè½®è¯¢çš„æ•ˆç‡å°±ä¼šè¶Šä½ã€‚

ä¸Šé¢çš„é—®é¢˜åœ¨äºï¼Œçº¿ç¨‹å¹¶ä¸çŸ¥é“å½“å‰è¿æ¥æ˜¯å¦æœ‰æ•°æ®å¯è¯»ï¼Œä»è€Œéœ€è¦æ¯æ¬¡é€šè¿‡ `read` å»è¯•æ¢ã€‚

é‚£æœ‰æ²¡æœ‰åŠæ³•åœ¨åªæœ‰å½“è¿æ¥ä¸Šæœ‰æ•°æ®çš„æ—¶å€™ï¼Œçº¿ç¨‹æ‰å»å‘èµ·è¯»è¯·æ±‚å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œå®ç°è¿™ä¸€æŠ€æœ¯çš„å°±æ˜¯ I/O å¤šè·¯å¤ç”¨ã€‚

I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ä¼šç”¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°æ¥ç›‘å¬æˆ‘ä»¬æ‰€æœ‰å…³å¿ƒçš„è¿æ¥ï¼Œä¹Ÿå°±è¯´å¯ä»¥åœ¨ä¸€ä¸ªç›‘æ§çº¿ç¨‹é‡Œé¢ç›‘æ§å¾ˆå¤šçš„è¿æ¥ã€‚

![image-20220725152308276](images/image-20220725152308276.png)

æˆ‘ä»¬ç†Ÿæ‚‰çš„ select/poll/epoll å°±æ˜¯å†…æ ¸æä¾›ç»™ç”¨æˆ·æ€çš„å¤šè·¯å¤ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œçº¿ç¨‹å¯ä»¥é€šè¿‡ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ä»å†…æ ¸ä¸­è·å–å¤šä¸ªäº‹ä»¶ã€‚

select/poll/epoll æ˜¯å¦‚ä½•è·å–ç½‘ç»œäº‹ä»¶çš„å‘¢ï¼Ÿ

åœ¨è·å–äº‹ä»¶æ—¶ï¼Œå…ˆæŠŠæˆ‘ä»¬è¦å…³å¿ƒçš„è¿æ¥ä¼ ç»™å†…æ ¸ï¼Œå†ç”±å†…æ ¸æ£€æµ‹ï¼š

- å¦‚æœæ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹åªéœ€é˜»å¡åœ¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ— éœ€åƒå‰é¢çš„çº¿ç¨‹æ± æ–¹æ¡ˆé‚£æ ·è½®è®­è°ƒç”¨ read æ“ä½œæ¥åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®ã€‚
- å¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå†…æ ¸ä¼šè¿”å›äº§ç”Ÿäº†äº‹ä»¶çš„è¿æ¥ï¼Œçº¿ç¨‹å°±ä¼šä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œç„¶ååœ¨ç”¨æˆ·æ€ä¸­å†å¤„ç†è¿™äº›è¿æ¥å¯¹åº”çš„ä¸šåŠ¡å³å¯ã€‚

å½“ä¸‹å¼€æºè½¯ä»¶èƒ½åšåˆ°ç½‘ç»œé«˜æ€§èƒ½çš„åŸå› å°±æ˜¯ I/O å¤šè·¯å¤ç”¨å—ï¼Ÿ

æ˜¯çš„ï¼ŒåŸºæœ¬æ˜¯åŸºäº I/O å¤šè·¯å¤ç”¨ï¼Œç”¨è¿‡ I/O å¤šè·¯å¤ç”¨æ¥å£å†™ç½‘ç»œç¨‹åºçš„åŒå­¦ï¼Œè‚¯å®šçŸ¥é“æ˜¯é¢å‘è¿‡ç¨‹çš„æ–¹å¼å†™ä»£ç çš„ï¼Œè¿™æ ·çš„å¼€å‘çš„æ•ˆç‡ä¸é«˜ã€‚

äºæ˜¯ï¼Œå¤§ä½¬ä»¬åŸºäºé¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œå¯¹ I/O å¤šè·¯å¤ç”¨ä½œäº†ä¸€å±‚å°è£…ï¼Œè®©ä½¿ç”¨è€…ä¸ç”¨è€ƒè™‘åº•å±‚ç½‘ç»œ API çš„ç»†èŠ‚ï¼Œåªéœ€è¦å…³æ³¨åº”ç”¨ä»£ç çš„ç¼–å†™ã€‚

å¤§ä½¬ä»¬è¿˜ä¸ºè¿™ç§æ¨¡å¼å–äº†ä¸ªè®©äººç¬¬ä¸€æ—¶é—´éš¾ä»¥ç†è§£çš„åå­—ï¼š**Reactor æ¨¡å¼**ã€‚

Reactor ç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯ã€Œååº”å †ã€ï¼Œå¯èƒ½å¤§å®¶ä¼šè”æƒ³åˆ°ç‰©ç†å­¦é‡Œçš„æ ¸ååº”å †ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯çš„è¿™ä¸ªæ„æ€ã€‚

è¿™é‡Œçš„ååº”æŒ‡çš„æ˜¯ã€Œ**å¯¹äº‹ä»¶ååº”**ã€ï¼Œä¹Ÿå°±æ˜¯**æ¥äº†ä¸€ä¸ªäº‹ä»¶ï¼ŒReactor å°±æœ‰ç›¸å¯¹åº”çš„ååº”/å“åº”**ã€‚

äº‹å®ä¸Šï¼ŒReactor æ¨¡å¼ä¹Ÿå« `Dispatcher` æ¨¡å¼ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªåå­—æ›´è´´åˆè¯¥æ¨¡å¼çš„å«ä¹‰ï¼Œå³ **I/O å¤šè·¯å¤ç”¨ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œæ ¹æ®äº‹ä»¶ç±»å‹åˆ†é…ï¼ˆDispatchï¼‰ç»™æŸä¸ªè¿›ç¨‹ / çº¿ç¨‹**ã€‚

Reactor æ¨¡å¼ä¸»è¦ç”± Reactor å’Œå¤„ç†èµ„æºæ± è¿™ä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†ç»„æˆï¼Œå®ƒä¿©è´Ÿè´£çš„äº‹æƒ…å¦‚ä¸‹ï¼š

- Reactor è´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œäº‹ä»¶ç±»å‹åŒ…å«è¿æ¥äº‹ä»¶ã€è¯»å†™äº‹ä»¶ï¼›
- å¤„ç†èµ„æºæ± è´Ÿè´£å¤„ç†äº‹ä»¶ï¼Œå¦‚ read -> ä¸šåŠ¡é€»è¾‘ -> sendï¼›

Reactor æ¨¡å¼æ˜¯çµæ´»å¤šå˜çš„ï¼Œå¯ä»¥åº”å¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œçµæ´»åœ¨äºï¼š

- Reactor çš„æ•°é‡å¯ä»¥åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼›
- å¤„ç†èµ„æºæ± å¯ä»¥æ˜¯å•ä¸ªè¿›ç¨‹ / çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªè¿›ç¨‹ /çº¿ç¨‹ï¼›

å°†ä¸Šé¢çš„ä¸¤ä¸ªå› ç´ æ’åˆ—ç»„è®¾ä¸€ä¸‹ï¼Œç†è®ºä¸Šå°±å¯ä»¥æœ‰ 4 ç§æ–¹æ¡ˆé€‰æ‹©ï¼š

- å• Reactor å•è¿›ç¨‹ / çº¿ç¨‹ï¼›
- å• Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹ï¼›
- å¤š Reactor å•è¿›ç¨‹ / çº¿ç¨‹ï¼›
- å¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹ï¼›

å…¶ä¸­ï¼Œã€Œå¤š Reactor å•è¿›ç¨‹ / çº¿ç¨‹ã€å®ç°æ–¹æ¡ˆç›¸æ¯”ã€Œå• Reactor å•è¿›ç¨‹ / çº¿ç¨‹ã€æ–¹æ¡ˆï¼Œä¸ä»…å¤æ‚è€Œä¸”ä¹Ÿæ²¡æœ‰æ€§èƒ½ä¼˜åŠ¿ï¼Œå› æ­¤å®é™…ä¸­å¹¶æ²¡æœ‰åº”ç”¨ã€‚

å‰©ä¸‹çš„ 3 ä¸ªæ–¹æ¡ˆéƒ½æ˜¯æ¯”è¾ƒç»å…¸çš„ï¼Œä¸”éƒ½æœ‰åº”ç”¨åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼š

- å• Reactor å•è¿›ç¨‹ / çº¿ç¨‹ï¼›
- å• Reactor å¤šçº¿ç¨‹ / è¿›ç¨‹ï¼›
- å¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹ï¼›

æ–¹æ¡ˆå…·ä½“ä½¿ç”¨è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œè¦çœ‹ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€ä»¥åŠå¹³å°æœ‰å…³ï¼š

- Java è¯­è¨€ä¸€èˆ¬ä½¿ç”¨çº¿ç¨‹ï¼Œæ¯”å¦‚ Netty;
- C è¯­è¨€ä½¿ç”¨è¿›ç¨‹å’Œçº¿ç¨‹éƒ½å¯ä»¥ï¼Œä¾‹å¦‚ Nginx ä½¿ç”¨çš„æ˜¯è¿›ç¨‹ï¼ŒMemcache ä½¿ç”¨çš„æ˜¯çº¿ç¨‹ã€‚

æ¥ä¸‹æ¥ï¼Œåˆ†åˆ«ä»‹ç»è¿™ä¸‰ä¸ªç»å…¸çš„ Reactor æ–¹æ¡ˆã€‚

#### Reactor

##### å• Reactor å•è¿›ç¨‹ / çº¿ç¨‹

ä¸€èˆ¬æ¥è¯´ï¼ŒC è¯­è¨€å®ç°çš„æ˜¯ã€Œ**å• Reactor \*å•è¿›ç¨‹\***ã€çš„æ–¹æ¡ˆï¼Œå› ä¸º C è¯­ç¼–å†™å®Œçš„ç¨‹åºï¼Œè¿è¡Œåå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä¸éœ€è¦åœ¨è¿›ç¨‹ä¸­å†åˆ›å»ºçº¿ç¨‹ã€‚

è€Œ Java è¯­è¨€å®ç°çš„æ˜¯ã€Œ**å• Reactor \*å•çº¿ç¨‹\***ã€çš„æ–¹æ¡ˆï¼Œå› ä¸º Java ç¨‹åºæ˜¯è·‘åœ¨ Java è™šæ‹Ÿæœºè¿™ä¸ªè¿›ç¨‹ä¸Šé¢çš„ï¼Œè™šæ‹Ÿæœºä¸­æœ‰å¾ˆå¤šçº¿ç¨‹ï¼Œæˆ‘ä»¬å†™çš„ Java ç¨‹åºåªæ˜¯å…¶ä¸­çš„ä¸€ä¸ªçº¿ç¨‹è€Œå·²ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹ã€Œ**å• Reactor å•è¿›ç¨‹**ã€çš„æ–¹æ¡ˆç¤ºæ„å›¾ï¼š

![image-20220725152351105](images/image-20220725152351105.png)

å¯ä»¥çœ‹åˆ°è¿›ç¨‹é‡Œæœ‰ **Reactorã€Acceptorã€Handler** è¿™ä¸‰ä¸ªå¯¹è±¡ï¼š

- Reactor å¯¹è±¡çš„ä½œç”¨æ˜¯ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼›
- Acceptor å¯¹è±¡çš„ä½œç”¨æ˜¯è·å–è¿æ¥ï¼›
- Handler å¯¹è±¡çš„ä½œç”¨æ˜¯å¤„ç†ä¸šåŠ¡ï¼›

å¯¹è±¡é‡Œçš„ selectã€acceptã€readã€send æ˜¯ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œdispatch å’Œ ã€Œä¸šåŠ¡å¤„ç†ã€æ˜¯éœ€è¦å®Œæˆçš„æ“ä½œï¼Œå…¶ä¸­ dispatch æ˜¯åˆ†å‘äº‹ä»¶æ“ä½œã€‚

æ¥ä¸‹æ¥ï¼Œä»‹ç»ä¸‹ã€Œå• Reactor å•è¿›ç¨‹ã€è¿™ä¸ªæ–¹æ¡ˆï¼š

- Reactor å¯¹è±¡é€šè¿‡ select ï¼ˆIO å¤šè·¯å¤ç”¨æ¥å£ï¼‰ ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘ï¼Œå…·ä½“åˆ†å‘ç»™ Acceptor å¯¹è±¡è¿˜æ˜¯ Handler å¯¹è±¡ï¼Œè¿˜è¦çœ‹æ”¶åˆ°çš„äº‹ä»¶ç±»å‹ï¼›
- å¦‚æœæ˜¯è¿æ¥å»ºç«‹çš„äº‹ä»¶ï¼Œåˆ™äº¤ç”± Acceptor å¯¹è±¡è¿›è¡Œå¤„ç†ï¼ŒAcceptor å¯¹è±¡ä¼šé€šè¿‡ accept æ–¹æ³• è·å–è¿æ¥ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡æ¥å¤„ç†åç»­çš„å“åº”äº‹ä»¶ï¼›
- å¦‚æœä¸æ˜¯è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œ åˆ™äº¤ç”±å½“å‰è¿æ¥å¯¹åº”çš„ Handler å¯¹è±¡æ¥è¿›è¡Œå“åº”ï¼›
- Handler å¯¹è±¡é€šè¿‡ read -> ä¸šåŠ¡å¤„ç† -> send çš„æµç¨‹æ¥å®Œæˆå®Œæ•´çš„ä¸šåŠ¡æµç¨‹ã€‚

å• Reactor å•è¿›ç¨‹çš„æ–¹æ¡ˆå› ä¸ºå…¨éƒ¨å·¥ä½œéƒ½åœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…å®Œæˆï¼Œæ‰€ä»¥å®ç°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä¸éœ€è¦è€ƒè™‘è¿›ç¨‹é—´é€šä¿¡ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒå¤šè¿›ç¨‹ç«äº‰ã€‚

ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆå­˜åœ¨ 2 ä¸ªç¼ºç‚¹ï¼š

- ç¬¬ä¸€ä¸ªç¼ºç‚¹ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œ**æ— æ³•å……åˆ†åˆ©ç”¨ å¤šæ ¸ CPU çš„æ€§èƒ½**ï¼›
- ç¬¬äºŒä¸ªç¼ºç‚¹ï¼ŒHandler å¯¹è±¡åœ¨ä¸šåŠ¡å¤„ç†æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ˜¯æ— æ³•å¤„ç†å…¶ä»–è¿æ¥çš„äº‹ä»¶çš„ï¼Œ**å¦‚æœä¸šåŠ¡å¤„ç†è€—æ—¶æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆå°±é€ æˆå“åº”çš„å»¶è¿Ÿ**ï¼›

æ‰€ä»¥ï¼Œå• Reactor å•è¿›ç¨‹çš„æ–¹æ¡ˆ**ä¸é€‚ç”¨è®¡ç®—æœºå¯†é›†å‹çš„åœºæ™¯ï¼Œåªé€‚ç”¨äºä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿçš„åœºæ™¯**ã€‚

Redis æ˜¯ç”± C è¯­è¨€å®ç°çš„ï¼Œåœ¨ Redis 6.0 ç‰ˆæœ¬ä¹‹å‰é‡‡ç”¨çš„æ­£æ˜¯ã€Œå• Reactor å•è¿›ç¨‹ã€çš„æ–¹æ¡ˆï¼Œå› ä¸º Redis ä¸šåŠ¡å¤„ç†ä¸»è¦æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆï¼Œæ“ä½œçš„é€Ÿåº¦æ˜¯å¾ˆå¿«çš„ï¼Œæ€§èƒ½ç“¶é¢ˆä¸åœ¨ CPU ä¸Šï¼Œæ‰€ä»¥ Redis å¯¹äºå‘½ä»¤çš„å¤„ç†æ˜¯å•è¿›ç¨‹çš„æ–¹æ¡ˆã€‚



##### å• Reactor å¤šçº¿ç¨‹ / å¤šè¿›ç¨‹

å¦‚æœè¦å…‹æœã€Œå• Reactor å•çº¿ç¨‹ / è¿›ç¨‹ã€æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼Œé‚£ä¹ˆå°±éœ€è¦å¼•å…¥å¤šçº¿ç¨‹ / å¤šè¿›ç¨‹ï¼Œè¿™æ ·å°±äº§ç”Ÿäº†**å• Reactor å¤šçº¿ç¨‹ / å¤šè¿›ç¨‹**çš„æ–¹æ¡ˆã€‚

é—»å…¶åä¸å¦‚çœ‹å…¶å›¾ï¼Œå…ˆæ¥çœ‹çœ‹ã€Œå• Reactor å¤šçº¿ç¨‹ã€æ–¹æ¡ˆçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![image-20220725152423113](images/image-20220725152423113.png)

è¯¦ç»†è¯´ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆï¼š

- Reactor å¯¹è±¡é€šè¿‡ select ï¼ˆIO å¤šè·¯å¤ç”¨æ¥å£ï¼‰ ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘ï¼Œå…·ä½“åˆ†å‘ç»™ Acceptor å¯¹è±¡è¿˜æ˜¯ Handler å¯¹è±¡ï¼Œè¿˜è¦çœ‹æ”¶åˆ°çš„äº‹ä»¶ç±»å‹ï¼›
- å¦‚æœæ˜¯è¿æ¥å»ºç«‹çš„äº‹ä»¶ï¼Œåˆ™äº¤ç”± Acceptor å¯¹è±¡è¿›è¡Œå¤„ç†ï¼ŒAcceptor å¯¹è±¡ä¼šé€šè¿‡ accept æ–¹æ³• è·å–è¿æ¥ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡æ¥å¤„ç†åç»­çš„å“åº”äº‹ä»¶ï¼›
- å¦‚æœä¸æ˜¯è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œ åˆ™äº¤ç”±å½“å‰è¿æ¥å¯¹åº”çš„ Handler å¯¹è±¡æ¥è¿›è¡Œå“åº”ï¼›

ä¸Šé¢çš„ä¸‰ä¸ªæ­¥éª¤å’Œå• Reactor å•çº¿ç¨‹æ–¹æ¡ˆæ˜¯ä¸€æ ·çš„ï¼Œæ¥ä¸‹æ¥çš„æ­¥éª¤å°±å¼€å§‹ä¸ä¸€æ ·äº†ï¼š

- Handler å¯¹è±¡ä¸å†è´Ÿè´£ä¸šåŠ¡å¤„ç†ï¼Œåªè´Ÿè´£æ•°æ®çš„æ¥æ”¶å’Œå‘é€ï¼ŒHandler å¯¹è±¡é€šè¿‡ read è¯»å–åˆ°æ•°æ®åï¼Œä¼šå°†æ•°æ®å‘ç»™å­çº¿ç¨‹é‡Œçš„ Processor å¯¹è±¡è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼›
- å­çº¿ç¨‹é‡Œçš„ Processor å¯¹è±¡å°±è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¤„ç†å®Œåï¼Œå°†ç»“æœå‘ç»™ä¸»çº¿ç¨‹ä¸­çš„ Handler å¯¹è±¡ï¼Œæ¥ç€ç”± Handler é€šè¿‡ send æ–¹æ³•å°†å“åº”ç»“æœå‘é€ç»™ clientï¼›

å• Reator å¤šçº¿ç¨‹çš„æ–¹æ¡ˆä¼˜åŠ¿åœ¨äº**èƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„èƒ½**ï¼Œé‚£æ—¢ç„¶å¼•å…¥å¤šçº¿ç¨‹ï¼Œé‚£ä¹ˆè‡ªç„¶å°±å¸¦æ¥äº†å¤šçº¿ç¨‹ç«äº‰èµ„æºçš„é—®é¢˜ã€‚

ä¾‹å¦‚ï¼Œå­çº¿ç¨‹å®Œæˆä¸šåŠ¡å¤„ç†åï¼Œè¦æŠŠç»“æœä¼ é€’ç»™ä¸»çº¿ç¨‹çš„ Handler è¿›è¡Œå‘é€ï¼Œè¿™é‡Œæ¶‰åŠå…±äº«æ•°æ®çš„ç«äº‰ã€‚

è¦é¿å…å¤šçº¿ç¨‹ç”±äºç«äº‰å…±äº«èµ„æºè€Œå¯¼è‡´æ•°æ®é”™ä¹±çš„é—®é¢˜ï¼Œå°±éœ€è¦åœ¨æ“ä½œå…±äº«èµ„æºå‰åŠ ä¸Šäº’æ–¥é”ï¼Œä»¥ä¿è¯ä»»æ„æ—¶é—´é‡Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œå…±äº«èµ„æºï¼Œå¾…è¯¥çº¿ç¨‹æ“ä½œå®Œé‡Šæ”¾äº’æ–¥é”åï¼Œå…¶ä»–çº¿ç¨‹æ‰æœ‰æœºä¼šæ“ä½œå…±äº«æ•°æ®ã€‚

èŠå®Œå• Reactor å¤šçº¿ç¨‹çš„æ–¹æ¡ˆï¼Œæ¥ç€æ¥çœ‹çœ‹å• Reactor å¤šè¿›ç¨‹çš„æ–¹æ¡ˆã€‚

äº‹å®ä¸Šï¼Œå• Reactor å¤šè¿›ç¨‹ç›¸æ¯”å• Reactor å¤šçº¿ç¨‹å®ç°èµ·æ¥å¾ˆéº»çƒ¦ï¼Œä¸»è¦å› ä¸ºè¦è€ƒè™‘å­è¿›ç¨‹ <-> çˆ¶è¿›ç¨‹çš„åŒå‘é€šä¿¡ï¼Œå¹¶ä¸”çˆ¶è¿›ç¨‹è¿˜å¾—çŸ¥é“å­è¿›ç¨‹è¦å°†æ•°æ®å‘é€ç»™å“ªä¸ªå®¢æˆ·ç«¯ã€‚

è€Œå¤šçº¿ç¨‹é—´å¯ä»¥å…±äº«æ•°æ®ï¼Œè™½ç„¶è¦é¢å¤–è€ƒè™‘å¹¶å‘é—®é¢˜ï¼Œä½†æ˜¯è¿™è¿œæ¯”è¿›ç¨‹é—´é€šä¿¡çš„å¤æ‚åº¦ä½å¾—å¤šï¼Œå› æ­¤å®é™…åº”ç”¨ä¸­ä¹Ÿçœ‹ä¸åˆ°å• Reactor å¤šè¿›ç¨‹çš„æ¨¡å¼ã€‚

å¦å¤–ï¼Œã€Œå• Reactorã€çš„æ¨¡å¼è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œ**å› ä¸ºä¸€ä¸ª Reactor å¯¹è±¡æ‰¿æ‹…æ‰€æœ‰äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œè€Œä¸”åªåœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œåœ¨é¢å¯¹ç¬é—´é«˜å¹¶å‘çš„åœºæ™¯æ—¶ï¼Œå®¹æ˜“æˆä¸ºæ€§èƒ½çš„ç“¶é¢ˆçš„åœ°æ–¹**ã€‚



##### å¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹

è¦è§£å†³ã€Œå• Reactorã€çš„é—®é¢˜ï¼Œå°±æ˜¯å°†ã€Œå• Reactorã€å®ç°æˆã€Œå¤š Reactorã€ï¼Œè¿™æ ·å°±äº§ç”Ÿäº†ç¬¬ **å¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹**çš„æ–¹æ¡ˆã€‚

è€è§„çŸ©ï¼Œé—»å…¶åä¸å¦‚çœ‹å…¶å›¾ã€‚å¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹æ–¹æ¡ˆçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼ˆä»¥çº¿ç¨‹ä¸ºä¾‹ï¼‰ï¼š

![image-20220725152443546](images/image-20220725152443546.png)

æ–¹æ¡ˆè¯¦ç»†è¯´æ˜å¦‚ä¸‹ï¼š

- ä¸»çº¿ç¨‹ä¸­çš„ MainReactor å¯¹è±¡é€šè¿‡ select ç›‘æ§è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ Acceptor å¯¹è±¡ä¸­çš„ accept  è·å–è¿æ¥ï¼Œå°†æ–°çš„è¿æ¥åˆ†é…ç»™æŸä¸ªå­çº¿ç¨‹ï¼›
- å­çº¿ç¨‹ä¸­çš„ SubReactor å¯¹è±¡å°† MainReactor å¯¹è±¡åˆ†é…çš„è¿æ¥åŠ å…¥ select ç»§ç»­è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler ç”¨äºå¤„ç†è¿æ¥çš„å“åº”äº‹ä»¶ã€‚
- å¦‚æœæœ‰æ–°çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒSubReactor å¯¹è±¡ä¼šè°ƒç”¨å½“å‰è¿æ¥å¯¹åº”çš„ Handler å¯¹è±¡æ¥è¿›è¡Œå“åº”ã€‚
- Handler å¯¹è±¡é€šè¿‡ read -> ä¸šåŠ¡å¤„ç† -> send çš„æµç¨‹æ¥å®Œæˆå®Œæ•´çš„ä¸šåŠ¡æµç¨‹ã€‚

å¤š Reactor å¤šçº¿ç¨‹çš„æ–¹æ¡ˆè™½ç„¶çœ‹èµ·æ¥å¤æ‚çš„ï¼Œä½†æ˜¯å®é™…å®ç°æ—¶æ¯”å• Reactor å¤šçº¿ç¨‹çš„æ–¹æ¡ˆè¦ç®€å•çš„å¤šï¼ŒåŸå› å¦‚ä¸‹ï¼š

- ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹åˆ†å·¥æ˜ç¡®ï¼Œä¸»çº¿ç¨‹åªè´Ÿè´£æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹è´Ÿè´£å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†ã€‚
- ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„äº¤äº’å¾ˆç®€å•ï¼Œä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— é¡»è¿”å›æ•°æ®ï¼Œç›´æ¥å°±å¯ä»¥åœ¨å­çº¿ç¨‹å°†å¤„ç†ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚

å¤§åé¼é¼çš„ä¸¤ä¸ªå¼€æºè½¯ä»¶ Netty å’Œ Memcache éƒ½é‡‡ç”¨äº†ã€Œå¤š Reactor å¤šçº¿ç¨‹ã€çš„æ–¹æ¡ˆã€‚

é‡‡ç”¨äº†ã€Œå¤š Reactor å¤šè¿›ç¨‹ã€æ–¹æ¡ˆçš„å¼€æºè½¯ä»¶æ˜¯ Nginxï¼Œä¸è¿‡æ–¹æ¡ˆä¸æ ‡å‡†çš„å¤š Reactor å¤šè¿›ç¨‹æœ‰äº›å·®å¼‚ã€‚

å…·ä½“å·®å¼‚è¡¨ç°åœ¨ä¸»è¿›ç¨‹ä¸­ä»…ä»…ç”¨æ¥åˆå§‹åŒ– socketï¼Œå¹¶æ²¡æœ‰åˆ›å»º mainReactor æ¥ accept è¿æ¥ï¼Œè€Œæ˜¯ç”±å­è¿›ç¨‹çš„ Reactor æ¥ accept  è¿æ¥ï¼Œé€šè¿‡é”æ¥æ§åˆ¶ä¸€æ¬¡åªæœ‰ä¸€ä¸ªå­è¿›ç¨‹è¿›è¡Œ acceptï¼ˆé˜²æ­¢å‡ºç°æƒŠç¾¤ç°è±¡ï¼‰ï¼Œå­è¿›ç¨‹ accept æ–°è¿æ¥åå°±æ”¾åˆ°è‡ªå·±çš„ Reactor  è¿›è¡Œå¤„ç†ï¼Œä¸ä¼šå†åˆ†é…ç»™å…¶ä»–å­è¿›ç¨‹ã€‚



#### Proactor

å‰é¢æåˆ°çš„ Reactor æ˜¯éé˜»å¡åŒæ­¥ç½‘ç»œæ¨¡å¼ï¼Œè€Œ **Proactor æ˜¯å¼‚æ­¥ç½‘ç»œæ¨¡å¼**ã€‚

è¿™é‡Œå…ˆç»™å¤§å®¶å¤ä¹ ä¸‹é˜»å¡ã€éé˜»å¡ã€åŒæ­¥ã€å¼‚æ­¥ I/O çš„æ¦‚å¿µã€‚

å…ˆæ¥çœ‹çœ‹**é˜»å¡ I/O**ï¼Œå½“ç”¨æˆ·ç¨‹åºæ‰§è¡Œ `read` ï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œä¸€ç›´ç­‰åˆ°å†…æ ¸æ•°æ®å‡†å¤‡å¥½ï¼Œå¹¶æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºä¸­ï¼Œå½“æ‹·è´è¿‡ç¨‹å®Œæˆï¼Œ`read` æ‰ä¼šè¿”å›ã€‚

æ³¨æ„ï¼Œ**é˜»å¡ç­‰å¾…çš„æ˜¯ã€Œå†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€å’Œã€Œæ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ã€è¿™ä¸¤ä¸ªè¿‡ç¨‹**ã€‚è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![image-20220725152513494](images/image-20220725152513494.png)

çŸ¥é“äº†é˜»å¡ I/O ï¼Œæ¥çœ‹çœ‹**éé˜»å¡ I/O**ï¼Œéé˜»å¡çš„ read è¯·æ±‚åœ¨æ•°æ®æœªå‡†å¤‡å¥½çš„æƒ…å†µä¸‹ç«‹å³è¿”å›ï¼Œå¯ä»¥ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ­¤æ—¶åº”ç”¨ç¨‹åºä¸æ–­è½®è¯¢å†…æ ¸ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å¥½ï¼Œå†…æ ¸å°†æ•°æ®æ‹·è´åˆ°åº”ç”¨ç¨‹åºç¼“å†²åŒºï¼Œ`read` è°ƒç”¨æ‰å¯ä»¥è·å–åˆ°ç»“æœã€‚è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![image-20220725152523692](images/image-20220725152523692.png)

æ³¨æ„ï¼Œ**è¿™é‡Œæœ€åä¸€æ¬¡ read è°ƒç”¨ï¼Œè·å–æ•°æ®çš„è¿‡ç¨‹ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥çš„è¿‡ç¨‹ï¼Œæ˜¯éœ€è¦ç­‰å¾…çš„è¿‡ç¨‹ã€‚è¿™é‡Œçš„åŒæ­¥æŒ‡çš„æ˜¯å†…æ ¸æ€çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¨‹åºçš„ç¼“å­˜åŒºè¿™ä¸ªè¿‡ç¨‹ã€‚**

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœ socket è®¾ç½®äº† `O_NONBLOCK` æ ‡å¿—ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºä½¿ç”¨çš„æ˜¯éé˜»å¡ I/O çš„æ–¹å¼è®¿é—®ï¼Œè€Œä¸åšä»»ä½•è®¾ç½®çš„è¯ï¼Œé»˜è®¤æ˜¯é˜»å¡ I/Oã€‚

å› æ­¤ï¼Œæ— è®º read å’Œ send æ˜¯é˜»å¡ I/Oï¼Œè¿˜æ˜¯éé˜»å¡ I/O éƒ½æ˜¯åŒæ­¥è°ƒç”¨ã€‚å› ä¸ºåœ¨ read  è°ƒç”¨æ—¶ï¼Œå†…æ ¸å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„è¿‡ç¨‹éƒ½æ˜¯éœ€è¦ç­‰å¾…çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œå¦‚æœå†…æ ¸å®ç°çš„æ‹·è´æ•ˆç‡ä¸é«˜ï¼Œread  è°ƒç”¨å°±ä¼šåœ¨è¿™ä¸ªåŒæ­¥è¿‡ç¨‹ä¸­ç­‰å¾…æ¯”è¾ƒé•¿çš„æ—¶é—´ã€‚

è€ŒçœŸæ­£çš„**å¼‚æ­¥ I/O** æ˜¯ã€Œå†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€å’Œã€Œæ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ã€è¿™**ä¸¤ä¸ªè¿‡ç¨‹éƒ½ä¸ç”¨ç­‰å¾…**ã€‚

å½“æˆ‘ä»¬å‘èµ· `aio_read` ï¼ˆå¼‚æ­¥ I/Oï¼‰ ä¹‹åï¼Œå°±ç«‹å³è¿”å›ï¼Œå†…æ ¸è‡ªåŠ¨å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™ä¸ªæ‹·è´è¿‡ç¨‹åŒæ ·æ˜¯å¼‚æ­¥çš„ï¼Œå†…æ ¸è‡ªåŠ¨å®Œæˆçš„ï¼Œå’Œå‰é¢çš„åŒæ­¥æ“ä½œä¸ä¸€æ ·ï¼Œ**åº”ç”¨ç¨‹åºå¹¶ä¸éœ€è¦ä¸»åŠ¨å‘èµ·æ‹·è´åŠ¨ä½œ**ã€‚è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![image-20220725152532905](images/image-20220725152532905.png)

ä¸¾ä¸ªä½ å»é¥­å ‚åƒé¥­çš„ä¾‹å­ï¼Œä½ å¥½æ¯”åº”ç”¨ç¨‹åºï¼Œé¥­å ‚å¥½æ¯”æ“ä½œç³»ç»Ÿã€‚

é˜»å¡ I/O å¥½æ¯”ï¼Œä½ å»é¥­å ‚åƒé¥­ï¼Œä½†æ˜¯é¥­å ‚çš„èœè¿˜æ²¡åšå¥½ï¼Œç„¶åä½ å°±ä¸€ç›´åœ¨é‚£é‡Œç­‰å•Šç­‰ï¼Œç­‰äº†å¥½é•¿ä¸€æ®µæ—¶é—´ç»ˆäºç­‰åˆ°é¥­å ‚é˜¿å§¨æŠŠèœç«¯äº†å‡ºæ¥ï¼ˆæ•°æ®å‡†å¤‡çš„è¿‡ç¨‹ï¼‰ï¼Œä½†æ˜¯ä½ è¿˜å¾—ç»§ç»­ç­‰é˜¿å§¨æŠŠèœï¼ˆå†…æ ¸ç©ºé—´ï¼‰æ‰“åˆ°ä½ çš„é¥­ç›’é‡Œï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ï¼Œç»å†å®Œè¿™ä¸¤ä¸ªè¿‡ç¨‹ï¼Œä½ æ‰å¯ä»¥ç¦»å¼€ã€‚

éé˜»å¡ I/O å¥½æ¯”ï¼Œä½ å»äº†é¥­å ‚ï¼Œé—®é˜¿å§¨èœåšå¥½äº†æ²¡æœ‰ï¼Œé˜¿å§¨å‘Šè¯‰ä½ æ²¡ï¼Œä½ å°±ç¦»å¼€äº†ï¼Œè¿‡å‡ ååˆ†é’Ÿï¼Œä½ åˆæ¥é¥­å ‚é—®é˜¿å§¨ï¼Œé˜¿å§¨è¯´åšå¥½äº†ï¼Œäºæ˜¯é˜¿å§¨å¸®ä½ æŠŠèœæ‰“åˆ°ä½ çš„é¥­ç›’é‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ä½ æ˜¯å¾—ç­‰å¾…çš„ã€‚

å¼‚æ­¥ I/O å¥½æ¯”ï¼Œä½ è®©é¥­å ‚é˜¿å§¨å°†èœåšå¥½å¹¶æŠŠèœæ‰“åˆ°é¥­ç›’é‡Œåï¼ŒæŠŠé¥­ç›’é€åˆ°ä½ é¢å‰ï¼Œæ•´ä¸ªè¿‡ç¨‹ä½ éƒ½ä¸éœ€è¦ä»»ä½•ç­‰å¾…ã€‚

å¾ˆæ˜æ˜¾ï¼Œå¼‚æ­¥ I/O æ¯”åŒæ­¥ I/O æ€§èƒ½æ›´å¥½ï¼Œå› ä¸ºå¼‚æ­¥ I/O åœ¨ã€Œå†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€å’Œã€Œæ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€è¿™ä¸¤ä¸ªè¿‡ç¨‹éƒ½ä¸ç”¨ç­‰å¾…ã€‚

Proactor æ­£æ˜¯é‡‡ç”¨äº†å¼‚æ­¥ I/O æŠ€æœ¯ï¼Œæ‰€ä»¥è¢«ç§°ä¸ºå¼‚æ­¥ç½‘ç»œæ¨¡å‹ã€‚

ç°åœ¨æˆ‘ä»¬å†æ¥ç†è§£ Reactor å’Œ Proactor çš„åŒºåˆ«ï¼Œå°±æ¯”è¾ƒæ¸…æ™°äº†ã€‚

- **Reactor æ˜¯éé˜»å¡åŒæ­¥ç½‘ç»œæ¨¡å¼ï¼Œæ„ŸçŸ¥çš„æ˜¯å°±ç»ªå¯è¯»å†™äº‹ä»¶**ã€‚åœ¨æ¯æ¬¡æ„ŸçŸ¥åˆ°æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆæ¯”å¦‚å¯è¯»å°±ç»ªäº‹ä»¶ï¼‰åï¼Œå°±éœ€è¦åº”ç”¨è¿›ç¨‹ä¸»åŠ¨è°ƒç”¨ read æ–¹æ³•æ¥å®Œæˆæ•°æ®çš„è¯»å–ï¼Œä¹Ÿå°±æ˜¯è¦åº”ç”¨è¿›ç¨‹ä¸»åŠ¨å°† socket æ¥æ”¶ç¼“å­˜ä¸­çš„æ•°æ®è¯»åˆ°åº”ç”¨è¿›ç¨‹å†…å­˜ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œè¯»å–å®Œæ•°æ®ååº”ç”¨è¿›ç¨‹æ‰èƒ½å¤„ç†æ•°æ®ã€‚
- **Proactor æ˜¯å¼‚æ­¥ç½‘ç»œæ¨¡å¼ï¼Œ æ„ŸçŸ¥çš„æ˜¯å·²å®Œæˆçš„è¯»å†™äº‹ä»¶**ã€‚åœ¨å‘èµ·å¼‚æ­¥è¯»å†™è¯·æ±‚æ—¶ï¼Œéœ€è¦ä¼ å…¥æ•°æ®ç¼“å†²åŒºçš„åœ°å€ï¼ˆç”¨æ¥å­˜æ”¾ç»“æœæ•°æ®ï¼‰ç­‰ä¿¡æ¯ï¼Œè¿™æ ·ç³»ç»Ÿå†…æ ¸æ‰å¯ä»¥è‡ªåŠ¨å¸®æˆ‘ä»¬æŠŠæ•°æ®çš„è¯»å†™å·¥ä½œå®Œæˆï¼Œè¿™é‡Œçš„è¯»å†™å·¥ä½œå…¨ç¨‹ç”±æ“ä½œç³»ç»Ÿæ¥åšï¼Œå¹¶ä¸éœ€è¦åƒ Reactor é‚£æ ·è¿˜éœ€è¦åº”ç”¨è¿›ç¨‹ä¸»åŠ¨å‘èµ· read/write æ¥è¯»å†™æ•°æ®ï¼Œæ“ä½œç³»ç»Ÿå®Œæˆè¯»å†™å·¥ä½œåï¼Œå°±ä¼šé€šçŸ¥åº”ç”¨è¿›ç¨‹ç›´æ¥å¤„ç†æ•°æ®ã€‚

å› æ­¤ï¼Œ**Reactor å¯ä»¥ç†è§£ä¸ºã€Œæ¥äº†äº‹ä»¶æ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨è¿›ç¨‹ï¼Œè®©åº”ç”¨è¿›ç¨‹æ¥å¤„ç†ã€**ï¼Œè€Œ **Proactor å¯ä»¥ç†è§£ä¸ºã€Œæ¥äº†äº‹ä»¶æ“ä½œç³»ç»Ÿæ¥å¤„ç†ï¼Œå¤„ç†å®Œå†é€šçŸ¥åº”ç”¨è¿›ç¨‹ã€**ã€‚è¿™é‡Œçš„ã€Œäº‹ä»¶ã€å°±æ˜¯æœ‰æ–°è¿æ¥ã€æœ‰æ•°æ®å¯è¯»ã€æœ‰æ•°æ®å¯å†™çš„è¿™äº› I/O äº‹ä»¶è¿™é‡Œçš„ã€Œå¤„ç†ã€åŒ…å«ä»é©±åŠ¨è¯»å–åˆ°å†…æ ¸ä»¥åŠä»å†…æ ¸è¯»å–åˆ°ç”¨æˆ·ç©ºé—´ã€‚

ä¸¾ä¸ªå®é™…ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼ŒReactor æ¨¡å¼å°±æ˜¯å¿«é€’å‘˜åœ¨æ¥¼ä¸‹ï¼Œç»™ä½ æ‰“ç”µè¯å‘Šè¯‰ä½ å¿«é€’åˆ°ä½ å®¶å°åŒºäº†ï¼Œä½ éœ€è¦è‡ªå·±ä¸‹æ¥¼æ¥æ‹¿å¿«é€’ã€‚è€Œåœ¨ Proactor æ¨¡å¼ä¸‹ï¼Œå¿«é€’å‘˜ç›´æ¥å°†å¿«é€’é€åˆ°ä½ å®¶é—¨å£ï¼Œç„¶åé€šçŸ¥ä½ ã€‚

æ— è®ºæ˜¯ Reactorï¼Œè¿˜æ˜¯ Proactorï¼Œéƒ½æ˜¯ä¸€ç§åŸºäºã€Œäº‹ä»¶åˆ†å‘ã€çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼ï¼ŒåŒºåˆ«åœ¨äº **Reactor æ¨¡å¼æ˜¯åŸºäºã€Œå¾…å®Œæˆã€çš„ I/O äº‹ä»¶ï¼Œè€Œ Proactor æ¨¡å¼åˆ™æ˜¯åŸºäºã€Œå·²å®Œæˆã€çš„ I/O äº‹ä»¶**ã€‚

æ¥ä¸‹æ¥ï¼Œä¸€èµ·çœ‹çœ‹ Proactor æ¨¡å¼çš„ç¤ºæ„å›¾ï¼š

![image-20220725152542296](images/image-20220725152542296.png)

ä»‹ç»ä¸€ä¸‹ Proactor æ¨¡å¼çš„å·¥ä½œæµç¨‹ï¼š

- Proactor Initiator è´Ÿè´£åˆ›å»º Proactor å’Œ Handler å¯¹è±¡ï¼Œå¹¶å°† Proactor å’Œ Handler éƒ½é€šè¿‡ Asynchronous Operation Processor æ³¨å†Œåˆ°å†…æ ¸ï¼›
- Asynchronous Operation Processor è´Ÿè´£å¤„ç†æ³¨å†Œè¯·æ±‚ï¼Œå¹¶å¤„ç† I/O æ“ä½œï¼›
- Asynchronous Operation Processor å®Œæˆ I/O æ“ä½œåé€šçŸ¥ Proactorï¼›
- Proactor æ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹å›è°ƒä¸åŒçš„ Handler è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼›
- Handler å®Œæˆä¸šåŠ¡å¤„ç†ï¼›

å¯æƒœçš„æ˜¯ï¼Œåœ¨ Linux ä¸‹çš„å¼‚æ­¥ I/O æ˜¯ä¸å®Œå–„çš„ï¼Œ `aio` ç³»åˆ—å‡½æ•°æ˜¯ç”± POSIX  å®šä¹‰çš„å¼‚æ­¥æ“ä½œæ¥å£ï¼Œä¸æ˜¯çœŸæ­£çš„æ“ä½œç³»ç»Ÿçº§åˆ«æ”¯æŒçš„ï¼Œè€Œæ˜¯åœ¨ç”¨æˆ·ç©ºé—´æ¨¡æ‹Ÿå‡ºæ¥çš„å¼‚æ­¥ï¼Œå¹¶ä¸”ä»…ä»…æ”¯æŒåŸºäºæœ¬åœ°æ–‡ä»¶çš„ aio å¼‚æ­¥æ“ä½œï¼Œç½‘ç»œç¼–ç¨‹ä¸­çš„  socket æ˜¯ä¸æ”¯æŒçš„ï¼Œè¿™ä¹Ÿä½¿å¾—åŸºäº Linux çš„é«˜æ€§èƒ½ç½‘ç»œç¨‹åºéƒ½æ˜¯ä½¿ç”¨ Reactor æ–¹æ¡ˆã€‚

è€Œ Windows é‡Œå®ç°äº†ä¸€å¥—å®Œæ•´çš„æ”¯æŒ socket çš„å¼‚æ­¥ç¼–ç¨‹æ¥å£ï¼Œè¿™å¥—æ¥å£å°±æ˜¯ `IOCP`ï¼Œæ˜¯ç”±æ“ä½œç³»ç»Ÿçº§åˆ«å®ç°çš„å¼‚æ­¥ I/Oï¼ŒçœŸæ­£æ„ä¹‰ä¸Šå¼‚æ­¥ I/Oï¼Œå› æ­¤åœ¨ Windows é‡Œå®ç°é«˜æ€§èƒ½ç½‘ç»œç¨‹åºå¯ä»¥ä½¿ç”¨æ•ˆç‡æ›´é«˜çš„ Proactor æ–¹æ¡ˆã€‚



## ğŸƒ Springç³»åˆ—

### â­ï¸ springä¸­éƒ½æœ‰å“ªäº›è®¾è®¡æ¨¡å¼ï¼Ÿï¼ˆ2022çƒ­é—¨é—®é¢˜ï¼‰

1ã€**ç®€å•å·¥å‚æ¨¡å¼**ï¼š`BeanFactory`å°±æ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„ä½“ç°ï¼Œæ ¹æ®ä¼ å…¥ä¸€ä¸ªå”¯ä¸€æ ‡è¯†æ¥è·å¾— Bean å¯¹è±¡ã€‚

```java
@Override
public Object getBean(String name) throws BeansException {
    assertBeanFactoryActive();
    return getBeanFactory().getBean(name);
}
 
        Copied!
    
```

2ã€**å·¥å‚æ–¹æ³•æ¨¡å¼**ï¼š`FactoryBean`å°±æ˜¯å…¸å‹çš„å·¥å‚æ–¹æ³•æ¨¡å¼ã€‚springåœ¨ä½¿ç”¨`getBean()`è°ƒç”¨è·å¾—è¯¥beanæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨è¯¥beançš„`getObject()`æ–¹æ³•ã€‚æ¯ä¸ª Bean éƒ½ä¼šå¯¹åº”ä¸€ä¸ª `FactoryBean`ï¼Œå¦‚ `SqlSessionFactory` å¯¹åº” `SqlSessionFactoryBean`ã€‚

3ã€**å•ä¾‹æ¨¡å¼**ï¼šä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œæä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚Spring åˆ›å»º Bean å®ä¾‹é»˜è®¤æ˜¯å•ä¾‹çš„ã€‚

4ã€**é€‚é…å™¨æ¨¡å¼**ï¼šSpringMVCä¸­çš„é€‚é…å™¨`HandlerAdatper`ã€‚ç”±äºåº”ç”¨ä¼šæœ‰å¤šä¸ªControllerå®ç°ï¼Œå¦‚æœéœ€è¦ç›´æ¥è°ƒç”¨Controlleræ–¹æ³•ï¼Œé‚£ä¹ˆéœ€è¦å…ˆåˆ¤æ–­æ˜¯ç”±å“ªä¸€ä¸ªControllerå¤„ç†è¯·æ±‚ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚å½“å¢åŠ æ–°çš„ Controllerï¼Œéœ€è¦ä¿®æ”¹åŸæ¥çš„é€»è¾‘ï¼Œè¿åäº†å¼€é—­åŸåˆ™ï¼ˆå¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾ï¼‰ã€‚

ä¸ºæ­¤ï¼ŒSpringæä¾›äº†ä¸€ä¸ªé€‚é…å™¨æ¥å£ï¼Œæ¯ä¸€ç§ Controller å¯¹åº”ä¸€ç§ `HandlerAdapter` å®ç°ç±»ï¼Œå½“è¯·æ±‚è¿‡æ¥ï¼ŒSpringMVCä¼šè°ƒç”¨`getHandler()`è·å–ç›¸åº”çš„Controllerï¼Œç„¶åè·å–è¯¥Controllerå¯¹åº”çš„ `HandlerAdapter`ï¼Œæœ€åè°ƒç”¨`HandlerAdapter`çš„`handle()`æ–¹æ³•å¤„ç†è¯·æ±‚ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯Controllerçš„`handleRequest()`ã€‚æ¯æ¬¡æ·»åŠ æ–°çš„ Controller æ—¶ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªé€‚é…å™¨ç±»å°±å¯ä»¥ï¼Œæ— éœ€ä¿®æ”¹åŸæœ‰çš„é€»è¾‘ã€‚

å¸¸ç”¨çš„å¤„ç†å™¨é€‚é…å™¨ï¼š`SimpleControllerHandlerAdapter`ï¼Œ`HttpRequestHandlerAdapter`ï¼Œ`AnnotationMethodHandlerAdapter`ã€‚

```java
// Determine handler for the current request.
mappedHandler = getHandler(processedRequest);

HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());

// Actually invoke the handler.
mv = ha.handle(processedRequest, response, mappedHandler.getHandler());

public class HttpRequestHandlerAdapter implements HandlerAdapter {

    @Override
    public boolean supports(Object handler) {//handleræ˜¯è¢«é€‚é…çš„å¯¹è±¡ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯å¯¹è±¡çš„é€‚é…å™¨æ¨¡å¼
        return (handler instanceof HttpRequestHandler);
    }

    @Override
    @Nullable
    public ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler)
        throws Exception {

        ((HttpRequestHandler) handler).handleRequest(request, response);
        return null;
    }
}
```

5ã€**ä»£ç†æ¨¡å¼**ï¼šspring çš„ aop ä½¿ç”¨äº†åŠ¨æ€ä»£ç†ï¼Œæœ‰ä¸¤ç§æ–¹å¼`JdkDynamicAopProxy`å’Œ`Cglib2AopProxy`ã€‚

6ã€**è§‚å¯Ÿè€…æ¨¡å¼**ï¼šspring ä¸­ observer æ¨¡å¼å¸¸ç”¨çš„åœ°æ–¹æ˜¯ listener çš„å®ç°ï¼Œå¦‚`ApplicationListener`ã€‚

7ã€**æ¨¡æ¿æ¨¡å¼**ï¼š Spring ä¸­ `jdbcTemplate`ã€`hibernateTemplate` ç­‰ï¼Œå°±ä½¿ç”¨åˆ°äº†æ¨¡æ¿æ¨¡å¼ã€‚



> è¯¦ç»†

#### å·¥å‚è®¾è®¡æ¨¡å¼

Springä½¿ç”¨å·¥å‚æ¨¡å¼å¯ä»¥é€šè¿‡ `BeanFactory` æˆ– `ApplicationContext` åˆ›å»º bean å¯¹è±¡ã€‚

**ä¸¤è€…å¯¹æ¯”ï¼š**

- `BeanFactory` ï¼šå»¶è¿Ÿæ³¨å…¥(ä½¿ç”¨åˆ°æŸä¸ª bean çš„æ—¶å€™æ‰ä¼šæ³¨å…¥),ç›¸æ¯”äº `ApplicationContext` æ¥è¯´ä¼šå ç”¨æ›´å°‘çš„å†…å­˜ï¼Œç¨‹åºå¯åŠ¨é€Ÿåº¦æ›´å¿«ã€‚
- `ApplicationContext` ï¼šå®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¸ç®¡ä½ ç”¨æ²¡ç”¨åˆ°ï¼Œä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰ bean ã€‚`BeanFactory` ä»…æä¾›äº†æœ€åŸºæœ¬çš„ä¾èµ–æ³¨å…¥æ”¯æŒï¼Œ` ApplicationContext` æ‰©å±•äº† `BeanFactory` ,é™¤äº†æœ‰ `BeanFactory`çš„åŠŸèƒ½è¿˜æœ‰é¢å¤–æ›´å¤šåŠŸèƒ½ï¼Œæ‰€ä»¥ä¸€èˆ¬å¼€å‘äººå‘˜ä½¿ç”¨ ` ApplicationContext`ä¼šæ›´å¤šã€‚

ApplicationContextçš„ä¸‰ä¸ªå®ç°ç±»ï¼š

1. `ClassPathXmlApplication`ï¼šæŠŠä¸Šä¸‹æ–‡æ–‡ä»¶å½“æˆç±»è·¯å¾„èµ„æºã€‚
2. `FileSystemXmlApplication`ï¼šä»æ–‡ä»¶ç³»ç»Ÿä¸­çš„ XML æ–‡ä»¶è½½å…¥ä¸Šä¸‹æ–‡å®šä¹‰ä¿¡æ¯ã€‚
3. `XmlWebApplicationContext`ï¼šä»Webç³»ç»Ÿä¸­çš„XMLæ–‡ä»¶è½½å…¥ä¸Šä¸‹æ–‡å®šä¹‰ä¿¡æ¯ã€‚

Example:

```java
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.FileSystemXmlApplicationContext;
 
public class App {
	public static void main(String[] args) {
		ApplicationContext context = new FileSystemXmlApplicationContext(
				"C:/work/IOC Containers/springframework.applicationcontext/src/main/resources/bean-factory-config.xml");
 
		HelloApplicationContext obj = (HelloApplicationContext) context.getBean("helloApplicationContext");
		obj.getMsg();
	}
}
```

#### å•ä¾‹è®¾è®¡æ¨¡å¼

åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ï¼Œæœ‰ä¸€äº›å¯¹è±¡å…¶å®æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªï¼Œæ¯”å¦‚è¯´ï¼šçº¿ç¨‹æ± ã€ç¼“å­˜ã€å¯¹è¯æ¡†ã€æ³¨å†Œè¡¨ã€æ—¥å¿—å¯¹è±¡ã€å……å½“æ‰“å°æœºã€æ˜¾å¡ç­‰è®¾å¤‡é©±åŠ¨ç¨‹åºçš„å¯¹è±¡ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸€ç±»å¯¹è±¡åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¦‚æœåˆ¶é€ å‡ºå¤šä¸ªå®ä¾‹å°±å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜çš„äº§ç”Ÿï¼Œæ¯”å¦‚ï¼šç¨‹åºçš„è¡Œä¸ºå¼‚å¸¸ã€èµ„æºä½¿ç”¨è¿‡é‡ã€æˆ–è€…ä¸ä¸€è‡´æ€§çš„ç»“æœã€‚

**ä½¿ç”¨å•ä¾‹æ¨¡å¼çš„å¥½å¤„:**

- å¯¹äºé¢‘ç¹ä½¿ç”¨çš„å¯¹è±¡ï¼Œå¯ä»¥çœç•¥åˆ›å»ºå¯¹è±¡æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œè¿™å¯¹äºé‚£äº›é‡é‡çº§å¯¹è±¡è€Œè¨€ï¼Œæ˜¯éå¸¸å¯è§‚çš„ä¸€ç¬”ç³»ç»Ÿå¼€é”€ï¼›
- ç”±äº new æ“ä½œçš„æ¬¡æ•°å‡å°‘ï¼Œå› è€Œå¯¹ç³»ç»Ÿå†…å­˜çš„ä½¿ç”¨é¢‘ç‡ä¹Ÿä¼šé™ä½ï¼Œè¿™å°†å‡è½» GC å‹åŠ›ï¼Œç¼©çŸ­ GC åœé¡¿æ—¶é—´ã€‚

**Spring ä¸­ bean çš„é»˜è®¤ä½œç”¨åŸŸå°±æ˜¯ singleton(å•ä¾‹)çš„ã€‚** é™¤äº† singleton ä½œç”¨åŸŸï¼ŒSpring ä¸­ bean è¿˜æœ‰ä¸‹é¢å‡ ç§ä½œç”¨åŸŸï¼š

- prototype : æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ bean å®ä¾‹ã€‚
- request : æ¯ä¸€æ¬¡HTTPè¯·æ±‚éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„beanï¼Œè¯¥beanä»…åœ¨å½“å‰HTTP requestå†…æœ‰æ•ˆã€‚
- session : æ¯ä¸€æ¬¡HTTPè¯·æ±‚éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ beanï¼Œè¯¥beanä»…åœ¨å½“å‰ HTTP session å†…æœ‰æ•ˆã€‚
- global-sessionï¼š  å…¨å±€sessionä½œç”¨åŸŸï¼Œä»…ä»…åœ¨åŸºäºportletçš„webåº”ç”¨ä¸­æ‰æœ‰æ„ä¹‰ï¼ŒSpring5å·²ç»æ²¡æœ‰äº†ã€‚Portletæ˜¯èƒ½å¤Ÿç”Ÿæˆè¯­ä¹‰ä»£ç (ä¾‹å¦‚ï¼šHTML)ç‰‡æ®µçš„å°å‹Java Webæ’ä»¶ã€‚å®ƒä»¬åŸºäºportletå®¹å™¨ï¼Œå¯ä»¥åƒservletä¸€æ ·å¤„ç†HTTPè¯·æ±‚ã€‚ä½†æ˜¯ï¼Œä¸ servlet ä¸åŒï¼Œæ¯ä¸ª portlet  éƒ½æœ‰ä¸åŒçš„ä¼šè¯

**Spring å®ç°å•ä¾‹çš„æ–¹å¼ï¼š**

- xml : `<bean id="userService" class="top.snailclimb.UserService" scope="singleton"/>`
- æ³¨è§£ï¼š`@Scope(value = "singleton")`

**Spring é€šè¿‡ `ConcurrentHashMap` å®ç°å•ä¾‹æ³¨å†Œè¡¨çš„ç‰¹æ®Šæ–¹å¼å®ç°å•ä¾‹æ¨¡å¼ã€‚Spring å®ç°å•ä¾‹çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹**

```java
// é€šè¿‡ ConcurrentHashMapï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ å®ç°å•ä¾‹æ³¨å†Œè¡¨
private final Map<String, Object> singletonObjects = new ConcurrentHashMap<String, Object>(64);

public Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {
        Assert.notNull(beanName, "'beanName' must not be null");
        synchronized (this.singletonObjects) {
            // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨å®ä¾‹  
            Object singletonObject = this.singletonObjects.get(beanName);
            if (singletonObject == null) {
                //...çœç•¥äº†å¾ˆå¤šä»£ç 
                try {
                    singletonObject = singletonFactory.getObject();
                }
                //...çœç•¥äº†å¾ˆå¤šä»£ç 
                // å¦‚æœå®ä¾‹å¯¹è±¡åœ¨ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬æ³¨å†Œåˆ°å•ä¾‹æ³¨å†Œè¡¨ä¸­ã€‚
                addSingleton(beanName, singletonObject);
            }
            return (singletonObject != NULL_OBJECT ? singletonObject : null);
        }
    }
    //å°†å¯¹è±¡æ·»åŠ åˆ°å•ä¾‹æ³¨å†Œè¡¨
    protected void addSingleton(String beanName, Object singletonObject) {
            synchronized (this.singletonObjects) {
                this.singletonObjects.put(beanName, (singletonObject != null ? singletonObject : NULL_OBJECT));

            }
        }
}
```

#### ä»£ç†è®¾è®¡æ¨¡å¼

##### ä»£ç†æ¨¡å¼åœ¨ AOP ä¸­çš„åº”ç”¨

AOP(Aspect-Oriented Programming:é¢å‘åˆ‡é¢ç¼–ç¨‹)èƒ½å¤Ÿå°†é‚£äº›ä¸ä¸šåŠ¡æ— å…³ï¼Œ**å´ä¸ºä¸šåŠ¡æ¨¡å—æ‰€å…±åŒè°ƒç”¨çš„é€»è¾‘æˆ–è´£ä»»ï¼ˆä¾‹å¦‚äº‹åŠ¡å¤„ç†ã€æ—¥å¿—ç®¡ç†ã€æƒé™æ§åˆ¶ç­‰ï¼‰å°è£…èµ·æ¥**ï¼Œä¾¿äº**å‡å°‘ç³»ç»Ÿçš„é‡å¤ä»£ç **ï¼Œ**é™ä½æ¨¡å—é—´çš„è€¦åˆåº¦**ï¼Œå¹¶**æœ‰åˆ©äºæœªæ¥çš„å¯æ‹“å±•æ€§å’Œå¯ç»´æŠ¤æ€§**ã€‚

**Spring AOP å°±æ˜¯åŸºäºåŠ¨æ€ä»£ç†çš„**ï¼Œå¦‚æœè¦ä»£ç†çš„å¯¹è±¡ï¼Œå®ç°äº†æŸä¸ªæ¥å£ï¼Œé‚£ä¹ˆSpring AOPä¼šä½¿ç”¨**JDK Proxy**ï¼Œå»åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œè€Œå¯¹äºæ²¡æœ‰å®ç°æ¥å£çš„å¯¹è±¡ï¼Œå°±æ— æ³•ä½¿ç”¨ JDK Proxy å»è¿›è¡Œä»£ç†äº†ï¼Œè¿™æ—¶å€™Spring AOPä¼šä½¿ç”¨ **Cglib** ç”Ÿæˆä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡çš„å­ç±»æ¥ä½œä¸ºä»£ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220616162330096](./images/image-20220616162330096.png)

å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ AspectJ ,Spring AOP å·²ç»é›†æˆäº†AspectJ ï¼ŒAspectJ åº”è¯¥ç®—çš„ä¸Šæ˜¯ Java ç”Ÿæ€ç³»ç»Ÿä¸­æœ€å®Œæ•´çš„ AOP æ¡†æ¶äº†ã€‚

ä½¿ç”¨ AOP ä¹‹åæˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›é€šç”¨åŠŸèƒ½æŠ½è±¡å‡ºæ¥ï¼Œåœ¨éœ€è¦ç”¨åˆ°çš„åœ°æ–¹ç›´æ¥ä½¿ç”¨å³å¯ï¼Œè¿™æ ·å¤§å¤§ç®€åŒ–äº†ä»£ç é‡ã€‚æˆ‘ä»¬éœ€è¦å¢åŠ æ–°åŠŸèƒ½æ—¶ä¹Ÿæ–¹ä¾¿ï¼Œè¿™æ ·ä¹Ÿæé«˜äº†ç³»ç»Ÿæ‰©å±•æ€§ã€‚æ—¥å¿—åŠŸèƒ½ã€äº‹åŠ¡ç®¡ç†ç­‰ç­‰åœºæ™¯éƒ½ç”¨åˆ°äº† AOP ã€‚

#### æ¨¡æ¿æ–¹æ³•

æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œå®ƒå®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚ æ¨¡æ¿æ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤çš„å®ç°æ–¹å¼ã€‚

```java
public abstract class Template {
    //è¿™æ˜¯æˆ‘ä»¬çš„æ¨¡æ¿æ–¹æ³•
    public final void TemplateMethod(){
        PrimitiveOperation1();  
        PrimitiveOperation2();
        PrimitiveOperation3();
    }

    protected void  PrimitiveOperation1(){
        //å½“å‰ç±»å®ç°
    }
  
    //è¢«å­ç±»å®ç°çš„æ–¹æ³•
    protected abstract void PrimitiveOperation2();
    protected abstract void PrimitiveOperation3();

}
public class TemplateImpl extends Template {

    @Override
    public void PrimitiveOperation2() {
        //å½“å‰ç±»å®ç°
    }
  
    @Override
    public void PrimitiveOperation3() {
        //å½“å‰ç±»å®ç°
    }
}
```

Spring ä¸­ `jdbcTemplate`ã€`hibernateTemplate` ç­‰ä»¥ Template ç»“å°¾çš„å¯¹æ•°æ®åº“æ“ä½œçš„ç±»ï¼Œå®ƒä»¬å°±ä½¿ç”¨åˆ°äº†æ¨¡æ¿æ¨¡å¼ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼æ¥å®ç°æ¨¡æ¿æ¨¡å¼ï¼Œä½†æ˜¯ Spring å¹¶æ²¡æœ‰ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè€Œæ˜¯ä½¿ç”¨Callback æ¨¡å¼ä¸æ¨¡æ¿æ–¹æ³•æ¨¡å¼é…åˆï¼Œæ—¢è¾¾åˆ°äº†ä»£ç å¤ç”¨çš„æ•ˆæœï¼ŒåŒæ—¶å¢åŠ äº†çµæ´»æ€§ã€‚

#### è§‚å¯Ÿè€…æ¨¡å¼

è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§å¯¹è±¡è¡Œä¸ºå‹æ¨¡å¼ã€‚å®ƒè¡¨ç¤ºçš„æ˜¯ä¸€ç§å¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´å…·æœ‰ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œè¿™ä¸ªå¯¹è±¡æ‰€ä¾èµ–çš„å¯¹è±¡ä¹Ÿä¼šåšå‡ºååº”ã€‚Spring äº‹ä»¶é©±åŠ¨æ¨¡å‹å°±æ˜¯è§‚å¯Ÿè€…æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªåº”ç”¨ã€‚Spring  äº‹ä»¶é©±åŠ¨æ¨¡å‹éå¸¸æœ‰ç”¨ï¼Œåœ¨å¾ˆå¤šåœºæ™¯éƒ½å¯ä»¥è§£è€¦æˆ‘ä»¬çš„ä»£ç ã€‚æ¯”å¦‚æˆ‘ä»¬æ¯æ¬¡æ·»åŠ å•†å“çš„æ—¶å€™éƒ½éœ€è¦é‡æ–°æ›´æ–°å•†å“ç´¢å¼•ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥åˆ©ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

##### Spring äº‹ä»¶é©±åŠ¨æ¨¡å‹ä¸­çš„ä¸‰ç§è§’è‰²

###### äº‹ä»¶è§’è‰²

`ApplicationEvent` (`org.springframework.context`åŒ…ä¸‹)å……å½“äº‹ä»¶çš„è§’è‰²,è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»§æ‰¿äº† `java.util.EventObject`å¹¶å®ç°äº† `java.io.Serializable`æ¥å£ã€‚

Spring ä¸­é»˜è®¤å­˜åœ¨ä»¥ä¸‹äº‹ä»¶ï¼Œä»–ä»¬éƒ½æ˜¯å¯¹ `ApplicationContextEvent` çš„å®ç°(ç»§æ‰¿è‡ª `ApplicationContextEvent`)ï¼š

- `ContextStartedEvent`ï¼š`ApplicationContext` å¯åŠ¨åè§¦å‘çš„äº‹ä»¶;
- `ContextStoppedEvent`ï¼š`ApplicationContext` åœæ­¢åè§¦å‘çš„äº‹ä»¶;
- `ContextRefreshedEvent`ï¼š`ApplicationContext` åˆå§‹åŒ–æˆ–åˆ·æ–°å®Œæˆåè§¦å‘çš„äº‹ä»¶;
- `ContextClosedEvent`ï¼š`ApplicationContext` å…³é—­åè§¦å‘çš„äº‹ä»¶ã€‚

![image-20220616162504520](./images/image-20220616162504520.png)

###### äº‹ä»¶ç›‘å¬è€…è§’è‰²

`ApplicationListener` å……å½“äº†äº‹ä»¶ç›‘å¬è€…è§’è‰²ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢åªå®šä¹‰äº†ä¸€ä¸ª `onApplicationEventï¼ˆï¼‰`æ–¹æ³•æ¥å¤„ç† `ApplicationEvent`ã€‚`ApplicationListener`æ¥å£ç±»æºç å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºæ¥å£å®šä¹‰çœ‹å‡ºæ¥å£ä¸­çš„äº‹ä»¶åªè¦å®ç°äº† `ApplicationEvent`å°±å¯ä»¥äº†ã€‚æ‰€ä»¥ï¼Œåœ¨ Springä¸­æˆ‘ä»¬åªè¦å®ç° `ApplicationListener` æ¥å£çš„ `onApplicationEvent()` æ–¹æ³•å³å¯å®Œæˆç›‘å¬äº‹ä»¶

```java
package org.springframework.context;
import java.util.EventListener;
@FunctionalInterface
public interface ApplicationListener<E extends ApplicationEvent> extends EventListener {
    void onApplicationEvent(E var1);
}
```

###### äº‹ä»¶å‘å¸ƒè€…è§’è‰²

`ApplicationEventPublisher` å……å½“äº†äº‹ä»¶çš„å‘å¸ƒè€…ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ã€‚

```java
@FunctionalInterface
public interface ApplicationEventPublisher {
    default void publishEvent(ApplicationEvent event) {
        this.publishEvent((Object)event);
    }

    void publishEvent(Object var1);
}
```

`ApplicationEventPublisher` æ¥å£çš„ `publishEventï¼ˆï¼‰`è¿™ä¸ªæ–¹æ³•åœ¨ `AbstractApplicationContext`ç±»ä¸­è¢«å®ç°ï¼Œé˜…è¯»è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œä½ ä¼šå‘ç°å®é™…ä¸Šäº‹ä»¶çœŸæ­£æ˜¯é€šè¿‡ `ApplicationEventMulticaster`æ¥å¹¿æ’­å‡ºå»çš„ã€‚

#### é€‚é…å™¨æ¨¡å¼

é€‚é…å™¨æ¨¡å¼(Adapter Pattern) å°†ä¸€ä¸ªæ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼Œé€‚é…å™¨æ¨¡å¼ä½¿æ¥å£ä¸å…¼å®¹çš„é‚£äº›ç±»å¯ä»¥ä¸€èµ·å·¥ä½œï¼Œå…¶åˆ«åä¸ºåŒ…è£…å™¨(Wrapper)ã€‚

##### spring AOPä¸­çš„é€‚é…å™¨æ¨¡å¼

æˆ‘ä»¬çŸ¥é“ Spring AOP çš„å®ç°æ˜¯åŸºäºä»£ç†æ¨¡å¼ï¼Œä½†æ˜¯ Spring AOP çš„å¢å¼ºæˆ–é€šçŸ¥(Advice)ä½¿ç”¨åˆ°äº†é€‚é…å™¨æ¨¡å¼ï¼Œä¸ä¹‹ç›¸å…³çš„æ¥å£æ˜¯ `AdvisorAdapter ` ã€‚Advice å¸¸ç”¨çš„ç±»å‹æœ‰ï¼š`BeforeAdvice`ï¼ˆç›®æ ‡æ–¹æ³•è°ƒç”¨å‰,å‰ç½®é€šçŸ¥ï¼‰ã€`AfterAdvice`ï¼ˆç›®æ ‡æ–¹æ³•è°ƒç”¨å,åç½®é€šçŸ¥ï¼‰ã€`AfterReturningAdvice`(ç›®æ ‡æ–¹æ³•æ‰§è¡Œç»“æŸåï¼Œreturnä¹‹å‰)ç­‰ç­‰ã€‚æ¯ä¸ªç±»å‹Adviceï¼ˆé€šçŸ¥ï¼‰éƒ½æœ‰å¯¹åº”çš„æ‹¦æˆªå™¨:`MethodBeforeAdviceInterceptor`ã€`AfterReturningAdviceAdapter`ã€`AfterReturningAdviceInterceptor`ã€‚Springé¢„å®šä¹‰çš„é€šçŸ¥è¦é€šè¿‡å¯¹åº”çš„é€‚é…å™¨ï¼Œé€‚é…æˆ `MethodInterceptor`æ¥å£(æ–¹æ³•æ‹¦æˆªå™¨)ç±»å‹çš„å¯¹è±¡ï¼ˆå¦‚ï¼š`MethodBeforeAdviceInterceptor` è´Ÿè´£é€‚é… `MethodBeforeAdvice`ï¼‰ã€‚

##### spring MVCä¸­çš„é€‚é…å™¨æ¨¡å¼

åœ¨Spring MVCä¸­ï¼Œ`DispatcherServlet` æ ¹æ®è¯·æ±‚ä¿¡æ¯è°ƒç”¨ `HandlerMapping`ï¼Œè§£æè¯·æ±‚å¯¹åº”çš„ `Handler`ã€‚è§£æåˆ°å¯¹åº”çš„ `Handler`ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸è¯´çš„ `Controller` æ§åˆ¶å™¨ï¼‰åï¼Œå¼€å§‹ç”± `HandlerAdapter` é€‚é…å™¨å¤„ç†ã€‚`HandlerAdapter` ä½œä¸ºæœŸæœ›æ¥å£ï¼Œå…·ä½“çš„é€‚é…å™¨å®ç°ç±»ç”¨äºå¯¹ç›®æ ‡ç±»è¿›è¡Œé€‚é…ï¼Œ`Controller` ä½œä¸ºéœ€è¦é€‚é…çš„ç±»ã€‚

**ä¸ºä»€ä¹ˆè¦åœ¨ Spring MVC ä¸­ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Ÿ** Spring MVC ä¸­çš„ `Controller` ç§ç±»ä¼—å¤šï¼Œä¸åŒç±»å‹çš„ `Controller` é€šè¿‡ä¸åŒçš„æ–¹æ³•æ¥å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚å¦‚æœä¸åˆ©ç”¨é€‚é…å™¨æ¨¡å¼çš„è¯ï¼Œ`DispatcherServlet` ç›´æ¥è·å–å¯¹åº”ç±»å‹çš„ `Controller`ï¼Œéœ€è¦çš„è‡ªè¡Œæ¥åˆ¤æ–­ï¼Œåƒä¸‹é¢è¿™æ®µä»£ç ä¸€æ ·ï¼š

```java
if(mappedHandler.getHandler() instanceof MultiActionController){  
   ((MultiActionController)mappedHandler.getHandler()).xxx  
}else if(mappedHandler.getHandler() instanceof XXX){  
    ...  
}else if(...){  
   ...  
}  
```

å‡å¦‚æˆ‘ä»¬å†å¢åŠ ä¸€ä¸ª `Controller`ç±»å‹å°±è¦åœ¨ä¸Šé¢ä»£ç ä¸­å†åŠ å…¥ä¸€è¡Œ åˆ¤æ–­è¯­å¥ï¼Œè¿™ç§å½¢å¼å°±ä½¿å¾—ç¨‹åºéš¾ä»¥ç»´æŠ¤ï¼Œä¹Ÿè¿åäº†è®¾è®¡æ¨¡å¼ä¸­çš„å¼€é—­åŸåˆ™ â€“ å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚

#### è£…é¥°è€…æ¨¡å¼

è£…é¥°è€…æ¨¡å¼å¯ä»¥åŠ¨æ€åœ°ç»™å¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„å±æ€§æˆ–è¡Œä¸ºã€‚ç›¸æ¯”äºä½¿ç”¨ç»§æ‰¿ï¼Œè£…é¥°è€…æ¨¡å¼æ›´åŠ çµæ´»ã€‚ç®€å•ç‚¹å„¿è¯´å°±æ˜¯å½“æˆ‘ä»¬éœ€è¦ä¿®æ”¹åŸæœ‰çš„åŠŸèƒ½ï¼Œä½†æˆ‘ä»¬åˆä¸æ„¿ç›´æ¥å»ä¿®æ”¹åŸæœ‰çš„ä»£ç æ—¶ï¼Œè®¾è®¡ä¸€ä¸ªDecoratorå¥—åœ¨åŸæœ‰ä»£ç å¤–é¢ã€‚å…¶å®åœ¨ JDK ä¸­å°±æœ‰å¾ˆå¤šåœ°æ–¹ç”¨åˆ°äº†è£…é¥°è€…æ¨¡å¼ï¼Œæ¯”å¦‚ `InputStream`å®¶æ—ï¼Œ`InputStream` ç±»ä¸‹æœ‰ `FileInputStream` (è¯»å–æ–‡ä»¶)ã€`BufferedInputStream` (å¢åŠ ç¼“å­˜,ä½¿è¯»å–æ–‡ä»¶é€Ÿåº¦å¤§å¤§æå‡)ç­‰å­ç±»éƒ½åœ¨ä¸ä¿®æ”¹ `InputStream` ä»£ç çš„æƒ…å†µä¸‹æ‰©å±•äº†å®ƒçš„åŠŸèƒ½ã€‚

![image-20220616162704781](./images/image-20220616162704781.png)

Spring ä¸­é…ç½® DataSource çš„æ—¶å€™ï¼ŒDataSource  å¯èƒ½æ˜¯ä¸åŒçš„æ•°æ®åº“å’Œæ•°æ®æºã€‚æˆ‘ä»¬èƒ½å¦æ ¹æ®å®¢æˆ·çš„éœ€æ±‚åœ¨å°‘ä¿®æ”¹åŸæœ‰ç±»çš„ä»£ç ä¸‹åŠ¨æ€åˆ‡æ¢ä¸åŒçš„æ•°æ®æºï¼Ÿè¿™ä¸ªæ—¶å€™å°±è¦ç”¨åˆ°è£…é¥°è€…æ¨¡å¼(è¿™ä¸€ç‚¹æˆ‘è‡ªå·±è¿˜æ²¡å¤ªç†è§£å…·ä½“åŸç†)ã€‚Spring ä¸­ç”¨åˆ°çš„åŒ…è£…å™¨æ¨¡å¼åœ¨ç±»åä¸Šå«æœ‰ `Wrapper`æˆ–è€… `Decorator`ã€‚è¿™äº›ç±»åŸºæœ¬ä¸Šéƒ½æ˜¯åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£

### SpringBootå¯åŠ¨æµç¨‹

![image-20220627213051378](./images/image-20220627213051378.png)

### Beanç”Ÿå‘½å‘¨æœŸ

![img](./images/20220709213529.png)

1.è°ƒç”¨beançš„æ„é€ æ–¹æ³•åˆ›å»ºBean

2.é€šè¿‡åå°„è°ƒç”¨setteræ–¹æ³•è¿›è¡Œå±æ€§çš„ä¾èµ–æ³¨å…¥

3.å¦‚æœBeanå®ç°äº†`BeanNameAware`æ¥å£ï¼ŒSpringå°†è°ƒç”¨`setBeanName`()ï¼Œè®¾ç½® `Bean`çš„nameï¼ˆxmlæ–‡ä»¶ä¸­beanæ ‡ç­¾çš„idï¼‰

4.å¦‚æœBeanå®ç°äº†`BeanFactoryAware`æ¥å£ï¼ŒSpringå°†è°ƒç”¨`setBeanFactory()`æŠŠbean factoryè®¾ç½®ç»™Bean

5.å¦‚æœå­˜åœ¨`BeanPostProcessor`ï¼ŒSpringå°†è°ƒç”¨å®ƒä»¬çš„`postProcessBeforeInitialization`ï¼ˆé¢„åˆå§‹åŒ–ï¼‰æ–¹æ³•ï¼Œåœ¨Beanåˆå§‹åŒ–å‰å¯¹å…¶è¿›è¡Œå¤„ç†

6.å¦‚æœBeanå®ç°äº†`InitializingBean`æ¥å£ï¼ŒSpringå°†è°ƒç”¨å®ƒçš„`afterPropertiesSet`æ–¹æ³•ï¼Œç„¶åè°ƒç”¨xmlå®šä¹‰çš„ init-method æ–¹æ³•ï¼Œä¸¤ä¸ªæ–¹æ³•ä½œç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯åœ¨åˆå§‹åŒ– bean çš„æ—¶å€™æ‰§è¡Œ

7.å¦‚æœå­˜åœ¨`BeanPostProcessor`ï¼ŒSpringå°†è°ƒç”¨å®ƒä»¬çš„`postProcessAfterInitialization`ï¼ˆååˆå§‹åŒ–ï¼‰æ–¹æ³•ï¼Œåœ¨Beanåˆå§‹åŒ–åå¯¹å…¶è¿›è¡Œå¤„ç†

8.Beanåˆå§‹åŒ–å®Œæˆï¼Œä¾›åº”ç”¨ä½¿ç”¨ï¼Œè¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µï¼š

8.1 å¦‚æœBeanä¸ºå•ä¾‹çš„è¯ï¼Œé‚£ä¹ˆå®¹å™¨ä¼šè¿”å›Beanç»™ç”¨æˆ·ï¼Œå¹¶å­˜å…¥ç¼“å­˜æ± ã€‚å¦‚æœBeanå®ç°äº†`DisposableBean`æ¥å£ï¼ŒSpringå°†è°ƒç”¨å®ƒçš„`destory`æ–¹æ³•ï¼Œç„¶åè°ƒç”¨åœ¨xmlä¸­å®šä¹‰çš„ `destory-method`æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä½œç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯åœ¨Beanå®ä¾‹é”€æ¯å‰æ‰§è¡Œã€‚

8.2 å¦‚æœBeanæ˜¯å¤šä¾‹çš„è¯ï¼Œå®¹å™¨å°†Beanè¿”å›ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„ç”Ÿå‘½å‘¨æœŸç”±ç”¨æˆ·æ§åˆ¶ã€‚



### @Autowired å’Œ @Resource çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

Spring å†…ç½®çš„ `@Autowired` ä»¥åŠ JDK å†…ç½®çš„ `@Resource` å’Œ `@Inject` éƒ½å¯ä»¥ç”¨äºæ³¨å…¥ Beanã€‚

| Annotaion      | Package                              | Source       |
| :------------- | :----------------------------------- | :----------- |
| `@Autowired` | `org.springframework.bean.factory` | Spring 2.5+  |
| `@Resource`  | `javax.annotation`                 | Java JSR-250 |
| `@Inject`    | `javax.inject`                     | Java JSR-330 |

`@Autowired` å’Œ `@Resource`ä½¿ç”¨çš„æ¯”è¾ƒå¤šä¸€äº›ã€‚

`Autowired` å±äº Spring å†…ç½®çš„æ³¨è§£ï¼Œé»˜è®¤çš„æ³¨å…¥æ–¹å¼ä¸º `byType`ï¼ˆæ ¹æ®ç±»å‹è¿›è¡ŒåŒ¹é…ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šä¼˜å…ˆæ ¹æ®æ¥å£ç±»å‹å»åŒ¹é…å¹¶æ³¨å…¥ Bean ï¼ˆæ¥å£çš„å®ç°ç±»ï¼‰ã€‚

**è¿™ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ** å½“ä¸€ä¸ªæ¥å£å­˜åœ¨å¤šä¸ªå®ç°ç±»çš„è¯ï¼Œ`byType`è¿™ç§æ–¹å¼å°±æ— æ³•æ­£ç¡®æ³¨å…¥å¯¹è±¡äº†ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ Spring ä¼šåŒæ—¶æ‰¾åˆ°å¤šä¸ªæ»¡è¶³æ¡ä»¶çš„é€‰æ‹©ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒè‡ªå·±ä¸çŸ¥é“é€‰æ‹©å“ªä¸€ä¸ªã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œæ³¨å…¥æ–¹å¼ä¼šå˜ä¸º `byName`ï¼ˆæ ¹æ®åç§°è¿›è¡ŒåŒ¹é…ï¼‰ï¼Œè¿™ä¸ªåç§°é€šå¸¸å°±æ˜¯ç±»åï¼ˆé¦–å­—æ¯å°å†™ï¼‰ã€‚å°±æ¯”å¦‚è¯´ä¸‹é¢ä»£ç ä¸­çš„ `smsService` å°±æ˜¯æˆ‘è¿™é‡Œæ‰€è¯´çš„åç§°ï¼Œè¿™æ ·åº”è¯¥æ¯”è¾ƒå¥½ç†è§£äº†å§ã€‚

```java
// smsService å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„åç§°
@Autowired
private SmsService smsService;
```

ä¸¾ä¸ªä¾‹å­ï¼Œ`SmsService` æ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»: `SmsServiceImpl1`å’Œ `SmsServiceImpl2`ï¼Œä¸”å®ƒä»¬éƒ½å·²ç»è¢« Spring å®¹å™¨æ‰€ç®¡ç†ã€‚

```java
// æŠ¥é”™ï¼ŒbyName å’Œ byType éƒ½æ— æ³•åŒ¹é…åˆ° bean
@Autowired
private SmsService smsService;
// æ­£ç¡®æ³¨å…¥ SmsServiceImpl1 å¯¹è±¡å¯¹åº”çš„ bean
@Autowired
private SmsService smsServiceImpl1;
// æ­£ç¡®æ³¨å…¥  SmsServiceImpl1 å¯¹è±¡å¯¹åº”çš„ bean
// smsServiceImpl1 å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„åç§°
@Autowired
@Qualifier(value = "smsServiceImpl1")
private SmsService smsService;
```

æˆ‘ä»¬è¿˜æ˜¯å»ºè®®é€šè¿‡ `@Qualifier` æ³¨è§£æ¥æ˜¾ç¤ºæŒ‡å®šåç§°è€Œä¸æ˜¯ä¾èµ–å˜é‡çš„åç§°ã€‚

`@Resource`å±äº JDK æä¾›çš„æ³¨è§£ï¼Œé»˜è®¤æ³¨å…¥æ–¹å¼ä¸º `byName`ã€‚å¦‚æœæ— æ³•é€šè¿‡åç§°åŒ¹é…åˆ°å¯¹åº”çš„å®ç°ç±»çš„è¯ï¼Œæ³¨å…¥æ–¹å¼ä¼šå˜ä¸º `byType`ã€‚

`@Resource` æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦ä¸”æ—¥å¸¸å¼€å‘å¸¸ç”¨çš„å±æ€§ï¼š`name`ï¼ˆåç§°ï¼‰ã€`type`ï¼ˆç±»å‹ï¼‰ã€‚

```java
public @interface Resource {
    String name() default "";
    Class<?> type() default Object.class;
}
```

å¦‚æœä»…æŒ‡å®š `name` å±æ€§åˆ™æ³¨å…¥æ–¹å¼ä¸º `byName`ï¼Œå¦‚æœä»…æŒ‡å®š `type`å±æ€§åˆ™æ³¨å…¥æ–¹å¼ä¸º `byType`ï¼Œå¦‚æœåŒæ—¶æŒ‡å®š `name` å’Œ `type`å±æ€§ï¼ˆä¸å»ºè®®è¿™ä¹ˆåšï¼‰åˆ™æ³¨å…¥æ–¹å¼ä¸º `byType`+`byName`ã€‚

```java
// æŠ¥é”™ï¼ŒbyName å’Œ byType éƒ½æ— æ³•åŒ¹é…åˆ° bean
@Resource
private SmsService smsService;
// æ­£ç¡®æ³¨å…¥ SmsServiceImpl1 å¯¹è±¡å¯¹åº”çš„ bean
@Resource
private SmsService smsServiceImpl1;
// æ­£ç¡®æ³¨å…¥ SmsServiceImpl1 å¯¹è±¡å¯¹åº”çš„ beanï¼ˆæ¯”è¾ƒæ¨èè¿™ç§æ–¹å¼ï¼‰

@Resource(name = "smsServiceImpl1")
private SmsService smsService;
```

ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š

- `@Autowired` æ˜¯ Spring æä¾›çš„æ³¨è§£ï¼Œ`@Resource` æ˜¯ JDK æä¾›çš„æ³¨è§£ã€‚
- `Autowired` é»˜è®¤çš„æ³¨å…¥æ–¹å¼ä¸º `byType`ï¼ˆæ ¹æ®ç±»å‹è¿›è¡ŒåŒ¹é…ï¼‰ï¼Œ`@Resource`é»˜è®¤æ³¨å…¥æ–¹å¼ä¸º `byName`ï¼ˆæ ¹æ®åç§°è¿›è¡ŒåŒ¹é…ï¼‰ã€‚
- å½“ä¸€ä¸ªæ¥å£å­˜åœ¨å¤šä¸ªå®ç°ç±»çš„æƒ…å†µä¸‹ï¼Œ`@Autowired` å’Œ `@Resource`éƒ½éœ€è¦é€šè¿‡åç§°æ‰èƒ½æ­£ç¡®åŒ¹é…åˆ°å¯¹åº”çš„ Beanã€‚`Autowired` å¯ä»¥é€šè¿‡ `@Qualifier` æ³¨è§£æ¥æ˜¾ç¤ºæŒ‡å®šåç§°ï¼Œ`@Resource`å¯ä»¥é€šè¿‡ `name` å±æ€§æ¥æ˜¾ç¤ºæŒ‡å®šåç§°ã€‚

### è¯·æè¿°Spring MVCçš„å·¥ä½œæµç¨‹ï¼Ÿæè¿°ä¸€ä¸‹ DispatcherServlet çš„å·¥ä½œæµç¨‹ï¼Ÿ

1. ç”¨æˆ·å‘é€requestè¯·æ±‚åˆ°å‰ç«¯æ§åˆ¶å™¨DispatcherServletã€‚
2. å‰ç«¯æ§åˆ¶å™¨DispatcherServleté€šè¿‡requestè¯·æ±‚çš„urlåœ°å€ï¼Œå‘æ˜ å°„å™¨HandlerMappingè¯·æ±‚è°ƒç”¨å¯¹åº”çš„å¤„ç†å™¨handlerã€‚
3. æ˜ å°„å™¨HandlerMappingé€šè¿‡urlåœ°å€ç”Ÿäº§å¤„ç†å™¨æ‰§è¡Œé“¾å¹¶è¿”å›ã€‚
4. DispatcherServletæ ¹æ®å¤„ç†å™¨Handlerè·å–å¤„ç†å™¨é€‚é…å™¨HandlerAdapteræ‰§è¡ŒHandlerAdapterå¤„ç†ä¸€ç³»åˆ—çš„æ“ä½œï¼Œå¦‚ï¼šå‚æ•°å°è£…ï¼Œæ•°æ®æ ¼å¼è½¬æ¢ï¼Œæ•°æ®éªŒè¯ç­‰æ“ä½œã€‚
5. é€‚é…å™¨æ‰§è¡Œå¤„ç†å™¨ï¼Œå³æ‰§è¡ŒControllerä¸­çš„æ–¹æ³•ã€‚
6. å¤„ç†å™¨å®Œæˆä¸šåŠ¡é€»è¾‘åè¿”å›ModelAndViewã€‚
7. é€‚é…å™¨å°†å¤„ç†å™¨çš„å¤„ç†ç»“æœè¿”å›ç»™å‰ç«¯æ§åˆ¶å™¨DispatcherServletã€‚
8. å°†ModelAndViewä¸­çš„viewåç§°ä¼ ç»™viewResloverã€‚
9. viewResloveré€šè¿‡viewåç§°è¿”å›å…·ä½“çš„viewã€‚
10. å°†ModelAndViewä¸­çš„modelæ³¨å…¥åˆ°viewã€‚
11. å°†æœ€ç»ˆç»è¿‡è§†å›¾æ¸²æŸ“çš„viewé¡µé¢å“åº”ç»™ç”¨æˆ·ã€‚

![image-20220711133221313](./images/image-20220711133221313.png)



### Springä¸­æ„é€ æ–¹æ³•æ³¨å…¥å’Œè®¾å€¼æ³¨å…¥æœ‰ä»€ä¹ˆåŒºåˆ«

æ„é€ å™¨é€šè¿‡æ„é€ æ–¹æ³•å®ç°ï¼Œæ„é€ æ–¹æ³•æœ‰æ— å‚æ•°éƒ½å¯ä»¥ã€‚åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯é€šè¿‡ç±»çš„æ„é€ å™¨æ¥åˆ›å»ºå¯¹è±¡ï¼ŒSpringä¹Ÿå¯ä»¥é‡‡ç”¨åå°„æœºåˆ¶é€šè¿‡æ„é€ å™¨å®Œæˆæ³¨å…¥ï¼Œè¿™å°±æ˜¯æ„é€ å™¨æ³¨å…¥çš„åŸç†ã€‚

```java
public class Role {

    private long id;
    private String roleName;

    public Role(long id,String roleName){
        this.id=id;
        this.roleName=roleName;

    }
    public void getCount(){
        System.out.println("Roleå·²è¢«è°ƒç”¨"+"\n"+"id:"+id+"\n"+"roleName:"+roleName);
    }
}
```

setteræ³¨å…¥æ˜¯Springä¸­æœ€ä¸»æµçš„æ³¨å…¥æ–¹æ³•ï¼ˆå¸¸ç”¨ï¼‰ï¼Œå¥½å¤„å°±ä¸ç”¨å¤šè¯´äº†ã€‚åŸç†ä¹Ÿæ˜¯é€šè¿‡åå°„æ³¨å…¥ï¼Œç›´æ¥ä¸Šä»£ç ã€‚ï¼ˆæ³¨æ„å¯¹åº”çš„å®ä½“ç±»å±æ€§å¿…é¡»å®ç°setï¼Œgetæ–¹æ³•ã€‚å¦‚æœå®ä½“ç±»æ²¡æœ‰å±æ€§ä¹Ÿä¼šè¢«æ³¨å…¥ï¼‰ã€‚

```java
public class Role {

    public long getId() {
        return id;
    }
    public void setId(long id) {
        this.id = id;
    }
    public String getRoleName() {
        return roleName;
    }
    public void setRoleName(String roleName) {
        this.roleName = roleName;
    }
    private long id;
    private String roleName;
}
```



### Springæ€ä¹ˆè§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Ÿ

**æ„é€ å™¨æ³¨å…¥çš„å¾ªç¯ä¾èµ–ï¼šSpringå¤„ç†ä¸äº†**ï¼Œç›´æ¥æŠ›å‡º`BeanCurrentlylnCreationException`å¼‚å¸¸ã€‚

å•ä¾‹æ¨¡å¼ä¸‹å±æ€§æ³¨å…¥çš„å¾ªç¯ä¾èµ–ï¼šé€šè¿‡**ä¸‰çº§ç¼“å­˜å¤„ç†å¾ªç¯ä¾èµ–**ã€‚

éå•ä¾‹å¾ªç¯ä¾èµ–ï¼šæ— æ³•å¤„ç†ã€‚

> **Springä¸ºä½•ä¸èƒ½è§£å†³éå•ä¾‹å±æ€§ä¹‹å¤–çš„å¾ªç¯ä¾èµ–ï¼Ÿ**
>
> Springä¸ºä»€ä¹ˆä¸èƒ½è§£å†³æ„é€ å™¨çš„å¾ªç¯ä¾èµ–ï¼Ÿ
>
> æ„é€ å™¨æ³¨å…¥å½¢æˆçš„å¾ªç¯ä¾èµ–ï¼š ä¹Ÿå°±æ˜¯beanBéœ€è¦åœ¨beanAçš„æ„é€ å‡½æ•°ä¸­å®Œæˆåˆå§‹åŒ–ï¼ŒbeanAä¹Ÿéœ€è¦åœ¨beanBçš„æ„é€ å‡½æ•°ä¸­å®Œæˆåˆå§‹åŒ–ï¼Œè¿™ç§æƒ…å†µçš„ç»“æœå°±æ˜¯ä¸¤ä¸ªbeanéƒ½ä¸èƒ½å®Œæˆåˆå§‹åŒ–ï¼Œå¾ªç¯ä¾èµ–éš¾ä»¥è§£å†³ã€‚
>
> Springè§£å†³å¾ªç¯ä¾èµ–ä¸»è¦æ˜¯ä¾èµ–ä¸‰çº§ç¼“å­˜ï¼Œä½†æ˜¯çš„**åœ¨è°ƒç”¨æ„é€ æ–¹æ³•ä¹‹å‰è¿˜æœªå°†å…¶æ”¾å…¥ä¸‰çº§ç¼“å­˜ä¹‹ä¸­**ï¼Œå› æ­¤åç»­çš„ä¾èµ–è°ƒç”¨æ„é€ æ–¹æ³•çš„æ—¶å€™å¹¶ä¸èƒ½ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–åˆ°ä¾èµ–çš„Beanï¼Œå› æ­¤ä¸èƒ½è§£å†³ã€‚
>
> ---
>
> Springä¸ºä»€ä¹ˆä¸èƒ½è§£å†³prototypeä½œç”¨åŸŸå¾ªç¯ä¾èµ–ï¼Ÿ
>
> è¿™ç§å¾ªç¯ä¾èµ–åŒæ ·æ— æ³•è§£å†³ï¼Œå› ä¸ºspringä¸ä¼šç¼“å­˜â€˜prototypeâ€™ä½œç”¨åŸŸçš„beanï¼Œè€Œspringä¸­å¾ªç¯ä¾èµ–çš„è§£å†³æ­£æ˜¯é€šè¿‡ç¼“å­˜æ¥å®ç°çš„ã€‚
>
> ---
>
> Springä¸ºä»€ä¹ˆä¸èƒ½è§£å†³å¤šä¾‹çš„å¾ªç¯ä¾èµ–ï¼Ÿ
>
> å¤šå®ä¾‹Beanæ˜¯æ¯æ¬¡è°ƒç”¨ä¸€æ¬¡getBeanéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡æ„é€ æ–¹æ³•å¹¶ä¸”ç»™å±æ€§èµ‹å€¼ï¼Œæ ¹æœ¬æ²¡æœ‰ä¸‰çº§ç¼“å­˜ï¼Œå› æ­¤ä¸èƒ½è§£å†³å¾ªç¯ä¾èµ–ã€‚

ä¸‹é¢åˆ†æå•ä¾‹æ¨¡å¼ä¸‹å±æ€§æ³¨å…¥çš„å¾ªç¯ä¾èµ–æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼š

é¦–å…ˆï¼ŒSpringå•ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–å¤§ç•¥åˆ†ä¸ºä¸‰æ­¥ï¼š

1. `createBeanInstance`ï¼šå®ä¾‹åŒ–beanï¼Œä½¿ç”¨æ„é€ æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼Œä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚
2. `populateBean`ï¼šè¿›è¡Œä¾èµ–æ³¨å…¥ã€‚
3. `initializeBean`ï¼šåˆå§‹åŒ–beanã€‚

Springä¸ºäº†è§£å†³å•ä¾‹çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œä½¿ç”¨äº†ä¸‰çº§ç¼“å­˜ï¼š

`singletonObjects`ï¼šå®Œæˆäº†åˆå§‹åŒ–çš„å•ä¾‹å¯¹è±¡mapï¼Œbean name --> bean instance

`earlySingletonObjects`ï¼šå®Œæˆå®ä¾‹åŒ–æœªåˆå§‹åŒ–çš„å•ä¾‹å¯¹è±¡mapï¼Œbean name --> bean instance

`singletonFactories`ï¼š å•ä¾‹å¯¹è±¡å·¥å‚mapï¼Œbean name --> ObjectFactoryï¼Œå•ä¾‹å¯¹è±¡å®ä¾‹åŒ–å®Œæˆä¹‹åä¼šåŠ å…¥singletonFactoriesã€‚

åœ¨è°ƒç”¨createBeanInstanceè¿›è¡Œå®ä¾‹åŒ–ä¹‹åï¼Œä¼šè°ƒç”¨addSingletonFactoryï¼Œå°†å•ä¾‹å¯¹è±¡æ”¾åˆ°singletonFactoriesä¸­ã€‚

```java
protected void addSingletonFactory(String beanName, ObjectFactory<?> singletonFactory) {
    Assert.notNull(singletonFactory, "Singleton factory must not be null");
    synchronized (this.singletonObjects) {
        if (!this.singletonObjects.containsKey(beanName)) {
            this.singletonFactories.put(beanName, singletonFactory);
            this.earlySingletonObjects.remove(beanName);
            this.registeredSingletons.add(beanName);
        }
    }
}
```

å‡å¦‚Aä¾èµ–äº†Bçš„å®ä¾‹å¯¹è±¡ï¼ŒåŒæ—¶Bä¹Ÿä¾èµ–Açš„å®ä¾‹å¯¹è±¡ã€‚

1. Aé¦–å…ˆå®Œæˆäº†å®ä¾‹åŒ–ï¼Œå¹¶ä¸”å°†è‡ªå·±æ·»åŠ åˆ°singletonFactoriesä¸­
2. æ¥ç€è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå‘ç°è‡ªå·±ä¾èµ–å¯¹è±¡Bï¼Œæ­¤æ—¶å°±å°è¯•å»get(B)
3. å‘ç°Bè¿˜æ²¡æœ‰è¢«å®ä¾‹åŒ–ï¼Œå¯¹Bè¿›è¡Œå®ä¾‹åŒ–
4. ç„¶åBåœ¨åˆå§‹åŒ–çš„æ—¶å€™å‘ç°è‡ªå·±ä¾èµ–äº†å¯¹è±¡Aï¼Œäºæ˜¯å°è¯•get(A)ï¼Œå°è¯•ä¸€çº§ç¼“å­˜singletonObjectså’ŒäºŒçº§ç¼“å­˜earlySingletonObjectsæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä¸‰çº§ç¼“å­˜singletonFactoriesï¼Œç”±äºAåˆå§‹åŒ–æ—¶å°†è‡ªå·±æ·»åŠ åˆ°äº†singletonFactoriesï¼Œæ‰€ä»¥Bå¯ä»¥æ‹¿åˆ°Aå¯¹è±¡ï¼Œç„¶åå°†Aä»ä¸‰çº§ç¼“å­˜ä¸­ç§»åˆ°äºŒçº§ç¼“å­˜ä¸­
5. Bæ‹¿åˆ°Aå¯¹è±¡åé¡ºåˆ©å®Œæˆäº†åˆå§‹åŒ–ï¼Œç„¶åå°†è‡ªå·±æ”¾å…¥åˆ°ä¸€çº§ç¼“å­˜singletonObjectsä¸­
6. æ­¤æ—¶è¿”å›Aä¸­ï¼ŒAæ­¤æ—¶èƒ½æ‹¿åˆ°Bçš„å¯¹è±¡é¡ºåˆ©å®Œæˆè‡ªå·±çš„åˆå§‹åŒ–

ç”±æ­¤çœ‹å‡ºï¼Œå±æ€§æ³¨å…¥çš„å¾ªç¯ä¾èµ–ä¸»è¦æ˜¯é€šè¿‡å°†å®ä¾‹åŒ–å®Œæˆçš„beanæ·»åŠ åˆ°singletonFactoriesæ¥å®ç°çš„ã€‚è€Œä½¿ç”¨æ„é€ å™¨ä¾èµ–æ³¨å…¥çš„beanåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼šè¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œä¸ä¼šè¢«æ·»åŠ åˆ°singletonFactoriesä¸­ã€‚æ¯”å¦‚Aå’ŒBéƒ½æ˜¯é€šè¿‡æ„é€ å™¨ä¾èµ–æ³¨å…¥ï¼ŒAåœ¨è°ƒç”¨æ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå‘ç°è‡ªå·±ä¾èµ–Bï¼ŒBæ²¡æœ‰è¢«å®ä¾‹åŒ–ï¼Œå°±ä¼šå¯¹Bè¿›è¡Œå®ä¾‹åŒ–ï¼Œæ­¤æ—¶Aæœªå®ä¾‹åŒ–å®Œæˆï¼Œä¸ä¼šè¢«æ·»åŠ åˆ°singtonFactoriesã€‚è€ŒBä¾èµ–äºAï¼ŒBä¼šå»ä¸‰çº§ç¼“å­˜å¯»æ‰¾Aå¯¹è±¡ï¼Œå‘ç°ä¸å­˜åœ¨ï¼Œäºæ˜¯åˆä¼šå®ä¾‹åŒ–Aï¼ŒAå®ä¾‹åŒ–äº†ä¸¤æ¬¡ï¼Œä»è€Œå¯¼è‡´æŠ›å¼‚å¸¸ã€‚

æ€»ç»“ï¼š1ã€åˆ©ç”¨ç¼“å­˜è¯†åˆ«å·²ç»éå†è¿‡çš„èŠ‚ç‚¹ï¼› 2ã€åˆ©ç”¨Javaå¼•ç”¨ï¼Œå…ˆæå‰è®¾ç½®å¯¹è±¡åœ°å€ï¼Œåå®Œå–„å¯¹è±¡ã€‚



## ğŸ¬ MYSQL

### MySql åŸºç¡€æ¶æ„ | ä¸€æ¡ SQL æŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„

![image-20220613104147805](./images/image-20220613104147805.png)

- **è¿æ¥å™¨ï¼š** èº«ä»½è®¤è¯å’Œæƒé™ç›¸å…³(ç™»å½• MySQL çš„æ—¶å€™)ã€‚
- **æŸ¥è¯¢ç¼“å­˜ï¼š** æ‰§è¡ŒæŸ¥è¯¢è¯­å¥çš„æ—¶å€™ï¼Œä¼šå…ˆæŸ¥è¯¢ç¼“å­˜ï¼ˆMySQL 8.0 ç‰ˆæœ¬åç§»é™¤ï¼Œå› ä¸ºè¿™ä¸ªåŠŸèƒ½ä¸å¤ªå®ç”¨ï¼‰ã€‚
- **åˆ†æå™¨ï¼š** æ²¡æœ‰å‘½ä¸­ç¼“å­˜çš„è¯ï¼ŒSQL è¯­å¥å°±ä¼šç»è¿‡åˆ†æå™¨ï¼Œåˆ†æå™¨è¯´ç™½äº†å°±æ˜¯è¦å…ˆçœ‹ä½ çš„ SQL è¯­å¥è¦å¹²å˜›ï¼Œå†æ£€æŸ¥ä½ çš„ SQL è¯­å¥è¯­æ³•æ˜¯å¦æ­£ç¡®ã€‚
- **ä¼˜åŒ–å™¨ï¼š** æŒ‰ç…§ MySQL è®¤ä¸ºæœ€ä¼˜çš„æ–¹æ¡ˆå»æ‰§è¡Œã€‚
- **æ‰§è¡Œå™¨ï¼š** æ‰§è¡Œè¯­å¥ï¼Œç„¶åä»å­˜å‚¨å¼•æ“è¿”å›æ•°æ®ã€‚ æ‰§è¡Œè¯­å¥ä¹‹å‰ä¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰æƒé™ï¼Œå¦‚æœæ²¡æœ‰æƒé™çš„è¯ï¼Œå°±ä¼šæŠ¥é”™ã€‚
- **æ’ä»¶å¼å­˜å‚¨å¼•æ“** ï¼š ä¸»è¦è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œè¯»å–ï¼Œé‡‡ç”¨çš„æ˜¯æ’ä»¶å¼æ¶æ„ï¼Œæ”¯æŒ InnoDBã€MyISAMã€Memory ç­‰å¤šç§å­˜å‚¨å¼•æ“ã€‚

### â­MyISAM å’Œ InnoDB çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

é™¤äº†6ï¼Œéƒ½æ˜¯InnoDBæ”¯æŒï¼Œå‰è€…ä¸æ”¯æŒ

**1.æ˜¯å¦æ”¯æŒè¡Œçº§é”**

**2.æ˜¯å¦æ”¯æŒäº‹åŠ¡**

**3.æ˜¯å¦æ”¯æŒå¤–é”®**

**4.æ˜¯å¦æ”¯æŒæ•°æ®åº“å¼‚å¸¸å´©æºƒåçš„å®‰å…¨æ¢å¤**

> MyISAM ä¸æ”¯æŒï¼Œè€Œ InnoDB æ”¯æŒã€‚
>
> ä½¿ç”¨ InnoDB çš„æ•°æ®åº“åœ¨å¼‚å¸¸å´©æºƒåï¼Œæ•°æ®åº“é‡æ–°å¯åŠ¨çš„æ—¶å€™ä¼šä¿è¯æ•°æ®åº“æ¢å¤åˆ°å´©æºƒå‰çš„çŠ¶æ€ã€‚è¿™ä¸ªæ¢å¤çš„è¿‡ç¨‹ä¾èµ–äº `redo log` ã€‚

**5.æ˜¯å¦æ”¯æŒ MVCC**

**6.ç´¢å¼•å®ç°ä¸ä¸€æ ·ã€‚**

> è™½ç„¶ MyISAM å¼•æ“å’Œ InnoDB å¼•æ“éƒ½æ˜¯ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä½†æ˜¯ä¸¤è€…çš„å®ç°æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚
>
> InnoDB å¼•æ“ä¸­ï¼Œå…¶æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ç´¢å¼•æ–‡ä»¶ã€‚ç›¸æ¯” MyISAMï¼Œç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œå…¶è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰ B+Tree ç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œæ ‘çš„å¶èŠ‚ç‚¹ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚

### æ•°æ®åº“çš„ç´¢å¼•åˆ†ç±»

- æŒ‰ã€Œæ•°æ®ç»“æ„ã€åˆ†ç±»ï¼š**B+treeç´¢å¼•ã€Hashç´¢å¼•ã€Full-textç´¢å¼•**ã€‚
- æŒ‰ã€Œç‰©ç†å­˜å‚¨ã€åˆ†ç±»ï¼š**èšç°‡ç´¢å¼•ï¼ˆä¸»é”®ç´¢å¼•ï¼‰ã€äºŒçº§ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ï¼‰**ã€‚
- æŒ‰ã€Œå­—æ®µç‰¹æ€§ã€åˆ†ç±»ï¼š**ä¸»é”®ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€æ™®é€šç´¢å¼•ã€å‰ç¼€ç´¢å¼•**ã€‚
- æŒ‰ã€Œå­—æ®µä¸ªæ•°ã€åˆ†ç±»ï¼š**å•åˆ—ç´¢å¼•ã€è”åˆç´¢å¼•**ã€‚

> xia'm

#### æŒ‰æ•°æ®ç»“æ„åˆ†ç±»

ä»æ•°æ®ç»“æ„çš„è§’åº¦æ¥çœ‹ï¼ŒMySQL å¸¸è§ç´¢å¼•æœ‰ B+Tree ç´¢å¼•ã€HASH ç´¢å¼•ã€Full-Text ç´¢å¼•ã€‚

æ¯ä¸€ç§å­˜å‚¨å¼•æ“æ”¯æŒçš„ç´¢å¼•ç±»å‹ä¸ä¸€å®šç›¸åŒï¼Œæˆ‘åœ¨è¡¨ä¸­æ€»ç»“äº† MySQL å¸¸è§çš„å­˜å‚¨å¼•æ“ InnoDBã€MyISAM å’Œ Memory åˆ†åˆ«æ”¯æŒçš„ç´¢å¼•ç±»å‹ã€‚

![image-20220712154456833](./images/image-20220712154456833.png)

InnoDB æ˜¯åœ¨ MySQL 5.5 ä¹‹åæˆä¸ºé»˜è®¤çš„ MySQL å­˜å‚¨å¼•æ“ï¼ŒB+Tree ç´¢å¼•ç±»å‹ä¹Ÿæ˜¯ MySQL å­˜å‚¨å¼•æ“é‡‡ç”¨æœ€å¤šçš„ç´¢å¼•ç±»å‹ã€‚

åœ¨åˆ›å»ºè¡¨æ—¶ï¼ŒInnoDB å­˜å‚¨å¼•æ“ä¼šæ ¹æ®ä¸åŒçš„åœºæ™¯é€‰æ‹©ä¸åŒçš„åˆ—ä½œä¸ºç´¢å¼•ï¼š

- å¦‚æœæœ‰ä¸»é”®ï¼Œé»˜è®¤ä¼šä½¿ç”¨ä¸»é”®ä½œä¸ºèšç°‡ç´¢å¼•çš„ç´¢å¼•é”®ï¼ˆkeyï¼‰ï¼›
- å¦‚æœæ²¡æœ‰ä¸»é”®ï¼Œå°±é€‰æ‹©ç¬¬ä¸€ä¸ªä¸åŒ…å« NULL å€¼çš„å”¯ä¸€åˆ—ä½œä¸ºèšç°‡ç´¢å¼•çš„ç´¢å¼•é”®ï¼ˆkeyï¼‰ï¼›
- åœ¨ä¸Šé¢ä¸¤ä¸ªéƒ½æ²¡æœ‰çš„æƒ…å†µä¸‹ï¼ŒInnoDB å°†è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšå¼è‡ªå¢ id åˆ—ä½œä¸ºèšç°‡ç´¢å¼•çš„ç´¢å¼•é”®ï¼ˆkeyï¼‰ï¼›

å…¶å®ƒç´¢å¼•éƒ½å±äºè¾…åŠ©ç´¢å¼•ï¼ˆSecondary Indexï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•æˆ–éèšç°‡ç´¢å¼•ã€‚**åˆ›å»ºçš„ä¸»é”®ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•é»˜è®¤ä½¿ç”¨çš„æ˜¯ B+Tree ç´¢å¼•**ã€‚

ä¸¾ä¸ªğŸŒ°ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªè¡¨

![image-20220712154548420](./images/image-20220712154548420.png)

è¿™äº›è¡Œæ•°æ®ï¼Œå­˜å‚¨åœ¨ B+Tree ç´¢å¼•æ—¶æ˜¯é•¿ä»€ä¹ˆæ ·å­çš„ï¼Ÿ

B+Tree æ˜¯ä¸€ç§å¤šå‰æ ‘ï¼Œå¶å­èŠ‚ç‚¹æ‰å­˜æ”¾æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜æ”¾ç´¢å¼•ï¼Œè€Œä¸”æ¯ä¸ªèŠ‚ç‚¹é‡Œçš„æ•°æ®æ˜¯**æŒ‰ä¸»é”®é¡ºåºå­˜æ”¾**çš„ã€‚æ¯ä¸€å±‚çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•å€¼éƒ½ä¼šå‡ºç°åœ¨ä¸‹å±‚å­èŠ‚ç‚¹çš„ç´¢å¼•å€¼ä¸­ï¼Œå› æ­¤åœ¨å¶å­èŠ‚ç‚¹ä¸­ï¼ŒåŒ…æ‹¬äº†æ‰€æœ‰çš„ç´¢å¼•å€¼ä¿¡æ¯ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹éƒ½æŒ‡å‘ä¸‹ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œå½¢æˆä¸€ä¸ªé“¾è¡¨ã€‚

ä¸»é”®ç´¢å¼•çš„ B+Tree å¦‚å›¾æ‰€ç¤ºï¼š

![image-20220712154624540](./images/image-20220712154624540.png)

##### é€šè¿‡ä¸»é”®æŸ¥è¯¢å•†å“æ•°æ®çš„è¿‡ç¨‹

æ¯”å¦‚ï¼Œæˆ‘ä»¬æ‰§è¡Œäº†ä¸‹é¢è¿™æ¡æŸ¥è¯¢è¯­å¥ï¼Œè¿™æ¡è¯­å¥ä½¿ç”¨äº†ä¸»é”®ç´¢å¼•æŸ¥è¯¢ id å·ä¸º 5 çš„å•†å“ã€‚æŸ¥è¯¢è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼ŒB+Tree ä¼šè‡ªé¡¶å‘ä¸‹é€å±‚è¿›è¡ŒæŸ¥æ‰¾ï¼š

- å°† 5 ä¸æ ¹èŠ‚ç‚¹çš„ç´¢å¼•æ•°æ® (1ï¼Œ10ï¼Œ20) æ¯”è¾ƒï¼Œ5 åœ¨ 1 å’Œ 10 ä¹‹é—´ï¼Œæ‰€ä»¥æ ¹æ® B+Treeçš„æœç´¢é€»è¾‘ï¼Œæ‰¾åˆ°ç¬¬äºŒå±‚çš„ç´¢å¼•æ•°æ® (1ï¼Œ4ï¼Œ7)ï¼›
- åœ¨ç¬¬äºŒå±‚çš„ç´¢å¼•æ•°æ®  (1ï¼Œ4ï¼Œ7)ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå› ä¸º 5 åœ¨ 4 å’Œ 7 ä¹‹é—´ï¼Œæ‰€ä»¥æ‰¾åˆ°ç¬¬ä¸‰å±‚çš„ç´¢å¼•æ•°æ®ï¼ˆ4ï¼Œ5ï¼Œ6ï¼‰ï¼›
- åœ¨å¶å­èŠ‚ç‚¹çš„ç´¢å¼•æ•°æ®ï¼ˆ4ï¼Œ5ï¼Œ6ï¼‰ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œç„¶åæˆ‘ä»¬æ‰¾åˆ°äº†ç´¢å¼•å€¼ä¸º 5 çš„è¡Œæ•°æ®ã€‚

æ•°æ®åº“çš„ç´¢å¼•å’Œæ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç¡¬ç›˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¯»å–ä¸€ä¸ªèŠ‚ç‚¹å½“ä½œä¸€æ¬¡ç£ç›˜ I/O æ“ä½œã€‚é‚£ä¹ˆä¸Šé¢çš„æ•´ä¸ªæŸ¥è¯¢è¿‡ç¨‹ä¸€å…±ç»å†äº† 3 ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œäº† 3 æ¬¡ I/O æ“ä½œã€‚

B+Tree å­˜å‚¨åƒä¸‡çº§çš„æ•°æ®åªéœ€è¦ 3-4 å±‚é«˜åº¦å°±å¯ä»¥æ»¡è¶³ï¼Œè¿™æ„å‘³ç€ä»åƒä¸‡çº§çš„è¡¨æŸ¥è¯¢ç›®æ ‡æ•°æ®æœ€å¤šéœ€è¦ 3-4 æ¬¡ç£ç›˜ I/Oï¼Œæ‰€ä»¥**B+Tree ç›¸æ¯”äº B æ ‘å’ŒäºŒå‰æ ‘æ¥è¯´ï¼Œæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºæŸ¥è¯¢æ•ˆç‡å¾ˆé«˜ï¼Œå› ä¸ºå³ä½¿åœ¨æ•°æ®é‡å¾ˆå¤§çš„æƒ…å†µï¼ŒæŸ¥è¯¢ä¸€ä¸ªæ•°æ®çš„ç£ç›˜ I/O ä¾ç„¶ç»´æŒåœ¨ 3-4æ¬¡ã€‚**

##### é€šè¿‡äºŒçº§ç´¢å¼•æŸ¥è¯¢å•†å“æ•°æ®çš„è¿‡ç¨‹

ä¸»é”®ç´¢å¼•çš„ B+Tree  å’ŒäºŒçº§ç´¢å¼•çš„ B+Tree åŒºåˆ«å¦‚ä¸‹ï¼š

- ä¸»é”®ç´¢å¼•çš„ B+Tree  çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯å®é™…æ•°æ®ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨ä¸»é”®ç´¢å¼•çš„ B+Tree çš„å¶å­èŠ‚ç‚¹é‡Œï¼›
- äºŒçº§ç´¢å¼•çš„ B+Tree  çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯å®é™…æ•°æ®ã€‚

æˆ‘è¿™é‡Œå°†å‰é¢çš„å•†å“è¡¨ä¸­çš„ product_no ï¼ˆå•†å“ç¼–ç ï¼‰å­—æ®µè®¾ç½®ä¸ºäºŒçº§ç´¢å¼•ï¼Œé‚£ä¹ˆäºŒçº§ç´¢å¼•çš„ B+Tree å¦‚ä¸‹å›¾ï¼Œå…¶ä¸­éå¶å­çš„ key å€¼æ˜¯ product_noï¼ˆå›¾ä¸­æ©™è‰²éƒ¨åˆ†ï¼‰ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®æ˜¯ä¸»é”®å€¼ï¼ˆå›¾ä¸­ç»¿è‰²éƒ¨åˆ†ï¼‰ã€‚

![image-20220712154658288](./images/image-20220712154658288.png)

å¦‚æœæˆ‘ç”¨ product_no äºŒçº§ç´¢å¼•æŸ¥è¯¢å•†å“ï¼Œå¦‚ä¸‹æŸ¥è¯¢è¯­å¥ï¼š

```sql
select * from product where product_no = '0002';
```

ä¼šå…ˆæ£€äºŒçº§ç´¢å¼•ä¸­çš„ B+Tree çš„ç´¢å¼•å€¼ï¼ˆå•†å“ç¼–ç ï¼Œproduct_noï¼‰ï¼Œæ‰¾åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œç„¶åè·å–ä¸»é”®å€¼ï¼Œç„¶åå†é€šè¿‡ä¸»é”®ç´¢å¼•ä¸­çš„ B+Tree æ ‘æŸ¥è¯¢åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œç„¶åè·å–æ•´è¡Œæ•°æ®ã€‚**è¿™ä¸ªè¿‡ç¨‹å«ã€Œå›è¡¨ã€ï¼Œä¹Ÿå°±æ˜¯è¯´è¦æŸ¥ä¸¤ä¸ª B+Tree æ‰èƒ½æŸ¥åˆ°æ•°æ®**ã€‚å¦‚ä¸‹å›¾ï¼š

![image-20220712154711271](./images/image-20220712154711271.png)

ä¸è¿‡ï¼Œå½“æŸ¥è¯¢çš„æ•°æ®æ˜¯èƒ½åœ¨äºŒçº§ç´¢å¼•çš„ B+Tree çš„å¶å­èŠ‚ç‚¹é‡ŒæŸ¥è¯¢åˆ°ï¼Œè¿™æ—¶å°±ä¸ç”¨å†æŸ¥ä¸»é”®ç´¢å¼•æŸ¥ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ¡æŸ¥è¯¢è¯­å¥ï¼š

```sql
select id from product where product_no = '0002';
```

**è¿™ç§åœ¨äºŒçº§ç´¢å¼•çš„ B+Tree å°±èƒ½æŸ¥è¯¢åˆ°ç»“æœçš„è¿‡ç¨‹å°±å«ä½œã€Œè¦†ç›–ç´¢å¼•ã€ï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦æŸ¥ä¸€ä¸ª B+Tree å°±èƒ½æ‰¾åˆ°æ•°æ®**ã€‚

#### æŒ‰ç‰©ç†å­˜å‚¨åˆ†ç±»

ä»ç‰©ç†å­˜å‚¨çš„è§’åº¦æ¥çœ‹ï¼Œç´¢å¼•åˆ†ä¸ºèšç°‡ç´¢å¼•ï¼ˆä¸»é”®ç´¢å¼•ï¼‰ã€äºŒçº§ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ï¼‰ã€‚

è¿™ä¸¤ä¸ªåŒºåˆ«åœ¨å‰é¢ä¹Ÿæåˆ°äº†ï¼š

- ä¸»é”®ç´¢å¼•çš„ B+Tree  çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯å®é™…æ•°æ®ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨ä¸»é”®ç´¢å¼•çš„ B+Tree çš„å¶å­èŠ‚ç‚¹é‡Œï¼›
- äºŒçº§ç´¢å¼•çš„ B+Tree  çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯å®é™…æ•°æ®ã€‚

#### æŒ‰å­—æ®µç‰¹æ€§åˆ†ç±»

ä»å­—æ®µç‰¹æ€§çš„è§’åº¦æ¥çœ‹ï¼Œç´¢å¼•åˆ†ä¸ºä¸»é”®ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€æ™®é€šç´¢å¼•ã€å‰ç¼€ç´¢å¼•ã€‚

* **ä¸»é”®ç´¢å¼•**å°±æ˜¯å»ºç«‹åœ¨ä¸»é”®å­—æ®µä¸Šçš„ç´¢å¼•ï¼Œé€šå¸¸åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ä¸€èµ·åˆ›å»ºï¼Œä¸€å¼ è¡¨æœ€å¤šåªæœ‰ä¸€ä¸ªä¸»é”®ç´¢å¼•ï¼Œç´¢å¼•åˆ—çš„å€¼ä¸å…è®¸æœ‰ç©ºå€¼ã€‚
* **å”¯ä¸€ç´¢å¼•**å»ºç«‹åœ¨ UNIQUE å­—æ®µä¸Šçš„ç´¢å¼•ï¼Œä¸€å¼ è¡¨å¯ä»¥æœ‰å¤šä¸ªå”¯ä¸€ç´¢å¼•ï¼Œç´¢å¼•åˆ—çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œä½†æ˜¯å…è®¸æœ‰ç©ºå€¼ã€‚
* **æ™®é€šç´¢å¼•**å°±æ˜¯å»ºç«‹åœ¨æ™®é€šå­—æ®µä¸Šçš„ç´¢å¼•ï¼Œæ—¢ä¸è¦æ±‚å­—æ®µä¸ºä¸»é”®ï¼Œä¹Ÿä¸è¦æ±‚å­—æ®µä¸º UNIQUEã€‚
* **å‰ç¼€ç´¢å¼•**æ˜¯æŒ‡å¯¹å­—ç¬¦ç±»å‹å­—æ®µçš„å‰å‡ ä¸ªå­—ç¬¦å»ºç«‹çš„ç´¢å¼•ï¼Œè€Œä¸æ˜¯åœ¨æ•´ä¸ªå­—æ®µä¸Šå»ºç«‹çš„ç´¢å¼•ï¼Œå‰ç¼€ç´¢å¼•å¯ä»¥å»ºç«‹åœ¨å­—æ®µç±»å‹ä¸º charã€ varcharã€binaryã€varbinary çš„åˆ—ä¸Šã€‚
  * ä½¿ç”¨å‰ç¼€ç´¢å¼•çš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘ç´¢å¼•å ç”¨çš„å­˜å‚¨ç©ºé—´ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚

#### æŒ‰å­—æ®µä¸ªæ•°åˆ†ç±»

ä»å­—æ®µä¸ªæ•°çš„è§’åº¦æ¥çœ‹ï¼Œç´¢å¼•åˆ†ä¸ºå•åˆ—ç´¢å¼•ã€è”åˆç´¢å¼•ï¼ˆå¤åˆç´¢å¼•ï¼‰ã€‚

- å»ºç«‹åœ¨å•åˆ—ä¸Šçš„ç´¢å¼•ç§°ä¸ºå•åˆ—ç´¢å¼•ï¼Œæ¯”å¦‚ä¸»é”®ç´¢å¼•ï¼›
- å»ºç«‹åœ¨å¤šåˆ—ä¸Šçš„ç´¢å¼•ç§°ä¸ºè”åˆç´¢å¼•ï¼›

##### è”åˆç´¢å¼•

é€šè¿‡å°†å¤šä¸ªå­—æ®µç»„åˆæˆä¸€ä¸ªç´¢å¼•ï¼Œè¯¥ç´¢å¼•å°±è¢«ç§°ä¸ºè”åˆç´¢å¼•ã€‚æ¯”å¦‚å°†å•†å“è¡¨ä¸­çš„ product_no å’Œ name å­—æ®µç»„åˆæˆè”åˆç´¢å¼• `(product_no, name)`ï¼Œåˆ›å»ºè”åˆç´¢å¼•çš„æ–¹å¼å¦‚ä¸‹ï¼š

```sql
CREATE INDEX index_product_no_name ON product(product_no, name);
```

è”åˆç´¢å¼• `(product_no, name)` çš„ B+Tree ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![image-20220712155601299](./images/image-20220712155601299.png)

### â­ï¸èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•

å¦å¤–ï¼Œç´¢å¼•åˆå¯ä»¥åˆ†æˆèšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰ï¼Œå®ƒä»¬åŒºåˆ«å°±åœ¨äºå¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä»€ä¹ˆæ•°æ®ï¼š

- èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯å®é™…æ•°æ®ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ï¼›
- äºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯å®é™…æ•°æ®ã€‚

å› ä¸ºè¡¨çš„æ•°æ®éƒ½æ˜¯å­˜æ”¾åœ¨èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹é‡Œï¼Œæ‰€ä»¥ InnoDB å­˜å‚¨å¼•æ“ä¸€å®šä¼šä¸ºè¡¨åˆ›å»ºä¸€ä¸ªèšç°‡ç´¢å¼•ï¼Œä¸”ç”±äºæ•°æ®åœ¨ç‰©ç†ä¸Šåªä¼šä¿å­˜ä¸€ä»½ï¼Œæ‰€ä»¥èšç°‡ç´¢å¼•åªèƒ½æœ‰ä¸€ä¸ªã€‚

InnoDB åœ¨åˆ›å»ºèšç°‡ç´¢å¼•æ—¶ï¼Œä¼šæ ¹æ®ä¸åŒçš„åœºæ™¯é€‰æ‹©ä¸åŒçš„åˆ—ä½œä¸ºç´¢å¼•ï¼š

- å¦‚æœæœ‰ä¸»é”®ï¼Œé»˜è®¤ä¼šä½¿ç”¨ä¸»é”®ä½œä¸ºèšç°‡ç´¢å¼•çš„ç´¢å¼•é”®ï¼›
- å¦‚æœæ²¡æœ‰ä¸»é”®ï¼Œå°±é€‰æ‹©ç¬¬ä¸€ä¸ªä¸åŒ…å« NULL å€¼çš„å”¯ä¸€åˆ—ä½œä¸ºèšç°‡ç´¢å¼•çš„ç´¢å¼•é”®ï¼›
- åœ¨ä¸Šé¢ä¸¤ä¸ªéƒ½æ²¡æœ‰çš„æƒ…å†µä¸‹ï¼ŒInnoDB å°†è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšå¼è‡ªå¢ id åˆ—ä½œä¸ºèšç°‡ç´¢å¼•çš„ç´¢å¼•é”®ï¼›

ä¸€å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ï¼Œé‚£ä¸ºäº†å®ç°éä¸»é”®å­—æ®µçš„å¿«é€Ÿæœç´¢ï¼Œå°±å¼•å‡ºäº†äºŒçº§ç´¢å¼•ï¼ˆéèšç°‡ç´¢å¼•/è¾…åŠ©ç´¢å¼•ï¼‰ï¼Œå®ƒä¹Ÿæ˜¯åˆ©ç”¨äº† B+ æ ‘çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯äºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼ï¼Œä¸æ˜¯å®é™…æ•°æ®ã€‚

äºŒçº§ç´¢å¼•çš„ B+ æ ‘å¦‚ä¸‹å›¾ï¼Œæ•°æ®éƒ¨åˆ†ä¸ºä¸»é”®å€¼ï¼š

![image-20220718134133927](./images/image-20220718134133927.png)

å› æ­¤ï¼Œ**å¦‚æœæŸä¸ªæŸ¥è¯¢è¯­å¥ä½¿ç”¨äº†äºŒçº§ç´¢å¼•ï¼Œä½†æ˜¯æŸ¥è¯¢çš„æ•°æ®ä¸æ˜¯ä¸»é”®å€¼ï¼Œè¿™æ—¶åœ¨äºŒçº§ç´¢å¼•æ‰¾åˆ°ä¸»é”®å€¼åï¼Œéœ€è¦å»èšç°‡ç´¢å¼•ä¸­è·å¾—æ•°æ®è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«ä½œã€Œå›è¡¨ã€ï¼Œä¹Ÿå°±æ˜¯è¯´è¦æŸ¥ä¸¤ä¸ª B+  æ ‘æ‰èƒ½æŸ¥åˆ°æ•°æ®ã€‚ä¸è¿‡ï¼Œå½“æŸ¥è¯¢çš„æ•°æ®æ˜¯ä¸»é”®å€¼æ—¶ï¼Œå› ä¸ºåªåœ¨äºŒçº§ç´¢å¼•å°±èƒ½æŸ¥è¯¢åˆ°ï¼Œä¸ç”¨å†å»èšç°‡ç´¢å¼•æŸ¥ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«ä½œã€Œç´¢å¼•è¦†ç›–ã€ï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦æŸ¥ä¸€ä¸ª  B+ æ ‘å°±èƒ½æ‰¾åˆ°æ•°æ®ã€‚**

### æ•°æ®åº“äº‹åŠ¡ï¼Ÿ

ç®€å•æ¥è¯´ï¼Œæ•°æ®åº“äº‹åŠ¡å¯ä»¥ä¿è¯å¤šä¸ªå¯¹æ•°æ®åº“çš„æ“ä½œï¼ˆä¹Ÿå°±æ˜¯ SQL è¯­å¥ï¼‰æ„æˆä¸€ä¸ªé€»è¾‘ä¸Šçš„æ•´ä½“ã€‚æ„æˆè¿™ä¸ªé€»è¾‘ä¸Šçš„æ•´ä½“çš„è¿™äº›æ•°æ®åº“æ“ä½œéµå¾ªï¼š**è¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸ,è¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ** ã€‚

```sql
# å¼€å¯ä¸€ä¸ªäº‹åŠ¡
START TRANSACTION;
# å¤šæ¡ SQL è¯­å¥
SQL1,SQL2...
## æäº¤äº‹åŠ¡
COMMIT;
```

![image-20220613143832546](./images/image-20220613143832546.png)

å¦å¤–ï¼Œå…³ç³»å‹æ•°æ®åº“ï¼ˆä¾‹å¦‚ï¼š`MySQL`ã€`SQL Server`ã€`Oracle` ç­‰ï¼‰äº‹åŠ¡éƒ½æœ‰ **ACID** ç‰¹æ€§ï¼š

![image-20220613143851071](./images/image-20220613143851071.png)

1. **åŸå­æ€§**ï¼ˆ`Atomicity`ï¼‰ ï¼š äº‹åŠ¡æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œä¸å…è®¸åˆ†å‰²ã€‚äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨ï¼›
2. **ä¸€è‡´æ€§**ï¼ˆ`Consistency`ï¼‰ï¼š æ‰§è¡Œäº‹åŠ¡å‰åï¼Œæ•°æ®ä¿æŒä¸€è‡´ï¼Œä¾‹å¦‚è½¬è´¦ä¸šåŠ¡ä¸­ï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æˆåŠŸï¼Œè½¬è´¦è€…å’Œæ”¶æ¬¾äººçš„æ€»é¢åº”è¯¥æ˜¯ä¸å˜çš„ï¼›
3. **éš”ç¦»æ€§**ï¼ˆ`Isolation`ï¼‰ï¼š å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œä¸€ä¸ªç”¨æˆ·çš„äº‹åŠ¡ä¸è¢«å…¶ä»–äº‹åŠ¡æ‰€å¹²æ‰°ï¼Œå„å¹¶å‘äº‹åŠ¡ä¹‹é—´æ•°æ®åº“æ˜¯ç‹¬ç«‹çš„ï¼›
4. **æŒä¹…æ€§**ï¼ˆ`Durabilily`ï¼‰ï¼š ä¸€ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹åã€‚å®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æŒä¹…çš„ï¼Œå³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚

ğŸŒˆ è¿™é‡Œè¦é¢å¤–è¡¥å……ä¸€ç‚¹ï¼š**åªæœ‰ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€åŸå­æ€§ã€éš”ç¦»æ€§ä¹‹åï¼Œä¸€è‡´æ€§æ‰èƒ½å¾—åˆ°ä¿éšœã€‚ä¹Ÿå°±æ˜¯è¯´ Aã€Iã€D æ˜¯æ‰‹æ®µï¼ŒC æ˜¯ç›®çš„ï¼** æƒ³å¿…å¤§å®¶ä¹Ÿå’Œæˆ‘ä¸€æ ·ï¼Œè¢« ACID è¿™ä¸ªæ¦‚å¿µè¢«è¯¯å¯¼äº†å¾ˆä¹…!

![image-20220613144017540](./images/image-20220613144017540.png)

å¦å¤–ï¼ŒDDIA ä¹Ÿå°±æ˜¯ [ã€ŠDesigning Data-Intensive Applicationï¼ˆæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿè®¾è®¡ï¼‰ã€‹](https://book.douban.com/subject/30329536/)

 çš„ä½œè€…åœ¨ä»–çš„è¿™æœ¬ä¹¦ä¸­å¦‚æ˜¯è¯´ï¼š

> Atomicity, isolation, and durability are properties of the database, whereas  consisâ€ tency (in the ACID sense) is a property of the application. The  application may rely on the databaseâ€™s atomicity and isolation  properties in order to achieve consistency, but itâ€™s not up to the  database alone.
>
> ç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯ï¼šåŸå­æ€§ï¼Œéš”ç¦»æ€§å’ŒæŒä¹…æ€§æ˜¯æ•°æ®åº“çš„å±æ€§ï¼Œè€Œä¸€è‡´æ€§ï¼ˆåœ¨ ACID æ„ä¹‰ä¸Šï¼‰æ˜¯åº”ç”¨ç¨‹åºçš„å±æ€§ã€‚åº”ç”¨å¯èƒ½ä¾èµ–æ•°æ®åº“çš„åŸå­æ€§å’Œéš”ç¦»å±æ€§æ¥å®ç°ä¸€è‡´æ€§ï¼Œä½†è¿™å¹¶ä¸ä»…å–å†³äºæ•°æ®åº“ã€‚å› æ­¤ï¼Œå­—æ¯ C ä¸å±äº ACID ã€‚

### å¹¶å‘äº‹åŠ¡å¸¦æ¥äº†å“ªäº›é—®é¢˜

> éƒ¨åˆ†å›¾é€‰è‡ªã€ŠMySQLæ˜¯æ€æ ·è¿è¡Œçš„ã€‹

åœ¨å…¸å‹çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¤šä¸ªäº‹åŠ¡å¹¶å‘è¿è¡Œï¼Œç»å¸¸ä¼šæ“ä½œç›¸åŒçš„æ•°æ®æ¥å®Œæˆå„è‡ªçš„ä»»åŠ¡ï¼ˆå¤šä¸ªç”¨æˆ·å¯¹åŒä¸€æ•°æ®è¿›è¡Œæ“ä½œï¼‰ã€‚å¹¶å‘è™½ç„¶æ˜¯å¿…é¡»çš„ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´ä»¥ä¸‹çš„é—®é¢˜ã€‚

- **è„è¯»ï¼ˆDirty readï¼‰:** å½“ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨è®¿é—®æ•°æ®å¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¿™ä¸ªæ•°æ®ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªæ•°æ®ã€‚å› ä¸ºè¿™ä¸ªæ•°æ®æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œé‚£ä¹ˆå¦å¤–ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°çš„è¿™ä¸ªæ•°æ®æ˜¯â€œè„æ•°æ®â€ï¼Œä¾æ®â€œè„æ•°æ®â€æ‰€åšçš„æ“ä½œå¯èƒ½æ˜¯ä¸æ­£ç¡®çš„ã€‚ã€ç®€è€Œè¨€ä¹‹ï¼š**å¦‚æœä¸€ä¸ªäº‹åŠ¡è¯»åˆ°äº†å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œé‚£å°±æ„å‘³ç€å‘ç”Ÿäº† è„è¯»** ã€‘

![img](./images/v2-404a11c565a99a9382aa3ed1d8e05e9a_r.jpg)

![image-20220706223058381](./images/image-20220706223058381.png)

- **ä¸¢å¤±ä¿®æ”¹ï¼ˆLost to modifyï¼‰/ è„å†™:**  æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡è¯»å–ä¸€ä¸ªæ•°æ®æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¯¥æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®åï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ä¹Ÿä¿®æ”¹äº†è¿™ä¸ªæ•°æ®ã€‚è¿™æ ·ç¬¬ä¸€ä¸ªäº‹åŠ¡å†…çš„ä¿®æ”¹ç»“æœå°±è¢«ä¸¢å¤±ï¼Œå› æ­¤ç§°ä¸ºä¸¢å¤±ä¿®æ”¹ã€‚ ä¾‹å¦‚ï¼šäº‹åŠ¡ 1 è¯»å–æŸè¡¨ä¸­çš„æ•°æ® A=20ï¼Œäº‹åŠ¡ 2 ä¹Ÿè¯»å– A=20ï¼Œäº‹åŠ¡ 1 ä¿®æ”¹ A=A-1ï¼Œäº‹åŠ¡ 2 ä¹Ÿä¿®æ”¹ A=A-1ï¼Œæœ€ç»ˆç»“æœ  A=19ï¼Œäº‹åŠ¡ 1 çš„ä¿®æ”¹è¢«ä¸¢å¤±ã€‚ã€**å¦‚æœä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œé‚£å°±æ„å‘³ç€å‘ç”Ÿäº† è„å†™**ã€‘

![img](./images/v2-0b5257fd270ef7e6e619e2eec293ec37_r.jpg)

![image-20220706223114814](./images/image-20220706223114814.png)

- **ä¸å¯é‡å¤è¯»ï¼ˆUnrepeatable readï¼‰:** æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»åŒä¸€æ•°æ®ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥æ•°æ®ã€‚é‚£ä¹ˆï¼Œåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸­çš„ä¸¤æ¬¡è¯»æ•°æ®ä¹‹é—´ï¼Œç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹å¯¼è‡´ç¬¬ä¸€ä¸ªäº‹åŠ¡ä¸¤æ¬¡è¯»å–çš„æ•°æ®å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚è¿™å°±å‘ç”Ÿäº†åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå› æ­¤ç§°ä¸ºä¸å¯é‡å¤è¯»ã€‚

![img](./images/v2-f470fb471caacb70acf65bc2a597b0c5_r.jpg)

![image-20220706222414240](./images/image-20220706222414240.png)

- **å¹»è¯»ï¼ˆPhantom readï¼‰:** å¹»è¯»ä¸ä¸å¯é‡å¤è¯»ç±»ä¼¼ã€‚å®ƒå‘ç”Ÿåœ¨ä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰è¯»å–äº†å‡ è¡Œæ•°æ®ï¼Œæ¥ç€å¦ä¸€ä¸ªå¹¶å‘äº‹åŠ¡ï¼ˆT2ï¼‰æ’å…¥äº†ä¸€äº›æ•°æ®æ—¶ã€‚åœ¨éšåçš„æŸ¥è¯¢ä¸­ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰å°±ä¼šå‘ç°å¤šäº†ä¸€äº›åŸæœ¬ä¸å­˜åœ¨çš„è®°å½•ï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ï¼Œæ‰€ä»¥ç§°ä¸ºå¹»è¯»ã€‚

![img](./images/v2-c698e64414f7cb1428e3025e133d9592_r.jpg)

![image-20220706222426455](./images/image-20220706222426455.png)

**ä¸å¯é‡å¤è¯»å’Œå¹»è¯»åŒºåˆ«** ï¼š`<u>`ä¸å¯é‡å¤è¯»çš„é‡ç‚¹æ˜¯ä¿®æ”¹`</u>`æ¯”å¦‚å¤šæ¬¡è¯»å–ä¸€æ¡è®°å½•å‘ç°å…¶ä¸­æŸäº›åˆ—çš„å€¼è¢«ä¿®æ”¹ï¼Œ`<u>`å¹»è¯»çš„é‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤`</u>`æ¯”å¦‚å¤šæ¬¡æŸ¥è¯¢åŒä¸€æ¡æŸ¥è¯¢è¯­å¥ï¼ˆDQLï¼‰æ—¶ï¼Œè®°å½•å‘ç°è®°å½•å¢å¤šæˆ–å‡å°‘äº†ã€‚

### â­æœ‰å“ªäº›äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ŒMySQL çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆ?

MySQL çš„éš”ç¦»çº§åˆ«åŸºäºé”å’Œ MVCC æœºåˆ¶å…±åŒå®ç°çš„ã€‚

- **READ-UNCOMMITTED(è¯»å–æœªæäº¤)** ï¼š æœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ã€‚
- **READ-COMMITTED(è¯»å–å·²æäº¤)** ï¼š å…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚
- **REPEATABLE-READ(å¯é‡å¤è¯»)** ï¼š å¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚
- **SERIALIZABLE(å¯ä¸²è¡ŒåŒ–)** ï¼š æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚

---

|     éš”ç¦»çº§åˆ«     | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» |
| :--------------: | :--: | :--------: | :--: |
| READ-UNCOMMITTED |  âˆš  |     âˆš     |  âˆš  |
|  READ-COMMITTED  |  Ã—  |     âˆš     |  âˆš  |
| REPEATABLE-READ |  Ã—  |     Ã—     |  âˆš  |
|   SERIALIZABLE   |  Ã—  |     Ã—     |  Ã—  |

### è¡¨çº§é”å’Œè¡Œçº§é”äº†è§£å—ï¼Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

MyISAM ä»…ä»…æ”¯æŒè¡¨çº§é”(table-level locking)ï¼Œä¸€é”å°±é”æ•´å¼ è¡¨ï¼Œè¿™åœ¨å¹¶å‘å†™çš„æƒ…å†µä¸‹æ€§éå¸¸å·®ã€‚

InnoDB ä¸å…‰æ”¯æŒè¡¨çº§é”(table-level locking)ï¼Œè¿˜æ”¯æŒè¡Œçº§é”(row-level  locking)ï¼Œé»˜è®¤ä¸ºè¡Œçº§é”ã€‚è¡Œçº§é”çš„ç²’åº¦æ›´å°ï¼Œä»…å¯¹ç›¸å…³çš„è®°å½•ä¸Šé”å³å¯ï¼ˆå¯¹ä¸€è¡Œæˆ–è€…å¤šè¡Œè®°å½•åŠ é”ï¼‰ï¼Œæ‰€ä»¥å¯¹äºå¹¶å‘å†™å…¥æ“ä½œæ¥è¯´ï¼Œ InnoDB  çš„æ€§èƒ½æ›´é«˜ã€‚

**è¡¨çº§é”å’Œè¡Œçº§é”å¯¹æ¯”** ï¼š

- **è¡¨çº§é”ï¼š** MySQL ä¸­é”å®šç²’åº¦æœ€å¤§çš„ä¸€ç§é”ï¼Œæ˜¯é’ˆ**å¯¹éç´¢å¼•å­—æ®µåŠ çš„é”**ï¼Œå¯¹å½“å‰æ“ä½œçš„æ•´å¼ è¡¨åŠ é”ï¼Œå®ç°ç®€å•ï¼Œèµ„æºæ¶ˆè€—ä¹Ÿæ¯”è¾ƒå°‘ï¼ŒåŠ é”å¿«ï¼Œä¸ä¼šå‡ºç°æ­»é”ã€‚å…¶é”å®šç²’åº¦æœ€å¤§ï¼Œè§¦å‘é”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼ŒMyISAM å’Œ InnoDB å¼•æ“éƒ½æ”¯æŒè¡¨çº§é”ã€‚
- **è¡Œçº§é”ï¼š** MySQL ä¸­é”å®šç²’åº¦æœ€å°çš„ä¸€ç§é”ï¼Œæ˜¯é’ˆ**å¯¹ç´¢å¼•å­—æ®µåŠ çš„é”**ï¼Œåªé’ˆå¯¹å½“å‰æ“ä½œçš„è®°å½•è¿›è¡ŒåŠ é”ã€‚ è¡Œçº§é”èƒ½å¤§å¤§å‡å°‘æ•°æ®åº“æ“ä½œçš„å†²çªã€‚å…¶åŠ é”ç²’åº¦æœ€å°ï¼Œå¹¶å‘åº¦é«˜ï¼Œä½†åŠ é”çš„å¼€é”€ä¹Ÿæœ€å¤§ï¼ŒåŠ é”æ…¢ï¼Œä¼šå‡ºç°æ­»é”ã€‚

### å…±äº«é”å’Œæ’ä»–é”

ä¸è®ºæ˜¯è¡¨çº§é”è¿˜æ˜¯è¡Œçº§é”ï¼Œéƒ½å­˜åœ¨å…±äº«é”ï¼ˆShare Lockï¼ŒS é”ï¼‰å’Œæ’ä»–é”ï¼ˆExclusive Lockï¼ŒX é”ï¼‰è¿™ä¸¤ç±»ï¼š

- **å…±äº«é”ï¼ˆS é”ï¼‰** ï¼šåˆç§°è¯»é”ï¼Œäº‹åŠ¡åœ¨è¯»å–è®°å½•çš„æ—¶å€™è·å–å…±äº«é”ï¼Œå…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ï¼ˆé”å…¼å®¹ï¼‰ã€‚
- **æ’ä»–é”ï¼ˆX é”ï¼‰** ï¼šåˆç§°å†™é”/ç‹¬å é”ï¼Œäº‹åŠ¡åœ¨ä¿®æ”¹è®°å½•çš„æ—¶å€™è·å–æ’ä»–é”ï¼Œä¸å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è·å–ã€‚å¦‚æœä¸€ä¸ªè®°å½•å·²ç»è¢«åŠ äº†æ’ä»–é”ï¼Œé‚£å…¶ä»–äº‹åŠ¡ä¸èƒ½å†å¯¹è¿™æ¡äº‹åŠ¡åŠ ä»»ä½•ç±»å‹çš„é”ï¼ˆé”ä¸å…¼å®¹ï¼‰ã€‚

æ’ä»–é”ä¸ä»»ä½•çš„é”éƒ½ä¸å…¼å®¹ï¼Œå…±äº«é”ä»…å’Œå…±äº«é”å…¼å®¹ã€‚

|      | S é”   | X é” |
| :--- | :----- | :--- |
| S é” | ä¸å†²çª | å†²çª |
| X é” | å†²çª   | å†²çª |

ç”±äº MVCC çš„å­˜åœ¨ï¼Œå¯¹äºä¸€èˆ¬çš„ `SELECT` è¯­å¥ï¼ŒInnoDB ä¸ä¼šåŠ ä»»ä½•é”ã€‚ä¸è¿‡ï¼Œ ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥æ˜¾å¼åŠ å…±äº«é”æˆ–æ’ä»–é”ã€‚

```sql
# å…±äº«é”
SELECT ... LOCK IN SHARE MODE;
# æ’ä»–é”
SELECT ... FOR UPDATE;
```

### æ•°æ®åº“ç´¢å¼•å¤±æ•ˆæœ‰å“ªäº›

è¯¦ç»†æŸ¥çœ‹æ–‡ç« ï¼šhttps://xiaolincoding.com/mysql/index/index_lose.html

- å½“æˆ‘ä»¬ä½¿ç”¨å·¦æˆ–è€…å·¦å³æ¨¡ç³ŠåŒ¹é…çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ `like %xx` æˆ–è€… `like %xx%`è¿™ä¸¤ç§æ–¹å¼éƒ½ä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼›
- å½“æˆ‘ä»¬åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ç´¢å¼•åˆ—ä½¿ç”¨å‡½æ•°ï¼Œå°±ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚
- å½“æˆ‘ä»¬åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ç´¢å¼•åˆ—è¿›è¡Œè¡¨è¾¾å¼è®¡ç®—ï¼Œä¹Ÿæ˜¯æ— æ³•èµ°ç´¢å¼•çš„ã€‚
- MySQL  åœ¨é‡åˆ°å­—ç¬¦ä¸²å’Œæ•°å­—æ¯”è¾ƒçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æŠŠå­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—ï¼Œç„¶åå†è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœå­—ç¬¦ä¸²æ˜¯ç´¢å¼•åˆ—ï¼Œè€Œæ¡ä»¶è¯­å¥ä¸­çš„è¾“å…¥å‚æ•°æ˜¯æ•°å­—çš„è¯ï¼Œé‚£ä¹ˆç´¢å¼•åˆ—ä¼šå‘ç”Ÿéšå¼ç±»å‹è½¬æ¢ï¼Œç”±äºéšå¼ç±»å‹è½¬æ¢æ˜¯é€šè¿‡ CAST å‡½æ•°å®ç°çš„ï¼Œç­‰åŒäºå¯¹ç´¢å¼•åˆ—ä½¿ç”¨äº†å‡½æ•°ï¼Œæ‰€ä»¥å°±ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚
- è”åˆç´¢å¼•è¦èƒ½æ­£ç¡®ä½¿ç”¨éœ€è¦éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§æœ€å·¦ä¼˜å…ˆçš„æ–¹å¼è¿›è¡Œç´¢å¼•çš„åŒ¹é…ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚
- åœ¨ WHERE å­å¥ä¸­ï¼Œå¦‚æœåœ¨ OR å‰çš„æ¡ä»¶åˆ—æ˜¯ç´¢å¼•åˆ—ï¼Œè€Œåœ¨ OR åçš„æ¡ä»¶åˆ—ä¸æ˜¯ç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆç´¢å¼•ä¼šå¤±æ•ˆã€‚



### æ•°æ®åº“sqlä¼˜åŒ–æœ‰å“ªäº›æ–¹æ³•

> è§„èŒƒ

[MySQLé«˜æ€§èƒ½ä¼˜åŒ–è§„èŒƒå»ºè®®](https://javaguide.cn/database/mysql/mysql-high-performance-optimization-specification-recommendations.html#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%91%BD%E4%BB%A4%E8%A7%84%E8%8C%83)

1. å°½é‡é¿å…ä½¿ç”¨å­æŸ¥è¯¢
2. ç”¨INæ¥æ›¿æ¢OR
3. è¯»å–é€‚å½“çš„è®°å½•LIMIT M,Nï¼Œè€Œä¸è¦è¯»å¤šä½™çš„è®°å½•
4. ç¦æ­¢ä¸å¿…è¦çš„Order Byæ’åº
5. æ€»å’ŒæŸ¥è¯¢å¯ä»¥ç¦æ­¢æ’é‡ç”¨union all
6. é¿å…éšæœºå–è®°å½•
7. å°†å¤šæ¬¡æ’å…¥æ¢æˆæ‰¹é‡Insertæ’å…¥
8. åªè¿”å›å¿…è¦çš„åˆ—ï¼Œç”¨å…·ä½“çš„å­—æ®µåˆ—è¡¨ä»£æ›¿ select * è¯­å¥
9. åŒºåˆ†inå’Œexists
10. ä¼˜åŒ–Group Byè¯­å¥
11. å°½é‡ä½¿ç”¨æ•°å­—å‹å­—æ®µ
12. ä¼˜åŒ–Joinè¯­å¥

> æ­¥éª¤

[SQLè¯­å¥ä¼˜åŒ–](https://www.pdai.tech/md/db/sql-lan/sql-lan-optimize.html#sql%E8%AF%AD%E8%A8%80---sql%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96)

### InnoDB æœ‰å“ªå‡ ç±»è¡Œé”

MySQL InnoDB æ”¯æŒä¸‰ç§è¡Œé”å®šæ–¹å¼ï¼š

- **è®°å½•é”ï¼ˆRecord Lockï¼‰** ï¼šä¹Ÿè¢«ç§°ä¸ºè®°å½•é”ï¼Œå±äºå•ä¸ªè¡Œè®°å½•ä¸Šçš„é”ã€‚
- **é—´éš™é”ï¼ˆGap Lockï¼‰** ï¼šé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä¸åŒ…æ‹¬è®°å½•æœ¬èº«ã€‚
- **ä¸´é”®é”ï¼ˆNext-key Lockï¼‰** ï¼šRecord Lock+Gap Lockï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼ŒåŒ…å«è®°å½•æœ¬èº«ã€‚è®°å½•é”åªèƒ½é”ä½å·²ç»å­˜åœ¨çš„è®°å½•ï¼Œä¸ºäº†é¿å…æ’å…¥æ–°è®°å½•ï¼Œéœ€è¦ä¾èµ–é—´éš™é”ã€‚

InnoDB çš„é»˜è®¤éš”ç¦»çº§åˆ« REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰æ˜¯å¯ä»¥è§£å†³å¹»è¯»é—®é¢˜å‘ç”Ÿçš„ï¼Œä¸»è¦æœ‰ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š

- **å¿«ç…§è¯»** ï¼šç”± MVCC æœºåˆ¶æ¥ä¿è¯ä¸å‡ºç°å¹»è¯»ã€‚
- **å½“å‰è¯»** ï¼š ä½¿ç”¨ Next-Key Lock è¿›è¡ŒåŠ é”æ¥ä¿è¯ä¸å‡ºç°å¹»è¯»ã€‚

### ä¸ºä»€ä¹ˆMySQL æ²¡æœ‰ä½¿ç”¨Hashè¡¨ä½œä¸ºç´¢å¼•çš„æ•°æ®ç»“æ„å‘¢ï¼Ÿ

**1.Hash å†²çªé—®é¢˜** ï¼šJDK1.8 ä¹‹å‰ `HashMap` å°±æ˜¯é€šè¿‡é“¾åœ°å€æ³•æ¥è§£å†³å“ˆå¸Œå†²çªçš„ã€‚ä¸è¿‡ï¼ŒJDK1.8 ä»¥å `HashMap`ä¸ºäº†å‡å°‘é“¾è¡¨è¿‡é•¿çš„æ—¶å€™æœç´¢æ—¶é—´è¿‡é•¿å¼•å…¥äº†çº¢é»‘æ ‘ï¼Œä¸è¿‡å¯¹äºæ•°æ®åº“æ¥è¯´è¿™è¿˜ä¸ç®—æœ€å¤§çš„ç¼ºç‚¹ã€‚

**2.Hash ç´¢å¼•ä¸æ”¯æŒé¡ºåºå’ŒèŒƒå›´æŸ¥è¯¢(Hash ç´¢å¼•ä¸æ”¯æŒé¡ºåºå’ŒèŒƒå›´æŸ¥è¯¢æ˜¯å®ƒæœ€å¤§çš„ç¼ºç‚¹ï¼š** å‡å¦‚æˆ‘ä»¬è¦å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œæ’åºæˆ–è€…è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ï¼Œé‚£ Hash ç´¢å¼•å¯å°±ä¸è¡Œäº†ã€‚

è¯•æƒ³ä¸€ç§æƒ…å†µ:

```java
SELECT * FROM tb1 WHERE id < 500;
```

åœ¨è¿™ç§èŒƒå›´æŸ¥è¯¢ä¸­ï¼Œä¼˜åŠ¿éå¸¸å¤§ï¼Œç›´æ¥éå†æ¯” 500 å°çš„å¶å­èŠ‚ç‚¹å°±å¤Ÿäº†ã€‚è€Œ Hash ç´¢å¼•æ˜¯æ ¹æ® hash ç®—æ³•æ¥å®šä½çš„ï¼Œéš¾ä¸æˆè¿˜è¦æŠŠ 1 - 499 çš„æ•°æ®ï¼Œæ¯ä¸ªéƒ½è¿›è¡Œä¸€æ¬¡ hash è®¡ç®—æ¥å®šä½å—?è¿™å°±æ˜¯ Hash æœ€å¤§çš„ç¼ºç‚¹äº†ã€‚

### â­ï¸ä¸ºä»€ä¹ˆMySQLåº•å±‚è¦ç”¨B+æ ‘ï¼Ÿå’ŒBæ ‘æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿï¼ˆ2022é£ä¹¦ï¼‰

å›¾è§£B+æ ‘ï¼šhttps://zhuanlan.zhihu.com/p/54102723

B æ ‘ä¹Ÿç§° B-æ ‘,å…¨ç§°ä¸º **å¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘** ï¼ŒB+ æ ‘æ˜¯ B æ ‘çš„ä¸€ç§å˜ä½“ã€‚B æ ‘å’Œ B+æ ‘ä¸­çš„ B æ˜¯ `Balanced` ï¼ˆå¹³è¡¡ï¼‰çš„æ„æ€ã€‚

ç›®å‰å¤§éƒ¨åˆ†æ•°æ®åº“ç³»ç»ŸåŠæ–‡ä»¶ç³»ç»Ÿéƒ½é‡‡ç”¨ B-Tree æˆ–å…¶å˜ç§ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ã€‚

**B æ ‘& B+æ ‘ä¸¤è€…æœ‰ä½•å¼‚åŒå‘¢ï¼Ÿ**

- B æ ‘çš„æ‰€æœ‰èŠ‚ç‚¹æ—¢å­˜æ”¾é”®(key) ä¹Ÿå­˜æ”¾ æ•°æ®(data)ï¼Œè€Œ B+æ ‘åªæœ‰å¶å­èŠ‚ç‚¹å­˜æ”¾ key å’Œ dataï¼Œå…¶ä»–å†…èŠ‚ç‚¹åªå­˜æ”¾ keyã€‚
- B æ ‘çš„å¶å­èŠ‚ç‚¹éƒ½æ˜¯ç‹¬ç«‹çš„;B+æ ‘çš„å¶å­èŠ‚ç‚¹æœ‰ä¸€æ¡å¼•ç”¨é“¾æŒ‡å‘ä¸å®ƒç›¸é‚»çš„å¶å­èŠ‚ç‚¹ã€‚
- B æ ‘çš„æ£€ç´¢çš„è¿‡ç¨‹ç›¸å½“äºå¯¹èŒƒå›´å†…çš„æ¯ä¸ªèŠ‚ç‚¹çš„å…³é”®å­—åšäºŒåˆ†æŸ¥æ‰¾ï¼Œå¯èƒ½è¿˜æ²¡æœ‰åˆ°è¾¾å¶å­èŠ‚ç‚¹ï¼Œæ£€ç´¢å°±ç»“æŸäº†ã€‚è€Œ B+æ ‘çš„æ£€ç´¢æ•ˆç‡å°±å¾ˆç¨³å®šäº†ï¼Œä»»ä½•æŸ¥æ‰¾éƒ½æ˜¯ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œå¶å­èŠ‚ç‚¹çš„é¡ºåºæ£€ç´¢å¾ˆæ˜æ˜¾ã€‚

åœ¨ MySQL ä¸­ï¼ŒMyISAM å¼•æ“å’Œ InnoDB å¼•æ“éƒ½æ˜¯ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä½†æ˜¯ï¼Œä¸¤è€…çš„å®ç°æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚

MyISAM å¼•æ“ä¸­ï¼ŒB+Tree å¶èŠ‚ç‚¹çš„ data åŸŸå­˜æ”¾çš„æ˜¯æ•°æ®è®°å½•çš„åœ°å€ã€‚åœ¨ç´¢å¼•æ£€ç´¢çš„æ—¶å€™ï¼Œé¦–å…ˆæŒ‰ç…§ B+Tree  æœç´¢ç®—æ³•æœç´¢ç´¢å¼•ï¼Œå¦‚æœæŒ‡å®šçš„ Key å­˜åœ¨ï¼Œåˆ™å–å‡ºå…¶ data åŸŸçš„å€¼ï¼Œç„¶å**ä»¥ data  åŸŸçš„å€¼ä¸ºåœ°å€è¯»å–ç›¸åº”çš„æ•°æ®è®°å½•**ã€‚è¿™è¢«ç§°ä¸ºâ€œ**éèšç°‡ç´¢å¼•**â€ã€‚

InnoDB å¼•æ“ä¸­ï¼Œå…¶æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ç´¢å¼•æ–‡ä»¶ã€‚ç›¸æ¯” MyISAMï¼Œç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œå…¶è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰ B+Tree  ç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œ**æ ‘çš„å¶èŠ‚ç‚¹ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•**ã€‚è¿™ä¸ªç´¢å¼•çš„ key æ˜¯æ•°æ®è¡¨çš„ä¸»é”®ï¼Œå› æ­¤ InnoDB  è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ä¸»ç´¢å¼•ã€‚è¿™è¢«ç§°ä¸º**â€œèšç°‡ç´¢å¼•ï¼ˆæˆ–èšé›†ç´¢å¼•ï¼‰**â€ï¼Œè€Œå…¶ä½™çš„ç´¢å¼•éƒ½ä½œä¸ºè¾…åŠ©ç´¢å¼•ï¼Œè¾…åŠ©ç´¢å¼•çš„ data  åŸŸå­˜å‚¨ç›¸åº”è®°å½•ä¸»é”®çš„å€¼è€Œä¸æ˜¯åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯å’Œ MyISAM ä¸åŒçš„åœ°æ–¹ã€‚åœ¨æ ¹æ®ä¸»ç´¢å¼•æœç´¢æ—¶ï¼Œç›´æ¥æ‰¾åˆ° key  æ‰€åœ¨çš„èŠ‚ç‚¹å³å¯å–å‡ºæ•°æ®ï¼›åœ¨æ ¹æ®è¾…åŠ©ç´¢å¼•æŸ¥æ‰¾æ—¶ï¼Œåˆ™éœ€è¦å…ˆå–å‡ºä¸»é”®çš„å€¼ï¼Œå†èµ°ä¸€éä¸»ç´¢å¼•ã€‚  å› æ­¤ï¼Œåœ¨è®¾è®¡è¡¨çš„æ—¶å€™ï¼Œä¸å»ºè®®ä½¿ç”¨è¿‡é•¿çš„å­—æ®µä½œä¸ºä¸»é”®ï¼Œä¹Ÿä¸å»ºè®®ä½¿ç”¨éå•è°ƒçš„å­—æ®µä½œä¸ºä¸»é”®ï¼Œè¿™æ ·ä¼šé€ æˆä¸»ç´¢å¼•é¢‘ç¹åˆ†è£‚ã€‚

### è¯¦è§£B+æ ‘

#### ä»€ä¹ˆæ˜¯ B+ æ ‘ï¼Ÿ

B+ æ ‘å°±æ˜¯å¯¹ B æ ‘åšäº†ä¸€ä¸ªå‡çº§ï¼ŒMySQL ä¸­ç´¢å¼•çš„æ•°æ®ç»“æ„å°±æ˜¯é‡‡ç”¨äº† B+ æ ‘ï¼ŒB+ æ ‘ç»“æ„å¦‚ä¸‹å›¾ï¼š

![image-20220718133551150](./images/image-20220718133551150.png)

B+ æ ‘ä¸ B æ ‘å·®å¼‚çš„ç‚¹ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹è¿™å‡ ç‚¹ï¼š

- å¶å­èŠ‚ç‚¹ï¼ˆæœ€åº•éƒ¨çš„èŠ‚ç‚¹ï¼‰æ‰ä¼šå­˜æ”¾å®é™…æ•°æ®ï¼ˆç´¢å¼•+è®°å½•ï¼‰ï¼Œéå¶å­èŠ‚ç‚¹åªä¼šå­˜æ”¾ç´¢å¼•ï¼›
- æ‰€æœ‰ç´¢å¼•éƒ½ä¼šåœ¨å¶å­èŠ‚ç‚¹å‡ºç°ï¼Œå¶å­èŠ‚ç‚¹ä¹‹é—´æ„æˆä¸€ä¸ªæœ‰åºé“¾è¡¨ï¼›
- éå¶å­èŠ‚ç‚¹çš„ç´¢å¼•ä¹Ÿä¼šåŒæ—¶å­˜åœ¨åœ¨å­èŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”æ˜¯åœ¨å­èŠ‚ç‚¹ä¸­æ‰€æœ‰ç´¢å¼•çš„æœ€å¤§ï¼ˆæˆ–æœ€å°ï¼‰ã€‚
- éå¶å­èŠ‚ç‚¹ä¸­æœ‰å¤šå°‘ä¸ªå­èŠ‚ç‚¹ï¼Œå°±æœ‰å¤šå°‘ä¸ªç´¢å¼•ï¼›

ä¸‹é¢é€šè¿‡ä¸‰ä¸ªæ–¹é¢ï¼Œæ¯”è¾ƒä¸‹ B+ å’Œ B æ ‘çš„æ€§èƒ½åŒºåˆ«ã€‚

#### B+ æ ‘æ˜¯å¦‚ä½•è¿›è¡ŒæŸ¥è¯¢çš„ï¼Ÿ

ä¸€ä¸ªæ•°æ®é¡µä¸­çš„è®°å½•æ£€ç´¢ï¼Œå› ä¸ºä¸€ä¸ªæ•°æ®é¡µä¸­çš„è®°å½•æ˜¯æœ‰é™çš„ï¼Œä¸”ä¸»é”®å€¼æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥é€šè¿‡å¯¹æ‰€æœ‰è®°å½•è¿›è¡Œåˆ†ç»„ï¼Œç„¶åå°†ç»„å·ï¼ˆæ§½å·ï¼‰å­˜å‚¨åˆ°é¡µç›®å½•ï¼Œä½¿å…¶èµ·åˆ°ç´¢å¼•ä½œç”¨ï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾çš„æ–¹æ³•å¿«é€Ÿæ£€ç´¢åˆ°è®°å½•åœ¨å“ªä¸ªåˆ†ç»„ï¼Œæ¥é™ä½æ£€ç´¢çš„æ—¶é—´å¤æ‚åº¦ã€‚

ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬éœ€è¦å­˜å‚¨å¤§é‡çš„è®°å½•æ—¶ï¼Œå°±éœ€è¦å¤šä¸ªæ•°æ®é¡µï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦è€ƒè™‘å¦‚ä½•å»ºç«‹åˆé€‚çš„ç´¢å¼•ï¼Œæ‰èƒ½æ–¹ä¾¿å®šä½è®°å½•æ‰€åœ¨çš„é¡µã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ**InnoDB é‡‡ç”¨äº† B+ æ ‘ä½œä¸ºç´¢å¼•**ã€‚ç£ç›˜çš„ I/O æ“ä½œæ¬¡æ•°å¯¹ç´¢å¼•çš„ä½¿ç”¨æ•ˆç‡è‡³å…³é‡è¦ï¼Œå› æ­¤åœ¨æ„é€ ç´¢å¼•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ›´å€¾å‘äºé‡‡ç”¨â€œçŸ®èƒ–â€çš„ B+ æ ‘æ•°æ®ç»“æ„ï¼Œè¿™æ ·æ‰€éœ€è¦è¿›è¡Œçš„ç£ç›˜ I/O æ¬¡æ•°æ›´å°‘ï¼Œè€Œä¸” B+ æ ‘ æ›´é€‚åˆè¿›è¡Œå…³é”®å­—çš„èŒƒå›´æŸ¥è¯¢ã€‚

InnoDB é‡Œçš„ B+ æ ‘ä¸­çš„**æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªæ•°æ®é¡µ**ï¼Œç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![image-20220718134312198](./images/image-20220718134312198.png)

é€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬çœ‹å‡º  B+ æ ‘çš„ç‰¹ç‚¹ï¼š

- åªæœ‰å¶å­èŠ‚ç‚¹ï¼ˆæœ€åº•å±‚çš„èŠ‚ç‚¹ï¼‰æ‰å­˜æ”¾äº†æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹ï¼ˆå…¶ä»–ä¸Šå±‚èŠ‚ï¼‰ä»…ç”¨æ¥å­˜æ”¾ç›®å½•é¡¹ä½œä¸ºç´¢å¼•ã€‚
- éå¶å­èŠ‚ç‚¹åˆ†ä¸ºä¸åŒå±‚æ¬¡ï¼Œé€šè¿‡åˆ†å±‚æ¥é™ä½æ¯ä¸€å±‚çš„æœç´¢é‡ï¼›
- æ‰€æœ‰èŠ‚ç‚¹æŒ‰ç…§ç´¢å¼•é”®å¤§å°æ’åºï¼Œæ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä¾¿äºèŒƒå›´æŸ¥è¯¢ï¼›

æˆ‘ä»¬å†çœ‹çœ‹ B+ æ ‘å¦‚ä½•å®ç°å¿«é€ŸæŸ¥æ‰¾ä¸»é”®ä¸º 6 çš„è®°å½•ï¼Œä»¥ä¸Šå›¾ä¸ºä¾‹å­ï¼š

- ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°ç¬¦åˆé¡µå†…èŒƒå›´åŒ…å«æŸ¥è¯¢å€¼çš„é¡µï¼Œå› ä¸ºæŸ¥è¯¢çš„ä¸»é”®å€¼ä¸º 6ï¼Œåœ¨[1, 7)èŒƒå›´ä¹‹é—´ï¼Œæ‰€ä»¥åˆ°é¡µ 30 ä¸­æŸ¥æ‰¾æ›´è¯¦ç»†çš„ç›®å½•é¡¹ï¼›
- åœ¨éå¶å­èŠ‚ç‚¹ï¼ˆé¡µ30ï¼‰ä¸­ï¼Œç»§ç»­é€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°ç¬¦åˆé¡µå†…èŒƒå›´åŒ…å«æŸ¥è¯¢å€¼çš„é¡µï¼Œä¸»é”®å€¼å¤§äº 5ï¼Œæ‰€ä»¥å°±åˆ°å¶å­èŠ‚ç‚¹ï¼ˆé¡µ16ï¼‰æŸ¥æ‰¾è®°å½•ï¼›
- æ¥ç€ï¼Œåœ¨å¶å­èŠ‚ç‚¹ï¼ˆé¡µ16ï¼‰ä¸­ï¼Œé€šè¿‡æ§½æŸ¥æ‰¾è®°å½•æ—¶ï¼Œä½¿ç”¨äºŒåˆ†æ³•å¿«é€Ÿå®šä½è¦æŸ¥è¯¢çš„è®°å½•åœ¨å“ªä¸ªæ§½ï¼ˆå“ªä¸ªè®°å½•åˆ†ç»„ï¼‰ï¼Œå®šä½åˆ°æ§½åï¼Œå†éå†æ§½å†…çš„æ‰€æœ‰è®°å½•ï¼Œæ‰¾åˆ°ä¸»é”®ä¸º 6 çš„è®°å½•ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å®šä½è®°å½•æ‰€åœ¨å“ªä¸€ä¸ªé¡µæ—¶ï¼Œä¹Ÿæ˜¯é€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°åŒ…å«è¯¥è®°å½•çš„é¡µã€‚å®šä½åˆ°è¯¥é¡µåï¼Œåˆä¼šåœ¨è¯¥é¡µå†…è¿›è¡ŒäºŒåˆ†æ³•å¿«é€Ÿå®šä½è®°å½•æ‰€åœ¨çš„åˆ†ç»„ï¼ˆæ§½å·ï¼‰ï¼Œæœ€ååœ¨åˆ†ç»„å†…è¿›è¡Œéå†æŸ¥æ‰¾ã€‚

#### å•ç‚¹æŸ¥è¯¢

B æ ‘è¿›è¡Œå•ä¸ªç´¢å¼•æŸ¥è¯¢æ—¶ï¼Œæœ€å¿«å¯ä»¥åœ¨ O(1) çš„æ—¶é—´ä»£ä»·å†…å°±æŸ¥åˆ°ï¼Œè€Œä»å¹³å‡æ—¶é—´ä»£ä»·æ¥çœ‹ï¼Œä¼šæ¯” B+ æ ‘ç¨å¿«ä¸€äº›ã€‚

ä½†æ˜¯ B æ ‘çš„æŸ¥è¯¢æ³¢åŠ¨ä¼šæ¯”è¾ƒå¤§ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹å³å­˜ç´¢å¼•åˆå­˜è®°å½•ï¼Œæ‰€ä»¥æœ‰æ—¶å€™è®¿é—®åˆ°äº†éå¶å­èŠ‚ç‚¹å°±å¯ä»¥æ‰¾åˆ°ç´¢å¼•ï¼Œè€Œæœ‰æ—¶éœ€è¦è®¿é—®åˆ°å¶å­èŠ‚ç‚¹æ‰èƒ½æ‰¾åˆ°ç´¢å¼•ã€‚

**B+ æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸å­˜æ”¾å®é™…çš„è®°å½•æ•°æ®ï¼Œä»…å­˜æ”¾ç´¢å¼•ï¼Œå› æ­¤æ•°æ®é‡ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œç›¸æ¯”å­˜å‚¨å³å­˜ç´¢å¼•åˆå­˜è®°å½•çš„ B æ ‘ï¼ŒB+æ ‘çš„éå¶å­èŠ‚ç‚¹å¯ä»¥å­˜æ”¾æ›´å¤šçš„ç´¢å¼•ï¼Œå› æ­¤ B+ æ ‘å¯ä»¥æ¯” B æ ‘æ›´ã€ŒçŸ®èƒ–ã€ï¼ŒæŸ¥è¯¢åº•å±‚èŠ‚ç‚¹çš„ç£ç›˜ I/Oæ¬¡æ•°ä¼šæ›´å°‘**ã€‚

#### æ’å…¥å’Œåˆ é™¤æ•ˆç‡

B+ æ ‘æœ‰å¤§é‡çš„å†—ä½™èŠ‚ç‚¹ï¼Œè¿™æ ·ä½¿å¾—åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä»å¶å­èŠ‚ç‚¹ä¸­åˆ é™¤ï¼Œç”šè‡³å¯ä»¥ä¸åŠ¨éå¶å­èŠ‚ç‚¹ï¼Œè¿™æ ·åˆ é™¤éå¸¸å¿«ï¼Œ

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªåŠ¨å›¾æ˜¯åˆ é™¤ B+ æ ‘ 0004 èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œå› ä¸ºéå¶å­èŠ‚ç‚¹æœ‰ 0004 çš„å†—ä½™èŠ‚ç‚¹ï¼Œæ‰€ä»¥åœ¨åˆ é™¤çš„æ—¶å€™ï¼Œæ ‘å½¢ç»“æ„å˜åŒ–å¾ˆå°ï¼š

![](https://img-blog.csdnimg.cn/25508b0cd9c44ef6937fdd737020a7f1.gif)

> æ³¨æ„ï¼Œï¼šB+ æ ‘å¯¹äºéå¶å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å’Œç´¢å¼•çš„ä¸ªæ•°ï¼Œå®šä¹‰æ–¹å¼å¯èƒ½ä¼šæœ‰ä¸åŒï¼Œæœ‰çš„æ˜¯è¯´éå¶å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„ä¸ªæ•°ä¸º M  é˜¶ï¼Œè€Œç´¢å¼•çš„ä¸ªæ•°ä¸º M-1ï¼ˆè¿™ä¸ªæ˜¯ç»´åŸºç™¾ç§‘é‡Œçš„å®šä¹‰ï¼‰ï¼Œå› æ­¤æˆ‘æœ¬æ–‡å…³äº B+ æ ‘çš„åŠ¨å›¾éƒ½æ˜¯åŸºäºè¿™ä¸ªã€‚ä½†æ˜¯æˆ‘åœ¨å‰é¢ä»‹ç» B+ æ ‘ä¸ B+  æ ‘çš„å·®å¼‚æ—¶ï¼Œè¯´çš„æ˜¯ã€Œéå¶å­èŠ‚ç‚¹ä¸­æœ‰å¤šå°‘ä¸ªå­èŠ‚ç‚¹ï¼Œå°±æœ‰å¤šå°‘ä¸ªç´¢å¼•ã€ï¼Œä¸»è¦æ˜¯ MySQL ç”¨åˆ°çš„ B+ æ ‘å°±æ˜¯è¿™ä¸ªç‰¹æ€§ã€‚

ä¸‹é¢è¿™ä¸ªåŠ¨å›¾æ˜¯åˆ é™¤ B æ ‘ 0008 èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ ‘çš„å¤æ‚å˜åŒ–ï¼š

![](https://img-blog.csdnimg.cn/2be62679487640bbaac663fa96c7f35f.gif)

ç”šè‡³ï¼ŒB+ æ ‘åœ¨åˆ é™¤æ ¹èŠ‚ç‚¹çš„æ—¶å€™ï¼Œç”±äºå­˜åœ¨å†—ä½™çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿå¤æ‚çš„æ ‘çš„å˜å½¢ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªåŠ¨å›¾æ˜¯åˆ é™¤ B+ æ ‘æ ¹èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼š

![](https://img-blog.csdnimg.cn/23730b5af987480fabff0f1d142a2b6c.gif)

B æ ‘åˆ™ä¸åŒï¼ŒB æ ‘æ²¡æœ‰å†—ä½™èŠ‚ç‚¹ï¼Œåˆ é™¤èŠ‚ç‚¹çš„æ—¶å€™éå¸¸å¤æ‚ï¼Œæ¯”å¦‚åˆ é™¤æ ¹èŠ‚ç‚¹ä¸­çš„æ•°æ®ï¼Œå¯èƒ½æ¶‰åŠå¤æ‚çš„æ ‘çš„å˜å½¢ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªåŠ¨å›¾æ˜¯åˆ é™¤ B æ ‘æ ¹èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼š

![](https://img-blog.csdnimg.cn/img_convert/7552002f9b8195ab650d431bfe66cce2.gif)

B+ æ ‘çš„æ’å…¥ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæœ‰å†—ä½™èŠ‚ç‚¹ï¼Œæ’å…¥å¯èƒ½å­˜åœ¨èŠ‚ç‚¹çš„åˆ†è£‚ï¼ˆå¦‚æœèŠ‚ç‚¹é¥±å’Œï¼‰ï¼Œä½†æ˜¯æœ€å¤šåªæ¶‰åŠæ ‘çš„ä¸€æ¡è·¯å¾„ã€‚è€Œä¸” B+ æ ‘ä¼šè‡ªåŠ¨å¹³è¡¡ï¼Œä¸éœ€è¦åƒæ›´å¤šå¤æ‚çš„ç®—æ³•ï¼Œç±»ä¼¼çº¢é»‘æ ‘çš„æ—‹è½¬æ“ä½œç­‰ã€‚

å› æ­¤ï¼Œ**B+ æ ‘çš„æ’å…¥å’Œåˆ é™¤æ•ˆç‡æ›´é«˜**ã€‚

#### èŒƒå›´æŸ¥è¯¢

B æ ‘å’Œ B+ æ ‘ç­‰å€¼æŸ¥è¯¢åŸç†åŸºæœ¬ä¸€è‡´ï¼Œå…ˆä»æ ¹èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œç„¶åå¯¹æ¯”ç›®æ ‡æ•°æ®çš„èŒƒå›´ï¼Œæœ€åé€’å½’çš„è¿›å…¥å­èŠ‚ç‚¹æŸ¥æ‰¾ã€‚

å› ä¸º **B+ æ ‘æ‰€æœ‰å¶å­èŠ‚ç‚¹é—´è¿˜æœ‰ä¸€ä¸ªé“¾è¡¨è¿›è¡Œè¿æ¥ï¼Œè¿™ç§è®¾è®¡å¯¹èŒƒå›´æŸ¥æ‰¾éå¸¸æœ‰å¸®åŠ©**ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬æƒ³çŸ¥é“ 12 æœˆ 1 æ—¥å’Œ 12 æœˆ 12 æ—¥ä¹‹é—´çš„è®¢å•ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å…ˆæŸ¥æ‰¾åˆ° 12 æœˆ 1 æ—¥æ‰€åœ¨çš„å¶å­èŠ‚ç‚¹ï¼Œç„¶ååˆ©ç”¨é“¾è¡¨å‘å³éå†ï¼Œç›´åˆ°æ‰¾åˆ° 12 æœˆ12 æ—¥çš„èŠ‚ç‚¹ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä»æ ¹èŠ‚ç‚¹æŸ¥è¯¢äº†ï¼Œè¿›ä¸€æ­¥èŠ‚çœæŸ¥è¯¢éœ€è¦çš„æ—¶é—´ã€‚

è€Œ B æ ‘æ²¡æœ‰å°†æ‰€æœ‰å¶å­èŠ‚ç‚¹ç”¨é“¾è¡¨ä¸²è”èµ·æ¥çš„ç»“æ„ï¼Œå› æ­¤åªèƒ½é€šè¿‡æ ‘çš„éå†æ¥å®ŒæˆèŒƒå›´æŸ¥è¯¢ï¼Œè¿™ä¼šæ¶‰åŠå¤šä¸ªèŠ‚ç‚¹çš„ç£ç›˜ I/O æ“ä½œï¼ŒèŒƒå›´æŸ¥è¯¢æ•ˆç‡ä¸å¦‚ B+ æ ‘ã€‚

å› æ­¤ï¼Œå­˜åœ¨å¤§é‡èŒƒå›´æ£€ç´¢çš„åœºæ™¯ï¼Œé€‚åˆä½¿ç”¨ B+æ ‘ï¼Œæ¯”å¦‚æ•°æ®åº“ã€‚è€Œå¯¹äºå¤§é‡çš„å•ä¸ªç´¢å¼•æŸ¥è¯¢çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ B æ ‘ï¼Œæ¯”å¦‚ nosql çš„MongoDB

#### MySQL ä¸­çš„ B+ æ ‘

MySQL çš„å­˜å‚¨æ–¹å¼æ ¹æ®å­˜å‚¨å¼•æ“çš„ä¸åŒè€Œä¸åŒï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯ Innodb å­˜å‚¨å¼•æ“ï¼Œå®ƒå°±æ˜¯é‡‡ç”¨äº† B+ æ ‘ä½œä¸ºäº†ç´¢å¼•çš„æ•°æ®ç»“æ„ã€‚

ä¸‹å›¾å°±æ˜¯ Innodb é‡Œçš„ B+ æ ‘ï¼š

![image-20220718133843334](./images/image-20220718133843334.png)

ä½†æ˜¯ Innodb ä½¿ç”¨çš„  B+ æ ‘æœ‰ä¸€äº›ç‰¹åˆ«çš„ç‚¹ï¼Œæ¯”å¦‚ï¼š

- B+ æ ‘çš„å¶å­èŠ‚ç‚¹ä¹‹é—´æ˜¯ç”¨ã€ŒåŒå‘é“¾è¡¨ã€è¿›è¡Œè¿æ¥ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯æ—¢èƒ½å‘å³éå†ï¼Œä¹Ÿèƒ½å‘å·¦éå†ã€‚
- B+ æ ‘ç‚¹èŠ‚ç‚¹å†…å®¹æ˜¯æ•°æ®é¡µï¼Œæ•°æ®é¡µé‡Œå­˜æ”¾äº†ç”¨æˆ·çš„è®°å½•ä»¥åŠå„ç§ä¿¡æ¯ï¼Œæ¯ä¸ªæ•°æ®é¡µé»˜è®¤å¤§å°æ˜¯ 16 KBã€‚

Innodb æ ¹æ®ç´¢å¼•ç±»å‹ä¸åŒï¼Œåˆ†ä¸ºèšé›†å’ŒäºŒçº§ç´¢å¼•ã€‚ä»–ä»¬åŒºåˆ«åœ¨äºï¼Œèšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯å®é™…æ•°æ®ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨èšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ï¼Œè€ŒäºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯å®é™…æ•°æ®ã€‚

å› ä¸ºè¡¨çš„æ•°æ®éƒ½æ˜¯å­˜æ”¾åœ¨èšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹é‡Œï¼Œæ‰€ä»¥ InnoDB å­˜å‚¨å¼•æ“ä¸€å®šä¼šä¸ºè¡¨åˆ›å»ºä¸€ä¸ªèšé›†ç´¢å¼•ï¼Œä¸”ç”±äºæ•°æ®åœ¨ç‰©ç†ä¸Šåªä¼šä¿å­˜ä¸€ä»½ï¼Œæ‰€ä»¥èšç°‡ç´¢å¼•åªèƒ½æœ‰ä¸€ä¸ªï¼Œè€ŒäºŒçº§ç´¢å¼•å¯ä»¥åˆ›å»ºå¤šä¸ªã€‚

### MySQLä¸‰å¤§æ—¥å¿—ï¼ˆbinlogã€redo logã€undo logï¼‰

`MySQL` æ—¥å¿— ä¸»è¦åŒ…æ‹¬é”™è¯¯æ—¥å¿—ã€æŸ¥è¯¢æ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—ã€äº‹åŠ¡æ—¥å¿—ã€äºŒè¿›åˆ¶æ—¥å¿—å‡ å¤§ç±»ã€‚å…¶ä¸­ï¼Œæ¯”è¾ƒé‡è¦çš„è¿˜è¦å±äºŒè¿›åˆ¶æ—¥å¿— `binlog`ï¼ˆå½’æ¡£æ—¥å¿—ï¼‰å’Œäº‹åŠ¡æ—¥å¿— `redo log`ï¼ˆé‡åšæ—¥å¿—ï¼‰å’Œ `undo log`ï¼ˆå›æ»šæ—¥å¿—ï¼‰

![image-20220613210057735](./images/image-20220613210057735.png)

#### redo log

`redo log`ï¼ˆé‡åšæ—¥å¿—ï¼‰æ˜¯ `InnoDB`å­˜å‚¨å¼•æ“ç‹¬æœ‰çš„ï¼Œå®ƒè®© `MySQL`æ‹¥æœ‰äº†å´©æºƒæ¢å¤èƒ½åŠ›ã€‚

æ¯”å¦‚ `MySQL` å®ä¾‹æŒ‚äº†æˆ–å®•æœºäº†ï¼Œé‡å¯æ—¶ï¼Œ`InnoDB`å­˜å‚¨å¼•æ“ä¼šä½¿ç”¨ `redo log`æ¢å¤æ•°æ®ï¼Œä¿è¯æ•°æ®çš„æŒä¹…æ€§ä¸å®Œæ•´æ€§ã€‚

![image-20220706212928940](./images/image-20220706212928940.png)

`MySQL` ä¸­æ•°æ®æ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œä½ æŸ¥è¯¢ä¸€æ¡è®°å½•ï¼Œä¼šä»ç¡¬ç›˜æŠŠä¸€é¡µçš„æ•°æ®åŠ è½½å‡ºæ¥ï¼ŒåŠ è½½å‡ºæ¥çš„æ•°æ®å«æ•°æ®é¡µï¼Œä¼šæ”¾å…¥åˆ° `Buffer Pool` ä¸­ã€‚

åç»­çš„æŸ¥è¯¢éƒ½æ˜¯å…ˆä» `Buffer Pool` ä¸­æ‰¾ï¼Œæ²¡æœ‰å‘½ä¸­å†å»ç¡¬ç›˜åŠ è½½ï¼Œå‡å°‘ç¡¬ç›˜ `IO` å¼€é”€ï¼Œæå‡æ€§èƒ½ã€‚

æ›´æ–°è¡¨æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå‘ç° `Buffer Pool` é‡Œå­˜åœ¨è¦æ›´æ–°çš„æ•°æ®ï¼Œå°±ç›´æ¥åœ¨ `Buffer Pool` é‡Œæ›´æ–°ã€‚

ç„¶åä¼šæŠŠâ€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€è®°å½•åˆ°é‡åšæ—¥å¿—ç¼“å­˜ï¼ˆ`redo log buffer`ï¼‰é‡Œï¼Œæ¥ç€åˆ·ç›˜åˆ° `redo log` æ–‡ä»¶é‡Œã€‚

![image-20220706212937926](./images/image-20220706212937926.png)

> å›¾ç‰‡ç¬”è¯¯æç¤ºï¼šç¬¬ 4 æ­¥ â€œæ¸…ç©º redo log buffe åˆ·ç›˜åˆ° redo æ—¥å¿—ä¸­â€è¿™å¥è¯ä¸­çš„ buffe åº”è¯¥æ˜¯ bufferã€‚

ç†æƒ³æƒ…å†µï¼Œäº‹åŠ¡ä¸€æäº¤å°±ä¼šè¿›è¡Œåˆ·ç›˜æ“ä½œï¼Œä½†å®é™…ä¸Šï¼Œåˆ·ç›˜çš„æ—¶æœºæ˜¯æ ¹æ®ç­–ç•¥æ¥è¿›è¡Œçš„ã€‚

> å°è´´å£«ï¼šæ¯æ¡ redo è®°å½•ç”±â€œè¡¨ç©ºé—´å·+æ•°æ®é¡µå·+åç§»é‡+ä¿®æ”¹æ•°æ®é•¿åº¦+å…·ä½“ä¿®æ”¹çš„æ•°æ®â€ç»„æˆ



##### PageCache

æˆ‘ä»¬çŸ¥é“æ–‡ä»¶ä¸€èˆ¬å­˜æ”¾åœ¨ç¡¬ç›˜ï¼ˆæœºæ¢°ç¡¬ç›˜æˆ–å›ºæ€ç¡¬ç›˜ï¼‰ä¸­ï¼ŒCPU å¹¶ä¸èƒ½ç›´æ¥è®¿é—®ç¡¬ç›˜ä¸­çš„æ•°æ®ï¼Œè€Œæ˜¯éœ€è¦å…ˆå°†ç¡¬ç›˜ä¸­çš„æ•°æ®è¯»å…¥åˆ°å†…å­˜ä¸­ï¼Œç„¶åæ‰èƒ½è¢« CPU è®¿é—®ã€‚

ç”±äºè¯»å†™ç¡¬ç›˜çš„é€Ÿåº¦æ¯”è¯»å†™å†…å­˜è¦æ…¢å¾ˆå¤šï¼ˆDDR4 å†…å­˜è¯»å†™é€Ÿåº¦æ˜¯æœºæ¢°ç¡¬ç›˜500å€ï¼Œæ˜¯å›ºæ€ç¡¬ç›˜çš„200å€ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…æ¯æ¬¡è¯»å†™æ–‡ä»¶æ—¶ï¼Œéƒ½éœ€è¦å¯¹ç¡¬ç›˜è¿›è¡Œè¯»å†™æ“ä½œï¼ŒLinux å†…æ ¸ä½¿ç”¨ `é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰` æœºåˆ¶æ¥å¯¹æ–‡ä»¶ä¸­çš„æ•°æ®è¿›è¡Œç¼“å­˜ã€‚

> æœ¬æ–‡ä½¿ç”¨çš„ Linux å†…æ ¸ç‰ˆæœ¬ä¸ºï¼šLinux-2.6.23

###### ä»€ä¹ˆæ˜¯é¡µç¼“å­˜

ä¸ºäº†æå‡å¯¹æ–‡ä»¶çš„è¯»å†™æ•ˆç‡ï¼ŒLinux å†…æ ¸ä¼šä»¥é¡µå¤§å°ï¼ˆ4KBï¼‰ä¸ºå•ä½ï¼Œå°†æ–‡ä»¶åˆ’åˆ†ä¸ºå¤šæ•°æ®å—ã€‚å½“ç”¨æˆ·å¯¹æ–‡ä»¶ä¸­çš„æŸä¸ªæ•°æ®å—è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå†…æ ¸é¦–å…ˆä¼šç”³è¯·ä¸€ä¸ªå†…å­˜é¡µï¼ˆç§°ä¸º `é¡µç¼“å­˜`ï¼‰ä¸æ–‡ä»¶ä¸­çš„æ•°æ®å—è¿›è¡Œç»‘å®šã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220725150519009](images/image-20220725150519009.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“ç”¨æˆ·å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ—¶ï¼Œå®é™…ä¸Šæ˜¯å¯¹æ–‡ä»¶çš„ `é¡µç¼“å­˜` è¿›è¡Œè¯»å†™ã€‚æ‰€ä»¥å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œä¼šåˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µè¿›è¡Œå¤„ç†ï¼š

- å½“ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®æ—¶ï¼Œå¦‚æœè¦è¯»å–çš„æ•°æ®æ‰€åœ¨çš„é¡µç¼“å­˜å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´ç»™ç”¨æˆ·å³å¯ã€‚å¦åˆ™ï¼Œå†…æ ¸é¦–å…ˆä¼šç”³è¯·ä¸€ä¸ªç©ºé—²çš„å†…å­˜é¡µï¼ˆé¡µç¼“å­˜ï¼‰ï¼Œç„¶åä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°é¡µç¼“å­˜ï¼Œå¹¶ä¸”æŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´ç»™ç”¨æˆ·ã€‚
- å½“å‘æ–‡ä»¶ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå¦‚æœè¦å†™å…¥çš„æ•°æ®æ‰€åœ¨çš„é¡µç¼“å­˜å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆç›´æ¥æŠŠæ–°æ•°æ®å†™å…¥åˆ°é¡µç¼“å­˜å³å¯ã€‚å¦åˆ™ï¼Œå†…æ ¸é¦–å…ˆä¼šç”³è¯·ä¸€ä¸ªç©ºé—²çš„å†…å­˜é¡µï¼ˆé¡µç¼“å­˜ï¼‰ï¼Œç„¶åä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°é¡µç¼“å­˜ï¼Œå¹¶ä¸”æŠŠæ–°æ•°æ®å†™å…¥åˆ°é¡µç¼“å­˜ä¸­ã€‚å¯¹äºè¢«ä¿®æ”¹çš„é¡µç¼“å­˜ï¼Œå†…æ ¸ä¼šå®šæ—¶æŠŠè¿™äº›é¡µç¼“å­˜åˆ·æ–°åˆ°æ–‡ä»¶ä¸­ã€‚

###### é¡µç¼“å­˜çš„å®ç°

å‰é¢ä¸»è¦ä»‹ç»äº†é¡µç¼“å­˜çš„ä½œç”¨å’ŒåŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¼šåˆ†æ Linux å†…æ ¸æ˜¯æ€ä¹ˆå®ç°é¡µç¼“å­˜æœºåˆ¶çš„ã€‚

1. address_space

åœ¨ Linux å†…æ ¸ä¸­ï¼Œä½¿ç”¨ `file` å¯¹è±¡æ¥æè¿°ä¸€ä¸ªè¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸ªåä¸º `f_mapping` çš„å­—æ®µï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```c
struct file {
    ...
    struct address_space *f_mapping;
};
```

ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ`f_mapping` å­—æ®µçš„ç±»å‹ä¸º `address_space` ç»“æ„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```c
struct address_space {
    struct inode           *host;      /* owner: inode, block_device */
    struct radix_tree_root page_tree;  /* radix tree of all pages */
    rwlock_t               tree_lock;  /* and rwlock protecting it */
    ...
};
```

`address_space` ç»“æ„å…¶ä¸­çš„ä¸€ä¸ªä½œç”¨å°±æ˜¯ç”¨äºå­˜å‚¨æ–‡ä»¶çš„ `é¡µç¼“å­˜`ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹å„ä¸ªå­—æ®µçš„ä½œç”¨ï¼š

- `host`ï¼šæŒ‡å‘å½“å‰ `address_space` å¯¹è±¡æ‰€å±çš„æ–‡ä»¶ `inode` å¯¹è±¡ï¼ˆæ¯ä¸ªæ–‡ä»¶éƒ½ä½¿ç”¨ä¸€ä¸ª `inode` å¯¹è±¡è¡¨ç¤ºï¼‰ã€‚
- `page_tree`ï¼šç”¨äºå­˜å‚¨å½“å‰æ–‡ä»¶çš„ `é¡µç¼“å­˜`ã€‚
- `tree_lock`ï¼šç”¨äºé˜²æ­¢å¹¶å‘è®¿é—® `page_tree` å¯¼è‡´çš„èµ„æºç«äº‰é—®é¢˜ã€‚

ä» `address_space` å¯¹è±¡çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶çš„ `é¡µç¼“å­˜` ä½¿ç”¨äº† `radixæ ‘` æ¥å­˜å‚¨ã€‚

> `radixæ ‘`ï¼šåˆååŸºæ•°æ ‘ï¼Œå®ƒä½¿ç”¨é”®å€¼ï¼ˆkey-valueï¼‰å¯¹çš„å½¢å¼æ¥ä¿å­˜æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡é”®å¿«é€ŸæŸ¥æ‰¾åˆ°å…¶å¯¹åº”çš„å€¼ã€‚å†…æ ¸ä»¥æ–‡ä»¶è¯»å†™æ“ä½œä¸­çš„æ•°æ® `åç§»é‡` ä½œä¸ºé”®ï¼Œä»¥æ•°æ®åç§»é‡æ‰€åœ¨çš„ `é¡µç¼“å­˜` ä½œä¸ºå€¼ï¼Œå­˜å‚¨åœ¨ `address_space` ç»“æ„çš„ `page_tree` å­—æ®µä¸­ã€‚

ä¸‹å›¾å±•ç¤ºäº†ä¸Šè¿°å„ä¸ªç»“æ„ä¹‹é—´çš„å…³ç³»ï¼š

![image-20220725150553230](images/image-20220725150553230.png)

å¦‚æœå¯¹ `radixæ ‘` ä¸å¤ªäº†è§£ï¼Œå¯ä»¥ç®€å•å°†å…¶çœ‹æˆå¯ä»¥é€šè¿‡æ–‡ä»¶åç§»é‡å¿«é€Ÿæ‰¾åˆ°å…¶æ‰€åœ¨ `é¡µç¼“å­˜` çš„ç»“æ„ï¼Œæœ‰æœºä¼šæˆ‘ä¼šå¦å¤–å†™ä¸€ç¯‡å…³äº `radixæ ‘` çš„æ–‡ç« ã€‚

2. è¯»æ–‡ä»¶æ“ä½œ

ç°åœ¨æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¯»å–æ–‡ä»¶æ•°æ®çš„è¿‡ç¨‹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒç”¨ `read` ç³»ç»Ÿè°ƒç”¨æ¥è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå…¶è°ƒç”¨é“¾å¦‚ä¸‹ï¼š

```
read()
â””â†’ sys_read()
   â””â†’ vfs_read()
      â””â†’ do_sync_read()
         â””â†’ generic_file_aio_read()
            â””â†’ do_generic_file_read()
               â””â†’ do_generic_mapping_read()
```

ä»ä¸Šé¢çš„è°ƒç”¨é“¾å¯ä»¥çœ‹å‡ºï¼Œ`read` ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆä¼šè°ƒç”¨ `do_generic_mapping_read` å‡½æ•°æ¥è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š

```c
void do_generic_mapping_read(struct address_space *mapping,
                        struct file_ra_state *_ra,
                        struct file *filp,
                        loff_t *ppos,
                        read_descriptor_t *desc,
                        read_actor_t actor)
{
    struct inode *inode = mapping->host;
    unsigned long index;
    struct page *cached_page;
    ...

    cached_page = NULL;
    index = *ppos >> PAGE_CACHE_SHIFT;
    ...

    for (;;) {
        struct page *page;
        ...

find_page:
        // 1. æŸ¥æ‰¾æ–‡ä»¶åç§»é‡æ‰€åœ¨çš„é¡µç¼“å­˜æ˜¯å¦å­˜åœ¨
        page = find_get_page(mapping, index);
        if (!page) {
            ...
            // 2. å¦‚æœé¡µç¼“å­˜ä¸å­˜åœ¨, é‚£ä¹ˆè·³åˆ° no_cached_page è¿›è¡Œå¤„ç†
            goto no_cached_page; 
        }
        ...

page_ok:
        ...
        // 3. å¦‚æœé¡µç¼“å­˜å­˜åœ¨, é‚£ä¹ˆæŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·åº”ç”¨ç¨‹åºçš„å†…å­˜ä¸­
        ret = actor(desc, page, offset, nr);
        ...
        if (ret == nr && desc->count)
            continue;
        goto out;
        ...

readpage:
        // 4. ä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°é¡µç¼“å­˜ä¸­
        error = mapping->a_ops->readpage(filp, page);
        ...
        goto page_ok;
        ...

no_cached_page:
        if (!cached_page) {
            // 5. ç”³è¯·ä¸€ä¸ªå†…å­˜é¡µä½œä¸ºé¡µç¼“å­˜
            cached_page = page_cache_alloc_cold(mapping);
            ...
        }

        // 6. æŠŠæ–°ç”³è¯·çš„é¡µç¼“å­˜æ·»åŠ åˆ°æ–‡ä»¶é¡µç¼“å­˜ä¸­
        error = add_to_page_cache_lru(cached_page, mapping, index, GFP_KERNEL);
        ...
        page = cached_page;
        cached_page = NULL;
        goto readpage;
    }

out:
    ...
}
```

`do_generic_mapping_read` å‡½æ•°çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œç»è¿‡ç²¾ç®€åï¼Œä¸Šé¢ä»£ç åªç•™ä¸‹æœ€é‡è¦çš„é€»è¾‘ï¼Œå¯ä»¥å½’çº³ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

- é€šè¿‡è°ƒç”¨ `find_get_page` å‡½æ•°æŸ¥æ‰¾è¦è¯»å–çš„æ–‡ä»¶åç§»é‡æ‰€å¯¹åº”çš„é¡µç¼“å­˜æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±æŠŠé¡µç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„å†…å­˜ä¸­ã€‚
- å¦åˆ™è°ƒç”¨ `page_cache_alloc_cold` å‡½æ•°ç”³è¯·ä¸€ä¸ªç©ºé—²çš„å†…å­˜é¡µä½œä¸ºæ–°çš„é¡µç¼“å­˜ï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨ `add_to_page_cache_lru` å‡½æ•°æŠŠæ–°ç”³è¯·çš„é¡µç¼“å­˜æ·»åŠ åˆ°æ–‡ä»¶é¡µç¼“å­˜å’Œ LRU é˜Ÿåˆ—ä¸­ï¼ˆåé¢ä¼šä»‹ç»ï¼‰ã€‚
- é€šè¿‡è°ƒç”¨ `readpage` æ¥å£ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°é¡µç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æŠŠé¡µç¼“å­˜çš„æ•°æ®æ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„å†…å­˜ä¸­ã€‚

ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“é¡µç¼“å­˜ä¸å­˜åœ¨æ—¶ä¼šç”³è¯·ä¸€å—ç©ºé—²çš„å†…å­˜é¡µä½œä¸ºé¡µç¼“å­˜ï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨ `add_to_page_cache_lru` å‡½æ•°æŠŠå…¶æ·»åŠ åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜å’Œ LRU é˜Ÿåˆ—ä¸­ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ `add_to_page_cache_lru` å‡½æ•°çš„å®ç°ï¼š

```c
 int add_to_page_cache_lru(struct page *page, struct address_space *mapping,
                           pgoff_t offset, gfp_t gfp_mask)
{
    // 1. æŠŠé¡µç¼“å­˜æ·»åŠ åˆ°æ–‡ä»¶é¡µç¼“å­˜ä¸­
    int ret = add_to_page_cache(page, mapping, offset, gfp_mask);
    if (ret == 0)
        lru_cache_add(page); // 2. æŠŠé¡µç¼“å­˜æ·»åŠ åˆ° LRU é˜Ÿåˆ—ä¸­
    return ret;
}
```

`add_to_page_cache_lru` å‡½æ•°ä¸»è¦å®Œæˆä¸¤ä¸ªå·¥ä½œï¼š

- é€šè¿‡è°ƒç”¨ `add_to_page_cache` å‡½æ•°æŠŠé¡µç¼“å­˜æ·»åŠ åˆ°æ–‡ä»¶é¡µç¼“å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ åˆ° `address_space` ç»“æ„çš„ `page_tree` å­—æ®µä¸­ã€‚
- é€šè¿‡è°ƒç”¨ `lru_cache_add` å‡½æ•°æŠŠé¡µç¼“å­˜æ·»åŠ åˆ° LRU é˜Ÿåˆ—ä¸­ã€‚LRU é˜Ÿåˆ—ç”¨äºå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œå¯¹é¡µç¼“å­˜è¿›è¡Œæ¸…ç†æ—¶ä½¿ç”¨ã€‚

###### æ€»ç»“

æœ¬æ–‡ä¸»è¦ä»‹ç»äº† `é¡µç¼“å­˜` çš„ä½œç”¨å’ŒåŸç†ï¼Œå¹¶ä¸”ä»‹ç»äº†åœ¨è¯»å–æ–‡ä»¶æ•°æ®æ—¶å¯¹é¡µç¼“å­˜çš„å¤„ç†è¿‡ç¨‹ã€‚æœ¬æ–‡å¹¶æ²¡æœ‰ä»‹ç»å†™æ–‡ä»¶æ“ä½œå¯¹åº”çš„é¡µç¼“å­˜å¤„ç†å’Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶æ€ä¹ˆé‡Šæ”¾é¡µç¼“å­˜ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œé˜…è¯»ç›¸å…³çš„ä»£ç å®ç°ã€‚



##### åˆ·ç›˜æ—¶æœº

`InnoDB` å­˜å‚¨å¼•æ“ä¸º `redo log` çš„åˆ·ç›˜ç­–ç•¥æä¾›äº† `innodb_flush_log_at_trx_commit` å‚æ•°ï¼Œå®ƒæ”¯æŒä¸‰ç§ç­–ç•¥ï¼š

- **0** ï¼šè®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ä¸è¿›è¡Œåˆ·ç›˜æ“ä½œ
- **1** ï¼šè®¾ç½®ä¸º 1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½å°†è¿›è¡Œåˆ·ç›˜æ“ä½œï¼ˆé»˜è®¤å€¼ï¼‰
- **2** ï¼šè®¾ç½®ä¸º 2 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæŠŠ redo log buffer å†…å®¹å†™å…¥ page cache

`innodb_flush_log_at_trx_commit` å‚æ•°é»˜è®¤ä¸º 1 ï¼Œä¹Ÿå°±æ˜¯è¯´å½“äº‹åŠ¡æäº¤æ—¶ä¼šè°ƒç”¨ `fsync` å¯¹ redo log è¿›è¡Œåˆ·ç›˜

å¦å¤–ï¼Œ`InnoDB` å­˜å‚¨å¼•æ“æœ‰ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œæ¯éš” `1` ç§’ï¼Œå°±ä¼šæŠŠ `redo log buffer` ä¸­çš„å†…å®¹å†™åˆ°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼ˆ`page cache`ï¼‰ï¼Œç„¶åè°ƒç”¨ `fsync` åˆ·ç›˜ã€‚

![image-20220706213001613](./images/image-20220706213001613.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ²¡æœ‰æäº¤äº‹åŠ¡çš„ `redo log` è®°å½•ï¼Œä¹Ÿå¯èƒ½ä¼šåˆ·ç›˜ã€‚

**ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ**

å› ä¸ºåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ `redo log` è®°å½•æ˜¯ä¼šå†™å…¥ `redo log buffer` ä¸­ï¼Œè¿™äº› `redo log` è®°å½•ä¼šè¢«åå°çº¿ç¨‹åˆ·ç›˜ã€‚

![image-20220706213009977](./images/image-20220706213009977.png)

é™¤äº†åå°çº¿ç¨‹æ¯ç§’ `1`æ¬¡çš„è½®è¯¢æ“ä½œï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå½“ `redo log buffer` å ç”¨çš„ç©ºé—´å³å°†è¾¾åˆ° `innodb_log_buffer_size` ä¸€åŠçš„æ—¶å€™ï¼Œåå°çº¿ç¨‹ä¼šä¸»åŠ¨åˆ·ç›˜ã€‚

ä¸‹é¢æ˜¯ä¸åŒåˆ·ç›˜ç­–ç•¥çš„æµç¨‹å›¾

innodb_flush_log_at_trx_commit=0

![image-20220706213032809](./images/image-20220706213032809.png)

ä¸º `0`æ—¶ï¼Œå¦‚æœ `MySQL`æŒ‚äº†æˆ–å®•æœºå¯èƒ½ä¼šæœ‰ `1`ç§’æ•°æ®çš„ä¸¢å¤±ã€‚

innodb_flush_log_at_trx_commit=1

![image-20220706213045311](./images/image-20220706213045311.png)

ä¸º `1`æ—¶ï¼Œ åªè¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œ`redo log`è®°å½•å°±ä¸€å®šåœ¨ç¡¬ç›˜é‡Œï¼Œä¸ä¼šæœ‰ä»»ä½•æ•°æ®ä¸¢å¤±ã€‚

å¦‚æœäº‹åŠ¡æ‰§è¡ŒæœŸé—´ `MySQL`æŒ‚äº†æˆ–å®•æœºï¼Œè¿™éƒ¨åˆ†æ—¥å¿—ä¸¢äº†ï¼Œä½†æ˜¯äº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼Œæ‰€ä»¥æ—¥å¿—ä¸¢äº†ä¹Ÿä¸ä¼šæœ‰æŸå¤±ã€‚

innodb_flush_log_at_trx_commit=2

![image-20220706213100010](./images/image-20220706213100010.png)

ä¸º `2`æ—¶ï¼Œ åªè¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œ`redo log buffer`ä¸­çš„å†…å®¹åªå†™å…¥æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼ˆ`page cache`ï¼‰ã€‚

å¦‚æœä»…ä»…åªæ˜¯ `MySQL`æŒ‚äº†ä¸ä¼šæœ‰ä»»ä½•æ•°æ®ä¸¢å¤±ï¼Œä½†æ˜¯å®•æœºå¯èƒ½ä¼šæœ‰ `1`ç§’æ•°æ®çš„ä¸¢å¤±ã€‚

##### æ—¥å¿—æ–‡ä»¶ç»„

 ç¡¬ç›˜ä¸Šå­˜å‚¨çš„ `redo log` æ—¥å¿—æ–‡ä»¶ä¸åªä¸€ä¸ªï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ª**æ—¥å¿—æ–‡ä»¶ç»„**çš„å½¢å¼å‡ºç°çš„ï¼Œæ¯ä¸ªçš„ `redo`æ—¥å¿—æ–‡ä»¶å¤§å°éƒ½æ˜¯ä¸€æ ·çš„ã€‚

æ¯”å¦‚å¯ä»¥é…ç½®ä¸ºä¸€ç»„ `4`ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯ `1GB`ï¼Œæ•´ä¸ª `redo log` æ—¥å¿—æ–‡ä»¶ç»„å¯ä»¥è®°å½• `4G`çš„å†…å®¹ã€‚

å®ƒé‡‡ç”¨çš„æ˜¯ç¯å½¢æ•°ç»„å½¢å¼ï¼Œä»å¤´å¼€å§‹å†™ï¼Œå†™åˆ°æœ«å°¾åˆå›åˆ°å¤´å¾ªç¯å†™ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![image-20220706213128010](./images/image-20220706213128010.png)

åœ¨ä¸ª**æ—¥å¿—æ–‡ä»¶ç»„**ä¸­è¿˜æœ‰ä¸¤ä¸ªé‡è¦çš„å±æ€§ï¼Œåˆ†åˆ«æ˜¯ `write posã€checkpoint`

- **write pos** æ˜¯å½“å‰è®°å½•çš„ä½ç½®ï¼Œä¸€è¾¹å†™ä¸€è¾¹åç§»
- **checkpoint** æ˜¯å½“å‰è¦æ“¦é™¤çš„ä½ç½®ï¼Œä¹Ÿæ˜¯å¾€åæ¨ç§»

æ¯æ¬¡åˆ·ç›˜ `redo log` è®°å½•åˆ°**æ—¥å¿—æ–‡ä»¶ç»„**ä¸­ï¼Œ`write pos` ä½ç½®å°±ä¼šåç§»æ›´æ–°ã€‚

æ¯æ¬¡ `MySQL` åŠ è½½**æ—¥å¿—æ–‡ä»¶ç»„**æ¢å¤æ•°æ®æ—¶ï¼Œä¼šæ¸…ç©ºåŠ è½½è¿‡çš„ `redo log` è®°å½•ï¼Œå¹¶æŠŠ `checkpoint` åç§»æ›´æ–°ã€‚

`write pos` å’Œ `checkpoint` ä¹‹é—´çš„è¿˜ç©ºç€çš„éƒ¨åˆ†å¯ä»¥ç”¨æ¥å†™å…¥æ–°çš„ `redo log` è®°å½•ã€‚

![image-20220706213147439](./images/image-20220706213147439.png)

å¦‚æœ `write pos` è¿½ä¸Š `checkpoint` ï¼Œè¡¨ç¤º**æ—¥å¿—æ–‡ä»¶ç»„**æ»¡äº†ï¼Œè¿™æ—¶å€™ä¸èƒ½å†å†™å…¥æ–°çš„ `redo log` è®°å½•ï¼Œ`MySQL` å¾—åœä¸‹æ¥ï¼Œæ¸…ç©ºä¸€äº›è®°å½•ï¼ŒæŠŠ `checkpoint` æ¨è¿›ä¸€ä¸‹ã€‚

![image-20220706213155597](./images/image-20220706213155597.png)

##### redo log å°ç»“

ç›¸ä¿¡å¤§å®¶éƒ½çŸ¥é“ `redo log` çš„ä½œç”¨å’Œå®ƒçš„åˆ·ç›˜æ—¶æœºã€å­˜å‚¨å½¢å¼ã€‚

ç°åœ¨æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š **åªè¦æ¯æ¬¡æŠŠä¿®æ”¹åçš„æ•°æ®é¡µç›´æ¥åˆ·ç›˜ä¸å°±å¥½äº†ï¼Œè¿˜æœ‰ `redo log` ä»€ä¹ˆäº‹ï¼Ÿ**

å®ƒä»¬ä¸éƒ½æ˜¯åˆ·ç›˜ä¹ˆï¼Ÿå·®åˆ«åœ¨å“ªé‡Œï¼Ÿ

```java
1 Byte = 8bit
1 KB = 1024 Byte
1 MB = 1024 KB
1 GB = 1024 MB
1 TB = 1024 GB
```

å®é™…ä¸Šï¼Œæ•°æ®é¡µå¤§å°æ˜¯ `16KB`ï¼Œåˆ·ç›˜æ¯”è¾ƒè€—æ—¶ï¼Œå¯èƒ½å°±ä¿®æ”¹äº†æ•°æ®é¡µé‡Œçš„å‡  `Byte` æ•°æ®ï¼Œæœ‰å¿…è¦æŠŠå®Œæ•´çš„æ•°æ®é¡µåˆ·ç›˜å—ï¼Ÿ

è€Œä¸”æ•°æ®é¡µåˆ·ç›˜æ˜¯éšæœºå†™ï¼Œå› ä¸ºä¸€ä¸ªæ•°æ®é¡µå¯¹åº”çš„ä½ç½®å¯èƒ½åœ¨ç¡¬ç›˜æ–‡ä»¶çš„éšæœºä½ç½®ï¼Œæ‰€ä»¥æ€§èƒ½æ˜¯å¾ˆå·®ã€‚

å¦‚æœæ˜¯å†™ `redo log`ï¼Œä¸€è¡Œè®°å½•å¯èƒ½å°±å å‡ å `Byte`ï¼ŒåªåŒ…å«è¡¨ç©ºé—´å·ã€æ•°æ®é¡µå·ã€ç£ç›˜æ–‡ä»¶åç§» é‡ã€æ›´æ–°å€¼ï¼Œå†åŠ ä¸Šæ˜¯é¡ºåºå†™ï¼Œæ‰€ä»¥åˆ·ç›˜é€Ÿåº¦å¾ˆå¿«ã€‚

æ‰€ä»¥ç”¨ `redo log` å½¢å¼è®°å½•ä¿®æ”¹å†…å®¹ï¼Œæ€§èƒ½ä¼šè¿œè¿œè¶…è¿‡åˆ·æ•°æ®é¡µçš„æ–¹å¼ï¼Œè¿™ä¹Ÿè®©æ•°æ®åº“çš„å¹¶å‘èƒ½åŠ›æ›´å¼ºã€‚

> å…¶å®å†…å­˜çš„æ•°æ®é¡µåœ¨ä¸€å®šæ—¶æœºä¹Ÿä¼šåˆ·ç›˜ï¼Œæˆ‘ä»¬æŠŠè¿™ç§°ä¸ºé¡µåˆå¹¶ï¼Œè®² `Buffer Pool`çš„æ—¶å€™ä¼šå¯¹è¿™å—ç»†è¯´

#### binlog

`redo log` å®ƒæ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•å†…å®¹æ˜¯â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€ï¼Œå±äº `InnoDB` å­˜å‚¨å¼•æ“ã€‚

è€Œ `binlog` æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•å†…å®¹æ˜¯è¯­å¥çš„åŸå§‹é€»è¾‘ï¼Œç±»ä¼¼äºâ€œç»™ ID=2 è¿™ä¸€è¡Œçš„ c å­—æ®µåŠ  1â€ï¼Œå±äº `MySQL Server` å±‚ã€‚

ä¸ç®¡ç”¨ä»€ä¹ˆå­˜å‚¨å¼•æ“ï¼Œåªè¦å‘ç”Ÿäº†è¡¨æ•°æ®æ›´æ–°ï¼Œéƒ½ä¼šäº§ç”Ÿ `binlog` æ—¥å¿—ã€‚

é‚£ `binlog` åˆ°åº•æ˜¯ç”¨æ¥å¹²å˜›çš„ï¼Ÿ

å¯ä»¥è¯´ `MySQL`æ•°æ®åº“çš„**æ•°æ®å¤‡ä»½ã€ä¸»å¤‡ã€ä¸»ä¸»ã€ä¸»ä»**éƒ½ç¦»ä¸å¼€ `binlog`ï¼Œéœ€è¦ä¾é  `binlog`æ¥åŒæ­¥æ•°æ®ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

##### è®°å½•æ ¼å¼

`binlog` æ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡ `binlog_format`å‚æ•°æŒ‡å®šã€‚

- **statement**
- **row**
- **mixed**

æŒ‡å®š `statement`ï¼Œè®°å½•çš„å†…å®¹æ˜¯ `SQL`è¯­å¥åŸæ–‡ï¼Œæ¯”å¦‚æ‰§è¡Œä¸€æ¡ `update T set update_time=now() where id=1`ï¼Œè®°å½•çš„å†…å®¹å¦‚ä¸‹

![image-20220706213326407](./images/image-20220706213326407.png)

åŒæ­¥æ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œè®°å½•çš„ `SQL`è¯­å¥ï¼Œä½†æ˜¯

æœ‰ä¸ªé—®é¢˜ï¼Œ`update_time=now()`è¿™é‡Œä¼šè·å–å½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œç›´æ¥æ‰§è¡Œä¼šå¯¼è‡´ä¸åŸåº“çš„æ•°æ®ä¸ä¸€è‡´ã€‚

ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šä¸º `row`ï¼Œè®°å½•çš„å†…å®¹ä¸å†æ˜¯ç®€å•çš„ `SQL`è¯­å¥äº†ï¼Œè¿˜åŒ…å«æ“ä½œçš„å…·ä½“æ•°æ®ï¼Œè®°å½•å†…å®¹å¦‚ä¸‹

![image-20220706213333425](./images/image-20220706213333425.png)

`row`æ ¼å¼è®°å½•çš„å†…å®¹çœ‹ä¸åˆ°è¯¦ç»†ä¿¡æ¯ï¼Œè¦é€šè¿‡ `mysqlbinlog`å·¥å…·è§£æå‡ºæ¥ã€‚

`update_time=now()`å˜æˆäº†å…·ä½“çš„æ—¶é—´ `update_time=1627112756247`ï¼Œæ¡ä»¶åé¢çš„@1ã€@2ã€@3 éƒ½æ˜¯è¯¥è¡Œæ•°æ®ç¬¬ 1 ä¸ª~3 ä¸ªå­—æ®µçš„åŸå§‹å€¼ï¼ˆ**å‡è®¾è¿™å¼ è¡¨åªæœ‰ 3 ä¸ªå­—æ®µ**ï¼‰ã€‚

è¿™æ ·å°±èƒ½ä¿è¯åŒæ­¥æ•°æ®çš„ä¸€è‡´æ€§ï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯æŒ‡å®šä¸º `row`ï¼Œè¿™æ ·å¯ä»¥ä¸ºæ•°æ®åº“çš„æ¢å¤ä¸åŒæ­¥å¸¦æ¥æ›´å¥½çš„å¯é æ€§ã€‚

ä½†æ˜¯è¿™ç§æ ¼å¼ï¼Œéœ€è¦æ›´å¤§çš„å®¹é‡æ¥è®°å½•ï¼Œæ¯”è¾ƒå ç”¨ç©ºé—´ï¼Œæ¢å¤ä¸åŒæ­¥æ—¶ä¼šæ›´æ¶ˆè€— `IO`èµ„æºï¼Œå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚

æ‰€ä»¥å°±æœ‰äº†ä¸€ç§æŠ˜ä¸­çš„æ–¹æ¡ˆï¼ŒæŒ‡å®šä¸º `mixed`ï¼Œè®°å½•çš„å†…å®¹æ˜¯å‰ä¸¤è€…çš„æ··åˆã€‚

`MySQL`ä¼šåˆ¤æ–­è¿™æ¡ `SQL`è¯­å¥æ˜¯å¦å¯èƒ½å¼•èµ·æ•°æ®ä¸ä¸€è‡´ï¼Œå¦‚æœæ˜¯ï¼Œå°±ç”¨ `row`æ ¼å¼ï¼Œå¦åˆ™å°±ç”¨ `statement`æ ¼å¼

##### å†™å…¥æœºåˆ¶

`binlog`çš„å†™å…¥æ—¶æœºä¹Ÿéå¸¸ç®€å•ï¼Œäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…ˆæŠŠæ—¥å¿—å†™åˆ° `binlog cache`ï¼Œäº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå†æŠŠ `binlog cache`å†™åˆ° `binlog`æ–‡ä»¶ä¸­ã€‚

å› ä¸ºä¸€ä¸ªäº‹åŠ¡çš„ `binlog`ä¸èƒ½è¢«æ‹†å¼€ï¼Œæ— è®ºè¿™ä¸ªäº‹åŠ¡å¤šå¤§ï¼Œä¹Ÿè¦ç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥ï¼Œæ‰€ä»¥ç³»ç»Ÿä¼šç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªå—å†…å­˜ä½œä¸º `binlog cache`ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `binlog_cache_size`å‚æ•°æ§åˆ¶å•ä¸ªçº¿ç¨‹ binlog cache å¤§å°ï¼Œå¦‚æœå­˜å‚¨å†…å®¹è¶…è¿‡äº†è¿™ä¸ªå‚æ•°ï¼Œå°±è¦æš‚å­˜åˆ°ç£ç›˜ï¼ˆ`Swap`ï¼‰ã€‚

`binlog`æ—¥å¿—åˆ·ç›˜æµç¨‹å¦‚ä¸‹

![image-20220706213409674](./images/image-20220706213409674.png)

- **ä¸Šå›¾çš„ writeï¼Œæ˜¯æŒ‡æŠŠæ—¥å¿—å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„ page cacheï¼Œå¹¶æ²¡æœ‰æŠŠæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ‰€ä»¥é€Ÿåº¦æ¯”è¾ƒå¿«**
- **ä¸Šå›¾çš„ fsyncï¼Œæ‰æ˜¯å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜çš„æ“ä½œ**

`write`å’Œ `fsync`çš„æ—¶æœºï¼Œå¯ä»¥ç”±å‚æ•° `sync_binlog`æ§åˆ¶ï¼Œé»˜è®¤æ˜¯ `0`ã€‚

ä¸º `0`çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½åª `write`ï¼Œç”±ç³»ç»Ÿè‡ªè¡Œåˆ¤æ–­ä»€ä¹ˆæ—¶å€™æ‰§è¡Œ `fsync`ã€‚

![image-20220706213418556](./images/image-20220706213418556.png)

è™½ç„¶æ€§èƒ½å¾—åˆ°æå‡ï¼Œä½†æ˜¯æœºå™¨å®•æœºï¼Œ`page cache`é‡Œé¢çš„ binlog ä¼šä¸¢å¤±ã€‚

ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå¯ä»¥è®¾ç½®ä¸º `1`ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼šæ‰§è¡Œ `fsync`ï¼Œå°±å¦‚åŒ **redo log æ—¥å¿—åˆ·ç›˜æµç¨‹** ä¸€æ ·ã€‚

æœ€åè¿˜æœ‰ä¸€ç§æŠ˜ä¸­æ–¹å¼ï¼Œå¯ä»¥è®¾ç½®ä¸º `N(N>1)`ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ `write`ï¼Œä½†ç´¯ç§¯ `N`ä¸ªäº‹åŠ¡åæ‰ `fsync`

![image-20220706213426711](./images/image-20220706213426711.png)

åœ¨å‡ºç° `IO`ç“¶é¢ˆçš„åœºæ™¯é‡Œï¼Œå°† `sync_binlog`è®¾ç½®æˆä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼ï¼Œå¯ä»¥æå‡æ€§èƒ½ã€‚

åŒæ ·çš„ï¼Œå¦‚æœæœºå™¨å®•æœºï¼Œä¼šä¸¢å¤±æœ€è¿‘ `N`ä¸ªäº‹åŠ¡çš„ `binlog`æ—¥å¿—

#### ä¸¤é˜¶æ®µæäº¤

`redo log`ï¼ˆé‡åšæ—¥å¿—ï¼‰è®© `InnoDB`å­˜å‚¨å¼•æ“æ‹¥æœ‰äº†å´©æºƒæ¢å¤èƒ½åŠ›ã€‚

`binlog`ï¼ˆå½’æ¡£æ—¥å¿—ï¼‰ä¿è¯äº† `MySQL`é›†ç¾¤æ¶æ„çš„æ•°æ®ä¸€è‡´æ€§ã€‚

è™½ç„¶å®ƒä»¬éƒ½å±äºæŒä¹…åŒ–çš„ä¿è¯ï¼Œä½†æ˜¯ä¾§é‡ç‚¹ä¸åŒã€‚

åœ¨æ‰§è¡Œæ›´æ–°è¯­å¥è¿‡ç¨‹ï¼Œä¼šè®°å½• `redo log`ä¸ `binlog`ä¸¤å—æ—¥å¿—ï¼Œä»¥åŸºæœ¬çš„äº‹åŠ¡ä¸ºå•ä½ï¼Œ`redo log`åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥ä¸æ–­å†™å…¥ï¼Œè€Œ `binlog`åªæœ‰åœ¨æäº¤äº‹åŠ¡æ—¶æ‰å†™å…¥ï¼Œæ‰€ä»¥ `redo log`ä¸ `binlog`çš„å†™å…¥æ—¶æœºä¸ä¸€æ ·ã€‚

![image-20220706213448142](./images/image-20220706213448142.png)

å›åˆ°æ­£é¢˜ï¼Œ`redo log`ä¸ `binlog`ä¸¤ä»½æ—¥å¿—ä¹‹é—´çš„é€»è¾‘ä¸ä¸€è‡´ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ

æˆ‘ä»¬ä»¥ `update`è¯­å¥ä¸ºä¾‹ï¼Œå‡è®¾ `id=2`çš„è®°å½•ï¼Œå­—æ®µ `c`å€¼æ˜¯ `0`ï¼ŒæŠŠå­—æ®µ `c`å€¼æ›´æ–°æˆ `1`ï¼Œ`SQL`è¯­å¥ä¸º `update T set c=1 where id=2`ã€‚

å‡è®¾æ‰§è¡Œè¿‡ç¨‹ä¸­å†™å®Œ `redo log`æ—¥å¿—åï¼Œ`binlog`æ—¥å¿—å†™æœŸé—´å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ

![image-20220706213523943](./images/image-20220706213523943.png)

ç”±äº `binlog`æ²¡å†™å®Œå°±å¼‚å¸¸ï¼Œè¿™æ—¶å€™ `binlog`é‡Œé¢æ²¡æœ‰å¯¹åº”çš„ä¿®æ”¹è®°å½•ã€‚å› æ­¤ï¼Œä¹‹åç”¨ `binlog`æ—¥å¿—æ¢å¤æ•°æ®æ—¶ï¼Œå°±ä¼šå°‘è¿™ä¸€æ¬¡æ›´æ–°ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œ `c`å€¼æ˜¯ `0`ï¼Œè€ŒåŸåº“å› ä¸º `redo log`æ—¥å¿—æ¢å¤ï¼Œè¿™ä¸€è¡Œ `c`å€¼æ˜¯ `1`ï¼Œæœ€ç»ˆæ•°æ®ä¸ä¸€è‡´ã€‚

![image-20220706213531140](./images/image-20220706213531140.png)

ä¸ºäº†è§£å†³ä¸¤ä»½æ—¥å¿—ä¹‹é—´çš„é€»è¾‘ä¸€è‡´é—®é¢˜ï¼Œ`InnoDB`å­˜å‚¨å¼•æ“ä½¿ç”¨**ä¸¤é˜¶æ®µæäº¤**æ–¹æ¡ˆã€‚

åŸç†å¾ˆç®€å•ï¼Œå°† `redo log`çš„å†™å…¥æ‹†æˆäº†ä¸¤ä¸ªæ­¥éª¤ `prepare`å’Œ `commit`ï¼Œè¿™å°±æ˜¯**ä¸¤é˜¶æ®µæäº¤**ã€‚

![image-20220706213538608](./images/image-20220706213538608.png)

ä½¿ç”¨**ä¸¤é˜¶æ®µæäº¤**åï¼Œå†™å…¥ `binlog`æ—¶å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¸ä¼šæœ‰å½±å“ï¼Œå› ä¸º `MySQL`æ ¹æ® `redo log`æ—¥å¿—æ¢å¤æ•°æ®æ—¶ï¼Œå‘ç° `redo log`è¿˜å¤„äº `prepare`é˜¶æ®µï¼Œå¹¶ä¸”æ²¡æœ‰å¯¹åº” `binlog`æ—¥å¿—ï¼Œå°±ä¼šå›æ»šè¯¥äº‹åŠ¡ã€‚![image-20220706213548852](./images/image-20220706213548852.png)

å†çœ‹ä¸€ä¸ªåœºæ™¯ï¼Œ`redo log`è®¾ç½® `commit`é˜¶æ®µå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¼šä¸ä¼šå›æ»šäº‹åŠ¡å‘¢ï¼Ÿ

![image-20220706213556183](./images/image-20220706213556183.png)

å¹¶ä¸ä¼šå›æ»šäº‹åŠ¡ï¼Œå®ƒä¼šæ‰§è¡Œä¸Šå›¾æ¡†ä½çš„é€»è¾‘ï¼Œè™½ç„¶ `redo log`æ˜¯å¤„äº `prepare`é˜¶æ®µï¼Œä½†æ˜¯èƒ½é€šè¿‡äº‹åŠ¡ `id`æ‰¾åˆ°å¯¹åº”çš„ `binlog`æ—¥å¿—ï¼Œæ‰€ä»¥ `MySQL`è®¤ä¸ºæ˜¯å®Œæ•´çš„ï¼Œå°±ä¼šæäº¤äº‹åŠ¡æ¢å¤æ•°æ®

#### undo log

æˆ‘ä»¬åœ¨æ‰§è¡Œæ‰§è¡Œä¸€æ¡â€œå¢åˆ æ”¹â€è¯­å¥çš„æ—¶å€™ï¼Œè™½ç„¶æ²¡æœ‰è¾“å…¥ begin å¼€å¯äº‹åŠ¡å’Œ commit æäº¤äº‹åŠ¡ï¼Œä½†æ˜¯ MySQL ä¼š**éšå¼å¼€å¯äº‹åŠ¡**æ¥æ‰§è¡Œâ€œå¢åˆ æ”¹â€è¯­å¥çš„ï¼Œæ‰§è¡Œå®Œå°±è‡ªåŠ¨æäº¤äº‹åŠ¡çš„ï¼Œè¿™æ ·å°±ä¿è¯äº†æ‰§è¡Œå®Œâ€œå¢åˆ æ”¹â€è¯­å¥åï¼Œæˆ‘ä»¬å¯ä»¥åŠæ—¶åœ¨æ•°æ®åº“è¡¨çœ‹åˆ°â€œå¢åˆ æ”¹â€çš„ç»“æœäº†ã€‚

æ‰§è¡Œä¸€æ¡è¯­å¥æ˜¯å¦è‡ªåŠ¨æäº¤äº‹åŠ¡ï¼Œæ˜¯ç”± `autocommit` å‚æ•°å†³å®šçš„ï¼Œé»˜è®¤æ˜¯å¼€å¯ã€‚æ‰€ä»¥ï¼Œæ‰§è¡Œä¸€æ¡ update è¯­å¥ä¹Ÿæ˜¯ä¼šä½¿ç”¨äº‹åŠ¡çš„ã€‚

é‚£ä¹ˆï¼Œè€ƒè™‘ä¸€ä¸ªé—®é¢˜ã€‚ä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåœ¨è¿˜æ²¡æœ‰æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œå¦‚æœMySQL å‘ç”Ÿäº†å´©æºƒï¼Œè¦æ€ä¹ˆå›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®å‘¢ï¼Ÿ

å¦‚æœæˆ‘ä»¬æ¯æ¬¡åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéƒ½è®°å½•ä¸‹å›æ»šæ—¶éœ€è¦çš„ä¿¡æ¯åˆ°ä¸€ä¸ªæ—¥å¿—é‡Œï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æ‰§è¡Œä¸­é€”å‘ç”Ÿäº† MySQL å´©æºƒåï¼Œå°±ä¸ç”¨æ‹…å¿ƒæ— æ³•å›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ—¥å¿—å›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®ã€‚

å®ç°è¿™ä¸€æœºåˆ¶å°±æ˜¯  **undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ï¼Œå®ƒä¿è¯äº†äº‹åŠ¡çš„ ACID ç‰¹æ€§ (opens new window)ä¸­çš„åŸå­æ€§ï¼ˆAtomicityï¼‰ã€‚**

undo log æ˜¯ä¸€ç§ç”¨äºæ’¤é”€å›é€€çš„æ—¥å¿—ã€‚åœ¨äº‹åŠ¡æ²¡æäº¤ä¹‹å‰ï¼ŒMySQL ä¼šå…ˆè®°å½•æ›´æ–°å‰çš„æ•°æ®åˆ° undo log æ—¥å¿—æ–‡ä»¶é‡Œé¢ï¼Œå½“äº‹åŠ¡å›æ»šæ—¶ï¼Œå¯ä»¥åˆ©ç”¨ undo log æ¥è¿›è¡Œå›æ»šã€‚å¦‚ä¸‹å›¾ï¼š

![image-20220706213728255](./images/image-20220706213728255.png)

æ¯å½“ InnoDB å¼•æ“å¯¹ä¸€æ¡è®°å½•è¿›è¡Œæ“ä½œï¼ˆä¿®æ”¹ã€åˆ é™¤ã€æ–°å¢ï¼‰æ—¶ï¼Œè¦æŠŠå›æ»šæ—¶éœ€è¦çš„ä¿¡æ¯éƒ½è®°å½•åˆ° undo log é‡Œï¼Œæ¯”å¦‚ï¼š

- åœ¨**æ’å…¥**ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®å€¼è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶åªéœ€è¦æŠŠè¿™ä¸ªä¸»é”®å€¼å¯¹åº”çš„è®°å½•**åˆ æ‰**å°±å¥½äº†ï¼›
- åœ¨**åˆ é™¤**ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¿™æ¡è®°å½•ä¸­çš„å†…å®¹éƒ½è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠç”±è¿™äº›å†…å®¹ç»„æˆçš„è®°å½•**æ’å…¥**åˆ°è¡¨ä¸­å°±å¥½äº†ï¼›
- åœ¨**æ›´æ–°**ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¢«æ›´æ–°çš„åˆ—çš„æ—§å€¼è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠè¿™äº›åˆ—**æ›´æ–°ä¸ºæ—§å€¼**å°±å¥½äº†ã€‚

åœ¨å‘ç”Ÿå›æ»šæ—¶ï¼Œå°±è¯»å– undo log é‡Œçš„æ•°æ®ï¼Œç„¶ååšåŸå…ˆç›¸åæ“ä½œã€‚æ¯”å¦‚å½“ delete ä¸€æ¡è®°å½•æ—¶ï¼Œundo log ä¸­ä¼šæŠŠè®°å½•ä¸­çš„å†…å®¹éƒ½è®°ä¸‹æ¥ï¼Œç„¶åæ‰§è¡Œå›æ»šæ“ä½œçš„æ—¶å€™ï¼Œå°±è¯»å– undo log é‡Œçš„æ•°æ®ï¼Œç„¶åè¿›è¡Œ insert æ“ä½œã€‚

ä¸åŒçš„æ“ä½œï¼Œéœ€è¦è®°å½•çš„å†…å®¹ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥ä¸åŒç±»å‹çš„æ“ä½œï¼ˆä¿®æ”¹ã€åˆ é™¤ã€æ–°å¢ï¼‰äº§ç”Ÿçš„ undo log çš„æ ¼å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œå…·ä½“çš„æ¯ä¸€ä¸ªæ“ä½œçš„ undo log çš„æ ¼å¼æˆ‘å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±å»æŸ¥æŸ¥ã€‚

ä¸€æ¡è®°å½•çš„æ¯ä¸€æ¬¡æ›´æ–°æ“ä½œäº§ç”Ÿçš„ undo log æ ¼å¼éƒ½æœ‰ä¸€ä¸ª roll_pointer æŒ‡é’ˆå’Œä¸€ä¸ª trx_id äº‹åŠ¡idï¼š

- é€šè¿‡ trx_id å¯ä»¥çŸ¥é“è¯¥è®°å½•æ˜¯è¢«å“ªä¸ªäº‹åŠ¡ä¿®æ”¹çš„ï¼›
- é€šè¿‡ roll_pointer æŒ‡é’ˆå¯ä»¥å°†è¿™äº› undo log ä¸²æˆä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨å°±è¢«ç§°ä¸ºç‰ˆæœ¬é“¾ï¼›

ç‰ˆæœ¬é“¾å¦‚ä¸‹å›¾ï¼š

![image-20220706213736248](./images/image-20220706213736248.png)

å¦å¤–ï¼Œ**undo log è¿˜æœ‰ä¸€ä¸ªä½œç”¨ï¼Œé€šè¿‡ ReadView + undo log å®ç° MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰**ã€‚

å¯¹äºã€Œè¯»æäº¤ã€å’Œã€Œå¯é‡å¤è¯»ã€éš”ç¦»çº§åˆ«çš„äº‹åŠ¡æ¥è¯´ï¼Œå®ƒä»¬çš„å¿«ç…§è¯»ï¼ˆæ™®é€š select è¯­å¥ï¼‰æ˜¯é€šè¿‡ Read View  + undo log æ¥å®ç°çš„ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äºåˆ›å»º Read View çš„æ—¶æœºä¸åŒï¼š

- ã€Œè¯»æäº¤ã€éš”ç¦»çº§åˆ«æ˜¯åœ¨æ¯ä¸ª select éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ Read Viewï¼Œä¹Ÿæ„å‘³ç€ï¼Œäº‹åŠ¡æœŸé—´çš„å¤šæ¬¡è¯»å–åŒä¸€æ¡æ•°æ®ï¼Œå‰åä¸¤æ¬¡è¯»çš„æ•°æ®å¯èƒ½ä¼šå‡ºç°ä¸ä¸€è‡´ï¼Œå› ä¸ºå¯èƒ½è¿™æœŸé—´å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†è¯¥è®°å½•ï¼Œå¹¶æäº¤äº†äº‹åŠ¡ã€‚
- ã€Œå¯é‡å¤è¯»ã€éš”ç¦»çº§åˆ«æ˜¯å¯åŠ¨äº‹åŠ¡æ—¶ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œç„¶åæ•´ä¸ªäº‹åŠ¡æœŸé—´éƒ½åœ¨ç”¨è¿™ä¸ª Read Viewï¼Œè¿™æ ·å°±ä¿è¯äº†åœ¨äº‹åŠ¡æœŸé—´è¯»åˆ°çš„æ•°æ®éƒ½æ˜¯äº‹åŠ¡å¯åŠ¨å‰çš„è®°å½•ã€‚

è¿™ä¸¤ä¸ªéš”ç¦»çº§åˆ«å®ç°æ˜¯é€šè¿‡ã€Œäº‹åŠ¡çš„ Read View é‡Œçš„å­—æ®µã€å’Œã€Œè®°å½•ä¸­çš„ä¸¤ä¸ªéšè—åˆ—ï¼ˆtrx_id å’Œ roll_pointerï¼‰ã€çš„æ¯”å¯¹ï¼Œå¦‚æœä¸æ»¡è¶³å¯è§è¡Œï¼Œå°±ä¼šé¡ºç€  undo log ç‰ˆæœ¬é“¾é‡Œæ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•ï¼Œä»è€Œæ§åˆ¶å¹¶å‘äº‹åŠ¡è®¿é—®åŒä¸€ä¸ªè®°å½•æ—¶çš„è¡Œä¸ºï¼Œè¿™å°±å«  MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ã€‚å…·ä½“çš„å®ç°å¯ä»¥çœ‹ï¼š[äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯æ€ä¹ˆå®ç°çš„](https://xiaolincoding.com/mysql/transaction/mvcc.html#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E6%9C%89%E5%93%AA%E4%BA%9B)ï¼Ÿ å› æ­¤ï¼Œundo log ä¸¤å¤§ä½œç”¨ï¼š

- **å®ç°äº‹åŠ¡å›æ»šï¼Œä¿éšœäº‹åŠ¡çš„åŸå­æ€§**ã€‚äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯æˆ–è€…ç”¨æˆ·æ‰§ è¡Œäº† ROLLBACK è¯­å¥ï¼ŒMySQL å¯ä»¥åˆ©ç”¨ undo log ä¸­çš„å†å²æ•°æ®å°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€ã€‚
- **å®ç° MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰å…³é”®å› ç´ ä¹‹ä¸€**ã€‚MVCC æ˜¯é€šè¿‡ ReadView + undo log å®ç°çš„ã€‚undo log ä¸ºæ¯æ¡è®°å½•ä¿å­˜å¤šä»½å†å²æ•°æ®ï¼ŒMySQL åœ¨æ‰§è¡Œå¿«ç…§è¯»ï¼ˆæ™®é€š  select è¯­å¥ï¼‰çš„æ—¶å€™ï¼Œä¼šæ ¹æ®äº‹åŠ¡çš„ Read View é‡Œçš„ä¿¡æ¯ï¼Œé¡ºç€ undo log çš„ç‰ˆæœ¬é“¾æ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•ã€‚

### å›¾è§£MVCC

çº²è¦ï¼š

* å½“å‰è¯»å’Œå¿«ç…§è¯»çš„æ¦‚å¿µ
* äº‹åŠ¡éš”ç¦»çº§åˆ«
* MVCC çš„ä¸¤ä¸ªæ¦‚å¿µ
  * ç‰ˆæœ¬é“¾
  * è¯»è§†å›¾ï¼ˆè¯»å·²æäº¤å’Œå¯é‡å¤è¯»ï¼‰

![image-20220706231641283](./images/image-20220706231641283.png)

* å½“ç†è§£äº†ä¸Šè¿°æ¦‚å¿µå¯ä»¥å¯¹æ­¤ä¾‹å­è¿›è¡ŒåŠ æ·±ç†è§£

![image-20220706220605710](./images/image-20220706220605710.png)

### InnoDBå­˜å‚¨å¼•æ“å¯¹MVCCçš„å®ç°

MVCC çš„å®ç°ä¾èµ–äºï¼šéšè—å­—æ®µã€Read Viewã€undo logã€‚åœ¨å†…éƒ¨å®ç°ä¸­ï¼ŒInnoDB é€šè¿‡æ•°æ®è¡Œçš„ DB_TRX_ID å’Œ Read View æ¥åˆ¤æ–­æ•°æ®çš„å¯è§æ€§ï¼Œå¦‚ä¸å¯è§ï¼Œåˆ™é€šè¿‡æ•°æ®è¡Œçš„ DB_ROLL_PTR æ‰¾åˆ° undo log ä¸­çš„å†å²ç‰ˆæœ¬ã€‚æ¯ä¸ªäº‹åŠ¡è¯»åˆ°çš„æ•°æ®ç‰ˆæœ¬å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç”¨æˆ·åªèƒ½çœ‹åˆ°è¯¥äº‹åŠ¡åˆ›å»º Read View ä¹‹å‰å·²ç»æäº¤çš„ä¿®æ”¹å’Œè¯¥äº‹åŠ¡æœ¬èº«åšçš„ä¿®æ”¹

#### éšè—å­—æ®µ

åœ¨å†…éƒ¨ï¼Œ`InnoDB` å­˜å‚¨å¼•æ“ä¸ºæ¯è¡Œæ•°æ®æ·»åŠ äº†ä¸‰ä¸ª [éšè—å­—æ®µ](https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html)

ï¼š

- `DB_TRX_IDï¼ˆ6å­—èŠ‚ï¼‰`ï¼šè¡¨ç¤ºæœ€åä¸€æ¬¡æ’å…¥æˆ–æ›´æ–°è¯¥è¡Œçš„äº‹åŠ¡ idã€‚æ­¤å¤–ï¼Œ`delete` æ“ä½œåœ¨å†…éƒ¨è¢«è§†ä¸ºæ›´æ–°ï¼Œåªä¸è¿‡ä¼šåœ¨è®°å½•å¤´ `Record header` ä¸­çš„ `deleted_flag` å­—æ®µå°†å…¶æ ‡è®°ä¸ºå·²åˆ é™¤
- `DB_ROLL_PTRï¼ˆ7å­—èŠ‚ï¼‰` å›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥è¡Œçš„ `undo log` ã€‚å¦‚æœè¯¥è¡Œæœªè¢«æ›´æ–°ï¼Œåˆ™ä¸ºç©º
- `DB_ROW_IDï¼ˆ6å­—èŠ‚ï¼‰`ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®ä¸»é”®ä¸”è¯¥è¡¨æ²¡æœ‰å”¯ä¸€éç©ºç´¢å¼•æ—¶ï¼Œ`InnoDB` ä¼šä½¿ç”¨è¯¥ id æ¥ç”Ÿæˆèšç°‡ç´¢å¼•

#### ReadView

```c
class ReadView {
  /* ... */
private:
  trx_id_t m_low_limit_id;      /* å¤§äºç­‰äºè¿™ä¸ª ID çš„äº‹åŠ¡å‡ä¸å¯è§ */

  trx_id_t m_up_limit_id;       /* å°äºè¿™ä¸ª ID çš„äº‹åŠ¡å‡å¯è§ */

  trx_id_t m_creator_trx_id;    /* åˆ›å»ºè¯¥ Read View çš„äº‹åŠ¡ID */

  trx_id_t m_low_limit_no;      /* äº‹åŠ¡ Number, å°äºè¯¥ Number çš„ Undo Logs å‡å¯ä»¥è¢« Purge */

  ids_t m_ids;                  /* åˆ›å»º Read View æ—¶çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ */

  m_closed;                     /* æ ‡è®° Read View æ˜¯å¦ close */
}
```

Read Viewä¸»è¦æ˜¯ç”¨æ¥åšå¯è§æ€§åˆ¤æ–­ï¼Œé‡Œé¢ä¿å­˜äº† â€œå½“å‰å¯¹æœ¬äº‹åŠ¡ä¸å¯è§çš„å…¶ä»–æ´»è·ƒäº‹åŠ¡â€

ä¸»è¦æœ‰ä»¥ä¸‹å­—æ®µï¼š

- `m_low_limit_id`ï¼šç›®å‰å‡ºç°è¿‡çš„æœ€å¤§çš„äº‹åŠ¡ ID+1ï¼Œå³ä¸‹ä¸€ä¸ªå°†è¢«åˆ†é…çš„äº‹åŠ¡ IDã€‚å¤§äºç­‰äºè¿™ä¸ª ID çš„æ•°æ®ç‰ˆæœ¬å‡ä¸å¯è§
- `m_up_limit_id`ï¼šæ´»è·ƒäº‹åŠ¡åˆ—è¡¨ `m_ids` ä¸­æœ€å°çš„äº‹åŠ¡ IDï¼Œå¦‚æœ `m_ids` ä¸ºç©ºï¼Œåˆ™ `m_up_limit_id` ä¸º `m_low_limit_id`ã€‚å°äºè¿™ä¸ª ID çš„æ•°æ®ç‰ˆæœ¬å‡å¯è§
- `m_ids`ï¼š`Read View` åˆ›å»ºæ—¶å…¶ä»–æœªæäº¤çš„æ´»è·ƒäº‹åŠ¡ ID åˆ—è¡¨ã€‚åˆ›å»º `Read View`æ—¶ï¼Œå°†å½“å‰æœªæäº¤äº‹åŠ¡ ID è®°å½•ä¸‹æ¥ï¼Œåç»­å³ä½¿å®ƒä»¬ä¿®æ”¹äº†è®°å½•è¡Œçš„å€¼ï¼Œå¯¹äºå½“å‰äº‹åŠ¡ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚`m_ids` ä¸åŒ…æ‹¬å½“å‰äº‹åŠ¡è‡ªå·±å’Œå·²æäº¤çš„äº‹åŠ¡ï¼ˆæ­£åœ¨å†…å­˜ä¸­ï¼‰
- `m_creator_trx_id`ï¼šåˆ›å»ºè¯¥ `Read View` çš„äº‹åŠ¡ ID

**äº‹åŠ¡å¯è§æ€§ç¤ºæ„å›¾**

![image-20220711215228405](./images/image-20220711215228405.png)

#### undo-log

`undo log` ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š

- å½“äº‹åŠ¡å›æ»šæ—¶ç”¨äºå°†æ•°æ®æ¢å¤åˆ°ä¿®æ”¹å‰çš„æ ·å­
- å¦ä¸€ä¸ªä½œç”¨æ˜¯ `MVCC` ï¼Œå½“è¯»å–è®°å½•æ—¶ï¼Œè‹¥è¯¥è®°å½•è¢«å…¶ä»–äº‹åŠ¡å ç”¨æˆ–å½“å‰ç‰ˆæœ¬å¯¹è¯¥äº‹åŠ¡ä¸å¯è§ï¼Œåˆ™å¯ä»¥é€šè¿‡ `undo log` è¯»å–ä¹‹å‰çš„ç‰ˆæœ¬æ•°æ®ï¼Œä»¥æ­¤å®ç°éé”å®šè¯»

**åœ¨ `InnoDB` å­˜å‚¨å¼•æ“ä¸­ `undo log` åˆ†ä¸ºä¸¤ç§ï¼š `insert undo log` å’Œ `update undo log`ï¼š**

1. **`insert undo log`** ï¼šæŒ‡åœ¨ `insert` æ“ä½œä¸­äº§ç”Ÿçš„ `undo log`ã€‚å› ä¸º `insert` æ“ä½œçš„è®°å½•åªå¯¹äº‹åŠ¡æœ¬èº«å¯è§ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ï¼Œæ•…è¯¥ `undo log` å¯ä»¥åœ¨äº‹åŠ¡æäº¤åç›´æ¥åˆ é™¤ã€‚ä¸éœ€è¦è¿›è¡Œ `purge` æ“ä½œ

**`insert` æ—¶çš„æ•°æ®åˆå§‹çŠ¶æ€ï¼š**

![image-20220711215325716](./images/image-20220711215325716.png)

2. **`update undo log`** ï¼š`update` æˆ– `delete` æ“ä½œä¸­äº§ç”Ÿçš„ `undo log`ã€‚è¯¥ `undo log`å¯èƒ½éœ€è¦æä¾› `MVCC` æœºåˆ¶ï¼Œå› æ­¤ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶å°±è¿›è¡Œåˆ é™¤ã€‚æäº¤æ—¶æ”¾å…¥ `undo log` é“¾è¡¨ï¼Œç­‰å¾… `purgeçº¿ç¨‹` è¿›è¡Œæœ€åçš„åˆ é™¤

**æ•°æ®ç¬¬ä¸€æ¬¡è¢«ä¿®æ”¹æ—¶ï¼š**

![image-20220711215339796](./images/image-20220711215339796.png)

**æ•°æ®ç¬¬äºŒæ¬¡è¢«ä¿®æ”¹æ—¶ï¼š**

![image-20220711215345905](./images/image-20220711215345905.png)

ä¸åŒäº‹åŠ¡æˆ–è€…ç›¸åŒäº‹åŠ¡çš„å¯¹åŒä¸€è®°å½•è¡Œçš„ä¿®æ”¹ï¼Œä¼šä½¿è¯¥è®°å½•è¡Œçš„ `undo log` æˆä¸ºä¸€æ¡é“¾è¡¨ï¼Œé“¾é¦–å°±æ˜¯æœ€æ–°çš„è®°å½•ï¼Œé“¾å°¾å°±æ˜¯æœ€æ—©çš„æ—§è®°å½•

#### æ•°æ®å¯è§æ€§ç®—æ³•

åœ¨ `InnoDB` å­˜å‚¨å¼•æ“ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°äº‹åŠ¡åï¼Œæ‰§è¡Œæ¯ä¸ª `select` è¯­å¥å‰ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼ˆRead Viewï¼‰ï¼Œ**å¿«ç…§ä¸­ä¿å­˜äº†å½“å‰æ•°æ®åº“ç³»ç»Ÿä¸­æ­£å¤„äºæ´»è·ƒï¼ˆæ²¡æœ‰ commitï¼‰çš„äº‹åŠ¡çš„ ID å·**ã€‚å…¶å®ç®€å•çš„è¯´ä¿å­˜çš„æ˜¯ç³»ç»Ÿä¸­å½“å‰ä¸åº”è¯¥è¢«æœ¬äº‹åŠ¡çœ‹åˆ°çš„å…¶ä»–äº‹åŠ¡ ID åˆ—è¡¨ï¼ˆå³ m_idsï¼‰ã€‚å½“ç”¨æˆ·åœ¨è¿™ä¸ªäº‹åŠ¡ä¸­è¦è¯»å–æŸä¸ªè®°å½•è¡Œçš„æ—¶å€™ï¼Œ`InnoDB` ä¼šå°†è¯¥è®°å½•è¡Œçš„ `DB_TRX_ID` ä¸ `Read View` ä¸­çš„ä¸€äº›å˜é‡åŠå½“å‰äº‹åŠ¡ ID è¿›è¡Œæ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³å¯è§æ€§æ¡ä»¶

å…·ä½“çš„æ¯”è¾ƒç®—æ³•å¦‚ä¸‹

![image-20220711215410118](./images/image-20220711215410118.png)

1. å¦‚æœè®°å½• DB_TRX_ID < m_up_limit_idï¼Œé‚£ä¹ˆè¡¨æ˜æœ€æ–°ä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ï¼ˆDB_TRX_IDï¼‰åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§ä¹‹å‰å°±æäº¤äº†ï¼Œæ‰€ä»¥è¯¥è®°å½•è¡Œçš„å€¼å¯¹å½“å‰äº‹åŠ¡æ˜¯å¯è§çš„
2. å¦‚æœ DB_TRX_ID >= m_low_limit_idï¼Œé‚£ä¹ˆè¡¨æ˜æœ€æ–°ä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ï¼ˆDB_TRX_IDï¼‰åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§ä¹‹åæ‰ä¿®æ”¹è¯¥è¡Œï¼Œæ‰€ä»¥è¯¥è®°å½•è¡Œçš„å€¼å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ã€‚è·³åˆ°æ­¥éª¤ 5
3. m_ids ä¸ºç©ºï¼Œåˆ™è¡¨æ˜åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§ä¹‹å‰ï¼Œä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡å°±å·²ç»æäº¤äº†ï¼Œæ‰€ä»¥è¯¥è®°å½•è¡Œçš„å€¼å¯¹å½“å‰äº‹åŠ¡æ˜¯å¯è§çš„
4. å¦‚æœ m_up_limit_id <= DB_TRX_ID <  m_low_limit_idï¼Œè¡¨æ˜æœ€æ–°ä¿®æ”¹è¯¥è¡Œçš„äº‹åŠ¡ï¼ˆDB_TRX_IDï¼‰åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§çš„æ—¶å€™å¯èƒ½å¤„äºâ€œæ´»åŠ¨çŠ¶æ€â€æˆ–è€…â€œå·²æäº¤çŠ¶æ€â€ï¼›æ‰€ä»¥å°±è¦å¯¹æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ m_ids è¿›è¡ŒæŸ¥æ‰¾ï¼ˆæºç ä¸­æ˜¯ç”¨çš„äºŒåˆ†æŸ¥æ‰¾ï¼Œå› ä¸ºæ˜¯æœ‰åºçš„ï¼‰
   - å¦‚æœåœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ m_ids ä¸­èƒ½æ‰¾åˆ°  DB_TRX_IDï¼Œè¡¨æ˜ï¼šâ‘  åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§å‰ï¼Œè¯¥è®°å½•è¡Œçš„å€¼è¢«äº‹åŠ¡ ID ä¸º DB_TRX_ID çš„äº‹åŠ¡ä¿®æ”¹äº†ï¼Œä½†æ²¡æœ‰æäº¤ï¼›æˆ–è€… â‘¡  åœ¨å½“å‰äº‹åŠ¡åˆ›å»ºå¿«ç…§åï¼Œè¯¥è®°å½•è¡Œçš„å€¼è¢«äº‹åŠ¡ ID ä¸º DB_TRX_ID çš„äº‹åŠ¡ä¿®æ”¹äº†ã€‚è¿™äº›æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè®°å½•è¡Œçš„å€¼å¯¹å½“å‰äº‹åŠ¡éƒ½æ˜¯ä¸å¯è§çš„ã€‚è·³åˆ°æ­¥éª¤ 5
   - åœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™è¡¨æ˜â€œid ä¸º trx_id çš„äº‹åŠ¡â€åœ¨ä¿®æ”¹â€œè¯¥è®°å½•è¡Œçš„å€¼â€åï¼Œåœ¨â€œå½“å‰äº‹åŠ¡â€åˆ›å»ºå¿«ç…§å‰å°±å·²ç»æäº¤äº†ï¼Œæ‰€ä»¥è®°å½•è¡Œå¯¹å½“å‰äº‹åŠ¡å¯è§
5. åœ¨è¯¥è®°å½•è¡Œçš„ DB_ROLL_PTR æŒ‡é’ˆæ‰€æŒ‡å‘çš„ `undo log` å–å‡ºå¿«ç…§è®°å½•ï¼Œç”¨å¿«ç…§è®°å½•çš„ DB_TRX_ID è·³åˆ°æ­¥éª¤ 1 é‡æ–°å¼€å§‹åˆ¤æ–­ï¼Œç›´åˆ°æ‰¾åˆ°æ»¡è¶³çš„å¿«ç…§ç‰ˆæœ¬æˆ–è¿”å›ç©º

### è¯»å†™åˆ†ç¦»äº†è§£å—ï¼Ÿ

è§åæ€æ„ï¼Œæ ¹æ®è¯»å†™åˆ†ç¦»çš„åå­—ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ï¼š**è¯»å†™åˆ†ç¦»ä¸»è¦æ˜¯ä¸ºäº†å°†å¯¹æ•°æ®åº“çš„è¯»å†™æ“ä½œåˆ†æ•£åˆ°ä¸åŒçš„æ•°æ®åº“èŠ‚ç‚¹ä¸Šã€‚** è¿™æ ·çš„è¯ï¼Œå°±èƒ½å¤Ÿå°å¹…æå‡å†™æ€§èƒ½ï¼Œå¤§å¹…æå‡è¯»æ€§èƒ½ã€‚

![image-20220617163230641](./images/image-20220617163230641.png)

ä¸è®ºæ˜¯ä½¿ç”¨å“ªä¸€ç§è¯»å†™åˆ†ç¦»å…·ä½“çš„å®ç°æ–¹æ¡ˆï¼Œæƒ³è¦å®ç°è¯»å†™åˆ†ç¦»ä¸€èˆ¬åŒ…å«å¦‚ä¸‹å‡ æ­¥ï¼š

1. éƒ¨ç½²å¤šå°æ•°æ®åº“ï¼Œé€‰æ‹©å…¶ä¸­çš„ä¸€å°ä½œä¸ºä¸»æ•°æ®åº“ï¼Œå…¶ä»–çš„ä¸€å°æˆ–è€…å¤šå°ä½œä¸ºä»æ•°æ®åº“ã€‚
2. ä¿è¯ä¸»æ•°æ®åº“å’Œä»æ•°æ®åº“ä¹‹é—´çš„æ•°æ®æ˜¯å®æ—¶åŒæ­¥çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„**ä¸»ä»å¤åˆ¶**ã€‚
3. ç³»ç»Ÿå°†å†™è¯·æ±‚äº¤ç»™ä¸»æ•°æ®åº“å¤„ç†ï¼Œè¯»è¯·æ±‚äº¤ç»™ä»æ•°æ®åº“å¤„ç†ã€‚

è½å®åˆ°é¡¹ç›®æœ¬èº«çš„è¯ï¼Œå¸¸ç”¨çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š

**1.ä»£ç†æ–¹å¼**

![image-20220617163247933](./images/image-20220617163247933.png)

æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨å’Œæ•°æ®ä¸­é—´åŠ äº†ä¸€ä¸ªä»£ç†å±‚ã€‚åº”ç”¨ç¨‹åºæ‰€æœ‰çš„æ•°æ®è¯·æ±‚éƒ½äº¤ç»™ä»£ç†å±‚å¤„ç†ï¼Œä»£ç†å±‚è´Ÿè´£åˆ†ç¦»è¯»å†™è¯·æ±‚ï¼Œå°†å®ƒä»¬è·¯ç”±åˆ°å¯¹åº”çš„æ•°æ®åº“ä¸­ã€‚

æä¾›ç±»ä¼¼åŠŸèƒ½çš„ä¸­é—´ä»¶æœ‰ **MySQL Router**ï¼ˆå®˜æ–¹ï¼‰ã€**Atlas**ï¼ˆåŸºäº MySQL Proxyï¼‰ã€**Maxscale**ã€**MyCat**ã€‚

**2.ç»„ä»¶æ–¹å¼**

åœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¼•å…¥ç¬¬ä¸‰æ–¹ç»„ä»¶æ¥å¸®åŠ©æˆ‘ä»¬è¯»å†™è¯·æ±‚ã€‚

è¿™ä¹Ÿæ˜¯æˆ‘æ¯”è¾ƒæ¨èçš„ä¸€ç§æ–¹å¼ã€‚è¿™ç§æ–¹å¼ç›®å‰åœ¨å„ç§äº’è”ç½‘å…¬å¸ä¸­ç”¨çš„æœ€å¤šçš„ï¼Œç›¸å…³çš„å®é™…çš„æ¡ˆä¾‹ä¹Ÿéå¸¸å¤šã€‚å¦‚æœä½ è¦é‡‡ç”¨è¿™ç§æ–¹å¼çš„è¯ï¼Œæ¨èä½¿ç”¨ `sharding-jdbc` ï¼Œç›´æ¥å¼•å…¥ jar åŒ…å³å¯ä½¿ç”¨ï¼Œéå¸¸æ–¹ä¾¿ã€‚åŒæ—¶ï¼Œä¹ŸèŠ‚çœäº†å¾ˆå¤šè¿ç»´çš„æˆæœ¬ã€‚

### ä¸»ä»å¤åˆ¶åŸç†äº†è§£ä¹ˆï¼Ÿ

MySQL binlog(binary log å³äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶) ä¸»è¦è®°å½•äº† MySQL æ•°æ®åº“ä¸­æ•°æ®çš„æ‰€æœ‰å˜åŒ–(æ•°æ®åº“æ‰§è¡Œçš„æ‰€æœ‰ DDL å’Œ DML è¯­å¥)ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ ¹æ®ä¸»åº“çš„ MySQL binlog æ—¥å¿—å°±èƒ½å¤Ÿå°†ä¸»åº“çš„æ•°æ®åŒæ­¥åˆ°ä»åº“ä¸­ã€‚

![image-20220617163123694](./images/image-20220617163123694.png)

1. ä¸»åº“å°†æ•°æ®åº“ä¸­æ•°æ®çš„å˜åŒ–å†™å…¥åˆ° binlog
2. ä»åº“è¿æ¥ä¸»åº“
3. ä»åº“ä¼šåˆ›å»ºä¸€ä¸ª I/O çº¿ç¨‹å‘ä¸»åº“è¯·æ±‚æ›´æ–°çš„ binlog
4. ä¸»åº“ä¼šåˆ›å»ºä¸€ä¸ª binlog dump çº¿ç¨‹æ¥å‘é€ binlog ï¼Œä»åº“ä¸­çš„ I/O çº¿ç¨‹è´Ÿè´£æ¥æ”¶
5. ä»åº“çš„ I/O çº¿ç¨‹å°†æ¥æ”¶çš„ binlog å†™å…¥åˆ° relay log ä¸­ã€‚
6. ä»åº“çš„ SQL çº¿ç¨‹è¯»å– relay log åŒæ­¥æ•°æ®æœ¬åœ°ï¼ˆä¹Ÿå°±æ˜¯å†æ‰§è¡Œä¸€é SQL ï¼‰ã€‚

æ€ä¹ˆæ ·ï¼Ÿçœ‹äº†æˆ‘å¯¹ä¸»ä»å¤åˆ¶è¿™ä¸ªè¿‡ç¨‹çš„è®²è§£ï¼Œä½ åº”è¯¥ææ˜ç™½äº†å§!

ä½ ä¸€èˆ¬çœ‹åˆ° binlog å°±è¦æƒ³åˆ°ä¸»ä»å¤åˆ¶ã€‚å½“ç„¶ï¼Œé™¤äº†ä¸»ä»å¤åˆ¶ä¹‹å¤–ï¼Œbinlog è¿˜èƒ½å¸®åŠ©æˆ‘ä»¬å®ç°æ•°æ®æ¢å¤ã€‚

ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼š

ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰ä½¿ç”¨è¿‡é˜¿é‡Œå¼€æºçš„ä¸€ä¸ªå«åš canal çš„å·¥å…·ã€‚è¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç° MySQL å’Œå…¶ä»–æ•°æ®æºæ¯”å¦‚ Elasticsearch æˆ–è€…å¦å¤–ä¸€å° MySQL  æ•°æ®åº“ä¹‹é—´çš„æ•°æ®åŒæ­¥ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå·¥å…·çš„åº•å±‚åŸç†è‚¯å®šä¹Ÿæ˜¯ä¾èµ– binlogã€‚canal çš„åŸç†å°±æ˜¯æ¨¡æ‹Ÿ MySQL ä¸»ä»å¤åˆ¶çš„è¿‡ç¨‹ï¼Œè§£æ  binlog å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–çš„æ•°æ®æºã€‚

å¦å¤–ï¼Œåƒå’±ä»¬å¸¸ç”¨çš„åˆ†å¸ƒå¼ç¼“å­˜ç»„ä»¶ Redis ä¹Ÿæ˜¯é€šè¿‡ä¸»ä»å¤åˆ¶å®ç°çš„è¯»å†™åˆ†ç¦»ã€‚

ğŸŒ• ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š

**MySQL ä¸»ä»å¤åˆ¶æ˜¯ä¾èµ–äº binlog ã€‚å¦å¤–ï¼Œå¸¸è§çš„ä¸€äº›åŒæ­¥ MySQL æ•°æ®åˆ°å…¶ä»–æ•°æ®æºçš„å·¥å…·ï¼ˆæ¯”å¦‚ canalï¼‰çš„åº•å±‚ä¸€èˆ¬ä¹Ÿæ˜¯ä¾èµ– binlog ã€‚**

### æ•°æ®åº“å¦‚ä½•å®ç°åˆ†å¸ƒå¼é”

#### åŸºäºæ•°æ®åº“è¡¨ï¼ˆé”è¡¨ï¼Œå¾ˆå°‘ä½¿ç”¨ï¼‰

æœ€ç®€å•çš„æ–¹å¼å¯èƒ½å°±æ˜¯ç›´æ¥åˆ›å»ºä¸€å¼ é”è¡¨ï¼Œç„¶åé€šè¿‡æ“ä½œè¯¥è¡¨ä¸­çš„æ•°æ®æ¥å®ç°äº†ã€‚å½“æˆ‘ä»¬æƒ³è¦è·å¾—é”çš„æ—¶å€™ï¼Œå°±å¯ä»¥åœ¨è¯¥è¡¨ä¸­å¢åŠ ä¸€æ¡è®°å½•ï¼Œæƒ³è¦é‡Šæ”¾é”çš„æ—¶å€™å°±åˆ é™¤è¿™æ¡è®°å½•ã€‚

ä¸ºäº†æ›´å¥½çš„æ¼”ç¤ºï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€å¼ æ•°æ®åº“è¡¨ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š

```sql
CREATE TABLE database_lock (
	`id` BIGINT NOT NULL AUTO_INCREMENT,
	`resource` int NOT NULL COMMENT 'é”å®šçš„èµ„æº',
	`description` varchar(1024) NOT NULL DEFAULT "" COMMENT 'æè¿°',
	PRIMARY KEY (id),
	UNIQUE KEY uiq_idx_resource (resource)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ•°æ®åº“åˆ†å¸ƒå¼é”è¡¨';
```

å½“æˆ‘ä»¬æƒ³è¦è·å¾—é”æ—¶ï¼Œå¯ä»¥æ’å…¥ä¸€æ¡æ•°æ®ï¼š

```sql
INSERT INTO database_lock(resource, description) VALUES (1, 'lock');
```

å½“éœ€è¦é‡Šæ”¾é”çš„æ—¶ï¼Œå¯ä»¥åˆ é™¤è¿™æ¡æ•°æ®ï¼š

```sql
DELETE FROM database_lock WHERE resource=1;
```

#### åŸºäºæ‚²è§‚é”

**æ‚²è§‚é”å®ç°æ€è·¯**ï¼Ÿ

1. åœ¨å¯¹ä»»æ„è®°å½•è¿›è¡Œä¿®æ”¹å‰ï¼Œå…ˆå°è¯•ä¸ºè¯¥è®°å½•åŠ ä¸Šæ’ä»–é”ï¼ˆexclusive lockingï¼‰ã€‚
2. å¦‚æœåŠ é”å¤±è´¥ï¼Œè¯´æ˜è¯¥è®°å½•æ­£åœ¨è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“å‰æŸ¥è¯¢å¯èƒ½è¦ç­‰å¾…æˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚ å…·ä½“å“åº”æ–¹å¼ç”±å¼€å‘è€…æ ¹æ®å®é™…éœ€è¦å†³å®šã€‚
3. å¦‚æœæˆåŠŸåŠ é”ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹è®°å½•åšä¿®æ”¹ï¼Œäº‹åŠ¡å®Œæˆåå°±ä¼šè§£é”äº†ã€‚
4. å…¶é—´å¦‚æœæœ‰å…¶ä»–å¯¹è¯¥è®°å½•åšä¿®æ”¹æˆ–åŠ æ’ä»–é”çš„æ“ä½œï¼Œéƒ½ä¼šç­‰å¾…æˆ‘ä»¬è§£é”æˆ–ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚

**ä»¥MySQL InnoDBä¸­ä½¿ç”¨æ‚²è§‚é”ä¸ºä¾‹**ï¼Ÿ

è¦ä½¿ç”¨æ‚²è§‚é”ï¼Œæˆ‘ä»¬å¿…é¡»å…³é—­mysqlæ•°æ®åº“çš„è‡ªåŠ¨æäº¤å±æ€§ï¼Œå› ä¸ºMySQLé»˜è®¤ä½¿ç”¨autocommitæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ æ‰§è¡Œä¸€ä¸ªæ›´æ–°æ“ä½œåï¼ŒMySQLä¼šç«‹åˆ»å°†ç»“æœè¿›è¡Œæäº¤ã€‚set autocommit=0;

```sql
//0.å¼€å§‹äº‹åŠ¡
begin;/begin work;/start transaction; (ä¸‰è€…é€‰ä¸€å°±å¯ä»¥)
//1.æŸ¥è¯¢å‡ºå•†å“ä¿¡æ¯
select status from t_goods where id=1 for update;
//2.æ ¹æ®å•†å“ä¿¡æ¯ç”Ÿæˆè®¢å•
insert into t_orders (id,goods_id) values (null,1);
//3.ä¿®æ”¹å•†å“statusä¸º2
update t_goods set status=2;
//4.æäº¤äº‹åŠ¡
commit;/commit work;
```

ä¸Šé¢çš„æŸ¥è¯¢è¯­å¥ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `selectâ€¦for update`çš„æ–¹å¼ï¼Œè¿™æ ·å°±é€šè¿‡å¼€å¯æ’ä»–é”çš„æ–¹å¼å®ç°äº†æ‚²è§‚é”ã€‚æ­¤æ—¶åœ¨t_goodsè¡¨ä¸­ï¼Œidä¸º1çš„ é‚£æ¡æ•°æ®å°±è¢«æˆ‘ä»¬é”å®šäº†ï¼Œå…¶å®ƒçš„äº‹åŠ¡å¿…é¡»ç­‰æœ¬æ¬¡äº‹åŠ¡æäº¤ä¹‹åæ‰èƒ½æ‰§è¡Œã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥ä¿è¯å½“å‰çš„æ•°æ®ä¸ä¼šè¢«å…¶å®ƒäº‹åŠ¡ä¿®æ”¹ã€‚

ä¸Šé¢æˆ‘ä»¬æåˆ°ï¼Œä½¿ç”¨ `selectâ€¦for update`ä¼šæŠŠæ•°æ®ç»™é”ä½ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€äº›é”çš„çº§åˆ«ï¼ŒMySQL InnoDBé»˜è®¤è¡Œçº§é”ã€‚è¡Œçº§é”éƒ½æ˜¯åŸºäºç´¢å¼•çš„ï¼Œå¦‚æœä¸€æ¡SQLè¯­å¥ç”¨ä¸åˆ°ç´¢å¼•æ˜¯ä¸ä¼šä½¿ç”¨è¡Œçº§é”çš„ï¼Œä¼šä½¿ç”¨è¡¨çº§é”æŠŠæ•´å¼ è¡¨é”ä½ï¼Œè¿™ç‚¹éœ€è¦æ³¨æ„ã€‚

#### åŸºäºä¹è§‚é”

ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆåˆåâ€œä¹è§‚é”â€ï¼ŒOptimistic Concurrency Controlï¼Œç¼©å†™â€œOCCâ€ï¼‰æ˜¯ä¸€ç§å¹¶å‘æ§åˆ¶çš„æ–¹æ³•ã€‚å®ƒå‡è®¾å¤šç”¨æˆ·å¹¶å‘çš„äº‹åŠ¡åœ¨å¤„ç†æ—¶ä¸ä¼šå½¼æ­¤äº’ç›¸å½±å“ï¼Œå„äº‹åŠ¡èƒ½å¤Ÿåœ¨ä¸äº§ç”Ÿé”çš„æƒ…å†µä¸‹å¤„ç†å„è‡ªå½±å“çš„é‚£éƒ¨åˆ†æ•°æ®ã€‚åœ¨æäº¤æ•°æ®æ›´æ–°ä¹‹å‰ï¼Œæ¯ä¸ªäº‹åŠ¡ä¼šå…ˆæ£€æŸ¥åœ¨è¯¥äº‹åŠ¡è¯»å–æ•°æ®åï¼Œæœ‰æ²¡æœ‰å…¶ä»–äº‹åŠ¡åˆä¿®æ”¹äº†è¯¥æ•°æ®ã€‚å¦‚æœå…¶ä»–äº‹åŠ¡æœ‰æ›´æ–°çš„è¯ï¼Œæ­£åœ¨æäº¤çš„äº‹åŠ¡ä¼šè¿›è¡Œå›æ»šã€‚

**ä»¥ä½¿ç”¨ç‰ˆæœ¬å·å®ç°ä¹è§‚é”ä¸ºä¾‹ï¼Ÿ**

ä½¿ç”¨ç‰ˆæœ¬å·æ—¶ï¼Œå¯ä»¥åœ¨æ•°æ®åˆå§‹åŒ–æ—¶æŒ‡å®šä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å¯¹æ•°æ®çš„æ›´æ–°æ“ä½œéƒ½å¯¹ç‰ˆæœ¬å·æ‰§è¡Œ+1æ“ä½œã€‚å¹¶åˆ¤æ–­å½“å‰ç‰ˆæœ¬å·æ˜¯ä¸æ˜¯è¯¥æ•°æ®çš„æœ€æ–°çš„ç‰ˆæœ¬å·ã€‚

```sql
1.æŸ¥è¯¢å‡ºå•†å“ä¿¡æ¯
select (status,status,version) from t_goods where id=#{id}
2.æ ¹æ®å•†å“ä¿¡æ¯ç”Ÿæˆè®¢å•
3.ä¿®æ”¹å•†å“statusä¸º2
update t_goods 
set status=2,version=version+1
where id=#{id} and version=#{version};
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¹è§‚é”æœºåˆ¶å¾€å¾€åŸºäºç³»ç»Ÿä¸­æ•°æ®å­˜å‚¨é€»è¾‘ï¼Œå› æ­¤ä¹Ÿå…·å¤‡ä¸€å®šçš„å±€é™æ€§ã€‚ç”±äºä¹è§‚é”æœºåˆ¶æ˜¯åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­å®ç°çš„ï¼Œå¯¹äºæ¥è‡ªå¤–éƒ¨ç³»ç»Ÿçš„ç”¨æˆ·æ•°æ®æ›´æ–°æ“ä½œä¸å—æˆ‘ä»¬ç³»ç»Ÿçš„æ§åˆ¶ï¼Œå› æ­¤å¯èƒ½ä¼šé€ æˆè„æ•°æ®è¢«æ›´æ–°åˆ°æ•°æ®åº“ä¸­ã€‚åœ¨ç³»ç»Ÿè®¾è®¡é˜¶æ®µï¼Œæˆ‘ä»¬åº”è¯¥å……åˆ†è€ƒè™‘åˆ°è¿™äº›æƒ…å†µï¼Œå¹¶è¿›è¡Œç›¸åº”çš„è°ƒæ•´ï¼ˆå¦‚å°†ä¹è§‚é”ç­–ç•¥åœ¨æ•°æ®åº“å­˜å‚¨è¿‡ç¨‹ä¸­å®ç°ï¼Œå¯¹å¤–åªå¼€æ”¾åŸºäºæ­¤å­˜å‚¨è¿‡ç¨‹çš„æ•°æ®æ›´æ–°é€”å¾„ï¼Œè€Œä¸æ˜¯å°†æ•°æ®åº“è¡¨ç›´æ¥å¯¹å¤–å…¬å¼€ï¼‰ã€‚

- **ç¼ºé™·**

å¯¹æ•°æ®åº“ä¾èµ–ï¼Œå¼€é”€é—®é¢˜ï¼Œè¡Œé”å˜è¡¨é”é—®é¢˜ï¼Œæ— æ³•è§£å†³æ•°æ®åº“å•ç‚¹å’Œå¯é‡å…¥çš„é—®é¢˜ã€‚

## â™¨ï¸ redis

### è¯´ä¸€ä¸‹redis

ç®€å•æ¥è¯´ **Redis å°±æ˜¯ä¸€ä¸ªä½¿ç”¨ C è¯­è¨€å¼€å‘çš„æ•°æ®åº“**ï¼Œä¸è¿‡ä¸ä¼ ç»Ÿæ•°æ®åº“ä¸åŒçš„æ˜¯ **Redis çš„æ•°æ®æ˜¯å­˜åœ¨å†…å­˜ä¸­çš„** ï¼Œä¹Ÿå°±æ˜¯å®ƒæ˜¯å†…å­˜æ•°æ®åº“ï¼Œæ‰€ä»¥è¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œå› æ­¤ Redis è¢«å¹¿æ³›åº”ç”¨äºç¼“å­˜æ–¹å‘ã€‚

å¦å¤–ï¼Œ**Redis é™¤äº†åšç¼“å­˜ä¹‹å¤–ï¼Œä¹Ÿç»å¸¸ç”¨æ¥åšåˆ†å¸ƒå¼é”ï¼Œç”šè‡³æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚**

**Redis æä¾›äº†å¤šç§æ•°æ®ç±»å‹æ¥æ”¯æŒä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚Redis è¿˜æ”¯æŒäº‹åŠ¡ ã€æŒä¹…åŒ–ã€Lua è„šæœ¬ã€å¤šç§é›†ç¾¤æ–¹æ¡ˆã€‚**

### Redisä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«ï¼Ÿ

* rediså®Œå…¨**åŸºäºå†…å­˜**,ç»å¤§éƒ¨åˆ†è¯·æ±‚æ˜¯çº¯ç²¹çš„å†…å­˜æ“ä½œ,éå¸¸å¿«é€Ÿ.
* **æ•°æ®ç»“æ„ç®€å•**,å¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•,redisä¸­çš„æ•°æ®ç»“æ„æ˜¯ä¸“é—¨è¿›è¡Œè®¾è®¡çš„
* é‡‡ç”¨**å•çº¿ç¨‹æ¨¡å‹**, é¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶, ä¹Ÿä¸å­˜åœ¨å¤šçº¿ç¨‹æˆ–è€…å¤šçº¿ç¨‹åˆ‡æ¢è€Œæ¶ˆè€—CPU, ä¸ç”¨è€ƒè™‘å„ç§é”çš„é—®é¢˜, ä¸å­˜åœ¨åŠ é”, é‡Šæ”¾é”çš„æ“ä½œ, æ²¡æœ‰å› ä¸ºå¯èƒ½å‡ºç°æ­»é”è€Œå¯¼è‡´æ€§èƒ½æ¶ˆè€—
* ä½¿ç”¨äº†**å¤šè·¯IOå¤ç”¨æ¨¡å‹**,éé˜»å¡IO
* ä½¿ç”¨**åº•å±‚æ¨¡å‹ä¸åŒ**ï¼ŒRedisç›´æ¥è‡ªå·±æ„å»ºäº† VM (è™šæ‹Ÿå†…å­˜)æœºåˆ¶ ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚

### ä¸ºä»€ä¹ˆè¦ç”¨ Redis / ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜ï¼Ÿ/ ä¸ºä»€ä¹ˆç”¨ Redis ä½œä¸º MySQL çš„ç¼“å­˜ï¼Ÿ

ä¸»è¦æ˜¯å› ä¸º **Redis å…·å¤‡ã€Œé«˜æ€§èƒ½ã€å’Œã€Œé«˜å¹¶å‘ã€ä¸¤ç§ç‰¹æ€§**ã€‚

ä¸»è¦ä»ä¸¤ä¸ªæ–¹é¢è®²ï¼š

***1ã€Redis å…·å¤‡é«˜æ€§èƒ½***

å‡å¦‚ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—® MySQL ä¸­çš„æŸäº›æ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šæ¯”è¾ƒæ…¢ï¼Œå› ä¸ºæ˜¯ä»ç¡¬ç›˜ä¸Šè¯»å–çš„ã€‚å°†è¯¥ç”¨æˆ·è®¿é—®çš„æ•°æ®ç¼“å­˜åœ¨ Redis ä¸­ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡å†è®¿é—®è¿™äº›æ•°æ®çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–äº†ï¼Œæ“ä½œ Redis ç¼“å­˜å°±æ˜¯ç›´æ¥æ“ä½œå†…å­˜ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å½“å¿«ã€‚

![image-20220714213332696](./images/image-20220714213332696.png)

å¦‚æœ MySQL ä¸­çš„å¯¹åº”æ•°æ®æ”¹å˜çš„ä¹‹åï¼ŒåŒæ­¥æ”¹å˜ Redis ç¼“å­˜ä¸­ç›¸åº”çš„æ•°æ®å³å¯ï¼Œä¸è¿‡è¿™é‡Œä¼šæœ‰ Redis å’Œ MySQL åŒå†™ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œåé¢æˆ‘ä»¬ä¼šæåˆ°ã€‚

***2ã€ Redis å…·å¤‡é«˜å¹¶å‘***

å•å°è®¾å¤‡çš„ Redis çš„ QPSï¼ˆQuery Per Secondï¼Œæ¯ç§’é’Ÿå¤„ç†å®Œè¯·æ±‚çš„æ¬¡æ•°ï¼‰ æ˜¯ MySQL çš„ 10 å€ï¼ŒRedis å•æœºçš„ QPS èƒ½è½»æ¾ç ´ 10wï¼Œè€Œ MySQL å•æœºçš„ QPS å¾ˆéš¾ç ´  1wã€‚

æ‰€ä»¥ï¼Œç›´æ¥è®¿é—® Redis èƒ½å¤Ÿæ‰¿å—çš„è¯·æ±‚æ˜¯è¿œè¿œå¤§äºç›´æ¥è®¿é—® MySQL çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠæ•°æ®åº“ä¸­çš„éƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç¼“å­˜ä¸­å»ï¼Œè¿™æ ·ç”¨æˆ·çš„ä¸€éƒ¨åˆ†è¯·æ±‚ä¼šç›´æ¥åˆ°ç¼“å­˜è¿™é‡Œè€Œä¸ç”¨ç»è¿‡æ•°æ®åº“ã€‚

### Redis å¦‚ä½•å®ç°æœåŠ¡é«˜å¯ç”¨ï¼Ÿ

è¦æƒ³è®¾è®¡ä¸€ä¸ªé«˜å¯ç”¨çš„ Redis æœåŠ¡ï¼Œä¸€å®šè¦ä» Redis çš„å¤šæœåŠ¡èŠ‚ç‚¹æ¥è€ƒè™‘ï¼Œæ¯”å¦‚ Redis çš„ä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼ã€åˆ‡ç‰‡é›†ç¾¤ã€‚

> ä¸»ä»å¤åˆ¶

ä¸»ä»å¤åˆ¶æ˜¯ Redis é«˜å¯ç”¨æœåŠ¡çš„æœ€åŸºç¡€çš„ä¿è¯ï¼Œå®ç°æ–¹æ¡ˆå°±æ˜¯å°†ä»å‰çš„ä¸€å° Redis æœåŠ¡å™¨ï¼ŒåŒæ­¥æ•°æ®åˆ°å¤šå°ä» Redis æœåŠ¡å™¨ä¸Šï¼Œå³ä¸€ä¸»å¤šä»çš„æ¨¡å¼ï¼Œä¸”ä¸»ä»æœåŠ¡å™¨ä¹‹é—´é‡‡ç”¨çš„æ˜¯ã€Œè¯»å†™åˆ†ç¦»ã€çš„æ–¹å¼ã€‚

ä¸»æœåŠ¡å™¨å¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œå½“å‘ç”Ÿå†™æ“ä½œæ—¶è‡ªåŠ¨å°†å†™æ“ä½œåŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨ä¸€èˆ¬æ˜¯åªè¯»ï¼Œå¹¶æ¥å—ä¸»æœåŠ¡å™¨åŒæ­¥è¿‡æ¥å†™æ“ä½œå‘½ä»¤ï¼Œç„¶åæ‰§è¡Œè¿™æ¡å‘½ä»¤ã€‚

![image-20220715161214356](./images/image-20220715161214356.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„æ•°æ®ä¿®æ”¹åªåœ¨ä¸»æœåŠ¡å™¨ä¸Šè¿›è¡Œï¼Œç„¶åå°†æœ€æ–°çš„æ•°æ®åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè¿™æ ·å°±ä½¿å¾—ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚

æ³¨æ„ï¼Œä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„å‘½ä»¤å¤åˆ¶æ˜¯**å¼‚æ­¥**è¿›è¡Œçš„ã€‚

å…·ä½“æ¥è¯´ï¼Œåœ¨ä¸»ä»æœåŠ¡å™¨å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä¸»æœåŠ¡å™¨æ”¶åˆ°æ–°çš„å†™å‘½ä»¤åï¼Œä¼šå‘é€ç»™ä»æœåŠ¡å™¨ã€‚ä½†æ˜¯ï¼Œä¸»æœåŠ¡å™¨å¹¶ä¸ä¼šç­‰åˆ°ä»æœåŠ¡å™¨å®é™…æ‰§è¡Œå®Œå‘½ä»¤åï¼Œå†æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯ä¸»æœåŠ¡å™¨è‡ªå·±åœ¨æœ¬åœ°æ‰§è¡Œå®Œå‘½ä»¤åï¼Œå°±ä¼šå‘å®¢æˆ·ç«¯è¿”å›ç»“æœäº†ã€‚å¦‚æœä»æœåŠ¡å™¨è¿˜æ²¡æœ‰æ‰§è¡Œä¸»æœåŠ¡å™¨åŒæ­¥è¿‡æ¥çš„å‘½ä»¤ï¼Œä¸»ä»æœåŠ¡å™¨é—´çš„æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚

æ‰€ä»¥ï¼Œæ— æ³•å®ç°å¼ºä¸€è‡´æ€§ä¿è¯ï¼ˆä¸»ä»æ•°æ®æ—¶æ—¶åˆ»åˆ»ä¿æŒä¸€è‡´ï¼‰ï¼Œæ•°æ®ä¸ä¸€è‡´æ˜¯éš¾ä»¥é¿å…çš„ã€‚

> å“¨å…µæ¨¡å¼

åœ¨ä½¿ç”¨ Redis ä¸»ä»æœåŠ¡çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“ Redis çš„ä¸»ä»æœåŠ¡å™¨å‡ºç°æ•…éšœå®•æœºæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨è¿›è¡Œæ¢å¤ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis å¢åŠ äº†å“¨å…µæ¨¡å¼ï¼ˆ**Redis Sentinel**ï¼‰ï¼Œå› ä¸ºå“¨å…µæ¨¡å¼åšåˆ°äº†å¯ä»¥ç›‘æ§ä¸»ä»æœåŠ¡å™¨ï¼Œå¹¶ä¸”æä¾›**ä¸»ä»èŠ‚ç‚¹æ•…éšœè½¬ç§»çš„åŠŸèƒ½ã€‚**

![image-20220715161234139](./images/image-20220715161234139.png)

> åˆ‡ç‰‡é›†ç¾¤æ¨¡å¼

å½“ Redis ç¼“å­˜æ•°æ®é‡å¤§åˆ°ä¸€å°æœåŠ¡å™¨æ— æ³•ç¼“å­˜æ—¶ï¼Œå°±éœ€è¦ä½¿ç”¨ **Redis åˆ‡ç‰‡é›†ç¾¤**ï¼ˆRedis Cluster ï¼‰æ–¹æ¡ˆï¼Œå®ƒå°†æ•°æ®åˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä»¥æ­¤æ¥é™ä½ç³»ç»Ÿå¯¹å•ä¸»èŠ‚ç‚¹çš„ä¾èµ–ï¼Œä»è€Œæé«˜ Redis æœåŠ¡çš„è¯»å†™æ€§èƒ½ã€‚

Redis Cluster æ–¹æ¡ˆé‡‡ç”¨å“ˆå¸Œæ§½ï¼ˆHash Slotï¼‰ï¼Œæ¥å¤„ç†æ•°æ®å’ŒèŠ‚ç‚¹ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚åœ¨ Redis Cluster æ–¹æ¡ˆä¸­ï¼Œ**ä¸€ä¸ªåˆ‡ç‰‡é›†ç¾¤å…±æœ‰ 16384 ä¸ªå“ˆå¸Œæ§½**ï¼Œè¿™äº›å“ˆå¸Œæ§½ç±»ä¼¼äºæ•°æ®åˆ†åŒºï¼Œæ¯ä¸ªé”®å€¼å¯¹éƒ½ä¼šæ ¹æ®å®ƒçš„ keyï¼Œè¢«æ˜ å°„åˆ°ä¸€ä¸ªå“ˆå¸Œæ§½ä¸­ï¼Œå…·ä½“æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºä¸¤å¤§æ­¥ï¼š

- æ ¹æ®é”®å€¼å¯¹çš„ keyï¼ŒæŒ‰ç…§ CRC16 ç®—æ³•è®¡ç®—ä¸€ä¸ª 16 bit çš„å€¼ã€‚
- å†ç”¨ 16bit å€¼å¯¹ 16384 å–æ¨¡ï¼Œå¾—åˆ° 0~16383 èŒƒå›´å†…çš„æ¨¡æ•°ï¼Œæ¯ä¸ªæ¨¡æ•°ä»£è¡¨ä¸€ä¸ªç›¸åº”ç¼–å·çš„å“ˆå¸Œæ§½ã€‚

æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œè¿™äº›å“ˆå¸Œæ§½æ€ä¹ˆè¢«æ˜ å°„åˆ°å…·ä½“çš„ Redis èŠ‚ç‚¹ä¸Šçš„å‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

- **å¹³å‡åˆ†é…ï¼š** åœ¨ä½¿ç”¨ cluster create å‘½ä»¤åˆ›å»º Redis é›†ç¾¤æ—¶ï¼ŒRedis ä¼šè‡ªåŠ¨æŠŠæ‰€æœ‰å“ˆå¸Œæ§½å¹³å‡åˆ†å¸ƒåˆ°é›†ç¾¤èŠ‚ç‚¹ä¸Šã€‚æ¯”å¦‚é›†ç¾¤ä¸­æœ‰ 9 ä¸ªèŠ‚ç‚¹ï¼Œåˆ™æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ§½çš„ä¸ªæ•°ä¸º 16384/9 ä¸ªã€‚
- **æ‰‹åŠ¨åˆ†é…ï¼š** å¯ä»¥ä½¿ç”¨ cluster meet å‘½ä»¤æ‰‹åŠ¨å»ºç«‹èŠ‚ç‚¹é—´çš„è¿æ¥ï¼Œç»„æˆé›†ç¾¤ï¼Œå†ä½¿ç”¨ cluster addslots å‘½ä»¤ï¼ŒæŒ‡å®šæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„å“ˆå¸Œæ§½ä¸ªæ•°ã€‚

ä¸ºäº†æ–¹ä¾¿ä½ çš„ç†è§£ï¼Œæˆ‘é€šè¿‡ä¸€å¼ å›¾æ¥è§£é‡Šæ•°æ®ã€å“ˆå¸Œæ§½ï¼Œä»¥åŠèŠ‚ç‚¹ä¸‰è€…çš„æ˜ å°„åˆ†å¸ƒå…³ç³»ã€‚

![image-20220715161306957](./images/image-20220715161306957.png)

ä¸Šå›¾ä¸­çš„åˆ‡ç‰‡é›†ç¾¤ä¸€å…±æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼Œå‡è®¾æœ‰ 4 ä¸ªå“ˆå¸Œæ§½ï¼ˆSlot 0ï½Slot 3ï¼‰æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å‘½ä»¤æ‰‹åŠ¨åˆ†é…å“ˆå¸Œæ§½ï¼Œæ¯”å¦‚èŠ‚ç‚¹ 1 ä¿å­˜å“ˆå¸Œæ§½ 0 å’Œ 1ï¼ŒèŠ‚ç‚¹ 2 ä¿å­˜å“ˆå¸Œæ§½ 2 å’Œ 3ã€‚

```c
redis-cli -h 192.168.1.10 â€“p 6379 cluster addslots 0,1
redis-cli -h 192.168.1.11 â€“p 6379 cluster addslots 2,3
```

ç„¶ååœ¨é›†ç¾¤è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œkey1 å’Œ key2 è®¡ç®—å®Œ CRC16 å€¼åï¼Œå¯¹å“ˆå¸Œæ§½æ€»ä¸ªæ•° 5 è¿›è¡Œå–æ¨¡ï¼Œå†æ ¹æ®å„è‡ªçš„æ¨¡æ•°ç»“æœï¼Œå°±å¯ä»¥è¢«æ˜ å°„åˆ°å¯¹åº”çš„èŠ‚ç‚¹ 1 å’ŒèŠ‚ç‚¹ 3 ä¸Šäº†ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ‰‹åŠ¨åˆ†é…å“ˆå¸Œæ§½æ—¶ï¼Œéœ€è¦æŠŠ 16384 ä¸ªæ§½éƒ½åˆ†é…å®Œï¼Œå¦åˆ™ Redis é›†ç¾¤æ— æ³•æ­£å¸¸å·¥ä½œã€‚

### Redis å’Œ Memcached æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

å¾ˆå¤šäººéƒ½è¯´ç”¨ Redis ä½œä¸ºç¼“å­˜ï¼Œä½†æ˜¯ Memcached ä¹Ÿæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œä¸ºä»€ä¹ˆä¸é€‰æ‹©å®ƒä½œä¸ºç¼“å­˜å‘¢ï¼Ÿè¦è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±è¦å¼„æ¸…æ¥š Redis å’Œ Memcached çš„åŒºåˆ«ã€‚ Redis ä¸ Memcached **å…±åŒç‚¹**ï¼š

1. éƒ½æ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œä¸€èˆ¬éƒ½ç”¨æ¥å½“åšç¼“å­˜ä½¿ç”¨ã€‚
2. éƒ½æœ‰è¿‡æœŸç­–ç•¥ã€‚
3. ä¸¤è€…çš„æ€§èƒ½éƒ½éå¸¸é«˜ã€‚

Redis ä¸ Memcached **åŒºåˆ«**ï¼š

- Redis æ”¯æŒçš„æ•°æ®ç±»å‹æ›´ä¸°å¯Œï¼ˆStringã€Hashã€Listã€Setã€ZSetï¼‰ï¼Œè€Œ Memcached åªæ”¯æŒæœ€ç®€å•çš„ key-value æ•°æ®ç±»å‹ï¼›
- Redis æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿æŒåœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨ï¼Œè€Œ Memcached æ²¡æœ‰æŒä¹…åŒ–åŠŸèƒ½ï¼Œæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ï¼ŒMemcached é‡å¯æˆ–è€…æŒ‚æ‰åï¼Œæ•°æ®å°±æ²¡äº†ï¼›
- Redis åŸç”Ÿæ”¯æŒé›†ç¾¤æ¨¡å¼ï¼ŒMemcached æ²¡æœ‰åŸç”Ÿçš„é›†ç¾¤æ¨¡å¼ï¼Œéœ€è¦ä¾é å®¢æˆ·ç«¯æ¥å®ç°å¾€é›†ç¾¤ä¸­åˆ†ç‰‡å†™å…¥æ•°æ®ï¼›
- Redis æ”¯æŒå‘å¸ƒè®¢é˜…æ¨¡å‹ã€Lua è„šæœ¬ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè€Œ Memcached ä¸æ”¯æŒï¼›

### Redis é™¤äº†åšç¼“å­˜ï¼Œè¿˜èƒ½åšä»€ä¹ˆï¼Ÿ

**åˆ†å¸ƒå¼é”** ï¼š é€šè¿‡ Redis æ¥åšåˆ†å¸ƒå¼é”æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æ–¹å¼ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯åŸºäº Redisson æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚ç›¸å…³é˜…è¯»ï¼š[ã€Šåˆ†å¸ƒå¼é”ä¸­çš„ç‹è€…æ–¹æ¡ˆ - Redissonã€‹](https://mp.weixin.qq.com/s/CbnPRfvq4m1sqo2uKI6qQw)

**é™æµ** ï¼šä¸€èˆ¬æ˜¯é€šè¿‡ Redis + Lua è„šæœ¬çš„æ–¹å¼æ¥å®ç°é™æµã€‚ç›¸å…³é˜…è¯»ï¼š[ã€Šæˆ‘å¸ç”¨äº† 6 å¹´çš„ Redis åˆ†å¸ƒå¼é™æµå™¨ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸å‰å®³äº†ï¼ã€‹](https://mp.weixin.qq.com/s/kyFAWH3mVNJvurQDt4vchA)

**æ¶ˆæ¯é˜Ÿåˆ—** ï¼šRedis è‡ªå¸¦çš„ list æ•°æ®ç»“æ„å¯ä»¥ä½œä¸ºä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—ä½¿ç”¨ã€‚Redis 5.0 ä¸­å¢åŠ çš„ Stream ç±»å‹çš„æ•°æ®ç»“æ„æ›´åŠ é€‚åˆç”¨æ¥åšæ¶ˆæ¯é˜Ÿåˆ—ã€‚å®ƒæ¯”è¾ƒç±»ä¼¼äº Kafkaï¼Œæœ‰ä¸»é¢˜å’Œæ¶ˆè´¹ç»„çš„æ¦‚å¿µï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ä»¥åŠ ACK æœºåˆ¶ã€‚

**å¤æ‚ä¸šåŠ¡åœºæ™¯** ï¼šé€šè¿‡ Redis ä»¥åŠ Redis æ‰©å±•ï¼ˆæ¯”å¦‚ Redissonï¼‰æä¾›çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®Œæˆå¾ˆå¤šå¤æ‚çš„ä¸šåŠ¡åœºæ™¯æ¯”å¦‚é€šè¿‡ bitmap ç»Ÿè®¡æ´»è·ƒç”¨æˆ·ã€é€šè¿‡ sorted set ç»´æŠ¤æ’è¡Œæ¦œã€‚

......

### â­åŸºæœ¬æ•°æ®ç±»å‹ã€åº”ç”¨åœºæ™¯

> 5ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼šstringã€listã€hashã€setã€zset
>
> æ¨èé˜…è¯»ï¼š[å›¾è§£ Redis æ•°æ®ç»“æ„](https://mp.weixin.qq.com/s/qptE172slg_6Tl1yuzdbfw)

#### 1ï¸âƒ£string

1. **ä»‹ç»** ï¼šstring æ•°æ®ç»“æ„æ˜¯ç®€å•çš„ key-value ç±»å‹ã€‚è™½ç„¶ Redis æ˜¯ç”¨ C è¯­è¨€å†™çš„ï¼Œä½†æ˜¯ Redis å¹¶æ²¡æœ‰ä½¿ç”¨ C çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§ **ç®€å•åŠ¨æ€å­—ç¬¦ä¸²**ï¼ˆsimple dynamic stringï¼Œ**SDS**ï¼‰ã€‚ç›¸æ¯”äº C çš„åŸç”Ÿå­—ç¬¦ä¸²ï¼ŒRedis çš„ SDS ä¸å…‰å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®è¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶ä¸”è·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦ä¸º O(1)ï¼ˆC å­—ç¬¦ä¸²ä¸º O(N)ï¼‰,é™¤æ­¤ä¹‹å¤–ï¼ŒRedis çš„ SDS API æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `set,get,strlen,exists,decr,incr,setex` ç­‰ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯ï¼š** ä¸€èˆ¬å¸¸ç”¨åœ¨éœ€è¦**è®¡æ•°**çš„åœºæ™¯ï¼Œæ¯”å¦‚ç”¨æˆ·çš„è®¿é—®æ¬¡æ•°ã€çƒ­ç‚¹æ–‡ç« çš„ç‚¹èµè½¬å‘æ•°é‡ï¼›**ç¼“å­˜**ï¼Œç»å…¸ä½¿ç”¨åœºæ™¯ï¼ŒæŠŠå¸¸ç”¨ä¿¡æ¯ï¼Œå­—ç¬¦ä¸²ï¼Œå›¾ç‰‡æˆ–è€…è§†é¢‘ç­‰ä¿¡æ¯æ”¾åˆ°redisä¸­ï¼Œredisä½œä¸ºç¼“å­˜å±‚ï¼ŒmysqlåšæŒä¹…åŒ–å±‚ï¼Œé™ä½mysqlçš„è¯»å†™å‹åŠ›ï¼›**session**ï¼Œå¸¸è§æ–¹æ¡ˆspring session + rediså®ç°sessionå…±äº«ç­‰ç­‰ã€‚

#### 2ï¸âƒ£list

1. **ä»‹ç»** ï¼š**list** å³æ˜¯ **é“¾è¡¨**ã€‚é“¾è¡¨æ˜¯ä¸€ç§éå¸¸å¸¸è§çš„æ•°æ®ç»“æ„ï¼Œç‰¹ç‚¹æ˜¯æ˜“äºæ•°æ®å…ƒç´ çš„æ’å…¥å’Œåˆ é™¤å¹¶ä¸”å¯ä»¥çµæ´»è°ƒæ•´é“¾è¡¨é•¿åº¦ï¼Œä½†æ˜¯é“¾è¡¨çš„éšæœºè®¿é—®å›°éš¾ã€‚è®¸å¤šé«˜çº§ç¼–ç¨‹è¯­è¨€éƒ½å†…ç½®äº†é“¾è¡¨çš„å®ç°æ¯”å¦‚ Java ä¸­çš„ **LinkedList**ï¼Œä½†æ˜¯ C è¯­è¨€å¹¶æ²¡æœ‰å®ç°é“¾è¡¨ï¼Œæ‰€ä»¥ Redis å®ç°äº†è‡ªå·±çš„é“¾è¡¨æ•°æ®ç»“æ„ã€‚Redis çš„ list çš„å®ç°ä¸ºä¸€ä¸ª **åŒå‘é“¾è¡¨**ï¼Œå³å¯ä»¥æ”¯æŒåå‘æŸ¥æ‰¾å’Œéå†ï¼Œæ›´æ–¹ä¾¿æ“ä½œï¼Œä¸è¿‡å¸¦æ¥äº†éƒ¨åˆ†é¢å¤–çš„å†…å­˜å¼€é”€ã€‚
2. **å¸¸ç”¨å‘½ä»¤:** `rpush,lpop,lpush,rpop,lrange,llen` ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯:** å‘å¸ƒä¸è®¢é˜…æˆ–è€…è¯´æ¶ˆæ¯é˜Ÿåˆ—ã€æ…¢æŸ¥è¯¢ã€‚
   1. **å¾®åšTimeLine**: æœ‰äººå‘å¸ƒå¾®åšï¼Œç”¨lpushåŠ å…¥æ—¶é—´è½´ï¼Œå±•ç¤ºæ–°çš„åˆ—è¡¨ä¿¡æ¯ã€‚

#### 3ï¸âƒ£hash

1. **ä»‹ç»** ï¼šhash ç±»ä¼¼äº JDK1.8 å‰çš„ HashMapï¼Œå†…éƒ¨å®ç°ä¹Ÿå·®ä¸å¤š(æ•°ç»„ + é“¾è¡¨)ã€‚ä¸è¿‡ï¼ŒRedis çš„ hash åšäº†æ›´å¤šä¼˜åŒ–ã€‚å¦å¤–ï¼Œhash æ˜¯ä¸€ä¸ª string ç±»å‹çš„ field å’Œ value çš„æ˜ å°„è¡¨ï¼Œ**ç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡**ï¼Œåç»­æ“ä½œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç›´æ¥ä»…ä»…ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªå­—æ®µçš„å€¼ã€‚ æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ hash æ•°æ®ç»“æ„æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œå•†å“ä¿¡æ¯ç­‰ç­‰ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `hset,hmset,hexists,hget,hgetall,hkeys,hvals` ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯:** ç³»ç»Ÿä¸­å¯¹è±¡æ•°æ®çš„å­˜å‚¨ï¼Œ**ç¼“å­˜**ï¼š èƒ½ç›´è§‚ï¼Œç›¸æ¯”stringæ›´èŠ‚çœç©ºé—´ï¼Œçš„ç»´æŠ¤ç¼“å­˜ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·ä¿¡æ¯ï¼Œè§†é¢‘ä¿¡æ¯ç­‰ã€‚

#### 4ï¸âƒ£set

1. **ä»‹ç» ï¼š** set ç±»ä¼¼äº Java ä¸­çš„ `HashSet`  ã€‚Redis ä¸­çš„ set ç±»å‹æ˜¯ä¸€ç§æ— åºé›†åˆï¼Œé›†åˆä¸­çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºã€‚å½“ä½ éœ€è¦å­˜å‚¨ä¸€ä¸ªåˆ—è¡¨æ•°æ®ï¼Œåˆä¸å¸Œæœ›å‡ºç°é‡å¤æ•°æ®æ—¶ï¼Œset  æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå¹¶ä¸” set æä¾›äº†åˆ¤æ–­æŸä¸ªæˆå‘˜æ˜¯å¦åœ¨ä¸€ä¸ª set é›†åˆå†…çš„é‡è¦æ¥å£ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ list æ‰€ä¸èƒ½æä¾›çš„ã€‚å¯ä»¥åŸºäº set  è½»æ˜“å®ç°äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„æ“ä½œã€‚æ¯”å¦‚ï¼šä½ å¯ä»¥å°†ä¸€ä¸ªç”¨æˆ·æ‰€æœ‰çš„å…³æ³¨äººå­˜åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œå°†å…¶æ‰€æœ‰ç²‰ä¸å­˜åœ¨ä¸€ä¸ªé›†åˆã€‚Redis  å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°å¦‚å…±åŒå…³æ³¨ã€å…±åŒç²‰ä¸ã€å…±åŒå–œå¥½ç­‰åŠŸèƒ½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿå°±æ˜¯æ±‚äº¤é›†çš„è¿‡ç¨‹ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `sadd,spop,smembers,sismember,scard,sinterstore,sunion` ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯:** éœ€è¦å­˜æ”¾çš„æ•°æ®ä¸èƒ½é‡å¤ä»¥åŠéœ€è¦è·å–å¤šä¸ªæ•°æ®æºäº¤é›†å’Œå¹¶é›†ç­‰åœºæ™¯ï¼›**æ ‡ç­¾**ï¼ˆtagï¼‰,ç»™ç”¨æˆ·æ·»åŠ æ ‡ç­¾ï¼Œæˆ–è€…ç”¨æˆ·ç»™æ¶ˆæ¯æ·»åŠ æ ‡ç­¾ï¼Œè¿™æ ·æœ‰åŒä¸€æ ‡ç­¾æˆ–è€…ç±»ä¼¼æ ‡ç­¾çš„å¯ä»¥ç»™æ¨èå…³æ³¨çš„äº‹æˆ–è€…å…³æ³¨çš„äººï¼›**ç‚¹èµï¼Œæˆ–ç‚¹è¸©ï¼Œæ”¶è—ç­‰**ï¼Œå¯ä»¥æ”¾åˆ°setä¸­å®ç°ã€‚

#### 5ï¸âƒ£Zset

1. **ä»‹ç» ï¼š** å’Œ set ç›¸æ¯”ï¼Œsorted set å¢åŠ äº†ä¸€ä¸ªæƒé‡å‚æ•° scoreï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ score è¿›è¡Œæœ‰åºæ’åˆ—ï¼Œè¿˜å¯ä»¥é€šè¿‡ score çš„èŒƒå›´æ¥è·å–å…ƒç´ çš„åˆ—è¡¨ã€‚æœ‰ç‚¹åƒæ˜¯ Java ä¸­ HashMap å’Œ TreeSet çš„ç»“åˆä½“ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `ZADD å°†ä¸€ä¸ªå¸¦æœ‰ç»™å®šåˆ†å€¼çš„æˆå‘˜æ·»åŠ åˆ°æœ‰åºé›†åˆé‡Œé¢,ZRANGE æ ¹æ®å…ƒç´ åœ¨æœ‰åºé›†åˆä¸­æ‰€å¤„çš„ä½ç½®ï¼Œä»æœ‰åºé›†åˆä¸­è·å–å¤šä¸ªå…ƒç´ ,ZREM å¦‚æœç»™å®šå…ƒç´ æˆå‘˜å­˜åœ¨äºæœ‰åºé›†åˆä¸­ï¼Œé‚£ä¹ˆå°±ç§»é™¤è¿™ä¸ªå…ƒç´ ` ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯:** **æ’è¡Œæ¦œ**   éœ€è¦å¯¹æ•°æ®æ ¹æ®æŸä¸ªæƒé‡è¿›è¡Œæ’åºçš„åœºæ™¯ã€‚ä¾‹å¦‚å°è¯´è§†é¢‘ç­‰ç½‘ç«™éœ€è¦å¯¹ç”¨æˆ·ä¸Šä¼ çš„å°è¯´è§†é¢‘åšæ’è¡Œæ¦œï¼Œæ¦œå•å¯ä»¥æŒ‰ç…§ç”¨æˆ·å…³æ³¨æ•°ï¼Œæ›´æ–°æ—¶é—´ï¼Œå­—æ•°ç­‰æ‰“åˆ†ï¼Œåšæ’è¡Œï¼›åœ¨ç›´æ’­ç³»ç»Ÿä¸­ï¼Œå®æ—¶æ’è¡Œä¿¡æ¯åŒ…å«ç›´æ’­é—´åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼›å„ç§ç¤¼ç‰©**æ’è¡Œæ¦œ**ï¼Œå¼¹å¹•æ¶ˆæ¯ï¼ˆå¯ä»¥ç†è§£ä¸ºæŒ‰æ¶ˆæ¯ç»´åº¦çš„æ¶ˆæ¯æ’è¡Œæ¦œï¼‰ç­‰ä¿¡æ¯ã€‚
4. æœ‰åºé›†åˆæ˜¯é€šè¿‡ä¸¤ç§æ•°æ®ç»“æ„å®ç°ï¼š

   1. **å‹ç¼©åˆ—è¡¨(ziplist)**: ziplistæ˜¯ä¸ºäº†æé«˜å­˜å‚¨æ•ˆç‡è€Œè®¾è®¡çš„ä¸€ç§ç‰¹æ®Šç¼–ç çš„åŒå‘é“¾è¡¨ã€‚å®ƒå¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²æˆ–è€…æ•´æ•°ï¼Œå­˜å‚¨æ•´æ•°æ—¶æ˜¯é‡‡ç”¨æ•´æ•°çš„äºŒè¿›åˆ¶è€Œä¸æ˜¯å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨ã€‚å®ƒèƒ½åœ¨O(1)çš„æ—¶é—´å¤æ‚åº¦ä¸‹å®Œæˆlistä¸¤ç«¯çš„pushå’Œpopæ“ä½œã€‚ä½†æ˜¯å› ä¸ºæ¯æ¬¡æ“ä½œéƒ½éœ€è¦é‡æ–°åˆ†é…ziplistçš„å†…å­˜ï¼Œæ‰€ä»¥å®é™…å¤æ‚åº¦å’Œziplistçš„å†…å­˜ä½¿ç”¨é‡ç›¸å…³
   2. **è·³è·ƒè¡¨ï¼ˆzSkiplist)**: è·³è·ƒè¡¨çš„æ€§èƒ½å¯ä»¥ä¿è¯åœ¨æŸ¥æ‰¾ï¼Œåˆ é™¤ï¼Œæ·»åŠ ç­‰æ“ä½œçš„æ—¶å€™åœ¨å¯¹æ•°æœŸæœ›æ—¶é—´å†…å®Œæˆï¼Œè¿™ä¸ªæ€§èƒ½æ˜¯å¯ä»¥å’Œå¹³è¡¡æ ‘æ¥ç›¸æ¯”è¾ƒçš„ï¼Œè€Œä¸”åœ¨å®ç°æ–¹é¢æ¯”å¹³è¡¡æ ‘è¦ä¼˜é›…ï¼Œè¿™æ˜¯é‡‡ç”¨è·³è·ƒè¡¨çš„ä¸»è¦åŸå› ã€‚è·³è·ƒè¡¨çš„å¤æ‚åº¦æ˜¯O(log(n))ã€‚

éšç€ Redis ç‰ˆæœ¬çš„æ›´æ–°ï¼Œåé¢åˆæ”¯æŒäº†å››ç§æ•°æ®ç±»å‹ï¼šBitMapï¼ˆ2.2 ç‰ˆæ–°å¢ï¼‰ã€HyperLogLogï¼ˆ2.8 ç‰ˆæ–°å¢ï¼‰ã€GEOï¼ˆ3.2 ç‰ˆæ–°å¢ï¼‰ã€Streamï¼ˆ5.0 ç‰ˆæ–°å¢ï¼‰

#### ç‰¹æ®Šç±»å‹ï¼š bitmap

1. **ä»‹ç»ï¼š** bitmap å­˜å‚¨çš„æ˜¯è¿ç»­çš„äºŒè¿›åˆ¶æ•°å­—ï¼ˆ0 å’Œ 1ï¼‰ï¼Œé€šè¿‡ bitmap, åªéœ€è¦ä¸€ä¸ª bit ä½æ¥è¡¨ç¤ºæŸä¸ªå…ƒç´ å¯¹åº”çš„å€¼æˆ–è€…çŠ¶æ€ï¼Œkey å°±æ˜¯å¯¹åº”å…ƒç´ æœ¬èº« ã€‚æˆ‘ä»¬çŸ¥é“ 8 ä¸ª bit å¯ä»¥ç»„æˆä¸€ä¸ª byteï¼Œæ‰€ä»¥ bitmap æœ¬èº«ä¼šæå¤§çš„èŠ‚çœå‚¨å­˜ç©ºé—´ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** `setbit` ã€`getbit` ã€`bitcount`ã€`bitop`
3. **åº”ç”¨åœºæ™¯ï¼š** é€‚åˆéœ€è¦ä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼ˆæ¯”å¦‚æ˜¯å¦ç­¾åˆ°ã€æ˜¯å¦ç™»å½•...ï¼‰å¹¶éœ€è¦è¿›ä¸€æ­¥å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œåˆ†æçš„åœºæ™¯ã€‚æ¯”å¦‚ç”¨æˆ·ç­¾åˆ°æƒ…å†µã€æ´»è·ƒç”¨æˆ·æƒ…å†µã€ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ï¼ˆæ¯”å¦‚æ˜¯å¦ç‚¹èµè¿‡æŸä¸ªè§†é¢‘ï¼‰ã€‚

### Redis å•çº¿ç¨‹æ¨¡å‹äº†è§£å—ï¼Ÿ

**Redis åŸºäº Reactor æ¨¡å¼æ¥è®¾è®¡å¼€å‘äº†è‡ªå·±çš„ä¸€å¥—é«˜æ•ˆçš„äº‹ä»¶å¤„ç†æ¨¡å‹** ï¼ˆNetty çš„çº¿ç¨‹æ¨¡å‹ä¹ŸåŸºäº Reactor æ¨¡å¼ï¼ŒReactor æ¨¡å¼ä¸æ„§æ˜¯é«˜æ€§èƒ½ IO çš„åŸºçŸ³ï¼‰ï¼Œè¿™å¥—äº‹ä»¶å¤„ç†æ¨¡å‹å¯¹åº”çš„æ˜¯ Redis ä¸­çš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile  event handlerï¼‰ã€‚ç”±äºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰æ˜¯å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½è¯´ Redis  æ˜¯å•çº¿ç¨‹æ¨¡å‹ã€‚

**æ—¢ç„¶æ˜¯å•çº¿ç¨‹ï¼Œé‚£æ€ä¹ˆç›‘å¬å¤§é‡çš„å®¢æˆ·ç«¯è¿æ¥å‘¢ï¼Ÿ**

Redis é€šè¿‡**IO å¤šè·¯å¤ç”¨ç¨‹åº** æ¥ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼ˆæˆ–è€…è¯´æ˜¯ç›‘å¬å¤šä¸ª socketï¼‰ï¼Œå®ƒä¼šå°†æ„Ÿå…´è¶£çš„äº‹ä»¶åŠç±»å‹ï¼ˆè¯»ã€å†™ï¼‰æ³¨å†Œåˆ°å†…æ ¸ä¸­å¹¶ç›‘å¬æ¯ä¸ªäº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚

è¿™æ ·çš„å¥½å¤„éå¸¸æ˜æ˜¾ï¼š **I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä½¿ç”¨è®© Redis ä¸éœ€è¦é¢å¤–åˆ›å»ºå¤šä½™çš„çº¿ç¨‹æ¥ç›‘å¬å®¢æˆ·ç«¯çš„å¤§é‡è¿æ¥ï¼Œé™ä½äº†èµ„æºçš„æ¶ˆè€—**ï¼ˆå’Œ NIO ä¸­çš„ `Selector` ç»„ä»¶å¾ˆåƒï¼‰ã€‚

å¦å¤–ï¼Œ Redis æœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ç¨‹åºï¼ŒæœåŠ¡å™¨éœ€è¦å¤„ç†ä¸¤ç±»äº‹ä»¶ï¼š1. æ–‡ä»¶äº‹ä»¶; 2. æ—¶é—´äº‹ä»¶ã€‚

æ—¶é—´äº‹ä»¶ä¸éœ€è¦å¤šèŠ±æ—¶é—´äº†è§£ï¼Œæˆ‘ä»¬æ¥è§¦æœ€å¤šçš„è¿˜æ˜¯ **æ–‡ä»¶äº‹ä»¶**ï¼ˆå®¢æˆ·ç«¯è¿›è¡Œè¯»å–å†™å…¥ç­‰æ“ä½œï¼Œæ¶‰åŠä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡ï¼‰ã€‚

ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹æœ‰ä¸€æ®µè¯æ˜¯å¦‚æ˜¯ä»‹ç»æ–‡ä»¶äº‹ä»¶çš„ï¼Œæˆ‘è§‰å¾—å†™å¾—æŒºä¸é”™ã€‚

> Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼šè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event  handlerï¼‰ã€‚æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I/O  å¤šè·¯å¤ç”¨ï¼ˆmultiplexingï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚
>
> å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³ é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚
>
> **è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—**ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œè¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§ã€‚

å¯ä»¥çœ‹å‡ºï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰ä¸»è¦æ˜¯åŒ…å« 4 ä¸ªéƒ¨åˆ†ï¼š

- å¤šä¸ª socketï¼ˆå®¢æˆ·ç«¯è¿æ¥ï¼‰
- IO å¤šè·¯å¤ç”¨ç¨‹åºï¼ˆæ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥çš„å…³é”®ï¼‰
- æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼ˆå°† socket å…³è”åˆ°ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼‰
- äº‹ä»¶å¤„ç†å™¨ï¼ˆè¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ï¼‰

![image-20220716153002622](./images/image-20220716153002622.png)

å›¾ä¸­çš„è“è‰²éƒ¨åˆ†æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ˜¯ç”±ä¸»çº¿ç¨‹è´Ÿè´£çš„ï¼Œå¯ä»¥çœ‹åˆ°ç½‘ç»œ I/O å’Œå‘½ä»¤å¤„ç†éƒ½æ˜¯å•çº¿ç¨‹ã€‚ Redis åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šåšä¸‹é¢è¿™å‡ å¹´äº‹æƒ…ï¼š

- é¦–å…ˆï¼Œè°ƒç”¨ epoll_create() åˆ›å»ºä¸€ä¸ª epoll å¯¹è±¡å’Œè°ƒç”¨ socket() ä¸€ä¸ªæœåŠ¡ç«¯ socket
- ç„¶åï¼Œè°ƒç”¨ bind() ç»‘å®šç«¯å£å’Œè°ƒç”¨ listen() ç›‘å¬è¯¥ socketï¼›
- ç„¶åï¼Œå°†è°ƒç”¨ epoll_crt() å°† listen socket åŠ å…¥åˆ° epollï¼ŒåŒæ—¶æ³¨å†Œã€Œè¿æ¥äº‹ä»¶ã€å¤„ç†å‡½æ•°ã€‚

åˆå§‹åŒ–å®Œåï¼Œä¸»çº¿ç¨‹å°±è¿›å…¥åˆ°ä¸€ä¸ª**äº‹ä»¶å¾ªç¯å‡½æ•°**ï¼Œä¸»è¦ä¼šåšä»¥ä¸‹äº‹æƒ…ï¼š

- é¦–å…ˆï¼Œå…ˆè°ƒç”¨**å¤„ç†å‘é€é˜Ÿåˆ—å‡½æ•°**ï¼Œçœ‹æ˜¯å‘é€é˜Ÿåˆ—é‡Œæ˜¯å¦æœ‰ä»»åŠ¡ï¼Œå¦‚æœæœ‰å‘é€ä»»åŠ¡ï¼Œåˆ™é€šè¿‡ write å‡½æ•°å°†å®¢æˆ·ç«¯å‘é€ç¼“å­˜åŒºé‡Œçš„æ•°æ®å‘é€å‡ºå»ï¼Œå¦‚æœè¿™ä¸€è½®æ•°æ®æ²¡æœ‰å‘ç”Ÿå®Œï¼Œå°±ä¼šæ³¨å†Œå†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç­‰å¾… epoll_wait å‘ç°å¯å†™åå†å¤„ç† ã€‚
- æ¥ç€ï¼Œè°ƒç”¨ epoll_wait å‡½æ•°ç­‰å¾…äº‹ä»¶çš„åˆ°æ¥ï¼š
  - å¦‚æœæ˜¯**è¿æ¥äº‹ä»¶**åˆ°æ¥ï¼Œåˆ™ä¼šè°ƒç”¨**è¿æ¥äº‹ä»¶å¤„ç†å‡½æ•°**ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šè°ƒç”¨ accpet è·å–å·²è¿æ¥çš„ socket ->  è°ƒç”¨ epoll_ctr å°†å·²è¿æ¥çš„ socket åŠ å…¥åˆ° epoll -> æ³¨å†Œã€Œè¯»äº‹ä»¶ã€å¤„ç†å‡½æ•°ï¼›
  - å¦‚æœæ˜¯**è¯»äº‹ä»¶**åˆ°æ¥ï¼Œåˆ™ä¼šè°ƒç”¨**è¯»äº‹ä»¶å¤„ç†å‡½æ•°**ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šè°ƒç”¨ read è·å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ® -> è§£æå‘½ä»¤ -> å¤„ç†å‘½ä»¤ -> å°†å®¢æˆ·ç«¯å¯¹è±¡æ·»åŠ åˆ°å‘é€é˜Ÿåˆ— -> å°†æ‰§è¡Œç»“æœå†™åˆ°å‘é€ç¼“å­˜åŒºç­‰å¾…å‘é€ï¼›
  - å¦‚æœæ˜¯**å†™äº‹ä»¶**åˆ°æ¥ï¼Œåˆ™ä¼šè°ƒç”¨**å†™äº‹ä»¶å¤„ç†å‡½æ•°**ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šé€šè¿‡ write å‡½æ•°å°†å®¢æˆ·ç«¯å‘é€ç¼“å­˜åŒºé‡Œçš„æ•°æ®å‘é€å‡ºå»ï¼Œå¦‚æœè¿™ä¸€è½®æ•°æ®æ²¡æœ‰å‘ç”Ÿå®Œï¼Œå°±ä¼šç»§ç»­æ³¨å†Œå†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç­‰å¾… epoll_wait å‘ç°å¯å†™åå†å¤„ç† ã€‚

> âš ï¸ æé†’ï¼šç¯‡å¹…è¿‡é•¿ï¼Œå¦‚æœæ²¡æœ‰è€å¿ƒå»ºè®®ç›´æ¥èƒŒè¯µå³å¯
>
> æ·±å…¥äº†è§£Reactorç›´é€šè½¦ï¼šhttps://xiaolincoding.com/os/8_network_system/reactor.html#%E5%8D%95-reactor-%E5%8D%95%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B
>
> I/Oå¤šè·¯å¤ç”¨ç›´é€šè½¦ï¼šhttps://mp.weixin.qq.com/s/Qpa0qXxuIM8jrBqDaXmVNA

### Redis6.0 ä¹‹åä¸ºä½•å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ

**Redis6.0 å¼•å…¥å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½**ï¼Œå› ä¸ºè¿™ä¸ªç®—æ˜¯ Redis ä¸­çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼ˆRedis çš„ç“¶é¢ˆä¸»è¦å—é™äºå†…å­˜å’Œç½‘ç»œï¼‰ã€‚

è™½ç„¶ï¼ŒRedis6.0 å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ Redis çš„å¤šçº¿ç¨‹åªæ˜¯åœ¨ç½‘ç»œæ•°æ®çš„è¯»å†™è¿™ç±»è€—æ—¶æ“ä½œä¸Šä½¿ç”¨äº†ï¼Œæ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œã€‚å› æ­¤ï¼Œä½ ä¹Ÿä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

Redis6.0 çš„å¤šçº¿ç¨‹é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œåªä½¿ç”¨ä¸»çº¿ç¨‹ã€‚å¦‚éœ€å¼€å¯éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf` ï¼š

```bash
io-threads-do-reads yes
```

å¼€å¯å¤šçº¿ç¨‹åï¼Œè¿˜éœ€è¦è®¾ç½®çº¿ç¨‹æ•°ï¼Œå¦åˆ™æ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚åŒæ ·éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ `redis.conf` :

```bash
io-threads 4 #å®˜ç½‘å»ºè®®4æ ¸çš„æœºå™¨å»ºè®®è®¾ç½®ä¸º2æˆ–3ä¸ªçº¿ç¨‹ï¼Œ8æ ¸çš„å»ºè®®è®¾ç½®ä¸º6ä¸ªçº¿ç¨‹
```

### Redis æ˜¯å¦‚ä½•åˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡æœŸçš„å‘¢ï¼Ÿ

æ¯å½“æˆ‘ä»¬å¯¹ä¸€ä¸ª key è®¾ç½®äº†è¿‡æœŸæ—¶é—´æ—¶ï¼ŒRedis  ä¼šæŠŠè¯¥ key å¸¦ä¸Šè¿‡æœŸæ—¶é—´å­˜å‚¨åˆ°ä¸€ä¸ª**è¿‡æœŸå­—å…¸**ï¼ˆexpires dictï¼‰ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ã€Œè¿‡æœŸå­—å…¸ã€ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰ key çš„è¿‡æœŸæ—¶é—´ã€‚

è¿‡æœŸå­—å…¸å­˜å‚¨åœ¨ redisDb ç»“æ„ä¸­ï¼Œå¦‚ä¸‹ï¼š

```c
typedef struct redisDb {
    dict *dict;    /* æ•°æ®åº“é”®ç©ºé—´ï¼Œå­˜æ”¾ç€æ‰€æœ‰çš„é”®å€¼å¯¹ */
    dict *expires; /* é”®çš„è¿‡æœŸæ—¶é—´ */
    ....
} redisDb;
```

è¿‡æœŸå­—å…¸æ•°æ®ç»“æ„ç»“æ„å¦‚ä¸‹ï¼š

- è¿‡æœŸå­—å…¸çš„ key æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸ªé”®å¯¹è±¡ï¼›
- è¿‡æœŸå­—å…¸çš„ value æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä¿å­˜äº† key çš„è¿‡æœŸæ—¶é—´ï¼›

è¿‡æœŸå­—å…¸çš„æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220714211943265](./images/image-20220714211943265.png)

å­—å…¸å®é™…ä¸Šæ˜¯å“ˆå¸Œè¡¨ï¼Œå“ˆå¸Œè¡¨çš„æœ€å¤§å¥½å¤„å°±æ˜¯è®©æˆ‘ä»¬å¯ä»¥ç”¨ O(1) çš„æ—¶é—´å¤æ‚åº¦æ¥å¿«é€ŸæŸ¥æ‰¾ã€‚å½“æˆ‘ä»¬æŸ¥è¯¢ä¸€ä¸ª key æ—¶ï¼ŒRedis é¦–å…ˆæ£€æŸ¥è¯¥ key æ˜¯å¦å­˜åœ¨äºè¿‡æœŸå­—å…¸ä¸­ï¼š

- å¦‚æœä¸åœ¨ï¼Œåˆ™æ­£å¸¸è¯»å–é”®å€¼ï¼›
- å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šè·å–è¯¥ key çš„è¿‡æœŸæ—¶é—´ï¼Œç„¶åä¸å½“å‰ç³»ç»Ÿæ—¶é—´è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæ¯”ç³»ç»Ÿæ—¶é—´å¤§ï¼Œé‚£å°±æ²¡æœ‰è¿‡æœŸï¼Œå¦åˆ™åˆ¤å®šè¯¥ key å·²è¿‡æœŸã€‚

è¿‡æœŸé”®åˆ¤æ–­æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220714211925160](./images/image-20220714211925160.png)

> æ‹“å±•ï¼šå¤§é‡ key é›†ä¸­è¿‡æœŸé—®é¢˜

å› ä¸ºå¯¼è‡´å®¢æˆ·ç«¯è¯·æ±‚æ²¡åŠæ³•è¢«åŠæ—¶å¤„ç†ï¼Œå“åº”é€Ÿåº¦ä¼šæ¯”è¾ƒæ…¢ã€‚

å¦‚ä½•è§£å†³å‘¢ï¼Ÿä¸‹é¢æ˜¯ä¸¤ç§å¸¸è§çš„æ–¹æ³•ï¼š

1. ç»™ key è®¾ç½®**éšæœºè¿‡æœŸæ—¶é—´**ã€‚
2. å¼€å¯ lazy-freeï¼ˆ**æƒ°æ€§åˆ é™¤**/å»¶è¿Ÿé‡Šæ”¾ï¼‰ ã€‚lazy-free ç‰¹æ€§æ˜¯ Redis 4.0 å¼€å§‹å¼•å…¥çš„ï¼ŒæŒ‡çš„æ˜¯è®© Redis é‡‡ç”¨å¼‚æ­¥æ–¹å¼å»¶è¿Ÿé‡Šæ”¾ key ä½¿ç”¨çš„å†…å­˜ï¼Œå°†è¯¥æ“ä½œäº¤ç»™å•ç‹¬çš„å­çº¿ç¨‹å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

ä¸ªäººå»ºè®®ä¸ç®¡æ˜¯å¦å¼€å¯ lazy-freeï¼Œæˆ‘ä»¬éƒ½å°½é‡ç»™ key è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´ã€‚

### è¿‡æœŸçš„æ•°æ®çš„åˆ é™¤ç­–ç•¥äº†è§£ä¹ˆï¼Ÿ

å¸¸ç”¨çš„è¿‡æœŸæ•°æ®çš„åˆ é™¤ç­–ç•¥å°±å‰ä¸¤ä¸ªï¼ˆé‡è¦ï¼è‡ªå·±é€ ç¼“å­˜è½®å­çš„æ—¶å€™éœ€è¦æ ¼å¤–è€ƒè™‘çš„ä¸œè¥¿ï¼‰ï¼š

> æƒ°æ€§åˆ é™¤

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„åšæ³•æ˜¯ï¼Œ**ä¸ä¸»åŠ¨åˆ é™¤è¿‡æœŸé”®ï¼Œæ¯æ¬¡ä»æ•°æ®åº“è®¿é—® key æ—¶ï¼Œéƒ½æ£€æµ‹ key æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤è¯¥ keyã€‚**

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„**ä¼˜ç‚¹**ï¼š

- å› ä¸ºæ¯æ¬¡è®¿é—®æ—¶ï¼Œæ‰ä¼šæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸï¼Œæ‰€ä»¥æ­¤ç­–ç•¥åªä¼šä½¿ç”¨å¾ˆå°‘çš„ç³»ç»Ÿèµ„æºï¼Œå› æ­¤ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹ CPU æ—¶é—´æœ€å‹å¥½ã€‚

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„**ç¼ºç‚¹**ï¼š

- å¦‚æœä¸€ä¸ª key å·²ç»è¿‡æœŸï¼Œè€Œè¿™ä¸ª key åˆä»ç„¶ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªè¿‡æœŸ key ä¸€ç›´æ²¡æœ‰è¢«è®¿é—®ï¼Œå®ƒæ‰€å ç”¨çš„å†…å­˜å°±ä¸ä¼šé‡Šæ”¾ï¼Œé€ æˆäº†ä¸€å®šçš„å†…å­˜ç©ºé—´æµªè´¹ã€‚æ‰€ä»¥ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹å†…å­˜ä¸å‹å¥½ã€‚

> å®šæœŸåˆ é™¤

å®šæœŸåˆ é™¤ç­–ç•¥çš„åšæ³•æ˜¯ï¼Œ**æ¯éš”ä¸€æ®µæ—¶é—´ã€Œéšæœºã€ä»æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„ key è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸkeyã€‚**

å®šæœŸåˆ é™¤ç­–ç•¥çš„**ä¼˜ç‚¹**ï¼š

- é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ï¼Œæ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU çš„å½±å“ï¼ŒåŒæ—¶ä¹Ÿèƒ½åˆ é™¤ä¸€éƒ¨åˆ†è¿‡æœŸçš„æ•°æ®å‡å°‘äº†è¿‡æœŸé”®å¯¹ç©ºé—´çš„æ— æ•ˆå ç”¨ã€‚

å®šæœŸåˆ é™¤ç­–ç•¥çš„**ç¼ºç‚¹**ï¼š

- å†…å­˜æ¸…ç†æ–¹é¢æ²¡æœ‰å®šæ—¶åˆ é™¤æ•ˆæœå¥½ï¼ŒåŒæ—¶æ²¡æœ‰æƒ°æ€§åˆ é™¤ä½¿ç”¨çš„ç³»ç»Ÿèµ„æºå°‘ã€‚
- éš¾ä»¥ç¡®å®šåˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ã€‚å¦‚æœæ‰§è¡Œçš„å¤ªé¢‘ç¹ï¼Œå®šæœŸåˆ é™¤ç­–ç•¥å˜å¾—å’Œå®šæ—¶åˆ é™¤ç­–ç•¥ä¸€æ ·ï¼Œå¯¹CPUä¸å‹å¥½ï¼›å¦‚æœæ‰§è¡Œçš„å¤ªå°‘ï¼Œé‚£åˆå’Œæƒ°æ€§åˆ é™¤ä¸€æ ·äº†ï¼Œè¿‡æœŸ key å ç”¨çš„å†…å­˜ä¸ä¼šåŠæ—¶å¾—åˆ°é‡Šæ”¾ã€‚

> å®šæ—¶åˆ é™¤

å®šæ—¶åˆ é™¤ç­–ç•¥çš„åšæ³•æ˜¯ï¼Œ**åœ¨è®¾ç½® key çš„è¿‡æœŸæ—¶é—´æ—¶ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªå®šæ—¶äº‹ä»¶ï¼Œå½“æ—¶é—´åˆ°è¾¾æ—¶ï¼Œç”±äº‹ä»¶å¤„ç†å™¨è‡ªåŠ¨æ‰§è¡Œ key çš„åˆ é™¤æ“ä½œã€‚**

å®šæ—¶åˆ é™¤ç­–ç•¥çš„**ä¼˜ç‚¹**ï¼š

- å¯ä»¥ä¿è¯è¿‡æœŸ key ä¼šè¢«å°½å¿«åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯å†…å­˜å¯ä»¥è¢«å°½å¿«åœ°é‡Šæ”¾ã€‚å› æ­¤ï¼Œå®šæ—¶åˆ é™¤å¯¹å†…å­˜æ˜¯æœ€å‹å¥½çš„ã€‚

å®šæ—¶åˆ é™¤ç­–ç•¥çš„**ç¼ºç‚¹**ï¼š

- åœ¨è¿‡æœŸ key æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œåˆ é™¤è¿‡æœŸ key å¯èƒ½ä¼šå ç”¨ç›¸å½“ä¸€éƒ¨åˆ† CPU æ—¶é—´ï¼Œåœ¨å†…å­˜ä¸ç´§å¼ ä½† CPU æ—¶é—´ç´§å¼ çš„æƒ…å†µä¸‹ï¼Œå°† CPU  æ—¶é—´ç”¨äºåˆ é™¤å’Œå½“å‰ä»»åŠ¡æ— å…³çš„è¿‡æœŸé”®ä¸Šï¼Œæ— ç–‘ä¼šå¯¹æœåŠ¡å™¨çš„å“åº”æ—¶é—´å’Œååé‡é€ æˆå½±å“ã€‚æ‰€ä»¥ï¼Œå®šæ—¶åˆ é™¤ç­–ç•¥å¯¹ CPU ä¸å‹å¥½ã€‚

#### Redis å†…å­˜æ»¡äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

åœ¨ Redis çš„è¿è¡Œå†…å­˜è¾¾åˆ°äº†æŸä¸ªé˜€å€¼ï¼Œå°±ä¼šè§¦å‘**å†…å­˜æ·˜æ±°æœºåˆ¶**ï¼Œè¿™ä¸ªé˜€å€¼å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„æœ€å¤§è¿è¡Œå†…å­˜ï¼Œæ­¤å€¼åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œé…ç½®é¡¹ä¸º maxmemoryã€‚

### Redis å†…å­˜æ·˜æ±°æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ

Redis å†…å­˜æ·˜æ±°ç­–ç•¥å…±æœ‰å…«ç§ï¼Œè¿™å…«ç§ç­–ç•¥å¤§ä½“åˆ†ä¸ºã€Œä¸è¿›è¡Œæ•°æ®æ·˜æ±°ã€å’Œã€Œè¿›è¡Œæ•°æ®æ·˜æ±°ã€ä¸¤ç±»ç­–ç•¥ã€‚

*1ã€ä¸è¿›è¡Œæ•°æ®æ·˜æ±°çš„ç­–ç•¥*

**noeviction**ï¼ˆRedis3.0ä¹‹åï¼Œé»˜è®¤çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼‰ ï¼šå®ƒè¡¨ç¤ºå½“è¿è¡Œå†…å­˜è¶…è¿‡æœ€å¤§è®¾ç½®å†…å­˜æ—¶ï¼Œä¸æ·˜æ±°ä»»ä½•æ•°æ®ï¼Œè€Œæ˜¯ä¸å†æä¾›æœåŠ¡ï¼Œç›´æ¥è¿”å›é”™è¯¯ã€‚

*2ã€è¿›è¡Œæ•°æ®æ·˜æ±°çš„ç­–ç•¥*

é’ˆå¯¹ã€Œè¿›è¡Œæ•°æ®æ·˜æ±°ã€è¿™ä¸€ç±»ç­–ç•¥ï¼Œåˆå¯ä»¥ç»†åˆ†ä¸ºã€Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®ä¸­è¿›è¡Œæ·˜æ±°ã€å’Œã€Œåœ¨æ‰€æœ‰æ•°æ®èŒƒå›´å†…è¿›è¡Œæ·˜æ±°ã€è¿™ä¸¤ç±»ç­–ç•¥ã€‚

åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®ä¸­è¿›è¡Œæ·˜æ±°ï¼š

- **volatile-random**ï¼šéšæœºæ·˜æ±°è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ä»»æ„é”®å€¼ï¼›
- **volatile-ttl**ï¼šä¼˜å…ˆæ·˜æ±°æ›´æ—©è¿‡æœŸçš„é”®å€¼ã€‚
- **volatile-lru**ï¼ˆRedis3.0 ä¹‹å‰ï¼Œé»˜è®¤çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼‰ï¼šæ·˜æ±°æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­ï¼Œæœ€ä¹…æœªä½¿ç”¨çš„é”®å€¼ï¼›
- **volatile-lfu**ï¼ˆRedis 4.0 åæ–°å¢çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼‰ï¼šæ·˜æ±°æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­ï¼Œæœ€å°‘ä½¿ç”¨çš„é”®å€¼ï¼›

åœ¨æ‰€æœ‰æ•°æ®èŒƒå›´å†…è¿›è¡Œæ·˜æ±°ï¼š

- **allkeys-random**ï¼šéšæœºæ·˜æ±°ä»»æ„é”®å€¼;
- **allkeys-lru**ï¼šæ·˜æ±°æ•´ä¸ªé”®å€¼ä¸­æœ€ä¹…æœªä½¿ç”¨çš„é”®å€¼ï¼›
- **allkeys-lfu**ï¼ˆRedis 4.0 åæ–°å¢çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼‰ï¼šæ·˜æ±°æ•´ä¸ªé”®å€¼ä¸­æœ€å°‘ä½¿ç”¨çš„é”®å€¼ã€‚

> LRU ç®—æ³•

**LRU** å…¨ç§°æ˜¯ Least Recently Used ç¿»è¯‘ä¸º**æœ€è¿‘æœ€å°‘ä½¿ç”¨**ï¼Œä¼šé€‰æ‹©æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®ã€‚

ä¼ ç»Ÿ LRU ç®—æ³•çš„å®ç°æ˜¯åŸºäºã€Œé“¾è¡¨ã€ç»“æ„ï¼Œé“¾è¡¨ä¸­çš„å…ƒç´ æŒ‰ç…§æ“ä½œé¡ºåºä»å‰å¾€åæ’åˆ—ï¼Œæœ€æ–°æ“ä½œçš„é”®ä¼šè¢«ç§»åŠ¨åˆ°è¡¨å¤´ï¼Œå½“éœ€è¦å†…å­˜æ·˜æ±°æ—¶ï¼Œåªéœ€è¦åˆ é™¤é“¾è¡¨å°¾éƒ¨çš„å…ƒç´ å³å¯ï¼Œå› ä¸ºé“¾è¡¨å°¾éƒ¨çš„å…ƒç´ å°±ä»£è¡¨æœ€ä¹…æœªè¢«ä½¿ç”¨çš„å…ƒç´ ã€‚

Redis å¹¶æ²¡æœ‰ä½¿ç”¨è¿™æ ·çš„æ–¹å¼å®ç° LRU ç®—æ³•ï¼Œå› ä¸ºä¼ ç»Ÿçš„ LRU ç®—æ³•å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

- éœ€è¦ç”¨é“¾è¡¨ç®¡ç†æ‰€æœ‰çš„ç¼“å­˜æ•°æ®ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„ç©ºé—´å¼€é”€ï¼›
- å½“æœ‰æ•°æ®è¢«è®¿é—®æ—¶ï¼Œéœ€è¦åœ¨é“¾è¡¨ä¸ŠæŠŠè¯¥æ•°æ®ç§»åŠ¨åˆ°å¤´ç«¯ï¼Œå¦‚æœæœ‰å¤§é‡æ•°æ®è¢«è®¿é—®ï¼Œå°±ä¼šå¸¦æ¥å¾ˆå¤šé“¾è¡¨ç§»åŠ¨æ“ä½œï¼Œä¼šå¾ˆè€—æ—¶ï¼Œè¿›è€Œä¼šé™ä½ Redis ç¼“å­˜æ€§èƒ½ã€‚

> Redis æ˜¯å¦‚ä½•å®ç° LRU ç®—æ³•çš„ï¼Ÿ

Redis å®ç°çš„æ˜¯ä¸€ç§**è¿‘ä¼¼ LRU ç®—æ³•**ï¼Œç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„èŠ‚çº¦å†…å­˜ï¼Œå®ƒçš„**å®ç°æ–¹å¼æ˜¯åœ¨ Redis çš„å¯¹è±¡ç»“æ„ä½“ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å­—æ®µï¼Œç”¨äºè®°å½•æ­¤æ•°æ®çš„æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´**ã€‚

å½“ Redis è¿›è¡Œå†…å­˜æ·˜æ±°æ—¶ï¼Œä¼šä½¿ç”¨**éšæœºé‡‡æ ·çš„æ–¹å¼æ¥æ·˜æ±°æ•°æ®**ï¼Œå®ƒæ˜¯éšæœºå– 5 ä¸ªå€¼ï¼ˆæ­¤å€¼å¯é…ç½®ï¼‰ï¼Œç„¶å**æ·˜æ±°æœ€ä¹…æ²¡æœ‰ä½¿ç”¨çš„é‚£ä¸ª**ã€‚

Redis å®ç°çš„ LRU ç®—æ³•çš„ä¼˜ç‚¹ï¼š

- ä¸ç”¨ä¸ºæ‰€æœ‰çš„æ•°æ®ç»´æŠ¤ä¸€ä¸ªå¤§é“¾è¡¨ï¼ŒèŠ‚çœäº†ç©ºé—´å ç”¨ï¼›
- ä¸ç”¨åœ¨æ¯æ¬¡æ•°æ®è®¿é—®æ—¶éƒ½ç§»åŠ¨é“¾è¡¨é¡¹ï¼Œæå‡äº†ç¼“å­˜çš„æ€§èƒ½ï¼›

ä½†æ˜¯ LRU ç®—æ³•æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ**æ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜**ï¼Œæ¯”å¦‚åº”ç”¨ä¸€æ¬¡è¯»å–äº†å¤§é‡çš„æ•°æ®ï¼Œè€Œè¿™äº›æ•°æ®åªä¼šè¢«è¯»å–è¿™ä¸€æ¬¡ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®ä¼šç•™å­˜åœ¨ Redis ç¼“å­˜ä¸­å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œé€ æˆç¼“å­˜æ±¡æŸ“ã€‚

å› æ­¤ï¼Œåœ¨ Redis 4.0 ä¹‹åå¼•å…¥äº† LFU ç®—æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

> ä»€ä¹ˆæ˜¯ LFU ç®—æ³•ï¼Ÿ

LFU å…¨ç§°æ˜¯ Least Frequently Used ç¿»è¯‘ä¸º**æœ€è¿‘æœ€ä¸å¸¸ç”¨çš„ï¼Œ**LFU ç®—æ³•æ˜¯æ ¹æ®æ•°æ®è®¿é—®æ¬¡æ•°æ¥æ·˜æ±°æ•°æ®çš„ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®è¿‡å»è¢«è®¿é—®å¤šæ¬¡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„é¢‘ç‡ä¹Ÿæ›´é«˜â€ã€‚

æ‰€ä»¥ï¼Œ LFU ç®—æ³•ä¼šè®°å½•æ¯ä¸ªæ•°æ®çš„è®¿é—®æ¬¡æ•°ã€‚å½“ä¸€ä¸ªæ•°æ®è¢«å†æ¬¡è®¿é—®æ—¶ï¼Œå°±ä¼šå¢åŠ è¯¥æ•°æ®çš„è®¿é—®æ¬¡æ•°ã€‚è¿™æ ·å°±è§£å†³äº†å¶å°”è¢«è®¿é—®ä¸€æ¬¡ä¹‹åï¼Œæ•°æ®ç•™å­˜åœ¨ç¼“å­˜ä¸­å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„é—®é¢˜ï¼Œç›¸æ¯”äº LRU ç®—æ³•ä¹Ÿæ›´åˆç†ä¸€äº›ã€‚

> Redis æ˜¯å¦‚ä½•å®ç° LFU ç®—æ³•çš„ï¼Ÿ

LFU ç®—æ³•ç›¸æ¯”äº  LRU ç®—æ³•çš„å®ç°ï¼Œå¤šè®°å½•äº†ã€Œæ•°æ®çš„è®¿é—®é¢‘æ¬¡ã€çš„ä¿¡æ¯ã€‚Redis å¯¹è±¡çš„ç»“æ„å¦‚ä¸‹ï¼š

```c
typedef struct redisObject {
    ...
    
    // 24 bitsï¼Œç”¨äºè®°å½•å¯¹è±¡çš„è®¿é—®ä¿¡æ¯
    unsigned lru:24;  
    ...
} robj;
```

Redis å¯¹è±¡å¤´ä¸­çš„ lru å­—æ®µï¼Œåœ¨ LRU ç®—æ³•ä¸‹å’Œ LFU ç®—æ³•ä¸‹ä½¿ç”¨æ–¹å¼å¹¶ä¸ç›¸åŒã€‚

**åœ¨ LRU ç®—æ³•ä¸­**ï¼ŒRedis å¯¹è±¡å¤´çš„ 24 bits çš„ lru å­—æ®µæ˜¯ç”¨æ¥è®°å½• key çš„è®¿é—®æ—¶é—´æˆ³ï¼Œå› æ­¤åœ¨ LRU æ¨¡å¼ä¸‹ï¼ŒRediså¯ä»¥æ ¹æ®å¯¹è±¡å¤´ä¸­çš„ lru å­—æ®µè®°å½•çš„å€¼ï¼Œæ¥æ¯”è¾ƒæœ€åä¸€æ¬¡ key çš„è®¿é—®æ—¶é—´é•¿ï¼Œä»è€Œæ·˜æ±°æœ€ä¹…æœªè¢«ä½¿ç”¨çš„ keyã€‚

**åœ¨ LFU ç®—æ³•ä¸­**ï¼ŒRediså¯¹è±¡å¤´çš„ 24 bits çš„ lru å­—æ®µè¢«åˆ†æˆä¸¤æ®µæ¥å­˜å‚¨ï¼Œé«˜ 16bit å­˜å‚¨ ldt(Last Decrement Time)ï¼Œä½ 8bit å­˜å‚¨ logc(Logistic Counter)ã€‚

![image-20220714211622755](./images/image-20220714211622755.png)

- ldt æ˜¯ç”¨æ¥è®°å½• key çš„è®¿é—®æ—¶é—´æˆ³ï¼›
- logc æ˜¯ç”¨æ¥è®°å½• key çš„è®¿é—®é¢‘æ¬¡ï¼Œå®ƒçš„å€¼è¶Šå°è¡¨ç¤ºä½¿ç”¨é¢‘ç‡è¶Šä½ï¼Œè¶Šå®¹æ˜“æ·˜æ±°ï¼Œæ¯ä¸ªæ–°åŠ å…¥çš„ key çš„logc åˆå§‹å€¼ä¸º 5ã€‚

æ³¨æ„ï¼Œlogc å¹¶ä¸æ˜¯å•çº¯çš„è®¿é—®æ¬¡æ•°ï¼Œè€Œæ˜¯è®¿é—®é¢‘æ¬¡ï¼ˆè®¿é—®é¢‘ç‡ï¼‰ï¼Œå› ä¸º **logc  ä¼šéšæ—¶é—´æ¨ç§»è€Œè¡°å‡çš„**ã€‚

åœ¨æ¯æ¬¡ key è¢«è®¿é—®æ—¶ï¼Œä¼šå…ˆå¯¹ logc åšä¸€ä¸ªè¡°å‡æ“ä½œï¼Œè¡°å‡çš„å€¼è·Ÿå‰åè®¿é—®æ—¶é—´çš„å·®è·æœ‰å…³ç³»ï¼Œå¦‚æœä¸Šä¸€æ¬¡è®¿é—®çš„æ—¶é—´ä¸è¿™ä¸€æ¬¡è®¿é—®çš„æ—¶é—´å·®è·å¾ˆå¤§ï¼Œé‚£ä¹ˆè¡°å‡çš„å€¼å°±è¶Šå¤§ï¼Œè¿™æ ·å®ç°çš„ LFU ç®—æ³•æ˜¯æ ¹æ®**è®¿é—®é¢‘ç‡**æ¥æ·˜æ±°æ•°æ®çš„ï¼Œè€Œä¸åªæ˜¯è®¿é—®æ¬¡æ•°ã€‚è®¿é—®é¢‘ç‡éœ€è¦è€ƒè™‘ key çš„è®¿é—®æ˜¯å¤šé•¿æ—¶é—´æ®µå†…å‘ç”Ÿçš„ã€‚key çš„å…ˆå‰è®¿é—®è·ç¦»å½“å‰æ—¶é—´è¶Šé•¿ï¼Œé‚£ä¹ˆè¿™ä¸ª key çš„è®¿é—®é¢‘ç‡ç›¸åº”åœ°ä¹Ÿå°±ä¼šé™ä½ï¼Œè¿™æ ·è¢«æ·˜æ±°çš„æ¦‚ç‡ä¹Ÿä¼šæ›´å¤§ã€‚

å¯¹ logc åšå®Œè¡°å‡æ“ä½œåï¼Œå°±å¼€å§‹å¯¹ logc  è¿›è¡Œå¢åŠ æ“ä½œï¼Œå¢åŠ æ“ä½œå¹¶ä¸æ˜¯å•çº¯çš„ + 1ï¼Œè€Œæ˜¯æ ¹æ®æ¦‚ç‡å¢åŠ ï¼Œå¦‚æœ logc è¶Šå¤§çš„ keyï¼Œå®ƒçš„ logc å°±è¶Šéš¾å†å¢åŠ ã€‚

æ‰€ä»¥ï¼ŒRedis åœ¨è®¿é—® key æ—¶ï¼Œå¯¹äº logc  æ˜¯è¿™æ ·å˜åŒ–çš„ï¼š

1. å…ˆæŒ‰ç…§ä¸Šæ¬¡è®¿é—®è·ç¦»å½“å‰çš„æ—¶é•¿ï¼Œæ¥å¯¹ logc è¿›è¡Œè¡°å‡ï¼›
2. ç„¶åï¼Œå†æŒ‰ç…§ä¸€å®šæ¦‚ç‡å¢åŠ  logc çš„å€¼

redis.conf æä¾›äº†ä¸¤ä¸ªé…ç½®é¡¹ï¼Œç”¨äºè°ƒæ•´ LFU ç®—æ³•ä»è€Œæ§åˆ¶ logc çš„å¢é•¿å’Œè¡°å‡ï¼š

- `lfu-decay-time` ç”¨äºè°ƒæ•´ logc çš„è¡°å‡é€Ÿåº¦ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»¥åˆ†é’Ÿä¸ºå•ä½çš„æ•°å€¼ï¼Œé»˜è®¤å€¼ä¸º1ï¼Œlfu-decay-time å€¼è¶Šå¤§ï¼Œè¡°å‡è¶Šæ…¢ï¼›
- `lfu-log-factor` ç”¨äºè°ƒæ•´ logc çš„å¢é•¿é€Ÿåº¦ï¼Œlfu-log-factor å€¼è¶Šå¤§ï¼Œlogc å¢é•¿è¶Šæ…¢ã€‚

### è·³è·ƒè¡¨

#### ç®€ä»‹

è·³è·ƒè¡¨ï¼ˆskiplistï¼‰æ˜¯ä¸€ç§éšæœºåŒ–çš„æ•°æ®ç»“æ„ï¼Œç”± **William Pugh** åœ¨è®ºæ–‡ã€ŠSkip lists: a probabilistic alternative to balanced treesã€‹ä¸­æå‡ºï¼Œæ˜¯ä¸€ç§å¯ä»¥ä¸å¹³è¡¡æ ‘åª²ç¾çš„å±‚æ¬¡åŒ–é“¾è¡¨ç»“æ„â€”â€”æŸ¥æ‰¾ã€åˆ é™¤ã€æ·»åŠ ç­‰æ“ä½œéƒ½å¯ä»¥åœ¨å¯¹æ•°æœŸæœ›æ—¶é—´ä¸‹å®Œæˆï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„è·³è·ƒè¡¨ä¾‹å­ï¼š

![image-20220715150511611](./images/image-20220715150511611.png)

æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡ä¸­æåˆ°äº† Redis çš„äº”ç§åŸºæœ¬ç»“æ„ä¸­ï¼Œæœ‰ä¸€ä¸ªå«åš **æœ‰åºåˆ—è¡¨ zset** çš„æ•°æ®ç»“æ„ï¼Œå®ƒç±»ä¼¼äº Java ä¸­çš„ **SortedSet** å’Œ **HashMap** çš„ç»“åˆä½“ï¼Œä¸€æ–¹é¢å®ƒæ˜¯ä¸€ä¸ª set ä¿è¯äº†å†…éƒ¨ value çš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢åˆå¯ä»¥ç»™æ¯ä¸ª value èµ‹äºˆä¸€ä¸ªæ’åºçš„æƒé‡å€¼ scoreï¼Œæ¥è¾¾åˆ° **æ’åº** çš„ç›®çš„ã€‚

å®ƒçš„å†…éƒ¨å®ç°å°±ä¾èµ–äº†ä¸€ç§å«åš **ã€Œè·³è·ƒåˆ—è¡¨ã€** çš„æ•°æ®ç»“æ„ã€‚

#### ä¸ºä»€ä¹ˆä½¿ç”¨è·³è·ƒè¡¨

é¦–å…ˆï¼Œå› ä¸º zset è¦æ”¯æŒéšæœºçš„æ’å…¥å’Œåˆ é™¤ï¼Œæ‰€ä»¥å®ƒ **ä¸å®œä½¿ç”¨æ•°ç»„æ¥å®ç°**ï¼Œå…³äºæ’åºé—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“å°±æƒ³åˆ° **çº¢é»‘æ ‘/ å¹³è¡¡æ ‘** è¿™æ ·çš„æ ‘å½¢ç»“æ„ï¼Œä¸ºä»€ä¹ˆ Redis ä¸ä½¿ç”¨è¿™æ ·ä¸€äº›ç»“æ„å‘¢ï¼Ÿ

1. **æ€§èƒ½è€ƒè™‘ï¼š** åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ ‘å½¢ç»“æ„éœ€è¦æ‰§è¡Œä¸€äº›ç±»ä¼¼äº rebalance è¿™æ ·çš„å¯èƒ½æ¶‰åŠæ•´æ£µæ ‘çš„æ“ä½œï¼Œç›¸å¯¹æ¥è¯´è·³è·ƒè¡¨çš„å˜åŒ–åªæ¶‰åŠå±€éƒ¨ *(ä¸‹é¢è¯¦ç»†è¯´)*ï¼›
2. **å®ç°è€ƒè™‘ï¼š** åœ¨å¤æ‚åº¦ä¸çº¢é»‘æ ‘ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè·³è·ƒè¡¨å®ç°èµ·æ¥æ›´ç®€å•ï¼Œçœ‹èµ·æ¥ä¹Ÿæ›´åŠ ç›´è§‚ï¼›

åŸºäºä»¥ä¸Šçš„ä¸€äº›è€ƒè™‘ï¼ŒRedis åŸºäº **William Pugh** çš„è®ºæ–‡åšå‡ºä¸€äº›æ”¹è¿›åé‡‡ç”¨äº† **è·³è·ƒè¡¨** è¿™æ ·çš„ç»“æ„ã€‚

#### æœ¬è´¨æ˜¯è§£å†³æŸ¥æ‰¾é—®é¢˜

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæ™®é€šçš„é“¾è¡¨ç»“æ„ï¼š

![image-20220715150536830](./images/image-20220715150536830.png)

æˆ‘ä»¬éœ€è¦è¿™ä¸ªé“¾è¡¨æŒ‰ç…§ score å€¼è¿›è¡Œæ’åºï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬éœ€è¦æ·»åŠ æ–°çš„å…ƒç´ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å®šä½åˆ°æ’å…¥ç‚¹ï¼Œè¿™æ ·æ‰å¯ä»¥ç»§ç»­ä¿è¯é“¾è¡¨æ˜¯æœ‰åºçš„ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ **äºŒåˆ†æŸ¥æ‰¾æ³•**ï¼Œä½†äºŒåˆ†æŸ¥æ‰¾æ˜¯æœ‰åºæ•°ç»„çš„ï¼Œé“¾è¡¨æ²¡åŠæ³•è¿›è¡Œä½ç½®å®šä½ï¼Œæˆ‘ä»¬é™¤äº†éå†æ•´ä¸ªæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”ç»™å®šæ•°æ®å¤§çš„èŠ‚ç‚¹ä¸ºæ­¢ *ï¼ˆæ—¶é—´å¤æ‚åº¦ O(n))* ä¼¼ä¹æ²¡æœ‰æ›´å¥½çš„åŠæ³•ã€‚

ä½†å‡å¦‚æˆ‘ä»¬æ¯ç›¸é‚»ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´å°±å¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼Œè®©æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20220715150547405](./images/image-20220715150547405.png)

è¿™æ ·æ‰€æœ‰æ–°å¢çš„æŒ‡é’ˆè¿æˆäº†ä¸€ä¸ªæ–°çš„é“¾è¡¨ï¼Œä½†å®ƒåŒ…å«çš„æ•°æ®å´åªæœ‰åŸæ¥çš„ä¸€åŠ *ï¼ˆå›¾ä¸­çš„ä¸º 3ï¼Œ11ï¼‰*ã€‚

ç°åœ¨å‡è®¾æˆ‘ä»¬æƒ³è¦æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œå¯ä»¥æ ¹æ®è¿™æ¡æ–°çš„é“¾è¡¨æŸ¥æ‰¾ï¼Œå¦‚æœç¢°åˆ°æ¯”å¾…æŸ¥æ‰¾æ•°æ®å¤§çš„èŠ‚ç‚¹æ—¶ï¼Œå†å›åˆ°åŸæ¥çš„é“¾è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³è¦æŸ¥æ‰¾ 7ï¼ŒæŸ¥æ‰¾çš„è·¯å¾„åˆ™æ˜¯æ²¿ç€ä¸‹å›¾ä¸­æ ‡æ³¨å‡ºçš„çº¢è‰²æŒ‡é’ˆæ‰€æŒ‡å‘çš„æ–¹å‘è¿›è¡Œçš„ï¼š

![image-20220715150600549](./images/image-20220715150600549.png)

è¿™æ˜¯ä¸€ä¸ªç•¥å¾®æç«¯çš„ä¾‹å­ï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æ–°å¢åŠ çš„æŒ‡é’ˆæŸ¥æ‰¾ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ä¸é“¾è¡¨ä¸Šçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹é€ä¸€è¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ ·æ”¹è¿›ä¹‹åéœ€è¦æ¯”è¾ƒçš„èŠ‚ç‚¹æ•°å¤§æ¦‚åªæœ‰åŸæ¥çš„ä¸€åŠã€‚

åˆ©ç”¨åŒæ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ–°äº§ç”Ÿçš„é“¾è¡¨ä¸Šï¼Œç»§ç»­ä¸ºæ¯ä¸¤ä¸ªç›¸é‚»çš„èŠ‚ç‚¹å¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼Œä»è€Œäº§ç”Ÿç¬¬ä¸‰å±‚é“¾è¡¨ï¼š

![image-20220715150622214](./images/image-20220715150622214.png)

åœ¨è¿™ä¸ªæ–°çš„ä¸‰å±‚é“¾è¡¨ç»“æ„ä¸­ï¼Œæˆ‘ä»¬è¯•ç€ **æŸ¥æ‰¾ 13**ï¼Œé‚£ä¹ˆæ²¿ç€æœ€ä¸Šå±‚é“¾è¡¨é¦–å…ˆæ¯”è¾ƒçš„æ˜¯ 11ï¼Œå‘ç° 11 æ¯” 13 å°ï¼Œäºæ˜¯æˆ‘ä»¬å°±çŸ¥é“åªéœ€è¦åˆ° 11 åé¢ç»§ç»­æŸ¥æ‰¾ï¼Œ**ä»è€Œä¸€ä¸‹å­è·³è¿‡äº† 11 å‰é¢çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚**

å¯ä»¥æƒ³è±¡ï¼Œå½“é“¾è¡¨è¶³å¤Ÿé•¿ï¼Œè¿™æ ·çš„å¤šå±‚é“¾è¡¨ç»“æ„å¯ä»¥å¸®åŠ©æˆ‘ä»¬è·³è¿‡å¾ˆå¤šä¸‹å±‚èŠ‚ç‚¹ï¼Œä»è€ŒåŠ å¿«æŸ¥æ‰¾çš„æ•ˆç‡ã€‚

#### æ›´è¿›ä¸€æ­¥çš„è·³è·ƒè¡¨

**è·³è·ƒè¡¨ skiplist** å°±æ˜¯å—åˆ°è¿™ç§å¤šå±‚é“¾è¡¨ç»“æ„çš„å¯å‘è€Œè®¾è®¡å‡ºæ¥çš„ã€‚æŒ‰ç…§ä¸Šé¢ç”Ÿæˆé“¾è¡¨çš„æ–¹å¼ï¼Œä¸Šé¢æ¯ä¸€å±‚é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œæ˜¯ä¸‹é¢ä¸€å±‚çš„èŠ‚ç‚¹ä¸ªæ•°çš„ä¸€åŠï¼Œè¿™æ ·æŸ¥æ‰¾è¿‡ç¨‹å°±éå¸¸ç±»ä¼¼äºä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾ï¼Œä½¿å¾—æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ° *O(logn)*ã€‚

ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™æœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚æ–°æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åï¼Œå°±ä¼šæ‰“ä¹±ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚é“¾è¡¨ä¸ŠèŠ‚ç‚¹ä¸ªæ•°ä¸¥æ ¼çš„ 2:1 çš„å¯¹åº”å…³ç³»ã€‚å¦‚æœè¦ç»´æŒè¿™ç§å¯¹åº”å…³ç³»ï¼Œå°±å¿…é¡»æŠŠæ–°æ’å…¥çš„èŠ‚ç‚¹åé¢çš„æ‰€æœ‰èŠ‚ç‚¹ *ï¼ˆä¹ŸåŒ…æ‹¬æ–°æ’å…¥çš„èŠ‚ç‚¹ï¼‰* é‡æ–°è¿›è¡Œè°ƒæ•´ï¼Œè¿™ä¼šè®©æ—¶é—´å¤æ‚åº¦é‡æ–°èœ•åŒ–æˆ *O(n)*ã€‚åˆ é™¤æ•°æ®ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ã€‚

**skiplist** ä¸ºäº†é¿å…è¿™ä¸€é—®é¢˜ï¼Œå®ƒä¸è¦æ±‚ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚é“¾è¡¨ä¹‹é—´çš„èŠ‚ç‚¹ä¸ªæ•°æœ‰ä¸¥æ ¼çš„å¯¹åº”å…³ç³»ï¼Œè€Œæ˜¯ **ä¸ºæ¯ä¸ªèŠ‚ç‚¹éšæœºå‡ºä¸€ä¸ªå±‚æ•°(level)**ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªèŠ‚ç‚¹éšæœºå‡ºçš„å±‚æ•°æ˜¯ 3ï¼Œé‚£ä¹ˆå°±æŠŠå®ƒé“¾å…¥åˆ°ç¬¬ 1 å±‚åˆ°ç¬¬ 3 å±‚è¿™ä¸‰å±‚é“¾è¡¨ä¸­ã€‚ä¸ºäº†è¡¨è¾¾æ¸…æ¥šï¼Œä¸‹å›¾å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ä¸€æ­¥æ­¥çš„æ’å…¥æ“ä½œä»è€Œå½¢æˆä¸€ä¸ª skiplist çš„è¿‡ç¨‹ï¼š

![image-20220715150657023](./images/image-20220715150657023.png)

ä»ä¸Šé¢çš„åˆ›å»ºå’Œæ’å…¥çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å±‚æ•°ï¼ˆlevelï¼‰æ˜¯éšæœºå‡ºæ¥çš„ï¼Œè€Œä¸”æ–°æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹å¹¶ä¸ä¼šå½±å“åˆ°å…¶ä»–èŠ‚ç‚¹çš„å±‚æ•°ï¼Œå› æ­¤ï¼Œ**æ’å…¥æ“ä½œåªéœ€è¦ä¿®æ”¹èŠ‚ç‚¹å‰åçš„æŒ‡é’ˆï¼Œè€Œä¸éœ€è¦å¯¹å¤šä¸ªèŠ‚ç‚¹éƒ½è¿›è¡Œè°ƒæ•´**ï¼Œè¿™å°±é™ä½äº†æ’å…¥æ“ä½œçš„å¤æ‚åº¦ã€‚

ç°åœ¨æˆ‘ä»¬å‡è®¾ä»æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„è¿™ä¸ªç»“æ„ä¸­æŸ¥æ‰¾ 23 è¿™ä¸ªä¸å­˜åœ¨çš„æ•°ï¼Œé‚£ä¹ˆæŸ¥æ‰¾è·¯å¾„ä¼šå¦‚ä¸‹å›¾ï¼š

![image-20220715150710832](./images/image-20220715150710832.png)

#### è·³è·ƒè¡¨çš„å®ç°

Redis ä¸­çš„è·³è·ƒè¡¨ç”± `server.h/zskiplistNode` å’Œ `server.h/zskiplist` ä¸¤ä¸ªç»“æ„å®šä¹‰ï¼Œå‰è€…ä¸ºè·³è·ƒè¡¨èŠ‚ç‚¹ï¼Œåè€…åˆ™ä¿å­˜äº†è·³è·ƒèŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒä¹‹å‰çš„ `é›†åˆ list` ç»“æ„ç±»ä¼¼ï¼Œå…¶å®åªæœ‰ `zskiplistNode` å°±å¯ä»¥å®ç°äº†ï¼Œä½†æ˜¯å¼•å…¥åè€…æ˜¯ä¸ºäº†æ›´åŠ æ–¹ä¾¿çš„æ“ä½œï¼š

```c
/* ZSETs use a specialized version of Skiplists */
typedef struct zskiplistNode {
    // value
    sds ele;
    // åˆ†å€¼
    double score;
    // åé€€æŒ‡é’ˆ
    struct zskiplistNode *backward;
    // å±‚
    struct zskiplistLevel {
        // å‰è¿›æŒ‡é’ˆ
        struct zskiplistNode *forward;
        // è·¨åº¦
        unsigned long span;
    } level[];
} zskiplistNode;

typedef struct zskiplist {
    // è·³è·ƒè¡¨å¤´æŒ‡é’ˆ
    struct zskiplistNode *header, *tail;
    // è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡
    unsigned long length;
    // è¡¨ä¸­å±‚æ•°æœ€å¤§çš„èŠ‚ç‚¹çš„å±‚æ•°
    int level;
} zskiplist;
```

æ­£å¦‚æ–‡ç« å¼€å¤´ç”»å‡ºæ¥çš„é‚£å¼ æ ‡å‡†çš„è·³è·ƒè¡¨é‚£æ ·ã€‚

##### éšæœºå±‚æ•°

å¯¹äºæ¯ä¸€ä¸ªæ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œéƒ½éœ€è¦è°ƒç”¨ä¸€ä¸ªéšæœºç®—æ³•ç»™å®ƒåˆ†é…ä¸€ä¸ªåˆç†çš„å±‚æ•°ï¼Œæºç åœ¨ `t_zset.c/zslRandomLevel(void)` ä¸­è¢«å®šä¹‰ï¼š

```c
int zslRandomLevel(void) {
    int level = 1;
    while ((random()&0xFFFF) < (ZSKIPLIST_P * 0xFFFF))
        level += 1;
    return (level<ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;
}
```

ç›´è§‚ä¸ŠæœŸæœ›çš„ç›®æ ‡æ˜¯ 50% çš„æ¦‚ç‡è¢«åˆ†é…åˆ° `Level 1`ï¼Œ25% çš„æ¦‚ç‡è¢«åˆ†é…åˆ° `Level 2`ï¼Œ12.5% çš„æ¦‚ç‡è¢«åˆ†é…åˆ° `Level 3`ï¼Œä»¥æ­¤ç±»æ¨...æœ‰ 2-63 çš„æ¦‚ç‡è¢«åˆ†é…åˆ°æœ€é¡¶å±‚ï¼Œå› ä¸ºè¿™é‡Œæ¯ä¸€å±‚çš„æ™‹å‡ç‡éƒ½æ˜¯ 50%ã€‚

**Redis è·³è·ƒè¡¨é»˜è®¤å…è®¸æœ€å¤§çš„å±‚æ•°æ˜¯ 32**ï¼Œè¢«æºç ä¸­ `ZSKIPLIST_MAXLEVEL` å®šä¹‰ï¼Œå½“ `Level[0]` æœ‰ 264 ä¸ªå…ƒç´ æ—¶ï¼Œæ‰èƒ½è¾¾åˆ° 32 å±‚ï¼Œæ‰€ä»¥å®šä¹‰ 32 å®Œå…¨å¤Ÿç”¨äº†ã€‚

##### åˆ›å»ºè·³è·ƒè¡¨

è¿™ä¸ªè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œåœ¨æºç ä¸­çš„ `t_zset.c/zslCreate` ä¸­è¢«å®šä¹‰ï¼š

```c
zskiplist *zslCreate(void) {
    int j;
    zskiplist *zsl;

    // ç”³è¯·å†…å­˜ç©ºé—´
    zsl = zmalloc(sizeof(*zsl));
    // åˆå§‹åŒ–å±‚æ•°ä¸º 1
    zsl->level = 1;
    // åˆå§‹åŒ–é•¿åº¦ä¸º 0
    zsl->length = 0;
    // åˆ›å»ºä¸€ä¸ªå±‚æ•°ä¸º 32ï¼Œåˆ†æ•°ä¸º 0ï¼Œæ²¡æœ‰ value å€¼çš„è·³è·ƒè¡¨å¤´èŠ‚ç‚¹
    zsl->header = zslCreateNode(ZSKIPLIST_MAXLEVEL,0,NULL);
  
    // è·³è·ƒè¡¨å¤´èŠ‚ç‚¹åˆå§‹åŒ–
    for (j = 0; j < ZSKIPLIST_MAXLEVEL; j++) {
        // å°†è·³è·ƒè¡¨å¤´èŠ‚ç‚¹çš„æ‰€æœ‰å‰è¿›æŒ‡é’ˆ forward è®¾ç½®ä¸º NULL
        zsl->header->level[j].forward = NULL;
        // å°†è·³è·ƒè¡¨å¤´èŠ‚ç‚¹çš„æ‰€æœ‰è·¨åº¦ span è®¾ç½®ä¸º 0
        zsl->header->level[j].span = 0;
    }
    // è·³è·ƒè¡¨å¤´èŠ‚ç‚¹çš„åé€€æŒ‡é’ˆ backward ç½®ä¸º NULL
    zsl->header->backward = NULL;
    // è¡¨å¤´æŒ‡å‘è·³è·ƒè¡¨å°¾èŠ‚ç‚¹çš„æŒ‡é’ˆç½®ä¸º NULL
    zsl->tail = NULL;
    return zsl;
}
```

å³æ‰§è¡Œå®Œä¹‹ååˆ›å»ºäº†å¦‚ä¸‹ç»“æ„çš„åˆå§‹åŒ–è·³è·ƒè¡¨ï¼š

![image-20220715150812789](./images/image-20220715150812789.png)

##### æ’å…¥èŠ‚ç‚¹å®ç°

è¿™å‡ ä¹æ˜¯æœ€é‡è¦çš„ä¸€æ®µä»£ç äº†ï¼Œä½†æ€»ä½“æ€è·¯ä¹Ÿæ¯”è¾ƒæ¸…æ™°ç®€å•ï¼Œå¦‚æœç†è§£äº†ä¸Šé¢æ‰€è¯´çš„è·³è·ƒè¡¨çš„åŸç†ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“ç†æ¸…æ¥šæ’å…¥èŠ‚ç‚¹æ—¶å‘ç”Ÿçš„å‡ ä¸ªåŠ¨ä½œ *ï¼ˆå‡ ä¹è·Ÿé“¾è¡¨ç±»ä¼¼ï¼‰*ï¼š

1. æ‰¾åˆ°å½“å‰æˆ‘éœ€è¦æ’å…¥çš„ä½ç½® *ï¼ˆå…¶ä¸­åŒ…æ‹¬ç›¸åŒ score æ—¶çš„å¤„ç†ï¼‰*ï¼›
2. åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œè°ƒæ•´å‰åçš„æŒ‡é’ˆæŒ‡å‘ï¼Œå®Œæˆæ’å…¥ï¼›

ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘æŠŠæºç  `t_zset.c/zslInsert` å®šä¹‰çš„æ’å…¥å‡½æ•°æ‹†æˆäº†å‡ ä¸ªéƒ¨åˆ†

###### ç¬¬ä¸€éƒ¨åˆ†ï¼šå£°æ˜éœ€è¦å­˜å‚¨çš„å˜é‡

```c
// å­˜å‚¨æœç´¢è·¯å¾„
zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
// å­˜å‚¨ç»è¿‡çš„èŠ‚ç‚¹è·¨åº¦
unsigned int rank[ZSKIPLIST_MAXLEVEL];
int i, level;
```

###### ç¬¬äºŒéƒ¨åˆ†ï¼šæœç´¢å½“å‰èŠ‚ç‚¹æ’å…¥ä½ç½®

```c
serverAssert(!isnan(score));
x = zsl->header;
// é€æ­¥é™çº§å¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹ï¼Œå¾—åˆ° "æœç´¢è·¯å¾„"
for (i = zsl->level-1; i >= 0; i--) {
    /* store rank that is crossed to reach the insert position */
    rank[i] = i == (zsl->level-1) ? 0 : rank[i+1];
    // å¦‚æœ score ç›¸ç­‰ï¼Œè¿˜éœ€è¦æ¯”è¾ƒ value å€¼
    while (x->level[i].forward &&
            (x->level[i].forward->score < score ||
                (x->level[i].forward->score == score &&
                sdscmp(x->level[i].forward->ele,ele) < 0)))
    {
        rank[i] += x->level[i].span;
        x = x->level[i].forward;
    }
    // è®°å½• "æœç´¢è·¯å¾„"
    update[i] = x;
}
```

**è®¨è®ºï¼š** æœ‰ä¸€ç§æç«¯çš„æƒ…å†µï¼Œå°±æ˜¯è·³è·ƒè¡¨ä¸­çš„æ‰€æœ‰ score å€¼éƒ½æ˜¯ä¸€æ ·ï¼Œzset çš„æŸ¥æ‰¾æ€§èƒ½ä¼šä¸ä¼šé€€åŒ–ä¸º O(n) å‘¢ï¼Ÿ

ä»ä¸Šé¢çš„æºç ä¸­æˆ‘ä»¬å¯ä»¥å‘ç° zset çš„æ’åºå…ƒç´ ä¸åªæ˜¯çœ‹ score å€¼ï¼Œä¹Ÿä¼šæ¯”è¾ƒ value å€¼ *ï¼ˆå­—ç¬¦ä¸²æ¯”è¾ƒï¼‰*

###### ç¬¬ä¸‰éƒ¨åˆ†ï¼šç”Ÿæˆæ’å…¥èŠ‚ç‚¹

```c
/* we assume the element is not already inside, since we allow duplicated
 * scores, reinserting the same element should never happen since the
 * caller of zslInsert() should test in the hash table if the element is
 * already inside or not. */
level = zslRandomLevel();
// å¦‚æœéšæœºç”Ÿæˆçš„ level è¶…è¿‡äº†å½“å‰æœ€å¤§ level éœ€è¦æ›´æ–°è·³è·ƒè¡¨çš„ä¿¡æ¯
if (level > zsl->level) {
    for (i = zsl->level; i < level; i++) {
        rank[i] = 0;
        update[i] = zsl->header;
        update[i]->level[i].span = zsl->length;
    }
    zsl->level = level;
}
// åˆ›å»ºæ–°èŠ‚ç‚¹
x = zslCreateNode(level,score,ele);
```

###### ç¬¬å››éƒ¨åˆ†ï¼šé‡æ’å‰å‘æŒ‡é’ˆ

```c
for (i = 0; i < level; i++) {
    x->level[i].forward = update[i]->level[i].forward;
    update[i]->level[i].forward = x;

    /* update span covered by update[i] as x is inserted here */
    x->level[i].span = update[i]->level[i].span - (rank[0] - rank[i]);
    update[i]->level[i].span = (rank[0] - rank[i]) + 1;
}

/* increment span for untouched levels */
for (i = level; i < zsl->level; i++) {
    update[i]->level[i].span++;
}
```

###### ç¬¬äº”éƒ¨åˆ†ï¼šé‡æ’åå‘æŒ‡é’ˆå¹¶è¿”å›

```c
x->backward = (update[0] == zsl->header) ? NULL : update[0];
if (x->level[0].forward)
    x->level[0].forward->backward = x;
else
    zsl->tail = x;
zsl->length++;
return x;
```

##### èŠ‚ç‚¹åˆ é™¤å®ç°

åˆ é™¤è¿‡ç¨‹ç”±æºç ä¸­çš„ `t_zset.c/zslDeleteNode` å®šä¹‰ï¼Œå’Œæ’å…¥è¿‡ç¨‹ç±»ä¼¼ï¼Œéƒ½éœ€è¦å…ˆæŠŠè¿™ä¸ª **"æœç´¢è·¯å¾„"** æ‰¾å‡ºæ¥ï¼Œç„¶åå¯¹äºæ¯ä¸ªå±‚çš„ç›¸å…³èŠ‚ç‚¹é‡æ’ä¸€ä¸‹å‰å‘åå‘æŒ‡é’ˆï¼ŒåŒæ—¶è¿˜è¦æ³¨æ„æ›´æ–°ä¸€ä¸‹æœ€é«˜å±‚æ•° `maxLevel`ï¼Œç›´æ¥æ”¾æºç  *(å¦‚æœç†è§£äº†æ’å…¥è¿™é‡Œè¿˜æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„)*ï¼š

```c
/* Internal function used by zslDelete, zslDeleteByScore and zslDeleteByRank */
void zslDeleteNode(zskiplist *zsl, zskiplistNode *x, zskiplistNode **update) {
    int i;
    for (i = 0; i < zsl->level; i++) {
        if (update[i]->level[i].forward == x) {
            update[i]->level[i].span += x->level[i].span - 1;
            update[i]->level[i].forward = x->level[i].forward;
        } else {
            update[i]->level[i].span -= 1;
        }
    }
    if (x->level[0].forward) {
        x->level[0].forward->backward = x->backward;
    } else {
        zsl->tail = x->backward;
    }
    while(zsl->level > 1 && zsl->header->level[zsl->level-1].forward == NULL)
        zsl->level--;
    zsl->length--;
}

/* Delete an element with matching score/element from the skiplist.
 * The function returns 1 if the node was found and deleted, otherwise
 * 0 is returned.
 *
 * If 'node' is NULL the deleted node is freed by zslFreeNode(), otherwise
 * it is not freed (but just unlinked) and *node is set to the node pointer,
 * so that it is possible for the caller to reuse the node (including the
 * referenced SDS string at node->ele). */
int zslDelete(zskiplist *zsl, double score, sds ele, zskiplistNode **node) {
    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
    int i;

    x = zsl->header;
    for (i = zsl->level-1; i >= 0; i--) {
        while (x->level[i].forward &&
                (x->level[i].forward->score < score ||
                    (x->level[i].forward->score == score &&
                     sdscmp(x->level[i].forward->ele,ele) < 0)))
        {
            x = x->level[i].forward;
        }
        update[i] = x;
    }
    /* We may have multiple elements with the same score, what we need
     * is to find the element with both the right score and object. */
    x = x->level[0].forward;
    if (x && score == x->score && sdscmp(x->ele,ele) == 0) {
        zslDeleteNode(zsl, x, update);
        if (!node)
            zslFreeNode(x);
        else
            *node = x;
        return 1;
    }
    return 0; /* not found */
}
```

##### èŠ‚ç‚¹æ›´æ–°å®ç°

å½“æˆ‘ä»¬è°ƒç”¨ `ZADD` æ–¹æ³•æ—¶ï¼Œå¦‚æœå¯¹åº”çš„ value ä¸å­˜åœ¨ï¼Œé‚£å°±æ˜¯æ’å…¥è¿‡ç¨‹ï¼Œå¦‚æœè¿™ä¸ª value å·²ç»å­˜åœ¨ï¼Œåªæ˜¯è°ƒæ•´ä¸€ä¸‹ score çš„å€¼ï¼Œé‚£å°±éœ€è¦èµ°ä¸€ä¸ªæ›´æ–°æµç¨‹ã€‚

å‡è®¾è¿™ä¸ªæ–°çš„ score å€¼å¹¶ä¸ä¼šå¸¦æ¥æ’åºä¸Šçš„å˜åŒ–ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è°ƒæ•´ä½ç½®ï¼Œç›´æ¥ä¿®æ”¹å…ƒç´ çš„ score å€¼å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¦‚æœæ’åºä½ç½®æ”¹å˜äº†ï¼Œé‚£å°±éœ€è¦è°ƒæ•´ä½ç½®ï¼Œè¯¥å¦‚ä½•è°ƒæ•´å‘¢ï¼Ÿ

ä»æºç  `t_zset.c/zsetAdd` å‡½æ•° `1350` è¡Œå·¦å³å¯ä»¥çœ‹åˆ°ï¼ŒRedis é‡‡ç”¨äº†ä¸€ä¸ªéå¸¸ç®€å•çš„ç­–ç•¥ï¼š

```c
/* Remove and re-insert when score changed. */
if (score != curscore) {
    zobj->ptr = zzlDelete(zobj->ptr,eptr);
    zobj->ptr = zzlInsert(zobj->ptr,ele,score);
    *flags |= ZADD_UPDATED;
}
```

**æŠŠè¿™ä¸ªå…ƒç´ åˆ é™¤å†æ’å…¥è¿™ä¸ª**ï¼Œéœ€è¦ç»è¿‡ä¸¤æ¬¡è·¯å¾„æœç´¢ï¼Œä»è¿™ä¸€ç‚¹ä¸Šæ¥çœ‹ï¼ŒRedis çš„ `ZADD` ä»£ç ä¼¼ä¹è¿˜æœ‰è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç©ºé—´ã€‚

##### å…ƒç´ æ’åçš„å®ç°

è·³è·ƒè¡¨æœ¬èº«æ˜¯æœ‰åºçš„ï¼ŒRedis åœ¨ skiplist çš„ forward æŒ‡é’ˆä¸Šè¿›è¡Œäº†ä¼˜åŒ–ï¼Œç»™æ¯ä¸€ä¸ª forward æŒ‡é’ˆéƒ½å¢åŠ äº† `span` å±æ€§ï¼Œç”¨æ¥ **è¡¨ç¤ºä»å‰ä¸€ä¸ªèŠ‚ç‚¹æ²¿ç€å½“å‰å±‚çš„ forward æŒ‡é’ˆè·³åˆ°å½“å‰è¿™ä¸ªèŠ‚ç‚¹ä¸­é—´ä¼šè·³è¿‡å¤šå°‘ä¸ªèŠ‚ç‚¹**ã€‚åœ¨ä¸Šé¢çš„æºç ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ° Redis åœ¨æ’å…¥ã€åˆ é™¤æ“ä½œæ—¶éƒ½ä¼šå°å¿ƒç¿¼ç¿¼åœ°æ›´æ–° `span` å€¼çš„å¤§å°ã€‚

æ‰€ä»¥ï¼Œæ²¿ç€ **"æœç´¢è·¯å¾„"**ï¼ŒæŠŠæ‰€æœ‰ç»è¿‡èŠ‚ç‚¹çš„è·¨åº¦ `span` å€¼è¿›è¡Œç´¯åŠ å°±å¯ä»¥ç®—å‡ºå½“å‰å…ƒç´ çš„æœ€ç»ˆ rank å€¼äº†ï¼š

```c
/* Find the rank for an element by both score and key.
 * Returns 0 when the element cannot be found, rank otherwise.
 * Note that the rank is 1-based due to the span of zsl->header to the
 * first element. */
unsigned long zslGetRank(zskiplist *zsl, double score, sds ele) {
    zskiplistNode *x;
    unsigned long rank = 0;
    int i;

    x = zsl->header;
    for (i = zsl->level-1; i >= 0; i--) {
        while (x->level[i].forward &&
            (x->level[i].forward->score < score ||
                (x->level[i].forward->score == score &&
                sdscmp(x->level[i].forward->ele,ele) <= 0))) {
            // span ç´¯åŠ 
            rank += x->level[i].span;
            x = x->level[i].forward;
        }

        /* x might be equal to zsl->header, so test if obj is non-NULL */
        if (x->ele && sdscmp(x->ele,ele) == 0) {
            return rank;
        }
    }
    return 0;
}
```

### â­æ€ä¹ˆä¿è¯ Redis æŒ‚æ‰ä¹‹åå†é‡å¯æ•°æ®å¯ä»¥è¿›è¡Œæ¢å¤ï¼Ÿï¼ˆæŒä¹…åŒ–ç­–ç•¥ï¼‰

> æ¦‚è¿°ï¼š
>
> RDBæŒä¹…åŒ–æ˜¯æŠŠå½“å‰è¿›ç¨‹æ•°æ®ç”Ÿæˆå¿«ç…§ä¿å­˜åˆ°ç£ç›˜ä¸Šçš„è¿‡ç¨‹; é’ˆå¯¹RDBä¸é€‚åˆå®æ—¶æŒä¹…åŒ–çš„é—®é¢˜ï¼ŒRedisæä¾›äº†AOFæŒä¹…åŒ–æ–¹å¼æ¥è§£å†³.
>
> AOFæ˜¯â€œå†™åâ€æ—¥å¿—ï¼ŒRediså…ˆæ‰§è¡Œå‘½ä»¤ï¼ŒæŠŠæ•°æ®å†™å…¥å†…å­˜ï¼Œç„¶åæ‰è®°å½•æ—¥å¿—ã€‚æ—¥å¿—é‡Œè®°å½•çš„æ˜¯Redisæ”¶åˆ°çš„æ¯ä¸€æ¡å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤æ˜¯ä»¥æ–‡æœ¬å½¢å¼ä¿å­˜ã€‚
>
> Redis 4.0 ä¸­æå‡ºäº†ä¸€ä¸ª**æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§**çš„æ–¹æ³•ã€‚ç®€å•æ¥è¯´ï¼Œå†…å­˜å¿«ç…§ä»¥ä¸€å®šçš„é¢‘ç‡æ‰§è¡Œï¼Œåœ¨ä¸¤æ¬¡å¿«ç…§ä¹‹é—´ï¼Œä½¿ç”¨ AOF æ—¥å¿—è®°å½•è¿™æœŸé—´çš„æ‰€æœ‰å‘½ä»¤æ“ä½œ

å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦æŒä¹…åŒ–æ•°æ®ä¹Ÿå°±æ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œå¤§éƒ¨åˆ†åŸå› æ˜¯ä¸ºäº†ä¹‹åé‡ç”¨æ•°æ®ï¼ˆæ¯”å¦‚é‡å¯æœºå™¨ã€æœºå™¨æ•…éšœä¹‹åæ¢å¤æ•°æ®ï¼‰ï¼Œæˆ–è€…æ˜¯ä¸ºäº†é˜²æ­¢ç³»ç»Ÿæ•…éšœè€Œå°†æ•°æ®å¤‡ä»½åˆ°ä¸€ä¸ªè¿œç¨‹ä½ç½®ã€‚

Redis ä¸åŒäº Memcached çš„å¾ˆé‡è¦ä¸€ç‚¹å°±æ˜¯ï¼ŒRedis æ”¯æŒæŒä¹…åŒ–ï¼Œè€Œä¸”æ”¯æŒä¸¤ç§ä¸åŒçš„æŒä¹…åŒ–æ“ä½œã€‚**Redis çš„ä¸€ç§æŒä¹…åŒ–æ–¹å¼å«å¿«ç…§ï¼ˆsnapshottingï¼ŒRDBï¼‰ï¼Œå¦ä¸€ç§æ–¹å¼æ˜¯åªè¿½åŠ æ–‡ä»¶ï¼ˆappend-only file, AOFï¼‰**ã€‚

#### ä»€ä¹ˆæ˜¯ RDB æŒä¹…åŒ–ï¼Ÿ

Redis å¯ä»¥é€šè¿‡åˆ›å»ºå¿«ç…§æ¥è·å¾—å­˜å‚¨åœ¨å†…å­˜é‡Œé¢çš„æ•°æ®åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„å‰¯æœ¬ã€‚Redis  åˆ›å»ºå¿«ç…§ä¹‹åï¼Œå¯ä»¥å¯¹å¿«ç…§è¿›è¡Œå¤‡ä»½ï¼Œå¯ä»¥å°†å¿«ç…§å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä»è€Œåˆ›å»ºå…·æœ‰ç›¸åŒæ•°æ®çš„æœåŠ¡å™¨å‰¯æœ¬ï¼ˆRedis ä¸»ä»ç»“æ„ï¼Œä¸»è¦ç”¨æ¥æé«˜ Redis  æ€§èƒ½ï¼‰ï¼Œè¿˜å¯ä»¥å°†å¿«ç…§ç•™åœ¨åŸåœ°ä»¥ä¾¿é‡å¯æœåŠ¡å™¨çš„æ—¶å€™ä½¿ç”¨ã€‚

å¿«ç…§æŒä¹…åŒ–æ˜¯ Redis é»˜è®¤é‡‡ç”¨çš„æŒä¹…åŒ–æ–¹å¼ï¼Œåœ¨ `redis.conf` é…ç½®æ–‡ä»¶ä¸­é»˜è®¤æœ‰æ­¤ä¸‹é…ç½®ï¼š

```shell
save 900 1           #åœ¨900ç§’(15åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘BGSAVEå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚

save 300 10          #åœ¨300ç§’(5åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘BGSAVEå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚

save 60 10000        #åœ¨60ç§’(1åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10000ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼ŒRediså°±ä¼šè‡ªåŠ¨è§¦å‘BGSAVEå‘½ä»¤åˆ›å»ºå¿«ç…§ã€‚
```

#### ä»€ä¹ˆæ˜¯ AOF æŒä¹…åŒ–ï¼Ÿ

ä¸å¿«ç…§æŒä¹…åŒ–ç›¸æ¯”ï¼ŒAOF æŒä¹…åŒ–çš„å®æ—¶æ€§æ›´å¥½ï¼Œå› æ­¤å·²æˆä¸ºä¸»æµçš„æŒä¹…åŒ–æ–¹æ¡ˆã€‚é»˜è®¤æƒ…å†µä¸‹ Redis æ²¡æœ‰å¼€å¯ AOFï¼ˆappend only fileï¼‰æ–¹å¼çš„æŒä¹…åŒ–ï¼Œå¯ä»¥é€šè¿‡ appendonly å‚æ•°å¼€å¯ï¼š

```conf
appendonly yes
```

å¼€å¯ AOF æŒä¹…åŒ–åæ¯æ‰§è¡Œä¸€æ¡ä¼šæ›´æ”¹ Redis ä¸­çš„æ•°æ®çš„å‘½ä»¤ï¼ŒRedis å°±ä¼šå°†è¯¥å‘½ä»¤å†™å…¥åˆ°å†…å­˜ç¼“å­˜ `server.aof_buf` ä¸­ï¼Œç„¶åå†æ ¹æ® `appendfsync` é…ç½®æ¥å†³å®šä½•æ—¶å°†å…¶åŒæ­¥åˆ°ç¡¬ç›˜ä¸­çš„ AOF æ–‡ä»¶ã€‚

AOF æ–‡ä»¶çš„ä¿å­˜ä½ç½®å’Œ RDB æ–‡ä»¶çš„ä½ç½®ç›¸åŒï¼Œéƒ½æ˜¯é€šè¿‡ dir å‚æ•°è®¾ç½®çš„ï¼Œé»˜è®¤çš„æ–‡ä»¶åæ˜¯ `appendonly.aof`ã€‚

åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨ä¸‰ç§ä¸åŒçš„ AOF æŒä¹…åŒ–æ–¹å¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š

```conf
appendfsync always    #æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶,è¿™æ ·ä¼šä¸¥é‡é™ä½Redisçš„é€Ÿåº¦
appendfsync everysec  #æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œæ˜¾å¼åœ°å°†å¤šä¸ªå†™å‘½ä»¤åŒæ­¥åˆ°ç¡¬ç›˜
appendfsync no        #è®©æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶è¿›è¡ŒåŒæ­¥
```

ä¸ºäº†å…¼é¡¾æ•°æ®å’Œå†™å…¥æ€§èƒ½ï¼Œç”¨æˆ·å¯ä»¥è€ƒè™‘ `appendfsync everysec` é€‰é¡¹ ï¼Œè®© Redis æ¯ç§’åŒæ­¥ä¸€æ¬¡ AOF æ–‡ä»¶ï¼ŒRedis æ€§èƒ½å‡ ä¹æ²¡å—åˆ°ä»»ä½•å½±å“ã€‚è€Œä¸”è¿™æ ·å³ä½¿å‡ºç°ç³»ç»Ÿå´©æºƒï¼Œç”¨æˆ·æœ€å¤šåªä¼šä¸¢å¤±ä¸€ç§’ä¹‹å†…äº§ç”Ÿçš„æ•°æ®ã€‚å½“ç¡¬ç›˜å¿™äºæ‰§è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼ŒRedis è¿˜ä¼šä¼˜é›…çš„æ”¾æ…¢è‡ªå·±çš„é€Ÿåº¦ä»¥ä¾¿é€‚åº”ç¡¬ç›˜çš„æœ€å¤§å†™å…¥é€Ÿåº¦ã€‚

#### AOF é‡å†™äº†è§£å—ï¼Ÿ

AOF é‡å†™å¯ä»¥äº§ç”Ÿä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ï¼Œè¿™ä¸ªæ–°çš„ AOF æ–‡ä»¶å’ŒåŸæœ‰çš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€æ ·ï¼Œä½†ä½“ç§¯æ›´å°ã€‚

AOF é‡å†™æ˜¯ä¸€ä¸ªæœ‰æ­§ä¹‰çš„åå­—ï¼Œè¯¥åŠŸèƒ½æ˜¯é€šè¿‡è¯»å–æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ¥å®ç°çš„ï¼Œç¨‹åºæ— é¡»å¯¹ç°æœ‰ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å…¥ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œã€‚

åœ¨æ‰§è¡Œ `BGREWRITEAOF` å‘½ä»¤æ—¶ï¼ŒRedis æœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ª AOF é‡å†™ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä¼šåœ¨å­è¿›ç¨‹åˆ›å»ºæ–° AOF  æ–‡ä»¶æœŸé—´ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚å½“å­è¿›ç¨‹å®Œæˆåˆ›å»ºæ–° AOF æ–‡ä»¶çš„å·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå°†é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–° AOF  æ–‡ä»¶çš„æœ«å°¾ï¼Œä½¿å¾—æ–°çš„ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸ç°æœ‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚æœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„ AOF æ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®Œæˆ  AOF æ–‡ä»¶é‡å†™æ“ä½œã€‚

> æ‹“å±•

Redis 4.0 å¼€å§‹æ”¯æŒ RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–ï¼ˆé»˜è®¤å…³é—­ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ `aof-use-rdb-preamble` å¼€å¯ï¼‰ã€‚

å¦‚æœæŠŠæ··åˆæŒä¹…åŒ–æ‰“å¼€ï¼ŒAOF é‡å†™çš„æ—¶å€™å°±ç›´æ¥æŠŠ RDB çš„å†…å®¹å†™åˆ° AOF æ–‡ä»¶å¼€å¤´ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥ç»“åˆ RDB å’Œ AOF çš„ä¼˜ç‚¹,  å¿«é€ŸåŠ è½½åŒæ—¶é¿å…ä¸¢å¤±è¿‡å¤šçš„æ•°æ®ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œ AOF é‡Œé¢çš„ RDB éƒ¨åˆ†æ˜¯å‹ç¼©æ ¼å¼ä¸å†æ˜¯ AOF æ ¼å¼ï¼Œå¯è¯»æ€§è¾ƒå·®ã€‚

#### ä¸ºä»€ä¹ˆä¼šæœ‰æ··åˆæŒä¹…åŒ–ï¼Ÿ

RDB ä¼˜ç‚¹æ˜¯æ•°æ®æ¢å¤é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å¿«ç…§çš„é¢‘ç‡ä¸å¥½æŠŠæ¡ã€‚é¢‘ç‡å¤ªä½ï¼Œä¸¢å¤±çš„æ•°æ®å°±ä¼šæ¯”è¾ƒå¤šï¼Œé¢‘ç‡å¤ªé«˜ï¼Œå°±ä¼šå½±å“æ€§èƒ½ã€‚

AOF ä¼˜ç‚¹æ˜¯ä¸¢å¤±æ•°æ®å°‘ï¼Œä½†æ˜¯æ•°æ®æ¢å¤ä¸å¿«ã€‚

ä¸ºäº†é›†æˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ï¼Œ Redis 4.0 æå‡ºäº†**æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§**ï¼Œä¹Ÿå«æ··åˆæŒä¹…åŒ–ï¼Œæ—¢ä¿è¯äº† Redis é‡å¯é€Ÿåº¦ï¼Œåˆé™ä½æ•°æ®ä¸¢å¤±é£é™©ã€‚

æ··åˆæŒä¹…åŒ–å·¥ä½œåœ¨ **AOF æ—¥å¿—é‡å†™è¿‡ç¨‹**ï¼Œå½“å¼€å¯äº†æ··åˆæŒä¹…åŒ–æ—¶ï¼Œåœ¨ AOF é‡å†™æ—¥å¿—æ—¶ï¼Œfork å‡ºæ¥çš„é‡å†™å­è¿›ç¨‹ä¼šå…ˆå°†ä¸ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜æ•°æ®ä»¥ RDB æ–¹å¼å†™å…¥åˆ° AOF  æ–‡ä»¶ï¼Œç„¶åä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ä¼šè¢«è®°å½•åœ¨é‡å†™ç¼“å†²åŒºé‡Œï¼Œé‡å†™ç¼“å†²åŒºé‡Œçš„å¢é‡å‘½ä»¤ä¼šä»¥ AOF æ–¹å¼å†™å…¥åˆ° AOF  æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹å°†æ–°çš„å«æœ‰ RDB æ ¼å¼å’Œ AOF æ ¼å¼çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„çš„ AOF æ–‡ä»¶ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„**å‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®**ã€‚

![image-20220715160726101](./images/image-20220715160726101.png)

è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œé‡å¯ Redis åŠ è½½æ•°æ®çš„æ—¶å€™ï¼Œç”±äºå‰åŠéƒ¨åˆ†æ˜¯ RDB å†…å®¹ï¼Œè¿™æ ·**åŠ è½½çš„æ—¶å€™é€Ÿåº¦ä¼šå¾ˆå¿«**ã€‚

åŠ è½½å®Œ RDB çš„å†…å®¹åï¼Œæ‰ä¼šåŠ è½½ååŠéƒ¨åˆ†çš„ AOF å†…å®¹ï¼Œè¿™é‡Œçš„å†…å®¹æ˜¯ Redis åå°å­è¿›ç¨‹é‡å†™ AOF æœŸé—´ï¼Œä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ï¼Œå¯ä»¥ä½¿å¾—**æ•°æ®æ›´å°‘çš„ä¸¢å¤±**ã€‚

**æ··åˆæŒä¹…åŒ–ä¼˜ç‚¹ï¼š**

- æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF æŒä¹…åŒ–çš„ä¼˜ç‚¹ï¼Œå¼€å¤´ä¸º RDB çš„æ ¼å¼ï¼Œä½¿å¾— Redis å¯ä»¥æ›´å¿«çš„å¯åŠ¨ï¼ŒåŒæ—¶ç»“åˆ AOF çš„ä¼˜ç‚¹ï¼Œæœ‰å‡ä½äº†å¤§é‡æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚

**æ··åˆæŒä¹…åŒ–ç¼ºç‚¹ï¼š**

- AOF æ–‡ä»¶ä¸­æ·»åŠ äº† RDB æ ¼å¼çš„å†…å®¹ï¼Œä½¿å¾— AOF æ–‡ä»¶çš„å¯è¯»æ€§å˜å¾—å¾ˆå·®ï¼›
- å…¼å®¹æ€§å·®ï¼Œå¦‚æœå¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ­¤æ··åˆæŒä¹…åŒ– AOF æ–‡ä»¶ï¼Œå°±ä¸èƒ½ç”¨åœ¨ Redis 4.0 ä¹‹å‰ç‰ˆæœ¬äº†ã€‚

### ç¼“å­˜ç©¿é€ & ç¼“å­˜é›ªå´© & ç¼“å­˜å‡»ç©¿

#### ç©¿é€

å½“å‘ç”Ÿç¼“å­˜é›ªå´©æˆ–å‡»ç©¿æ—¶ï¼Œæ•°æ®åº“ä¸­è¿˜æ˜¯ä¿å­˜äº†åº”ç”¨è¦è®¿é—®çš„æ•°æ®ï¼Œä¸€æ—¦ç¼“å­˜æ¢å¤ç›¸å¯¹åº”çš„æ•°æ®ï¼Œå°±å¯ä»¥å‡è½»æ•°æ®åº“çš„å‹åŠ›ï¼Œè€Œç¼“å­˜ç©¿é€å°±ä¸ä¸€æ ·äº†ã€‚

å½“ç”¨æˆ·è®¿é—®çš„æ•°æ®ï¼Œ**æ—¢ä¸åœ¨ç¼“å­˜ä¸­ï¼Œä¹Ÿä¸åœ¨æ•°æ®åº“ä¸­**ï¼Œå¯¼è‡´è¯·æ±‚åœ¨è®¿é—®ç¼“å­˜æ—¶ï¼Œå‘ç°ç¼“å­˜ç¼ºå¤±ï¼Œå†å»è®¿é—®æ•°æ®åº“æ—¶ï¼Œå‘ç°æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰è¦è®¿é—®çš„æ•°æ®ï¼Œæ²¡åŠæ³•æ„å»ºç¼“å­˜æ•°æ®ï¼Œæ¥æœåŠ¡åç»­çš„è¯·æ±‚ã€‚é‚£ä¹ˆå½“æœ‰å¤§é‡è¿™æ ·çš„è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ•°æ®åº“çš„å‹åŠ›éª¤å¢ï¼Œè¿™å°±æ˜¯**ç¼“å­˜ç©¿é€**çš„é—®é¢˜ã€‚

![image-20220714212317883](./images/image-20220714212317883.png)

ç¼“å­˜ç©¿é€çš„å‘ç”Ÿä¸€èˆ¬æœ‰è¿™ä¸¤ç§æƒ…å†µï¼š

- ä¸šåŠ¡è¯¯æ“ä½œï¼Œç¼“å­˜ä¸­çš„æ•°æ®å’Œæ•°æ®åº“ä¸­çš„æ•°æ®éƒ½è¢«è¯¯åˆ é™¤äº†ï¼Œæ‰€ä»¥å¯¼è‡´ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰æ•°æ®ï¼›
- é»‘å®¢æ¶æ„æ”»å‡»ï¼Œæ•…æ„å¤§é‡è®¿é—®æŸäº›è¯»å–ä¸å­˜åœ¨æ•°æ®çš„ä¸šåŠ¡ï¼›

åº”å¯¹ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆï¼Œå¸¸è§çš„æ–¹æ¡ˆæœ‰ä¸‰ç§ã€‚

- **éæ³•è¯·æ±‚çš„é™åˆ¶**ï¼šå½“æœ‰å¤§é‡æ¶æ„è¯·æ±‚è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¼šå‘ç”Ÿç¼“å­˜ç©¿é€ï¼Œå› æ­¤åœ¨ API å…¥å£å¤„æˆ‘ä»¬è¦åˆ¤æ–­æ±‚è¯·æ±‚å‚æ•°æ˜¯å¦åˆç†ï¼Œè¯·æ±‚å‚æ•°æ˜¯å¦å«æœ‰éæ³•å€¼ã€è¯·æ±‚å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœåˆ¤æ–­å‡ºæ˜¯æ¶æ„è¯·æ±‚å°±ç›´æ¥è¿”å›é”™è¯¯ï¼Œé¿å…è¿›ä¸€æ­¥è®¿é—®ç¼“å­˜å’Œæ•°æ®åº“ã€‚
- **è®¾ç½®ç©ºå€¼æˆ–è€…é»˜è®¤å€¼**ï¼šå½“æˆ‘ä»¬çº¿ä¸Šä¸šåŠ¡å‘ç°ç¼“å­˜ç©¿é€çš„ç°è±¡æ—¶ï¼Œå¯ä»¥é’ˆå¯¹æŸ¥è¯¢çš„æ•°æ®ï¼Œåœ¨ç¼“å­˜ä¸­è®¾ç½®ä¸€ä¸ªç©ºå€¼æˆ–è€…é»˜è®¤å€¼ï¼Œè¿™æ ·åç»­è¯·æ±‚å°±å¯ä»¥ä»ç¼“å­˜ä¸­è¯»å–åˆ°ç©ºå€¼æˆ–è€…é»˜è®¤å€¼ï¼Œè¿”å›ç»™åº”ç”¨ï¼Œè€Œä¸ä¼šç»§ç»­æŸ¥è¯¢æ•°æ®åº“ã€‚
- **ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œé¿å…é€šè¿‡æŸ¥è¯¢æ•°æ®åº“æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨**ï¼šæˆ‘ä»¬å¯ä»¥åœ¨å†™å…¥æ•°æ®åº“æ•°æ®æ—¶ï¼Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åšä¸ªæ ‡è®°ï¼Œç„¶ååœ¨ç”¨æˆ·è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä¸šåŠ¡çº¿ç¨‹ç¡®è®¤ç¼“å­˜å¤±æ•ˆåï¼Œå¯ä»¥é€šè¿‡æŸ¥è¯¢å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¸ç”¨é€šè¿‡æŸ¥è¯¢æ•°æ®åº“æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå³ä½¿å‘ç”Ÿäº†ç¼“å­˜ç©¿é€ï¼Œå¤§é‡è¯·æ±‚åªä¼šæŸ¥è¯¢ Redis å’Œå¸ƒéš†è¿‡æ»¤å™¨ï¼Œè€Œä¸ä¼šæŸ¥è¯¢æ•°æ®åº“ï¼Œä¿è¯äº†æ•°æ®åº“èƒ½æ­£å¸¸è¿è¡Œï¼ŒRedis è‡ªèº«ä¹Ÿæ˜¯æ”¯æŒå¸ƒéš†è¿‡æ»¤å™¨çš„ã€‚

> è¯¦ç»†è¯´æ˜

**1ï¼‰ç¼“å­˜æ— æ•ˆ key**

å¦‚æœç¼“å­˜å’Œæ•°æ®åº“éƒ½æŸ¥ä¸åˆ°æŸä¸ª key çš„æ•°æ®å°±å†™ä¸€ä¸ªåˆ° Redis ä¸­å»å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š `SET key value EX 10086` ã€‚è¿™ç§æ–¹å¼å¯ä»¥è§£å†³è¯·æ±‚çš„ key å˜åŒ–ä¸é¢‘ç¹çš„æƒ…å†µï¼Œå¦‚æœé»‘å®¢æ¶æ„æ”»å‡»ï¼Œæ¯æ¬¡æ„å»ºä¸åŒçš„è¯·æ±‚ keyï¼Œä¼šå¯¼è‡´ Redis ä¸­ç¼“å­˜å¤§é‡æ— æ•ˆçš„ key ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ç§æ–¹æ¡ˆå¹¶ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³æ­¤é—®é¢˜ã€‚å¦‚æœéè¦ç”¨è¿™ç§æ–¹å¼æ¥è§£å†³ç©¿é€é—®é¢˜çš„è¯ï¼Œå°½é‡å°†æ— æ•ˆçš„ key çš„è¿‡æœŸæ—¶é—´è®¾ç½®çŸ­ä¸€ç‚¹æ¯”å¦‚ 1 åˆ†é’Ÿã€‚

**2ï¼‰å¸ƒéš†è¿‡æ»¤å™¨**

å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªéå¸¸ç¥å¥‡çš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°åˆ¤æ–­ä¸€ä¸ªç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨äºæµ·é‡æ•°æ®ä¸­ã€‚æˆ‘ä»¬éœ€è¦çš„å°±æ˜¯åˆ¤æ–­ key æ˜¯å¦åˆæ³•ï¼Œæœ‰æ²¡æœ‰æ„Ÿè§‰å¸ƒéš†è¿‡æ»¤å™¨å°±æ˜¯æˆ‘ä»¬æƒ³è¦æ‰¾çš„é‚£ä¸ªâ€œäººâ€ã€‚

å…·ä½“æ˜¯è¿™æ ·åšçš„ï¼šæŠŠæ‰€æœ‰å¯èƒ½å­˜åœ¨çš„è¯·æ±‚çš„å€¼éƒ½å­˜æ”¾åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå½“ç”¨æˆ·è¯·æ±‚è¿‡æ¥ï¼Œå…ˆåˆ¤æ–­ç”¨æˆ·å‘æ¥çš„è¯·æ±‚çš„å€¼æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚ä¸å­˜åœ¨çš„è¯ï¼Œç›´æ¥è¿”å›è¯·æ±‚å‚æ•°é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼Œå­˜åœ¨çš„è¯æ‰ä¼šèµ°ä¸‹é¢çš„æµç¨‹ã€‚

åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ä¹‹åçš„ç¼“å­˜å¤„ç†æµç¨‹å›¾å¦‚ä¸‹ã€‚

![image-20220616204045863](./images/image-20220616204045863.png)

ä½†æ˜¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¸ƒéš†è¿‡æ»¤å™¨å¯èƒ½ä¼šå­˜åœ¨è¯¯åˆ¤çš„æƒ…å†µã€‚æ€»ç»“æ¥è¯´å°±æ˜¯ï¼š **å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ å­˜åœ¨ï¼Œå°æ¦‚ç‡ä¼šè¯¯åˆ¤ã€‚å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ ä¸åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ ä¸€å®šä¸åœ¨ã€‚**

*ä¸ºä»€ä¹ˆä¼šå‡ºç°è¯¯åˆ¤çš„æƒ…å†µå‘¢? æˆ‘ä»¬è¿˜è¦ä»å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†æ¥è¯´ï¼*

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œ**å½“ä¸€ä¸ªå…ƒç´ åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå“ªäº›æ“ä½œï¼š**

1. ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„å“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ å€¼è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å“ˆå¸Œå€¼ï¼ˆæœ‰å‡ ä¸ªå“ˆå¸Œå‡½æ•°å¾—åˆ°å‡ ä¸ªå“ˆå¸Œå€¼ï¼‰ã€‚
2. æ ¹æ®å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œåœ¨ä½æ•°ç»„ä¸­æŠŠå¯¹åº”ä¸‹æ ‡çš„å€¼ç½®ä¸º 1ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ï¼Œ**å½“æˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå“ªäº›æ“ä½œï¼š**

1. å¯¹ç»™å®šå…ƒç´ å†æ¬¡è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè®¡ç®—ï¼›
2. å¾—åˆ°å€¼ä¹‹ååˆ¤æ–­ä½æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ä¸º 1ï¼Œå¦‚æœå€¼éƒ½ä¸º 1ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ä¸ä¸º 1ï¼Œè¯´æ˜è¯¥å…ƒç´ ä¸åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚

ç„¶åï¼Œä¸€å®šä¼šå‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼š**ä¸åŒçš„å­—ç¬¦ä¸²å¯èƒ½å“ˆå¸Œå‡ºæ¥çš„ä½ç½®ç›¸åŒã€‚** ï¼ˆå¯ä»¥é€‚å½“å¢åŠ ä½æ•°ç»„å¤§å°æˆ–è€…è°ƒæ•´æˆ‘ä»¬çš„å“ˆå¸Œå‡½æ•°æ¥é™ä½æ¦‚ç‡ï¼‰

æ›´å¤šå…³äºå¸ƒéš†è¿‡æ»¤å™¨çš„å†…å®¹å¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡åŸåˆ›ï¼š[ã€Šä¸äº†è§£å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿä¸€æ–‡ç»™ä½ æ•´çš„æ˜æ˜ç™½ç™½ï¼ã€‹open in new window](https://javaguide.cn/cs-basics/data-structure/bloom-filter/) ï¼Œå¼ºçƒˆæ¨èï¼Œä¸ªäººæ„Ÿè§‰ç½‘ä¸Šåº”è¯¥æ‰¾ä¸åˆ°æ€»ç»“çš„è¿™ä¹ˆæ˜æ˜ç™½ç™½çš„æ–‡ç« äº†

#### ã€æ‹“å±•1ã€‘å¸ƒéš†è¿‡æ»¤å™¨

ä»€ä¹ˆæ˜¯å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å¸ƒéš†è¿‡æ»¤å™¨çš„æ¦‚å¿µã€‚

å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰æ˜¯ä¸€ä¸ªå«åš Bloom çš„è€å“¥äº 1970 å¹´æå‡ºçš„ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹ä½œç”±äºŒè¿›åˆ¶å‘é‡ï¼ˆæˆ–è€…è¯´ä½æ•°ç»„ï¼‰å’Œä¸€ç³»åˆ—éšæœºæ˜ å°„å‡½æ•°ï¼ˆå“ˆå¸Œå‡½æ•°ï¼‰ä¸¤éƒ¨åˆ†ç»„æˆçš„æ•°æ®ç»“æ„ã€‚ç›¸æ¯”äºæˆ‘ä»¬å¹³æ—¶å¸¸ç”¨çš„çš„ Listã€Map ã€Set ç­‰æ•°æ®ç»“æ„ï¼Œå®ƒå ç”¨ç©ºé—´æ›´å°‘å¹¶ä¸”æ•ˆç‡æ›´é«˜ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯å…¶è¿”å›çš„ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œè€Œä¸æ˜¯éå¸¸å‡†ç¡®çš„ã€‚ç†è®ºæƒ…å†µä¸‹æ·»åŠ åˆ°é›†åˆä¸­çš„å…ƒç´ è¶Šå¤šï¼Œè¯¯æŠ¥çš„å¯èƒ½æ€§å°±è¶Šå¤§ã€‚å¹¶ä¸”ï¼Œå­˜æ”¾åœ¨å¸ƒéš†è¿‡æ»¤å™¨çš„æ•°æ®ä¸å®¹æ˜“åˆ é™¤ã€‚

![å¸ƒéš†è¿‡æ»¤å™¨ç¤ºæ„å›¾](./images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8-bit%E6%95%B0%E7%BB%84.png)

ä½æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½åªå ç”¨ 1 bit ï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ åªèƒ½æ˜¯ 0 æˆ–è€… 1ã€‚è¿™æ ·ç”³è¯·ä¸€ä¸ª 100w ä¸ªå…ƒç´ çš„ä½æ•°ç»„åªå ç”¨ 1000000Bit / 8 = 125000 Byte = 125000/1024 kb â‰ˆ 122kb çš„ç©ºé—´ã€‚

æ€»ç»“ï¼š**ä¸€ä¸ªåå« Bloom çš„äººæå‡ºäº†ä¸€ç§æ¥æ£€ç´¢å…ƒç´ æ˜¯å¦åœ¨ç»™å®šå¤§é›†åˆä¸­çš„æ•°æ®ç»“æ„ï¼Œè¿™ç§æ•°æ®ç»“æ„æ˜¯é«˜æ•ˆä¸”æ€§èƒ½å¾ˆå¥½çš„ï¼Œä½†ç¼ºç‚¹æ˜¯å…·æœ‰ä¸€å®šçš„é”™è¯¯è¯†åˆ«ç‡å’Œåˆ é™¤éš¾åº¦ã€‚å¹¶ä¸”ï¼Œç†è®ºæƒ…å†µä¸‹ï¼Œæ·»åŠ åˆ°é›†åˆä¸­çš„å…ƒç´ è¶Šå¤šï¼Œè¯¯æŠ¥çš„å¯èƒ½æ€§å°±è¶Šå¤§ã€‚**

å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†

**å½“ä¸€ä¸ªå…ƒç´ åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š**

1. ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„å“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ å€¼è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å“ˆå¸Œå€¼ï¼ˆæœ‰å‡ ä¸ªå“ˆå¸Œå‡½æ•°å¾—åˆ°å‡ ä¸ªå“ˆå¸Œå€¼ï¼‰ã€‚
2. æ ¹æ®å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œåœ¨ä½æ•°ç»„ä¸­æŠŠå¯¹åº”ä¸‹æ ‡çš„å€¼ç½®ä¸º 1ã€‚

**å½“æˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š**

1. å¯¹ç»™å®šå…ƒç´ å†æ¬¡è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè®¡ç®—ï¼›
2. å¾—åˆ°å€¼ä¹‹ååˆ¤æ–­ä½æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ä¸º 1ï¼Œå¦‚æœå€¼éƒ½ä¸º 1ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ä¸ä¸º 1ï¼Œè¯´æ˜è¯¥å…ƒç´ ä¸åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š

![å¸ƒéš†è¿‡æ»¤å™¨hashè®¡ç®—](./images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8-hash%E8%BF%90%E7%AE%97.png)

å¦‚å›¾æ‰€ç¤ºï¼Œå½“å­—ç¬¦ä¸²å­˜å‚¨è¦åŠ å…¥åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ—¶ï¼Œè¯¥å­—ç¬¦ä¸²é¦–å…ˆç”±å¤šä¸ªå“ˆå¸Œå‡½æ•°ç”Ÿæˆä¸åŒçš„å“ˆå¸Œå€¼ï¼Œç„¶åå°†å¯¹åº”çš„ä½æ•°ç»„çš„ä¸‹æ ‡è®¾ç½®ä¸º 1ï¼ˆå½“ä½æ•°ç»„åˆå§‹åŒ–æ—¶ï¼Œæ‰€æœ‰ä½ç½®å‡ä¸º 0ï¼‰ã€‚å½“ç¬¬äºŒæ¬¡å­˜å‚¨ç›¸åŒå­—ç¬¦ä¸²æ—¶ï¼Œå› ä¸ºå…ˆå‰çš„å¯¹åº”ä½ç½®å·²è®¾ç½®ä¸º 1ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“çŸ¥é“æ­¤å€¼å·²ç»å­˜åœ¨ï¼ˆå»é‡éå¸¸æ–¹ä¾¿ï¼‰ã€‚

å¦‚æœæˆ‘ä»¬éœ€è¦åˆ¤æ–­æŸä¸ªå­—ç¬¦ä¸²æ˜¯å¦åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ—¶ï¼Œåªéœ€è¦å¯¹ç»™å®šå­—ç¬¦ä¸²å†æ¬¡è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè®¡ç®—ï¼Œå¾—åˆ°å€¼ä¹‹ååˆ¤æ–­ä½æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ä¸º 1ï¼Œå¦‚æœå€¼éƒ½ä¸º 1ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ä¸ä¸º 1ï¼Œè¯´æ˜è¯¥å…ƒç´ ä¸åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚

**ä¸åŒçš„å­—ç¬¦ä¸²å¯èƒ½å“ˆå¸Œå‡ºæ¥çš„ä½ç½®ç›¸åŒï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥é€‚å½“å¢åŠ ä½æ•°ç»„å¤§å°æˆ–è€…è°ƒæ•´æˆ‘ä»¬çš„å“ˆå¸Œå‡½æ•°ã€‚**

ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼š**å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ å­˜åœ¨ï¼Œå°æ¦‚ç‡ä¼šè¯¯åˆ¤ã€‚å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå…ƒç´ ä¸åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ ä¸€å®šä¸åœ¨**

#### ã€æ‹“å±•2ã€‘å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼ˆCuckoo Filterï¼‰

##### å¸ƒè°·é¸Ÿå“ˆå¸Œ

å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ç”¨æ›´ä½çš„ç©ºé—´å¼€é”€è§£å†³äº†å¸ƒéš†è¿‡æ»¤å™¨ä¸èƒ½åˆ é™¤å…ƒç´ çš„é—®é¢˜ï¼Œåšåˆ°äº†æ›´å¥½çš„æ•ˆæœï¼Œå…·ä½“çš„

- æ”¯æŒåŠ¨æ€çš„æ·»åŠ å’Œåˆ é™¤å…ƒç´ 
- æä¾›äº†æ¯”ä¼ ç»Ÿå¸ƒéš†è¿‡æ»¤å™¨æ›´é«˜çš„æŸ¥æ‰¾æ€§èƒ½ï¼Œå³ä½¿åœ¨æ¥è¿‘æ»¡çš„æƒ…å†µä¸‹ï¼ˆæ¯”å¦‚ç©ºé—´åˆ©ç”¨ç‡è¾¾åˆ° 95% çš„æ—¶å€™ï¼‰
- æ¯”èµ·å•†è¿‡æ»¤å™¨å®ƒæ›´å®¹æ˜“å®ç°
- å¦‚æœè¦æ±‚è¯¯åˆ¤ç‡ä½äº3%ï¼Œå®ƒæ¯”å¸ƒéš†è¿‡æ»¤å™¨æœ‰æ›´ä½çš„ç©ºé—´å¼€é”€

æœ¬è´¨ä¸Šæ¥è¯´å®ƒä¸ºè§£å†³å“ˆå¸Œå†²çªæä¾›äº†å¦ä¸€ç§ç­–ç•¥ï¼Œåˆ©ç”¨è¾ƒå°‘è®¡ç®—æ¢å–äº†è¾ƒå¤§ç©ºé—´ã€‚å®ƒå…·æœ‰å ç”¨ç©ºé—´å°ã€æŸ¥è¯¢è¿…é€Ÿç­‰ç‰¹æ€§ã€‚åç§°æºäºé‡‡å–äº†ä¸€ç§å’Œå¸ƒè°·é¸Ÿä¸€æ ·çš„å…»å¨ƒæ–¹æ³•

> å¸ƒè°·é¸Ÿäº¤é…åï¼Œé›Œæ€§**å¸ƒè°·é¸Ÿ**å°±å‡†å¤‡äº§è›‹äº†ï¼Œä½†å®ƒå´ä¸ä¼šè‡ªå·±ç­‘å·¢ã€‚å®ƒä¼šæ¥åˆ°åƒçŸ¥æ›´**é¸Ÿ**ã€åˆºå˜´èºç­‰é‚£äº›æ¯”å®ƒå°çš„**é¸Ÿ**ç±»çš„å·¢ä¸­ï¼Œç§»èµ°åŸæ¥çš„é‚£çªè›‹ä¸­çš„ä¸€ä¸ªï¼Œç”¨è‡ªå·±çš„è›‹æ¥å–è€Œä»£ä¹‹ã€‚ç›¸å¯¹äºå®ƒçš„ä½“å½¢æ¥è¯´ï¼Œå®ƒçš„è›‹æ˜¯åå°çš„ï¼Œè€Œä¸”è›‹ä¸Šçš„æ–‘çº¹åŒå®ƒæ··å…¥çš„å…¶ä»–**é¸Ÿ**çš„è›‹ä¹Ÿéå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥ä¸æ˜“è¢«åˆ†è¾¨å‡ºæ¥ã€‚å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œå®ƒçš„è›‹è‚¯å®šä¼šè¢«æ‰”å‡ºå»ã€‚

æœ€åŸå§‹çš„å¸ƒè°·é¸Ÿå“ˆå¸Œæ–¹æ³•æ˜¯ä½¿ç”¨ä¸¤ä¸ªå“ˆå¸Œå‡½æ•°å¯¹ä¸€ä¸ª `key`è¿›è¡Œå“ˆå¸Œï¼Œå¾—åˆ°æ¡¶ä¸­çš„ä¸¤ä¸ªä½ç½®ï¼Œæ­¤æ—¶

- å¦‚æœä¸¤ä¸ªä½ç½®éƒ½ä¸ºä¸ºç©ºåˆ™å°† `key`éšæœºå­˜å…¥å…¶ä¸­ä¸€ä¸ªä½ç½®
- å¦‚æœåªæœ‰ä¸€ä¸ªä½ç½®ä¸ºç©ºåˆ™å­˜å…¥ä¸ºç©ºçš„ä½ç½®
- å¦‚æœéƒ½ä¸ä¸ºç©ºï¼Œåˆ™éšæœºè¸¢å‡ºä¸€ä¸ªå…ƒç´ ï¼Œè¸¢å‡ºçš„å…ƒç´ å†é‡æ–°è®¡ç®—å“ˆå¸Œæ‰¾åˆ°ç›¸åº”çš„ä½ç½®

å½“ç„¶å‡å¦‚å­˜åœ¨ç»å¯¹çš„ç©ºé—´ä¸è¶³ï¼Œé‚£è€æ˜¯è¸¢å‡ºä¹Ÿä¸æ˜¯åŠæ³•ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šè®¾ç½®ä¸€ä¸ª**è¸¢å‡ºé˜ˆå€¼**ï¼Œå¦‚æœåœ¨æŸæ¬¡æ’å…¥è¡Œä¸ºè¿‡ç¨‹ä¸­è¿ç»­è¸¢å‡ºè¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è¿›è¡Œæ‰©å®¹ã€‚

![image-20210727104910960](./images/1617168-20210727195627534-1821849951.png)

##### å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨

![1](./images/1617168-20210727195625561-1153589445.jpg)

ä¸Šå›¾ï¼ˆaï¼‰(b)å±•ç¤ºäº†ä¸€ä¸ªåŸºæœ¬çš„å¸ƒè°·é¸Ÿå“ˆå¸Œè¡¨çš„æ’å…¥æ“ä½œï¼Œæ˜¯ç”±ä¸€ä¸ªæ¡¶æ•°ç»„ç»„æˆï¼Œæ¯ä¸ªæ’å…¥é¡¹éƒ½æœ‰ç”±æ•£åˆ—å‡½æ•°h1(x)å’Œh2(x)ç¡®å®šçš„ä¸¤ä¸ªå€™é€‰æ¡¶ï¼Œå…·ä½“æ“ä½œä¸Šæ–‡ä¸­å·²ç»æè¿°ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚

è€ŒåŸºæœ¬çš„å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ä¹Ÿæ˜¯ç”±ä¸¤ä¸ªæˆ–è€…å¤šä¸ªå“ˆå¸Œå‡½æ•°æ„æˆï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨çš„å¸ƒè°·é¸Ÿå“ˆå¸Œè¡¨çš„åŸºæœ¬å•ä½ç§°ä¸º**æ¡ç›®ï¼ˆentryï¼‰**ã€‚ æ¯ä¸ªæ¡ç›®å­˜å‚¨ä¸€ä¸ª**æŒ‡çº¹ï¼ˆfingerprintï¼‰**ï¼ŒæŒ‡çº¹æŒ‡çš„æ˜¯ä½¿ç”¨ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ç”Ÿæˆçš„nä½æ¯”ç‰¹ä½ï¼Œnçš„å…·ä½“å¤§å°ç”±æ‰€èƒ½æ¥å—çš„è¯¯åˆ¤ç‡æ¥è®¾ç½®ï¼Œè®ºæ–‡ä¸­çš„ä¾‹å­ä½¿ç”¨çš„æ˜¯8bitsçš„æŒ‡çº¹å¤§å°ã€‚

å“ˆå¸Œè¡¨ç”±ä¸€ä¸ªæ¡¶æ•°ç»„ç»„æˆï¼Œå…¶ä¸­ä¸€ä¸ªæ¡¶å¯ä»¥æœ‰å¤šä¸ªæ¡ç›®ï¼ˆæ¯”å¦‚ä¸Šè¿°å›¾cä¸­æœ‰å››ä¸ªæ¡ç›®ï¼‰ã€‚è€Œæ¯ä¸ªæ¡¶ä¸­æœ‰å››ä¸ªæŒ‡çº¹ä½ç½®ï¼Œæ„å‘³ç€ä¸€æ¬¡å“ˆå¸Œè®¡ç®—åå¸ƒè°·é¸Ÿæœ‰å››ä¸ªâ€œå·¢â€œå¯ç”¨ï¼Œè€Œä¸”å››ä¸ªå·¢æ˜¯è¿ç»­ä½ç½®ï¼Œå¯ä»¥æ›´å¥½çš„åˆ©ç”¨cpué«˜é€Ÿç¼“å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªæ¡¶çš„å¤§å°æ˜¯4*8bits

#### é›ªå´©

ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ

å®é™…ä¸Šï¼Œç¼“å­˜é›ªå´©æè¿°çš„å°±æ˜¯è¿™æ ·ä¸€ä¸ªç®€å•çš„åœºæ™¯ï¼š**ç¼“å­˜åœ¨åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œåé¢çš„è¯·æ±‚éƒ½ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œé€ æˆæ•°æ®åº“çŸ­æ—¶é—´å†…æ‰¿å—å¤§é‡è¯·æ±‚ã€‚** è¿™å°±å¥½æ¯”é›ªå´©ä¸€æ ·ï¼Œæ‘§æ¯æ‹‰æœ½ä¹‹åŠ¿ï¼Œæ•°æ®åº“çš„å‹åŠ›å¯æƒ³è€ŒçŸ¥ï¼Œå¯èƒ½ç›´æ¥å°±è¢«è¿™ä¹ˆå¤šè¯·æ±‚å¼„å®•æœºäº†

> å¦ä¸€ç§è¯´æ³•æ˜¯ï¼š
>
> å½“**å¤§é‡ç¼“å­˜æ•°æ®åœ¨åŒä¸€æ—¶é—´è¿‡æœŸï¼ˆå¤±æ•ˆï¼‰\**æ—¶ï¼Œå¦‚æœæ­¤æ—¶æœ‰å¤§é‡çš„ç”¨æˆ·è¯·æ±‚ï¼Œéƒ½æ— æ³•åœ¨ Redis ä¸­å¤„ç†ï¼Œäºæ˜¯å…¨éƒ¨è¯·æ±‚éƒ½ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œä»è€Œå¯¼è‡´æ•°æ®åº“çš„å‹åŠ›éª¤å¢ï¼Œä¸¥é‡çš„ä¼šé€ æˆæ•°æ®åº“å®•æœºï¼Œä»è€Œå½¢æˆä¸€ç³»åˆ—è¿é”ååº”ï¼Œé€ æˆæ•´ä¸ªç³»ç»Ÿå´©æºƒï¼Œè¿™å°±æ˜¯ç¼“å­˜é›ªå´©**çš„é—®é¢˜ã€‚

![image-20220616203658271](./images/image-20220616203658271.png)

é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ç¼“å­˜ç”¨äºç¼“å†²å¯¹ DB çš„å†²å‡»ï¼Œå¦‚æœç¼“å­˜å®•æœºï¼Œæ‰€æœ‰è¯·æ±‚å°†ç›´æ¥æ‰“åœ¨ DBï¼Œé€ æˆ DB å®•æœºâ€”â€”ä»è€Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå®•æœºã€‚

![image-20220616203727609](./images/image-20220616203727609.png)

**2 ç§ç­–ç•¥ï¼š**

- **å°†ç¼“å­˜å¤±æ•ˆæ—¶é—´éšæœºæ‰“æ•£ï¼š** æˆ‘ä»¬å¯ä»¥åœ¨åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼ˆæ¯”å¦‚ 1 åˆ° 10 åˆ†é’Ÿï¼‰è¿™æ ·æ¯ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´éƒ½ä¸é‡å¤äº†ï¼Œä¹Ÿå°±é™ä½äº†ç¼“å­˜é›†ä½“å¤±æ•ˆçš„æ¦‚ç‡ã€‚
- **è®¾ç½®ç¼“å­˜ä¸è¿‡æœŸï¼š** æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°æœåŠ¡æ¥æ›´æ–°ç¼“å­˜æ•°æ®ï¼Œä»è€Œé¿å…å› ä¸ºç¼“å­˜å¤±æ•ˆé€ æˆçš„ç¼“å­˜é›ªå´©ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…ç¼“å­˜å¹¶å‘é—®é¢˜ã€‚

#### å‡»ç©¿

**ç¼“å­˜å‡»ç©¿**æ˜¯æŒ‡æŸä¸€ä¸ªçƒ­ç‚¹æ•°æ®ç¼“å­˜ä¸­æ²¡æœ‰ä½†æ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ç¼“å­˜æ—¶é—´åˆ°æœŸï¼Œæ¯”å¦‚ç§’æ€æ´»åŠ¨ï¼Œè¿™ç±»è¢«é¢‘åœ°è®¿é—®çš„æ•°æ®è¢«ç§°ä¸ºçƒ­ç‚¹æ•°æ®ï¼‰ã€‚è¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ˆ**æŸä¸ªçƒ­ç‚¹æ•°æ®è¿‡æœŸ**äº†ï¼Œæ­¤æ—¶å¤§é‡çš„è¯·æ±‚è®¿é—®äº†è¯¥çƒ­ç‚¹æ•°æ®ï¼Œå°±æ— æ³•ä»ç¼“å­˜ä¸­è¯»å–ï¼‰ï¼Œå°±å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œè¢«é«˜å¹¶å‘çš„è¯·æ±‚å†²å®ï¼Œè¿™å°±æ˜¯**ç¼“å­˜å‡»ç©¿**çš„é—®é¢˜ã€‚

è§£å†³ï¼š

1. **è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸ**ã€‚
2. **æ¥å£é™æµä¸ç†”æ–­**ï¼Œé™çº§ã€‚é‡è¦çš„æ¥å£ä¸€å®šè¦åšå¥½é™æµç­–ç•¥ï¼Œé˜²æ­¢ç”¨æˆ·æ¶æ„åˆ·æ¥å£ï¼ŒåŒæ—¶è¦é™çº§å‡†å¤‡ï¼Œå½“æ¥å£ä¸­çš„æŸäº›æœåŠ¡ä¸å¯ç”¨æ—¶å€™ï¼Œè¿›è¡Œç†”æ–­ï¼Œå¤±è´¥å¿«é€Ÿè¿”å›æœºåˆ¶ã€‚
3. **è®¾ç½®äº’æ–¥é”**ã€‚åœ¨å¹¶å‘çš„å¤šä¸ªè¯·æ±‚ä¸­ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªè¯·æ±‚çº¿ç¨‹èƒ½æ‹¿åˆ°é”å¹¶æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œï¼Œå…¶ä»–çš„çº¿ç¨‹æ‹¿ä¸åˆ°é”å°±é˜»å¡ç­‰ç€ï¼Œç­‰åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹å°†æ•°æ®å†™å…¥ç¼“å­˜åï¼Œç›´æ¥èµ°ç¼“å­˜ã€‚ï¼ˆå¯ä»¥ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”ï¼‰

![image-20220714212532910](./images/image-20220714212532910.png)

### ä¸»ä»å¤åˆ¶æ–¹æ¡ˆæ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

![image-20220714220149168](./images/image-20220714220149168.png)

å¤šå°æœåŠ¡å™¨è¦ä¿å­˜åŒä¸€ä»½æ•°æ®ï¼Œè¿™é‡Œé—®é¢˜å°±æ¥äº†ã€‚

è¿™äº›æœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®å¦‚ä½•ä¿æŒä¸€è‡´æ€§å‘¢ï¼Ÿæ•°æ®çš„è¯»å†™æ“ä½œæ˜¯å¦æ¯å°æœåŠ¡å™¨éƒ½å¯ä»¥å¤„ç†ï¼Ÿ

Redis æä¾›äº†**ä¸»ä»å¤åˆ¶æ¨¡å¼**ï¼Œæ¥é¿å…ä¸Šè¿°çš„é—®é¢˜ã€‚

è¿™ä¸ªæ¨¡å¼å¯ä»¥ä¿è¯å¤šå°æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä¸”ä¸»ä»æœåŠ¡å™¨ä¹‹é—´é‡‡ç”¨çš„æ˜¯ã€Œè¯»å†™åˆ†ç¦»ã€çš„æ–¹å¼ã€‚

ä¸»æœåŠ¡å™¨å¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œå½“å‘ç”Ÿå†™æ“ä½œæ—¶è‡ªåŠ¨å°†å†™æ“ä½œåŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨ä¸€èˆ¬æ˜¯åªè¯»ï¼Œå¹¶æ¥å—ä¸»æœåŠ¡å™¨åŒæ­¥è¿‡æ¥å†™æ“ä½œå‘½ä»¤ï¼Œç„¶åæ‰§è¡Œè¿™æ¡å‘½ä»¤ã€‚

![image-20220714220158025](./images/image-20220714220158025.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„æ•°æ®ä¿®æ”¹åªåœ¨ä¸»æœåŠ¡å™¨ä¸Šè¿›è¡Œï¼Œç„¶åå°†æœ€æ–°çš„æ•°æ®åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè¿™æ ·å°±ä½¿å¾—ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚

åŒæ­¥è¿™ä¸¤ä¸ªå­—è¯´çš„ç®€å•ï¼Œä½†æ˜¯è¿™ä¸ªåŒæ­¥è¿‡ç¨‹å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•ï¼Œè¦è€ƒè™‘çš„äº‹æƒ…ä¸æ˜¯ä¸€ä¸¤ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ï¼Œä¸»ä»æœåŠ¡å™¨é—´çš„ç¬¬ä¸€æ¬¡åŒæ­¥æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

#### ç¬¬ä¸€æ¬¡åŒæ­¥

å¤šå°æœåŠ¡å™¨ä¹‹é—´è¦é€šè¿‡ä»€ä¹ˆæ–¹å¼æ¥ç¡®å®šè°æ˜¯ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…è°æ˜¯ä»æœåŠ¡å™¨å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `replicaof`ï¼ˆRedis 5.0 ä¹‹å‰ä½¿ç”¨ slaveofï¼‰å‘½ä»¤å½¢æˆä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨çš„å…³ç³»ã€‚

æ¯”å¦‚ï¼Œç°åœ¨æœ‰æœåŠ¡å™¨ A å’Œ æœåŠ¡å™¨ Bï¼Œæˆ‘ä»¬åœ¨æœåŠ¡å™¨ B ä¸Šæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š

```text
# æœåŠ¡å™¨ B æ‰§è¡Œè¿™æ¡å‘½ä»¤
replicaof <æœåŠ¡å™¨ A çš„ IP åœ°å€> <æœåŠ¡å™¨ A çš„ Redis ç«¯å£å·>
```

æ¥ç€ï¼ŒæœåŠ¡å™¨ B å°±ä¼šå˜æˆæœåŠ¡å™¨ A çš„ã€Œä»æœåŠ¡å™¨ã€ï¼Œç„¶åä¸ä¸»æœåŠ¡å™¨è¿›è¡Œç¬¬ä¸€æ¬¡åŒæ­¥ã€‚

ä¸»ä»æœåŠ¡å™¨é—´çš„ç¬¬ä¸€æ¬¡åŒæ­¥çš„è¿‡ç¨‹å¯åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

- ç¬¬ä¸€é˜¶æ®µæ˜¯å»ºç«‹é“¾æ¥ã€åå•†åŒæ­¥ï¼›
- ç¬¬äºŒé˜¶æ®µæ˜¯ä¸»æœåŠ¡å™¨åŒæ­¥æ•°æ®ç»™ä»æœåŠ¡å™¨ï¼›
- ç¬¬ä¸‰é˜¶æ®µæ˜¯ä¸»æœåŠ¡å™¨å‘é€æ–°å†™æ“ä½œå‘½ä»¤ç»™ä»æœåŠ¡å™¨ã€‚

ä¸ºäº†è®©ä½ æ›´æ¸…æ¥šäº†è§£è¿™ä¸‰ä¸ªé˜¶æ®µï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾ã€‚

![image-20220714220220342](./images/image-20220714220220342.png)

> æ¥ä¸‹æ¥ï¼Œæˆ‘åœ¨å…·ä½“ä»‹ç»æ¯ä¸€ä¸ªé˜¶æ®µéƒ½åšäº†ä»€ä¹ˆã€‚

*ç¬¬ä¸€é˜¶æ®µï¼šå»ºç«‹é“¾æ¥ã€åå•†åŒæ­¥*

æ‰§è¡Œäº† replicaof å‘½ä»¤åï¼Œä»æœåŠ¡å™¨å°±ä¼šç»™ä¸»æœåŠ¡å™¨å‘é€ `psync` å‘½ä»¤ï¼Œè¡¨ç¤ºè¦è¿›è¡Œæ•°æ®åŒæ­¥ã€‚

psync å‘½ä»¤åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯**ä¸»æœåŠ¡å™¨çš„ runID** å’Œ**å¤åˆ¶è¿›åº¦ offset**ã€‚

- runIDï¼Œæ¯ä¸ª Redis æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿäº§ä¸€ä¸ªéšæœºçš„ ID æ¥å”¯ä¸€æ ‡è¯†è‡ªå·±ã€‚å½“ä»æœåŠ¡å™¨å’Œä¸»æœåŠ¡å™¨ç¬¬ä¸€æ¬¡åŒæ­¥æ—¶ï¼Œå› ä¸ºä¸çŸ¥é“ä¸»æœåŠ¡å™¨çš„ run IDï¼Œæ‰€ä»¥å°†å…¶è®¾ç½®ä¸º "?"ã€‚
- offsetï¼Œè¡¨ç¤ºå¤åˆ¶çš„è¿›åº¦ï¼Œç¬¬ä¸€æ¬¡åŒæ­¥æ—¶ï¼Œå…¶å€¼ä¸º -1ã€‚

ä¸»æœåŠ¡å™¨æ”¶åˆ° psync å‘½ä»¤åï¼Œä¼šç”¨ `FULLRESYNC` ä½œä¸ºå“åº”å‘½ä»¤è¿”å›ç»™å¯¹æ–¹ã€‚

å¹¶ä¸”è¿™ä¸ªå“åº”å‘½ä»¤ä¼šå¸¦ä¸Šä¸¤ä¸ªå‚æ•°ï¼šä¸»æœåŠ¡å™¨çš„ runID å’Œä¸»æœåŠ¡å™¨ç›®å‰çš„å¤åˆ¶è¿›åº¦ offsetã€‚ä»æœåŠ¡å™¨æ”¶åˆ°å“åº”åï¼Œä¼šè®°å½•è¿™ä¸¤ä¸ªå€¼ã€‚

FULLRESYNC å“åº”å‘½ä»¤çš„æ„å›¾æ˜¯é‡‡ç”¨**å…¨é‡å¤åˆ¶**çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä¸»æœåŠ¡å™¨ä¼šæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½åŒæ­¥ç»™ä»æœåŠ¡å™¨ã€‚

æ‰€ä»¥ï¼Œç¬¬ä¸€é˜¶æ®µçš„å·¥ä½œæ—¶ä¸ºäº†å…¨é‡å¤åˆ¶åšå‡†å¤‡ã€‚

é‚£å…·ä½“æ€ä¹ˆå…¨é‡åŒæ­¥å‘€å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å¾€ä¸‹çœ‹ç¬¬äºŒé˜¶æ®µã€‚

*ç¬¬äºŒé˜¶æ®µï¼šä¸»æœåŠ¡å™¨åŒæ­¥æ•°æ®ç»™ä»æœåŠ¡å™¨*

æ¥ç€ï¼Œä¸»æœåŠ¡å™¨ä¼šæ‰§è¡Œ bgsave å‘½ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç„¶åæŠŠæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ã€‚

ä»æœåŠ¡å™¨æ”¶åˆ° RDB æ–‡ä»¶åï¼Œä¼šå…ˆæ¸…ç©ºå½“å‰çš„æ•°æ®ï¼Œç„¶åè½½å…¥ RDB æ–‡ä»¶ã€‚

è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œä¸»æœåŠ¡å™¨ç”Ÿæˆ RDB è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„ï¼Œå› ä¸º bgsave å‘½ä»¤æ˜¯äº§ç”Ÿäº†ä¸€ä¸ªå­è¿›ç¨‹æ¥åšç”Ÿæˆ RDB æ–‡ä»¶çš„å·¥ä½œï¼Œæ˜¯å¼‚æ­¥å·¥ä½œçš„ï¼Œè¿™æ · Redis ä¾ç„¶å¯ä»¥æ­£å¸¸å¤„ç†å‘½ä»¤ã€‚

ä½†æ˜¯ï¼Œè¿™æœŸé—´çš„å†™æ“ä½œå‘½ä»¤å¹¶æ²¡æœ‰è®°å½•åˆ°åˆšåˆšç”Ÿæˆçš„ RDB æ–‡ä»¶ä¸­ï¼Œè¿™æ—¶ä¸»ä»æœåŠ¡å™¨é—´çš„æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚é‚£ä¹ˆä¸ºäº†ä¿è¯ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§ï¼Œ**ä¸»æœåŠ¡å™¨åœ¨ä¸‹é¢è¿™ä¸‰ä¸ªæ—¶é—´é—´éš™ä¸­å°†æ”¶åˆ°çš„å†™æ“ä½œå‘½ä»¤ï¼Œå†™å…¥åˆ° replication buffer ç¼“å†²åŒºé‡Œã€‚**

- ä¸»æœåŠ¡å™¨ç”Ÿæˆ RDB æ–‡ä»¶æœŸé—´ï¼›
- ä¸»æœåŠ¡å™¨å‘é€ RDB æ–‡ä»¶ç»™ä»æœåŠ¡å™¨æœŸé—´ï¼›
- ã€Œä»æœåŠ¡å™¨ã€åŠ è½½ RDB æ–‡ä»¶æœŸé—´ï¼›

*ç¬¬ä¸‰é˜¶æ®µï¼šä¸»æœåŠ¡å™¨å‘é€æ–°å†™æ“ä½œå‘½ä»¤ç»™ä»æœåŠ¡å™¨*

åœ¨ä¸»æœåŠ¡å™¨ç”Ÿæˆçš„ RDB æ–‡ä»¶å‘é€å®Œï¼Œä»æœåŠ¡å™¨åŠ è½½å®Œ RDB æ–‡ä»¶åï¼Œç„¶åå°† replication buffer ç¼“å†²åŒºé‡Œæ‰€è®°å½•çš„å†™æ“ä½œå‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åã€Œä»æœåŠ¡å™¨ã€é‡æ–°æ‰§è¡Œè¿™äº›æ“ä½œï¼Œè‡³æ­¤ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®å°±ä¸€è‡´äº†ã€‚

è‡³æ­¤ï¼Œä¸»ä»æœåŠ¡å™¨çš„ç¬¬ä¸€æ¬¡åŒæ­¥çš„å·¥ä½œå°±å®Œæˆäº†ã€‚

#### å‘½ä»¤ä¼ æ’­

ä¸»ä»æœåŠ¡å™¨åœ¨å®Œæˆç¬¬ä¸€æ¬¡åŒæ­¥åï¼ŒåŒæ–¹ä¹‹é—´å°±ä¼šç»´æŠ¤ä¸€ä¸ª TCP è¿æ¥ã€‚

![image-20220714220259046](./images/image-20220714220259046.png)

åç»­ä¸»æœåŠ¡å™¨å¯ä»¥é€šè¿‡è¿™ä¸ªè¿æ¥ç»§ç»­å°†å†™æ“ä½œå‘½ä»¤ä¼ æ’­ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åä»æœåŠ¡å™¨æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä½¿å¾—ä¸ä¸»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€ç›¸åŒã€‚

è€Œä¸”è¿™ä¸ªè¿æ¥æ˜¯é•¿è¿æ¥çš„ï¼Œç›®çš„æ˜¯é¿å…é¢‘ç¹çš„ TCP è¿æ¥å’Œæ–­å¼€å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚

ä¸Šé¢çš„è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º**åŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­**ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥ä¿è¯ç¬¬ä¸€æ¬¡åŒæ­¥åçš„ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§ã€‚

#### åˆ†æ‘Šä¸»æœåŠ¡å™¨çš„å‹åŠ›

åœ¨å‰é¢çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸»ä»æœåŠ¡å™¨åœ¨ç¬¬ä¸€æ¬¡æ•°æ®åŒæ­¥çš„è¿‡ç¨‹ä¸­ï¼Œä¸»æœåŠ¡å™¨ä¼šåšä¸¤ä»¶è€—æ—¶çš„æ“ä½œï¼šç”Ÿæˆ RDB æ–‡ä»¶å’Œä¼ è¾“ RDB æ–‡ä»¶ã€‚

ä¸»æœåŠ¡å™¨æ˜¯å¯ä»¥æœ‰å¤šä¸ªä»æœåŠ¡å™¨çš„ï¼Œå¦‚æœä»æœåŠ¡å™¨æ•°é‡éå¸¸å¤šï¼Œè€Œä¸”éƒ½ä¸ä¸»æœåŠ¡å™¨è¿›è¡Œå…¨é‡åŒæ­¥çš„è¯ï¼Œå°±ä¼šå¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š

- ç”±äºæ˜¯é€šè¿‡ bgsave å‘½ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶çš„ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°±ä¼šå¿™äºä½¿ç”¨ fork() åˆ›å»ºå­è¿›ç¨‹ï¼Œå¦‚æœä¸»æœåŠ¡å™¨çš„å†…å­˜æ•°æ®éå¤§ï¼Œåœ¨æ‰§è¡Œ fork() å‡½æ•°æ—¶æ˜¯ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„ï¼Œä»è€Œä½¿å¾— Redis æ— æ³•æ­£å¸¸å¤„ç†è¯·æ±‚ï¼›
- ä¼ è¾“ RDB æ–‡ä»¶ä¼šå ç”¨ä¸»æœåŠ¡å™¨çš„ç½‘ç»œå¸¦å®½ï¼Œä¼šå¯¹ä¸»æœåŠ¡å™¨å“åº”å‘½ä»¤è¯·æ±‚äº§ç”Ÿå½±å“ã€‚

è¿™ç§æƒ…å†µå°±å¥½åƒï¼Œåˆšåˆ›ä¸šçš„å…¬å¸ï¼Œç”±äºäººä¸å¤šï¼Œæ‰€ä»¥å‘˜å·¥éƒ½å½’è€æ¿ä¸€ä¸ªäººç®¡ï¼Œä½†æ˜¯éšç€å…¬å¸çš„å‘å±•ï¼Œäººå‘˜çš„æ‰©å……ï¼Œè€æ¿æ…¢æ…¢å°±æ— æ³•æ‰¿æ‹…å…¨éƒ¨å‘˜å·¥çš„ç®¡ç†å·¥ä½œäº†ã€‚

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè€æ¿å°±éœ€è¦è®¾ç«‹ç»ç†èŒä½ï¼Œç”±ç»ç†ç®¡ç†å¤šåæ™®é€šå‘˜å·¥ï¼Œç„¶åè€æ¿åªéœ€è¦ç®¡ç†ç»ç†å°±å¥½ã€‚

Redis ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä»æœåŠ¡å™¨å¯ä»¥æœ‰è‡ªå·±çš„ä»æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ‹¥æœ‰ä»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨å½“ä½œç»ç†è§’è‰²ï¼Œå®ƒä¸ä»…å¯ä»¥æ¥æ”¶ä¸»æœåŠ¡å™¨çš„åŒæ­¥æ•°æ®ï¼Œè‡ªå·±ä¹Ÿå¯ä»¥åŒæ—¶ä½œä¸ºä¸»æœåŠ¡å™¨çš„å½¢å¼å°†æ•°æ®åŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œç»„ç»‡å½¢å¼å¦‚ä¸‹å›¾ï¼š

![image-20220714220315731](./images/image-20220714220315731.png)

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ**ä¸»æœåŠ¡å™¨ç”Ÿæˆ RDB å’Œä¼ è¾“ RDB çš„å‹åŠ›å¯ä»¥åˆ†æ‘Šåˆ°å……å½“ç»ç†è§’è‰²çš„ä»æœåŠ¡å™¨**ã€‚

é‚£å…·ä½“æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ

å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬åœ¨ã€Œä»æœåŠ¡å™¨ã€ä¸Šæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼Œä½¿å…¶ä½œä¸ºç›®æ ‡æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼š

```text
replicaof <ç›®æ ‡æœåŠ¡å™¨çš„IP> 6379
```

æ­¤æ—¶å¦‚æœç›®æ ‡æœåŠ¡å™¨æœ¬èº«ä¹Ÿæ˜¯ã€Œä»æœåŠ¡å™¨ã€ï¼Œé‚£ä¹ˆè¯¥ç›®æ ‡æœåŠ¡å™¨å°±ä¼šæˆä¸ºã€Œç»ç†ã€çš„è§’è‰²ï¼Œä¸ä»…å¯ä»¥æ¥å—ä¸»æœåŠ¡å™¨åŒæ­¥çš„æ•°æ®ï¼Œä¹Ÿä¼šæŠŠæ•°æ®åŒæ­¥ç»™è‡ªå·±æ——ä¸‹çš„ä»æœåŠ¡å™¨ï¼Œä»è€Œå‡è½»ä¸»æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚

#### å¢é‡å¤åˆ¶

ä¸»ä»æœåŠ¡å™¨åœ¨å®Œæˆç¬¬ä¸€æ¬¡åŒæ­¥åï¼Œå°±ä¼šåŸºäºé•¿è¿æ¥è¿›è¡Œå‘½ä»¤ä¼ æ’­ã€‚

å¯æ˜¯ï¼Œç½‘ç»œæ€»æ˜¯ä¸æŒ‰å¥—è·¯å‡ºç‰Œçš„å˜›ï¼Œè¯´å»¶è¿Ÿå°±å»¶è¿Ÿï¼Œè¯´æ–­å¼€å°±æ–­å¼€ã€‚

å¦‚æœä¸»ä»æœåŠ¡å™¨é—´çš„ç½‘ç»œè¿æ¥æ–­å¼€äº†ï¼Œé‚£ä¹ˆå°±æ— æ³•è¿›è¡Œå‘½ä»¤ä¼ æ’­äº†ï¼Œè¿™æ—¶ä»æœåŠ¡å™¨çš„æ•°æ®å°±æ²¡åŠæ³•å’Œä¸»æœåŠ¡å™¨ä¿æŒä¸€è‡´äº†ï¼Œå®¢æˆ·ç«¯å°±å¯èƒ½ä»ã€Œä»æœåŠ¡å™¨ã€è¯»åˆ°æ—§çš„æ•°æ®ã€‚

![image-20220714220333043](./images/image-20220714220333043.png)

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœæ­¤æ—¶æ–­å¼€çš„ç½‘ç»œï¼Œåˆæ¢å¤æ­£å¸¸äº†ï¼Œè¦æ€ä¹ˆç»§ç»­ä¿è¯ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§å‘¢ï¼Ÿ

åœ¨ Redis 2.8 ä¹‹å‰ï¼Œå¦‚æœä¸»ä»æœåŠ¡å™¨åœ¨å‘½ä»¤åŒæ­¥æ—¶å‡ºç°äº†ç½‘ç»œæ–­å¼€åˆæ¢å¤çš„æƒ…å†µï¼Œä»æœåŠ¡å™¨å°±ä¼šå’Œä¸»æœåŠ¡å™¨é‡æ–°è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œå¾ˆæ˜æ˜¾è¿™æ ·çš„å¼€é”€å¤ªå¤§äº†ï¼Œå¿…é¡»è¦æ”¹è¿›ä¸€æ³¢ã€‚

æ‰€ä»¥ï¼Œä» Redis 2.8 å¼€å§‹ï¼Œç½‘ç»œæ–­å¼€åˆæ¢å¤åï¼Œä»ä¸»ä»æœåŠ¡å™¨ä¼šé‡‡ç”¨**å¢é‡å¤åˆ¶**çš„æ–¹å¼ç»§ç»­åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯åªä¼šæŠŠç½‘ç»œæ–­å¼€æœŸé—´ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å†™æ“ä½œå‘½ä»¤ï¼ŒåŒæ­¥ç»™ä»æœåŠ¡å™¨ã€‚

ç½‘ç»œæ¢å¤åçš„å¢é‡å¤åˆ¶è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![image-20220714220340040](./images/image-20220714220340040.png)

ä¸»è¦æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š

- ä»æœåŠ¡å™¨åœ¨æ¢å¤ç½‘ç»œåï¼Œä¼šå‘é€ psync å‘½ä»¤ç»™ä¸»æœåŠ¡å™¨ï¼Œæ­¤æ—¶çš„ psync å‘½ä»¤é‡Œçš„ offset å‚æ•°ä¸æ˜¯ -1ï¼›
- ä¸»æœåŠ¡å™¨æ”¶åˆ°è¯¥å‘½ä»¤åï¼Œç„¶åç”¨ CONTINUE å“åº”å‘½ä»¤å‘Šè¯‰ä»æœåŠ¡å™¨æ¥ä¸‹æ¥é‡‡ç”¨å¢é‡å¤åˆ¶çš„æ–¹å¼åŒæ­¥æ•°æ®ï¼›
- ç„¶åä¸»æœåŠ¡å°†ä¸»ä»æœåŠ¡å™¨æ–­çº¿æœŸé—´ï¼Œæ‰€æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åä»æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚

é‚£ä¹ˆå…³é”®çš„é—®é¢˜æ¥äº†ï¼Œ**ä¸»æœåŠ¡å™¨æ€ä¹ˆçŸ¥é“è¦å°†å“ªäº›å¢é‡æ•°æ®å‘é€ç»™ä»æœåŠ¡å™¨å‘¢ï¼Ÿ**

ç­”æ¡ˆè—åœ¨è¿™ä¸¤ä¸ªä¸œè¥¿é‡Œï¼š

- **repl_backlog_buffer**ï¼Œæ˜¯ä¸€ä¸ªã€Œ**ç¯å½¢**ã€ç¼“å†²åŒºï¼Œç”¨äºä¸»ä»æœåŠ¡å™¨æ–­è¿åï¼Œä»ä¸­æ‰¾åˆ°å·®å¼‚çš„æ•°æ®ï¼›
- **replication offset**ï¼Œæ ‡è®°ä¸Šé¢é‚£ä¸ªç¼“å†²åŒºçš„åŒæ­¥è¿›åº¦ï¼Œä¸»ä»æœåŠ¡å™¨éƒ½æœ‰å„è‡ªçš„åç§»é‡ï¼Œä¸»æœåŠ¡å™¨ä½¿ç”¨ master_repl_offset æ¥è®°å½•è‡ªå·±ã€Œ*å†™*ã€åˆ°çš„ä½ç½®ï¼Œä»æœåŠ¡å™¨ä½¿ç”¨ slave_repl_offset æ¥è®°å½•è‡ªå·±ã€Œ*è¯»*ã€åˆ°çš„ä½ç½®ã€‚

é‚£repl_backlog_buffer ç¼“å†²åŒºæ˜¯ä»€ä¹ˆæ—¶å€™å†™å…¥çš„å‘¢ï¼Ÿ

åœ¨ä¸»æœåŠ¡å™¨è¿›è¡Œå‘½ä»¤ä¼ æ’­æ—¶ï¼Œä¸ä»…ä¼šå°†å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè¿˜ä¼šå°†å†™å‘½ä»¤å†™å…¥åˆ° repl_backlog_buffer ç¼“å†²åŒºé‡Œï¼Œå› æ­¤ è¿™ä¸ªç¼“å†²åŒºé‡Œä¼šä¿å­˜ç€æœ€è¿‘ä¼ æ’­çš„å†™å‘½ä»¤ã€‚

ç½‘ç»œæ–­å¼€åï¼Œå½“ä»æœåŠ¡å™¨é‡æ–°è¿ä¸Šä¸»æœåŠ¡å™¨æ—¶ï¼Œä»æœåŠ¡å™¨ä¼šé€šè¿‡ psync å‘½ä»¤å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡ slave_repl_offset å‘é€ç»™ä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨æ ¹æ®è‡ªå·±çš„  master_repl_offset å’Œ slave_repl_offset ä¹‹é—´çš„å·®è·ï¼Œç„¶åæ¥å†³å®šå¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå“ªç§åŒæ­¥æ“ä½œï¼š

- å¦‚æœåˆ¤æ–­å‡ºä»æœåŠ¡å™¨è¦è¯»å–çš„æ•°æ®è¿˜åœ¨ repl_backlog_buffer ç¼“å†²åŒºé‡Œï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†é‡‡ç”¨**å¢é‡åŒæ­¥**çš„æ–¹å¼ï¼›
- ç›¸åï¼Œå¦‚æœåˆ¤æ–­å‡ºä»æœåŠ¡å™¨è¦è¯»å–çš„æ•°æ®å·²ç»ä¸å­˜åœ¨ repl_backlog_buffer ç¼“å†²åŒºé‡Œï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†é‡‡ç”¨**å…¨é‡åŒæ­¥**çš„æ–¹å¼ã€‚

å½“ä¸»æœåŠ¡å™¨åœ¨ repl_backlog_buffer ä¸­æ‰¾åˆ°ä¸»ä»æœåŠ¡å™¨å·®å¼‚ï¼ˆå¢é‡ï¼‰çš„æ•°æ®åï¼Œå°±ä¼šå°†å¢é‡çš„æ•°æ®å†™å…¥åˆ° replication buffer ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºæˆ‘ä»¬å‰é¢ä¹Ÿæåˆ°è¿‡ï¼Œå®ƒæ˜¯ç¼“å­˜å°†è¦ä¼ æ’­ç»™ä»æœåŠ¡å™¨çš„å‘½ä»¤ã€‚

![image-20220714220348740](./images/image-20220714220348740.png)

repl_backlog_buffer ç¼“è¡Œç¼“å†²åŒºçš„é»˜è®¤å¤§å°æ˜¯ 1Mï¼Œå¹¶ä¸”ç”±äºå®ƒæ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œæ‰€ä»¥å½“ç¼“å†²åŒºå†™æ»¡åï¼Œä¸»æœåŠ¡å™¨ç»§ç»­å†™å…¥çš„è¯ï¼Œå°±ä¼šè¦†ç›–ä¹‹å‰çš„æ•°æ®ã€‚

å› æ­¤ï¼Œå½“ä¸»æœåŠ¡å™¨çš„å†™å…¥é€Ÿåº¦è¿œè¶…äºä»æœåŠ¡å™¨çš„è¯»å–é€Ÿåº¦ï¼Œç¼“å†²åŒºçš„æ•°æ®ä¸€ä¸‹å°±ä¼šè¢«è¦†ç›–ã€‚

é‚£ä¹ˆåœ¨ç½‘ç»œæ¢å¤æ—¶ï¼Œå¦‚æœä»æœåŠ¡å™¨æƒ³è¯»çš„æ•°æ®å·²ç»è¢«è¦†ç›–äº†ï¼Œä¸»æœåŠ¡å™¨å°±ä¼šé‡‡ç”¨å…¨é‡åŒæ­¥ï¼Œè¿™ä¸ªæ–¹å¼æ¯”å¢é‡åŒæ­¥çš„æ€§èƒ½æŸè€—è¦å¤§å¾ˆå¤šã€‚

å› æ­¤ï¼Œä¸ºäº†é¿å…åœ¨ç½‘ç»œæ¢å¤æ—¶ï¼Œä¸»æœåŠ¡å™¨é¢‘ç¹åœ°ä½¿ç”¨å…¨é‡åŒæ­¥çš„æ–¹å¼ï¼Œæˆ‘ä»¬åº”è¯¥è°ƒæ•´ä¸‹ repl_backlog_buffer ç¼“å†²åŒºå¤§å°ï¼Œå°½å¯èƒ½çš„å¤§ä¸€äº›ï¼Œå‡å°‘å‡ºç°ä»æœåŠ¡å™¨è¦è¯»å–çš„æ•°æ®è¢«è¦†ç›–çš„æ¦‚ç‡ï¼Œä»è€Œä½¿å¾—ä¸»æœåŠ¡å™¨é‡‡ç”¨å¢é‡åŒæ­¥çš„æ–¹å¼ã€‚

é‚£ repl_backlog_buffer ç¼“å†²åŒºå…·ä½“è¦è°ƒæ•´åˆ°å¤šå¤§å‘¢ï¼Ÿ

repl_backlog_buffer æœ€å°çš„å¤§å°å¯ä»¥æ ¹æ®è¿™é¢è¿™ä¸ªå…¬å¼ä¼°ç®—ã€‚

![image-20220714220356331](./images/image-20220714220356331.png)

æˆ‘æ¥è§£é‡Šä¸‹è¿™ä¸ªå…¬å¼çš„æ„æ€ï¼š

- second ä¸ºä»æœåŠ¡å™¨æ–­çº¿åé‡æ–°è¿æ¥ä¸Šä¸»æœåŠ¡å™¨æ‰€éœ€çš„å¹³å‡ æ—¶é—´(ä»¥ç§’è®¡ç®—)ã€‚
- write_size_per_second åˆ™æ˜¯ä¸»æœåŠ¡å™¨å¹³å‡æ¯ç§’äº§ç”Ÿçš„å†™å‘½ä»¤æ•°æ®é‡å¤§å°ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸»æœåŠ¡å™¨å¹³å‡æ¯ç§’äº§ç”Ÿ 1 MB çš„å†™å‘½ä»¤ï¼Œè€Œä»æœåŠ¡å™¨æ–­çº¿ä¹‹åå¹³å‡è¦ 5 ç§’æ‰èƒ½é‡æ–°è¿æ¥ä¸»æœåŠ¡å™¨ã€‚

é‚£ä¹ˆ repl_backlog_buffer å¤§å°å°±ä¸èƒ½ä½äº 5 MBï¼Œå¦åˆ™æ–°å†™åœ°å‘½ä»¤å°±ä¼šè¦†ç›–æ—§æ•°æ®äº†ã€‚

å½“ç„¶ï¼Œä¸ºäº†åº”å¯¹ä¸€äº›çªå‘çš„æƒ…å†µï¼Œå¯ä»¥å°† repl_backlog_buffer çš„å¤§å°è®¾ç½®ä¸ºæ­¤åŸºç¡€ä¸Šçš„ 2 å€ï¼Œä¹Ÿå°±æ˜¯ 10 MBã€‚

å…³äº repl_backlog_buffer å¤§å°ä¿®æ”¹çš„æ–¹æ³•ï¼Œåªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶é‡Œä¸‹é¢è¿™ä¸ªå‚æ•°é¡¹çš„å€¼å°±å¯ä»¥ã€‚

```shell
repl-backlog-size 1mb
```

#### æ€»ç»“

ä¸»ä»å¤åˆ¶å…±æœ‰ä¸‰ç§æ¨¡å¼ï¼š**å…¨é‡å¤åˆ¶ã€åŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ã€å¢é‡å¤åˆ¶**ã€‚

ä¸»ä»æœåŠ¡å™¨ç¬¬ä¸€æ¬¡åŒæ­¥çš„æ—¶å€™ï¼Œå°±æ˜¯é‡‡ç”¨å…¨é‡å¤åˆ¶ï¼Œæ­¤æ—¶ä¸»æœåŠ¡å™¨ä¼šä¸¤ä¸ªè€—æ—¶çš„åœ°æ–¹ï¼Œåˆ†åˆ«æ˜¯ç”Ÿæˆ RDB æ–‡ä»¶å’Œä¼ è¾“ RDB  æ–‡ä»¶ã€‚ä¸ºäº†é¿å…è¿‡å¤šçš„ä»æœåŠ¡å™¨å’Œä¸»æœåŠ¡å™¨è¿›è¡Œå…¨é‡å¤åˆ¶ï¼Œå¯ä»¥æŠŠä¸€éƒ¨åˆ†ä»æœåŠ¡å™¨å‡çº§ä¸ºã€Œç»ç†è§’è‰²ã€ï¼Œè®©å®ƒä¹Ÿæœ‰è‡ªå·±çš„ä»æœåŠ¡å™¨ï¼Œé€šè¿‡è¿™æ ·å¯ä»¥åˆ†æ‘Šä¸»æœåŠ¡å™¨çš„å‹åŠ›ã€‚

ç¬¬ä¸€æ¬¡åŒæ­¥å®Œæˆåï¼Œä¸»ä»æœåŠ¡å™¨éƒ½ä¼šç»´æŠ¤ç€ä¸€ä¸ªé•¿è¿æ¥ï¼Œä¸»æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°å†™æ“ä½œå‘½ä»¤åï¼Œå°±ä¼šé€šè¿‡è¿™ä¸ªè¿æ¥å°†å†™å‘½ä»¤ä¼ æ’­ç»™ä»æœåŠ¡å™¨ï¼Œæ¥ä¿è¯ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§ã€‚

å¦‚æœé‡åˆ°ç½‘ç»œæ–­å¼€ï¼Œå¢é‡å¤åˆ¶å°±å¯ä»¥ä¸Šåœºäº†ï¼Œä¸è¿‡è¿™ä¸ªè¿˜è·Ÿ repl_backlog_size è¿™ä¸ªå¤§å°æœ‰å…³ç³»ã€‚

å¦‚æœå®ƒé…ç½®çš„è¿‡å°ï¼Œä¸»ä»æœåŠ¡å™¨ç½‘ç»œæ¢å¤æ—¶ï¼Œå¯èƒ½å‘ç”Ÿã€Œä»æœåŠ¡å™¨ã€æƒ³è¯»çš„æ•°æ®å·²ç»è¢«è¦†ç›–äº†ï¼Œé‚£ä¹ˆè¿™æ—¶å°±ä¼šå¯¼è‡´ä¸»æœåŠ¡å™¨é‡‡ç”¨å…¨é‡å¤åˆ¶çš„æ–¹å¼ã€‚æ‰€ä»¥ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„é¢‘ç¹å‘ç”Ÿï¼Œè¦è°ƒå¤§è¿™ä¸ªå‚æ•°çš„å€¼ï¼Œä»¥é™ä½ä¸»ä»æœåŠ¡å™¨æ–­å¼€åå…¨é‡åŒæ­¥çš„æ¦‚ç‡ã€‚

### Sentinelï¼ˆå“¨å…µï¼‰  æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ

> Redis Sentinelï¼Œå³Rediså“¨å…µï¼Œåœ¨Redis 2.8ç‰ˆæœ¬å¼€å§‹å¼•å…¥ã€‚å“¨å…µçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä¸»èŠ‚ç‚¹çš„è‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

ä¸‹å›¾æ˜¯ä¸€ä¸ªå…¸å‹çš„å“¨å…µé›†ç¾¤ç›‘æ§çš„é€»è¾‘å›¾ï¼š

![image-20220617154744863](./images/image-20220617154744863.png)

å“¨å…µå®ç°äº†ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿä¸‹é¢æ˜¯Rediså®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼š

- **ç›‘æ§ï¼ˆMonitoringï¼‰**ï¼šå“¨å…µä¼šä¸æ–­åœ°æ£€æŸ¥ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹æ˜¯å¦è¿ä½œæ­£å¸¸ã€‚
- **è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆAutomatic failoverï¼‰**ï¼šå½“ä¸»èŠ‚ç‚¹ä¸èƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼Œå“¨å…µä¼šå¼€å§‹è‡ªåŠ¨æ•…éšœè½¬ç§»æ“ä½œï¼Œå®ƒä¼šå°†å¤±æ•ˆä¸»èŠ‚ç‚¹çš„å…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶è®©å…¶ä»–ä»èŠ‚ç‚¹æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹ã€‚
- **é…ç½®æä¾›è€…ï¼ˆConfiguration providerï¼‰**ï¼šå®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡è¿æ¥å“¨å…µæ¥è·å¾—å½“å‰RedisæœåŠ¡çš„ä¸»èŠ‚ç‚¹åœ°å€ã€‚
- **é€šçŸ¥ï¼ˆNotificationï¼‰**ï¼šå“¨å…µå¯ä»¥å°†æ•…éšœè½¬ç§»çš„ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚

å…¶ä¸­ï¼Œç›‘æ§å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œä½¿å¾—å“¨å…µå¯ä»¥åŠæ—¶å‘ç°ä¸»èŠ‚ç‚¹æ•…éšœå¹¶å®Œæˆè½¬ç§»ï¼›è€Œé…ç½®æä¾›è€…å’Œé€šçŸ¥åŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨ä¸å®¢æˆ·ç«¯çš„äº¤äº’ä¸­æ‰èƒ½ä½“ç°ã€‚

### ä¸ºä»€ä¹ˆè¦å“¨å…µï¼Ÿ

åœ¨ Redis çš„ä¸»ä»æ¶æ„ä¸­ï¼Œç”±äºä¸»ä»æ¨¡å¼æ˜¯è¯»å†™åˆ†ç¦»çš„ï¼Œå¦‚æœä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰æŒ‚äº†ï¼Œé‚£ä¹ˆå°†æ²¡æœ‰ä¸»èŠ‚ç‚¹æ¥æœåŠ¡å®¢æˆ·ç«¯çš„å†™æ“ä½œè¯·æ±‚ï¼Œä¹Ÿæ²¡æœ‰ä¸»èŠ‚ç‚¹ç»™ä»èŠ‚ç‚¹ï¼ˆslaveï¼‰è¿›è¡Œæ•°æ®åŒæ­¥äº†ã€‚

![image-20220714220520655](./images/image-20220714220520655.png)

è¿™æ—¶å¦‚æœè¦æ¢å¤æœåŠ¡çš„è¯ï¼Œéœ€è¦äººå·¥ä»‹å…¥ï¼Œé€‰æ‹©ä¸€ä¸ªã€Œä»èŠ‚ç‚¹ã€åˆ‡æ¢ä¸ºã€Œä¸»èŠ‚ç‚¹ã€ï¼Œç„¶åè®©å…¶ä»–ä»èŠ‚ç‚¹æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶è¿˜éœ€è¦é€šçŸ¥ä¸Šæ¸¸é‚£äº›è¿æ¥ Redis ä¸»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ï¼Œå°†å…¶é…ç½®ä¸­çš„ä¸»èŠ‚ç‚¹ IP åœ°å€æ›´æ–°ä¸ºã€Œæ–°ä¸»èŠ‚ç‚¹ã€çš„ IP åœ°å€ã€‚

è¿™æ ·ä¹Ÿä¸å¤ªâ€œæ™ºèƒ½â€äº†ï¼Œè¦æ˜¯æœ‰ä¸€ä¸ªèŠ‚ç‚¹èƒ½ç›‘æ§ã€Œä¸»èŠ‚ç‚¹ã€çš„çŠ¶æ€ï¼Œå½“å‘ç°ä¸»èŠ‚ç‚¹æŒ‚äº† ï¼Œå®ƒè‡ªåŠ¨å°†ä¸€ä¸ªã€Œä»èŠ‚ç‚¹ã€åˆ‡æ¢ä¸ºã€Œä¸»èŠ‚ç‚¹ã€çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥èŠ‚çœæˆ‘ä»¬å¾ˆå¤šäº‹æƒ…å•Šï¼

Redis åœ¨ 2.8 ç‰ˆæœ¬ä»¥åæä¾›çš„**å“¨å…µï¼ˆ\*Sentinel\*ï¼‰æœºåˆ¶**ï¼Œå®ƒçš„ä½œç”¨æ˜¯å®ç°**ä¸»ä»èŠ‚ç‚¹æ•…éšœè½¬ç§»**ã€‚å®ƒä¼šç›‘æµ‹ä¸»èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœå‘ç°ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå®ƒå°±ä¼šé€‰ä¸¾ä¸€ä¸ªä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠŠæ–°ä¸»èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯é€šçŸ¥ç»™ä»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯ã€‚

#### å“¨å…µæœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

å“¨å…µå…¶å®æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„ Redis è¿›ç¨‹ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚ä»â€œå“¨å…µâ€è¿™ä¸ªåå­—ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå®ƒç›¸å½“äºæ˜¯â€œè§‚å¯Ÿè€…èŠ‚ç‚¹â€ï¼Œè§‚å¯Ÿçš„å¯¹è±¡æ˜¯ä¸»ä»èŠ‚ç‚¹ã€‚

å½“ç„¶ï¼Œå®ƒä¸ä»…ä»…æ˜¯è§‚å¯Ÿé‚£ä¹ˆç®€å•ï¼Œåœ¨å®ƒè§‚å¯Ÿåˆ°æœ‰å¼‚å¸¸çš„çŠ¶å†µä¸‹ï¼Œä¼šåšå‡ºä¸€äº›â€œåŠ¨ä½œâ€ï¼Œæ¥ä¿®å¤å¼‚å¸¸çŠ¶æ€ã€‚

å“¨å…µèŠ‚ç‚¹ä¸»è¦è´Ÿè´£ä¸‰ä»¶äº‹æƒ…ï¼š**ç›‘æ§ã€é€‰ä¸»ã€é€šçŸ¥**ã€‚

![image-20220714220539777](./images/image-20220714220539777.png)

æ‰€ä»¥ï¼Œæˆ‘ä»¬é‡ç‚¹è¦å­¦ä¹ è¿™ä¸‰ä»¶äº‹æƒ…ï¼š

- å“¨å…µèŠ‚ç‚¹æ˜¯å¦‚ä½•ç›‘æ§èŠ‚ç‚¹çš„ï¼Ÿåˆæ˜¯å¦‚ä½•åˆ¤æ–­ä¸»èŠ‚ç‚¹æ˜¯å¦çœŸçš„æ•…éšœäº†ï¼Ÿ
- æ ¹æ®ä»€ä¹ˆè§„åˆ™é€‰æ‹©ä¸€ä¸ªä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Ÿ
- æ€ä¹ˆæŠŠæ–°ä¸»èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯é€šçŸ¥ç»™ä»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯å‘¢ï¼Ÿ

#### å¦‚ä½•åˆ¤æ–­ä¸»èŠ‚ç‚¹çœŸçš„æ•…éšœäº†ï¼Ÿ

å“¨å…µä¼šæ¯éš” 1 ç§’ç»™æ‰€æœ‰ä¸»ä»èŠ‚ç‚¹å‘é€ PING å‘½ä»¤ï¼Œå½“ä¸»ä»èŠ‚ç‚¹æ”¶åˆ° PING å‘½ä»¤åï¼Œä¼šå‘é€ä¸€ä¸ªå“åº”å‘½ä»¤ç»™å“¨å…µï¼Œè¿™æ ·å°±å¯ä»¥åˆ¤æ–­å®ƒä»¬æ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œã€‚

![image-20220714220557761](./images/image-20220714220557761.png)

å¦‚æœä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹æ²¡æœ‰åœ¨è§„å®šçš„æ—¶é—´å†…å“åº”å“¨å…µçš„ PING å‘½ä»¤ï¼Œå“¨å…µå°±ä¼šå°†å®ƒä»¬æ ‡è®°ä¸ºã€Œ**ä¸»è§‚ä¸‹çº¿**ã€ã€‚è¿™ä¸ªã€Œè§„å®šçš„æ—¶é—´ã€æ˜¯é…ç½®é¡¹  `down-after-milliseconds` å‚æ•°è®¾å®šçš„ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚

> ä¸»è§‚ä¸‹çº¿ï¼Ÿéš¾é“è¿˜æœ‰å®¢è§‚ä¸‹çº¿ï¼Ÿ

æ˜¯çš„æ²¡é”™ï¼Œå®¢è§‚ä¸‹çº¿åªé€‚ç”¨äºä¸»èŠ‚ç‚¹ã€‚

ä¹‹æ‰€ä»¥é’ˆå¯¹ã€Œä¸»èŠ‚ç‚¹ã€è®¾è®¡ã€Œä¸»è§‚ä¸‹çº¿ã€å’Œã€Œå®¢è§‚ä¸‹çº¿ã€ä¸¤ä¸ªçŠ¶æ€ï¼Œæ˜¯å› ä¸ºæœ‰å¯èƒ½ã€Œä¸»èŠ‚ç‚¹ã€å…¶å®å¹¶æ²¡æœ‰æ•…éšœï¼Œå¯èƒ½åªæ˜¯å› ä¸ºä¸»èŠ‚ç‚¹çš„ç³»ç»Ÿå‹åŠ›æ¯”è¾ƒå¤§æˆ–è€…ç½‘ç»œå‘é€äº†æ‹¥å¡ï¼Œå¯¼è‡´ä¸»èŠ‚ç‚¹æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”å“¨å…µçš„ PING å‘½ä»¤ã€‚

æ‰€ä»¥ï¼Œä¸ºäº†å‡å°‘è¯¯åˆ¤çš„æƒ…å†µï¼Œå“¨å…µåœ¨éƒ¨ç½²çš„æ—¶å€™ä¸ä¼šåªéƒ¨ç½²ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œæ˜¯ç”¨å¤šä¸ªèŠ‚ç‚¹éƒ¨ç½²æˆ**å“¨å…µé›†ç¾¤**ï¼ˆ*æœ€å°‘éœ€è¦ä¸‰å°æœºå™¨æ¥éƒ¨ç½²å“¨å…µé›†ç¾¤*ï¼‰ï¼Œ**é€šè¿‡å¤šä¸ªå“¨å…µèŠ‚ç‚¹ä¸€èµ·åˆ¤æ–­ï¼Œå°±å¯ä»¥å°±å¯ä»¥é¿å…å•ä¸ªå“¨å…µå› ä¸ºè‡ªèº«ç½‘ç»œçŠ¶å†µä¸å¥½ï¼Œè€Œè¯¯åˆ¤ä¸»èŠ‚ç‚¹ä¸‹çº¿çš„æƒ…å†µ**ã€‚åŒæ—¶ï¼Œå¤šä¸ªå“¨å…µçš„ç½‘ç»œåŒæ—¶ä¸ç¨³å®šçš„æ¦‚ç‡è¾ƒå°ï¼Œç”±å®ƒä»¬ä¸€èµ·åšå†³ç­–ï¼Œè¯¯åˆ¤ç‡ä¹Ÿèƒ½é™ä½ã€‚

å…·ä½“æ˜¯æ€ä¹ˆåˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€çš„å‘¢ï¼Ÿ

å½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸ºã€Œä¸»è§‚ä¸‹çº¿ã€åï¼Œå°±ä¼šå‘å…¶ä»–å“¨å…µå‘èµ·å‘½ä»¤ï¼Œå…¶ä»–å“¨å…µæ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæ ¹æ®è‡ªèº«å’Œä¸»èŠ‚ç‚¹çš„ç½‘ç»œçŠ¶å†µï¼Œåšå‡ºèµæˆæŠ•ç¥¨æˆ–è€…æ‹’ç»æŠ•ç¥¨çš„å“åº”ã€‚

![image-20220714220606567](./images/image-20220714220606567.png)

å½“è¿™ä¸ªå“¨å…µçš„èµåŒç¥¨æ•°è¾¾åˆ°å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum é…ç½®é¡¹è®¾å®šçš„å€¼åï¼Œè¿™æ—¶ä¸»èŠ‚ç‚¹å°±ä¼šè¢«è¯¥å“¨å…µæ ‡è®°ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ã€‚

ä¾‹å¦‚ï¼Œç°åœ¨æœ‰ 3 ä¸ªå“¨å…µï¼Œquorum é…ç½®çš„æ˜¯ 2ï¼Œé‚£ä¹ˆä¸€ä¸ªå“¨å…µéœ€è¦ 2 å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥æ ‡è®°ä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€äº†ã€‚è¿™ 2 å¼ èµæˆç¥¨åŒ…æ‹¬å“¨å…µè‡ªå·±çš„ä¸€å¼ èµæˆç¥¨å’Œå¦å¤–ä¸¤ä¸ªå“¨å…µçš„èµæˆç¥¨ã€‚

PSï¼šquorum çš„å€¼ä¸€èˆ¬è®¾ç½®ä¸ºå“¨å…µä¸ªæ•°çš„äºŒåˆ†ä¹‹ä¸€åŠ 1ï¼Œä¾‹å¦‚ 3 ä¸ªå“¨å…µå°±è®¾ç½® 2ã€‚

å“¨å…µåˆ¤æ–­å®Œä¸»èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿åï¼Œå“¨å…µå°±è¦å¼€å§‹åœ¨å¤šä¸ªã€Œä»èŠ‚ç‚¹ã€ä¸­ï¼Œé€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹æ¥åšæ–°ä¸»èŠ‚ç‚¹ã€‚

#### ç”±å“ªä¸ªå“¨å…µè¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»ï¼Ÿ

å‰é¢è¯´è¿‡ï¼Œä¸ºäº†æ›´åŠ â€œå®¢è§‚â€çš„åˆ¤æ–­ä¸»èŠ‚ç‚¹æ•…éšœäº†ï¼Œä¸€èˆ¬ä¸ä¼šåªç”±å•ä¸ªå“¨å…µçš„æ£€æµ‹ç»“æœæ¥åˆ¤æ–­ï¼Œè€Œæ˜¯å¤šä¸ªå“¨å…µä¸€èµ·åˆ¤æ–­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¯¯åˆ¤æ¦‚ç‡ï¼Œæ‰€ä»¥**å“¨å…µæ˜¯ä»¥å“¨å…µé›†ç¾¤çš„æ–¹å¼å­˜åœ¨çš„**ã€‚

é—®é¢˜æ¥äº†ï¼Œç”±å“¨å…µé›†ç¾¤ä¸­çš„å“ªä¸ªèŠ‚ç‚¹è¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»å‘¢ï¼Ÿ

æ‰€ä»¥è¿™æ—¶å€™ï¼Œè¿˜éœ€è¦åœ¨å“¨å…µé›†ç¾¤ä¸­é€‰å‡ºä¸€ä¸ª leederï¼Œè®© leeder æ¥æ‰§è¡Œä¸»ä»åˆ‡æ¢ã€‚

é€‰ä¸¾ leeder çš„è¿‡ç¨‹å…¶å®æ˜¯ä¸€ä¸ªæŠ•ç¥¨çš„è¿‡ç¨‹ï¼Œåœ¨æŠ•ç¥¨å¼€å§‹å‰ï¼Œè‚¯å®šå¾—æœ‰ä¸ªã€Œå€™é€‰è€…ã€ã€‚

> é‚£è°æ¥ä½œä¸ºå€™é€‰è€…å‘¢ï¼Ÿ

å“ªä¸ªå“¨å…µèŠ‚ç‚¹åˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ï¼Œè¿™ä¸ªå“¨å…µèŠ‚ç‚¹å°±æ˜¯å€™é€‰è€…ï¼Œæ‰€è°“çš„å€™é€‰è€…å°±æ˜¯æƒ³å½“ Leader çš„å“¨å…µã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸‰ä¸ªå“¨å…µã€‚å½“å“¨å…µ B å…ˆåˆ¤æ–­åˆ°ä¸»èŠ‚ç‚¹ã€Œä¸»è§‚ä¸‹çº¿åã€ï¼Œå°±ä¼šç»™å…¶ä»–å®ä¾‹å‘é€ is-master-down-by-addr å‘½ä»¤ã€‚æ¥ç€ï¼Œå…¶ä»–å“¨å…µä¼šæ ¹æ®è‡ªå·±å’Œä¸»èŠ‚ç‚¹çš„ç½‘ç»œè¿æ¥æƒ…å†µï¼Œåšå‡ºèµæˆæŠ•ç¥¨æˆ–è€…æ‹’ç»æŠ•ç¥¨çš„å“åº”ã€‚

![image-20220714220628098](./images/image-20220714220628098.png)

å½“å“¨å…µ B æ”¶åˆ°èµæˆç¥¨æ•°è¾¾åˆ°å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum é…ç½®é¡¹è®¾å®šçš„å€¼åï¼Œå°±ä¼šå°†ä¸»èŠ‚ç‚¹æ ‡è®°ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ï¼Œæ­¤æ—¶çš„å“¨å…µ B å°±æ˜¯ä¸€ä¸ªLeader å€™é€‰è€…ã€‚

> å€™é€‰è€…å¦‚ä½•é€‰ä¸¾æˆä¸º Leaderï¼Ÿ

å€™é€‰è€…ä¼šå‘å…¶ä»–å“¨å…µå‘é€å‘½ä»¤ï¼Œè¡¨æ˜å¸Œæœ›æˆä¸º Leader æ¥æ‰§è¡Œä¸»ä»åˆ‡æ¢ï¼Œå¹¶è®©æ‰€æœ‰å…¶ä»–å“¨å…µå¯¹å®ƒè¿›è¡ŒæŠ•ç¥¨ã€‚

æ¯ä¸ªå“¨å…µåªæœ‰ä¸€æ¬¡æŠ•ç¥¨æœºä¼šï¼Œå¦‚æœç”¨å®Œåå°±ä¸èƒ½å‚ä¸æŠ•ç¥¨äº†ï¼Œå¯ä»¥æŠ•ç»™è‡ªå·±æˆ–æŠ•ç»™åˆ«äººï¼Œä½†æ˜¯åªæœ‰å€™é€‰è€…æ‰èƒ½æŠŠç¥¨æŠ•ç»™è‡ªå·±ã€‚

é‚£ä¹ˆåœ¨æŠ•ç¥¨è¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªã€Œå€™é€‰è€…ã€ï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

- ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›
- ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾å“¨å…µèŠ‚ç‚¹æœ‰  3 ä¸ªï¼Œquorum è®¾ç½®ä¸º 2ï¼Œé‚£ä¹ˆä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º Leader çš„å“¨å…µåªè¦æ‹¿åˆ° 2 å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥é€‰ä¸¾æˆåŠŸäº†ã€‚å¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶ï¼Œå°±éœ€è¦é‡æ–°è¿›è¡Œé€‰ä¸¾ã€‚

è¿™æ—¶å€™æœ‰çš„åŒå­¦å°±ä¼šé—®äº†ï¼Œå¦‚æœæŸä¸ªæ—¶é—´ç‚¹ï¼Œåˆšå¥½æœ‰ä¸¤ä¸ªå“¨å…µèŠ‚ç‚¹åˆ¤æ–­åˆ°ä¸»èŠ‚ç‚¹ä¸ºå®¢è§‚ä¸‹çº¿ï¼Œé‚£è¿™æ—¶ä¸å°±æœ‰ä¸¤ä¸ªå€™é€‰è€…äº†ï¼Ÿè¿™æ—¶è¯¥å¦‚ä½•å†³å®šè°æ˜¯ Leader å‘¢ï¼Ÿ

æ¯ä½å€™é€‰è€…éƒ½ä¼šå…ˆç»™è‡ªå·±æŠ•ä¸€ç¥¨ï¼Œç„¶åå‘å…¶ä»–å“¨å…µå‘èµ·æŠ•ç¥¨è¯·æ±‚ã€‚å¦‚æœæŠ•ç¥¨è€…å…ˆæ”¶åˆ°ã€Œå€™é€‰è€… Aã€çš„æŠ•ç¥¨è¯·æ±‚ï¼Œå°±ä¼šå…ˆæŠ•ç¥¨ç»™å®ƒï¼Œå¦‚æœæŠ•ç¥¨è€…ç”¨å®ŒæŠ•ç¥¨æœºä¼šåï¼Œæ”¶åˆ°ã€Œå€™é€‰è€… Bã€çš„æŠ•ç¥¨è¯·æ±‚åï¼Œå°±ä¼šæ‹’ç»æŠ•ç¥¨ã€‚è¿™æ—¶ï¼Œå€™é€‰è€… A  å…ˆæ»¡è¶³äº†ä¸Šé¢çš„é‚£ä¸¤ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥ã€Œå€™é€‰è€… Aã€å°±ä¼šè¢«é€‰ä¸¾ä¸º Leaderã€‚

> ä¸ºä»€ä¹ˆå“¨å…µèŠ‚ç‚¹è‡³å°‘è¦æœ‰ 3 ä¸ªï¼Ÿ

å¦‚æœå“¨å…µé›†ç¾¤ä¸­åªæœ‰ 2 ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œæ­¤æ—¶å¦‚æœä¸€ä¸ªå“¨å…µæƒ³è¦æˆåŠŸæˆä¸º Leaderï¼Œå¿…é¡»è·å¾— 2 ç¥¨ï¼Œè€Œä¸æ˜¯ 1 ç¥¨ã€‚

æ‰€ä»¥ï¼Œå¦‚æœå“¨å…µé›†ç¾¤ä¸­æœ‰ä¸ªå“¨å…µæŒ‚æ‰äº†ï¼Œé‚£ä¹ˆå°±åªå‰©ä¸€ä¸ªå“¨å…µäº†ï¼Œå¦‚æœè¿™ä¸ªå“¨å…µæƒ³è¦æˆä¸º Leaderï¼Œè¿™æ—¶ç¥¨æ•°å°±æ²¡åŠæ³•è¾¾åˆ° 2 ç¥¨ï¼Œå°±æ— æ³•æˆåŠŸæˆä¸º Leaderï¼Œè¿™æ—¶æ˜¯æ— æ³•è¿›è¡Œä¸»ä»èŠ‚ç‚¹åˆ‡æ¢çš„ã€‚

å› æ­¤ï¼Œé€šå¸¸æˆ‘ä»¬è‡³å°‘ä¼šé…ç½® 3 ä¸ªå“¨å…µèŠ‚ç‚¹ã€‚è¿™æ—¶ï¼Œå¦‚æœå“¨å…µé›†ç¾¤ä¸­æœ‰ä¸ªå“¨å…µæŒ‚æ‰äº†ï¼Œé‚£ä¹ˆè¿˜å‰©ä¸‹ä¸¤ä¸ªä¸ªå“¨å…µï¼Œå¦‚æœè¿™ä¸ªå“¨å…µæƒ³è¦æˆä¸º Leaderï¼Œè¿™æ—¶è¿˜æ˜¯æœ‰æœºä¼šè¾¾åˆ° 2 ç¥¨çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯å¯ä»¥é€‰ä¸¾æˆåŠŸçš„ï¼Œä¸ä¼šå¯¼è‡´æ— æ³•è¿›è¡Œä¸»ä»èŠ‚ç‚¹åˆ‡æ¢ã€‚

å½“ç„¶ï¼Œä½ è¦é—®ï¼Œå¦‚æœ 3 ä¸ªå“¨å…µèŠ‚ç‚¹ï¼ŒæŒ‚äº† 2 ä¸ªæ€ä¹ˆåŠï¼Ÿè¿™ä¸ªæ—¶å€™å¾—äººä¸ºä»‹å…¥äº†ï¼Œæˆ–è€…å¢åŠ å¤šä¸€ç‚¹å“¨å…µèŠ‚ç‚¹ã€‚

å†è¯´ä¸€ä¸ªé—®é¢˜ï¼ŒRedis 1 ä¸» 4 ä»ï¼Œ5 ä¸ªå“¨å…µ ï¼Œquorum è®¾ç½®ä¸º 3ï¼Œå¦‚æœ 2 ä¸ªå“¨å…µæ•…éšœï¼Œå½“ä¸»èŠ‚ç‚¹å®•æœºæ—¶ï¼Œå“¨å…µèƒ½å¦åˆ¤æ–­ä¸»èŠ‚ç‚¹â€œå®¢è§‚ä¸‹çº¿â€ï¼Ÿä¸»ä»èƒ½å¦è‡ªåŠ¨åˆ‡æ¢ï¼Ÿ

- **å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹â€œå®¢è§‚ä¸‹çº¿â€**ã€‚å“¨å…µé›†ç¾¤è¿˜å‰©ä¸‹ 3 ä¸ªå“¨å…µï¼Œå½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»èŠ‚ç‚¹â€œä¸»è§‚ä¸‹çº¿â€åï¼Œè¯¢é—®å¦å¤– 2 ä¸ªå“¨å…µåï¼Œæœ‰å¯èƒ½èƒ½æ‹¿åˆ° 3 å¼ èµåŒç¥¨ï¼Œè¿™æ—¶å°±è¾¾åˆ°äº† quorum çš„å€¼ï¼Œå› æ­¤ï¼Œå“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚
- **å“¨å…µé›†ç¾¤å¯ä»¥å®Œæˆä¸»ä»åˆ‡æ¢**ã€‚å½“æœ‰ä¸ªå“¨å…µæ ‡è®°ä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€åï¼Œå°±ä¼šè¿›è¡Œé€‰ä¸¾ Leader çš„è¿‡ç¨‹ï¼Œå› ä¸ºæ­¤æ—¶å“¨å…µé›†ç¾¤è¿˜å‰©ä¸‹ 3 ä¸ªå“¨å…µï¼Œé‚£ä¹ˆè¿˜æ˜¯å¯ä»¥æ‹¿åˆ°åŠæ•°ä»¥ä¸Šï¼ˆ5/2+1=3ï¼‰çš„ç¥¨ï¼Œè€Œä¸”ä¹Ÿè¾¾åˆ°äº† quorum  å€¼ï¼Œæ»¡è¶³äº†é€‰ä¸¾ Leader çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œ æ‰€ä»¥å°±èƒ½é€‰ä¸¾æˆåŠŸï¼Œå› æ­¤å“¨å…µé›†ç¾¤å¯ä»¥å®Œæˆä¸»ä»åˆ‡æ¢ã€‚

å¦‚æœ quorum è®¾ç½®ä¸º 2 ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ã€‚æ­¤æ—¶å“¨å…µé›†ç¾¤è¿˜æ˜¯å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä½†æ˜¯å“¨å…µä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢äº†ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ¨æ¼”ä¸‹ã€‚

å¦‚æœ quorum è®¾ç½®ä¸º 3ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ï¼Œå“¨å…µé›†ç¾¤å³ä¸èƒ½åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä¹Ÿä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢äº†ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œquorum ä¸º 2 çš„æ—¶å€™ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ï¼Œè™½ç„¶å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä½†æ˜¯ä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢ï¼Œè¿™æ ·æ„Ÿè§‰ã€Œåˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºå®¢è§‚ä¸‹çº¿ã€è¿™ä»¶äº‹æƒ…ç™½åšäº†ä¸€æ ·ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œè¿˜ä¸å¦‚ä¸è¦åšï¼Œquorum ä¸º 3 çš„æ—¶å€™ï¼Œå°±å¯ä»¥é¿å…è¿™ç§æ— ç”¨åŠŸã€‚

æ‰€ä»¥ï¼Œ**quorum çš„å€¼å»ºè®®è®¾ç½®ä¸ºå“¨å…µä¸ªæ•°çš„äºŒåˆ†ä¹‹ä¸€åŠ 1**ï¼Œä¾‹å¦‚ 3 ä¸ªå“¨å…µå°±è®¾ç½® 2ï¼Œ5 ä¸ªå“¨å…µè®¾ç½®ä¸º 3ï¼Œè€Œä¸”**å“¨å…µèŠ‚ç‚¹çš„æ•°é‡åº”è¯¥æ˜¯å¥‡æ•°**ã€‚

#### ä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

åœ¨å“¨å…µé›†ç¾¤ä¸­é€šè¿‡æŠ•ç¥¨çš„æ–¹å¼ï¼Œé€‰ä¸¾å‡ºäº†å“¨å…µ leader åï¼Œå°±å¯ä»¥è¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹äº†ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20220714222351206](./images/image-20220714222351206.png)

ä¸»ä»æ•…éšœè½¬ç§»æ“ä½œåŒ…å«ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š

- ç¬¬ä¸€æ­¥ï¼šåœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹ï¼ˆæ—§ä¸»èŠ‚ç‚¹ï¼‰å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ã€‚
- ç¬¬äºŒæ­¥ï¼šè®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¿®æ”¹å¤åˆ¶ç›®æ ‡ï¼Œä¿®æ”¹ä¸ºå¤åˆ¶ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼›
- ç¬¬ä¸‰æ­¥ï¼šå°†æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œä¿¡æ¯ï¼Œé€šè¿‡ã€Œå‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ã€é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼›
- ç¬¬å››æ­¥ï¼šç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“è¿™ä¸ªæ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå°†å®ƒè®¾ç½®ä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼›

> è¿™å—å…·ä½“è¿˜æ˜¯çœ‹https://xiaolincoding.com/redis/cluster/sentinel.html#%E6%AD%A5%E9%AA%A4%E4%B8%80-%E9%80%89%E5%87%BA%E6%96%B0%E4%B8%BB%E8%8A%82%E7%82%B9

#### å“¨å…µé›†ç¾¤æ˜¯å¦‚ä½•ç»„æˆçš„ï¼Ÿ

å‰é¢æåˆ°äº†  Redis çš„å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ï¼Œé‚£å°±ä¸å¾—ä¸æä¸€ä¸‹å“¨å…µé›†ç¾¤çš„ç»„æˆæ–¹å¼ï¼Œå› ä¸ºå®ƒä¹Ÿç”¨åˆ°äº†è¿™ä¸ªæŠ€æœ¯ã€‚

åœ¨æˆ‘ç¬¬ä¸€æ¬¡æ­å»ºå“¨å…µé›†ç¾¤çš„æ—¶å€™ï¼Œå½“æ—¶è§‰å¾—å¾ˆè¯§å¼‚ã€‚å› ä¸ºåœ¨é…ç½®å“¨å…µçš„ä¿¡æ¯æ—¶ï¼Œç«Ÿç„¶åªéœ€è¦å¡«ä¸‹é¢è¿™å‡ ä¸ªå‚æ•°ï¼Œè®¾ç½®ä¸»èŠ‚ç‚¹åå­—ã€ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œç«¯å£å·ä»¥åŠ quorum å€¼ã€‚

```c
sentinel monitor <master-name> <ip> <redis-port> <quorum> 
```

ä¸éœ€è¦å¡«å…¶ä»–å“¨å…µèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæˆ‘å°±å¥½å¥‡å®ƒä»¬æ˜¯å¦‚ä½•æ„ŸçŸ¥å¯¹æ–¹çš„ï¼Œåˆæ˜¯å¦‚ä½•ç»„æˆå“¨å…µé›†ç¾¤çš„ï¼Ÿ

åé¢æ‰äº†è§£åˆ°ï¼Œ**å“¨å…µèŠ‚ç‚¹ä¹‹é—´æ˜¯é€šè¿‡ Redis çš„å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶æ¥ç›¸äº’å‘ç°çš„**ã€‚

åœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¸Šæœ‰ä¸€ä¸ªåä¸º `__sentinel__:hello`çš„é¢‘é“ï¼Œä¸åŒå“¨å…µå°±æ˜¯é€šè¿‡å®ƒæ¥ç›¸äº’å‘ç°ï¼Œå®ç°äº’ç›¸é€šä¿¡çš„ã€‚

åœ¨ä¸‹å›¾ä¸­ï¼Œå“¨å…µ A æŠŠè‡ªå·±çš„ IP åœ°å€å’Œç«¯å£çš„ä¿¡æ¯å‘å¸ƒåˆ° `__sentinel__:hello` é¢‘é“ä¸Šï¼Œå“¨å…µ B å’Œ C è®¢é˜…äº†è¯¥é¢‘é“ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå“¨å…µ B å’Œ C å°±å¯ä»¥ä»è¿™ä¸ªé¢‘é“ç›´æ¥è·å–å“¨å…µ A çš„ IP åœ°å€å’Œç«¯å£å·ã€‚ç„¶åï¼Œå“¨å…µ Bã€C å¯ä»¥å’Œå“¨å…µ A å»ºç«‹ç½‘ç»œè¿æ¥ã€‚

![image-20220714222643304](./images/image-20220714222643304.png)

é€šè¿‡è¿™ä¸ªæ–¹å¼ï¼Œå“¨å…µ B å’Œ C ä¹Ÿå¯ä»¥å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå“¨å…µé›†ç¾¤å°±å½¢æˆäº†ã€‚

> å“¨å…µé›†ç¾¤ä¼šå¯¹ã€Œä»èŠ‚ç‚¹ã€çš„è¿è¡ŒçŠ¶æ€è¿›è¡Œç›‘æ§ï¼Œé‚£å“¨å…µé›†ç¾¤å¦‚ä½•çŸ¥é“ã€Œä»èŠ‚ç‚¹ã€çš„ä¿¡æ¯ï¼Ÿ

ä¸»èŠ‚ç‚¹çŸ¥é“æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å“¨å…µä¼šæ¯ 10 ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘ä¸»èŠ‚ç‚¹å‘é€ INFO å‘½ä»¤æ¥è·å–æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€çš„ä¿¡æ¯ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå“¨å…µ B ç»™ä¸»èŠ‚ç‚¹å‘é€ INFO  å‘½ä»¤ï¼Œä¸»èŠ‚ç‚¹æ¥å—åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæŠŠä»èŠ‚ç‚¹åˆ—è¡¨è¿”å›ç»™å“¨å…µã€‚æ¥ç€ï¼Œå“¨å…µå°±å¯ä»¥æ ¹æ®ä»èŠ‚ç‚¹åˆ—è¡¨ä¸­çš„è¿æ¥ä¿¡æ¯ï¼Œå’Œæ¯ä¸ªä»èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨è¿™ä¸ªè¿æ¥ä¸ŠæŒç»­åœ°å¯¹ä»èŠ‚ç‚¹è¿›è¡Œç›‘æ§ã€‚å“¨å…µ A å’Œ C å¯ä»¥é€šè¿‡ç›¸åŒçš„æ–¹æ³•å’Œä»èŠ‚ç‚¹å»ºç«‹è¿æ¥ã€‚![image-20220714222836699](./images/image-20220714222836699.png)

æ­£å¼é€šè¿‡  Redis çš„å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ï¼Œå“¨å…µä¹‹é—´å¯ä»¥ç›¸äº’æ„ŸçŸ¥ï¼Œç„¶åç»„æˆé›†ç¾¤ï¼ŒåŒæ—¶ï¼Œå“¨å…µåˆé€šè¿‡ INFO å‘½ä»¤ï¼Œåœ¨ä¸»èŠ‚ç‚¹é‡Œè·å¾—äº†æ‰€æœ‰ä»èŠ‚ç‚¹è¿æ¥ä¿¡æ¯ï¼Œäºæ˜¯å°±èƒ½å’Œä»èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œå¹¶è¿›è¡Œç›‘æ§äº†ã€‚

#### æ€»ç»“

Redis åœ¨ 2.8 ç‰ˆæœ¬ä»¥åæä¾›çš„**å“¨å…µï¼ˆ\*Sentinel\*ï¼‰æœºåˆ¶**ï¼Œå®ƒçš„ä½œç”¨æ˜¯å®ç°**ä¸»ä»èŠ‚ç‚¹æ•…éšœè½¬ç§»**ã€‚å®ƒä¼šç›‘æµ‹ä¸»èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœå‘ç°ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå®ƒå°±ä¼šé€‰ä¸¾ä¸€ä¸ªä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠŠæ–°ä¸»èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯é€šçŸ¥ç»™ä»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯ã€‚

å“¨å…µä¸€èˆ¬æ˜¯ä»¥é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œè‡³å°‘éœ€è¦ 3 ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œå“¨å…µé›†ç¾¤ä¸»è¦è´Ÿè´£ä¸‰ä»¶äº‹æƒ…ï¼š**ç›‘æ§ã€é€‰ä¸»ã€é€šçŸ¥**ã€‚

å“¨å…µèŠ‚ç‚¹é€šè¿‡ Redis çš„å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ï¼Œå“¨å…µä¹‹é—´å¯ä»¥ç›¸äº’æ„ŸçŸ¥ï¼Œç›¸äº’è¿æ¥ï¼Œç„¶åç»„æˆå“¨å…µé›†ç¾¤ï¼ŒåŒæ—¶å“¨å…µåˆé€šè¿‡ INFO å‘½ä»¤ï¼Œåœ¨ä¸»èŠ‚ç‚¹é‡Œè·å¾—äº†æ‰€æœ‰ä»èŠ‚ç‚¹è¿æ¥ä¿¡æ¯ï¼Œäºæ˜¯å°±èƒ½å’Œä»èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œå¹¶è¿›è¡Œç›‘æ§äº†ã€‚

*1ã€ç¬¬ä¸€è½®æŠ•ç¥¨ï¼šåˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸‹çº¿*

å½“å“¨å…µé›†ç¾¤ä¸­çš„æŸä¸ªå“¨å…µåˆ¤å®šä¸»èŠ‚ç‚¹ä¸‹çº¿ï¼ˆä¸»è§‚ä¸‹çº¿ï¼‰åï¼Œå°±ä¼šå‘å…¶ä»–å“¨å…µå‘èµ·å‘½ä»¤ï¼Œå…¶ä»–å“¨å…µæ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæ ¹æ®è‡ªèº«å’Œä¸»èŠ‚ç‚¹çš„ç½‘ç»œçŠ¶å†µï¼Œåšå‡ºèµæˆæŠ•ç¥¨æˆ–è€…æ‹’ç»æŠ•ç¥¨çš„å“åº”ã€‚

å½“è¿™ä¸ªå“¨å…µçš„èµåŒç¥¨æ•°è¾¾åˆ°å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum é…ç½®é¡¹è®¾å®šçš„å€¼åï¼Œè¿™æ—¶ä¸»èŠ‚ç‚¹å°±ä¼šè¢«è¯¥å“¨å…µæ ‡è®°ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ã€‚

*2ã€ç¬¬äºŒè½®æŠ•ç¥¨ï¼šé€‰å‡ºå“¨å…µleader*

æŸä¸ªå“¨å…µåˆ¤å®šä¸»èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿åï¼Œè¯¥å“¨å…µå°±ä¼šå‘èµ·æŠ•ç¥¨ï¼Œå‘Šè¯‰å…¶ä»–å“¨å…µï¼Œå®ƒæƒ³æˆä¸º leaderï¼Œæƒ³æˆä¸º leader çš„å“¨å…µèŠ‚ç‚¹ï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

- ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›
- ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚

*3ã€ç”±å“¨å…µ leader è¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»*

é€‰ä¸¾å‡ºäº†å“¨å…µ leader åï¼Œå°±å¯ä»¥è¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹äº†ã€‚è¯¥æ“ä½œåŒ…å«ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š

- ç¬¬ä¸€æ­¥ï¼šåœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹ï¼ˆæ—§ä¸»èŠ‚ç‚¹ï¼‰å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œé€‰æ‹©çš„è§„åˆ™ï¼š
  - è¿‡æ»¤æ‰å·²ç»ç¦»çº¿çš„ä»èŠ‚ç‚¹ï¼›
  - è¿‡æ»¤æ‰å†å²ç½‘ç»œè¿æ¥çŠ¶æ€ä¸å¥½çš„ä»èŠ‚ç‚¹ï¼›
  - å°†å‰©ä¸‹çš„ä»èŠ‚ç‚¹ï¼Œè¿›è¡Œä¸‰è½®è€ƒå¯Ÿï¼šä¼˜å…ˆçº§ã€å¤åˆ¶è¿›åº¦ã€ID å·ã€‚åœ¨æ¯ä¸€è½®è€ƒå¯Ÿè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªèƒœå‡ºçš„ä»èŠ‚ç‚¹ï¼Œå°±å°†å…¶ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹ã€‚
- ç¬¬äºŒæ­¥ï¼šè®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¿®æ”¹å¤åˆ¶ç›®æ ‡ï¼Œä¿®æ”¹ä¸ºå¤åˆ¶ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼›
- ç¬¬ä¸‰æ­¥ï¼šå°†æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œä¿¡æ¯ï¼Œé€šè¿‡ã€Œå‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ã€é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼›
- ç¬¬å››æ­¥ï¼šç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“è¿™ä¸ªæ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå°†å®ƒè®¾ç½®ä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼›

### Clusterï¼ˆé›†ç¾¤ï¼‰çš„åŸç†ä½ èƒ½è®²ä¸€ä¸‹å—ï¼Ÿ

å“¨å…µæ¨¡å¼è§£å†³äº†ä¸»ä»å¤åˆ¶ä¸èƒ½è‡ªåŠ¨æ•…éšœè½¬ç§»ã€è¾¾ä¸åˆ°é«˜å¯ç”¨çš„é—®é¢˜ï¼Œä½†è¿˜æ˜¯å­˜åœ¨ä¸»èŠ‚ç‚¹çš„å†™èƒ½åŠ›ã€å®¹é‡å—é™äºå•æœºé…ç½®çš„é—®é¢˜ã€‚è€Œclusteræ¨¡å¼å®ç°äº†Redisçš„åˆ†å¸ƒå¼å­˜å‚¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨ä¸åŒçš„å†…å®¹ï¼Œè§£å†³ä¸»èŠ‚ç‚¹çš„å†™èƒ½åŠ›ã€å®¹é‡å—é™äºå•æœºé…ç½®çš„é—®é¢˜ã€‚

Redis clusteré›†ç¾¤èŠ‚ç‚¹æœ€å°é…ç½®6ä¸ªèŠ‚ç‚¹ä»¥ä¸Šï¼ˆ3ä¸»3ä»ï¼‰ï¼Œå…¶ä¸­ä¸»èŠ‚ç‚¹æä¾›è¯»å†™æ“ä½œï¼Œä»èŠ‚ç‚¹ä½œä¸ºå¤‡ç”¨èŠ‚ç‚¹ï¼Œä¸æä¾›è¯·æ±‚ï¼Œåªä½œä¸ºæ•…éšœè½¬ç§»ä½¿ç”¨ã€‚

Redis clusteré‡‡ç”¨**è™šæ‹Ÿæ§½åˆ†åŒº**ï¼Œæ‰€æœ‰çš„é”®æ ¹æ®å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°0ï½16383ä¸ªæ•´æ•°æ§½å†…ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä¸€éƒ¨åˆ†æ§½ä»¥åŠæ§½æ‰€æ˜ å°„çš„é”®å€¼æ•°æ®ã€‚

![img](./images/cluster_slots.png)

**å·¥ä½œåŸç†ï¼š**

1. é€šè¿‡å“ˆå¸Œçš„æ–¹å¼ï¼Œå°†æ•°æ®åˆ†ç‰‡ï¼Œæ¯ä¸ªèŠ‚ç‚¹å‡åˆ†å­˜å‚¨ä¸€å®šå“ˆå¸Œæ§½(å“ˆå¸Œå€¼)åŒºé—´çš„æ•°æ®ï¼Œé»˜è®¤åˆ†é…äº†16384 ä¸ªæ§½ä½
2. æ¯ä»½æ•°æ®åˆ†ç‰‡ä¼šå­˜å‚¨åœ¨å¤šä¸ªäº’ä¸ºä¸»ä»çš„å¤šèŠ‚ç‚¹ä¸Š
3. æ•°æ®å†™å…¥å…ˆå†™ä¸»èŠ‚ç‚¹ï¼Œå†åŒæ­¥åˆ°ä»èŠ‚ç‚¹(æ”¯æŒé…ç½®ä¸ºé˜»å¡åŒæ­¥)
4. åŒä¸€åˆ†ç‰‡å¤šä¸ªèŠ‚ç‚¹é—´çš„æ•°æ®ä¸ä¿æŒä¸€è‡´æ€§
5. è¯»å–æ•°æ®æ—¶ï¼Œå½“å®¢æˆ·ç«¯æ“ä½œçš„keyæ²¡æœ‰åˆ†é…åœ¨è¯¥èŠ‚ç‚¹ä¸Šæ—¶ï¼Œredisä¼šè¿”å›è½¬å‘æŒ‡ä»¤ï¼ŒæŒ‡å‘æ­£ç¡®çš„èŠ‚ç‚¹
6. æ‰©å®¹æ—¶æ—¶éœ€è¦éœ€è¦æŠŠæ—§èŠ‚ç‚¹çš„æ•°æ®è¿ç§»ä¸€éƒ¨åˆ†åˆ°æ–°èŠ‚ç‚¹

åœ¨ redis cluster æ¶æ„ä¸‹ï¼Œæ¯ä¸ª redis è¦æ”¾å¼€ä¸¤ä¸ªç«¯å£å·ï¼Œæ¯”å¦‚ä¸€ä¸ªæ˜¯ 6379ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯ åŠ 1w çš„ç«¯å£å·ï¼Œæ¯”å¦‚ 16379ã€‚

16379 ç«¯å£å·æ˜¯ç”¨æ¥è¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡çš„ï¼Œä¹Ÿå°±æ˜¯ cluster bus çš„ä¸œè¥¿ï¼Œcluster bus çš„é€šä¿¡ï¼Œç”¨æ¥è¿›è¡Œæ•…éšœæ£€æµ‹ã€é…ç½®æ›´æ–°ã€æ•…éšœè½¬ç§»æˆæƒã€‚cluster bus ç”¨äº†å¦å¤–ä¸€ç§äºŒè¿›åˆ¶çš„åè®®ï¼Œ`gossip` åè®®ï¼Œç”¨äºèŠ‚ç‚¹é—´è¿›è¡Œé«˜æ•ˆçš„æ•°æ®äº¤æ¢ï¼Œå ç”¨æ›´å°‘çš„ç½‘ç»œå¸¦å®½å’Œå¤„ç†æ—¶é—´ã€‚

**ä¼˜ç‚¹ï¼š**

- æ— ä¸­å¿ƒæ¶æ„ï¼Œ**æ”¯æŒåŠ¨æ€æ‰©**å®¹ï¼›
- æ•°æ®æŒ‰ç…§ `slot`å­˜å‚¨åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹é—´æ•°æ®å…±äº«ï¼Œ**å¯åŠ¨æ€è°ƒæ•´æ•°æ®åˆ†å¸ƒ**ï¼›
- **é«˜å¯ç”¨æ€§**ã€‚éƒ¨åˆ†èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œé›†ç¾¤ä»å¯ç”¨ã€‚é›†ç¾¤æ¨¡å¼èƒ½å¤Ÿå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆfailoverï¼‰ï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡ `gossip`åè®®äº¤æ¢çŠ¶æ€ä¿¡æ¯ï¼Œç”¨æŠ•ç¥¨æœºåˆ¶å®Œæˆ `Slave`åˆ° `Master`çš„è§’è‰²è½¬æ¢ã€‚

**ç¼ºç‚¹ï¼š**

- **ä¸æ”¯æŒæ‰¹é‡æ“ä½œ**ï¼ˆpipelineï¼‰ã€‚
- æ•°æ®é€šè¿‡å¼‚æ­¥å¤åˆ¶ï¼Œ**ä¸ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§**ã€‚
- **äº‹åŠ¡æ“ä½œæ”¯æŒæœ‰é™**ï¼Œåªæ”¯æŒå¤š `key`åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šçš„äº‹åŠ¡æ“ä½œï¼Œå½“å¤šä¸ª `key`åˆ†å¸ƒäºä¸åŒçš„èŠ‚ç‚¹ä¸Šæ—¶æ— æ³•ä½¿ç”¨äº‹åŠ¡åŠŸèƒ½ã€‚
- `key`ä½œä¸ºæ•°æ®åˆ†åŒºçš„æœ€å°ç²’åº¦ï¼Œä¸èƒ½å°†ä¸€ä¸ªå¾ˆå¤§çš„é”®å€¼å¯¹è±¡å¦‚ `hash`ã€`list`ç­‰æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚
- **ä¸æ”¯æŒå¤šæ•°æ®åº“ç©ºé—´**ï¼Œå•æœºä¸‹çš„Rediså¯ä»¥æ”¯æŒåˆ°16ä¸ªæ•°æ®åº“ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹åªèƒ½ä½¿ç”¨1ä¸ªæ•°æ®åº“ç©ºé—´ã€‚
- åªèƒ½ä½¿ç”¨0å·æ•°æ®åº“ã€‚

**å“ˆå¸Œåˆ†åŒºç®—æ³•æœ‰å“ªäº›ï¼Ÿ**

èŠ‚ç‚¹å–ä½™åˆ†åŒºã€‚ä½¿ç”¨ç‰¹å®šçš„æ•°æ®ï¼Œå¦‚Redisçš„é”®æˆ–ç”¨æˆ·IDï¼Œå¯¹èŠ‚ç‚¹æ•°é‡Nå–ä½™ï¼šhashï¼ˆkeyï¼‰%Nè®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œç”¨æ¥å†³å®šæ•°æ®æ˜ å°„åˆ°å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚ ä¼˜ç‚¹æ˜¯ç®€å•æ€§ã€‚æ‰©å®¹æ—¶é€šå¸¸é‡‡ç”¨ç¿»å€æ‰©å®¹ï¼Œé¿å…æ•°æ®æ˜ å°„å…¨éƒ¨è¢«æ‰“ä¹±å¯¼è‡´å…¨é‡è¿ç§»çš„æƒ…å†µã€‚

ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºã€‚ä¸ºç³»ç»Ÿä¸­æ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªtokenï¼ŒèŒƒå›´ä¸€èˆ¬åœ¨0~232ï¼Œè¿™äº›tokenæ„æˆä¸€ä¸ªå“ˆå¸Œç¯ã€‚æ•°æ®è¯»å†™æ‰§è¡ŒèŠ‚ç‚¹æŸ¥æ‰¾æ“ä½œæ—¶ï¼Œå…ˆæ ¹æ®keyè®¡ç®—hashå€¼ï¼Œç„¶åé¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºè¯¥å“ˆå¸Œå€¼çš„tokenèŠ‚ç‚¹ã€‚ è¿™ç§æ–¹å¼ç›¸æ¯”èŠ‚ç‚¹å–ä½™æœ€å¤§çš„å¥½å¤„åœ¨äºåŠ å…¥å’Œåˆ é™¤èŠ‚ç‚¹åªå½±å“å“ˆå¸Œç¯ä¸­ç›¸é‚»çš„èŠ‚ç‚¹ï¼Œå¯¹å…¶ä»–èŠ‚ç‚¹æ— å½±å“ã€‚

è™šæ‹Ÿæ§½åˆ†åŒºï¼Œæ‰€æœ‰çš„é”®æ ¹æ®å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°0~16383æ•´æ•°æ§½å†…ï¼Œè®¡ç®—å…¬å¼ï¼šslot=CRC16ï¼ˆkeyï¼‰&16383ã€‚æ¯ä¸€ä¸ªèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä¸€éƒ¨åˆ†æ§½ä»¥åŠæ§½æ‰€æ˜ å°„çš„é”®å€¼æ•°æ®ã€‚**Redis Cluseré‡‡ç”¨è™šæ‹Ÿæ§½åˆ†åŒºç®—æ³•ã€‚**

> è¯¦ç»†è¯´æ˜

- è‡ªåŠ¨å°†æ•°æ®è¿›è¡Œåˆ†ç‰‡ï¼Œæ¯ä¸ª master ä¸Šæ”¾ä¸€éƒ¨åˆ†æ•°æ®
- æä¾›å†…ç½®çš„é«˜å¯ç”¨æ”¯æŒï¼Œéƒ¨åˆ† master ä¸å¯ç”¨æ—¶ï¼Œè¿˜æ˜¯å¯ä»¥ç»§ç»­å·¥ä½œçš„

åœ¨ Redis cluster æ¶æ„ä¸‹ï¼Œæ¯ä¸ª Redis è¦æ”¾å¼€ä¸¤ä¸ªç«¯å£å·ï¼Œæ¯”å¦‚ä¸€ä¸ªæ˜¯ 6379ï¼Œå¦å¤–ä¸€ä¸ªå°±æ˜¯ åŠ  1w çš„ç«¯å£å·ï¼Œæ¯”å¦‚ 16379ã€‚

16379 ç«¯å£å·æ˜¯ç”¨æ¥è¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡çš„ï¼Œä¹Ÿå°±æ˜¯ cluster bus çš„ä¸œè¥¿ï¼Œcluster bus çš„é€šä¿¡ï¼Œç”¨æ¥è¿›è¡Œæ•…éšœæ£€æµ‹ã€é…ç½®æ›´æ–°ã€æ•…éšœè½¬ç§»æˆæƒã€‚cluster bus ç”¨äº†å¦å¤–ä¸€ç§äºŒè¿›åˆ¶çš„åè®®ï¼Œ `gossip` åè®®ï¼Œç”¨äºèŠ‚ç‚¹é—´è¿›è¡Œé«˜æ•ˆçš„æ•°æ®äº¤æ¢ï¼Œå ç”¨æ›´å°‘çš„ç½‘ç»œå¸¦å®½å’Œå¤„ç†æ—¶é—´ã€‚

#### èŠ‚ç‚¹é—´çš„å†…éƒ¨é€šä¿¡æœºåˆ¶

##### åŸºæœ¬é€šä¿¡åŸç†

é›†ç¾¤å…ƒæ•°æ®çš„ç»´æŠ¤æœ‰ä¸¤ç§æ–¹å¼ï¼šé›†ä¸­å¼ã€Gossip åè®®ã€‚Redis cluster èŠ‚ç‚¹é—´é‡‡ç”¨ gossip åè®®è¿›è¡Œé€šä¿¡ã€‚

**é›†ä¸­å¼**æ˜¯å°†é›†ç¾¤å…ƒæ•°æ®ï¼ˆèŠ‚ç‚¹ä¿¡æ¯ã€æ•…éšœç­‰ç­‰ï¼‰é›†ä¸­å­˜å‚¨åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šã€‚é›†ä¸­å¼å…ƒæ•°æ®é›†ä¸­å­˜å‚¨çš„ä¸€ä¸ªå…¸å‹ä»£è¡¨ï¼Œå°±æ˜¯å¤§æ•°æ®é¢†åŸŸçš„ `storm` ã€‚å®ƒæ˜¯åˆ†å¸ƒå¼çš„å¤§æ•°æ®å®æ—¶è®¡ç®—å¼•æ“ï¼Œæ˜¯é›†ä¸­å¼çš„å…ƒæ•°æ®å­˜å‚¨çš„ç»“æ„ï¼Œåº•å±‚åŸºäº zookeeperï¼ˆåˆ†å¸ƒå¼åè°ƒçš„ä¸­é—´ä»¶ï¼‰å¯¹æ‰€æœ‰å…ƒæ•°æ®è¿›è¡Œå­˜å‚¨ç»´æŠ¤ã€‚

![image-20220715143320253](./images/image-20220715143320253.png)

Redis ç»´æŠ¤é›†ç¾¤å…ƒæ•°æ®é‡‡ç”¨å¦ä¸€ä¸ªæ–¹å¼ï¼Œ `gossip` åè®®ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æŒæœ‰ä¸€ä»½å…ƒæ•°æ®ï¼Œä¸åŒçš„èŠ‚ç‚¹å¦‚æœå‡ºç°äº†å…ƒæ•°æ®çš„å˜æ›´ï¼Œå°±ä¸æ–­å°†å…ƒæ•°æ®å‘é€ç»™å…¶å®ƒçš„èŠ‚ç‚¹ï¼Œè®©å…¶å®ƒèŠ‚ç‚¹ä¹Ÿè¿›è¡Œå…ƒæ•°æ®çš„å˜æ›´ã€‚

![image-20220715143327361](./images/image-20220715143327361.png)

**é›†ä¸­å¼**çš„**å¥½å¤„**åœ¨äºï¼Œå…ƒæ•°æ®çš„è¯»å–å’Œæ›´æ–°ï¼Œæ—¶æ•ˆæ€§éå¸¸å¥½ï¼Œä¸€æ—¦å…ƒæ•°æ®å‡ºç°äº†å˜æ›´ï¼Œå°±ç«‹å³æ›´æ–°åˆ°é›†ä¸­å¼çš„å­˜å‚¨ä¸­ï¼Œå…¶å®ƒèŠ‚ç‚¹è¯»å–çš„æ—¶å€™å°±å¯ä»¥æ„ŸçŸ¥åˆ°ï¼›**ä¸å¥½**åœ¨äºï¼Œæ‰€æœ‰çš„å…ƒæ•°æ®çš„æ›´æ–°å‹åŠ›å…¨éƒ¨é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…ƒæ•°æ®çš„å­˜å‚¨æœ‰å‹åŠ›ã€‚

gossip å¥½å¤„åœ¨äºï¼Œå…ƒæ•°æ®çš„æ›´æ–°æ¯”è¾ƒåˆ†æ•£ï¼Œä¸æ˜¯é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œæ›´æ–°è¯·æ±‚ä¼šé™†é™†ç»­ç»­æ‰“åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸Šå»æ›´æ–°ï¼Œé™ä½äº†å‹åŠ›ï¼›ä¸å¥½åœ¨äºï¼Œå…ƒæ•°æ®çš„æ›´æ–°æœ‰å»¶æ—¶ï¼Œå¯èƒ½å¯¼è‡´é›†ç¾¤ä¸­çš„ä¸€äº›æ“ä½œä¼šæœ‰ä¸€äº›æ»åã€‚

- 10000 ç«¯å£ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªä¸“é—¨ç”¨äºèŠ‚ç‚¹é—´é€šä¿¡çš„ç«¯å£ï¼Œå°±æ˜¯è‡ªå·±æä¾›æœåŠ¡çš„ç«¯å£å·+10000ï¼Œæ¯”å¦‚ 7001ï¼Œé‚£ä¹ˆç”¨äºèŠ‚ç‚¹é—´é€šä¿¡çš„å°±æ˜¯ 17001 ç«¯å£ã€‚æ¯ä¸ªèŠ‚ç‚¹æ¯éš”ä¸€æ®µæ—¶é—´éƒ½ä¼šå¾€å¦å¤–å‡ ä¸ªèŠ‚ç‚¹å‘é€ `ping` æ¶ˆæ¯ï¼ŒåŒæ—¶å…¶å®ƒå‡ ä¸ªèŠ‚ç‚¹æ¥æ”¶åˆ° `ping` ä¹‹åè¿”å› `pong` ã€‚
- äº¤æ¢çš„ä¿¡æ¯ï¼šä¿¡æ¯åŒ…æ‹¬æ•…éšœä¿¡æ¯ï¼ŒèŠ‚ç‚¹çš„å¢åŠ å’Œåˆ é™¤ï¼Œhash slot ä¿¡æ¯ç­‰ç­‰ã€‚

##### gossip åè®®

gossip åè®®åŒ…å«å¤šç§æ¶ˆæ¯ï¼ŒåŒ…å« `ping` , `pong` , `meet` , `fail` ç­‰ç­‰ã€‚

- meetï¼šæŸä¸ªèŠ‚ç‚¹å‘é€ meet ç»™æ–°åŠ å…¥çš„èŠ‚ç‚¹ï¼Œè®©æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­ï¼Œç„¶åæ–°èŠ‚ç‚¹å°±ä¼šå¼€å§‹ä¸å…¶å®ƒèŠ‚ç‚¹è¿›è¡Œé€šä¿¡ã€‚

```bash
Redis-trib.rb add-node
```

å…¶å®å†…éƒ¨å°±æ˜¯å‘é€äº†ä¸€ä¸ª gossip meet æ¶ˆæ¯ç»™æ–°åŠ å…¥çš„èŠ‚ç‚¹ï¼Œé€šçŸ¥é‚£ä¸ªèŠ‚ç‚¹å»åŠ å…¥æˆ‘ä»¬çš„é›†ç¾¤ã€‚

- pingï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šé¢‘ç¹ç»™å…¶å®ƒèŠ‚ç‚¹å‘é€ pingï¼Œå…¶ä¸­åŒ…å«è‡ªå·±çš„çŠ¶æ€è¿˜æœ‰è‡ªå·±ç»´æŠ¤çš„é›†ç¾¤å…ƒæ•°æ®ï¼Œäº’ç›¸é€šè¿‡ ping äº¤æ¢å…ƒæ•°æ®ã€‚
- pongï¼šè¿”å› ping å’Œ meetï¼ŒåŒ…å«è‡ªå·±çš„çŠ¶æ€å’Œå…¶å®ƒä¿¡æ¯ï¼Œä¹Ÿç”¨äºä¿¡æ¯å¹¿æ’­å’Œæ›´æ–°ã€‚
- failï¼šæŸä¸ªèŠ‚ç‚¹åˆ¤æ–­å¦ä¸€ä¸ªèŠ‚ç‚¹ fail ä¹‹åï¼Œå°±å‘é€ fail ç»™å…¶å®ƒèŠ‚ç‚¹ï¼Œé€šçŸ¥å…¶å®ƒèŠ‚ç‚¹è¯´ï¼ŒæŸä¸ªèŠ‚ç‚¹å®•æœºå•¦ã€‚

##### ping æ¶ˆæ¯æ·±å…¥

ping æ—¶è¦æºå¸¦ä¸€äº›å…ƒæ•°æ®ï¼Œå¦‚æœå¾ˆé¢‘ç¹ï¼Œå¯èƒ½ä¼šåŠ é‡ç½‘ç»œè´Ÿæ‹…ã€‚

æ¯ä¸ªèŠ‚ç‚¹æ¯ç§’ä¼šæ‰§è¡Œ 10 æ¬¡ pingï¼Œæ¯æ¬¡ä¼šé€‰æ‹© 5 ä¸ªæœ€ä¹…æ²¡æœ‰é€šä¿¡çš„å…¶å®ƒèŠ‚ç‚¹ã€‚å½“ç„¶å¦‚æœå‘ç°æŸä¸ªèŠ‚ç‚¹é€šä¿¡å»¶æ—¶è¾¾åˆ°äº† `cluster_node_timeout / 2` ï¼Œé‚£ä¹ˆç«‹å³å‘é€ pingï¼Œé¿å…æ•°æ®äº¤æ¢å»¶æ—¶è¿‡é•¿ï¼Œè½åçš„æ—¶é—´å¤ªé•¿äº†ã€‚æ¯”å¦‚è¯´ï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´éƒ½ 10 åˆ†é’Ÿæ²¡æœ‰äº¤æ¢æ•°æ®äº†ï¼Œé‚£ä¹ˆæ•´ä¸ªé›†ç¾¤å¤„äºä¸¥é‡çš„å…ƒæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå°±ä¼šæœ‰é—®é¢˜ã€‚æ‰€ä»¥ `cluster_node_timeout` å¯ä»¥è°ƒèŠ‚ï¼Œå¦‚æœè°ƒå¾—æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆä¼šé™ä½ ping çš„é¢‘ç‡ã€‚

æ¯æ¬¡ pingï¼Œä¼šå¸¦ä¸Šè‡ªå·±èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œè¿˜æœ‰å°±æ˜¯å¸¦ä¸Š 1/10 å…¶å®ƒèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå‘é€å‡ºå»ï¼Œè¿›è¡Œäº¤æ¢ã€‚è‡³å°‘åŒ…å« `3` ä¸ªå…¶å®ƒèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œæœ€å¤šåŒ…å« `æ€»èŠ‚ç‚¹æ•°å‡ 2` ä¸ªå…¶å®ƒèŠ‚ç‚¹çš„ä¿¡æ¯ã€‚

#### åˆ†å¸ƒå¼å¯»å€ç®—æ³•

- hash ç®—æ³•ï¼ˆå¤§é‡ç¼“å­˜é‡å»ºï¼‰
- ä¸€è‡´æ€§ hash ç®—æ³•ï¼ˆè‡ªåŠ¨ç¼“å­˜è¿ç§»ï¼‰+ è™šæ‹ŸèŠ‚ç‚¹ï¼ˆè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼‰
- Redis cluster çš„ hash slot ç®—æ³•

##### hash ç®—æ³•

æ¥äº†ä¸€ä¸ª keyï¼Œé¦–å…ˆè®¡ç®— hash å€¼ï¼Œç„¶åå¯¹èŠ‚ç‚¹æ•°å–æ¨¡ã€‚ç„¶åæ‰“åœ¨ä¸åŒçš„ master èŠ‚ç‚¹ä¸Šã€‚ä¸€æ—¦æŸä¸€ä¸ª master èŠ‚ç‚¹å®•æœºï¼Œæ‰€æœ‰è¯·æ±‚è¿‡æ¥ï¼Œéƒ½ä¼šåŸºäºæœ€æ–°çš„å‰©ä½™ master èŠ‚ç‚¹æ•°å»å–æ¨¡ï¼Œå°è¯•å»å–æ•°æ®ã€‚è¿™ä¼šå¯¼è‡´**å¤§éƒ¨åˆ†çš„è¯·æ±‚è¿‡æ¥ï¼Œå…¨éƒ¨æ— æ³•æ‹¿åˆ°æœ‰æ•ˆçš„ç¼“å­˜**ï¼Œå¯¼è‡´å¤§é‡çš„æµé‡æ¶Œå…¥æ•°æ®åº“ã€‚

![image-20220715143507698](./images/image-20220715143507698.png)

##### ä¸€è‡´æ€§ hash ç®—æ³•

ä¸€è‡´æ€§ hash ç®—æ³•å°†æ•´ä¸ª hash å€¼ç©ºé—´ç»„ç»‡æˆä¸€ä¸ªè™šæ‹Ÿçš„åœ†ç¯ï¼Œæ•´ä¸ªç©ºé—´æŒ‰é¡ºæ—¶é’ˆæ–¹å‘ç»„ç»‡ï¼Œä¸‹ä¸€æ­¥å°†å„ä¸ª master èŠ‚ç‚¹ï¼ˆä½¿ç”¨æœåŠ¡å™¨çš„ ip æˆ–ä¸»æœºåï¼‰è¿›è¡Œ hashã€‚è¿™æ ·å°±èƒ½ç¡®å®šæ¯ä¸ªèŠ‚ç‚¹åœ¨å…¶å“ˆå¸Œç¯ä¸Šçš„ä½ç½®ã€‚

æ¥äº†ä¸€ä¸ª keyï¼Œé¦–å…ˆè®¡ç®— hash å€¼ï¼Œå¹¶ç¡®å®šæ­¤æ•°æ®åœ¨ç¯ä¸Šçš„ä½ç½®ï¼Œä»æ­¤ä½ç½®æ²¿ç¯**é¡ºæ—¶é’ˆâ€œè¡Œèµ°â€**ï¼Œé‡åˆ°çš„ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹å°±æ˜¯ key æ‰€åœ¨ä½ç½®ã€‚

åœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œå—å½±å“çš„æ•°æ®ä»…ä»…æ˜¯æ­¤èŠ‚ç‚¹åˆ°ç¯ç©ºé—´å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæ²¿ç€é€†æ—¶é’ˆæ–¹å‘è¡Œèµ°é‡åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ä¹‹é—´çš„æ•°æ®ï¼Œå…¶å®ƒä¸å—å½±å“ã€‚å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹ä¹ŸåŒç†ã€‚

ç‡ƒé¹…ï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åœ¨èŠ‚ç‚¹å¤ªå°‘æ—¶ï¼Œå®¹æ˜“å› ä¸ºèŠ‚ç‚¹åˆ†å¸ƒä¸å‡åŒ€è€Œé€ æˆ**ç¼“å­˜çƒ­ç‚¹**çš„é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ç§çƒ­ç‚¹é—®é¢˜ï¼Œä¸€è‡´æ€§ hash ç®—æ³•å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹æœºåˆ¶ï¼Œå³å¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹è®¡ç®—å¤šä¸ª hashï¼Œæ¯ä¸ªè®¡ç®—ç»“æœä½ç½®éƒ½æ”¾ç½®ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ã€‚è¿™æ ·å°±å®ç°äº†æ•°æ®çš„å‡åŒ€åˆ†å¸ƒï¼Œè´Ÿè½½å‡è¡¡ã€‚

![image-20220715143520445](./images/image-20220715143520445.png)

##### Redis cluster çš„ hash slot ç®—æ³•

Redis cluster æœ‰å›ºå®šçš„ `16384` ä¸ª hash slotï¼Œå¯¹æ¯ä¸ª `key` è®¡ç®— `CRC16` å€¼ï¼Œç„¶åå¯¹ `16384` å–æ¨¡ï¼Œå¯ä»¥è·å– key å¯¹åº”çš„ hash slotã€‚

Redis cluster ä¸­æ¯ä¸ª master éƒ½ä¼šæŒæœ‰éƒ¨åˆ† slotï¼Œæ¯”å¦‚æœ‰ 3 ä¸ª masterï¼Œé‚£ä¹ˆå¯èƒ½æ¯ä¸ª master æŒæœ‰ 5000 å¤šä¸ª  hash slotã€‚hash slot è®© node çš„å¢åŠ å’Œç§»é™¤å¾ˆç®€å•ï¼Œå¢åŠ ä¸€ä¸ª masterï¼Œå°±å°†å…¶ä»– master çš„ hash slot ç§»åŠ¨éƒ¨åˆ†è¿‡å»ï¼Œå‡å°‘ä¸€ä¸ª masterï¼Œå°±å°†å®ƒçš„ hash slot ç§»åŠ¨åˆ°å…¶ä»– master ä¸Šå»ã€‚ç§»åŠ¨ hash slot  çš„æˆæœ¬æ˜¯éå¸¸ä½çš„ã€‚å®¢æˆ·ç«¯çš„ apiï¼Œå¯ä»¥å¯¹æŒ‡å®šçš„æ•°æ®ï¼Œè®©ä»–ä»¬èµ°åŒä¸€ä¸ª hash slotï¼Œé€šè¿‡ `hash tag` æ¥å®ç°ã€‚

ä»»ä½•ä¸€å°æœºå™¨å®•æœºï¼Œå¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œä¸å½±å“çš„ã€‚å› ä¸º key æ‰¾çš„æ˜¯ hash slotï¼Œä¸æ˜¯æœºå™¨ã€‚

![image-20220715143532988](./images/image-20220715143532988.png)

#### Redis cluster çš„é«˜å¯ç”¨ä¸ä¸»å¤‡åˆ‡æ¢åŸç†

Redis cluster çš„é«˜å¯ç”¨çš„åŸç†ï¼Œå‡ ä¹è·Ÿå“¨å…µæ˜¯ç±»ä¼¼çš„ã€‚

##### åˆ¤æ–­èŠ‚ç‚¹å®•æœº

å¦‚æœä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹å®•æœºï¼Œé‚£ä¹ˆå°±æ˜¯ `pfail` ï¼Œ**ä¸»è§‚å®•æœº**ã€‚å¦‚æœå¤šä¸ªèŠ‚ç‚¹éƒ½è®¤ä¸ºå¦å¤–ä¸€ä¸ªèŠ‚ç‚¹å®•æœºäº†ï¼Œé‚£ä¹ˆå°±æ˜¯ `fail` ï¼Œ**å®¢è§‚å®•æœº**ï¼Œè·Ÿå“¨å…µçš„åŸç†å‡ ä¹ä¸€æ ·ï¼Œsdownï¼Œodownã€‚

åœ¨ `cluster-node-timeout` å†…ï¼ŒæŸä¸ªèŠ‚ç‚¹ä¸€ç›´æ²¡æœ‰è¿”å› `pong` ï¼Œé‚£ä¹ˆå°±è¢«è®¤ä¸º `pfail` ã€‚

å¦‚æœä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºæŸä¸ªèŠ‚ç‚¹ `pfail` äº†ï¼Œé‚£ä¹ˆä¼šåœ¨ `gossip ping` æ¶ˆæ¯ä¸­ï¼Œ `ping` ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå¦‚æœ**è¶…è¿‡åŠæ•°**çš„èŠ‚ç‚¹éƒ½è®¤ä¸º `pfail` äº†ï¼Œé‚£ä¹ˆå°±ä¼šå˜æˆ `fail` ã€‚

##### ä»èŠ‚ç‚¹è¿‡æ»¤

å¯¹å®•æœºçš„ master nodeï¼Œä»å…¶æ‰€æœ‰çš„ slave node ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªåˆ‡æ¢æˆ master nodeã€‚

æ£€æŸ¥æ¯ä¸ª slave node ä¸ master node æ–­å¼€è¿æ¥çš„æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº† `cluster-node-timeout * cluster-slave-validity-factor` ï¼Œé‚£ä¹ˆå°±**æ²¡æœ‰èµ„æ ¼**åˆ‡æ¢æˆ `master` ã€‚

##### ä»èŠ‚ç‚¹é€‰ä¸¾

æ¯ä¸ªä»èŠ‚ç‚¹ï¼Œéƒ½æ ¹æ®è‡ªå·±å¯¹ master å¤åˆ¶æ•°æ®çš„ offsetï¼Œæ¥è®¾ç½®ä¸€ä¸ªé€‰ä¸¾æ—¶é—´ï¼Œoffset è¶Šå¤§ï¼ˆå¤åˆ¶æ•°æ®è¶Šå¤šï¼‰çš„ä»èŠ‚ç‚¹ï¼Œé€‰ä¸¾æ—¶é—´è¶Šé å‰ï¼Œä¼˜å…ˆè¿›è¡Œé€‰ä¸¾ã€‚

æ‰€æœ‰çš„ master node å¼€å§‹ slave é€‰ä¸¾æŠ•ç¥¨ï¼Œç»™è¦è¿›è¡Œé€‰ä¸¾çš„ slave è¿›è¡ŒæŠ•ç¥¨ï¼Œå¦‚æœå¤§éƒ¨åˆ† master node `ï¼ˆN/2 + 1ï¼‰` éƒ½æŠ•ç¥¨ç»™äº†æŸä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆé€‰ä¸¾é€šè¿‡ï¼Œé‚£ä¸ªä»èŠ‚ç‚¹å¯ä»¥åˆ‡æ¢æˆ masterã€‚

ä»èŠ‚ç‚¹æ‰§è¡Œä¸»å¤‡åˆ‡æ¢ï¼Œä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ã€‚

##### ä¸å“¨å…µæ¯”è¾ƒ

æ•´ä¸ªæµç¨‹è·Ÿå“¨å…µç›¸æ¯”ï¼Œéå¸¸ç±»ä¼¼ï¼Œæ‰€ä»¥è¯´ï¼ŒRedis cluster åŠŸèƒ½å¼ºå¤§ï¼Œç›´æ¥é›†æˆäº† replication å’Œ sentinel çš„åŠŸèƒ½ã€‚

### â­MySQL å’Œ Redis æ€ä¹ˆä¿æŒæ•°æ®ä¸€è‡´?

å¯¹äºç¼“å­˜å’Œæ•°æ®åº“çš„æ“ä½œï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ã€‚

#### å…ˆåˆ ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“

ä¸¾ä¸ª ğŸŒ° å‡è®¾æŸä¸ªç”¨æˆ·çš„å¹´é¾„æ˜¯ 20ï¼Œè¯·æ±‚ A è¦æ›´æ–°ç”¨æˆ·å¹´é¾„ä¸º 21ï¼Œæ‰€ä»¥å®ƒä¼šåˆ é™¤ç¼“å­˜ä¸­çš„å†…å®¹ã€‚è¿™æ—¶ï¼Œå¦ä¸€ä¸ªè¯·æ±‚ B  è¦è¯»å–è¿™ä¸ªç”¨æˆ·çš„å¹´é¾„ï¼Œå®ƒæŸ¥è¯¢ç¼“å­˜å‘ç°æœªå‘½ä¸­åï¼Œä¼šä»æ•°æ®åº“ä¸­è¯»å–åˆ°å¹´é¾„ä¸º 20ï¼Œå¹¶ä¸”å†™å…¥åˆ°ç¼“å­˜ä¸­ï¼Œç„¶åè¯·æ±‚ A ç»§ç»­æ›´æ”¹æ•°æ®åº“ï¼Œå°†ç”¨æˆ·çš„å¹´é¾„æ›´æ–°ä¸º 21ã€‚

![image-20220715152802050](./images/image-20220715152802050.png)

æœ€ç»ˆï¼Œè¯¥ç”¨æˆ·å¹´é¾„åœ¨ç¼“å­˜ä¸­æ˜¯ 20ï¼ˆæ—§å€¼ï¼‰ï¼Œåœ¨æ•°æ®åº“ä¸­æ˜¯ 21ï¼ˆæ–°å€¼ï¼‰ï¼Œç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œ**å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ï¼Œåœ¨ã€Œè¯» + å†™ã€å¹¶å‘çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šå‡ºç°ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜**ã€‚

##### è§£å†³æ–¹æ¡ˆ:å»¶æ—¶åŒåˆ 

å»¶æ—¶åŒåˆ çš„æ–¹æ¡ˆçš„æ€è·¯æ˜¯ï¼Œä¸ºäº†é¿å…æ›´æ–°æ•°æ®åº“çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹ä»ç¼“å­˜ä¸­è¯»å–ä¸åˆ°æ•°æ®ï¼Œå°±åœ¨æ›´æ–°å®Œæ•°æ®åº“ä¹‹åï¼Œå†sleepä¸€æ®µæ—¶é—´ï¼Œç„¶åå†æ¬¡åˆ é™¤ç¼“å­˜ã€‚

sleepçš„æ—¶é—´è¦å¯¹ä¸šåŠ¡è¯»å†™ç¼“å­˜çš„æ—¶é—´åšå‡ºè¯„ä¼°ï¼Œsleepæ—¶é—´å¤§äºè¯»å†™ç¼“å­˜çš„æ—¶é—´å³å¯ã€‚

æµç¨‹å¦‚ä¸‹ï¼š

1. çº¿ç¨‹1åˆ é™¤ç¼“å­˜ï¼Œç„¶åå»æ›´æ–°æ•°æ®åº“
2. çº¿ç¨‹2æ¥è¯»ç¼“å­˜ï¼Œå‘ç°ç¼“å­˜å·²ç»è¢«åˆ é™¤ï¼Œæ‰€ä»¥ç›´æ¥ä»æ•°æ®åº“ä¸­è¯»å–ï¼Œè¿™æ—¶å€™ç”±äºçº¿ç¨‹1è¿˜æ²¡æœ‰æ›´æ–°å®Œæˆï¼Œæ‰€ä»¥è¯»åˆ°çš„æ˜¯æ—§å€¼ï¼Œç„¶åæŠŠæ—§å€¼å†™å…¥ç¼“å­˜
3. çº¿ç¨‹1ï¼Œæ ¹æ®ä¼°ç®—çš„æ—¶é—´ï¼Œsleepï¼Œç”±äºsleepçš„æ—¶é—´å¤§äºçº¿ç¨‹2è¯»æ•°æ®+å†™ç¼“å­˜çš„æ—¶é—´ï¼Œæ‰€ä»¥ç¼“å­˜è¢«å†æ¬¡åˆ é™¤
4. å¦‚æœè¿˜æœ‰å…¶ä»–çº¿ç¨‹æ¥è¯»å–ç¼“å­˜çš„è¯ï¼Œå°±ä¼šå†æ¬¡ä»æ•°æ®åº“ä¸­è¯»å–åˆ°æœ€æ–°å€¼

![image-20220715152925965](./images/image-20220715152925965.png)

#### å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜

ç»§ç»­ç”¨ã€Œè¯» + å†™ã€è¯·æ±‚çš„å¹¶å‘çš„åœºæ™¯æ¥åˆ†æã€‚

å‡å¦‚æŸä¸ªç”¨æˆ·æ•°æ®åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè¯·æ±‚ A è¯»å–æ•°æ®æ—¶ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°å¹´é¾„ä¸º 20ï¼Œåœ¨æœªå†™å…¥ç¼“å­˜ä¸­æ—¶å¦ä¸€ä¸ªè¯·æ±‚ B æ›´æ–°æ•°æ®ã€‚å®ƒæ›´æ–°æ•°æ®åº“ä¸­çš„å¹´é¾„ä¸º 21ï¼Œå¹¶ä¸”æ¸…ç©ºç¼“å­˜ã€‚è¿™æ—¶è¯·æ±‚ A æŠŠä»æ•°æ®åº“ä¸­è¯»åˆ°çš„å¹´é¾„ä¸º 20 çš„æ•°æ®å†™å…¥åˆ°ç¼“å­˜ä¸­ã€‚![image-20220715152956657](./images/image-20220715152956657.png)

æœ€ç»ˆï¼Œè¯¥ç”¨æˆ·å¹´é¾„åœ¨ç¼“å­˜ä¸­æ˜¯ 20ï¼ˆæ—§å€¼ï¼‰ï¼Œåœ¨æ•°æ®åº“ä¸­æ˜¯ 21ï¼ˆæ–°å€¼ï¼‰ï¼Œç¼“å­˜å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´ã€‚

ä»ä¸Šé¢çš„ç†è®ºä¸Šåˆ†æï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ä¹Ÿæ˜¯ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œ**ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œè¿™ä¸ªé—®é¢˜å‡ºç°çš„æ¦‚ç‡å¹¶ä¸é«˜**ã€‚

**å› ä¸ºç¼“å­˜çš„å†™å…¥é€šå¸¸è¦è¿œè¿œå¿«äºæ•°æ®åº“çš„å†™å…¥**ï¼Œæ‰€ä»¥åœ¨å®é™…ä¸­å¾ˆéš¾å‡ºç°è¯·æ±‚ B å·²ç»æ›´æ–°äº†æ•°æ®åº“å¹¶ä¸”åˆ é™¤äº†ç¼“å­˜ï¼Œè¯·æ±‚ A æ‰æ›´æ–°å®Œç¼“å­˜çš„æƒ…å†µã€‚

è€Œä¸€æ—¦è¯·æ±‚ A æ—©äºè¯·æ±‚ B åˆ é™¤ç¼“å­˜ä¹‹å‰æ›´æ–°äº†ç¼“å­˜ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„è¯·æ±‚å°±ä¼šå› ä¸ºç¼“å­˜ä¸å‘½ä¸­è€Œä»æ•°æ®åº“ä¸­é‡æ–°è¯»å–æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°è¿™ç§ä¸ä¸€è‡´çš„æƒ…å†µã€‚

æ‰€ä»¥ï¼Œ**ã€Œå…ˆæ›´æ–°æ•°æ®åº“ + å†åˆ é™¤ç¼“å­˜ã€çš„æ–¹æ¡ˆï¼Œæ˜¯å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„**ã€‚

##### è§£å†³æ–¹æ¡ˆ1:æ¶ˆæ¯é˜Ÿåˆ—

è¿™æ˜¯ç½‘ä¸Šå¾ˆå¤šæ–‡ç« é‡Œéƒ½æœ‰å†™è¿‡çš„æ–¹æ¡ˆã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºé™·ä¼šæ›´æ˜æ˜¾ä¸€ç‚¹ã€‚

å…ˆæ›´æ–°æ•°æ®åº“ï¼ŒæˆåŠŸåå¾€æ¶ˆæ¯é˜Ÿåˆ—å‘æ¶ˆæ¯ï¼Œæ¶ˆè´¹åˆ°æ¶ˆæ¯åå†åˆ é™¤ç¼“å­˜ï¼Œå€ŸåŠ©æ¶ˆæ¯é˜Ÿåˆ—çš„é‡è¯•æœºåˆ¶æ¥å®ç°ï¼Œè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§çš„æ•ˆæœã€‚

![image-20220715153053443](./images/image-20220715153053443.png)

è¿™ä¸ªè§£å†³æ–¹æ¡ˆå…¶å®é—®é¢˜æ›´å¤šã€‚

1. å¼•å…¥æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹åï¼Œé—®é¢˜æ›´å¤æ‚äº†ï¼Œæ€ä¹ˆä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±æ›´éº»çƒ¦
2. å°±ç®—æ›´æ–°æ•°æ®åº“å’Œåˆ é™¤ç¼“å­˜éƒ½æ²¡æœ‰å‘ç”Ÿé—®é¢˜ï¼Œæ¶ˆæ¯çš„å»¶è¿Ÿä¹Ÿä¼šå¸¦æ¥çŸ­æš‚çš„ä¸ä¸€è‡´æ€§ï¼Œä¸è¿‡è¿™ä¸ªå»¶è¿Ÿç›¸å¯¹æ¥è¯´è¿˜æ˜¯å¯ä»¥æ¥å—çš„

##### è§£å†³æ–¹æ¡ˆ2:è¿›é˜¶ç‰ˆæ¶ˆæ¯é˜Ÿåˆ—

ä¸ºäº†è§£å†³ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜å•ç‹¬å¼•å…¥ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¤ªå¤æ‚äº†ã€‚

å…¶å®ï¼Œä¸€èˆ¬å¤§å…¬å¸æœ¬èº«éƒ½ä¼šæœ‰ç›‘å¬binlogæ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—å­˜åœ¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†åšä¸€äº›æ ¸å¯¹çš„å·¥ä½œã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ç›‘å¬binlogçš„æ¶ˆæ¯é˜Ÿåˆ—æ¥åšåˆ é™¤ç¼“å­˜çš„æ“ä½œã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œä¸ç”¨ä½ è‡ªå·±å¼•å…¥ï¼Œä¾µå…¥åˆ°ä½ çš„ä¸šåŠ¡ä»£ç ä¸­ï¼Œä¸­é—´ä»¶å¸®ä½ åšäº†è§£è€¦ï¼ŒåŒæ—¶ï¼Œä¸­é—´ä»¶çš„è¿™ä¸ªä¸œè¥¿æœ¬èº«å°±ä¿è¯äº†é«˜å¯ç”¨ã€‚

å½“ç„¶ï¼Œè¿™æ ·æ¶ˆæ¯å»¶è¿Ÿçš„é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œä½†æ˜¯ç›¸æ¯”å•çº¯å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—çš„åšæ³•æ›´å¥½ä¸€ç‚¹ã€‚

è€Œä¸”ï¼Œå¦‚æœå¹¶å‘ä¸æ˜¯ç‰¹åˆ«é«˜çš„è¯ï¼Œè¿™ç§åšæ³•çš„å®æ—¶æ€§å’Œä¸€è‡´æ€§éƒ½è¿˜ç®—å¯ä»¥æ¥å—çš„ã€‚

![image-20220715153124553](./images/image-20220715153124553.png)

##### è§£å†³æ–¹æ¡ˆ3:è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´

æ¯æ¬¡æ”¾å…¥ç¼“å­˜çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚5åˆ†é’Ÿï¼Œä»¥åçš„æ“ä½œåªä¿®æ”¹æ•°æ®åº“ï¼Œä¸æ“ä½œç¼“å­˜ï¼Œç­‰å¾…ç¼“å­˜è¶…æ—¶åä»æ•°æ®åº“é‡æ–°è¯»å–ã€‚

å¦‚æœå¯¹äºä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜çš„æƒ…å†µï¼Œå¯ä»¥é‡‡ç”¨è¿™ç§æ–¹æ¡ˆã€‚

è¿™ä¸ªæ–¹æ¡ˆè¿˜ä¼šæœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœæ•°æ®æ›´æ–°çš„ç‰¹åˆ«é¢‘ç¹ï¼Œä¸ä¸€è‡´æ€§çš„é—®é¢˜å°±å¾ˆå¤§äº†ã€‚

åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€äº›æ´»åŠ¨çš„ç¼“å­˜æ•°æ®æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼å¤„ç†çš„ã€‚

å› ä¸ºæ´»åŠ¨å¹¶ä¸é¢‘ç¹å‘ç”Ÿæ”¹å˜ï¼Œè€Œä¸”å¯¹äºæ´»åŠ¨æ¥è¯´ï¼ŒçŸ­æš‚çš„ä¸ä¸€è‡´æ€§å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå¤§çš„é—®é¢˜ã€‚

è¯¦ç»†é—®é¢˜å¯ä»¥çœ‹ï¼š[æ•°æ®åº“å’Œç¼“å­˜å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ](https://xiaolincoding.com/redis/architecture/mysql_redis_consistency.html#%E5%85%88%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93-%E8%BF%98%E6%98%AF%E5%85%88%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98)

### â­ï¸Rediså¦‚ä½•å®ç°åˆ†å¸ƒå¼é”ï¼Ÿ

**åˆ†å¸ƒå¼é”**ï¼šå½“å¤šä¸ªè¿›ç¨‹ä¸åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­(æ¯”å¦‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ§åˆ¶å…±äº«èµ„æºè®¿é—®)ï¼Œç”¨åˆ†å¸ƒå¼é”æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹èµ„æºçš„è®¿é—®ã€‚

[Redisçš„å®˜ç½‘](https://redis.io/docs/reference/patterns/distributed-locks/)ä¸Šå¯¹ä½¿ç”¨åˆ†å¸ƒå¼é”æå‡ºè‡³å°‘éœ€è¦æ»¡è¶³å¦‚ä¸‹ä¸‰ä¸ªè¦æ±‚ï¼š

1. **äº’æ–¥**ï¼ˆå±äºå®‰å…¨æ€§ï¼‰ï¼šåœ¨ä»»ä½•ç»™å®šæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥æŒæœ‰é”ã€‚
2. **æ— æ­»é”**ï¼ˆå±äºæœ‰æ•ˆæ€§ï¼‰ï¼šå³ä½¿é”å®šèµ„æºçš„å®¢æˆ·ç«¯å´©æºƒæˆ–è¢«åˆ†åŒºï¼Œä¹Ÿæ€»æ˜¯å¯ä»¥è·å¾—é”ï¼›é€šå¸¸é€šè¿‡è¶…æ—¶æœºåˆ¶å®ç°ã€‚
3. **å®¹é”™æ€§**ï¼ˆå±äºæœ‰æ•ˆæ€§ï¼‰ï¼šåªè¦å¤§å¤šæ•° Redis èŠ‚ç‚¹éƒ½å¯åŠ¨ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è·å–å’Œé‡Šæ”¾é”ã€‚

**åŸºäº redis å®ç°åˆ†å¸ƒå¼é”**:

- å•ä¸ªRediså®ä¾‹ï¼šsetnx(key,å½“å‰æ—¶é—´+è¿‡æœŸæ—¶é—´) + Lua
- Redisé›†ç¾¤æ¨¡å¼ï¼šRedlock

#### æœ€ç®€åŒ–ç‰ˆæœ¬

é¦–å…ˆï¼Œå½“ç„¶æ˜¯æ­å»ºä¸€ä¸ªæœ€ç®€å•çš„å®ç°æ–¹å¼ï¼Œç›´æ¥ç”¨Redisçš„setnxå‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤çš„è¯­æ³•æ˜¯ï¼š**setnx key value**

å¦‚æœkeyä¸å­˜åœ¨ï¼Œåˆ™ä¼šå°†keyè®¾ç½®ä¸ºvalueï¼Œå¹¶è¿”å›1ï¼›å¦‚æœkeyå­˜åœ¨ï¼Œä¸ä¼šæœ‰ä»»åŠ¡å½±å“ï¼Œè¿”å›0ã€‚

åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨setnxå®ç°åŠ é”çš„ç›®çš„ï¼šé€šè¿‡setnxåŠ é”ï¼ŒåŠ é”ä¹‹åå…¶ä»–æœåŠ¡æ— æ³•åŠ é”ï¼Œç”¨å®Œä¹‹åï¼Œå†é€šè¿‡deleteè§£é”ï¼Œæ·±è—åŠŸä¸å

![image-20220709164349575](./images/image-20220709164349575.png)

#### æ”¯æŒè¿‡æœŸæ—¶é—´

æœ€ç®€åŒ–ç‰ˆæœ¬æœ‰ä¸€ä¸ªé—®é¢˜ï¼š**å¦‚æœè·å–é”çš„æœåŠ¡æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆé”å°±ä¸€ç›´å¾—ä¸åˆ°é‡Šæ”¾**ï¼Œå°±åƒçŸ³æ²‰å¤§æµ·ï¼Œæ³æ— éŸ³ä¿¡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¶…æ—¶æ¥å…œåº•ã€‚

Redisä¸­æœ‰expireå‘½ä»¤ï¼Œç”¨æ¥è®¾ç½®ä¸€ä¸ªkeyçš„è¶…æ—¶æ—¶é—´ã€‚ä½†æ˜¯setnxå’Œexpireä¸å…·å¤‡åŸå­æ€§ï¼Œå¦‚æœsetnxè·å–é”ä¹‹åï¼ŒæœåŠ¡æŒ‚æ‰ï¼Œä¾æ—§æ˜¯æ³¥ç‰›å…¥æµ·ã€‚

å¾ˆè‡ªç„¶ï¼Œæˆ‘ä»¬ä¼šæƒ³åˆ°ï¼Œsetå’Œexpireï¼Œæœ‰æ²¡æœ‰åŸå­æ“ä½œï¼Ÿ

å½“ç„¶æœ‰ï¼ŒRedisæ—©å°±è€ƒè™‘åˆ°äº†è¿™ç§åœºæ™¯ï¼Œæ¨å‡ºäº†å¦‚ä¸‹æ‰§è¡Œè¯­å¥ï¼š**set key value nx ex seconds**

nxè¡¨ç¤ºå…·å¤‡setnxç‰¹å®šï¼Œexè¡¨ç¤ºå¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œæœ€åä¸€ä¸ªå‚æ•°å°±æ˜¯è¿‡æœŸæ—¶é—´çš„å€¼ã€‚

![image-20220709164418917](./images/image-20220709164418917.png)

èƒ½å¤Ÿæ”¯æŒè¿‡æœŸæ—¶é—´ï¼Œç›®å‰è¿™ä¸ªé”åŸºæœ¬ä¸Šæ˜¯èƒ½ç”¨äº†ã€‚

ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šä¼šå­˜åœ¨æœåŠ¡Aé‡Šæ”¾æ‰æœåŠ¡Bçš„é”çš„å¯èƒ½ã€‚

#### åŠ ä¸Šowner

æˆ‘ä»¬æ¥è¯•æƒ³ä¸€ä¸‹å¦‚ä¸‹åœºæ™¯ï¼šæœåŠ¡Aè·å–äº†é”ï¼Œç”±äºä¸šåŠ¡æµç¨‹æ¯”è¾ƒé•¿ï¼Œæˆ–è€…ç½‘ç»œå»¶è¿Ÿã€GCå¡é¡¿ç­‰åŸå› ï¼Œå¯¼è‡´é”è¿‡æœŸï¼Œè€Œä¸šåŠ¡è¿˜ä¼šç»§ç»­è¿›è¡Œã€‚è¿™æ—¶å€™ï¼Œä¸šåŠ¡Bå·²ç»æ‹¿åˆ°äº†é”ï¼Œå‡†å¤‡å»æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™æœåŠ¡Aæ¢å¤è¿‡æ¥å¹¶åšå®Œäº†ä¸šåŠ¡ï¼Œå°±ä¼šé‡Šæ”¾é”ï¼Œè€ŒBå´è¿˜åœ¨ç»§ç»­æ‰§è¡Œã€‚

åœ¨çœŸå®çš„åˆ†å¸ƒå¼åœºæ™¯ä¸­ï¼Œå¯èƒ½å­˜åœ¨å‡ åä¸ªç«äº‰è€…ï¼Œé‚£ä¹ˆä¸Šè¿°æƒ…å†µå‘ç”Ÿæ¦‚ç‡å°±å¾ˆé«˜ï¼Œå¯¼è‡´åŒä¸€ä»½èµ„æºé¢‘ç¹è¢«ä¸åŒç«äº‰è€…åŒæ—¶è®¿é—®ï¼Œåˆ†å¸ƒå¼é”ä¹Ÿå°±å¤±å»äº†æ„ä¹‰ã€‚

åŸºäºè¿™ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œé—®é¢˜å…³é”®åœ¨äºï¼Œç«äº‰è€…å¯ä»¥é‡Šæ”¾å…¶ä»–äººçš„é”ã€‚é‚£ä¹ˆåœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ç»™å‡ºè§£å†³æ–¹æ¡ˆï¼š**åˆ†å¸ƒå¼é”éœ€è¦æ»¡è¶³è°ç”³è¯·è°é‡Šæ”¾åŸåˆ™ï¼Œä¸èƒ½é‡Šæ”¾åˆ«äººçš„é”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†å¸ƒå¼é”ï¼Œæ˜¯è¦æœ‰å½’å±çš„**

![image-20220709164452895](./images/image-20220709164452895.png)

#### å¼•å…¥Lua

åŠ å…¥owneråçš„ç‰ˆæœ¬å¯ä»¥ç§°å¾—ä¸Šæ˜¯å®Œå–„äº†å—ï¼Ÿè¿˜æœ‰æ²¡æœ‰ä»€ä¹ˆéšæ‚£å‘¢ï¼Ÿ

æˆ‘ä¹Ÿä¸å–å…³å­äº†ï¼Œåˆ°è¿™ä¸€æ­¥å…¶å®è¿˜å­˜åœ¨ä¸€ä¸ªå°é—®é¢˜ï¼Œæˆ‘ä»¬å®Œæ•´çš„æµç¨‹æ˜¯ç«äº‰è€…è·å–é”æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæ¯•åæ£€æŸ¥é”æ˜¯ä¸æ˜¯è‡ªå·±çš„ï¼Œæœ€åè¿›è¡Œé‡Šæ”¾ã€‚

æµç¨‹ä¸€æ¢³ç†ï¼Œä½ ä»¬è‚¯å®šæ˜ç™½äº†ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œ**æ£€æŸ¥é”ï¼Œå†é‡Šæ”¾ï¼Œè¿™äº›æ“ä½œä¸æ˜¯åŸå­åŒ–çš„ã€‚**

**å¯èƒ½é”è·å–æ—¶è¿˜æ˜¯è‡ªå·±çš„ï¼Œåˆ é™¤æ—¶å´å·²ç»æ˜¯åˆ«äººçš„**äº†ã€‚è¿™å¯æ€ä¹ˆåŠå‘¢ï¼Ÿ

Rediså¯æ²¡æœ‰ç›´æ¥æä¾›è¿™ç§åœºæ™¯åŸå­åŒ–çš„æ“ä½œå•Šã€‚é‡äº‹ä¸è¦æ…Œï¼Œä»”ç»†æƒ³ä¸€æƒ³ï¼ŒRedisæ˜¯ä¸æ˜¯è¿˜æœ‰ä¸ªç‰¹æ€§ï¼Œä¸“é—¨æ•´åˆåŸå­æ“ä½œï¼Œå¯¹ï¼Œå°±æ˜¯å®ƒâ€”â€”**Lua**

Redisâ•Luaï¼Œå¯ä»¥è¯´æ˜¯ä¸“é—¨ä¸ºè§£å†³åŸå­é—®é¢˜è€Œç”Ÿã€‚

æœ‰äº†Luaçš„ç‰¹æ€§ï¼ŒRedisæ‰çœŸæ­£åœ¨åˆ†å¸ƒå¼é”ã€ç§’æ€ç­‰åœºæ™¯ï¼Œæœ‰äº†ç”¨æ­¦ä¹‹åœ°ï¼Œä¸‹é¢ä¾¿æ˜¯æ”¹é€ ä¹‹åçš„æµç¨‹ï¼š

![image-20220709164528516](./images/image-20220709164528516.png)

å…¶å®åˆ°äº†è¿™ä¸€æ­¥ï¼Œåˆ†å¸ƒå¼é”çš„å‰ä¸‰ä¸ªç‰¹æ€§ï¼šå¯¹ç§°æ€§ã€å®‰å…¨æ€§ã€å¯é æ€§ï¼Œå°±æ»¡è¶³äº†ã€‚å¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¯ç”¨çš„åˆ†å¸ƒå¼é”äº†ï¼Œèƒ½æ»¡è¶³å¤§å¤šæ•°åœºæ™¯çš„éœ€è¦

#### Redisson

å¯¹äºå¯èƒ½å­˜åœ¨**é”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æ‰§è¡Œå®Œ** çš„é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥ç¨å¾®æŠŠé”è¿‡æœŸæ—¶é—´è®¾ç½®é•¿ä¸€äº›ï¼Œå¤§äºæ­£å¸¸ä¸šåŠ¡å¤„ç†æ—¶é—´å°±å¥½å•¦ã€‚å¦‚æœä½ è§‰å¾—ä¸æ˜¯å¾ˆç¨³ï¼Œè¿˜å¯ä»¥ç»™è·å¾—é”çš„çº¿ç¨‹ï¼Œå¼€å¯ä¸€ä¸ªå®šæ—¶å®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥é”æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å¯¹é”çš„è¿‡æœŸæ—¶é—´å»¶é•¿ï¼Œé˜²æ­¢é”è¿‡æœŸæå‰é‡Šæ”¾ã€‚

å½“å‰å¼€æºæ¡†æ¶Redissonè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å¯ä»¥çœ‹ä¸‹Redissonåº•å±‚åŸç†å›¾ï¼š

![image-20220709164742280](./images/image-20220709164742280.png)

åªè¦çº¿ç¨‹ä¸€åŠ é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ª `watch dog`çœ‹é—¨ç‹—ï¼Œå®ƒæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¼šæ¯éš”10ç§’æ£€æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœçº¿ç¨‹1è¿˜æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­çš„å»¶é•¿é”keyçš„ç”Ÿå­˜æ—¶é—´ã€‚å› æ­¤ï¼ŒRedissonå°±æ˜¯ä½¿ç”¨watch dogè§£å†³äº†**ã€Œé”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æ‰§è¡Œå®Œã€**é—®é¢˜ã€‚

#### Redlock+Redisson

å…¶å®Redisä¸€èˆ¬éƒ½æ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼š

![image-20220709164811068](./images/image-20220709164811068.png)

å¦‚æœçº¿ç¨‹ä¸€åœ¨Redisçš„masterèŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº†é”ï¼Œä½†æ˜¯åŠ é”çš„keyè¿˜æ²¡åŒæ­¥åˆ°slaveèŠ‚ç‚¹ã€‚æ°å¥½è¿™æ—¶ï¼ŒmasterèŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œä¸€ä¸ªslaveèŠ‚ç‚¹å°±ä¼šå‡çº§ä¸ºmasterèŠ‚ç‚¹ã€‚çº¿ç¨‹äºŒå°±å¯ä»¥è·å–åŒä¸ªkeyçš„é”å•¦ï¼Œä½†çº¿ç¨‹ä¸€ä¹Ÿå·²ç»æ‹¿åˆ°é”äº†ï¼Œé”çš„å®‰å…¨æ€§å°±æ²¡äº†ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisä½œè€… antirezæå‡ºä¸€ç§é«˜çº§çš„åˆ†å¸ƒå¼é”ç®—æ³•ï¼šRedlockã€‚Redlockæ ¸å¿ƒæ€æƒ³æ˜¯è¿™æ ·çš„ï¼š

> â
>
> æå¤šä¸ªRedis masteréƒ¨ç½²ï¼Œä»¥ä¿è¯å®ƒä»¬ä¸ä¼šåŒæ—¶å®•æ‰ã€‚å¹¶ä¸”è¿™äº›masterèŠ‚ç‚¹æ˜¯å®Œå…¨ç›¸äº’ç‹¬ç«‹çš„ï¼Œç›¸äº’ä¹‹é—´ä¸å­˜åœ¨æ•°æ®åŒæ­¥ã€‚åŒæ—¶ï¼Œéœ€è¦ç¡®ä¿åœ¨è¿™å¤šä¸ªmasterå®ä¾‹ä¸Šï¼Œæ˜¯ä¸åœ¨Rediså•å®ä¾‹ï¼Œä½¿ç”¨ç›¸åŒæ–¹æ³•æ¥è·å–å’Œé‡Šæ”¾é”ã€‚
>
> â

æˆ‘ä»¬å‡è®¾å½“å‰æœ‰5ä¸ªRedis masterèŠ‚ç‚¹ï¼Œåœ¨5å°æœåŠ¡å™¨ä¸Šé¢è¿è¡Œè¿™äº›Rediså®ä¾‹ã€‚

![image-20220709164830756](./images/image-20220709164830756.png)

RedLockçš„å®ç°æ­¥éª¤:å¦‚ä¸‹

> â
>
> - 1.è·å–å½“å‰æ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚
> - 2.æŒ‰é¡ºåºå‘5ä¸ªmasterèŠ‚ç‚¹è¯·æ±‚åŠ é”ã€‚å®¢æˆ·ç«¯è®¾ç½®ç½‘ç»œè¿æ¥å’Œå“åº”è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¸”è¶…æ—¶æ—¶é—´è¦å°äºé”çš„å¤±æ•ˆæ—¶é—´ã€‚ï¼ˆå‡è®¾é”è‡ªåŠ¨å¤±æ•ˆæ—¶é—´ä¸º10ç§’ï¼Œåˆ™è¶…æ—¶æ—¶é—´ä¸€èˆ¬åœ¨5-50æ¯«ç§’ä¹‹é—´,æˆ‘ä»¬å°±å‡è®¾è¶…æ—¶æ—¶é—´æ˜¯50mså§ï¼‰ã€‚å¦‚æœè¶…æ—¶ï¼Œè·³è¿‡è¯¥masterèŠ‚ç‚¹ï¼Œå°½å¿«å»å°è¯•ä¸‹ä¸€ä¸ªmasterèŠ‚ç‚¹ã€‚
> - 3.å®¢æˆ·ç«¯ä½¿ç”¨å½“å‰æ—¶é—´å‡å»å¼€å§‹è·å–é”æ—¶é—´ï¼ˆå³æ­¥éª¤1è®°å½•çš„æ—¶é—´ï¼‰ï¼Œå¾—åˆ°è·å–é”ä½¿ç”¨çš„æ—¶é—´ã€‚å½“ä¸”ä»…å½“è¶…è¿‡ä¸€åŠï¼ˆN/2+1ï¼Œè¿™é‡Œæ˜¯5/2+1=3ä¸ªèŠ‚ç‚¹ï¼‰çš„Redis masterèŠ‚ç‚¹éƒ½è·å¾—é”ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ—¶é—´å°äºé”å¤±æ•ˆæ—¶é—´æ—¶ï¼Œé”æ‰ç®—è·å–æˆåŠŸã€‚ï¼ˆå¦‚ä¸Šå›¾ï¼Œ10s> 30ms+40ms+50ms+4m0s+50msï¼‰
> - å¦‚æœå–åˆ°äº†é”ï¼Œkeyçš„çœŸæ­£æœ‰æ•ˆæ—¶é—´å°±å˜å•¦ï¼Œéœ€è¦å‡å»è·å–é”æ‰€ä½¿ç”¨çš„æ—¶é—´ã€‚
> - å¦‚æœè·å–é”å¤±è´¥ï¼ˆæ²¡æœ‰åœ¨è‡³å°‘N/2+1ä¸ªmasterå®ä¾‹å–åˆ°é”ï¼Œæœ‰æˆ–è€…è·å–é”æ—¶é—´å·²ç»è¶…è¿‡äº†æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå®¢æˆ·ç«¯è¦åœ¨æ‰€æœ‰çš„masterèŠ‚ç‚¹ä¸Šè§£é”ï¼ˆå³ä¾¿æœ‰äº›masterèŠ‚ç‚¹æ ¹æœ¬å°±æ²¡æœ‰åŠ é”æˆåŠŸï¼Œä¹Ÿéœ€è¦è§£é”ï¼Œä»¥é˜²æ­¢æœ‰äº›æ¼ç½‘ä¹‹é±¼ï¼‰ã€‚
>
> â

ç®€åŒ–ä¸‹æ­¥éª¤å°±æ˜¯ï¼š

- æŒ‰é¡ºåºå‘5ä¸ªmasterèŠ‚ç‚¹è¯·æ±‚åŠ é”
- æ ¹æ®è®¾ç½®çš„è¶…æ—¶æ—¶é—´æ¥åˆ¤æ–­ï¼Œæ˜¯ä¸æ˜¯è¦è·³è¿‡è¯¥masterèŠ‚ç‚¹ã€‚
- å¦‚æœå¤§äºç­‰äº3ä¸ªèŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ—¶é—´å°äºé”çš„æœ‰æ•ˆæœŸï¼Œå³å¯è®¤å®šåŠ é”æˆåŠŸå•¦ã€‚
- å¦‚æœè·å–é”å¤±è´¥ï¼Œè§£é”ï¼

#### Zookeeperåˆ†å¸ƒå¼é”

Zookeeperçš„èŠ‚ç‚¹Znodeæœ‰å››ç§ç±»å‹ï¼š

- **æŒä¹…èŠ‚ç‚¹** ï¼šé»˜è®¤çš„èŠ‚ç‚¹ç±»å‹ã€‚åˆ›å»ºèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨ã€‚
- **æŒä¹…èŠ‚ç‚¹é¡ºåºèŠ‚ç‚¹** ï¼šæ‰€è°“é¡ºåºèŠ‚ç‚¹ï¼Œå°±æ˜¯åœ¨åˆ›å»ºèŠ‚ç‚¹æ—¶ï¼ŒZookeeperæ ¹æ®åˆ›å»ºçš„æ—¶é—´é¡ºåºç»™è¯¥èŠ‚ç‚¹åç§°è¿›è¡Œç¼–å·ï¼ŒæŒä¹…èŠ‚ç‚¹é¡ºåºèŠ‚ç‚¹å°±æ˜¯æœ‰é¡ºåºçš„æŒä¹…èŠ‚ç‚¹ã€‚
- **ä¸´æ—¶èŠ‚ç‚¹** ï¼šå’ŒæŒä¹…èŠ‚ç‚¹ç›¸åï¼Œå½“åˆ›å»ºèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¸zookeeperæ–­å¼€è¿æ¥åï¼Œä¸´æ—¶èŠ‚ç‚¹ä¼šè¢«åˆ é™¤ã€‚
- **ä¸´æ—¶é¡ºåºèŠ‚ç‚¹** ï¼šæœ‰é¡ºåºçš„ä¸´æ—¶èŠ‚ç‚¹ã€‚

Zookeeperåˆ†å¸ƒå¼é”å®ç°åº”ç”¨äº†**ä¸´æ—¶é¡ºåºèŠ‚ç‚¹** ã€‚è¿™é‡Œä¸è´´ä»£ç å•¦ï¼Œæ¥è®²ä¸‹zkåˆ†å¸ƒå¼é”çš„å®ç°åŸç†å§ã€‚

##### zkè·å–é”è¿‡ç¨‹

å½“ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚è¿‡æ¥æ—¶ï¼ŒZookeeperå®¢æˆ·ç«¯ä¼šåˆ›å»ºä¸€ä¸ªæŒä¹…èŠ‚ç‚¹`locks`ã€‚å¦‚æœå®ƒï¼ˆClient1ï¼‰æƒ³è·å¾—é”ï¼Œéœ€è¦åœ¨`locks`èŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªé¡ºåºèŠ‚ç‚¹`lock1`.å¦‚å›¾

![image-20220725154831233](images/image-20220725154831233.png)

æ¥ç€ï¼Œå®¢æˆ·ç«¯Client1ä¼šæŸ¥æ‰¾`locks`ä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹`lock1`æ˜¯ä¸æ˜¯æ’åºæœ€å°çš„é‚£ä¸€ä¸ªï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æˆåŠŸè·å¾—é”ã€‚

![image-20220725154850768](images/image-20220725154850768.png)

è¿™æ—¶å€™å¦‚æœåˆæ¥ä¸€ä¸ªå®¢æˆ·ç«¯client2å‰æ¥å°è¯•è·å¾—é”ï¼Œå®ƒä¼šåœ¨locksä¸‹å†åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹`lock2`

![image-20220725154905321](images/image-20220725154905321.png)

å®¢æˆ·ç«¯client2ä¸€æ ·ä¹Ÿä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹lock2æ˜¯ä¸æ˜¯æœ€å°çš„ï¼Œæ­¤æ—¶ï¼Œå‘ç°lock1æ‰æ˜¯æœ€å°çš„ï¼Œäºæ˜¯è·å–é”å¤±è´¥ã€‚è·å–é”å¤±è´¥ï¼Œå®ƒæ˜¯ä¸ä¼šç”˜å¿ƒçš„ï¼Œclient2å‘å®ƒæ’åºé å‰çš„èŠ‚ç‚¹lock1æ³¨å†ŒWatcheräº‹ä»¶ï¼Œç”¨æ¥ç›‘å¬lock1æ˜¯å¦å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´client2æŠ¢é”å¤±è´¥è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

![image-20220725154920071](images/image-20220725154920071.png)

æ­¤æ—¶ï¼Œå¦‚æœå†æ¥ä¸€ä¸ªå®¢æˆ·ç«¯Client3æ¥å°è¯•è·å–é”ï¼Œå®ƒä¼šåœ¨locksä¸‹å†åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹lock3

![image-20220725154933777](images/image-20220725154933777.png)

åŒæ ·çš„ï¼Œclient3ä¸€æ ·ä¹Ÿä¼šæŸ¥æ‰¾locksä¸‹é¢çš„æ‰€æœ‰ä¸´æ—¶é¡ºåºå­èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±çš„èŠ‚ç‚¹lock3æ˜¯ä¸æ˜¯æœ€å°çš„ï¼Œå‘ç°è‡ªå·±ä¸æ˜¯æœ€å°çš„ï¼Œå°±è·å–é”å¤±è´¥ã€‚å®ƒä¹Ÿæ˜¯ä¸ä¼šç”˜å¿ƒçš„ï¼Œå®ƒä¼šå‘åœ¨å®ƒå‰é¢çš„èŠ‚ç‚¹lock2æ³¨å†ŒWatcheräº‹ä»¶ï¼Œä»¥ç›‘å¬lock2èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚

![image-20220725154939637](images/image-20220725154939637.png)

### é›†ç¾¤è„‘è£‚å¯¼è‡´æ•°æ®ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ

> ä»€ä¹ˆæ˜¯è„‘è£‚ï¼Ÿ

å…ˆæ¥ç†è§£é›†ç¾¤çš„è„‘è£‚ç°è±¡ï¼Œè¿™å°±å¥½æ¯”ä¸€ä¸ªäººæœ‰ä¸¤ä¸ªå¤§è„‘ï¼Œé‚£ä¹ˆåˆ°åº•å—è°æ§åˆ¶å‘¢ï¼Ÿ

é‚£ä¹ˆåœ¨ Redis ä¸­ï¼Œé›†ç¾¤è„‘è£‚äº§ç”Ÿæ•°æ®ä¸¢å¤±çš„ç°è±¡æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

åœ¨ Redis ä¸»ä»æ¶æ„ä¸­ï¼Œéƒ¨ç½²æ–¹å¼ä¸€èˆ¬æ˜¯ã€Œä¸€ä¸»å¤šä»ã€ï¼Œä¸»èŠ‚ç‚¹æä¾›å†™æ“ä½œï¼Œä»èŠ‚ç‚¹æä¾›è¯»æ“ä½œã€‚ å¦‚æœä¸»èŠ‚ç‚¹çš„ç½‘ç»œçªç„¶å‘ç”Ÿäº†é—®é¢˜ï¼Œå®ƒä¸æ‰€æœ‰çš„ä»èŠ‚ç‚¹éƒ½å¤±è”äº†ï¼Œä½†æ˜¯æ­¤æ—¶çš„ä¸»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯çš„ç½‘ç»œæ˜¯æ­£å¸¸çš„ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“ Redis  å†…éƒ¨å·²ç»å‡ºç°äº†é—®é¢˜ï¼Œè¿˜åœ¨ç…§æ ·çš„å‘è¿™ä¸ªå¤±è”çš„ä¸»èŠ‚ç‚¹å†™æ•°æ®ï¼ˆè¿‡ç¨‹Aï¼‰ï¼Œæ­¤æ—¶è¿™äº›æ•°æ®è¢«æ—§ä¸»èŠ‚ç‚¹ç¼“å­˜åˆ°äº†ç¼“å†²åŒºé‡Œï¼Œå› ä¸ºä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œé—®é¢˜ï¼Œè¿™äº›æ•°æ®éƒ½æ˜¯æ— æ³•åŒæ­¥ç»™ä»èŠ‚ç‚¹çš„ã€‚

è¿™æ—¶ï¼Œå“¨å…µä¹Ÿå‘ç°ä¸»èŠ‚ç‚¹å¤±è”äº†ï¼Œå®ƒå°±è®¤ä¸ºä¸»èŠ‚ç‚¹æŒ‚äº†ï¼ˆä½†å®é™…ä¸Šä¸»èŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯ç½‘ç»œå‡ºé—®é¢˜äº†ï¼‰ï¼Œäºæ˜¯å“¨å…µå°±ä¼šåœ¨ã€Œä»èŠ‚ç‚¹ã€ä¸­é€‰ä¸¾å‡ºä¸€ä¸ª leeder ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿™æ—¶é›†ç¾¤å°±æœ‰ä¸¤ä¸ªä¸»èŠ‚ç‚¹äº† â€”â€” **è„‘è£‚å‡ºç°äº†**ã€‚

ç„¶åï¼Œç½‘ç»œçªç„¶å¥½äº†ï¼Œå“¨å…µå› ä¸ºä¹‹å‰å·²ç»é€‰ä¸¾å‡ºä¸€ä¸ªæ–°ä¸»èŠ‚ç‚¹äº†ï¼Œå®ƒå°±ä¼šæŠŠæ—§ä¸»èŠ‚ç‚¹é™çº§ä¸ºä»èŠ‚ç‚¹ï¼ˆAï¼‰ï¼Œç„¶åä»èŠ‚ç‚¹ï¼ˆAï¼‰ä¼šå‘æ–°ä¸»èŠ‚ç‚¹è¯·æ±‚æ•°æ®åŒæ­¥ï¼Œ**å› ä¸ºç¬¬ä¸€æ¬¡åŒæ­¥æ˜¯å…¨é‡åŒæ­¥çš„æ–¹å¼ï¼Œæ­¤æ—¶çš„ä»èŠ‚ç‚¹ï¼ˆAï¼‰ä¼šæ¸…ç©ºæ‰è‡ªå·±æœ¬åœ°çš„æ•°æ®ï¼Œç„¶åå†åšå…¨é‡åŒæ­¥ã€‚æ‰€ä»¥ï¼Œä¹‹å‰å®¢æˆ·ç«¯åœ¨è¿‡ç¨‹ A å†™å…¥çš„æ•°æ®å°±ä¼šä¸¢å¤±äº†ï¼Œä¹Ÿå°±æ˜¯é›†ç¾¤äº§ç”Ÿè„‘è£‚æ•°æ®ä¸¢å¤±çš„é—®é¢˜**ã€‚

æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼šç”±äºç½‘ç»œé—®é¢˜ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¤±å»è”ç³»ã€‚ä¸»ä»æ•°æ®ä¸åŒæ­¥ï¼›é‡æ–°å¹³è¡¡é€‰ä¸¾ï¼Œäº§ç”Ÿä¸¤ä¸ªä¸»æœåŠ¡ã€‚ç­‰ç½‘ç»œæ¢å¤ï¼Œæ—§ä¸»èŠ‚ç‚¹ä¼šé™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œå†ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥å¤åˆ¶çš„æ—¶å€™ï¼Œç”±äºä¼šä»èŠ‚ç‚¹ä¼šæ¸…ç©ºè‡ªå·±çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥å¯¼è‡´ä¹‹å‰å®¢æˆ·ç«¯å†™å…¥çš„æ•°æ®ä¸¢å¤±äº†ã€‚

> è§£å†³æ–¹æ¡ˆ

å½“ä¸»èŠ‚ç‚¹å‘ç°ä»èŠ‚ç‚¹ä¸‹çº¿æˆ–è€…é€šä¿¡è¶…æ—¶çš„æ€»æ•°é‡å°äºé˜ˆå€¼æ—¶ï¼Œé‚£ä¹ˆç¦æ­¢ä¸»èŠ‚ç‚¹è¿›è¡Œå†™æ•°æ®ï¼Œç›´æ¥æŠŠé”™è¯¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥è®¾ç½®ï¼š

- min-slaves-to-write xï¼Œä¸»èŠ‚ç‚¹å¿…é¡»è¦æœ‰è‡³å°‘ x ä¸ªä»èŠ‚ç‚¹è¿æ¥ï¼Œå¦‚æœå°äºè¿™ä¸ªæ•°ï¼Œä¸»èŠ‚ç‚¹ä¼šç¦æ­¢å†™æ•°æ®ã€‚
- min-slaves-max-lag xï¼Œä¸»ä»æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿä¸èƒ½è¶…è¿‡ x ç§’ï¼Œå¦‚æœè¶…è¿‡ï¼Œä¸»èŠ‚ç‚¹ä¼šç¦æ­¢å†™æ•°æ®ã€‚

æˆ‘ä»¬å¯ä»¥æŠŠ min-slaves-to-write å’Œ min-slaves-max-lag è¿™ä¸¤ä¸ªé…ç½®é¡¹æ­é…èµ·æ¥ä½¿ç”¨ï¼Œåˆ†åˆ«ç»™å®ƒä»¬è®¾ç½®ä¸€å®šçš„é˜ˆå€¼ï¼Œå‡è®¾ä¸º N å’Œ Tã€‚

è¿™ä¸¤ä¸ªé…ç½®é¡¹ç»„åˆåçš„è¦æ±‚æ˜¯ï¼Œä¸»åº“è¿æ¥çš„ä»åº“ä¸­è‡³å°‘æœ‰ N ä¸ªä»åº“ï¼Œå’Œä¸»åº“è¿›è¡Œæ•°æ®å¤åˆ¶æ—¶çš„ ACK æ¶ˆæ¯å»¶è¿Ÿä¸èƒ½è¶…è¿‡ T ç§’ï¼Œå¦åˆ™ï¼Œä¸»åº“å°±ä¸ä¼šå†æ¥æ”¶å®¢æˆ·ç«¯çš„å†™è¯·æ±‚äº†ã€‚

å³ä½¿åŸä¸»åº“æ˜¯å‡æ•…éšœï¼Œå®ƒåœ¨å‡æ•…éšœæœŸé—´ä¹Ÿæ— æ³•å“åº”å“¨å…µå¿ƒè·³ï¼Œä¹Ÿä¸èƒ½å’Œä»åº“è¿›è¡ŒåŒæ­¥ï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ³•å’Œä»åº“è¿›è¡Œ ACK ç¡®è®¤äº†ã€‚è¿™æ ·ä¸€æ¥ï¼Œmin-slaves-to-write å’Œ min-slaves-max-lag çš„ç»„åˆè¦æ±‚å°±æ— æ³•å¾—åˆ°æ»¡è¶³ï¼Œ**åŸä¸»åº“å°±ä¼šè¢«é™åˆ¶æ¥æ”¶å®¢æˆ·ç«¯å†™è¯·æ±‚ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°±ä¸èƒ½åœ¨åŸä¸»åº“ä¸­å†™å…¥æ–°æ•°æ®äº†**ã€‚

**ç­‰åˆ°æ–°ä¸»åº“ä¸Šçº¿æ—¶ï¼Œå°±åªæœ‰æ–°ä¸»åº“èƒ½æ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ­¤æ—¶ï¼Œæ–°å†™çš„æ•°æ®ä¼šè¢«ç›´æ¥å†™åˆ°æ–°ä¸»åº“ä¸­ã€‚è€ŒåŸä¸»åº“ä¼šè¢«å“¨å…µé™ä¸ºä»åº“ï¼Œå³ä½¿å®ƒçš„æ•°æ®è¢«æ¸…ç©ºäº†ï¼Œä¹Ÿä¸ä¼šæœ‰æ–°æ•°æ®ä¸¢å¤±ã€‚**

å†æ¥ä¸¾ä¸ªä¾‹å­ã€‚

å‡è®¾æˆ‘ä»¬å°† min-slaves-to-write è®¾ç½®ä¸º 1ï¼ŒæŠŠ min-slaves-max-lag è®¾ç½®ä¸º 12sï¼ŒæŠŠå“¨å…µçš„  down-after-milliseconds è®¾ç½®ä¸º 10sï¼Œä¸»åº“å› ä¸ºæŸäº›åŸå› å¡ä½äº† 15sï¼Œå¯¼è‡´å“¨å…µåˆ¤æ–­ä¸»åº“å®¢è§‚ä¸‹çº¿ï¼Œå¼€å§‹è¿›è¡Œä¸»ä»åˆ‡æ¢ã€‚

åŒæ—¶ï¼Œå› ä¸ºåŸä¸»åº“å¡ä½äº† 15sï¼Œæ²¡æœ‰ä¸€ä¸ªä»åº“èƒ½å’ŒåŸä¸»åº“åœ¨ 12s å†…è¿›è¡Œæ•°æ®å¤åˆ¶ï¼ŒåŸä¸»åº“ä¹Ÿæ— æ³•æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚äº†ã€‚

è¿™æ ·ä¸€æ¥ï¼Œä¸»ä»åˆ‡æ¢å®Œæˆåï¼Œä¹Ÿåªæœ‰æ–°ä¸»åº“èƒ½æ¥æ”¶è¯·æ±‚ï¼Œä¸ä¼šå‘ç”Ÿè„‘è£‚ï¼Œä¹Ÿå°±ä¸ä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±çš„é—®é¢˜äº†ã€‚

## ğŸ“­ æ¶ˆæ¯é˜Ÿåˆ—

### æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä½¿ç”¨åœºæ™¯ ï¼ˆor ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰

å…¶å®å°±æ˜¯é—®é—®ä½ æ¶ˆæ¯é˜Ÿåˆ—éƒ½æœ‰å“ªäº›ä½¿ç”¨åœºæ™¯ï¼Œç„¶åä½ é¡¹ç›®é‡Œå…·ä½“æ˜¯ä»€ä¹ˆåœºæ™¯ï¼Œè¯´è¯´ä½ åœ¨è¿™ä¸ªåœºæ™¯é‡Œç”¨æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä»€ä¹ˆï¼Ÿ

é¢è¯•å®˜é—®ä½ è¿™ä¸ªé—®é¢˜ï¼Œ**æœŸæœ›çš„ä¸€ä¸ªå›ç­”**æ˜¯è¯´ï¼Œä½ ä»¬å…¬å¸æœ‰ä¸ªä»€ä¹ˆ**ä¸šåŠ¡åœºæ™¯**ï¼Œè¿™ä¸ªä¸šåŠ¡åœºæ™¯æœ‰ä¸ªä»€ä¹ˆæŠ€æœ¯æŒ‘æˆ˜ï¼Œå¦‚æœä¸ç”¨ MQ å¯èƒ½ä¼šå¾ˆéº»çƒ¦ï¼Œä½†æ˜¯ä½ ç°åœ¨ç”¨äº† MQ ä¹‹åå¸¦ç»™äº†ä½ å¾ˆå¤šçš„å¥½å¤„ã€‚

å…ˆè¯´ä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—å¸¸è§çš„ä½¿ç”¨åœºæ™¯å§ï¼Œå…¶å®åœºæ™¯æœ‰å¾ˆå¤šï¼Œä½†æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„æœ‰ 3 ä¸ªï¼š**è§£è€¦**ã€**å¼‚æ­¥**ã€**å‰Šå³°**ã€‚

#### åº”ç”¨è§£è€¦

ä¸¾ä¸ªå¸¸è§ä¸šåŠ¡åœºæ™¯ï¼šä¸‹å•æ‰£åº“å­˜ï¼Œç”¨æˆ·ä¸‹å•åï¼Œè®¢å•ç³»ç»Ÿå»é€šçŸ¥åº“å­˜ç³»ç»Ÿæ‰£å‡ã€‚

ä¼ ç»Ÿçš„åšæ³•å°±æ˜¯è®¢å•ç³»ç»Ÿç›´æ¥è°ƒç”¨åº“å­˜ç³»ç»Ÿï¼š

![image-20220622201936640](./images/image-20220622201936640.png)

* å¦‚æœåº“å­˜ç³»ç»Ÿæ— æ³•è®¿é—®ï¼Œä¸‹å•å°±ä¼šå¤±è´¥ï¼Œè®¢å•å’Œåº“å­˜ç³»ç»Ÿå­˜åœ¨è€¦åˆå…³ç³»
* å¦‚æœä¸šåŠ¡åˆæ¥å…¥ä¸€ä¸ªè¥é”€ç§¯åˆ†æœåŠ¡ï¼Œé‚£è®¢å•ä¸‹æ¸¸ç³»ç»Ÿè¦æ‰©å……ï¼Œå¦‚æœæœªæ¥æ¥å…¥è¶Šæ¥è¶Šå¤šçš„ä¸‹æ¸¸ç³»ç»Ÿï¼Œé‚£è®¢å•ç³»ç»Ÿä»£ç éœ€è¦ç»å¸¸ä¿®æ”¹

![image-20220622201957609](./images/image-20220622201957609.png)

å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¯ä»¥å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—

![image-20220622202006170](./images/image-20220622202006170.png)

1. è®¢å•ç³»ç»Ÿï¼šç”¨æˆ·ä¸‹å•åï¼Œæ¶ˆæ¯å†™å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿”å›ä¸‹å•æˆåŠŸ
2. åº“å­˜ç³»ç»Ÿï¼šè®¢é˜…ä¸‹å•æ¶ˆæ¯ï¼Œè·å–ä¸‹å•ä¿¡æ¯ï¼Œè¿›è¡Œåº“å­˜æ“ä½œ

#### æµé‡å‰Šå³°

æµé‡å‰Šå³°ä¹Ÿæ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„å¸¸ç”¨åœºæ™¯ã€‚æˆ‘ä»¬åšç§’æ€å®ç°çš„æ—¶å€™ï¼Œéœ€è¦é¿å…æµé‡æš´æ¶¨ï¼Œæ‰“å®åº”ç”¨ç³»ç»Ÿçš„é£é™©ã€‚å¯ä»¥åœ¨åº”ç”¨å‰é¢åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚

![image-20220622202028028](./images/image-20220622202028028.png)

å‡è®¾ç§’æ€ç³»ç»Ÿæ¯ç§’æœ€å¤šå¯ä»¥å¤„ç† 2k ä¸ªè¯·æ±‚ï¼Œæ¯ç§’å´æœ‰ 5k çš„è¯·æ±‚è¿‡æ¥ï¼Œå¯ä»¥å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç§’æ€ç³»ç»Ÿæ¯ç§’ä»æ¶ˆæ¯é˜Ÿåˆ—æ‹‰ 2k è¯·æ±‚å¤„ç†å¾—äº†ã€‚

æœ‰äº›ä¼™ä¼´æ‹…å¿ƒè¿™æ ·ä¼šå‡ºç°æ¶ˆæ¯ç§¯å‹çš„é—®é¢˜ï¼Œ

* é¦–å…ˆç§’æ€æ´»åŠ¨ä¸ä¼šæ¯æ—¶æ¯åˆ»éƒ½é‚£ä¹ˆå¤šè¯·æ±‚è¿‡æ¥ï¼Œé«˜å³°æœŸè¿‡å»åï¼Œç§¯å‹çš„è¯·æ±‚å¯ä»¥æ…¢
  æ…¢å¤„ç†ï¼›
* å…¶æ¬¡ï¼Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦è¶…è¿‡æœ€å¤§æ•°é‡ï¼Œå¯ä»¥ç›´æ¥æŠ›å¼ƒç”¨æˆ·è¯·æ±‚æˆ–è·³è½¬åˆ°é”™è¯¯é¡µé¢ï¼›

#### å¼‚æ­¥å¤„ç†

æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„ä¸šåŠ¡åœºæ™¯ï¼šç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œç»™å®ƒå‘ä¸ªçŸ­ä¿¡å’Œå‘ä¸ªé‚®ä»¶ã€‚

å¦‚æœæ³¨å†Œä¿¡æ¯å…¥åº“æ˜¯ 30msï¼Œå‘çŸ­ä¿¡ã€é‚®ä»¶ä¹Ÿæ˜¯ 30msï¼Œä¸‰ä¸ªåŠ¨ä½œä¸²è¡Œæ‰§è¡Œçš„è¯ï¼Œä¼šæ¯”è¾ƒè€—æ—¶ï¼Œå“åº” 90msï¼š

![image-20220622202122102](./images/image-20220622202122102.png)

å¦‚æœé‡‡ç”¨å¹¶è¡Œæ‰§è¡Œçš„æ–¹å¼ï¼Œå¯ä»¥å‡å°‘å“åº”æ—¶é—´ã€‚æ³¨å†Œä¿¡æ¯å…¥åº“åï¼ŒåŒæ—¶å¼‚æ­¥å‘çŸ­ä¿¡å’Œé‚®ä»¶ã€‚å¦‚ä½•å®ç°å¼‚æ­¥å‘¢ï¼Œç”¨æ¶ˆæ¯é˜Ÿåˆ—å³å¯ï¼Œå°±æ˜¯è¯´ï¼Œæ³¨å†Œä¿¡æ¯å…¥åº“æˆåŠŸåï¼Œå†™å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè¿™ä¸ªä¸€èˆ¬æ¯”è¾ƒå¿«ï¼Œå¦‚åªéœ€è¦3msï¼‰ï¼Œç„¶åå¼‚æ­¥è¯»å–å‘é‚®ä»¶å’ŒçŸ­ä¿¡ã€‚

![image-20220622202150827](./images/image-20220622202150827.png)

### æ­»ä¿¡é˜Ÿåˆ—&å»¶è¿Ÿé˜Ÿåˆ—

æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å­˜æ”¾çš„é˜Ÿåˆ—ã€‚

æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥çš„åŸå› ï¼š

- æ¶ˆæ¯è¢«æ‹’ç»å¹¶ä¸”æ¶ˆæ¯æ²¡æœ‰é‡æ–°å…¥é˜Ÿï¼ˆrequeue=falseï¼‰
- æ¶ˆæ¯è¶…æ—¶æœªæ¶ˆè´¹
- è¾¾åˆ°æœ€å¤§é˜Ÿåˆ—é•¿åº¦

![image-20220720155246253](./images/image-20220720155246253.png)



### MQå¸¸ç”¨é€šä¿¡åè®®

- **AMQPåè®®** AMQPå³Advanced Message Queuing Protocol,ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®,æ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†,ä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒå¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚

  > ä¼˜ç‚¹ï¼šå¯é ã€é€šç”¨

- **MQTTåè®®** MQTTï¼ˆMessage Queuing Telemetry Transportï¼Œæ¶ˆæ¯é˜Ÿåˆ—é¥æµ‹ä¼ è¾“ï¼‰æ˜¯IBMå¼€å‘çš„ä¸€ä¸ªå³æ—¶é€šè®¯åè®®ï¼Œæœ‰å¯èƒ½æˆä¸ºç‰©è”ç½‘çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¯¥åè®®æ”¯æŒæ‰€æœ‰å¹³å°ï¼Œå‡ ä¹å¯ä»¥æŠŠæ‰€æœ‰è”ç½‘ç‰©å“å’Œå¤–éƒ¨è¿æ¥èµ·æ¥ï¼Œè¢«ç”¨æ¥å½“åšä¼ æ„Ÿå™¨å’Œè‡´åŠ¨å™¨ï¼ˆæ¯”å¦‚é€šè¿‡Twitterè®©æˆ¿å±‹è”ç½‘ï¼‰çš„é€šä¿¡åè®®ã€‚

  > ä¼˜ç‚¹ï¼šæ ¼å¼ç®€æ´ã€å ç”¨å¸¦å®½å°ã€ç§»åŠ¨ç«¯é€šä¿¡ã€PUSHã€åµŒå…¥å¼ç³»ç»Ÿ

- **STOMPåè®®** STOMPï¼ˆStreaming Text Orientated Message Protocolï¼‰æ˜¯æµæ–‡æœ¬å®šå‘æ¶ˆæ¯åè®®ï¼Œæ˜¯ä¸€ç§ä¸ºMOM(Message Oriented Middlewareï¼Œé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶)è®¾è®¡çš„ç®€å•æ–‡æœ¬åè®®ã€‚STOMPæä¾›ä¸€ä¸ªå¯äº’æ“ä½œçš„è¿æ¥æ ¼å¼ï¼Œå…è®¸å®¢æˆ·ç«¯ä¸ä»»æ„STOMPæ¶ˆæ¯ä»£ç†ï¼ˆBrokerï¼‰è¿›è¡Œäº¤äº’ã€‚

  > ä¼˜ç‚¹ï¼šå‘½ä»¤æ¨¡å¼ï¼ˆétopic/queueæ¨¡å¼ï¼‰

- **XMPPåè®®** XMPPï¼ˆå¯æ‰©å±•æ¶ˆæ¯å¤„ç†ç°åœºåè®®ï¼ŒExtensible Messaging and Presence Protocolï¼‰æ˜¯åŸºäºå¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼ˆXMLï¼‰çš„åè®®ï¼Œå¤šç”¨äºå³æ—¶æ¶ˆæ¯ï¼ˆIMï¼‰ä»¥åŠåœ¨çº¿ç°åœºæ¢æµ‹ã€‚é€‚ç”¨äºæœåŠ¡å™¨ä¹‹é—´çš„å‡†å³æ—¶æ“ä½œã€‚æ ¸å¿ƒæ˜¯åŸºäºXMLæµä¼ è¾“ï¼Œè¿™ä¸ªåè®®å¯èƒ½æœ€ç»ˆå…è®¸å› ç‰¹ç½‘ç”¨æˆ·å‘å› ç‰¹ç½‘ä¸Šçš„å…¶ä»–ä»»ä½•äººå‘é€å³æ—¶æ¶ˆæ¯ï¼Œå³ä½¿å…¶æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨ä¸åŒã€‚

  > ä¼˜ç‚¹ï¼šé€šç”¨å…¬å¼€ã€å…¼å®¹æ€§å¼ºã€å¯æ‰©å±•ã€å®‰å…¨æ€§é«˜ï¼Œä½†XMLç¼–ç æ ¼å¼å ç”¨å¸¦å®½å¤§

- **å…¶ä»–åŸºäºTCP/IPè‡ªå®šä¹‰çš„åè®®**ï¼šæœ‰äº›ç‰¹æ®Šæ¡†æ¶ï¼ˆå¦‚ï¼šredisã€kafkaã€zeroMqç­‰ï¼‰æ ¹æ®è‡ªèº«éœ€è¦æœªä¸¥æ ¼éµå¾ªMQè§„èŒƒï¼Œè€Œæ˜¯åŸºäºTCP\IPè‡ªè¡Œå°è£…äº†ä¸€å¥—åè®®ï¼Œé€šè¿‡ç½‘ç»œsocketæ¥å£è¿›è¡Œä¼ è¾“ï¼Œå®ç°äº†MQçš„åŠŸèƒ½ã€‚



### å¦‚ä½•ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜å¯ç”¨ï¼Ÿ

#### RabbitMQ çš„é«˜å¯ç”¨æ€§

RabbitMQ æ˜¯æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„ï¼Œå› ä¸ºæ˜¯**åŸºäºä¸»ä»**ï¼ˆéåˆ†å¸ƒå¼ï¼‰åšé«˜å¯ç”¨æ€§çš„ï¼Œæˆ‘ä»¬å°±ä»¥ RabbitMQ ä¸ºä¾‹å­è®²è§£ç¬¬ä¸€ç§ MQ çš„é«˜å¯ç”¨æ€§æ€ä¹ˆå®ç°ã€‚

RabbitMQ æœ‰ä¸‰ç§æ¨¡å¼ï¼šå•æœºæ¨¡å¼ã€æ™®é€šé›†ç¾¤æ¨¡å¼ã€é•œåƒé›†ç¾¤æ¨¡å¼ã€‚

#### å•æœºæ¨¡å¼

å•æœºæ¨¡å¼ï¼Œå°±æ˜¯ Demo çº§åˆ«çš„ï¼Œä¸€èˆ¬å°±æ˜¯ä½ æœ¬åœ°å¯åŠ¨äº†ç©ç©å„¿çš„ï¼Œæ²¡äººç”Ÿäº§ç”¨å•æœºæ¨¡å¼ã€‚

#### æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰

æ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œæ„æ€å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ª RabbitMQ å®ä¾‹ï¼Œæ¯å°æœºå™¨å¯åŠ¨ä¸€ä¸ªã€‚ä½ **åˆ›å»ºçš„ queueï¼Œåªä¼šæ”¾åœ¨ä¸€ä¸ª RabbitMQ å®ä¾‹ä¸Š**ï¼Œä½†æ˜¯æ¯ä¸ªå®ä¾‹éƒ½åŒæ­¥ queue çš„å…ƒæ•°æ®ï¼ˆå…ƒæ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯ queue çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ° queue æ‰€åœ¨å®ä¾‹ï¼‰ã€‚ä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œå®é™…ä¸Šå¦‚æœè¿æ¥åˆ°äº†å¦å¤–ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆé‚£ä¸ªå®ä¾‹ä¼šä» queue æ‰€åœ¨å®ä¾‹ä¸Šæ‹‰å–æ•°æ®è¿‡æ¥ã€‚

![mq-7](./images/mq-7.png)

è¿™ç§æ–¹å¼ç¡®å®å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸æ€ä¹ˆå¥½ï¼Œ**æ²¡åšåˆ°æ‰€è°“çš„åˆ†å¸ƒå¼**ï¼Œå°±æ˜¯ä¸ªæ™®é€šé›†ç¾¤ã€‚å› ä¸ºè¿™å¯¼è‡´ä½ è¦ä¹ˆæ¶ˆè´¹è€…æ¯æ¬¡éšæœºè¿æ¥ä¸€ä¸ªå®ä¾‹ç„¶åæ‹‰å–æ•°æ®ï¼Œè¦ä¹ˆå›ºå®šè¿æ¥é‚£ä¸ª queue æ‰€åœ¨å®ä¾‹æ¶ˆè´¹æ•°æ®ï¼Œå‰è€…æœ‰**æ•°æ®æ‹‰å–çš„å¼€é”€**ï¼Œåè€…å¯¼è‡´**å•å®ä¾‹æ€§èƒ½ç“¶é¢ˆ**ã€‚

è€Œä¸”å¦‚æœé‚£ä¸ªæ”¾ queue çš„å®ä¾‹å®•æœºäº†ï¼Œä¼šå¯¼è‡´æ¥ä¸‹æ¥å…¶ä»–å®ä¾‹å°±æ— æ³•ä»é‚£ä¸ªå®ä¾‹æ‹‰å–ï¼Œå¦‚æœä½ **å¼€å¯äº†æ¶ˆæ¯æŒä¹…åŒ–**ï¼Œè®© RabbitMQ è½åœ°å­˜å‚¨æ¶ˆæ¯çš„è¯ï¼Œ**æ¶ˆæ¯ä¸ä¸€å®šä¼šä¸¢**ï¼Œå¾—ç­‰è¿™ä¸ªå®ä¾‹æ¢å¤äº†ï¼Œç„¶åæ‰å¯ä»¥ç»§ç»­ä»è¿™ä¸ª queue æ‹‰å–æ•°æ®ã€‚

æ‰€ä»¥è¿™ä¸ªäº‹å„¿å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œè¿™å°±**æ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„é«˜å¯ç”¨æ€§**ï¼Œ**è¿™æ–¹æ¡ˆä¸»è¦æ˜¯æé«˜ååé‡çš„**ï¼Œå°±æ˜¯è¯´è®©é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹æ¥æœåŠ¡æŸä¸ª queue çš„è¯»å†™æ“ä½œã€‚

#### é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰

è¿™ç§æ¨¡å¼ï¼Œæ‰æ˜¯æ‰€è°“çš„ RabbitMQ çš„é«˜å¯ç”¨æ¨¡å¼ã€‚è·Ÿæ™®é€šé›†ç¾¤æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œåœ¨é•œåƒé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä½ åˆ›å»ºçš„ queueï¼Œæ— è®ºæ˜¯å…ƒæ•°æ®è¿˜æ˜¯ queue é‡Œçš„æ¶ˆæ¯éƒ½ä¼š**å­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Š**ï¼Œå°±æ˜¯è¯´ï¼Œæ¯ä¸ª RabbitMQ èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ª queue çš„ä¸€ä¸ª**å®Œæ•´é•œåƒ**ï¼ŒåŒ…å« queue çš„å…¨éƒ¨æ•°æ®çš„æ„æ€ã€‚ç„¶åæ¯æ¬¡ä½ å†™æ¶ˆæ¯åˆ° queue çš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠ**æ¶ˆæ¯åŒæ­¥**åˆ°å¤šä¸ªå®ä¾‹çš„ queue ä¸Šã€‚

![mq-8](./images/mq-8.png)

é‚£ä¹ˆ**å¦‚ä½•å¼€å¯è¿™ä¸ªé•œåƒé›†ç¾¤æ¨¡å¼**å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒRabbitMQ æœ‰å¾ˆå¥½çš„ç®¡ç†æ§åˆ¶å°ï¼Œå°±æ˜¯åœ¨åå°æ–°å¢ä¸€ä¸ªç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯**é•œåƒé›†ç¾¤æ¨¡å¼çš„ç­–ç•¥**ï¼ŒæŒ‡å®šçš„æ—¶å€™æ˜¯å¯ä»¥è¦æ±‚æ•°æ®åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ï¼Œä¹Ÿå¯ä»¥è¦æ±‚åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„èŠ‚ç‚¹ï¼Œå†æ¬¡åˆ›å»º queue çš„æ—¶å€™ï¼Œåº”ç”¨è¿™ä¸ªç­–ç•¥ï¼Œå°±ä¼šè‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸Šå»äº†ã€‚

è¿™æ ·çš„è¯ï¼Œå¥½å¤„åœ¨äºï¼Œä½ ä»»ä½•ä¸€ä¸ªæœºå™¨å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œå…¶å®ƒæœºå™¨ï¼ˆèŠ‚ç‚¹ï¼‰è¿˜åŒ…å«äº†è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ï¼Œåˆ«çš„ consumer éƒ½å¯ä»¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šå»æ¶ˆè´¹æ•°æ®ã€‚åå¤„åœ¨äºï¼Œç¬¬ä¸€ï¼Œè¿™ä¸ªæ€§èƒ½å¼€é”€ä¹Ÿå¤ªå¤§äº†å§ï¼Œæ¶ˆæ¯éœ€è¦åŒæ­¥åˆ°æ‰€æœ‰æœºå™¨ä¸Šï¼Œå¯¼è‡´ç½‘ç»œå¸¦å®½å‹åŠ›å’Œæ¶ˆè€—å¾ˆé‡ï¼ç¬¬äºŒï¼Œè¿™ä¹ˆç©å„¿ï¼Œä¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå°±**æ²¡æœ‰æ‰©å±•æ€§å¯è¨€**äº†ï¼Œå¦‚æœæŸä¸ª queue è´Ÿè½½å¾ˆé‡ï¼Œä½ åŠ æœºå™¨ï¼Œæ–°å¢çš„æœºå™¨ä¹ŸåŒ…å«äº†è¿™ä¸ª queue çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶**æ²¡æœ‰åŠæ³•çº¿æ€§æ‰©å±•**ä½ çš„ queueã€‚ä½ æƒ³ï¼Œå¦‚æœè¿™ä¸ª queue çš„æ•°æ®é‡å¾ˆå¤§ï¼Œå¤§åˆ°è¿™ä¸ªæœºå™¨ä¸Šçš„å®¹é‡æ— æ³•å®¹çº³äº†ï¼Œæ­¤æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

#### Kafka çš„é«˜å¯ç”¨æ€§

Kafka ä¸€ä¸ªæœ€åŸºæœ¬çš„æ¶æ„è®¤è¯†ï¼šç”±å¤šä¸ª broker ç»„æˆï¼Œæ¯ä¸ª broker æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼›ä½ åˆ›å»ºä¸€ä¸ª topicï¼Œè¿™ä¸ª topic å¯ä»¥åˆ’åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition å¯ä»¥å­˜åœ¨äºä¸åŒçš„ broker ä¸Šï¼Œæ¯ä¸ª partition å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®ã€‚

è¿™å°±æ˜¯**å¤©ç„¶çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—**ï¼Œå°±æ˜¯è¯´ä¸€ä¸ª topic çš„æ•°æ®ï¼Œæ˜¯**åˆ†æ•£æ”¾åœ¨å¤šä¸ªæœºå™¨ä¸Šçš„ï¼Œæ¯ä¸ªæœºå™¨å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®**ã€‚

å®é™…ä¸Š RabbitMQ ä¹‹ç±»çš„ï¼Œå¹¶ä¸æ˜¯åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒå°±æ˜¯ä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªä¸è¿‡æä¾›äº†ä¸€äº›é›†ç¾¤ã€HA(High Availability, é«˜å¯ç”¨æ€§) çš„æœºåˆ¶è€Œå·²ï¼Œå› ä¸ºæ— è®ºæ€ä¹ˆç©å„¿ï¼ŒRabbitMQ ä¸€ä¸ª queue çš„æ•°æ®éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªèŠ‚ç‚¹é‡Œçš„ï¼Œé•œåƒé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä¹Ÿæ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æ”¾è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ã€‚

Kafka 0.8 ä»¥å‰ï¼Œæ˜¯æ²¡æœ‰ HA æœºåˆ¶çš„ï¼Œå°±æ˜¯ä»»ä½•ä¸€ä¸ª broker å®•æœºäº†ï¼Œé‚£ä¸ª broker ä¸Šçš„ partition å°±åºŸäº†ï¼Œæ²¡æ³•å†™ä¹Ÿæ²¡æ³•è¯»ï¼Œæ²¡æœ‰ä»€ä¹ˆé«˜å¯ç”¨æ€§å¯è¨€ã€‚

æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å‡è®¾åˆ›å»ºäº†ä¸€ä¸ª topicï¼ŒæŒ‡å®šå…¶ partition æ•°é‡æ˜¯ 3 ä¸ªï¼Œåˆ†åˆ«åœ¨ä¸‰å°æœºå™¨ä¸Šã€‚ä½†æ˜¯ï¼Œå¦‚æœç¬¬äºŒå°æœºå™¨å®•æœºäº†ï¼Œä¼šå¯¼è‡´è¿™ä¸ª topic çš„ 1/3 çš„æ•°æ®å°±ä¸¢äº†ï¼Œå› æ­¤è¿™ä¸ªæ˜¯åšä¸åˆ°é«˜å¯ç”¨çš„ã€‚

![kafka-before](./images/kafka-before.png)

Kafka 0.8 ä»¥åï¼Œæä¾›äº† HA æœºåˆ¶ï¼Œå°±æ˜¯ replicaï¼ˆå¤åˆ¶å“ï¼‰ å‰¯æœ¬æœºåˆ¶ã€‚æ¯ä¸ª partition çš„æ•°æ®éƒ½ä¼šåŒæ­¥åˆ°å…¶å®ƒæœºå™¨ä¸Šï¼Œå½¢æˆè‡ªå·±çš„å¤šä¸ª replica å‰¯æœ¬ã€‚æ‰€æœ‰ replica ä¼šé€‰ä¸¾ä¸€ä¸ª leader å‡ºæ¥ï¼Œé‚£ä¹ˆç”Ÿäº§å’Œæ¶ˆè´¹éƒ½è·Ÿè¿™ä¸ª leader æ‰“äº¤é“ï¼Œç„¶åå…¶ä»– replica å°±æ˜¯ followerã€‚å†™çš„æ—¶å€™ï¼Œleader ä¼šè´Ÿè´£æŠŠæ•°æ®åŒæ­¥åˆ°æ‰€æœ‰ follower ä¸Šå»ï¼Œè¯»çš„æ—¶å€™å°±ç›´æ¥è¯» leader ä¸Šçš„æ•°æ®å³å¯ã€‚åªèƒ½è¯»å†™ leaderï¼Ÿå¾ˆç®€å•ï¼Œ**è¦æ˜¯ä½ å¯ä»¥éšæ„è¯»å†™æ¯ä¸ª followerï¼Œé‚£ä¹ˆå°±è¦ care æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜**ï¼Œç³»ç»Ÿå¤æ‚åº¦å¤ªé«˜ï¼Œå¾ˆå®¹æ˜“å‡ºé—®é¢˜ã€‚Kafka ä¼šå‡åŒ€åœ°å°†ä¸€ä¸ª partition çš„æ‰€æœ‰ replica åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œè¿™æ ·æ‰å¯ä»¥æé«˜å®¹é”™æ€§ã€‚

![kafka-after](./images/kafka-after.png)

è¿™ä¹ˆæï¼Œå°±æœ‰æ‰€è°“çš„**é«˜å¯ç”¨æ€§**äº†ï¼Œå› ä¸ºå¦‚æœæŸä¸ª broker å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œé‚£ä¸ª broker ä¸Šé¢çš„ partition åœ¨å…¶ä»–æœºå™¨ä¸Šéƒ½æœ‰å‰¯æœ¬çš„ã€‚å¦‚æœè¿™ä¸ªå®•æœºçš„ broker ä¸Šé¢æœ‰æŸä¸ª partition çš„ leaderï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šä» follower ä¸­**é‡æ–°é€‰ä¸¾**ä¸€ä¸ªæ–°çš„ leader å‡ºæ¥ï¼Œå¤§å®¶ç»§ç»­è¯»å†™é‚£ä¸ªæ–°çš„ leader å³å¯ã€‚è¿™å°±æœ‰æ‰€è°“çš„é«˜å¯ç”¨æ€§äº†ã€‚

**å†™æ•°æ®**çš„æ—¶å€™ï¼Œç”Ÿäº§è€…å°±å†™ leaderï¼Œç„¶å leader å°†æ•°æ®è½åœ°å†™æœ¬åœ°ç£ç›˜ï¼Œæ¥ç€å…¶ä»– follower è‡ªå·±ä¸»åŠ¨ä» leader æ¥ pull æ•°æ®ã€‚ä¸€æ—¦æ‰€æœ‰ follower åŒæ­¥å¥½æ•°æ®äº†ï¼Œå°±ä¼šå‘é€ ack ç»™ leaderï¼Œleader æ”¶åˆ°æ‰€æœ‰ follower çš„ ack ä¹‹åï¼Œå°±ä¼šè¿”å›å†™æˆåŠŸçš„æ¶ˆæ¯ç»™ç”Ÿäº§è€…ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™åªæ˜¯å…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œè¿˜å¯ä»¥é€‚å½“è°ƒæ•´è¿™ä¸ªè¡Œä¸ºï¼‰

**æ¶ˆè´¹**çš„æ—¶å€™ï¼Œåªä¼šä» leader å»è¯»ï¼Œä½†æ˜¯åªæœ‰å½“ä¸€ä¸ªæ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ follower éƒ½åŒæ­¥æˆåŠŸè¿”å› ack çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šè¢«æ¶ˆè´¹è€…è¯»åˆ°ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¤§è‡´æ˜ç™½äº† Kafka æ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨æœºåˆ¶çš„äº†ï¼Œå¯¹å§ï¼Ÿä¸è‡³äºä¸€æ— æ‰€çŸ¥ï¼Œç°åœºè¿˜èƒ½ç»™é¢è¯•å®˜ç”»ç”»å›¾ã€‚è¦æ˜¯é‡ä¸Šé¢è¯•å®˜ç¡®å®æ˜¯ Kafka é«˜æ‰‹ï¼Œæ·±æŒ–äº†é—®ï¼Œé‚£ä½ åªèƒ½è¯´ä¸å¥½æ„æ€ï¼Œå¤ªæ·±å…¥çš„ä½ æ²¡ç ”ç©¶è¿‡ã€‚

### å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ

#### RocketMQ

**`RocketMQ` åœ¨ä¸»é¢˜ä¸Šæ˜¯æ— åºçš„ã€å®ƒåªæœ‰åœ¨é˜Ÿåˆ—å±‚é¢æ‰æ˜¯ä¿è¯æœ‰åº** çš„ã€‚

è¿™åˆæ‰¯åˆ°ä¸¤ä¸ªæ¦‚å¿µâ€”â€”**æ™®é€šé¡ºåº** å’Œ **ä¸¥æ ¼é¡ºåº** ã€‚

æ‰€è°“æ™®é€šé¡ºåºæ˜¯æŒ‡ æ¶ˆè´¹è€…é€šè¿‡ **åŒä¸€ä¸ªæ¶ˆè´¹é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„** ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„ã€‚æ™®é€šé¡ºåºæ¶ˆæ¯åœ¨ `Broker` **é‡å¯æƒ…å†µä¸‹ä¸ä¼šä¿è¯æ¶ˆæ¯é¡ºåºæ€§** (çŸ­æš‚æ—¶é—´) ã€‚

æ‰€è°“ä¸¥æ ¼é¡ºåºæ˜¯æŒ‡ æ¶ˆè´¹è€…æ”¶åˆ°çš„ **æ‰€æœ‰æ¶ˆæ¯** å‡æ˜¯æœ‰é¡ºåºçš„ã€‚ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ **å³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿä¼šä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§** ã€‚

ä½†æ˜¯ï¼Œä¸¥æ ¼é¡ºåºçœ‹èµ·æ¥è™½å¥½ï¼Œå®ç°å®ƒå¯ä¼šä»˜å‡ºå·¨å¤§çš„ä»£ä»·ã€‚å¦‚æœä½ ä½¿ç”¨ä¸¥æ ¼é¡ºåºæ¨¡å¼ï¼Œ`Broker` é›†ç¾¤ä¸­åªè¦æœ‰ä¸€å°æœºå™¨ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¸å¯ç”¨ã€‚ä½ è¿˜ç”¨å•¥ï¼Ÿç°åœ¨ä¸»è¦åœºæ™¯ä¹Ÿå°±åœ¨ `binlog` åŒæ­¥ã€‚

ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬çš„ `MQ` éƒ½æ˜¯èƒ½å®¹å¿çŸ­æš‚çš„ä¹±åºï¼Œæ‰€ä»¥æ¨èä½¿ç”¨æ™®é€šé¡ºåºæ¨¡å¼ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨ä½¿ç”¨äº† **æ™®é€šé¡ºåºæ¨¡å¼** ï¼Œæˆ‘ä»¬ä»ä¸Šé¢å­¦ä¹ çŸ¥é“äº†åœ¨ `Producer` ç”Ÿäº§æ¶ˆæ¯çš„æ—¶å€™ä¼šè¿›è¡Œè½®è¯¢(å–å†³ä½ çš„è´Ÿè½½å‡è¡¡ç­–ç•¥)æ¥å‘åŒä¸€ä¸»é¢˜çš„ä¸åŒæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚é‚£ä¹ˆå¦‚æœæ­¤æ—¶æˆ‘æœ‰å‡ ä¸ªæ¶ˆæ¯åˆ†åˆ«æ˜¯åŒä¸€ä¸ªè®¢å•çš„åˆ›å»ºã€æ”¯ä»˜ã€å‘è´§ï¼Œåœ¨è½®è¯¢çš„ç­–ç•¥ä¸‹è¿™ **ä¸‰ä¸ªæ¶ˆæ¯ä¼šè¢«å‘é€åˆ°ä¸åŒé˜Ÿåˆ—** ï¼Œå› ä¸ºåœ¨ä¸åŒçš„é˜Ÿåˆ—æ­¤æ—¶å°±æ— æ³•ä½¿ç”¨ `RocketMQ` å¸¦æ¥çš„é˜Ÿåˆ—æœ‰åºç‰¹æ€§æ¥ä¿è¯æ¶ˆæ¯æœ‰åºæ€§äº†ã€‚

![image-20220606105514638](./images/image-20220606105514638.png)

é‚£ä¹ˆï¼Œæ€ä¹ˆè§£å†³å‘¢ï¼Ÿ

å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†çš„ä»…ä»…æ˜¯å°†åŒä¸€è¯­ä¹‰ä¸‹çš„æ¶ˆæ¯æ”¾å…¥åŒä¸€ä¸ªé˜Ÿåˆ—(æ¯”å¦‚è¿™é‡Œæ˜¯åŒä¸€ä¸ªè®¢å•)ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ **Hashå–æ¨¡æ³•** æ¥ä¿è¯åŒä¸€ä¸ªè®¢å•åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­å°±è¡Œäº†ã€‚

> å¦å¤–æœ‰è¯´æ³•æ˜¯è¿™æ ·ï¼Œä½†å¤§æ„ä¸€è‡´ï¼Œæ–¹ä¾¿ç†è§£æ”¾åœ¨ä¸€èµ·
>
> è¦è§£å†³ RocketMQ çš„ä¹±åºé—®é¢˜ï¼Œæˆ‘ä»¬åªéœ€è¦æƒ³åŠæ³•è®©åŒä¸€ä¸ªè®¢å•çš„ binlog è¿›å…¥åˆ°åŒä¸€ä¸ª MessageQueue  ä¸­å°±å¯ä»¥äº†ã€‚å› ä¸ºåŒä¸€ä¸ª MessageQueue å†…çš„æ¶ˆæ¯æ˜¯ä¸€å®šæœ‰åºçš„ï¼Œä¸€ä¸ª MessageQueue ä¸­çš„æ¶ˆæ¯åªèƒ½äº¤ç»™ä¸€ä¸ª Consumer  æ¥è¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥ Consumer æ¶ˆè´¹çš„æ—¶å€™å°±ä¸€å®šä¼šæ˜¯æœ‰åºçš„ã€‚

#### RabbitMQ

æˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä»¥å‰åšè¿‡ä¸€ä¸ª mysql `binlog` åŒæ­¥çš„ç³»ç»Ÿï¼Œå‹åŠ›è¿˜æ˜¯éå¸¸å¤§çš„ï¼Œæ—¥åŒæ­¥æ•°æ®è¦è¾¾åˆ°ä¸Šäº¿ï¼Œå°±æ˜¯è¯´æ•°æ®ä»ä¸€ä¸ª mysql åº“åŸå°ä¸åŠ¨åœ°åŒæ­¥åˆ°å¦ä¸€ä¸ª mysql åº“é‡Œé¢å»ï¼ˆmysql -> mysqlï¼‰ã€‚å¸¸è§çš„ä¸€ç‚¹åœ¨äºè¯´æ¯”å¦‚å¤§æ•°æ® teamï¼Œå°±éœ€è¦åŒæ­¥ä¸€ä¸ª mysql åº“è¿‡æ¥ï¼Œå¯¹å…¬å¸çš„ä¸šåŠ¡ç³»ç»Ÿçš„æ•°æ®åšå„ç§å¤æ‚çš„æ“ä½œã€‚

ä½ åœ¨ mysql é‡Œå¢åˆ æ”¹ä¸€æ¡æ•°æ®ï¼Œå¯¹åº”å‡ºæ¥äº†å¢åˆ æ”¹ 3 æ¡ `binlog` æ—¥å¿—ï¼Œæ¥ç€è¿™ä¸‰æ¡ `binlog` å‘é€åˆ° MQ é‡Œé¢ï¼Œå†æ¶ˆè´¹å‡ºæ¥ä¾æ¬¡æ‰§è¡Œï¼Œèµ·ç å¾—ä¿è¯äººå®¶æ˜¯æŒ‰ç…§é¡ºåºæ¥çš„å§ï¼Ÿä¸ç„¶æœ¬æ¥æ˜¯ï¼šå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ï¼›ä½ æ¥æ˜¯æ¢äº†é¡ºåºç»™æ‰§è¡Œæˆåˆ é™¤ã€ä¿®æ”¹ã€å¢åŠ ï¼Œä¸å…¨é”™äº†ä¹ˆã€‚

æœ¬æ¥è¿™ä¸ªæ•°æ®åŒæ­¥è¿‡æ¥ï¼Œåº”è¯¥æœ€åè¿™ä¸ªæ•°æ®è¢«åˆ é™¤äº†ï¼›ç»“æœä½ æé”™äº†è¿™ä¸ªé¡ºåºï¼Œæœ€åè¿™ä¸ªæ•°æ®ä¿ç•™ä¸‹æ¥äº†ï¼Œæ•°æ®åŒæ­¥å°±å‡ºé”™äº†ã€‚

å…ˆçœ‹çœ‹é¡ºåºä¼šé”™ä¹±çš„ä¿©åœºæ™¯ï¼š

ä¸€ä¸ª queueï¼Œå¤šä¸ª consumerã€‚æ¯”å¦‚ï¼Œç”Ÿäº§è€…å‘ RabbitMQ é‡Œå‘é€äº†ä¸‰æ¡æ•°æ®ï¼Œé¡ºåºä¾æ¬¡æ˜¯ data1/data2/data3ï¼Œå‹å…¥çš„æ˜¯ RabbitMQ çš„ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—ã€‚æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…åˆ†åˆ«ä» MQ ä¸­æ¶ˆè´¹è¿™ä¸‰æ¡æ•°æ®ä¸­çš„ä¸€æ¡ï¼Œç»“æœæ¶ˆè´¹è€…2å…ˆæ‰§è¡Œå®Œæ“ä½œï¼ŒæŠŠ data2 å­˜å…¥æ•°æ®åº“ï¼Œç„¶åæ˜¯ data1/data3ã€‚è¿™ä¸æ˜æ˜¾ä¹±äº†ã€‚

![image-20220606105701838](./images/image-20220606105701838.png)

è§£å†³ï¼šæ‹†åˆ†å¤šä¸ª queueï¼Œæ¯ä¸ª queue ä¸€ä¸ª consumerï¼Œå°±æ˜¯å¤šä¸€äº› queue è€Œå·²ï¼Œç¡®å®æ˜¯éº»çƒ¦ç‚¹ï¼›æˆ–è€…å°±ä¸€ä¸ª queue ä½†æ˜¯å¯¹åº”ä¸€ä¸ª consumerï¼Œç„¶åè¿™ä¸ª consumer å†…éƒ¨ç”¨å†…å­˜é˜Ÿåˆ—åšæ’é˜Ÿï¼Œç„¶ååˆ†å‘ç»™åº•å±‚ä¸åŒçš„ worker æ¥å¤„ç†ã€‚åŒä¸€ä¸ªè®¢å•å·çš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€ä¸ª queue ä¸­ï¼Œç”±äºåŒä¸€ä¸ª queue çš„æ¶ˆæ¯æ˜¯ä¸€å®šä¼šä¿è¯æœ‰åºçš„ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªè®¢å•å·çš„æ¶ˆæ¯å°±åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…é¡ºåºæ¶ˆè´¹ï¼Œä»è€Œä¿è¯äº†æ¶ˆæ¯çš„é¡ºåºæ€§ã€‚

![image-20220712235743200](./images/image-20220712235743200.png)

#### Kafka

Kafka  ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯è¿™ä¸€æ•´ä¸ªè¿‡ç¨‹å…¶å®éƒ½æ˜¯å¯ä»¥ä¿è¯æœ‰åºçš„ï¼Œå¯¼è‡´æœ€ç»ˆä¹±åºæ˜¯ç”±äºæ¶ˆè´¹è€…ç«¯éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘å¤„ç†æ¶ˆæ¯æ¥æé«˜ååé‡ï¼Œæ¯”å¦‚æ¶ˆè´¹è€…æ¶ˆè´¹åˆ°äº†æ¶ˆæ¯ä»¥åï¼Œå¼€å¯ 32 ä¸ªçº¿ç¨‹å¤„ç†æ¶ˆæ¯ï¼Œæ¯ä¸ªçº¿ç¨‹çº¿ç¨‹å¤„ç†æ¶ˆæ¯çš„å¿«æ…¢æ˜¯ä¸ä¸€è‡´çš„ï¼Œæ‰€ä»¥æ‰ä¼šå¯¼è‡´æœ€ç»ˆæ¶ˆæ¯æœ‰å¯èƒ½ä¸ä¸€è‡´ã€‚

æ¯”å¦‚è¯´æˆ‘ä»¬å»ºäº†ä¸€ä¸ª topicï¼Œæœ‰ä¸‰ä¸ª partitionã€‚ç”Ÿäº§è€…åœ¨å†™çš„æ—¶å€™ï¼Œå…¶å®å¯ä»¥æŒ‡å®šä¸€ä¸ª keyï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬æŒ‡å®šäº†æŸä¸ªè®¢å• id ä½œä¸º keyï¼Œé‚£ä¹ˆè¿™ä¸ªè®¢å•ç›¸å…³çš„æ•°æ®ï¼Œä¸€å®šä¼šè¢«åˆ†å‘åˆ°åŒä¸€ä¸ª partition ä¸­å»ï¼Œè€Œä¸”è¿™ä¸ª partition ä¸­çš„æ•°æ®ä¸€å®šæ˜¯æœ‰é¡ºåºçš„ã€‚

æ¶ˆè´¹è€…ä» partition ä¸­å–å‡ºæ¥æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¸€å®šæ˜¯æœ‰é¡ºåºçš„ã€‚åˆ°è¿™é‡Œï¼Œé¡ºåºè¿˜æ˜¯ ok çš„ï¼Œæ²¡æœ‰é”™ä¹±ã€‚æ¥ç€ï¼Œæˆ‘ä»¬åœ¨æ¶ˆè´¹è€…é‡Œå¯èƒ½ä¼šæ**å¤šä¸ªçº¿ç¨‹æ¥å¹¶å‘å¤„ç†æ¶ˆæ¯**ã€‚å› ä¸ºå¦‚æœæ¶ˆè´¹è€…æ˜¯å•çº¿ç¨‹æ¶ˆè´¹å¤„ç†ï¼Œè€Œå¤„ç†æ¯”è¾ƒè€—æ—¶çš„è¯ï¼Œæ¯”å¦‚å¤„ç†ä¸€æ¡æ¶ˆæ¯è€—æ—¶å‡ å msï¼Œé‚£ä¹ˆ 1 ç§’é’Ÿåªèƒ½å¤„ç†å‡ åæ¡æ¶ˆæ¯ï¼Œè¿™ååé‡å¤ªä½äº†ã€‚è€Œå¤šä¸ªçº¿ç¨‹å¹¶å‘è·‘çš„è¯ï¼Œé¡ºåºå¯èƒ½å°±ä¹±æ‰äº†ã€‚

![image-20220606105925337](./images/image-20220606105925337.png)

è§£å†³ï¼š

- ä¸€ä¸ª topicï¼Œä¸€ä¸ª partitionï¼Œä¸€ä¸ª consumerï¼Œå†…éƒ¨å•çº¿ç¨‹æ¶ˆè´¹ï¼Œå•çº¿ç¨‹ååé‡å¤ªä½ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªã€‚
- æ‰€ä»¥å¯¹äº Kafka çš„æ¶ˆæ¯é¡ºåºæ€§ä¿è¯ï¼Œå…¶å®æˆ‘ä»¬åªéœ€è¦ä¿è¯åŒä¸€ä¸ªè®¢å•å·çš„æ¶ˆæ¯åªè¢«åŒä¸€ä¸ªçº¿ç¨‹å¤„ç†çš„å°±å¯ä»¥äº†ã€‚ç”±æ­¤æˆ‘ä»¬å¯ä»¥åœ¨çº¿ç¨‹å¤„ç†å‰å¢åŠ ä¸ªå†…å­˜é˜Ÿåˆ—ï¼Œæ¯ä¸ªçº¿ç¨‹åªè´Ÿè´£å¤„ç†å…¶ä¸­ä¸€ä¸ªå†…å­˜é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼ŒåŒä¸€ä¸ªè®¢å•å·çš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€ä¸ªå†…å­˜é˜Ÿåˆ—ä¸­å³å¯ã€‚

![image-20220713000139006](./images/image-20220713000139006.png)

### å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œäº‹åŠ¡æ¶ˆæ¯å¦‚ä½•å®ç°

ä¸€æ¡æ™®é€šçš„ MQ æ¶ˆæ¯ï¼Œä»äº§ç”Ÿåˆ°è¢«æ¶ˆè´¹ï¼Œå¤§æ¦‚æµç¨‹å¦‚ä¸‹ï¼š

![image-20220622201746536](./images/image-20220622201746536.png)

1. ç”Ÿäº§è€…äº§ç”Ÿæ¶ˆæ¯ï¼Œå‘é€å¸¦ MQ æœåŠ¡å™¨
2. MQ æ”¶åˆ°æ¶ˆæ¯åï¼Œå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°å­˜å‚¨ç³»ç»Ÿã€‚
3. MQ æœåŠ¡å™¨è¿”å› ACk åˆ°ç”Ÿäº§è€…ã€‚
4. MQ æœåŠ¡å™¨æŠŠæ¶ˆæ¯ push ç»™æ¶ˆè´¹è€…
5. æ¶ˆè´¹è€…æ¶ˆè´¹å®Œæ¶ˆæ¯ï¼Œå“åº” ACK
6. MQ æœåŠ¡å™¨æ”¶åˆ° ACKï¼Œè®¤ä¸ºæ¶ˆæ¯æ¶ˆè´¹æˆåŠŸï¼Œå³åœ¨å­˜å‚¨ä¸­åˆ é™¤æ¶ˆæ¯ã€‚

æˆ‘ä»¬ä¸¾ä¸ªä¸‹è®¢å•çš„ä¾‹å­å§ã€‚è®¢å•ç³»ç»Ÿåˆ›å»ºå®Œè®¢å•åï¼Œå†å‘é€æ¶ˆæ¯ç»™ä¸‹æ¸¸ç³»ç»Ÿã€‚å¦‚æœè®¢å•åˆ›å»ºæˆåŠŸï¼Œç„¶åæ¶ˆæ¯æ²¡æœ‰æˆåŠŸå‘é€å‡ºå»ï¼Œä¸‹æ¸¸ç³»ç»Ÿå°±æ— æ³•æ„ŸçŸ¥è¿™ä¸ªäº‹æƒ…ï¼Œå‡ºå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚
å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯ã€‚ä¸€èµ·æ¥çœ‹ä¸‹äº‹åŠ¡æ¶ˆæ¯æ˜¯å¦‚ä½•å®ç°çš„

![image-20220622201820014](./images/image-20220622201820014.png)

1. ç”Ÿäº§è€…äº§ç”Ÿæ¶ˆæ¯ï¼Œå‘é€ä¸€æ¡åŠäº‹åŠ¡æ¶ˆæ¯åˆ° MQ æœåŠ¡å™¨
2. MQ æ”¶åˆ°æ¶ˆæ¯åï¼Œå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°å­˜å‚¨ç³»ç»Ÿï¼Œè¿™æ¡æ¶ˆæ¯çš„çŠ¶æ€æ˜¯å¾…å‘é€çŠ¶æ€ã€‚
3. MQ æœåŠ¡å™¨è¿”å› ACK ç¡®è®¤åˆ°ç”Ÿäº§è€…ï¼Œæ­¤æ—¶ MQ ä¸ä¼šè§¦å‘æ¶ˆæ¯æ¨é€äº‹ä»¶
4. ç”Ÿäº§è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
5. å¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå³ commit æ‰§è¡Œç»“æœåˆ° MQ æœåŠ¡å™¨ï¼›å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œå‘
   é€ rollbackã€‚
6. å¦‚æœæ˜¯æ­£å¸¸çš„ commitï¼ŒMQ æœåŠ¡å™¨æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå¯å‘é€ï¼›å¦‚æœæ˜¯ rollbackï¼Œå³
   åˆ é™¤æ¶ˆæ¯ã€‚
7. å¦‚æœæ¶ˆæ¯çŠ¶æ€æ›´æ–°ä¸ºå¯å‘é€ï¼Œåˆ™ MQ æœåŠ¡å™¨ä¼š push æ¶ˆæ¯ç»™æ¶ˆè´¹è€…ã€‚æ¶ˆè´¹è€…æ¶ˆè´¹å®Œ
   å°±å› ACKã€‚
8. å¦‚æœ MQ æœåŠ¡å™¨é•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°ç”Ÿäº§è€…çš„ commit æˆ–è€… rollbackï¼Œå®ƒä¼šåæŸ¥ç”Ÿäº§
   è€…ï¼Œç„¶åæ ¹æ®æŸ¥è¯¢åˆ°çš„ç»“æœæ‰§è¡Œæœ€ç»ˆçŠ¶æ€ã€‚

### å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿ

### å¦‚ä½•è§£å†³é‡å¤æ¶ˆè´¹

å°±ä¸¤ä¸ªå­—â€”â€” **å¹‚ç­‰** ã€‚åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ª*å¹‚ç­‰*  æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚æ¯”å¦‚è¯´ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•çš„å¤„ç†ç§¯åˆ†çš„ç³»ç»Ÿï¼Œæ¯å½“æ¥ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™å®ƒå°±è´Ÿè´£ä¸ºåˆ›å»ºè¿™ä¸ªè®¢å•çš„ç”¨æˆ·çš„ç§¯åˆ†åŠ ä¸Šç›¸åº”çš„æ•°å€¼ã€‚å¯æ˜¯æœ‰ä¸€æ¬¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å‘é€ç»™è®¢å•ç³»ç»Ÿ FrancisQ çš„è®¢å•ä¿¡æ¯ï¼Œå…¶è¦æ±‚æ˜¯ç»™ FrancisQ çš„ç§¯åˆ†åŠ ä¸Š 500ã€‚ä½†æ˜¯ç§¯åˆ†ç³»ç»Ÿåœ¨æ”¶åˆ° FrancisQ  çš„è®¢å•ä¿¡æ¯å¤„ç†å®Œæˆä¹‹åè¿”å›ç»™æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æˆåŠŸçš„ä¿¡æ¯çš„æ—¶å€™å‡ºç°äº†ç½‘ç»œæ³¢åŠ¨(å½“ç„¶è¿˜æœ‰å¾ˆå¤šç§æƒ…å†µï¼Œæ¯”å¦‚Brokeræ„å¤–é‡å¯ç­‰ç­‰)ï¼Œè¿™æ¡å›åº”æ²¡æœ‰å‘é€æˆåŠŸã€‚

é‚£ä¹ˆï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ²¡æ”¶åˆ°ç§¯åˆ†ç³»ç»Ÿçš„å›åº”ä¼šä¸ä¼šå°è¯•é‡å‘è¿™ä¸ªæ¶ˆæ¯ï¼Ÿé—®é¢˜å°±æ¥äº†ï¼Œæˆ‘å†å‘è¿™ä¸ªæ¶ˆæ¯ï¼Œä¸‡ä¸€å®ƒåˆç»™ FrancisQ çš„è´¦æˆ·åŠ ä¸Š 500 ç§¯åˆ†æ€ä¹ˆåŠå‘¢ï¼Ÿ

æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™æˆ‘ä»¬çš„æ¶ˆè´¹è€…å®ç° **å¹‚ç­‰** ï¼Œä¹Ÿå°±æ˜¯å¯¹åŒä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†ç»“æœï¼Œæ‰§è¡Œå¤šå°‘æ¬¡éƒ½ä¸å˜ã€‚

é‚£ä¹ˆå¦‚ä½•ç»™ä¸šåŠ¡å®ç°å¹‚ç­‰å‘¢ï¼Ÿè¿™ä¸ªè¿˜æ˜¯éœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡çš„ã€‚ä½ å¯ä»¥ä½¿ç”¨ **å†™å…¥ `Redis`** æ¥ä¿è¯ï¼Œå› ä¸º `Redis` çš„ `key` å’Œ `value` å°±æ˜¯å¤©ç„¶æ”¯æŒå¹‚ç­‰çš„ã€‚å½“ç„¶è¿˜æœ‰ä½¿ç”¨ **æ•°æ®åº“æ’å…¥æ³•** ï¼ŒåŸºäºæ•°æ®åº“çš„å”¯ä¸€é”®æ¥ä¿è¯é‡å¤æ•°æ®ä¸ä¼šè¢«æ’å…¥å¤šæ¡ã€‚

ä¸è¿‡æœ€ä¸»è¦çš„è¿˜æ˜¯éœ€è¦ **æ ¹æ®ç‰¹å®šåœºæ™¯ä½¿ç”¨ç‰¹å®šçš„è§£å†³æ–¹æ¡ˆ** ï¼Œä½ è¦çŸ¥é“ä½ çš„æ¶ˆæ¯æ¶ˆè´¹æ˜¯å¦æ˜¯å®Œå…¨ä¸å¯é‡å¤æ¶ˆè´¹è¿˜æ˜¯å¯ä»¥å¿å—é‡å¤æ¶ˆè´¹çš„ï¼Œç„¶åå†é€‰æ‹©å¼ºæ ¡éªŒå’Œå¼±æ ¡éªŒçš„æ–¹å¼ã€‚æ¯•ç«Ÿåœ¨ CS é¢†åŸŸè¿˜æ˜¯å¾ˆå°‘æœ‰æŠ€æœ¯é“¶å¼¹çš„è¯´æ³•ã€‚

è€Œåœ¨æ•´ä¸ªäº’è”ç½‘é¢†åŸŸï¼Œå¹‚ç­‰ä¸ä»…ä»…é€‚ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—çš„é‡å¤æ¶ˆè´¹é—®é¢˜ï¼Œè¿™äº›å®ç°å¹‚ç­‰çš„æ–¹æ³•ï¼Œä¹ŸåŒæ ·é€‚ç”¨äºï¼Œ**åœ¨å…¶ä»–åœºæ™¯ä¸­æ¥è§£å†³é‡å¤è¯·æ±‚æˆ–è€…é‡å¤è°ƒç”¨çš„é—®é¢˜** ã€‚æ¯”å¦‚å°†HTTPæœåŠ¡è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œ**è§£å†³å‰ç«¯æˆ–è€…APPé‡å¤æäº¤è¡¨å•æ•°æ®çš„é—®é¢˜** ï¼Œä¹Ÿå¯ä»¥å°†ä¸€ä¸ªå¾®æœåŠ¡è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œè§£å†³ `RPC` æ¡†æ¶è‡ªåŠ¨é‡è¯•å¯¼è‡´çš„ **é‡å¤è°ƒç”¨é—®é¢˜** ã€‚

> å¸¸ç”¨çš„ä¸šåŠ¡å¹‚ç­‰æ€§ä¿è¯æ–¹æ³•

1. åˆ©ç”¨æ•°æ®åº“çš„å”¯ä¸€çº¦æŸå®ç°å¹‚ç­‰

æ¯”å¦‚å°†è®¢å•è¡¨ä¸­çš„è®¢å•ç¼–å·è®¾ç½®ä¸ºå”¯ä¸€ç´¢å¼•ï¼Œåˆ›å»ºè®¢å•æ—¶ï¼Œæ ¹æ®è®¢å•ç¼–å·å°±å¯ä»¥ä¿è¯å¹‚ç­‰

2. å»é‡è¡¨

è¿™ä¸ªæ–¹æ¡ˆæœ¬è´¨ä¹Ÿæ˜¯æ ¹æ®æ•°æ®åº“çš„å”¯ä¸€æ€§çº¦æŸæ¥å®ç°ã€‚å…¶å®ç°å¤§ä½“æ€è·¯æ˜¯ï¼šé¦–å…ˆåœ¨å»é‡è¡¨ä¸Šå»ºå”¯ä¸€ç´¢å¼•ï¼Œå…¶æ¬¡æ“ä½œæ—¶æŠŠä¸šåŠ¡è¡¨å’Œå»é‡è¡¨æ”¾åœ¨åŒä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ï¼Œå¦‚æœå‡ºç°é‡ç°é‡å¤æ¶ˆè´¹ï¼Œæ•°æ®åº“ä¼šæŠ›å”¯ä¸€çº¦æŸå¼‚å¸¸ï¼Œæ“ä½œå°±ä¼šå›æ»š

3. åˆ©ç”¨redisçš„åŸå­æ€§

æ¯æ¬¡æ“ä½œéƒ½ç›´æ¥setåˆ°redisé‡Œé¢ï¼Œç„¶åå°†redisæ•°æ®å®šæ—¶åŒæ­¥åˆ°æ•°æ®åº“ä¸­

4. å¤šç‰ˆæœ¬ï¼ˆä¹è§‚é”ï¼‰æ§åˆ¶

æ­¤æ–¹æ¡ˆå¤šç”¨äºæ›´æ–°çš„åœºæ™¯ä¸‹ã€‚å…¶å®ç°çš„å¤§ä½“æ€è·¯æ˜¯ï¼šç»™ä¸šåŠ¡æ•°æ®å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·å±æ€§ï¼Œæ¯æ¬¡æ›´æ–°æ•°æ®å‰ï¼Œæ¯”è¾ƒå½“å‰æ•°æ®çš„ç‰ˆæœ¬å·æ˜¯å¦å’Œæ¶ˆæ¯ä¸­çš„ç‰ˆæœ¬ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™æ‹’ç»æ›´æ–°æ•°æ®ï¼Œæ›´æ–°æ•°æ®çš„åŒæ—¶å°†ç‰ˆæœ¬å·+1

5. çŠ¶æ€æœºæœºåˆ¶

æ­¤æ–¹æ¡ˆå¤šç”¨äºæ›´æ–°ä¸”ä¸šåŠ¡åœºæ™¯å­˜åœ¨å¤šç§çŠ¶æ€æµè½¬çš„åœºæ™¯

6. tokenæœºåˆ¶

ç”Ÿäº§è€…å‘é€æ¯æ¡æ•°æ®çš„æ—¶å€™ï¼Œå¢åŠ ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„idï¼Œè¿™ä¸ªidé€šå¸¸æ˜¯**ä¸šåŠ¡çš„å”¯ä¸€æ ‡è¯†**ï¼Œæ¯”å¦‚è®¢å•ç¼–å·ã€‚åœ¨æ¶ˆè´¹ç«¯æ¶ˆè´¹æ—¶ï¼Œåˆ™éªŒè¯è¯¥idæ˜¯å¦è¢«æ¶ˆè´¹è¿‡ï¼Œå¦‚æœè¿˜æ²¡æ¶ˆè´¹è¿‡ï¼Œåˆ™è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚å¤„ç†ç»“æŸåï¼Œåœ¨æŠŠè¯¥idå­˜å…¥redisï¼ŒåŒæ—¶è®¾ç½®çŠ¶æ€ä¸ºå·²æ¶ˆè´¹ã€‚å¦‚æœå·²ç»æ¶ˆè´¹è¿‡äº†ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†ã€‚

### æ¶ˆæ¯å †ç§¯é—®é¢˜

åœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½â€”â€”**å‰Šå³°** ã€‚é‚£ä¹ˆå¦‚æœè¿™ä¸ªå³°å€¼å¤ªå¤§äº†å¯¼è‡´æ¶ˆæ¯å †ç§¯åœ¨é˜Ÿåˆ—ä¸­æ€ä¹ˆåŠå‘¢ï¼Ÿ

å…¶å®è¿™ä¸ªé—®é¢˜å¯ä»¥å°†å®ƒå¹¿ä¹‰åŒ–ï¼Œå› ä¸ºäº§ç”Ÿæ¶ˆæ¯å †ç§¯çš„æ ¹æºå…¶å®å°±åªæœ‰ä¸¤ä¸ªâ€”â€”ç”Ÿäº§è€…ç”Ÿäº§å¤ªå¿«æˆ–è€…æ¶ˆè´¹è€…æ¶ˆè´¹å¤ªæ…¢ã€‚

æˆ‘ä»¬å¯ä»¥ä»å¤šä¸ªè§’åº¦å»æ€è€ƒè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“æµé‡åˆ°å³°å€¼çš„æ—¶å€™æ˜¯å› ä¸ºç”Ÿäº§è€…ç”Ÿäº§å¤ªå¿«ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº› **é™æµé™çº§** çš„æ–¹æ³•ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å¢åŠ å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹å»æ°´å¹³æ‰©å±•å¢åŠ æ¶ˆè´¹èƒ½åŠ›æ¥åŒ¹é…ç”Ÿäº§çš„æ¿€å¢ã€‚å¦‚æœæ¶ˆè´¹è€…æ¶ˆè´¹è¿‡æ…¢çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ£€æŸ¥ **æ˜¯å¦æ˜¯æ¶ˆè´¹è€…å‡ºç°äº†å¤§é‡çš„æ¶ˆè´¹é”™è¯¯** ï¼Œæˆ–è€…æ‰“å°ä¸€ä¸‹æ—¥å¿—æŸ¥çœ‹æ˜¯å¦æ˜¯å“ªä¸€ä¸ªçº¿ç¨‹å¡æ­»ï¼Œå‡ºç°äº†é”èµ„æºä¸é‡Šæ”¾ç­‰ç­‰çš„é—®é¢˜ã€‚

> å½“ç„¶ï¼Œæœ€å¿«é€Ÿè§£å†³æ¶ˆæ¯å †ç§¯é—®é¢˜çš„æ–¹æ³•è¿˜æ˜¯å¢åŠ æ¶ˆè´¹è€…å®ä¾‹ï¼Œä¸è¿‡ **åŒæ—¶ä½ è¿˜éœ€è¦å¢åŠ æ¯ä¸ªä¸»é¢˜çš„é˜Ÿåˆ—æ•°é‡** ã€‚
>
> åˆ«å¿˜äº†åœ¨ `RocketMQ` ä¸­ï¼Œ**ä¸€ä¸ªé˜Ÿåˆ—åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹** ï¼Œå¦‚æœä½ ä»…ä»…æ˜¯å¢åŠ æ¶ˆè´¹è€…å®ä¾‹å°±ä¼šå‡ºç°æˆ‘ä¸€å¼€å§‹ç»™ä½ ç”»æ¶æ„å›¾çš„é‚£ç§æƒ…å†µ

![image-20220617111103393](./images/image-20220617111103393.png)

## ğŸ”— åˆ†å¸ƒå¼

### äº†è§£RPCå—ï¼Ÿ

ä¸€è¨€è”½ä¹‹ï¼š**RPC ï¼ˆRemote Procedure Callï¼‰çš„å‡ºç°å°±æ˜¯ä¸ºäº†è®©ä½ è°ƒç”¨è¿œç¨‹æ–¹æ³•åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•ã€‚**

ä¸ºäº†èƒ½å¤Ÿå¸®åŠ©å°ä¼™ä¼´ä»¬ç†è§£ RPC åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ª RPCçš„ æ ¸å¿ƒåŠŸèƒ½çœ‹ä½œæ˜¯ä¸‹é¢ğŸ‘‡ 6 ä¸ªéƒ¨åˆ†å®ç°çš„ï¼š

1. **å®¢æˆ·ç«¯ï¼ˆæœåŠ¡æ¶ˆè´¹ç«¯ï¼‰** ï¼šè°ƒç”¨è¿œç¨‹æ–¹æ³•çš„ä¸€ç«¯ã€‚
2. **å®¢æˆ·ç«¯ Stubï¼ˆæ¡©ï¼‰** ï¼š è¿™å…¶å®å°±æ˜¯ä¸€ä»£ç†ç±»ã€‚ä»£ç†ç±»ä¸»è¦åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠä½ è°ƒç”¨æ–¹æ³•ã€ç±»ã€æ–¹æ³•å‚æ•°ç­‰ä¿¡æ¯ä¼ é€’åˆ°æœåŠ¡ç«¯ã€‚
3. **ç½‘ç»œä¼ è¾“** ï¼š ç½‘ç»œä¼ è¾“å°±æ˜¯ä½ è¦æŠŠä½ è°ƒç”¨çš„æ–¹æ³•çš„ä¿¡æ¯æ¯”å¦‚è¯´å‚æ•°å•Šè¿™äº›ä¸œè¥¿ä¼ è¾“åˆ°æœåŠ¡ç«¯ï¼Œç„¶åæœåŠ¡ç«¯æ‰§è¡Œå®Œä¹‹åå†æŠŠè¿”å›ç»“æœé€šè¿‡ç½‘ç»œä¼ è¾“ç»™ä½ ä¼ è¾“å›æ¥ã€‚ç½‘ç»œä¼ è¾“çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§æ¯”å¦‚æœ€è¿‘åŸºæœ¬çš„ Socketæˆ–è€…æ€§èƒ½ä»¥åŠå°è£…æ›´åŠ ä¼˜ç§€çš„ Nettyï¼ˆæ¨èï¼‰ã€‚
4. **æœåŠ¡ç«¯ Stubï¼ˆæ¡©ï¼‰** ï¼šè¿™ä¸ªæ¡©å°±ä¸æ˜¯ä»£ç†ç±»äº†ã€‚æˆ‘è§‰å¾—ç†è§£ä¸ºæ¡©å®é™…ä¸å¤ªå¥½ï¼Œå¤§å®¶æ³¨æ„ä¸€ä¸‹å°±å¥½ã€‚è¿™é‡Œçš„æœåŠ¡ç«¯ Stub å®é™…æŒ‡çš„å°±æ˜¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯æ‰§è¡Œæ–¹æ³•çš„è¯·æ±‚åï¼Œå»æŒ‡å®šå¯¹åº”çš„æ–¹æ³•ç„¶åè¿”å›ç»“æœç»™å®¢æˆ·ç«¯çš„ç±»ã€‚
5. **æœåŠ¡ç«¯ï¼ˆæœåŠ¡æä¾›ç«¯ï¼‰** ï¼šæä¾›è¿œç¨‹æ–¹æ³•çš„ä¸€ç«¯ã€‚

å…·ä½“åŸç†å›¾å¦‚ä¸‹ï¼Œåé¢æˆ‘ä¼šä¸²èµ·æ¥å°†æ•´ä¸ªRPCçš„è¿‡ç¨‹ç»™å¤§å®¶è¯´ä¸€ä¸‹ã€‚

![image-20220609151233412](./images/image-20220609151233412.png)

1. æœåŠ¡æ¶ˆè´¹ç«¯ï¼ˆclientï¼‰ä»¥æœ¬åœ°è°ƒç”¨çš„æ–¹å¼è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼›
2. å®¢æˆ·ç«¯ Stubï¼ˆclient stubï¼‰ æ¥æ”¶åˆ°è°ƒç”¨åè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰ç»„è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“ï¼ˆåºåˆ—åŒ–ï¼‰ï¼š`RpcRequest`ï¼›
3. å®¢æˆ·ç«¯ Stubï¼ˆclient stubï¼‰ æ‰¾åˆ°è¿œç¨‹æœåŠ¡çš„åœ°å€ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€åˆ°æœåŠ¡æä¾›ç«¯ï¼›
4. æœåŠ¡ç«¯ Stubï¼ˆæ¡©ï¼‰æ”¶åˆ°æ¶ˆæ¯å°†æ¶ˆæ¯ååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡: `RpcRequest`ï¼›
5. æœåŠ¡ç«¯ Stubï¼ˆæ¡©ï¼‰æ ¹æ® `RpcRequest`ä¸­çš„ç±»ã€æ–¹æ³•ã€æ–¹æ³•å‚æ•°ç­‰ä¿¡æ¯è°ƒç”¨æœ¬åœ°çš„æ–¹æ³•ï¼›
6. æœåŠ¡ç«¯ Stubï¼ˆæ¡©ï¼‰å¾—åˆ°æ–¹æ³•æ‰§è¡Œç»“æœå¹¶å°†ç»„è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“ï¼š`RpcResponse`ï¼ˆåºåˆ—åŒ–ï¼‰å‘é€è‡³æ¶ˆè´¹æ–¹ï¼›
7. å®¢æˆ·ç«¯ Stubï¼ˆclient stubï¼‰æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶å°†æ¶ˆæ¯ååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡:`RpcResponse` ï¼Œè¿™æ ·ä¹Ÿå°±å¾—åˆ°äº†æœ€ç»ˆç»“æœã€‚over!

ç›¸ä¿¡å°ä¼™ä¼´ä»¬çœ‹å®Œä¸Šé¢çš„è®²è§£ä¹‹åï¼Œå·²ç»äº†è§£äº† RPC çš„åŸç†ã€‚

è™½ç„¶ç¯‡å¹…ä¸å¤šï¼Œä½†æ˜¯åŸºæœ¬æŠŠ RPC æ¡†æ¶çš„æ ¸å¿ƒåŸç†è®²æ¸…æ¥šäº†ï¼å¦å¤–ï¼Œå¯¹äºä¸Šé¢çš„æŠ€æœ¯ç»†èŠ‚ï¼Œæˆ‘ä¼šåœ¨åé¢çš„ç« èŠ‚ä»‹ç»åˆ°ã€‚

**æœ€åï¼Œå¯¹äº RPC çš„åŸç†ï¼Œå¸Œæœ›å°ä¼™ä¼´ä¸å•å•è¦ç†è§£ï¼Œè¿˜è¦èƒ½å¤Ÿè‡ªå·±ç”»å‡ºæ¥å¹¶ä¸”èƒ½å¤Ÿç»™åˆ«äººè®²å‡ºæ¥ã€‚å› ä¸ºï¼Œåœ¨é¢è¯•ä¸­è¿™ä¸ªé—®é¢˜åœ¨é¢è¯•å®˜é—®åˆ° RPC ç›¸å…³å†…å®¹çš„æ—¶å€™åŸºæœ¬éƒ½ä¼šç¢°åˆ°ã€‚**



### æœ‰å“ªäº›å¸¸è§çš„ RPC æ¡†æ¶ï¼Ÿ

æˆ‘ä»¬è¿™é‡Œè¯´çš„ RPC æ¡†æ¶æŒ‡çš„æ˜¯å¯ä»¥è®©å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•çš„æ¡†æ¶ï¼Œæ¯”å¦‚æˆ‘ä¸‹é¢ä»‹ç»çš„  Dubboã€Motanã€gRPCè¿™äº›ã€‚ å¦‚æœéœ€è¦å’Œ HTTP åè®®æ‰“äº¤é“ï¼Œè§£æå’Œå°è£… HTTP è¯·æ±‚å’Œå“åº”ã€‚è¿™ç±»æ¡†æ¶å¹¶ä¸èƒ½ç®—æ˜¯â€œRPC  æ¡†æ¶â€ï¼Œæ¯”å¦‚Feign

#### Dubbo

![image-20220723235648648](images/image-20220723235648648.png)

Apache Dubbo æ˜¯ä¸€æ¬¾å¾®æœåŠ¡æ¡†æ¶ï¼Œä¸ºå¤§è§„æ¨¡å¾®æœåŠ¡å®è·µæä¾›é«˜æ€§èƒ½ RPC é€šä¿¡ã€æµé‡æ²»ç†ã€å¯è§‚æµ‹æ€§ç­‰è§£å†³æ–¹æ¡ˆï¼Œ æ¶µç›– Javaã€Golang ç­‰å¤šç§è¯­è¨€ SDK å®ç°ã€‚

Dubbo æä¾›äº†ä»æœåŠ¡å®šä¹‰ã€æœåŠ¡å‘ç°ã€æœåŠ¡é€šä¿¡åˆ°æµé‡ç®¡æ§ç­‰å‡ ä¹æ‰€æœ‰çš„æœåŠ¡æ²»ç†èƒ½åŠ›ï¼Œæ”¯æŒ Triple åè®®ï¼ˆåŸºäº HTTP/2 ä¹‹ä¸Šå®šä¹‰çš„ä¸‹ä¸€ä»£ RPC é€šä¿¡åè®®ï¼‰ã€åº”ç”¨çº§æœåŠ¡å‘ç°ã€Dubbo Mesh ï¼ˆDubbo3 èµ‹äºˆäº†å¾ˆå¤šäº‘åŸç”Ÿå‹å¥½çš„æ–°ç‰¹æ€§ï¼‰ç­‰ç‰¹æ€§ã€‚

![image-20220723235657177](images/image-20220723235657177.png)

Dubbo æ˜¯ç”±é˜¿é‡Œå¼€æºï¼Œåæ¥åŠ å…¥äº† Apache ã€‚æ­£å¼ç”±äº Dubbo çš„å‡ºç°ï¼Œæ‰ä½¿å¾—è¶Šæ¥è¶Šå¤šçš„å…¬å¸å¼€å§‹ä½¿ç”¨ä»¥åŠæ¥å—åˆ†å¸ƒå¼æ¶æ„ã€‚

Dubbo ç®—çš„æ˜¯æ¯”è¾ƒä¼˜ç§€çš„å›½äº§å¼€æºé¡¹ç›®äº†ï¼Œå®ƒçš„æºç ä¹Ÿæ˜¯éå¸¸å€¼å¾—å­¦ä¹ å’Œé˜…è¯»çš„ï¼

- Github ï¼šhttps://github.com/apache/incubator-dubbo
- å®˜ç½‘ï¼šhttps://dubbo.apache.org/zh/



#### Motan

Motan æ˜¯æ–°æµªå¾®åšå¼€æºçš„ä¸€æ¬¾ RPC æ¡†æ¶ï¼Œæ®è¯´åœ¨æ–°æµªå¾®åšæ­£æ”¯æ’‘ç€åƒäº¿æ¬¡è°ƒç”¨ã€‚ä¸è¿‡ç¬”è€…å€’æ˜¯å¾ˆå°‘çœ‹åˆ°æœ‰å…¬å¸ä½¿ç”¨ï¼Œè€Œä¸”ç½‘ä¸Šçš„èµ„æ–™ä¹Ÿæ¯”è¾ƒå°‘ã€‚

å¾ˆå¤šäººå–œæ¬¢æ‹¿ Motan å’Œ Dubbo ä½œæ¯”è¾ƒï¼Œæ¯•ç«Ÿéƒ½æ˜¯å›½å†…å¤§å…¬å¸å¼€æºçš„ã€‚ç¬”è€…åœ¨æŸ¥é˜…äº†å¾ˆå¤šèµ„æ–™ï¼Œä»¥åŠç®€å•æŸ¥çœ‹äº†å…¶æºç ä¹‹åå‘ç°ï¼š**Motan æ›´åƒæ˜¯ä¸€ä¸ªç²¾ç®€ç‰ˆçš„ Dubboï¼Œå¯èƒ½æ˜¯å€Ÿé‰´äº† Dubbo çš„æ€æƒ³ï¼ŒMotan çš„è®¾è®¡æ›´åŠ ç²¾ç®€ï¼ŒåŠŸèƒ½æ›´åŠ çº¯ç²¹ã€‚**

ä¸è¿‡ï¼Œæˆ‘ä¸æ¨èä½ åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨ Motanã€‚å¦‚æœä½ è¦æ˜¯å…¬å¸å®é™…ä½¿ç”¨çš„è¯ï¼Œè¿˜æ˜¯æ¨è Dubbo ï¼Œå…¶ç¤¾åŒºæ´»è·ƒåº¦ä»¥åŠç”Ÿæ€éƒ½è¦å¥½å¾ˆå¤šã€‚

- ä» Motan çœ‹ RPC æ¡†æ¶è®¾è®¡ï¼šhttp://kriszhang.com/motan-rpc-impl/
- Motan ä¸­æ–‡æ–‡æ¡£ï¼šhttps://github.com/weibocom/motan/wiki/zh_overview



#### gRPC

![image-20220723235737977](images/image-20220723235737977.png)

gRPC æ˜¯ Google å¼€æºçš„ä¸€ä¸ªé«˜æ€§èƒ½ã€é€šç”¨çš„å¼€æº RPC æ¡†æ¶ã€‚å…¶ç”±ä¸»è¦é¢å‘ç§»åŠ¨åº”ç”¨å¼€å‘å¹¶åŸºäº HTTP/2 åè®®æ ‡å‡†è€Œè®¾è®¡ï¼ˆæ”¯æŒåŒå‘æµã€æ¶ˆæ¯å¤´å‹ç¼©ç­‰åŠŸèƒ½ï¼Œæ›´åŠ èŠ‚çœå¸¦å®½ï¼‰ï¼ŒåŸºäº ProtoBuf åºåˆ—åŒ–åè®®å¼€å‘ï¼Œå¹¶ä¸”æ”¯æŒä¼—å¤šå¼€å‘è¯­è¨€ã€‚

**ä½•è°“ ProtoBufï¼Ÿ** [ProtoBufï¼ˆ Protocol Bufferï¼‰](https://github.com/protocolbuffers/protobuf)

 æ˜¯ä¸€ç§æ›´åŠ çµæ´»ã€é«˜æ•ˆçš„æ•°æ®æ ¼å¼ï¼Œå¯ç”¨äºé€šè®¯åè®®ã€æ•°æ®å­˜å‚¨ç­‰é¢†åŸŸï¼ŒåŸºæœ¬æ”¯æŒæ‰€æœ‰ä¸»æµç¼–ç¨‹è¯­è¨€ä¸”ä¸å¹³å°æ— å…³ã€‚ä¸è¿‡ï¼Œé€šè¿‡ ProtoBuf å®šä¹‰æ¥å£å’Œæ•°æ®ç±»å‹è¿˜æŒºç¹ççš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå°é—®é¢˜ã€‚

![image-20220723235747598](images/image-20220723235747598.png)

ä¸å¾—ä¸è¯´ï¼ŒgRPC çš„é€šä¿¡å±‚çš„è®¾è®¡è¿˜æ˜¯éå¸¸ä¼˜ç§€çš„ï¼Œ[Dubbo-go 3.0](https://dubbogo.github.io/)

 çš„é€šä¿¡å±‚æ”¹è¿›ä¸»è¦å€Ÿé‰´äº† gRPCã€‚

ä¸è¿‡ï¼ŒgRPC çš„è®¾è®¡å¯¼è‡´å…¶å‡ ä¹æ²¡æœ‰æœåŠ¡æ²»ç†èƒ½åŠ›ã€‚å¦‚æœä½ æƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜çš„è¯ï¼Œå°±éœ€è¦ä¾èµ–å…¶ä»–ç»„ä»¶æ¯”å¦‚è…¾è®¯çš„ PolarisMeshï¼ˆåŒ—ææ˜Ÿï¼‰äº†ã€‚

- Githubï¼šhttps://github.com/grpc/grpc
- å®˜ç½‘ï¼šhttps://grpc.io/



#### Thrift

Apache Thrift æ˜¯ Facebook å¼€æºçš„è·¨è¯­è¨€çš„ RPC é€šä¿¡æ¡†æ¶ï¼Œç›®å‰å·²ç»æçŒ®ç»™ Apache  åŸºé‡‘ä¼šç®¡ç†ï¼Œç”±äºå…¶è·¨è¯­è¨€ç‰¹æ€§å’Œå‡ºè‰²çš„æ€§èƒ½ï¼Œåœ¨å¾ˆå¤šäº’è”ç½‘å…¬å¸å¾—åˆ°åº”ç”¨ï¼Œæœ‰èƒ½åŠ›çš„å…¬å¸ç”šè‡³ä¼šåŸºäº thrift  ç ”å‘ä¸€å¥—åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ï¼Œå¢åŠ è¯¸å¦‚æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°ç­‰åŠŸèƒ½ã€‚

`Thrift`æ”¯æŒå¤šç§ä¸åŒçš„**ç¼–ç¨‹è¯­è¨€**ï¼ŒåŒ…æ‹¬`C++`ã€`Java`ã€`Python`ã€`PHP`ã€`Ruby`ç­‰ï¼ˆç›¸æ¯”äº gRPC æ”¯æŒçš„è¯­è¨€æ›´å¤š ï¼‰ã€‚

- å®˜ç½‘ï¼šhttps://thrift.apache.org/
- Thrift ç®€å•ä»‹ç»ï¼šhttps://www.jianshu.com/p/8f25d057a5a9



#### æ€»ç»“

gRPC å’Œ Thrift è™½ç„¶æ”¯æŒè·¨è¯­è¨€çš„ RPC è°ƒç”¨ï¼Œä½†æ˜¯å®ƒä»¬åªæä¾›äº†æœ€åŸºæœ¬çš„ RPC æ¡†æ¶åŠŸèƒ½ï¼Œç¼ºä¹ä¸€ç³»åˆ—é…å¥—çš„æœåŠ¡åŒ–ç»„ä»¶å’ŒæœåŠ¡æ²»ç†åŠŸèƒ½çš„æ”¯æ’‘ã€‚

Dubbo ä¸è®ºæ˜¯ä»åŠŸèƒ½å®Œå–„ç¨‹åº¦ã€ç”Ÿæ€ç³»ç»Ÿè¿˜æ˜¯ç¤¾åŒºæ´»è·ƒåº¦æ¥è¯´éƒ½æ˜¯æœ€ä¼˜ç§€çš„ã€‚è€Œä¸”ï¼ŒDubboåœ¨å›½å†…æœ‰å¾ˆå¤šæˆåŠŸçš„æ¡ˆä¾‹æ¯”å¦‚å½“å½“ç½‘ã€æ»´æ»´ç­‰ç­‰ï¼Œæ˜¯ä¸€æ¬¾ç»å¾—èµ·ç”Ÿäº§è€ƒéªŒçš„æˆç†Ÿç¨³å®šçš„ RPC æ¡†æ¶ã€‚æœ€é‡è¦çš„æ˜¯ä½ è¿˜èƒ½æ‰¾åˆ°éå¸¸å¤šçš„ Dubbo å‚è€ƒèµ„æ–™ï¼Œå­¦ä¹ æˆæœ¬ç›¸å¯¹ä¹Ÿè¾ƒä½ã€‚

ä¸‹å›¾å±•ç¤ºäº† Dubbo çš„ç”Ÿæ€ç³»ç»Ÿã€‚

![image-20220723235849004](images/image-20220723235849004.png)

Dubbo ä¹Ÿæ˜¯ Spring Cloud Alibaba é‡Œé¢çš„ä¸€ä¸ªç»„ä»¶ã€‚

![image-20220723235856647](images/image-20220723235856647.png)

ä½†æ˜¯ï¼ŒDubbo å’Œ Motan ä¸»è¦æ˜¯ç»™ Java è¯­è¨€ä½¿ç”¨ã€‚è™½ç„¶ï¼ŒDubbo å’Œ Motan ç›®å‰ä¹Ÿèƒ½å…¼å®¹éƒ¨åˆ†è¯­è¨€ï¼Œä½†æ˜¯ä¸å¤ªæ¨èã€‚å¦‚æœéœ€è¦è·¨å¤šç§è¯­è¨€è°ƒç”¨çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ gRPCã€‚

ç»¼ä¸Šï¼Œå¦‚æœæ˜¯ Java åç«¯æŠ€æœ¯æ ˆï¼Œå¹¶ä¸”ä½ åœ¨çº ç»“é€‰æ‹©å“ªä¸€ç§ RPC æ¡†æ¶çš„è¯ï¼Œæˆ‘æ¨èä½ è€ƒè™‘ä¸€ä¸‹ Dubbo



### äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡å—ï¼Ÿ

æˆ‘æ¥è§¦å’Œäº†è§£åˆ°çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤§æ¦‚åˆ†ä¸ºï¼š

- 2pcï¼ˆä¸¤æ®µå¼æäº¤ï¼‰
- 3pcï¼ˆä¸‰æ®µå¼æäº¤ï¼‰
- TCCï¼ˆTryã€Confirmã€Cancelï¼‰
- æœ€å¤§åŠªåŠ›é€šçŸ¥
- æ¶ˆæ¯äº‹åŠ¡
- æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆebayç ”å‘å‡ºçš„ï¼‰
- åŠæ¶ˆæ¯/æœ€ç»ˆä¸€è‡´æ€§ï¼ˆRocketMQï¼‰

è¿™é‡Œæˆ‘å°±ä»‹ç»ä¸‹æœ€ç®€å•çš„**2pcï¼ˆä¸¤æ®µå¼ï¼‰**ï¼Œä»¥åŠå¤§å®¶ä»¥åå¯èƒ½æ¯”è¾ƒå¸¸ç”¨çš„**åŠæ¶ˆæ¯äº‹åŠ¡**ä¹Ÿå°±æ˜¯**æœ€ç»ˆä¸€è‡´æ€§**ï¼Œç›®çš„æ˜¯è®©å¤§å®¶ç†è§£ä¸‹åˆ†å¸ƒå¼äº‹åŠ¡é‡Œé¢**æ¶ˆæ¯ä¸­é—´ä»¶çš„ä½œç”¨**ï¼Œåˆ«çš„äº‹åŠ¡éƒ½å¤§åŒå°å¼‚ï¼Œéƒ½æœ‰å¾ˆå¤šä¼˜ç‚¹ã€‚

å½“ç„¶ä¹Ÿéƒ½æœ‰**ç§ç§å¼Šç«¯**ï¼š

ä¾‹å¦‚**é•¿æ—¶é—´é”å®šæ•°æ®åº“èµ„æº**ï¼Œå¯¼è‡´ç³»ç»Ÿçš„**å“åº”ä¸å¿«**ï¼Œ**å¹¶å‘ä¸Šä¸å»**ã€‚

ç½‘ç»œæŠ–åŠ¨å‡ºç°**è„‘è£‚**æƒ…å†µï¼Œå¯¼è‡´äº‹ç‰©å‚ä¸è€…ï¼Œä¸èƒ½å¾ˆå¥½åœ°æ‰§è¡Œåè°ƒè€…çš„æŒ‡ä»¤ï¼Œå¯¼è‡´**æ•°æ®ä¸ä¸€è‡´**ã€‚

**å•ç‚¹æ•…éšœ**ï¼šä¾‹å¦‚äº‹ç‰©åè°ƒè€…ï¼Œåœ¨æŸä¸€æ—¶åˆ»å®•æœºï¼Œè™½ç„¶å¯ä»¥é€šè¿‡é€‰ä¸¾æœºåˆ¶äº§ç”Ÿæ–°çš„Leaderï¼Œä½†æ˜¯è¿™è¿‡ç¨‹ä¸­ï¼Œå¿…ç„¶å‡ºç°é—®é¢˜ï¼Œè€ŒTCCï¼Œåªæœ‰å¼ºæ‚çš„æŠ€æœ¯å›¢é˜Ÿï¼Œæ‰èƒ½æ”¯æŒå¼€å‘ï¼Œ**æˆæœ¬å¤ªé«˜**ã€‚

ä¸å¤šBBäº†ï¼Œæˆ‘ä»¬å¼€å§‹ä»‹ç»è¿™ä¸ªä¸¤ä¸ªäº‹ç‰©å§ã€‚

#### 2pcï¼ˆä¸¤æ®µå¼æäº¤ï¼‰ 

![image-20220617144013552](./images/image-20220617144013552.png)

**2pcï¼ˆä¸¤æ®µå¼æäº¤ï¼‰**å¯ä»¥è¯´æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€å¼€å§‹çš„æ ·å­äº†ï¼Œåƒæäº†**åª’å©†**ï¼Œå°±æ˜¯é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶åè°ƒå¤šä¸ªç³»ç»Ÿï¼Œåœ¨ä¸¤ä¸ªç³»ç»Ÿæ“ä½œäº‹åŠ¡çš„æ—¶å€™éƒ½é”å®šèµ„æºä½†æ˜¯ä¸æäº¤äº‹åŠ¡ï¼Œç­‰ä¸¤è€…éƒ½å‡†å¤‡å¥½äº†ï¼Œå‘Šè¯‰æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç„¶åå†åˆ†åˆ«æäº¤äº‹åŠ¡ã€‚

**ä½†æ˜¯æˆ‘ä¸çŸ¥é“å¤§å®¶çœ‹åˆ°é—®é¢˜æ‰€åœ¨æ²¡æœ‰ï¼Ÿ**

æ˜¯çš„ä½ å¯èƒ½å·²ç»å‘ç°äº†ï¼Œå¦‚æœAç³»ç»Ÿäº‹åŠ¡æäº¤æˆåŠŸäº†ï¼Œä½†æ˜¯Bç³»ç»Ÿåœ¨æäº¤çš„æ—¶å€™ç½‘ç»œæ³¢åŠ¨æˆ–è€…å„ç§åŸå› æäº¤å¤±è´¥äº†ï¼Œå…¶å®è¿˜æ˜¯ä¼šå¤±è´¥çš„ã€‚



#### 3PC

3PC çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³ 2PC çš„ä¸€äº›é—®é¢˜ï¼Œç›¸æ¯”äº 2PC å®ƒåœ¨**å‚ä¸è€…ä¸­ä¹Ÿå¼•å…¥äº†è¶…æ—¶æœºåˆ¶**ï¼Œå¹¶ä¸”**æ–°å¢äº†ä¸€ä¸ªé˜¶æ®µ**ä½¿å¾—å‚ä¸è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ä¸ªé˜¶æ®µç»Ÿä¸€å„è‡ªçš„çŠ¶æ€ã€‚

è®©æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹ã€‚

3PC åŒ…å«äº†ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯**å‡†å¤‡é˜¶æ®µã€é¢„æäº¤é˜¶æ®µå’Œæäº¤é˜¶æ®µ**ï¼Œå¯¹åº”çš„è‹±æ–‡å°±æ˜¯ï¼š`CanCommitã€PreCommit å’Œ DoCommit`ã€‚

çœ‹èµ·æ¥æ˜¯**æŠŠ 2PC çš„æäº¤é˜¶æ®µå˜æˆäº†é¢„æäº¤é˜¶æ®µå’Œæäº¤é˜¶æ®µ**ï¼Œä½†æ˜¯ 3PC çš„å‡†å¤‡é˜¶æ®µåè°ƒè€…åªæ˜¯è¯¢é—®å‚ä¸è€…çš„è‡ªèº«çŠ¶å†µï¼Œæ¯”å¦‚ä½ ç°åœ¨è¿˜å¥½å—ï¼Ÿè´Ÿè½½é‡ä¸é‡ï¼Ÿè¿™ç±»çš„ã€‚

è€Œé¢„æäº¤é˜¶æ®µå°±æ˜¯å’Œ 2PC çš„å‡†å¤‡é˜¶æ®µä¸€æ ·ï¼Œé™¤äº†äº‹åŠ¡çš„æäº¤è¯¥åšçš„éƒ½åšäº†ã€‚

æäº¤é˜¶æ®µå’Œ 2PC çš„ä¸€æ ·ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å›¾ã€‚

![image-20220725145659669](images/image-20220725145659669.png)

ä¸ç®¡å“ªä¸€ä¸ªé˜¶æ®µæœ‰å‚ä¸è€…è¿”å›å¤±è´¥éƒ½ä¼šå®£å¸ƒäº‹åŠ¡å¤±è´¥ï¼Œè¿™å’Œ 2PC æ˜¯ä¸€æ ·çš„ï¼ˆå½“ç„¶åˆ°æœ€åçš„æäº¤é˜¶æ®µå’Œ 2PC ä¸€æ ·åªè¦æ˜¯æäº¤è¯·æ±‚å°±åªèƒ½ä¸æ–­é‡è¯•ï¼‰ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ 3PC çš„é˜¶æ®µå˜æ›´æœ‰ä»€ä¹ˆå½±å“ã€‚

é¦–å…ˆ**å‡†å¤‡é˜¶æ®µçš„å˜æ›´æˆä¸ä¼šç›´æ¥æ‰§è¡Œäº‹åŠ¡**ï¼Œè€Œæ˜¯ä¼šå…ˆå»è¯¢é—®æ­¤æ—¶çš„å‚ä¸è€…æ˜¯å¦æœ‰æ¡ä»¶æ¥è¿™ä¸ªäº‹åŠ¡ï¼Œå› æ­¤**ä¸ä¼šä¸€æ¥å°±å¹²æ´»ç›´æ¥é”èµ„æº**ï¼Œä½¿å¾—åœ¨æŸäº›èµ„æºä¸å¯ç”¨çš„æƒ…å†µä¸‹æ‰€æœ‰å‚ä¸è€…éƒ½é˜»å¡ç€ã€‚

è€Œ**é¢„æäº¤é˜¶æ®µçš„å¼•å…¥èµ·åˆ°äº†ä¸€ä¸ªç»Ÿä¸€çŠ¶æ€çš„ä½œç”¨**ï¼Œå®ƒåƒä¸€é“æ …æ ï¼Œè¡¨æ˜åœ¨é¢„æäº¤é˜¶æ®µå‰æ‰€æœ‰å‚ä¸è€…å…¶å®è¿˜æœªéƒ½å›åº”ï¼Œåœ¨é¢„å¤„ç†é˜¶æ®µè¡¨æ˜æ‰€æœ‰å‚ä¸è€…éƒ½å·²ç»å›åº”äº†ã€‚

å‡å¦‚ä½ æ˜¯ä¸€ä½å‚ä¸è€…ï¼Œä½ çŸ¥é“è‡ªå·±è¿›å…¥äº†é¢„æäº¤çŠ¶æ€é‚£ä½ å°±å¯ä»¥æ¨æ–­å‡ºæ¥å…¶ä»–å‚ä¸è€…ä¹Ÿéƒ½è¿›å…¥äº†é¢„æäº¤çŠ¶æ€ã€‚

ä½†æ˜¯å¤šå¼•å…¥ä¸€ä¸ªé˜¶æ®µä¹Ÿå¤šä¸€ä¸ªäº¤äº’ï¼Œå› æ­¤**æ€§èƒ½ä¼šå·®ä¸€äº›**ï¼Œè€Œä¸”**ç»å¤§éƒ¨åˆ†çš„æƒ…å†µä¸‹èµ„æºåº”è¯¥éƒ½æ˜¯å¯ç”¨çš„**ï¼Œè¿™æ ·ç­‰äºæ¯æ¬¡æ˜çŸ¥å¯ç”¨æ‰§è¡Œè¿˜å¾—è¯¢é—®ä¸€æ¬¡ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸‹å‚ä¸è€…è¶…æ—¶èƒ½å¸¦æ¥ä»€ä¹ˆæ ·çš„å½±å“ã€‚

æˆ‘ä»¬çŸ¥é“ 2PC æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œä¸Šé¢æˆ‘ä»¬å·²ç»åˆ†æäº†åè°ƒè€…æŒ‚åœ¨äº†æäº¤è¯·æ±‚è¿˜æœªå‘å‡ºå»çš„æ—¶å€™æ˜¯æœ€ä¼¤çš„ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½å·²ç»é”å®šèµ„æºå¹¶ä¸”é˜»å¡ç­‰å¾…ç€ã€‚

é‚£ä¹ˆå¼•å…¥äº†è¶…æ—¶æœºåˆ¶ï¼Œå‚ä¸è€…å°±ä¸ä¼šå‚»ç­‰äº†ï¼Œ**å¦‚æœæ˜¯ç­‰å¾…æäº¤å‘½ä»¤è¶…æ—¶ï¼Œé‚£ä¹ˆå‚ä¸è€…å°±ä¼šæäº¤äº‹åŠ¡äº†**ï¼Œå› ä¸ºéƒ½åˆ°äº†è¿™ä¸€é˜¶æ®µäº†å¤§æ¦‚ç‡æ˜¯æäº¤çš„ï¼Œ**å¦‚æœæ˜¯ç­‰å¾…é¢„æäº¤å‘½ä»¤è¶…æ—¶ï¼Œé‚£è¯¥å¹²å•¥å°±å¹²å•¥äº†ï¼Œåæ­£æœ¬æ¥å•¥ä¹Ÿæ²¡å¹²**ã€‚

ç„¶è€Œè¶…æ—¶æœºåˆ¶ä¹Ÿä¼šå¸¦æ¥æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ¯”å¦‚åœ¨ç­‰å¾…æäº¤å‘½ä»¤æ—¶å€™è¶…æ—¶äº†ï¼Œå‚ä¸è€…é»˜è®¤æ‰§è¡Œçš„æ˜¯æäº¤äº‹åŠ¡æ“ä½œï¼Œä½†æ˜¯**æœ‰å¯èƒ½æ‰§è¡Œçš„æ˜¯å›æ»šæ“ä½œï¼Œè¿™æ ·ä¸€æ¥æ•°æ®å°±ä¸ä¸€è‡´äº†**ã€‚

å½“ç„¶ 3PC åè°ƒè€…è¶…æ—¶è¿˜æ˜¯åœ¨çš„ï¼Œå…·ä½“ä¸åˆ†æäº†å’Œ 2PC æ˜¯ä¸€æ ·çš„ã€‚

ä»ç»´åŸºç™¾ç§‘ä¸Šçœ‹ï¼Œ3PC çš„å¼•å…¥æ˜¯ä¸ºäº†è§£å†³æäº¤é˜¶æ®µ 2PC åè°ƒè€…å’ŒæŸå‚ä¸è€…éƒ½æŒ‚äº†ä¹‹åæ–°é€‰ä¸¾çš„åè°ƒè€…ä¸çŸ¥é“å½“å‰åº”è¯¥æäº¤è¿˜æ˜¯å›æ»šçš„é—®é¢˜ã€‚

æ–°åè°ƒè€…æ¥çš„æ—¶å€™å‘ç°æœ‰ä¸€ä¸ªå‚ä¸è€…å¤„äºé¢„æäº¤æˆ–è€…æäº¤é˜¶æ®µï¼Œé‚£ä¹ˆè¡¨æ˜å·²ç»ç»è¿‡äº†æ‰€æœ‰å‚ä¸è€…çš„ç¡®è®¤äº†ï¼Œæ‰€ä»¥æ­¤æ—¶æ‰§è¡Œçš„å°±æ˜¯æäº¤å‘½ä»¤ã€‚

æ‰€ä»¥è¯´ 3PC å°±æ˜¯é€šè¿‡å¼•å…¥é¢„æäº¤é˜¶æ®µæ¥ä½¿å¾—å‚ä¸è€…ä¹‹é—´çš„çŠ¶æ€å¾—åˆ°ç»Ÿä¸€ï¼Œä¹Ÿå°±æ˜¯ç•™äº†ä¸€ä¸ªé˜¶æ®µè®©å¤§å®¶åŒæ­¥ä¸€ä¸‹ã€‚

ä½†æ˜¯è¿™ä¹Ÿåªèƒ½è®©åè°ƒè€…çŸ¥é“è¯¥å¦‚æœåšï¼Œä½†ä¸èƒ½ä¿è¯è¿™æ ·åšä¸€å®šå¯¹ï¼Œè¿™å…¶å®å’Œä¸Šé¢ 2PC åˆ†æä¸€è‡´ï¼Œå› ä¸ºæŒ‚äº†çš„å‚ä¸è€…åˆ°åº•æœ‰æ²¡æœ‰æ‰§è¡Œäº‹åŠ¡æ— æ³•æ–­å®šã€‚

æ‰€ä»¥è¯´ 3PC é€šè¿‡é¢„æäº¤é˜¶æ®µå¯ä»¥å‡å°‘æ•…éšœæ¢å¤æ—¶å€™çš„å¤æ‚æ€§ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®ä¸€è‡´ï¼Œé™¤éæŒ‚äº†çš„é‚£ä¸ªå‚ä¸è€…æ¢å¤ã€‚

è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œ 3PC ç›¸å¯¹äº 2PC åšäº†ä¸€å®šçš„æ”¹è¿›ï¼šå¼•å…¥äº†å‚ä¸è€…è¶…æ—¶æœºåˆ¶ï¼Œå¹¶ä¸”å¢åŠ äº†é¢„æäº¤é˜¶æ®µä½¿å¾—æ•…éšœæ¢å¤ä¹‹ååè°ƒè€…çš„å†³ç­–å¤æ‚åº¦é™ä½ï¼Œä½†æ•´ä½“çš„äº¤äº’è¿‡ç¨‹æ›´é•¿äº†ï¼Œæ€§èƒ½æœ‰æ‰€ä¸‹é™ï¼Œå¹¶ä¸”è¿˜æ˜¯ä¼šå­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚

æ‰€ä»¥ 2PC å’Œ 3PC éƒ½ä¸èƒ½ä¿è¯æ•°æ®100%ä¸€è‡´ï¼Œå› æ­¤ä¸€èˆ¬éƒ½éœ€è¦æœ‰å®šæ—¶æ‰«æè¡¥å¿æœºåˆ¶ã€‚

æˆ‘å†è¯´ä¸‹ 3PC æˆ‘æ²¡æœ‰æ‰¾åˆ°å…·ä½“çš„å®ç°ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸º 3PC åªæ˜¯çº¯çš„ç†è®ºä¸Šçš„ä¸œè¥¿ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°ç›¸æ¯”äº 2PC å®ƒæ˜¯åšäº†ä¸€äº›åŠªåŠ›ä½†æ˜¯æ•ˆæœç”šå¾®ï¼Œæ‰€ä»¥åªåšäº†è§£å³å¯ã€‚



#### TCC

**2PC å’Œ 3PC éƒ½æ˜¯æ•°æ®åº“å±‚é¢çš„ï¼Œè€Œ TCC æ˜¯ä¸šåŠ¡å±‚é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡**ï¼Œå°±åƒæˆ‘å‰é¢è¯´çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸ä»…ä»…åŒ…æ‹¬æ•°æ®åº“çš„æ“ä½œï¼Œè¿˜åŒ…æ‹¬å‘é€çŸ­ä¿¡ç­‰ï¼Œè¿™æ—¶å€™ TCC å°±æ´¾ä¸Šç”¨åœºäº†ï¼

TCC æŒ‡çš„æ˜¯`Try - Confirm - Cancel`ã€‚

- Try æŒ‡çš„æ˜¯é¢„ç•™ï¼Œå³èµ„æºçš„é¢„ç•™å’Œé”å®šï¼Œ**æ³¨æ„æ˜¯é¢„ç•™**ã€‚
- Confirm æŒ‡çš„æ˜¯ç¡®è®¤æ“ä½œï¼Œè¿™ä¸€æ­¥å…¶å®å°±æ˜¯çœŸæ­£çš„æ‰§è¡Œäº†ã€‚
- Cancel æŒ‡çš„æ˜¯æ’¤é”€æ“ä½œï¼Œå¯ä»¥ç†è§£ä¸ºæŠŠé¢„ç•™é˜¶æ®µçš„åŠ¨ä½œæ’¤é”€äº†ã€‚

å…¶å®ä»æ€æƒ³ä¸Šçœ‹å’Œ 2PC å·®ä¸å¤šï¼Œéƒ½æ˜¯å…ˆè¯•æ¢æ€§çš„æ‰§è¡Œï¼Œå¦‚æœéƒ½å¯ä»¥é‚£å°±çœŸæ­£çš„æ‰§è¡Œï¼Œå¦‚æœä¸è¡Œå°±å›æ»šã€‚

æ¯”å¦‚è¯´ä¸€ä¸ªäº‹åŠ¡è¦æ‰§è¡ŒAã€Bã€Cä¸‰ä¸ªæ“ä½œï¼Œé‚£ä¹ˆå…ˆå¯¹ä¸‰ä¸ªæ“ä½œæ‰§è¡Œé¢„ç•™åŠ¨ä½œã€‚å¦‚æœéƒ½é¢„ç•™æˆåŠŸäº†é‚£ä¹ˆå°±æ‰§è¡Œç¡®è®¤æ“ä½œï¼Œå¦‚æœæœ‰ä¸€ä¸ªé¢„ç•™å¤±è´¥é‚£å°±éƒ½æ‰§è¡Œæ’¤é”€åŠ¨ä½œã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹æµç¨‹ï¼ŒTCCæ¨¡å‹è¿˜æœ‰ä¸ªäº‹åŠ¡ç®¡ç†è€…çš„è§’è‰²ï¼Œç”¨æ¥è®°å½•TCCå…¨å±€äº‹åŠ¡çŠ¶æ€å¹¶æäº¤æˆ–è€…å›æ»šäº‹åŠ¡ã€‚

![image-20220725145418194](images/image-20220725145418194.png)

å¯ä»¥çœ‹åˆ°æµç¨‹è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œéš¾ç‚¹åœ¨äºä¸šåŠ¡ä¸Šçš„å®šä¹‰ï¼Œå¯¹äºæ¯ä¸€ä¸ªæ“ä½œä½ éƒ½éœ€è¦å®šä¹‰ä¸‰ä¸ªåŠ¨ä½œåˆ†åˆ«å¯¹åº”`Try - Confirm - Cancel`ã€‚

å› æ­¤ **TCC å¯¹ä¸šåŠ¡çš„ä¾µå…¥è¾ƒå¤§å’Œä¸šåŠ¡ç´§è€¦åˆ**ï¼Œéœ€è¦æ ¹æ®ç‰¹å®šçš„åœºæ™¯å’Œä¸šåŠ¡é€»è¾‘æ¥è®¾è®¡ç›¸åº”çš„æ“ä½œã€‚

è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œæ’¤é”€å’Œç¡®è®¤æ“ä½œçš„æ‰§è¡Œå¯èƒ½éœ€è¦é‡è¯•ï¼Œå› æ­¤è¿˜éœ€è¦ä¿è¯**æ“ä½œçš„å¹‚ç­‰**ã€‚

ç›¸å¯¹äº 2PCã€3PC ï¼ŒTCC é€‚ç”¨çš„èŒƒå›´æ›´å¤§ï¼Œä½†æ˜¯å¼€å‘é‡ä¹Ÿæ›´å¤§ï¼Œæ¯•ç«Ÿéƒ½åœ¨ä¸šåŠ¡ä¸Šå®ç°ï¼Œè€Œä¸”æœ‰æ—¶å€™ä½ ä¼šå‘ç°è¿™ä¸‰ä¸ªæ–¹æ³•è¿˜çœŸä¸å¥½å†™ã€‚ä¸è¿‡ä¹Ÿå› ä¸ºæ˜¯åœ¨ä¸šåŠ¡ä¸Šå®ç°çš„ï¼Œæ‰€ä»¥**TCCå¯ä»¥è·¨æ•°æ®åº“ã€è·¨ä¸åŒçš„ä¸šåŠ¡ç³»ç»Ÿæ¥å®ç°äº‹åŠ¡**ã€‚

#### æœ€å¤§åŠªåŠ›é€šçŸ¥

å…¶å®æˆ‘è§‰å¾—æœ¬åœ°æ¶ˆæ¯è¡¨ä¹Ÿå¯ä»¥ç®—æœ€å¤§åŠªåŠ›ï¼Œäº‹åŠ¡æ¶ˆæ¯ä¹Ÿå¯ä»¥ç®—æœ€å¤§åŠªåŠ›ã€‚

å°±æœ¬åœ°æ¶ˆæ¯è¡¨æ¥è¯´ä¼šæœ‰åå°ä»»åŠ¡å®šæ—¶å»æŸ¥çœ‹æœªå®Œæˆçš„æ¶ˆæ¯ï¼Œç„¶åå»è°ƒç”¨å¯¹åº”çš„æœåŠ¡ï¼Œå½“ä¸€ä¸ªæ¶ˆæ¯å¤šæ¬¡è°ƒç”¨éƒ½å¤±è´¥çš„æ—¶å€™å¯ä»¥è®°å½•ä¸‹ç„¶åå¼•å…¥äººå·¥ï¼Œæˆ–è€…ç›´æ¥èˆå¼ƒã€‚è¿™å…¶å®ç®—æ˜¯æœ€å¤§åŠªåŠ›äº†ã€‚

äº‹åŠ¡æ¶ˆæ¯ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå½“åŠæ¶ˆæ¯è¢«commitäº†ä¹‹åç¡®å®å°±æ˜¯æ™®é€šæ¶ˆæ¯äº†ï¼Œå¦‚æœè®¢é˜…è€…ä¸€ç›´ä¸æ¶ˆè´¹æˆ–è€…æ¶ˆè´¹ä¸äº†åˆ™ä¼šä¸€ç›´é‡è¯•ï¼Œåˆ°æœ€åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚å…¶å®è¿™ä¹Ÿç®—æœ€å¤§åŠªåŠ›ã€‚

æ‰€ä»¥**æœ€å¤§åŠªåŠ›é€šçŸ¥å…¶å®åªæ˜¯è¡¨æ˜äº†ä¸€ç§æŸ”æ€§äº‹åŠ¡çš„æ€æƒ³**ï¼šæˆ‘å·²ç»å°½åŠ›æˆ‘æœ€å¤§çš„åŠªåŠ›æƒ³è¾¾æˆäº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´äº†ã€‚

é€‚ç”¨äºå¯¹æ—¶é—´ä¸æ•æ„Ÿçš„ä¸šåŠ¡ï¼Œä¾‹å¦‚çŸ­ä¿¡é€šçŸ¥ã€‚



#### æ¶ˆæ¯äº‹åŠ¡

RocketMQ å°±å¾ˆå¥½çš„æ”¯æŒäº†æ¶ˆæ¯äº‹åŠ¡ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•é€šè¿‡æ¶ˆæ¯å®ç°äº‹åŠ¡ã€‚

ç¬¬ä¸€æ­¥å…ˆç»™ Broker å‘é€äº‹åŠ¡æ¶ˆæ¯å³åŠæ¶ˆæ¯ï¼Œ**åŠæ¶ˆæ¯ä¸æ˜¯è¯´ä¸€åŠæ¶ˆæ¯ï¼Œè€Œæ˜¯è¿™ä¸ªæ¶ˆæ¯å¯¹æ¶ˆè´¹è€…æ¥è¯´ä¸å¯è§**ï¼Œç„¶å**å‘é€æˆåŠŸåå‘é€æ–¹å†æ‰§è¡Œæœ¬åœ°äº‹åŠ¡**ã€‚

å†æ ¹æ®**æœ¬åœ°äº‹åŠ¡çš„ç»“æœå‘ Broker å‘é€ Commit æˆ–è€… RollBack å‘½ä»¤**ã€‚

å¹¶ä¸” RocketMQ çš„å‘é€æ–¹ä¼šæä¾›ä¸€ä¸ª**åæŸ¥äº‹åŠ¡çŠ¶æ€æ¥å£**ï¼Œå¦‚æœä¸€æ®µæ—¶é—´å†…åŠæ¶ˆæ¯æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ“ä½œè¯·æ±‚ï¼Œé‚£ä¹ˆ Broker ä¼šé€šè¿‡åæŸ¥æ¥å£å¾—çŸ¥å‘é€æ–¹äº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œç„¶åæ‰§è¡Œ Commit æˆ–è€… RollBack å‘½ä»¤ã€‚

å¦‚æœæ˜¯ Commit é‚£ä¹ˆè®¢é˜…æ–¹å°±èƒ½æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œç„¶åå†åšå¯¹åº”çš„æ“ä½œï¼Œåšå®Œäº†ä¹‹åå†æ¶ˆè´¹è¿™æ¡æ¶ˆæ¯å³å¯ã€‚

å¦‚æœæ˜¯ RollBack é‚£ä¹ˆè®¢é˜…æ–¹æ”¶ä¸åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œç­‰äºäº‹åŠ¡å°±æ²¡æ‰§è¡Œè¿‡ã€‚

å¯ä»¥çœ‹åˆ°é€šè¿‡ RocketMQ è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“å®ç°çš„ï¼ŒRocketMQ æä¾›äº†äº‹åŠ¡æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½äº‹åŠ¡åæŸ¥æ¥å£å³å¯ã€‚

![image-20220725145800448](images/image-20220725145800448.png)

å¯ä»¥çœ‹åˆ°æ¶ˆæ¯äº‹åŠ¡å®ç°çš„ä¹Ÿæ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚



#### æœ¬åœ°æ¶ˆæ¯è¡¨

æœ¬åœ°æ¶ˆæ¯è¡¨å…¶å®å°±æ˜¯åˆ©ç”¨äº† **å„ç³»ç»Ÿæœ¬åœ°çš„äº‹åŠ¡**æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

æœ¬åœ°æ¶ˆæ¯è¡¨é¡¾åæ€ä¹‰å°±æ˜¯ä¼šæœ‰ä¸€å¼ å­˜æ”¾æœ¬åœ°æ¶ˆæ¯çš„è¡¨ï¼Œä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨æ•°æ®åº“ä¸­ï¼Œç„¶ååœ¨æ‰§è¡Œä¸šåŠ¡çš„æ—¶å€™ **å°†ä¸šåŠ¡çš„æ‰§è¡Œå’Œå°†æ¶ˆæ¯æ”¾å…¥æ¶ˆæ¯è¡¨ä¸­çš„æ“ä½œæ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­**ï¼Œè¿™æ ·å°±èƒ½ä¿è¯æ¶ˆæ¯æ”¾å…¥æœ¬åœ°è¡¨ä¸­ä¸šåŠ¡è‚¯å®šæ˜¯æ‰§è¡ŒæˆåŠŸçš„ã€‚

ç„¶åå†å»è°ƒç”¨ä¸‹ä¸€ä¸ªæ“ä½œï¼Œå¦‚æœä¸‹ä¸€ä¸ªæ“ä½œè°ƒç”¨æˆåŠŸäº†å¥½è¯´ï¼Œæ¶ˆæ¯è¡¨çš„æ¶ˆæ¯çŠ¶æ€å¯ä»¥ç›´æ¥æ”¹æˆå·²æˆåŠŸã€‚

å¦‚æœè°ƒç”¨å¤±è´¥ä¹Ÿæ²¡äº‹ï¼Œä¼šæœ‰ **åå°ä»»åŠ¡å®šæ—¶å»è¯»å–æœ¬åœ°æ¶ˆæ¯è¡¨**ï¼Œç­›é€‰å‡ºè¿˜æœªæˆåŠŸçš„æ¶ˆæ¯å†è°ƒç”¨å¯¹åº”çš„æœåŠ¡ï¼ŒæœåŠ¡æ›´æ–°æˆåŠŸäº†å†å˜æ›´æ¶ˆæ¯çš„çŠ¶æ€ã€‚

è¿™æ—¶å€™æœ‰å¯èƒ½æ¶ˆæ¯å¯¹åº”çš„æ“ä½œä¸æˆåŠŸï¼Œå› æ­¤ä¹Ÿéœ€è¦é‡è¯•ï¼Œé‡è¯•å°±å¾—ä¿è¯å¯¹åº”æœåŠ¡çš„æ–¹æ³•æ˜¯å¹‚ç­‰çš„ï¼Œè€Œä¸”ä¸€èˆ¬é‡è¯•ä¼šæœ‰æœ€å¤§æ¬¡æ•°ï¼Œè¶…è¿‡æœ€å¤§æ¬¡æ•°å¯ä»¥è®°å½•ä¸‹æŠ¥è­¦è®©äººå·¥å¤„ç†ã€‚

å¯ä»¥çœ‹åˆ°æœ¬åœ°æ¶ˆæ¯è¡¨å…¶å®å®ç°çš„æ˜¯**æœ€ç»ˆä¸€è‡´æ€§**ï¼Œå®¹å¿äº†æ•°æ®æš‚æ—¶ä¸ä¸€è‡´çš„æƒ…å†µã€‚



#### æœ€ç»ˆä¸€è‡´æ€§

![image-20220617144020576](./images/image-20220617144020576.png)

æ•´ä¸ªæµç¨‹ä¸­ï¼Œæˆ‘ä»¬èƒ½ä¿è¯æ˜¯ï¼š

- ä¸šåŠ¡ä¸»åŠ¨æ–¹æœ¬åœ°äº‹åŠ¡æäº¤å¤±è´¥ï¼Œä¸šåŠ¡è¢«åŠ¨æ–¹ä¸ä¼šæ”¶åˆ°æ¶ˆæ¯çš„æŠ•é€’ã€‚
- åªè¦ä¸šåŠ¡ä¸»åŠ¨æ–¹æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆæ¶ˆæ¯æœåŠ¡ä¸€å®šä¼šæŠ•é€’æ¶ˆæ¯ç»™ä¸‹æ¸¸çš„ä¸šåŠ¡è¢«åŠ¨æ–¹ï¼Œå¹¶æœ€ç»ˆä¿è¯ä¸šåŠ¡è¢«åŠ¨æ–¹ä¸€å®šèƒ½æˆåŠŸæ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼ˆæ¶ˆè´¹æˆåŠŸæˆ–å¤±è´¥ï¼Œå³æœ€ç»ˆä¸€å®šä¼šæœ‰ä¸€ä¸ªæœ€ç»ˆæ€ï¼‰ã€‚

ä¸è¿‡å‘¢æŠ€æœ¯å°±æ˜¯è¿™æ ·ï¼Œ**å„ç§æç«¯çš„æƒ…å†µæˆ‘ä»¬éƒ½éœ€è¦è€ƒè™‘**ï¼Œä¹Ÿå¾ˆéš¾æœ‰å®Œç¾çš„æ–¹æ¡ˆï¼Œæ‰€ä»¥æ‰ä¼šæœ‰è¿™ä¹ˆå¤šçš„æ–¹æ¡ˆ**ä¸‰æ®µå¼**ã€**TCC**ã€**æœ€å¤§åŠªåŠ›é€šçŸ¥**ç­‰ç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆï¼Œå¤§å®¶åªéœ€è¦çŸ¥é“ä¸ºå•¥è¦åšï¼Œåšäº†æœ‰å•¥å¥½å¤„ï¼Œæœ‰å•¥åå¤„ï¼Œåœ¨å®é™…å¼€å‘çš„æ—¶å€™éƒ½æ³¨æ„ä¸‹å°±å¥½å¥½äº†ï¼Œ**ç³»ç»Ÿéƒ½æ˜¯æ ¹æ®ä¸šåŠ¡åœºæ™¯è®¾è®¡å‡ºæ¥çš„ï¼Œç¦»å¼€ä¸šåŠ¡çš„æŠ€æœ¯æ²¡æœ‰æ„ä¹‰ï¼Œç¦»å¼€æŠ€æœ¯çš„ä¸šåŠ¡æ²¡æœ‰åº•æ°”**ã€‚

è¿˜æ˜¯é‚£å¥è¯ï¼š**æ²¡æœ‰æœ€å®Œç¾çš„ç³»ç»Ÿï¼Œåªæœ‰æœ€é€‚åˆçš„ç³»ç»Ÿã€‚**



### å¸¸è§ä¿è¯å¹‚ç­‰çš„æ–¹å¼

#### ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§

å¹‚ç­‰æ˜¯ä¸€ä¸ªæ•°å­¦ä¸è®¡ç®—æœºå­¦æ¦‚å¿µï¼Œåœ¨æ•°å­¦ä¸­æŸä¸€å…ƒè¿ç®—ä¸ºå¹‚ç­‰æ—¶ï¼Œå…¶ä½œç”¨åœ¨ä»»ä¸€å…ƒç´ ä¸¤æ¬¡åä¼šå’Œå…¶ä½œç”¨ä¸€æ¬¡çš„ç»“æœç›¸åŒã€‚

åœ¨è®¡ç®—æœºä¸­ç¼–ç¨‹ä¸­ï¼Œä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚å¹‚ç­‰å‡½æ•°æˆ–å¹‚ç­‰æ–¹æ³•æ˜¯æŒ‡å¯ä»¥ä½¿ç”¨ç›¸åŒå‚æ•°é‡å¤æ‰§è¡Œï¼Œå¹¶èƒ½è·å¾—ç›¸åŒç»“æœçš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°ä¸ä¼šå½±å“ç³»ç»ŸçŠ¶æ€ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¤æ‰§è¡Œä¼šå¯¹ç³»ç»Ÿé€ æˆæ”¹å˜ã€‚

#### ä»€ä¹ˆæ˜¯æ¥å£å¹‚ç­‰æ€§

åœ¨HTTP/1.1ä¸­ï¼Œå¯¹å¹‚ç­‰æ€§è¿›è¡Œäº†å®šä¹‰ã€‚å®ƒæè¿°äº†ä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºå¯¹äºèµ„æºæœ¬èº«åº”è¯¥å…·æœ‰åŒæ ·çš„ç»“æœï¼ˆç½‘ç»œè¶…æ—¶ç­‰é—®é¢˜é™¤å¤–ï¼‰ï¼Œå³ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™å¯¹èµ„æºäº§ç”Ÿäº†å‰¯ä½œç”¨ï¼Œä½†æ˜¯ä»¥åçš„å¤šæ¬¡è¯·æ±‚éƒ½ä¸ä¼šå†å¯¹èµ„æºäº§ç”Ÿå‰¯ä½œç”¨ã€‚

è¿™é‡Œçš„å‰¯ä½œç”¨æ˜¯ä¸ä¼šå¯¹ç»“æœäº§ç”Ÿç ´åæˆ–è€…äº§ç”Ÿä¸å¯é¢„æ–™çš„ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œå¯¹èµ„æºæœ¬èº«æ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦å®ç°å¹‚ç­‰æ€§

åœ¨æ¥å£è°ƒç”¨æ—¶ä¸€èˆ¬æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸è¿”å›ä¿¡æ¯ä¸ä¼šé‡å¤æäº¤ï¼Œä¸è¿‡åœ¨é‡è§ä»¥ä¸‹æƒ…å†µæ—¶å¯ä»¥å°±ä¼šå‡ºç°é—®é¢˜ï¼Œå¦‚ï¼š

- **å‰ç«¯é‡å¤æäº¤è¡¨å•ï¼š** åœ¨å¡«å†™ä¸€äº›è¡¨æ ¼æ—¶å€™ï¼Œç”¨æˆ·å¡«å†™å®Œæˆæäº¤ï¼Œå¾ˆå¤šæ—¶å€™ä¼šå› ç½‘ç»œæ³¢åŠ¨æ²¡æœ‰åŠæ—¶å¯¹ç”¨æˆ·åšå‡ºæäº¤æˆåŠŸå“åº”ï¼Œè‡´ä½¿ç”¨æˆ·è®¤ä¸ºæ²¡æœ‰æˆåŠŸæäº¤ï¼Œç„¶åä¸€ç›´ç‚¹æäº¤æŒ‰é’®ï¼Œè¿™æ—¶å°±ä¼šå‘ç”Ÿé‡å¤æäº¤è¡¨å•è¯·æ±‚ã€‚
- **ç”¨æˆ·æ¶æ„è¿›è¡Œåˆ·å•ï¼š** ä¾‹å¦‚åœ¨å®ç°ç”¨æˆ·æŠ•ç¥¨è¿™ç§åŠŸèƒ½æ—¶ï¼Œå¦‚æœç”¨æˆ·é’ˆå¯¹ä¸€ä¸ªç”¨æˆ·è¿›è¡Œé‡å¤æäº¤æŠ•ç¥¨ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ¥å£æ¥æ”¶åˆ°ç”¨æˆ·é‡å¤æäº¤çš„æŠ•ç¥¨ä¿¡æ¯ï¼Œè¿™æ ·ä¼šä½¿æŠ•ç¥¨ç»“æœä¸äº‹å®ä¸¥é‡ä¸ç¬¦ã€‚
- **æ¥å£è¶…æ—¶é‡å¤æäº¤ï¼š** å¾ˆå¤šæ—¶å€™ HTTP å®¢æˆ·ç«¯å·¥å…·éƒ½é»˜è®¤å¼€å¯è¶…æ—¶é‡è¯•çš„æœºåˆ¶ï¼Œå°¤å…¶æ˜¯ç¬¬ä¸‰æ–¹è°ƒç”¨æ¥å£æ—¶å€™ï¼Œä¸ºäº†é˜²æ­¢ç½‘ç»œæ³¢åŠ¨è¶…æ—¶ç­‰é€ æˆçš„è¯·æ±‚å¤±è´¥ï¼Œéƒ½ä¼šæ·»åŠ é‡è¯•æœºåˆ¶ï¼Œå¯¼è‡´ä¸€ä¸ªè¯·æ±‚æäº¤å¤šæ¬¡ã€‚
- **æ¶ˆæ¯è¿›è¡Œé‡å¤æ¶ˆè´¹ï¼š** å½“ä½¿ç”¨ MQ æ¶ˆæ¯ä¸­é—´ä»¶æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿæ¶ˆæ¯ä¸­é—´ä»¶å‡ºç°é”™è¯¯æœªåŠæ—¶æäº¤æ¶ˆè´¹ä¿¡æ¯ï¼Œå¯¼è‡´å‘ç”Ÿé‡å¤æ¶ˆè´¹ã€‚

ä½¿ç”¨å¹‚ç­‰æ€§æœ€å¤§çš„ä¼˜åŠ¿åœ¨äºä½¿æ¥å£ä¿è¯ä»»ä½•å¹‚ç­‰æ€§æ“ä½œï¼Œå…å»å› é‡è¯•ç­‰é€ æˆç³»ç»Ÿäº§ç”Ÿçš„æœªçŸ¥çš„é—®é¢˜ã€‚

#### å¼•å…¥å¹‚ç­‰æ€§åå¯¹ç³»ç»Ÿçš„å½±å“

å¹‚ç­‰æ€§æ˜¯ä¸ºäº†ç®€åŒ–å®¢æˆ·ç«¯é€»è¾‘å¤„ç†ï¼Œèƒ½æ”¾ç½®é‡å¤æäº¤ç­‰æ“ä½œï¼Œä½†å´å¢åŠ äº†æœåŠ¡ç«¯çš„é€»è¾‘å¤æ‚æ€§å’Œæˆæœ¬ï¼Œå…¶ä¸»è¦æ˜¯ï¼š

- æŠŠå¹¶è¡Œæ‰§è¡Œçš„åŠŸèƒ½æ”¹ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œé™ä½äº†æ‰§è¡Œæ•ˆç‡ã€‚
- å¢åŠ äº†é¢å¤–æ§åˆ¶å¹‚ç­‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¤æ‚åŒ–äº†ä¸šåŠ¡åŠŸèƒ½ï¼›

æ‰€ä»¥åœ¨ä½¿ç”¨æ—¶å€™éœ€è¦è€ƒè™‘æ˜¯å¦å¼•å…¥å¹‚ç­‰æ€§çš„å¿…è¦æ€§ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯å…·ä½“åˆ†æï¼Œé™¤äº†ä¸šåŠ¡ä¸Šçš„ç‰¹æ®Šè¦æ±‚å¤–ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦å¼•å…¥çš„æ¥å£å¹‚ç­‰æ€§ã€‚

#### Restful API æ¥å£çš„å¹‚ç­‰æ€§

ç°åœ¨æµè¡Œçš„ Restful æ¨èçš„å‡ ç§ HTTP æ¥å£æ–¹æ³•ä¸­ï¼Œåˆ†åˆ«å­˜åœ¨å¹‚ç­‰è¡Œä¸ä¸èƒ½ä¿è¯å¹‚ç­‰çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

- âˆš æ»¡è¶³å¹‚ç­‰

- x ä¸æ»¡è¶³å¹‚ç­‰

- \- å¯èƒ½æ»¡è¶³ä¹Ÿå¯èƒ½ä¸æ»¡è¶³å¹‚ç­‰ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡é€»è¾‘æœ‰å…³

  

| æ–¹æ³•ç±»å‹ | æ˜¯å¦å¹‚ç­‰ |                             æè¿°                             |
| :------: | :------: | :----------------------------------------------------------: |
|   Get    |    âˆš     | Get æ–¹æ³•ç”¨äºè·å–èµ„æºã€‚å…¶ä¸€èˆ¬ä¸ä¼šä¹Ÿä¸åº”å½“å¯¹ç³»ç»Ÿèµ„æºè¿›è¡Œæ”¹å˜ï¼Œæ‰€ä»¥æ˜¯å¹‚ç­‰çš„ã€‚ |
|   Post   |    Ã—     | Post æ–¹æ³•ä¸€èˆ¬ç”¨äºåˆ›å»ºæ–°çš„èµ„æºã€‚å…¶æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šæ–°å¢æ•°æ®ï¼Œæ‰€ä»¥ä¸æ˜¯å¹‚ç­‰çš„ã€‚ |
|   Put    |    -     | Put æ–¹æ³•ä¸€èˆ¬ç”¨äºä¿®æ”¹èµ„æºã€‚è¯¥æ“ä½œåˆ™åˆ†æƒ…å†µæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯æ»¡è¶³å¹‚ç­‰ï¼Œæ›´æ–°æ“ä½œä¸­ç›´æ¥æ ¹æ®æŸä¸ªå€¼è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿèƒ½ä¿æŒå¹‚ç­‰ã€‚ä¸è¿‡æ‰§è¡Œç´¯åŠ æ“ä½œçš„æ›´æ–°æ˜¯éå¹‚ç­‰ã€‚ |
|  Delete  |    -     | Delete  æ–¹æ³•ä¸€èˆ¬ç”¨äºåˆ é™¤èµ„æºã€‚è¯¥æ“ä½œåˆ™åˆ†æƒ…å†µæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯æ»¡è¶³å¹‚ç­‰ï¼Œå½“æ ¹æ®å”¯ä¸€å€¼è¿›è¡Œåˆ é™¤æ—¶ï¼Œåˆ é™¤åŒä¸€ä¸ªæ•°æ®å¤šæ¬¡æ‰§è¡Œæ•ˆæœä¸€æ ·ã€‚ä¸è¿‡éœ€è¦æ³¨æ„ï¼Œå¸¦æŸ¥è¯¢æ¡ä»¶çš„åˆ é™¤åˆ™å°±ä¸ä¸€å®šæ»¡è¶³å¹‚ç­‰äº†ã€‚ä¾‹å¦‚åœ¨æ ¹æ®æ¡ä»¶åˆ é™¤ä¸€æ‰¹æ•°æ®åï¼Œè¿™æ—¶å€™æ–°å¢åŠ äº†ä¸€æ¡æ•°æ®ä¹Ÿæ»¡è¶³æ¡ä»¶ï¼Œç„¶ååˆæ‰§è¡Œäº†ä¸€æ¬¡åˆ é™¤ï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´æ–°å¢åŠ çš„è¿™æ¡æ»¡è¶³æ¡ä»¶æ•°æ®ä¹Ÿè¢«åˆ é™¤ã€‚ |

#### å¦‚ä½•å®ç°å¹‚ç­‰æ€§

##### æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“å”¯ä¸€ä¸»é”®

**æ–¹æ¡ˆæè¿°**

æ•°æ®åº“å”¯ä¸€ä¸»é”®çš„å®ç°ä¸»è¦æ˜¯åˆ©ç”¨æ•°æ®åº“ä¸­ä¸»é”®å”¯ä¸€çº¦æŸçš„ç‰¹æ€§ï¼Œä¸€èˆ¬æ¥è¯´å”¯ä¸€ä¸»é”®æ¯”è¾ƒé€‚ç”¨äºâ€œæ’å…¥â€æ—¶çš„å¹‚ç­‰æ€§ï¼Œå…¶èƒ½ä¿è¯ä¸€å¼ è¡¨ä¸­åªèƒ½å­˜åœ¨ä¸€æ¡å¸¦è¯¥å”¯ä¸€ä¸»é”®çš„è®°å½•ã€‚

ä½¿ç”¨æ•°æ®åº“å”¯ä¸€ä¸»é”®å®Œæˆå¹‚ç­‰æ€§æ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥ä¸»é”®ä¸€èˆ¬æ¥è¯´å¹¶ä¸æ˜¯ä½¿ç”¨æ•°æ®åº“ä¸­è‡ªå¢ä¸»é”®ï¼Œè€Œæ˜¯ä½¿ç”¨åˆ†å¸ƒå¼ ID å……å½“ä¸»é”®ï¼ˆå¯ä»¥å‚è€ƒ Java ä¸­åˆ†å¸ƒå¼ ID çš„è®¾è®¡æ–¹æ¡ˆ è¿™ç¯‡æ–‡ç« ï¼‰ï¼Œè¿™æ ·æ‰èƒ½èƒ½ä¿è¯åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ ID çš„å…¨å±€å”¯ä¸€æ€§ã€‚

**é€‚ç”¨æ“ä½œï¼š**

- æ’å…¥æ“ä½œ
- åˆ é™¤æ“ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**

- éœ€è¦ç”Ÿæˆå…¨å±€å”¯ä¸€ä¸»é”® IDï¼›

**ä¸»è¦æµç¨‹ï¼š**

![image-20220725150136872](images/image-20220725150136872.png)

ä¸»è¦æµç¨‹ï¼š

- â‘  å®¢æˆ·ç«¯æ‰§è¡Œåˆ›å»ºè¯·æ±‚ï¼Œè°ƒç”¨æœåŠ¡ç«¯æ¥å£ã€‚
- â‘¡ æœåŠ¡ç«¯æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç”Ÿæˆä¸€ä¸ªåˆ†å¸ƒå¼ IDï¼Œå°†è¯¥ ID å……å½“å¾…æ’å…¥æ•°æ®çš„ä¸»é”®ï¼Œç„¶åæ‰§æ•°æ®æ’å…¥æ“ä½œï¼Œè¿è¡Œå¯¹åº”çš„ SQL è¯­å¥ã€‚
- â‘¢ æœåŠ¡ç«¯å°†è¯¥æ¡æ•°æ®æ’å…¥æ•°æ®åº“ä¸­ï¼Œå¦‚æœæ’å…¥æˆåŠŸåˆ™è¡¨ç¤ºæ²¡æœ‰é‡å¤è°ƒç”¨æ¥å£ã€‚å¦‚æœæŠ›å‡ºä¸»é”®é‡å¤å¼‚å¸¸ï¼Œåˆ™è¡¨ç¤ºæ•°æ®åº“ä¸­å·²ç»å­˜åœ¨è¯¥æ¡è®°å½•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯åˆ°å®¢æˆ·ç«¯ã€‚

##### æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“ä¹è§‚é”

**æ–¹æ¡ˆæè¿°ï¼š**

æ•°æ®åº“ä¹è§‚é”æ–¹æ¡ˆä¸€èˆ¬åªèƒ½é€‚ç”¨äºæ‰§è¡Œâ€œæ›´æ–°æ“ä½œâ€çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æå‰åœ¨å¯¹åº”çš„æ•°æ®è¡¨ä¸­å¤šæ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œå……å½“å½“å‰æ•°æ®çš„ç‰ˆæœ¬æ ‡è¯†ã€‚è¿™æ ·æ¯æ¬¡å¯¹è¯¥æ•°æ®åº“è¯¥è¡¨çš„è¿™æ¡æ•°æ®æ‰§è¡Œæ›´æ–°æ—¶ï¼Œéƒ½ä¼šå°†è¯¥ç‰ˆæœ¬æ ‡è¯†ä½œä¸ºä¸€ä¸ªæ¡ä»¶ï¼Œå€¼ä¸ºä¸Šæ¬¡å¾…æ›´æ–°æ•°æ®ä¸­çš„ç‰ˆæœ¬æ ‡è¯†çš„å€¼ã€‚

**é€‚ç”¨æ“ä½œï¼š**

- æ›´æ–°æ“ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**

- éœ€è¦æ•°æ®åº“å¯¹åº”ä¸šåŠ¡è¡¨ä¸­æ·»åŠ é¢å¤–å­—æ®µï¼›

**æè¿°ç¤ºä¾‹ï¼š**

![image-20220725150153331](images/image-20220725150153331.png)

ä¾‹å¦‚ï¼Œå­˜åœ¨å¦‚ä¸‹çš„æ•°æ®è¡¨ä¸­ï¼š

| id   | name     | price |
| :--- | :------- | :---- |
| 1    | å°ç±³æ‰‹æœº | 1000  |
| 2    | è‹¹æœæ‰‹æœº | 2500  |
| 3    | åä¸ºæ‰‹æœº | 1600  |

ä¸ºäº†æ¯æ¬¡æ‰§è¡Œæ›´æ–°æ—¶é˜²æ­¢é‡å¤æ›´æ–°ï¼Œç¡®å®šæ›´æ–°çš„ä¸€å®šæ˜¯è¦æ›´æ–°çš„å†…å®¹ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½ä¼šæ·»åŠ ä¸€ä¸ª version å­—æ®µè®°å½•å½“å‰çš„è®°å½•ç‰ˆæœ¬ï¼Œè¿™æ ·åœ¨æ›´æ–°æ—¶å€™å°†è¯¥å€¼å¸¦ä¸Šï¼Œé‚£ä¹ˆåªè¦æ‰§è¡Œæ›´æ–°æ“ä½œå°±èƒ½ç¡®å®šä¸€å®šæ›´æ–°çš„æ˜¯æŸä¸ªå¯¹åº”ç‰ˆæœ¬ä¸‹çš„ä¿¡æ¯ã€‚

| id   | name     | price | version |
| :--- | :------- | :---- | :------ |
| 1    | å°ç±³æ‰‹æœº | 1000  | 10      |
| 2    | è‹¹æœæ‰‹æœº | 2500  | 21      |
| 3    | åä¸ºæ‰‹æœº | 1600  | 5       |

è¿™æ ·æ¯æ¬¡æ‰§è¡Œæ›´æ–°æ—¶å€™ï¼Œéƒ½è¦æŒ‡å®šè¦æ›´æ–°çš„ç‰ˆæœ¬å·ï¼Œå¦‚ä¸‹æ“ä½œå°±èƒ½å‡†ç¡®æ›´æ–° version=5 çš„ä¿¡æ¯ï¼š

```
UPDATE my_table SET price=price+50,version=version+1 WHERE id=1 AND version=5
```

ä¸Šé¢ WHERE åé¢è·Ÿç€æ¡ä»¶ id=1 AND version=5 è¢«æ‰§è¡Œåï¼Œid=1 çš„ version è¢«æ›´æ–°ä¸º 6ï¼Œæ‰€ä»¥å¦‚æœé‡å¤æ‰§è¡Œè¯¥æ¡  SQL è¯­å¥å°†ä¸ç”Ÿæ•ˆï¼Œå› ä¸º id=1 AND version=5 çš„æ•°æ®å·²ç»ä¸å­˜åœ¨ï¼Œè¿™æ ·å°±èƒ½ä¿ä½æ›´æ–°çš„å¹‚ç­‰ï¼Œå¤šæ¬¡æ›´æ–°å¯¹ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚

##### æ–¹æ¡ˆä¸‰ï¼šé˜²é‡ Token ä»¤ç‰Œ

**æ–¹æ¡ˆæè¿°ï¼š**

é’ˆå¯¹å®¢æˆ·ç«¯è¿ç»­ç‚¹å‡»æˆ–è€…è°ƒç”¨æ–¹çš„è¶…æ—¶é‡è¯•ç­‰æƒ…å†µï¼Œä¾‹å¦‚æäº¤è®¢å•ï¼Œæ­¤ç§æ“ä½œå°±å¯ä»¥ç”¨  Token çš„æœºåˆ¶å®ç°é˜²æ­¢é‡å¤æäº¤ã€‚ç®€å•çš„è¯´å°±æ˜¯è°ƒç”¨æ–¹åœ¨è°ƒç”¨æ¥å£çš„æ—¶å€™å…ˆå‘åç«¯è¯·æ±‚ä¸€ä¸ªå…¨å±€ IDï¼ˆTokenï¼‰ï¼Œè¯·æ±‚çš„æ—¶å€™æºå¸¦è¿™ä¸ªå…¨å±€ ID  ä¸€èµ·è¯·æ±‚ï¼ˆToken æœ€å¥½å°†å…¶æ”¾åˆ° Headers ä¸­ï¼‰ï¼Œåç«¯éœ€è¦å¯¹è¿™ä¸ª Token ä½œä¸º Keyï¼Œç”¨æˆ·ä¿¡æ¯ä½œä¸º Value åˆ° Redis  ä¸­è¿›è¡Œé”®å€¼å†…å®¹æ ¡éªŒï¼Œå¦‚æœ Key å­˜åœ¨ä¸” Value åŒ¹é…å°±æ‰§è¡Œåˆ é™¤å‘½ä»¤ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œåé¢çš„ä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœä¸å­˜åœ¨å¯¹åº”çš„ Key æˆ– Value  ä¸åŒ¹é…å°±è¿”å›é‡å¤æ‰§è¡Œçš„é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ ·æ¥ä¿è¯å¹‚ç­‰æ“ä½œã€‚

**é€‚ç”¨æ“ä½œï¼š**

- æ’å…¥æ“ä½œ
- æ›´æ–°æ“ä½œ
- åˆ é™¤æ“ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**

- éœ€è¦ç”Ÿæˆå…¨å±€å”¯ä¸€ Token ä¸²ï¼›
- éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶ Redis è¿›è¡Œæ•°æ®æ•ˆéªŒï¼›

**ä¸»è¦æµç¨‹ï¼š**

![image-20220725150246041](images/image-20220725150246041.png)

- â‘  æœåŠ¡ç«¯æä¾›è·å– Token çš„æ¥å£ï¼Œè¯¥ Token å¯ä»¥æ˜¯ä¸€ä¸ªåºåˆ—å·ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ ID æˆ–è€… UUID ä¸²ã€‚
- â‘¡ å®¢æˆ·ç«¯è°ƒç”¨æ¥å£è·å– Tokenï¼Œè¿™æ—¶å€™æœåŠ¡ç«¯ä¼šç”Ÿæˆä¸€ä¸ª Token ä¸²ã€‚
- â‘¢ ç„¶åå°†è¯¥ä¸²å­˜å…¥ Redis æ•°æ®åº“ä¸­ï¼Œä»¥è¯¥ Token ä½œä¸º Redis çš„é”®ï¼ˆæ³¨æ„è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ã€‚
- â‘£ å°† Token è¿”å›åˆ°å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°ååº”å­˜åˆ°è¡¨å•éšè—åŸŸä¸­ã€‚
- â‘¤ å®¢æˆ·ç«¯åœ¨æ‰§è¡Œæäº¤è¡¨å•æ—¶ï¼ŒæŠŠ Token å­˜å…¥åˆ° Headers ä¸­ï¼Œæ‰§è¡Œä¸šåŠ¡è¯·æ±‚å¸¦ä¸Šè¯¥ Headersã€‚
- â‘¥ æœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åä» Headers ä¸­æ‹¿åˆ° Tokenï¼Œç„¶åæ ¹æ® Token åˆ° Redis ä¸­æŸ¥æ‰¾è¯¥ key æ˜¯å¦å­˜åœ¨ã€‚
- â‘¦ æœåŠ¡ç«¯æ ¹æ® Redis ä¸­æ˜¯å¦å­˜è¯¥ key è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨å°±å°†è¯¥ key åˆ é™¤ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœä¸å­˜åœ¨å°±æŠ›å¼‚å¸¸ï¼Œè¿”å›é‡å¤æäº¤çš„é”™è¯¯ä¿¡æ¯ã€‚

> æ³¨æ„ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ Redis æŸ¥æ‰¾æ•°æ®ä¸åˆ é™¤éœ€è¦ä¿è¯åŸå­æ€§ï¼Œå¦åˆ™å¾ˆå¯èƒ½åœ¨å¹¶å‘ä¸‹æ— æ³•ä¿è¯å¹‚ç­‰æ€§ã€‚å…¶å®ç°æ–¹æ³•å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼é”æˆ–è€…ä½¿ç”¨ Lua è¡¨è¾¾å¼æ¥æ³¨é”€æŸ¥è¯¢ä¸åˆ é™¤æ“ä½œã€‚

#### æ–¹æ¡ˆå››:ä¸‹æ¸¸ä¼ é€’å”¯ä¸€åºåˆ—å·

**æ–¹æ¡ˆæè¿°ï¼š**

æ‰€è°“è¯·æ±‚åºåˆ—å·ï¼Œå…¶å®å°±æ˜¯æ¯æ¬¡å‘æœåŠ¡ç«¯è¯·æ±‚æ—¶å€™é™„å¸¦ä¸€ä¸ªçŸ­æ—¶é—´å†…å”¯ä¸€ä¸é‡å¤çš„åºåˆ—å·ï¼Œè¯¥åºåˆ—å·å¯ä»¥æ˜¯ä¸€ä¸ªæœ‰åº IDï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè®¢å•å·ï¼Œä¸€èˆ¬ç”±ä¸‹æ¸¸ç”Ÿæˆï¼Œåœ¨è°ƒç”¨ä¸Šæ¸¸æœåŠ¡ç«¯æ¥å£æ—¶é™„åŠ è¯¥åºåˆ—å·å’Œç”¨äºè®¤è¯çš„ IDã€‚

å½“ä¸Šæ¸¸æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ä¿¡æ¯åæ‹¿å–è¯¥ åºåˆ—å· å’Œä¸‹æ¸¸ è®¤è¯ID è¿›è¡Œç»„åˆï¼Œå½¢æˆç”¨äºæ“ä½œ Redis çš„ Keyï¼Œç„¶ååˆ° Redis ä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ Key çš„é”®å€¼å¯¹ï¼Œæ ¹æ®å…¶ç»“æœï¼š

- å¦‚æœå­˜åœ¨ï¼Œå°±è¯´æ˜å·²ç»å¯¹è¯¥ä¸‹æ¸¸çš„è¯¥åºåˆ—å·çš„è¯·æ±‚è¿›è¡Œäº†ä¸šåŠ¡å¤„ç†ï¼Œè¿™æ—¶å¯ä»¥ç›´æ¥å“åº”é‡å¤è¯·æ±‚çš„é”™è¯¯ä¿¡æ¯ã€‚
- å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä»¥è¯¥ Key ä½œä¸º Redis çš„é”®ï¼Œä»¥ä¸‹æ¸¸å…³é”®ä¿¡æ¯ä½œä¸ºå­˜å‚¨çš„å€¼ï¼ˆä¾‹å¦‚ä¸‹æ¸¸å•†ä¼ é€’çš„ä¸€äº›ä¸šåŠ¡é€»è¾‘ä¿¡æ¯ï¼‰ï¼Œå°†è¯¥é”®å€¼å¯¹å­˜å‚¨åˆ° Redis ä¸­ ï¼Œç„¶åå†æ­£å¸¸æ‰§è¡Œå¯¹åº”çš„ä¸šåŠ¡é€»è¾‘å³å¯ã€‚

**é€‚ç”¨æ“ä½œï¼š**

- æ’å…¥æ“ä½œ
- æ›´æ–°æ“ä½œ
- åˆ é™¤æ“ä½œ

**ä½¿ç”¨é™åˆ¶ï¼š**

- è¦æ±‚ç¬¬ä¸‰æ–¹ä¼ é€’å”¯ä¸€åºåˆ—å·ï¼›
- éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶ Redis è¿›è¡Œæ•°æ®æ•ˆéªŒï¼›

**ä¸»è¦æµç¨‹ï¼š**

![image-20220725150306807](images/image-20220725150306807.png)

ä¸»è¦æ­¥éª¤ï¼š

- â‘  ä¸‹æ¸¸æœåŠ¡ç”Ÿæˆåˆ†å¸ƒå¼ ID ä½œä¸ºåºåˆ—å·ï¼Œç„¶åæ‰§è¡Œè¯·æ±‚è°ƒç”¨ä¸Šæ¸¸æ¥å£ï¼Œå¹¶é™„å¸¦â€œå”¯ä¸€åºåˆ—å·â€ä¸è¯·æ±‚çš„â€œè®¤è¯å‡­æ®IDâ€ã€‚
- â‘¡ ä¸Šæ¸¸æœåŠ¡è¿›è¡Œå®‰å…¨æ•ˆéªŒï¼Œæ£€æµ‹ä¸‹æ¸¸ä¼ é€’çš„å‚æ•°ä¸­æ˜¯å¦å­˜åœ¨â€œåºåˆ—å·â€å’Œâ€œå‡­æ®IDâ€ã€‚
- â‘¢ ä¸Šæ¸¸æœåŠ¡åˆ° Redis ä¸­æ£€æµ‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„â€œåºåˆ—å·â€ä¸â€œè®¤è¯IDâ€ç»„æˆçš„  Keyï¼Œå¦‚æœå­˜åœ¨å°±æŠ›å‡ºé‡å¤æ‰§è¡Œçš„å¼‚å¸¸ä¿¡æ¯ï¼Œç„¶åå“åº”ä¸‹æ¸¸å¯¹åº”çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœä¸å­˜åœ¨å°±ä»¥è¯¥â€œåºåˆ—å·â€å’Œâ€œè®¤è¯IDâ€ç»„åˆä½œä¸º  Keyï¼Œä»¥ä¸‹æ¸¸å…³é”®ä¿¡æ¯ä½œä¸º Valueï¼Œè¿›è€Œå­˜å‚¨åˆ° Redis ä¸­ï¼Œç„¶åæ­£å¸¸æ‰§è¡Œæ¥æ¥æ¥çš„ä¸šåŠ¡é€»è¾‘ã€‚

> ä¸Šé¢æ­¥éª¤ä¸­æ’å…¥æ•°æ®åˆ° Redis ä¸€å®šè¦è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚è¿™æ ·èƒ½ä¿è¯åœ¨è¿™ä¸ªæ—¶é—´èŒƒå›´å†…ï¼Œå¦‚æœé‡å¤è°ƒç”¨æ¥å£ï¼Œåˆ™èƒ½å¤Ÿè¿›è¡Œåˆ¤æ–­è¯†åˆ«ã€‚å¦‚æœä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¾ˆå¯èƒ½å¯¼è‡´æ•°æ®æ— é™é‡çš„å­˜å…¥ Redisï¼Œè‡´ä½¿ Redis ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚



### åˆ†å¸ƒå¼ç³»ç»Ÿæ¥å£ï¼Œå¦‚ä½•é¿å…è¡¨å•çš„é‡å¤æäº¤ï¼Ÿ

#### å¹‚ç­‰æ€§

**æ•ˆæœï¼š**ç³»ç»Ÿå¯¹æŸæ¥å£çš„å¤šæ¬¡è¯·æ±‚ï¼Œéƒ½åº”è¯¥è¿”å›åŒæ ·çš„ç»“æœï¼ï¼ˆç½‘ç»œè®¿é—®å¤±è´¥çš„åœºæ™¯é™¤å¤–ï¼‰

**ç›®çš„ï¼š**é¿å…å› ä¸ºå„ç§åŸå› ï¼Œé‡å¤è¯·æ±‚å¯¼è‡´çš„ä¸šåŠ¡é‡å¤å¤„ç†

#### é‡å¤è¯·æ±‚åœºæ™¯æ¡ˆä¾‹

1ï¼Œå®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¯·æ±‚åï¼Œç½‘ç»œå¼‚å¸¸å¯¼è‡´æ”¶åˆ°è¯·æ±‚æ‰§è¡Œé€»è¾‘ä½†æ˜¯æ²¡æœ‰è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯çš„é‡æ–°å‘èµ·è¯·æ±‚

2ï¼Œå®¢æˆ·ç«¯è¿…é€Ÿç‚¹å‡»æŒ‰é’®æäº¤ï¼Œå¯¼è‡´åŒä¸€é€»è¾‘è¢«å¤šæ¬¡å‘é€åˆ°æœåŠ¡å™¨

*ç®€å•æ¥åˆ’åˆ†ï¼Œä¸šåŠ¡é€»è¾‘æ— ééƒ½å¯ä»¥å½’çº³ä¸ºå¢åˆ æ”¹æŸ¥ï¼*

**å¯¹äºæŸ¥è¯¢**ï¼Œå†…éƒ¨ä¸åŒ…å«å…¶ä»–æ“ä½œï¼Œå±äºåªè¯»æ€§è´¨çš„é‚£ç§ä¸šåŠ¡å¿…ç„¶ç¬¦åˆå¹‚ç­‰æ€§è¦æ±‚çš„ã€‚

**å¯¹äºåˆ é™¤**ï¼Œé‡å¤åšåˆ é™¤è¯·æ±‚è‡³å°‘ä¸ä¼šé€ æˆæ•°æ®æ‚ä¹±ï¼Œä¸è¿‡ä¹Ÿæœ‰äº›åœºæ™¯æ›´å¸Œæœ›é‡å¤ç‚¹å‡»æç¤ºçš„æ˜¯åˆ é™¤æˆåŠŸï¼Œè€Œä¸æ˜¯ç›®æ ‡ä¸å­˜åœ¨çš„æç¤ºã€‚

**å¯¹äºæ–°å¢å’Œä¿®æ”¹**ï¼Œè¿™é‡Œæ˜¯ä»Šå¤©è¦é‡ç‚¹å…³æ³¨çš„éƒ¨åˆ†ï¼šæ–°å¢ï¼Œéœ€è¦é¿å…é‡å¤æ’å…¥ï¼›ä¿®æ”¹ï¼Œé¿å…è¿›è¡Œæ— æ•ˆçš„é‡å¤ä¿®æ”¹ï¼›

#### å¹‚ç­‰æ€§çš„å®ç°æ–¹å¼

**å®ç°æ–¹æ³•ï¼š**å®¢æˆ·ç«¯åšæŸä¸€è¯·æ±‚çš„æ—¶å€™å¸¦ä¸Šè¯†åˆ«å‚æ•°æ ‡è¯†ï¼ŒæœåŠ¡ç«¯å¯¹æ­¤æ ‡è¯†è¿›è¡Œè¯†åˆ«ï¼Œé‡å¤è¯·æ±‚åˆ™é‡å¤è¿”å›ç¬¬ä¸€æ¬¡çš„ç»“æœå³å¯ã€‚

**ä¸¾ä¸ªæ —å­ï¼š**æ¯”å¦‚æ·»åŠ è¯·æ±‚çš„è¡¨å•é‡Œï¼Œåœ¨æ‰“å¼€æ·»åŠ è¡¨å•é¡µé¢çš„æ—¶å€™ï¼Œå°±ç”Ÿæˆä¸€ä¸ªAddIdæ ‡è¯†ï¼Œè¿™ä¸ªAddIdè·Ÿç€è¡¨å•ä¸€èµ·æäº¤åˆ°åå°æ¥å£ã€‚

åå°æ¥å£æ ¹æ®è¿™ä¸ªAddIdï¼ŒæœåŠ¡ç«¯å°±å¯ä»¥è¿›è¡Œç¼“å­˜æ ‡è®°å¹¶è¿›è¡Œè¿‡æ»¤ï¼Œç¼“å­˜å€¼å¯ä»¥æ˜¯AddIdä½œä¸ºç¼“å­˜keyï¼Œè¿”å›å†…å®¹ä½œä¸ºç¼“å­˜Valueï¼Œè¿™æ ·å³ä½¿æ·»åŠ æŒ‰é’®è¢«å¤šæ¬¡ç‚¹ä¸‹ä¹Ÿå¯ä»¥è¯†åˆ«å‡ºæ¥ã€‚

è¿™ä¸ªAddIdä»€ä¹ˆæ—¶å€™æ›´æ–°å‘¢ï¼Ÿåªæœ‰åœ¨ä¿å­˜æˆåŠŸå¹¶ä¸”æ¸…ç©ºè¡¨å•ä¹‹åï¼Œæ‰å˜æ›´è¿™ä¸ªAddIdæ ‡è¯†ï¼Œä»è€Œå®ç°æ–°æ•°æ®çš„è¡¨å•æäº¤

### æœ‰å‡ ç§ç”Ÿæˆå”¯ä¸€IDçš„æ–¹å¼ï¼Ÿ

åœ¨å¤æ‚åˆ†å¸ƒå¼ç³»ç»Ÿå’Œåºå¤§æ•°æ®é‡çš„åœºæ™¯ä¸‹ï¼Œä¸€èˆ¬éœ€è¦å¯¹å¤§é‡æ•°æ®è¿›è¡Œå”¯ä¸€æ ‡è¯†ã€‚

æ¯”å¦‚ï¼š

- æ•°æ®åº“åˆ†åº“åˆ†è¡¨åéœ€è¦ç”¨ä¸€ä¸ªå”¯ä¸€IDæ¥æ ‡è¯†ä¸€æ¡æ•°æ®ã€‚
- nosqlä¸­çš„æ•°æ®ï¼Œéœ€è¦ä¸€ä¸ªå”¯ä¸€IDä¸å…¶ä»–æ•°æ®æºçš„æ•°æ®è¿›è¡Œå…³è”

æœ¬æ–‡å¯¹æ¯”å’Œæ€»ç»“äº†å¸¸è§çš„å‡ ç§æ–¹å¼ï¼Œåœ¨åº§åŒå­¦å¯ä»¥è¿›è¡Œå‚è€ƒã€‚

æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­ç»å¸¸ä½¿ç”¨ksuidç®—æ³•ã€‚å®ƒç®€å•å¯é ï¼Œè¿˜å¯æŒ‰æ—¶é—´æ’åº

#### UUID

`UUID ï¼ˆUniversally Unique Identifierï¼‰`ï¼Œé€šç”¨å”¯ä¸€è¯†åˆ«ç çš„ç¼©å†™ã€‚UUIDæ˜¯ç”±ä¸€ç»„32ä½æ•°çš„16è¿›åˆ¶æ•°å­—æ‰€æ„æˆï¼Œæ‰€ä»¥UUIDç†è®ºä¸Šçš„æ€»æ•°ä¸º `16^32=2^128`ï¼Œçº¦ç­‰äº `3.4 x 10^38`ã€‚ä¹Ÿå°±æ˜¯è¯´è‹¥æ¯çº³ç§’äº§ç”Ÿ1å…†ä¸ªUUIDï¼Œè¦èŠ±100äº¿å¹´æ‰ä¼šå°†æ‰€æœ‰UUIDç”¨å®Œã€‚

ç”Ÿæˆçš„UUIDæ˜¯ç”± 8-4-4-4-12æ ¼å¼çš„æ•°æ®ç»„æˆï¼Œå…¶ä¸­32ä¸ªå­—ç¬¦å’Œ4ä¸ªè¿å­—ç¬¦' - 'ï¼Œä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™ä¼šå°†è¿å­—ç¬¦åˆ é™¤ uuid.`toString().replaceAll("-","")`ã€‚

ç›®å‰UUIDçš„äº§ç”Ÿæ–¹å¼æœ‰5ç§ç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬çš„ç®—æ³•ä¸åŒï¼Œåº”ç”¨èŒƒå›´ä¹Ÿä¸åŒã€‚

- `åŸºäºæ—¶é—´çš„UUID` - ç‰ˆæœ¬1ï¼š è¿™ä¸ªä¸€èˆ¬æ˜¯é€šè¿‡å½“å‰æ—¶é—´ï¼Œéšæœºæ•°ï¼Œå’Œæœ¬åœ°Macåœ°å€æ¥è®¡ç®—å‡ºæ¥ï¼Œå¯ä»¥é€šè¿‡ org.apache.logging.log4j.core.utilåŒ…ä¸­çš„ UuidUtil.getTimeBasedUuid()æ¥ä½¿ç”¨æˆ–è€…å…¶ä»–åŒ…ä¸­å·¥å…·ã€‚ç”±äºä½¿ç”¨äº†MACåœ°å€ï¼Œå› æ­¤èƒ½å¤Ÿç¡®ä¿å”¯ä¸€æ€§ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿæš´éœ²äº†MACåœ°å€ï¼Œç§å¯†æ€§ä¸å¤Ÿå¥½ã€‚
- `DCEå®‰å…¨çš„UUID` - ç‰ˆæœ¬2 DCEï¼ˆDistributed Computing Environmentï¼‰å®‰å…¨çš„UUIDå’ŒåŸºäºæ—¶é—´çš„UUIDç®—æ³•ç›¸åŒï¼Œä½†ä¼šæŠŠæ—¶é—´æˆ³çš„å‰4ä½ç½®æ¢ä¸ºPOSIXçš„UIDæˆ–GIDã€‚è¿™ä¸ªç‰ˆæœ¬çš„UUIDåœ¨å®é™…ä¸­è¾ƒå°‘ç”¨åˆ°ã€‚
- `åŸºäºåå­—çš„UUIDï¼ˆMD5ï¼‰`- ç‰ˆæœ¬3 åŸºäºåå­—çš„UUIDé€šè¿‡è®¡ç®—åå­—å’Œåå­—ç©ºé—´çš„MD5æ•£åˆ—å€¼å¾—åˆ°ã€‚è¿™ä¸ªç‰ˆæœ¬çš„UUIDä¿è¯äº†ï¼šç›¸åŒåå­—ç©ºé—´ä¸­ä¸åŒåå­—ç”Ÿæˆçš„UUIDçš„å”¯ä¸€æ€§ï¼›ä¸åŒåå­—ç©ºé—´ä¸­çš„UUIDçš„å”¯ä¸€æ€§ï¼›ç›¸åŒåå­—ç©ºé—´ä¸­ç›¸åŒåå­—çš„UUIDé‡å¤ç”Ÿæˆæ˜¯ç›¸åŒçš„ã€‚
- `éšæœºUUID` - ç‰ˆæœ¬4 æ ¹æ®éšæœºæ•°ï¼Œæˆ–è€…ä¼ªéšæœºæ•°ç”ŸæˆUUIDã€‚è¿™ç§UUIDäº§ç”Ÿé‡å¤çš„æ¦‚ç‡æ˜¯å¯ä»¥è®¡ç®—å‡ºæ¥çš„ï¼Œä½†æ˜¯é‡å¤çš„å¯èƒ½æ€§å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå› æ­¤è¯¥ç‰ˆæœ¬ä¹Ÿæ˜¯è¢«ç»å¸¸ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚JDKä¸­ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªç‰ˆæœ¬ã€‚
- `åŸºäºåå­—çš„UUIDï¼ˆSHA1ï¼‰` - ç‰ˆæœ¬5 å’ŒåŸºäºåå­—çš„UUIDç®—æ³•ç±»ä¼¼ï¼Œåªæ˜¯æ•£åˆ—å€¼è®¡ç®—ä½¿ç”¨SHA1ï¼ˆSecure Hash Algorithm 1ï¼‰ç®—æ³•ã€‚

ä¸€èˆ¬é€‰ç”¨V4ç‰ˆæœ¬ï¼ŒV1æœ‰æš´éœ²macåœ°å€çš„é£é™©ï¼ŒV2ç‰¹å®šåœºæ™¯æ‰ä¼šç”¨åˆ°ï¼ŒV3ã€V5ç›¸åŒçš„è¾“å…¥å‚æ•°å¾—åˆ°ç›¸åŒçš„UUID

ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹ï¼šç®€å•å¯é 
- ç¼ºç‚¹ï¼šä¸å¯æ’åºï¼Œä¸åˆ©äºæ£€ç´¢

#### mysqlè‡ªå¢id

é€‚ç”¨mysqlçš„è‡ªå¢idæœºåˆ¶ï¼Œæ»¡è¶³ é€’å¢æ€§ã€å•è°ƒæ€§ã€å”¯ä¸€æ€§ã€‚

- åœ¨å•æœºæƒ…å†µä¸‹ï¼Œå¦‚æœå¹¶å‘é‡é«˜ï¼Œmysqlçš„å‹åŠ›ä¼šå¾ˆå¤§ã€‚
- åˆ†å¸ƒå¼æƒ…å†µä¸‹ï¼Œä¸€èˆ¬éœ€è¦è®¾å®šæ¯å°æœºå™¨åˆå§‹IDï¼Œæ¥é¿å…IDé‡å¤ã€‚è¿™ç§æ–¹å¼æœ‰å±€é™æ€§ï¼Œä¸”æ°´å¹³æ‰©å±•æ–¹æ¡ˆå¤æ‚ï¼Œå®¹æ˜“ å‡ºé—®é¢˜ã€‚

ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹ï¼šç®€å•å¯é ï¼Œåœ¨å•æœºã€å¹¶å‘ä¸é«˜ã€æ•°æ®é‡è¾ƒå°çš„æƒ…å†µä¸‹é€‚ç”¨
- ç¼ºç‚¹ï¼šåœ¨åˆ†åº“åˆ†è¡¨ã€é«˜å¹¶å‘åœºæ™¯ä¸‹ä¸é€‚ç”¨

#### redis

å› ä¸ºRedisæ˜¯å•çº¿ç¨‹ï¼Œå¤©ç”Ÿä¿è¯åŸå­æ€§ï¼Œå¯ä»¥ä½¿ç”¨åŸå­æ“ä½œINCRå’ŒINCRBYæ¥å®ç°

å•æœºå’Œåˆ†å¸ƒå¼çš„ä¼˜ç¼ºç‚¹ä¸mysqlç±»ä¼¼

#### snowflake

Snowflakeï¼Œé›ªèŠ±ç®—æ³•æ˜¯ç”±Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œä»¥åˆ’åˆ†å‘½åç©ºé—´çš„æ–¹å¼å°† 64-bitä½åˆ†å‰²æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†ä»£è¡¨ä¸åŒçš„å«ä¹‰ã€‚è€Œ Javaä¸­64bitçš„æ•´æ•°æ˜¯Longç±»å‹ï¼Œæ‰€ä»¥åœ¨ Java ä¸­ SnowFlake ç®—æ³•ç”Ÿæˆçš„ ID å°±æ˜¯ long æ¥å­˜å‚¨çš„ã€‚

- **ç¬¬1ä½**å ç”¨1bitï¼Œå…¶å€¼å§‹ç»ˆæ˜¯0ï¼Œå¯çœ‹åšæ˜¯ç¬¦å·ä½ä¸ä½¿ç”¨ã€‚
- **ç¬¬2ä½**å¼€å§‹çš„41ä½æ˜¯æ—¶é—´æˆ³ï¼Œ41-bitä½å¯è¡¨ç¤º2^41ä¸ªæ•°ï¼Œæ¯ä¸ªæ•°ä»£è¡¨æ¯«ç§’ï¼Œé‚£ä¹ˆé›ªèŠ±ç®—æ³•å¯ç”¨çš„æ—¶é—´å¹´é™æ˜¯ `(1L<<41)/(1000L360024*365)`=69 å¹´çš„æ—¶é—´ã€‚
- **ä¸­é—´çš„10-bitä½**å¯è¡¨ç¤ºæœºå™¨æ•°ï¼Œå³2^10 = 1024å°æœºå™¨ï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šéƒ¨ç½²è¿™ä¹ˆå°æœºå™¨ã€‚å¦‚æœæˆ‘ä»¬å¯¹IDCï¼ˆäº’è”ç½‘æ•°æ®ä¸­å¿ƒï¼‰æœ‰éœ€æ±‚ï¼Œè¿˜å¯ä»¥å°† 10-bit åˆ† 5-bit ç»™ IDCï¼Œåˆ†5-bitç»™å·¥ä½œæœºå™¨ã€‚è¿™æ ·å°±å¯ä»¥è¡¨ç¤º32ä¸ªIDCï¼Œæ¯ä¸ªIDCä¸‹å¯ä»¥æœ‰32å°æœºå™¨ï¼Œå…·ä½“çš„åˆ’åˆ†å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚å®šä¹‰ã€‚
- **æœ€å12-bitä½**æ˜¯è‡ªå¢åºåˆ—ï¼Œå¯è¡¨ç¤º2^12 = 4096ä¸ªæ•°ã€‚

è¿™æ ·çš„åˆ’åˆ†ä¹‹åç›¸å½“äº**åœ¨ä¸€æ¯«ç§’ä¸€ä¸ªæ•°æ®ä¸­å¿ƒçš„ä¸€å°æœºå™¨ä¸Šå¯äº§ç”Ÿ4096ä¸ªæœ‰åºçš„ä¸é‡å¤çš„ID**ã€‚ä½†æ˜¯æˆ‘ä»¬ IDC å’Œæœºå™¨æ•°è‚¯å®šä¸æ­¢ä¸€ä¸ªï¼Œæ‰€ä»¥æ¯«ç§’å†…èƒ½ç”Ÿæˆçš„æœ‰åºIDæ•°æ˜¯ç¿»å€çš„ã€‚

ç®—æ³•ç»“æ„

![image-20220709155254210](./images/image-20220709155254210.png)

ä¼˜åŠ¿ï¼š

- å•æœºå¯åœ¨ä¸€æ¯«ç§’å†…ç”Ÿæˆ4096ä¸ªå”¯ä¸€ID
- å› ä¸ºæœ€é«˜ä½æ˜¯æ—¶é—´æˆ³ï¼Œæ‰€ä»¥snowflakeç”Ÿæˆçš„IDéƒ½æ˜¯æŒ‰æ—¶é—´è¶‹åŠ¿é€’å¢
- å› ä¸ºæœ‰ workerIdæ¥åšåŒºåˆ†ï¼Œæ‰€ä»¥æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…ä¸ä¼šäº§ç”Ÿé‡å¤ID

æœ€å¤§çš„é—®é¢˜ï¼šæ—¶é’Ÿå›æ‹¨

snowflakeéå¸¸ä¾èµ–ç³»ç»Ÿæ—¶é—´çš„ä¸€è‡´æ€§ï¼Œå¦‚æœå‘ç”Ÿç³»ç»Ÿæ—¶é—´çš„å›è°ƒï¼Œæ”¹å˜ï¼Œå°±å¯èƒ½ä¼šå‘ç”Ÿidçš„é‡å¤

ä¸‹é¢æ˜¯æˆ‘æ€»ç»“çš„å‡ ç§è§£å†³æ–¹æ³•ï¼š

- ç®€å•ç²—æš´ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯ï¼Œè®©ä¸šåŠ¡å±‚å»è§£å†³
- å…³é—­æœåŠ¡å™¨æ—¶é—´åŒæ­¥
- ä¿å­˜è¿‡å»ä¸€å°æ—¶ï¼Œæ¯ä¸ªæ¯«ç§’çš„åºå·ä½¿ç”¨æƒ…å†µã€‚å¦‚æœæ—¶é—´å›é€€åˆ°æŸä¸€æ¯«ç§’ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸€æ¯«ç§’çš„åºå·ï¼Œç»§ç»­ç”ŸæˆID
- ç”ŸæˆIDçš„æ—¶é—´ï¼Œä¸å®æ—¶è·ŸéšæœåŠ¡å™¨æ—¶é—´ï¼Œå½“1æ¯«ç§’å†…çš„åºå·å…¨éƒ¨ç”¨å®Œï¼Œæ‰è·³åˆ°ä¸‹ä¸€æ¯«ç§’ã€‚å¦‚æœç”ŸæˆIDçš„å¹¶å‘é‡ä¸å¤§ï¼Œå°±æœ‰å¾ˆå¤§çš„ä½™é‡æ—¶é—´æ²¡æœ‰ä½¿ç”¨ï¼Œå°±ç®—æ—¶é’Ÿå›é€€äº†ï¼Œä¹Ÿæ˜¯å›é€€åˆ°æ²¡æœ‰è¢«ä½¿ç”¨çš„æ—¶é—´ã€‚

ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹ï¼šç”Ÿæˆçš„IDè¶‹åŠ¿é€’å¢ï¼Œç”Ÿæˆæ•ˆç‡é«˜ï¼Œå¯ä¿è¯ä¸é‡å¤
- ç¼ºç‚¹ï¼šæ—¶é’Ÿå›æ‹¨é—®é¢˜å¤„ç†èµ·æ¥å¤æ‚ï¼Œå®¹æ˜“å‡ºç°é—®é¢˜

#### ksuid

ç®—æ³•ç»“æ„

![image-20220709155341400](./images/image-20220709155341400.png)

ksuidç”±ä¸¤éƒ¨åˆ†ç»„æˆ

- **ç¬¬ä¸€éƒ¨åˆ†**

32ä½çš„ç§’çº§æ—¶é—´æˆ³

- **ç¬¬äºŒéƒ¨åˆ†**

128 ä½éšæœºç”Ÿæˆè½½è·

ä¼˜åŠ¿ï¼š

- å› ä¸ºæœ€é«˜ä½æ˜¯æ—¶é—´æˆ³ï¼Œæ‰€ä»¥snowflakeç”Ÿæˆçš„IDéƒ½æ˜¯æŒ‰æ—¶é—´è¶‹åŠ¿é€’å¢
- è€Œ128ä½çš„å·ç ç©ºé—´ï¼Œåœ¨ä¸€ç§’å†…å‡ºç°éšæœºç¢°æ’çš„æ¦‚ç‡éå¸¸ä¹‹ä½ï¼Œ1/2^128 çº¦ç­‰äºæ˜å¤©é™¨çŸ³æ’åœ°çƒçš„æ¦‚ç‡
- æ²¡æœ‰åºå·åˆ™å¯ä»¥é¿å…snowflakeçš„æ—¶é’Ÿå›æ‹¨é—®é¢˜

ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹ï¼šç”Ÿæˆçš„IDè¶‹åŠ¿é€’å¢ï¼Œç”Ÿæˆæ•ˆç‡é«˜ï¼Œæ²¡æœ‰æ—¶é’Ÿå›æ‹¨çš„é—®é¢˜
- ç¼ºç‚¹ï¼šæœ‰éšæœºéƒ¨åˆ†ï¼Œç†è®ºä¸Šå­˜åœ¨éšæœºç¢°æ’çš„å¯èƒ½

#### å…¶ä»–

å¦å¤–è¿˜æœ‰ï¼š

* ç™¾åº¦-UidGenerator
* ç¾å›¢Leaf

å¯¹æ¯”äº†5ç§è§£å†³æ–¹æ¡ˆã€‚åœ¨æˆ‘çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘é€‰æ‹©ç®€å•å¯é çš„ksuidç®—æ³•æ¥ç”Ÿæˆå”¯ä¸€ID



### å•ç‚¹ç™»å½•

å•ç‚¹ç™»å½•çš„è‹±æ–‡åå«åšï¼šSingle Sign Onï¼ˆç®€ç§°**SSO**ï¼‰ã€‚

åœ¨**åˆå­¦/ä»¥å‰**çš„æ—¶å€™ï¼Œä¸€èˆ¬æˆ‘ä»¬å°±**å•ç³»ç»Ÿ**ï¼Œæ‰€æœ‰çš„åŠŸèƒ½éƒ½åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸Šã€‚



## ğŸ‘¨â€ğŸ’»è®¡ç®—æœºåŸºç¡€

### ğŸŒè®¡ç®—æœºç½‘ç»œï¼ˆçƒ­é—¨å…«è‚¡æ–‡ï¼‰

#### ğŸ‘ï¸å‰ç½®çŸ¥è¯†

##### OSI ä¸ƒå±‚æ¨¡å‹

**OSI ä¸ƒå±‚æ¨¡å‹** æ˜¯å›½é™…æ ‡å‡†åŒ–ç»„ç»‡æå‡ºä¸€ä¸ªç½‘ç»œåˆ†å±‚æ¨¡å‹ï¼Œå…¶å¤§ä½“ç»“æ„ä»¥åŠæ¯ä¸€å±‚æä¾›çš„åŠŸèƒ½å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220617141718194](./images/image-20220617141718194.png)

æ¯ä¸€å±‚éƒ½ä¸“æ³¨åšä¸€ä»¶äº‹æƒ…ï¼Œå¹¶ä¸”æ¯ä¸€å±‚éƒ½éœ€è¦ä½¿ç”¨ä¸‹ä¸€å±‚æä¾›çš„åŠŸèƒ½æ¯”å¦‚ä¼ è¾“å±‚éœ€è¦ä½¿ç”¨ç½‘ç»œå±‚æä¾›çš„è·¯ç”±å’Œå¯»å€åŠŸèƒ½ï¼Œè¿™æ ·ä¼ è¾“å±‚æ‰çŸ¥é“æŠŠæ•°æ®ä¼ è¾“åˆ°å“ªé‡Œå»ã€‚

**OSI çš„ä¸ƒå±‚ä½“ç³»ç»“æ„æ¦‚å¿µæ¸…æ¥šï¼Œç†è®ºä¹Ÿå¾ˆå®Œæ•´ï¼Œä½†æ˜¯å®ƒæ¯”è¾ƒå¤æ‚è€Œä¸”ä¸å®ç”¨ï¼Œè€Œä¸”æœ‰äº›åŠŸèƒ½åœ¨å¤šä¸ªå±‚ä¸­é‡å¤å‡ºç°ã€‚**

ä¸Šé¢è¿™ç§å›¾å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œå†æ¥ä¸€ä¸ªæ¯”è¾ƒç”ŸåŠ¨çš„å›¾ç‰‡ã€‚ä¸‹é¢è¿™ä¸ªå›¾ç‰‡æ˜¯æˆ‘åœ¨å›½å¤–çš„ä¸€ä¸ªç½‘ç«™ä¸Šçœ‹åˆ°çš„ï¼Œéå¸¸èµï¼

![image-20220617141726678](./images/image-20220617141726678.png)

**æ—¢ç„¶ OSI ä¸ƒå±‚æ¨¡å‹è¿™ä¹ˆå‰å®³ï¼Œä¸ºä»€ä¹ˆå¹²ä¸è¿‡ TCP/IP å›› å±‚æ¨¡å‹å‘¢ï¼Ÿ**

çš„ç¡®ï¼ŒOSI ä¸ƒå±‚æ¨¡å‹å½“æ—¶ä¸€ç›´è¢«ä¸€äº›å¤§å…¬å¸ç”šè‡³ä¸€äº›å›½å®¶æ”¿åºœæ”¯æŒã€‚è¿™æ ·çš„èƒŒæ™¯ä¸‹ï¼Œä¸ºä»€ä¹ˆä¼šå¤±è´¥å‘¢ï¼Ÿæˆ‘è§‰å¾—ä¸»è¦æœ‰ä¸‹é¢å‡ æ–¹é¢åŸå› ï¼š

1. OSI çš„ä¸“å®¶ç¼ºä¹å®é™…ç»éªŒï¼Œä»–ä»¬åœ¨å®Œæˆ OSI æ ‡å‡†æ—¶ç¼ºä¹å•†ä¸šé©±åŠ¨åŠ›
2. OSI çš„åè®®å®ç°èµ·æ¥è¿‡åˆ†å¤æ‚ï¼Œè€Œä¸”è¿è¡Œæ•ˆç‡å¾ˆä½
3. OSI åˆ¶å®šæ ‡å‡†çš„å‘¨æœŸå¤ªé•¿ï¼Œå› è€Œä½¿å¾—æŒ‰ OSI æ ‡å‡†ç”Ÿäº§çš„è®¾å¤‡æ— æ³•åŠæ—¶è¿›å…¥å¸‚åœºï¼ˆ20 ä¸–çºª 90 å¹´ä»£åˆæœŸï¼Œè™½ç„¶æ•´å¥—çš„ OSI å›½é™…æ ‡å‡†éƒ½å·²ç»åˆ¶å®šå‡ºæ¥ï¼Œä½†åŸºäº TCP/IP çš„äº’è”ç½‘å·²ç»æŠ¢å…ˆåœ¨å…¨çƒç›¸å½“å¤§çš„èŒƒå›´æˆåŠŸè¿è¡Œäº†ï¼‰
4. OSI çš„å±‚æ¬¡åˆ’åˆ†ä¸å¤ªåˆç†ï¼Œæœ‰äº›åŠŸèƒ½åœ¨å¤šä¸ªå±‚æ¬¡ä¸­é‡å¤å‡ºç°ã€‚

OSI ä¸ƒå±‚æ¨¡å‹è™½ç„¶å¤±è´¥äº†ï¼Œä½†æ˜¯å´æä¾›äº†å¾ˆå¤šä¸é”™çš„ç†è®ºåŸºç¡€ã€‚ä¸ºäº†æ›´å¥½åœ°å»äº†è§£ç½‘ç»œåˆ†å±‚ï¼ŒOSI ä¸ƒå±‚æ¨¡å‹è¿˜æ˜¯éå¸¸æœ‰å¿…è¦å­¦ä¹ çš„ã€‚

æœ€åå†åˆ†äº«ä¸€ä¸ªå…³äº OSI ä¸ƒå±‚æ¨¡å‹éå¸¸ä¸é”™çš„æ€»ç»“å›¾ç‰‡ï¼

![image-20220617141738525](./images/image-20220617141738525.png)

##### TCP/IP å››å±‚æ¨¡å‹

**TCP/IP å››å±‚æ¨¡å‹** æ˜¯ç›®å‰è¢«å¹¿æ³›é‡‡ç”¨çš„ä¸€ç§æ¨¡å‹,æˆ‘ä»¬å¯ä»¥å°† TCP / IP æ¨¡å‹çœ‹ä½œæ˜¯ OSI ä¸ƒå±‚æ¨¡å‹çš„ç²¾ç®€ç‰ˆæœ¬ï¼Œç”±ä»¥ä¸‹ 4 å±‚ç»„æˆï¼š

1. åº”ç”¨å±‚
2. ä¼ è¾“å±‚
3. ç½‘ç»œå±‚
4. ç½‘ç»œæ¥å£å±‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½å°† TCP/IP å››å±‚æ¨¡å‹ å’Œ OSI ä¸ƒå±‚æ¨¡å‹å®Œå…¨ç²¾ç¡®åœ°åŒ¹é…èµ·æ¥ï¼Œä¸è¿‡å¯ä»¥ç®€å•å°†ä¸¤è€…å¯¹åº”èµ·æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220617141758284](./images/image-20220617141758284.png)

###### åº”ç”¨å±‚ï¼ˆApplication layerï¼‰

**åº”ç”¨å±‚ä½äºä¼ è¾“å±‚ä¹‹ä¸Šï¼Œä¸»è¦æä¾›ä¸¤ä¸ªç»ˆç«¯è®¾å¤‡ä¸Šçš„åº”ç”¨ç¨‹åºä¹‹é—´ä¿¡æ¯äº¤æ¢çš„æœåŠ¡ï¼Œå®ƒå®šä¹‰äº†ä¿¡æ¯äº¤æ¢çš„æ ¼å¼ï¼Œæ¶ˆæ¯ä¼šäº¤ç»™ä¸‹ä¸€å±‚ä¼ è¾“å±‚æ¥ä¼ è¾“ã€‚** æˆ‘ä»¬æŠŠåº”ç”¨å±‚äº¤äº’çš„æ•°æ®å•å…ƒç§°ä¸ºæŠ¥æ–‡ã€‚

![image-20220617141814110](./images/image-20220617141814110.png)

åº”ç”¨å±‚åè®®å®šä¹‰äº†ç½‘ç»œé€šä¿¡è§„åˆ™ï¼Œå¯¹äºä¸åŒçš„ç½‘ç»œåº”ç”¨éœ€è¦ä¸åŒçš„åº”ç”¨å±‚åè®®ã€‚åœ¨äº’è”ç½‘ä¸­åº”ç”¨å±‚åè®®å¾ˆå¤šï¼Œå¦‚æ”¯æŒ Web åº”ç”¨çš„ HTTP åè®®ï¼Œæ”¯æŒç”µå­é‚®ä»¶çš„ SMTP åè®®ç­‰ç­‰ã€‚

![image-20220617141821818](./images/image-20220617141821818.png)

###### ä¼ è¾“å±‚ï¼ˆTransport layerï¼‰

**ä¼ è¾“å±‚çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯è´Ÿè´£å‘ä¸¤å°ç»ˆç«¯è®¾å¤‡è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æä¾›é€šç”¨çš„æ•°æ®ä¼ è¾“æœåŠ¡ã€‚** åº”ç”¨è¿›ç¨‹åˆ©ç”¨è¯¥æœåŠ¡ä¼ é€åº”ç”¨å±‚æŠ¥æ–‡ã€‚â€œé€šç”¨çš„â€æ˜¯æŒ‡å¹¶ä¸é’ˆå¯¹æŸä¸€ä¸ªç‰¹å®šçš„ç½‘ç»œåº”ç”¨ï¼Œè€Œæ˜¯å¤šç§åº”ç”¨å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªè¿è¾“å±‚æœåŠ¡ã€‚

**è¿è¾“å±‚ä¸»è¦ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§åè®®ï¼š**

1. **ä¼ è¾“æ§åˆ¶åè®® TCP**ï¼ˆTransmisson Control Protocolï¼‰--æä¾›**é¢å‘è¿æ¥**çš„ï¼Œ**å¯é çš„**æ•°æ®ä¼ è¾“æœåŠ¡ã€‚
2. **ç”¨æˆ·æ•°æ®åè®® UDP**ï¼ˆUser Datagram Protocolï¼‰--æä¾›**æ— è¿æ¥**çš„ï¼Œå°½æœ€å¤§åŠªåŠ›çš„æ•°æ®ä¼ è¾“æœåŠ¡ï¼ˆ**ä¸ä¿è¯æ•°æ®ä¼ è¾“çš„å¯é æ€§**ï¼‰ã€‚

![image-20220617141843078](./images/image-20220617141843078.png)

###### ç½‘ç»œå±‚ï¼ˆNetwork layerï¼‰

**ç½‘ç»œå±‚è´Ÿè´£ä¸ºåˆ†ç»„äº¤æ¢ç½‘ä¸Šçš„ä¸åŒä¸»æœºæä¾›é€šä¿¡æœåŠ¡ã€‚** åœ¨å‘é€æ•°æ®æ—¶ï¼Œç½‘ç»œå±‚æŠŠè¿è¾“å±‚äº§ç”Ÿçš„æŠ¥æ–‡æ®µæˆ–ç”¨æˆ·æ•°æ®æŠ¥å°è£…æˆåˆ†ç»„å’ŒåŒ…è¿›è¡Œä¼ é€ã€‚åœ¨ TCP/IP ä½“ç³»ç»“æ„ä¸­ï¼Œç”±äºç½‘ç»œå±‚ä½¿ç”¨ IP åè®®ï¼Œå› æ­¤åˆ†ç»„ä¹Ÿå« IP æ•°æ®æŠ¥ï¼Œç®€ç§°æ•°æ®æŠ¥ã€‚

âš ï¸æ³¨æ„ ï¼š**ä¸è¦æŠŠè¿è¾“å±‚çš„â€œç”¨æˆ·æ•°æ®æŠ¥ UDPâ€å’Œç½‘ç»œå±‚çš„â€œIP æ•°æ®æŠ¥â€å¼„æ··**ã€‚

**ç½‘ç»œå±‚çš„è¿˜æœ‰ä¸€ä¸ªä»»åŠ¡å°±æ˜¯é€‰æ‹©åˆé€‚çš„è·¯ç”±ï¼Œä½¿æºä¸»æœºè¿è¾“å±‚æ‰€ä¼ ä¸‹æ¥çš„åˆ†ç»„ï¼Œèƒ½é€šè¿‡ç½‘ç»œå±‚ä¸­çš„è·¯ç”±å™¨æ‰¾åˆ°ç›®çš„ä¸»æœºã€‚**

è¿™é‡Œå¼ºè°ƒæŒ‡å‡ºï¼Œç½‘ç»œå±‚ä¸­çš„â€œç½‘ç»œâ€äºŒå­—å·²ç»ä¸æ˜¯æˆ‘ä»¬é€šå¸¸è°ˆåˆ°çš„å…·ä½“ç½‘ç»œï¼Œè€Œæ˜¯æŒ‡è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„æ¨¡å‹ä¸­ç¬¬ä¸‰å±‚çš„åç§°ã€‚

äº’è”ç½‘æ˜¯ç”±å¤§é‡çš„å¼‚æ„ï¼ˆheterogeneousï¼‰ç½‘ç»œé€šè¿‡è·¯ç”±å™¨ï¼ˆrouterï¼‰ç›¸äº’è¿æ¥èµ·æ¥çš„ã€‚äº’è”ç½‘ä½¿ç”¨çš„ç½‘ç»œå±‚åè®®æ˜¯æ— è¿æ¥çš„ç½‘é™…åè®®ï¼ˆIntert Prococolï¼‰å’Œè®¸å¤šè·¯ç”±é€‰æ‹©åè®®ï¼Œå› æ­¤äº’è”ç½‘çš„ç½‘ç»œå±‚ä¹Ÿå«åš**ç½‘é™…å±‚**æˆ–**IP å±‚**ã€‚

![image-20220617141854709](./images/image-20220617141854709.png)

###### ç½‘ç»œæ¥å£å±‚ï¼ˆNetwork interface layerï¼‰

æˆ‘ä»¬å¯ä»¥æŠŠç½‘ç»œæ¥å£å±‚çœ‹ä½œæ˜¯æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚çš„åˆä½“ã€‚

1. æ•°æ®é“¾è·¯å±‚(data link layer)é€šå¸¸ç®€ç§°ä¸ºé“¾è·¯å±‚ï¼ˆ ä¸¤å°ä¸»æœºä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œæ€»æ˜¯åœ¨ä¸€æ®µä¸€æ®µçš„é“¾è·¯ä¸Šä¼ é€çš„ï¼‰ã€‚**æ•°æ®é“¾è·¯å±‚çš„ä½œç”¨æ˜¯å°†ç½‘ç»œå±‚äº¤ä¸‹æ¥çš„ IP æ•°æ®æŠ¥ç»„è£…æˆå¸§ï¼Œåœ¨ä¸¤ä¸ªç›¸é‚»èŠ‚ç‚¹é—´çš„é“¾è·¯ä¸Šä¼ é€å¸§ã€‚æ¯ä¸€å¸§åŒ…æ‹¬æ•°æ®å’Œå¿…è¦çš„æ§åˆ¶ä¿¡æ¯ï¼ˆå¦‚åŒæ­¥ä¿¡æ¯ï¼Œåœ°å€ä¿¡æ¯ï¼Œå·®é”™æ§åˆ¶ç­‰ï¼‰ã€‚**
2. **ç‰©ç†å±‚çš„ä½œç”¨æ˜¯å®ç°ç›¸é‚»è®¡ç®—æœºèŠ‚ç‚¹ä¹‹é—´æ¯”ç‰¹æµçš„é€æ˜ä¼ é€ï¼Œå°½å¯èƒ½å±è”½æ‰å…·ä½“ä¼ è¾“ä»‹è´¨å’Œç‰©ç†è®¾å¤‡çš„å·®å¼‚**

![image-20220617141907476](./images/image-20220617141907476.png)

##### TCPæµé‡æ§åˆ¶

**TCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ã€‚æµé‡æ§åˆ¶æ˜¯ä¸ºäº†æ§åˆ¶å‘é€æ–¹å‘é€é€Ÿç‡ï¼Œä¿è¯æ¥æ”¶æ–¹æ¥å¾—åŠæ¥æ”¶ã€‚** æ¥æ”¶æ–¹å‘é€çš„ç¡®è®¤æŠ¥æ–‡ä¸­çš„çª—å£å­—æ®µå¯ä»¥ç”¨æ¥æ§åˆ¶å‘é€æ–¹çª—å£å¤§å°ï¼Œä»è€Œå½±å“å‘é€æ–¹çš„å‘é€é€Ÿç‡ã€‚å°†çª—å£å­—æ®µè®¾ç½®ä¸º 0ï¼Œåˆ™å‘é€æ–¹ä¸èƒ½å‘é€æ•°æ®

ğŸŒ° ç›´æ¥ä¸¾æ —å­è¯´æ˜ï¼Œè¯·ç»“åˆå›¾è€å¿ƒé˜…è¯»ï¼š

1. ä¸»æœºAé€šè¿‡TCPæŠ¥æ–‡å‘é€ç»™ä¸»æœºB 1-100å­—èŠ‚ ï¼ˆseqæ˜¯åºå·å­—æ®µï¼Œ DATAæ˜¯è¡¨ç¤ºæ˜¯æ•°æ®æŠ¥æ–‡æ®µï¼‰
2. ä¸»æœºAåˆé€šè¿‡TCPæŠ¥æ–‡å‘é€ç»™ä¸»æœºB 101-200å­—èŠ‚ï¼ˆæ‰€ä»¥è¿™é‡Œçš„seqæ˜¯101ï¼‰
3. ä¸»æœºAåˆé€šè¿‡TCPæŠ¥æ–‡å°è£…å‘é€ç»™æ³¨è§£B 201-300å­—èŠ‚ï¼Œä½†æ˜¯å‘ç”Ÿäº†ä¸¢å¤± ğŸ³ï¸
   1. æ­¤æ—¶ä¸»æœºBå¯¹ä¸»æœºAè¿›è¡Œ**ç´¯è®¡ç¡®è®¤**ï¼ˆACKï¼šTCPæŠ¥æ–‡æ®µé¦–éƒ¨ä¸­çš„æ ‡å¿—ä½ï¼›ackï¼šç¡®è®¤æŠ¥æ–‡æ®µï¼Œ201æ˜¯è¯´æ˜201ä»¥å‰çš„æ•°æ®å·²å…¨éƒ¨æ­£ç¡®æ¥æ”¶ï¼›rwndæ»‘åŠ¨çª—å£å­—æ®µï¼Œ300è¡¨ç¤ºå¯ä»¥æ¥æ”¶çš„çª—å£å¤§å°ä¸º300ï¼‰
   2. æ»‘åŠ¨çª—å£ï¼Œæ»‘åˆ°201-600çš„ä½ç½®ï¼ˆå› ä¸ºåˆå§‹çª—å£çš„å¤§å°ä¸º400ï¼‰
   3. è°ƒæ•´çª—å£å¤§å°ï¼Œæ­¤æ—¶çª—å£ä½ç½®ä¸º201-500ï¼ˆå› ä¸ºrwndç°åœ¨ä¸º300ï¼‰
4. ä¸»æœºAåˆ é™¤1-200çš„ç¼“å­˜æ•°æ®ï¼ˆå› ä¸ºæ­¥éª¤3ä¸­å·²ç»è¯´æ˜äº†201ä¹‹å‰çš„æ•°æ®å·²ç»ç¡®è®¤æ¥æ”¶ï¼‰
5. ä¸»æœºAè®²301-400çš„æ•°æ®å°è£…æˆTCPå‘é€ç»™ä¸»æœºBï¼ˆæ­¤æ—¶201-500çš„æ•°æ®å·²ç»å…¨éƒ¨å‘é€å‡ºå»ï¼‰
6. é‡ä¼ è®¡æ—¶å™¨å¼€å§‹è®¡æ—¶ï¼Œä¸»æœºAæŠŠ201-500çš„æ•°æ®å°è£…æˆTCPæŠ¥æ–‡æ®µé‡æ–°å‘é€å‡ºå»ï¼ˆç»™Bï¼‰
7. æ­¤æ—¶ä¸»æœºBå¯¹ä¸»æœºAè¿›è¡Œ**ç´¯è®¡ç¡®è®¤**ï¼ˆACK=1ï¼Œack=501ï¼šç¡®è®¤501ä¹‹å‰çš„æ•°æ®ï¼Œrwnd=100ï¼šæ­¤æ—¶ä¸»æœºBè¿˜èƒ½æ¥æ”¶100å­—èŠ‚çš„æ•°æ®ï¼‰
   1. æ­¤æ—¶æ»‘åŠ¨çª—å£ä»501-800ï¼ˆçª—å£å¤§å°ä¸º300ï¼‰
   2. å› ä¸ºæ”¶åˆ°ä¸»æœºBçš„rwnd=100ï¼Œæ‰€ä»¥è°ƒæ•´çª—å£å¤§å°ä¸º501-600
8. åˆ é™¤501ä¹‹å‰çš„æ•°æ®ç¼“å­˜
9. å°è£…æˆTCPæŠ¥æ–‡é€501-600çš„æ•°æ®
10. æ­¤æ—¶ä¸»æœºBåˆå¯¹ä¸»æœºAè¿›è¡Œ**ç´¯è®¡ç¡®è®¤**ï¼ˆACK=1ï¼Œack=601ï¼Œrwnd=0ï¼‰æ­¤æ—¶ä¸»æœºAä¸èƒ½å†å‘é€äº†ï¼Œå‘é€çª—å£è¢«è°ƒæ§ä¸º0

![image-20220622144025833](./images/image-20220622144025833.png)

ğŸ’¨å‡è®¾ä¸ä¹…ä¹‹åï¼Œä¸»æœºBåˆæœ‰äº†ä¸€äº›å­˜å‚¨ç©ºé—´ï¼š

1. ä¸»æœºBå¯¹ä¸»æœºAå‘é€ä¸€ä¸ªrwnd=300çš„æŠ¥æ–‡æ®µï¼Œä½†æ˜¯è¿™ä¸ªæŠ¥æ–‡æ®µåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±äº†
   1. Aä¸€ç›´ç­‰å¾…Bå‘é€çš„éé›¶çª—å£é€šçŸ¥ï¼ŒBä¹Ÿä¸€ç›´ç­‰å¾…Aå‘é€çš„æ•°æ®ï¼ˆç»å…¸æ­»é”ï¼‰
   2. TCPè§£å†³æ–¹æ¡ˆï¼šè®¾ç«‹å®šæ—¶å™¨ï¼›æ‰€ä»¥ä¸»æœºAä¼šå¯åŠ¨ä¸€ä¸ªæŒç»­è®¡æ—¶å™¨
   3. å¦‚æœæŒç»­è®¡æ—¶å™¨è¶…æ—¶ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªé›¶çª—å£æ¢æµ‹æŠ¥æ–‡æ®µï¼ˆæºå¸¦1å­—èŠ‚æ•°æ®ï¼‰ã€æ‹“å±•ï¼šé›¶çª—å£æ¢æµ‹æŠ¥æ–‡æ®µä¹Ÿæœ‰æŒç»­è®¡æ—¶å™¨ï¼Œå¦‚æœä¸¢å¤±äº†ä¹Ÿä¼šè¿›è¡Œé‡ä¼ é¿å…æ­»é”ã€‘
2. å¦‚æœç°åœ¨ä¸»æœºBåˆæ²¡æœ‰ç©ºé—´äº†ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªçª—å£æ¢æµ‹æŠ¥æ–‡æ®µè¿›è¡Œç¡®è®¤ï¼ˆACK=1 rwnd=0ï¼‰
3. ä¸»æœºAæ¥æ”¶åˆ°äº†ä¼šåˆå¯åŠ¨ä¸€ä¸ªæŒç»­è®¡æ—¶å™¨ï¼Œå¦‚æœä¸»æœºBåˆæœ‰äº†å­˜å‚¨ç©ºé—´ï¼ˆå‡è®¾ç°åœ¨ä¸º300ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šå‘é€ä¸€ä¸ªæ¥æ”¶çª—å£ï¼ˆACK=1ï¼Œrwnd=300ï¼‰

![image-20220622144903957](./images/image-20220622144903957.png)

##### TCPæ‹¥å¡æ§åˆ¶

å››ç§æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼šæ…¢å¼€å§‹ã€æ‹¥å¡é¿å…ã€å¿«é‡ä¼ ï¼Œå¿«æ¢å¤

###### æ…¢å¼€å§‹ã€æ‹¥å¡é¿å…

å‡è®¾å‘é€æ–¹cwnd=1,swnd=cwnd,ssthresh=16

æ…¢å¼€å§‹å°ç»“ï¼šæ»‘åŠ¨çª—å£é€æ¸å¢å¤§

1. å‘é€æ–¹ç»™æ¥æ”¶æ–¹å‘é€æŠ¥æ–‡æ®µï¼Œå‘é€æ–¹æ¥æ”¶åˆ°äº†æ¥æ”¶æ–¹çš„ç¡®è®¤æŠ¥æ–‡æ®µåå°†çª—å£å¢å¤§1 (1+1=2)ï¼Œæ­¤æ—¶å‘é€å‘å¯ä»¥å‘é€2å·æ•°æ®æŠ¥æ–‡æ®µ

![image-20220622145827589](./images/image-20220622145827589.png)

2. æ­¤æ—¶å‘é€å‘åˆå‘é€1~2æŠ¥æ–‡æ®µï¼Œæ¥æ”¶æ–¹ç¡®è®¤åï¼Œå‘é€æ–¹å°†çª—å£å¢å¤§ä¸º4ï¼ˆ2+2=4ï¼‰ï¼Œå‘é€å‘ç°åœ¨å¯ä»¥å‘é€3~6å·æ•°æ®æŠ¥æ–‡æ®µ

![image-20220622150047014](./images/image-20220622150047014.png)

3. æ­¤æ—¶å‘é€å‘åˆå‘é€3~6æŠ¥æ–‡æ®µï¼Œæ¥æ”¶æ–¹ç¡®è®¤åï¼Œå‘é€æ–¹å°†çª—å£å¢å¤§ä¸º4ï¼ˆ4+4=8ï¼‰ï¼Œå‘é€å‘ç°åœ¨å¯ä»¥å‘é€7~14å·æ•°æ®æŠ¥æ–‡æ®µ

![image-20220622150158817](./images/image-20220622150158817.png)

4. åŒç†å¯ä»¥å¢åŠ åˆ°16çš„çª—å£å¤§å°

![image-20220622150303164](./images/image-20220622150303164.png)

5. æ­¤æ—¶å¼€å§‹**æ‹¥å¡é¿å…**ç®—æ³•ï¼šå¯¹æŠ¥æ–‡æ®µ15~30å·è¿›è¡Œå‘é€å’Œç¡®è®¤ï¼Œæ­¤æ—¶cwndä»16 + 1 = 17ï¼Œ

![image-20220622150515511](./images/image-20220622150515511.png)

6. æ­¤æ—¶å¯ä»¥å¯¹TCPæŠ¥æ–‡æ®µ31~47å·è¿›è¡Œå‘é€å’Œç¡®è®¤ï¼Œå‘é€æ–¹æ”¶åˆ°åçª—å£ä»17å¢å¤§åˆ°18ï¼ˆ17+1ï¼‰

![image-20220622150617743](./images/image-20220622150617743.png)

7. ä»¥æ­¤ç±»æ¨ï¼Œå½“å¢åŠ åˆ°24çš„æ»‘åŠ¨çª—å£æ—¶ï¼Œæ­¤æ—¶TCPå¯¹171~194æŠ¥æ–‡æ®µè¿›è¡Œå‘é€å’Œç¡®è®¤

![image-20220622150715342](./images/image-20220622150715342.png)

å¦‚æœæ­¤æ—¶æŠ¥æ–‡æ®µå‘ç”Ÿäº†ä¸¢å¤±ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œé‡ä¼ è®¡æ—¶å™¨è¶…æ—¶ï¼ˆåˆ¤æ–­ç½‘ç»œå‡ºç°äº†æ‹¥å¡ï¼‰ï¼š

* å°†ssthreshå€¼æ›´æ–°ä¸ºå‘ç”Ÿæ‹¥å¡æ§åˆ¶æ—¶cwndå€¼çš„ä¸€åŠï¼ˆssthresh = 24 / 2 = 12ï¼‰
* å°†cwndå€¼å‡å°‘ä¸º1ï¼Œå¹¶å¼€å§‹æ‰§è¡Œæ…¢å¼€å§‹ç®—æ³•ï¼ˆcwnd=1ï¼‰

![image-20220622152317600](./images/image-20220622152317600.png)

8. åˆå¼€å§‹æ…¢å¼€å§‹ç®—æ³•ï¼Œç›´åˆ°è¾¾åˆ°æ…¢å¼€å§‹é—¨é™å€¼

![image-20220622152350238](./images/image-20220622152350238.png)

æ•´ä½“æµç¨‹ï¼š

![image-20220622152551749](./images/image-20220622152551749.png)

###### å¿«é‡ä¼ ã€å¿«æ¢å¤

å¿«é‡ä¼ ç®€æ´è¯´æ˜ï¼šå½“å‘é€å‘æ”¶åˆ°3ä¸ªè¿ç»­é‡å¤ç¡®è®¤ï¼Œå°±å°†ç›¸åº”çš„æŠ¥æ–‡æ®µç«‹å³é‡ä¼ ï¼ˆå›¾ä¸­çš„3ä¸ªç¡®è®¤æŠ¥æ–‡æ®µä¸ºï¼šM4 M5 M6ï¼Œæœ€åç«‹å³é‡ä¼ M3ã€M3ä¸¢å¤±ã€‘ï¼‰

![image-20220622153534786](./images/image-20220622153534786.png)

å¿«æ¢å¤ç®€æ´è¯´æ˜ï¼šå‘é€æ–¹ä¸€æ—¦æ”¶åˆ°3ä¸ªé‡å¤ç¡®è®¤ï¼Œå°±çŸ¥é“ç°åœ¨åªæ˜¯ä¸¢å¤±äº†ä¸ªåˆ«çš„æŠ¥æ–‡æ®µã€‚äºæ˜¯**ä¸å¯åŠ¨æ…¢å¼€å§‹**ç®—æ³•ï¼Œè€Œæ‰§è¡Œå¿«æ¢å¤ç®—æ³•ï¼›å‘é€æ–¹å°†æ…¢å¼€å§‹é—¨é™ssthreshå€¼å’Œæ‹¥å¡çª—å£cwndå€¼è°ƒæ•´ä¸ºå½“å‰çª—å£çš„ä¸€åŠï¼›**å¼€å§‹æ‰§è¡Œæ‹¥å¡é¿å…ç®—æ³•**ã€‚

æ•´ä½“æµç¨‹ï¼š

![image-20220622153028675](./images/image-20220622153028675.png)

##### TCPå¯é ä¼ è¾“

å‘é€æ–¹å¦‚æœå‘é€äº†32~33å·æŠ¥æ–‡æ®µç»™æ¥æ”¶æ–¹

![image-20220622160349594](./images/image-20220622160349594.png)

é‚£ä¹ˆæ¥æ”¶æ–¹ä¼šæ¥æ”¶å®ƒä»¬ï¼Œå­˜å…¥ç¼“å­˜ï¼›å› ä¸º31å·å…ƒç´ è¿˜æ²¡æœ‰åˆ°è¾¾ï¼Œè¿™æ˜¯æœªæŒ‰åºåˆ°è¾¾çš„æ•°æ®

![image-20220622160614260](./images/image-20220622160614260.png)

å‡è®¾31å·æŠ¥æ–‡æ®µåˆ°è¾¾äº†æ¥æ”¶æ–¹ï¼Œå­˜å…¥åˆ°æ¥æ”¶ç¼“å­˜ï¼Œæ¥æ”¶æ–¹æ¥æ”¶äº†ä¹‹åå°±ä¼šæŠŠ31~33å·æ•°æ®äº¤ä»˜ç»™åº”ç”¨è¿›ç¨‹ï¼›æ¥æ”¶æ–¹ä¼šå‘å³æ»‘åŠ¨3ä¸ªçª—å£ï¼Œå¹¶å‘é€ç»™å‘é€å‘ç¡®è®¤æŠ¥æ–‡æ®µ

![image-20220622160757115](./images/image-20220622160757115.png)

å¦‚æœå‘é€æ–¹åˆå‘é€äº†ä¸‰ä¸ªæ•°æ®ï¼ˆ37ã€38ã€40ï¼‰ï¼Œæ¥æ”¶ç«¯æ¥å—äº†ä¹‹åä¼šå‘é€ç¡®è®¤æŠ¥æ–‡æ®µï¼ˆrwnd=20, ack=34ï¼‰ï¼Œé‚£ä¹ˆå‘é€æ–¹çš„çª—å£ä¹Ÿä¼šå‘å³ç§»åŠ¨3ä½

![image-20220622161106757](./images/image-20220622161106757.png)

##### HTTP

HTTP åè®®ï¼Œå…¨ç§°è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆHypertext Transfer Protocolï¼‰ã€‚é¡¾åæ€ä¹‰ï¼ŒHTTP åè®®å°±æ˜¯ç”¨æ¥è§„èŒƒè¶…æ–‡æœ¬çš„ä¼ è¾“ï¼Œè¶…æ–‡æœ¬ï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œä¸Šçš„åŒ…æ‹¬æ–‡æœ¬åœ¨å†…çš„å„å¼å„æ ·çš„æ¶ˆï¼Œå…·ä½“æ¥è¯´ï¼Œä¸»è¦æ˜¯æ¥è§„èŒƒæµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯çš„è¡Œä¸ºçš„ã€‚

å¹¶ä¸”ï¼ŒHTTP æ˜¯ä¸€ä¸ªæ— çŠ¶æ€ï¼ˆstatelessï¼‰åè®®ï¼Œä¹Ÿå°±æ˜¯è¯´æœåŠ¡å™¨ä¸ç»´æŠ¤ä»»ä½•æœ‰å…³å®¢æˆ·ç«¯è¿‡å»æ‰€å‘è¯·æ±‚çš„æ¶ˆæ¯ã€‚è¿™å…¶å®æ˜¯ä¸€ç§æ‡’æ”¿ï¼Œæœ‰çŠ¶æ€åè®®ä¼šæ›´åŠ å¤æ‚ï¼Œéœ€è¦ç»´æŠ¤çŠ¶æ€ï¼ˆå†å²ä¿¡æ¯ï¼‰ï¼Œè€Œä¸”å¦‚æœå®¢æˆ·æˆ–æœåŠ¡å™¨å¤±æ•ˆï¼Œä¼šäº§ç”ŸçŠ¶æ€çš„ä¸ä¸€è‡´ï¼Œè§£å†³è¿™ç§ä¸ä¸€è‡´çš„ä»£ä»·æ›´é«˜ã€‚

###### é€šä¿¡è¿‡ç¨‹

HTTP æ˜¯åº”ç”¨å±‚åè®®ï¼Œå®ƒä»¥ TCPï¼ˆä¼ è¾“å±‚ï¼‰ä½œä¸ºåº•å±‚åè®®ï¼Œé»˜è®¤ç«¯å£ä¸º 80. é€šä¿¡è¿‡ç¨‹ä¸»è¦å¦‚ä¸‹ï¼š

1. æœåŠ¡å™¨åœ¨ 80 ç«¯å£ç­‰å¾…å®¢æˆ·çš„è¯·æ±‚ã€‚
2. æµè§ˆå™¨å‘èµ·åˆ°æœåŠ¡å™¨çš„ TCP è¿æ¥ï¼ˆåˆ›å»ºå¥—æ¥å­— Socketï¼‰ã€‚
3. æœåŠ¡å™¨æ¥æ”¶æ¥è‡ªæµè§ˆå™¨çš„ TCP è¿æ¥ã€‚
4. æµè§ˆå™¨ï¼ˆHTTP å®¢æˆ·ç«¯ï¼‰ä¸ Web æœåŠ¡å™¨ï¼ˆHTTP æœåŠ¡å™¨ï¼‰äº¤æ¢ HTTP æ¶ˆæ¯ã€‚
5. å…³é—­ TCP è¿æ¥ã€‚

##### HTTPS

å› ä¸º HTTPS ç›¸æ¯” HTTP åè®®å¤šä¸€ä¸ª TLS åè®®æ¡æ‰‹è¿‡ç¨‹ï¼Œ**ç›®çš„æ˜¯ä¸ºäº†é€šè¿‡éå¯¹ç§°åŠ å¯†æ¡æ‰‹åå•†æˆ–è€…äº¤æ¢å‡ºå¯¹ç§°åŠ å¯†å¯†é’¥**ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ€é•¿å¯ä»¥èŠ±è´¹æ‰ 2 RTTï¼Œæ¥ç€åç»­ä¼ è¾“çš„åº”ç”¨æ•°æ®éƒ½å¾—ä½¿ç”¨å¯¹ç§°åŠ å¯†å¯†é’¥æ¥åŠ å¯†/è§£å¯†ã€‚

HTTPS åè®®ï¼ˆHyper Text Transfer Protocol Secureï¼‰ï¼Œæ˜¯ HTTP çš„åŠ å¼ºå®‰å…¨ç‰ˆæœ¬ã€‚HTTPS  æ˜¯åŸºäº HTTP çš„ï¼Œä¹Ÿæ˜¯ç”¨ TCP ä½œä¸ºåº•å±‚åè®®ï¼Œå¹¶é¢å¤–ä½¿ç”¨ SSL/TLS åè®®ç”¨ä½œåŠ å¯†å’Œå®‰å…¨è®¤è¯ã€‚é»˜è®¤ç«¯å£å·æ˜¯ 443.

HTTPS åè®®ä¸­ï¼ŒSSL é€šé“é€šå¸¸ä½¿ç”¨åŸºäºå¯†é’¥çš„åŠ å¯†ç®—æ³•ï¼Œå¯†é’¥é•¿åº¦é€šå¸¸æ˜¯ 40 æ¯”ç‰¹æˆ– 128 æ¯”ç‰¹ã€‚

###### SSL/TLS

SSL æŒ‡å®‰å…¨å¥—æ¥å­—åè®®ï¼ˆSecure Sockets Layerï¼‰ï¼Œé¦–æ¬¡å‘å¸ƒä¸ 1996 å¹´ã€‚SSL çš„é¦–æ¬¡å‘å¸ƒå…¶å®å·²ç»æ˜¯ä»–çš„ 3.0  ç‰ˆæœ¬ï¼ŒSSL 1.0 ä»æœªé¢ä¸–ï¼ŒSSL 2.0 åˆ™å…·æœ‰è¾ƒå¤§çš„ç¼ºé™·ï¼ˆDROWN ç¼ºé™·â€”â€”Decrypting RSA with Obsolete  and Weakened eNcryptionï¼‰ã€‚å¾ˆå¿«ï¼Œåœ¨ 1999 å¹´ï¼ŒSSL 3.0 è¿›ä¸€æ­¥å‡çº§ï¼Œ**æ–°ç‰ˆæœ¬è¢«å‘½åä¸º TLS 1.0**ã€‚å› æ­¤ï¼ŒTLS æ˜¯åŸºäº SSL ä¹‹ä¸Šçš„ï¼Œä½†ç”±äºä¹ æƒ¯å«æ³•ï¼Œé€šå¸¸æŠŠ HTTPS ä¸­çš„æ ¸å¿ƒåŠ å¯†åè®®æ··æˆä¸º SSL/TLSã€‚

###### éå¯¹ç§°åŠ å¯†

SSL/TLS çš„æ ¸å¿ƒè¦ç´ æ˜¯**éå¯¹ç§°åŠ å¯†**ã€‚éå¯¹ç§°åŠ å¯†é‡‡ç”¨ä¸¤ä¸ªå¯†é’¥â€”â€”ä¸€ä¸ªå…¬é’¥ï¼Œä¸€ä¸ªç§é’¥ã€‚åœ¨é€šä¿¡æ—¶ï¼Œç§é’¥ä»…ç”±è§£å¯†è€…ä¿å­˜ï¼Œå…¬é’¥ç”±ä»»ä½•ä¸€ä¸ªæƒ³ä¸è§£å¯†è€…é€šä¿¡çš„å‘é€è€…ï¼ˆåŠ å¯†è€…ï¼‰æ‰€çŸ¥ã€‚å¯ä»¥è®¾æƒ³ä¸€ä¸ªåœºæ™¯ï¼Œ

> åœ¨æŸä¸ªè‡ªåŠ©é‚®å±€ï¼Œæ¯ä¸ªé€šä¿¡ä¿¡é“éƒ½æ˜¯ä¸€ä¸ªé‚®ç®±ï¼Œæ¯ä¸€ä¸ªé‚®ç®±æ‰€æœ‰è€…éƒ½åœ¨æ—è¾¹ç«‹äº†ä¸€ä¸ªç‰Œå­ï¼Œä¸Šé¢æŒ‚ç€ä¸€æŠŠé’¥åŒ™ï¼šè¿™æ˜¯æˆ‘çš„å…¬é’¥ï¼Œå‘é€è€…è¯·å°†ä¿¡ä»¶æ”¾å…¥æˆ‘çš„é‚®ç®±ï¼Œå¹¶ç”¨å…¬é’¥é”å¥½ã€‚
>
> ä½†æ˜¯å…¬é’¥åªèƒ½åŠ é”ï¼Œå¹¶ä¸èƒ½è§£é”ã€‚è§£é”åªèƒ½ç”±é‚®ç®±çš„æ‰€æœ‰è€…â€”â€”å› ä¸ºåªæœ‰ä»–ä¿å­˜ç€ç§é’¥ã€‚
>
> è¿™æ ·ï¼Œé€šä¿¡ä¿¡æ¯å°±ä¸ä¼šè¢«å…¶ä»–äººæˆªè·äº†ï¼Œè¿™ä¾èµ–äºç§é’¥çš„ä¿å¯†æ€§ã€‚

![image-20220622195056508](./images/image-20220622195056508.png)

éå¯¹ç§°åŠ å¯†çš„å…¬é’¥å’Œç§é’¥éœ€è¦é‡‡ç”¨ä¸€ç§å¤æ‚çš„æ•°å­¦æœºåˆ¶ç”Ÿæˆï¼ˆå¯†ç å­¦è®¤ä¸ºï¼Œä¸ºäº†è¾ƒé«˜çš„å®‰å…¨æ€§ï¼Œå°½é‡ä¸è¦è‡ªå·±åˆ›é€ åŠ å¯†æ–¹æ¡ˆï¼‰ã€‚å…¬ç§é’¥å¯¹çš„ç”Ÿæˆç®—æ³•ä¾èµ–äºå•å‘é™·é—¨å‡½æ•°ã€‚

> å•å‘å‡½æ•°ï¼šå·²çŸ¥å•å‘å‡½æ•° fï¼Œç»™å®šä»»æ„ä¸€ä¸ªè¾“å…¥ xï¼Œæ˜“è®¡ç®—è¾“å‡º y=f(x)ï¼›è€Œç»™å®šä¸€ä¸ªè¾“å‡º yï¼Œå‡è®¾å­˜åœ¨ f(x)=yï¼Œå¾ˆéš¾æ ¹æ® f æ¥è®¡ç®—å‡º xã€‚
>
> å•å‘é™·é—¨å‡½æ•°ï¼šä¸€ä¸ªè¾ƒå¼±çš„å•å‘å‡½æ•°ã€‚å·²çŸ¥å•å‘é™·é—¨å‡½æ•° fï¼Œé™·é—¨ hï¼Œç»™å®šä»»æ„ä¸€ä¸ªè¾“å…¥ xï¼Œæ˜“è®¡ç®—å‡ºè¾“å‡º y=f(x;h)ï¼›è€Œç»™å®šä¸€ä¸ªè¾“å‡º yï¼Œå‡è®¾å­˜åœ¨ f(x;h)=yï¼Œå¾ˆéš¾æ ¹æ® f æ¥è®¡ç®—å‡º xï¼Œä½†å¯ä»¥æ ¹æ® f å’Œ h æ¥æ¨å¯¼å‡º xã€‚

![image-20220622195100965](./images/image-20220622195100965.png)

ä¸Šå›¾å°±æ˜¯ä¸€ä¸ªå•å‘å‡½æ•°ï¼ˆä¸æ˜¯å•é¡¹é™·é—¨å‡½æ•°ï¼‰ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç»ä¸–ç§˜ç±ï¼Œä»»ä½•çŸ¥é“äº†è¿™ä¸ªç§˜ç±çš„äººéƒ½å¯ä»¥æŠŠè‹¹æœæ±æ¦¨æˆè‹¹æœï¼Œé‚£ä¹ˆè¿™ä¸ªç§˜ç±å°±æ˜¯â€œé™·é—¨â€äº†å§ã€‚

åœ¨è¿™é‡Œï¼Œå‡½æ•° f çš„è®¡ç®—æ–¹æ³•ç›¸å½“äºå…¬é’¥ï¼Œé™·é—¨ h ç›¸å½“äºç§é’¥ã€‚å…¬é’¥ f æ˜¯å…¬å¼€çš„ï¼Œä»»ä½•äººå¯¹å·²æœ‰è¾“å…¥ï¼Œéƒ½å¯ä»¥ç”¨ f åŠ å¯†ï¼Œè€Œè¦æƒ³æ ¹æ®åŠ å¯†ä¿¡æ¯è¿˜åŸå‡ºåŸä¿¡æ¯ï¼Œå¿…é¡»è¦æœ‰ç§é’¥æ‰è¡Œã€‚

###### å¯¹ç§°åŠ å¯†

ä½¿ç”¨ SSL/TLS è¿›è¡Œé€šä¿¡çš„åŒæ–¹éœ€è¦ä½¿ç”¨éå¯¹ç§°åŠ å¯†æ–¹æ¡ˆæ¥é€šä¿¡ï¼Œä½†æ˜¯éå¯¹ç§°åŠ å¯†è®¾è®¡äº†è¾ƒä¸ºå¤æ‚çš„æ•°å­¦ç®—æ³•ï¼Œåœ¨å®é™…é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œè®¡ç®—çš„ä»£ä»·è¾ƒé«˜ï¼Œæ•ˆç‡å¤ªä½ï¼Œå› æ­¤ï¼ŒSSL/TLS å®é™…å¯¹æ¶ˆæ¯çš„åŠ å¯†ä½¿ç”¨çš„æ˜¯å¯¹ç§°åŠ å¯†ã€‚

> å¯¹ç§°åŠ å¯†ï¼šé€šä¿¡åŒæ–¹å…±äº«å”¯ä¸€å¯†é’¥ kï¼ŒåŠ è§£å¯†ç®—æ³•å·²çŸ¥ï¼ŒåŠ å¯†æ–¹åˆ©ç”¨å¯†é’¥ k åŠ å¯†ï¼Œè§£å¯†æ–¹åˆ©ç”¨å¯†é’¥ k è§£å¯†ï¼Œä¿å¯†æ€§ä¾èµ–äºå¯†é’¥ k çš„ä¿å¯†æ€§ã€‚

![image-20220622195120635](./images/image-20220622195120635.png)

å¯¹ç§°åŠ å¯†çš„å¯†é’¥ç”Ÿæˆä»£ä»·æ¯”å…¬ç§é’¥å¯¹çš„ç”Ÿæˆä»£ä»·ä½å¾—å¤šï¼Œé‚£ä¹ˆæœ‰çš„äººä¼šé—®äº†ï¼Œä¸ºä»€ä¹ˆ SSL/TLS  è¿˜éœ€è¦ä½¿ç”¨éå¯¹ç§°åŠ å¯†å‘¢ï¼Ÿå› ä¸ºå¯¹ç§°åŠ å¯†çš„ä¿å¯†æ€§å®Œå…¨ä¾èµ–äºå¯†é’¥çš„ä¿å¯†æ€§ã€‚åœ¨åŒæ–¹é€šä¿¡ä¹‹å‰ï¼Œéœ€è¦å•†é‡ä¸€ä¸ªç”¨äºå¯¹ç§°åŠ å¯†çš„å¯†é’¥ã€‚æˆ‘ä»¬çŸ¥é“ç½‘ç»œé€šä¿¡çš„ä¿¡é“æ˜¯ä¸å®‰å…¨çš„ï¼Œä¼ è¾“æŠ¥æ–‡å¯¹ä»»ä½•äººæ˜¯å¯è§çš„ï¼Œå¯†é’¥çš„äº¤æ¢è‚¯å®šä¸èƒ½ç›´æ¥åœ¨ç½‘ç»œä¿¡é“ä¸­ä¼ è¾“ã€‚å› æ­¤ï¼Œä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼Œå¯¹å¯¹ç§°åŠ å¯†çš„å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œä¿æŠ¤è¯¥å¯†é’¥ä¸åœ¨ç½‘ç»œä¿¡é“ä¸­è¢«çªƒå¬ã€‚è¿™æ ·ï¼Œé€šä¿¡åŒæ–¹åªéœ€è¦ä¸€æ¬¡éå¯¹ç§°åŠ å¯†ï¼Œäº¤æ¢å¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œåœ¨ä¹‹åçš„ä¿¡æ¯é€šä¿¡ä¸­ï¼Œä½¿ç”¨ç»å¯¹å®‰å…¨çš„å¯†é’¥ï¼Œå¯¹ä¿¡æ¯è¿›è¡Œå¯¹ç§°åŠ å¯†ï¼Œå³å¯ä¿è¯ä¼ è¾“æ¶ˆæ¯çš„ä¿å¯†æ€§ã€‚

###### æ•°å­—ç­¾å

å¥½ï¼Œåˆ°è¿™ä¸€å°èŠ‚ï¼Œå·²ç»æ˜¯ SSL/TLS çš„å°¾å£°äº†ã€‚ä¸Šä¸€å°èŠ‚æåˆ°äº†æ•°å­—ç­¾åï¼Œæ•°å­—ç­¾åè¦è§£å†³çš„é—®é¢˜ï¼Œæ˜¯é˜²æ­¢è¯ä¹¦è¢«ä¼ªé€ ã€‚ç¬¬ä¸‰æ–¹ä¿¡èµ–æœºæ„ CA ä¹‹æ‰€ä»¥èƒ½è¢«ä¿¡èµ–ï¼Œå°±æ˜¯ **é æ•°å­—ç­¾åæŠ€æœ¯** ã€‚

æ•°å­—ç­¾åï¼Œæ˜¯ CA åœ¨ç»™æœåŠ¡å™¨é¢å‘è¯ä¹¦æ—¶ï¼Œä½¿ç”¨æ•£åˆ—+åŠ å¯†çš„ç»„åˆæŠ€æœ¯ï¼Œåœ¨è¯ä¹¦ä¸Šç›–ä¸ªç« ï¼Œä»¥æ­¤æ¥æä¾›éªŒä¼ªçš„åŠŸèƒ½ã€‚å…·ä½“è¡Œä¸ºå¦‚ä¸‹ï¼š

> CA çŸ¥é“æœåŠ¡å™¨çš„å…¬é’¥ï¼Œå¯¹è¯¥å…¬é’¥é‡‡ç”¨æ•£åˆ—æŠ€æœ¯ç”Ÿæˆä¸€ä¸ªæ‘˜è¦ã€‚CA ä½¿ç”¨ CA ç§é’¥å¯¹è¯¥æ‘˜è¦è¿›è¡ŒåŠ å¯†ï¼Œå¹¶é™„åœ¨è¯ä¹¦ä¸‹æ–¹ï¼Œå‘é€ç»™æœåŠ¡å™¨ã€‚
>
> ç°åœ¨æœåŠ¡å™¨å°†è¯¥è¯ä¹¦å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯éœ€è¦éªŒè¯è¯¥è¯ä¹¦çš„èº«ä»½ã€‚å®¢æˆ·ç«¯æ‰¾åˆ°ç¬¬ä¸‰æ–¹æœºæ„ CAï¼Œè·çŸ¥ CA çš„å…¬é’¥ï¼Œå¹¶ç”¨ CA å…¬é’¥å¯¹è¯ä¹¦çš„ç­¾åè¿›è¡Œè§£å¯†ï¼Œè·å¾—äº† CA ç”Ÿæˆçš„æ‘˜è¦ã€‚
>
> å®¢æˆ·ç«¯å¯¹è¯ä¹¦æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯æœåŠ¡å™¨çš„å…¬é’¥ï¼‰åšç›¸åŒçš„æ•£åˆ—å¤„ç†ï¼Œå¾—åˆ°æ‘˜è¦ï¼Œå¹¶å°†è¯¥æ‘˜è¦ä¸ä¹‹å‰ä»ç­¾åä¸­è§£ç å‡ºçš„æ‘˜è¦åšå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒï¼Œåˆ™èº«ä»½éªŒè¯æˆåŠŸï¼›å¦åˆ™éªŒè¯å¤±è´¥ã€‚

![image-20220622195206707](./images/image-20220622195206707.png)

æ€»ç»“æ¥è¯´ï¼Œå¸¦æœ‰è¯ä¹¦çš„å…¬é’¥ä¼ è¾“æœºåˆ¶å¦‚ä¸‹ï¼š

1. è®¾æœ‰æœåŠ¡å™¨ Sï¼Œå®¢æˆ·ç«¯ Cï¼Œå’Œç¬¬ä¸‰æ–¹ä¿¡èµ–æœºæ„ CAã€‚
2. S ä¿¡ä»» CAï¼ŒCA æ˜¯çŸ¥é“ S å…¬é’¥çš„ï¼ŒCA å‘ S é¢å‘è¯ä¹¦ã€‚å¹¶é™„ä¸Š CA ç§é’¥å¯¹æ¶ˆæ¯æ‘˜è¦çš„åŠ å¯†ç­¾åã€‚
3. S è·å¾— CA é¢å‘çš„è¯ä¹¦ï¼Œå°†è¯¥è¯ä¹¦ä¼ é€’ç»™ Cã€‚
4. C è·å¾— S çš„è¯ä¹¦ï¼Œä¿¡ä»» CA å¹¶çŸ¥æ™“ CA å…¬é’¥ï¼Œä½¿ç”¨ CA å…¬é’¥å¯¹ S è¯ä¹¦ä¸Šçš„ç­¾åè§£å¯†ï¼ŒåŒæ—¶å¯¹æ¶ˆæ¯è¿›è¡Œæ•£åˆ—å¤„ç†ï¼Œå¾—åˆ°æ‘˜è¦ã€‚æ¯”è¾ƒæ‘˜è¦ï¼ŒéªŒè¯ S è¯ä¹¦çš„çœŸå®æ€§ã€‚
5. å¦‚æœ C éªŒè¯ S è¯ä¹¦æ˜¯çœŸå®çš„ï¼Œåˆ™ä¿¡ä»» S çš„å…¬é’¥ï¼ˆåœ¨ S è¯ä¹¦ä¸­ï¼‰ã€‚

![image-20220622195221158](./images/image-20220622195221158.png)

> [æ•°å­—ç­¾å åŠ æ•°å­—è¯ä¹¦ åŸç†](https://www.bilibili.com/video/BV18N411X7ty/)
>
> è¡¥å……ï¼šéƒ¨åˆ†å†…å®¹èŠ‚é€‰è‡ªã€Šå›¾è§£HTTPã€‹
>
> å…¬å¼€å¯†é’¥åŠ å¯†ä½¿ç”¨ä¸€å¯¹éå¯¹ç§°çš„å¯†é’¥ã€‚ä¸€æŠŠå«åšç§æœ‰å¯†é’¥ï¼ˆprivatekeyï¼‰ï¼Œå¦ä¸€æŠŠå«åšå…¬å¼€å¯†é’¥ï¼ˆpublic keyï¼‰ã€‚é¡¾åæ€ä¹‰ï¼Œç§æœ‰å¯†é’¥ä¸èƒ½è®©å…¶ä»–ä»»ä½•äººçŸ¥é“ï¼Œè€Œå…¬å¼€å¯†é’¥åˆ™å¯ä»¥éšæ„å‘å¸ƒï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å¾—ã€‚
>
> ä½¿ç”¨å…¬å¼€å¯†é’¥åŠ å¯†æ–¹å¼ï¼Œå‘é€å¯†æ–‡çš„ä¸€æ–¹ä½¿ç”¨å¯¹æ–¹çš„å…¬å¼€å¯†é’¥è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œå¯¹æ–¹æ”¶åˆ°è¢«åŠ å¯†çš„ä¿¡æ¯åï¼Œå†ä½¿ç”¨è‡ªå·±çš„ç§æœ‰å¯†é’¥è¿›è¡Œè§£å¯†ã€‚åˆ©ç”¨è¿™ç§æ–¹å¼ï¼Œä¸éœ€è¦å‘é€ç”¨æ¥è§£å¯†çš„ç§æœ‰å¯†é’¥ï¼Œä¹Ÿä¸å¿…æ‹…å¿ƒå¯†é’¥è¢«æ”»å‡»è€…çªƒå¬è€Œç›—èµ°ã€‚
>
> ![image-20220725121250347](images/image-20220725121250347.png)
>
> ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ç”±**æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ï¼ˆCAï¼ŒCertificateAuthorityï¼‰**å’Œå…¶ç›¸å…³æœºå…³é¢å‘çš„å…¬å¼€å¯†é’¥è¯ä¹¦ã€‚æ•°å­—è¯ä¹¦è®¤è¯æœºæ„å¤„äºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åŒæ–¹éƒ½å¯ä¿¡èµ–çš„ç¬¬ä¸‰æ–¹æœºæ„çš„ç«‹åœºä¸Šã€‚å¨ç‘ä¿¡ï¼ˆVeriSignï¼‰å°±æ˜¯å…¶ä¸­ä¸€å®¶éå¸¸æœ‰åçš„æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ã€‚æ•°å­—è¯ä¹¦è®¤è¯æœºæ„åœ¨åˆ¤æ˜æå‡ºç”³è¯·è€…çš„èº«ä»½ä¹‹åï¼Œä¼šå¯¹å·²ç”³è¯·çš„å…¬å¼€å¯†é’¥åšæ•°å­—ç­¾åï¼Œç„¶ååˆ†é…è¿™ä¸ªå·²ç­¾åçš„å…¬å¼€å¯†é’¥ï¼Œå¹¶å°†è¯¥å…¬å¼€å¯†é’¥æ”¾å…¥å…¬é’¥è¯ä¹¦åç»‘å®šåœ¨ä¸€èµ·ã€‚æœåŠ¡å™¨ä¼šå°†è¿™ä»½ç”±æ•°å­—è¯ä¹¦è®¤è¯æœºæ„é¢å‘çš„å…¬é’¥è¯ä¹¦å‘é€ç»™å®¢æˆ·ç«¯ï¼Œä»¥è¿›è¡Œå…¬å¼€å¯†é’¥åŠ å¯†æ–¹å¼é€šä¿¡ã€‚å…¬é’¥è¯ä¹¦ä¹Ÿå¯å«åšæ•°å­—è¯ä¹¦æˆ–ç›´æ¥ç§°ä¸ºè¯ä¹¦ã€‚æ¥åˆ°è¯ä¹¦çš„å®¢æˆ·ç«¯å¯ä½¿ç”¨æ•°å­—è¯ä¹¦è®¤è¯æœºæ„çš„å…¬å¼€å¯†é’¥ï¼Œå¯¹é‚£å¼ è¯ä¹¦ä¸Šçš„æ•°å­—ç­¾åè¿›è¡ŒéªŒè¯ï¼Œä¸€æ—¦éªŒè¯é€šè¿‡ï¼Œå®¢æˆ·ç«¯ä¾¿å¯æ˜ç¡®ä¸¤ä»¶äº‹ï¼š
>
> 1. è®¤è¯æœåŠ¡å™¨çš„å…¬å¼€å¯†é’¥çš„æ˜¯çœŸå®æœ‰æ•ˆçš„æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ã€‚
> 2. æœåŠ¡å™¨çš„å…¬å¼€å¯†é’¥æ˜¯å€¼å¾—ä¿¡èµ–çš„ã€‚
>
> ![image-20220725121905030](images/image-20220725121905030.png)

##### ARQ åè®®

**è‡ªåŠ¨é‡ä¼ è¯·æ±‚**ï¼ˆAutomatic Repeat-reQuestï¼ŒARQï¼‰æ˜¯ OSI æ¨¡å‹ä¸­æ•°æ®é“¾è·¯å±‚å’Œä¼ è¾“å±‚çš„é”™è¯¯çº æ­£åè®®ä¹‹ä¸€ã€‚å®ƒé€šè¿‡ä½¿ç”¨ç¡®è®¤å’Œè¶…æ—¶è¿™ä¸¤ä¸ªæœºåˆ¶ï¼Œåœ¨ä¸å¯é æœåŠ¡çš„åŸºç¡€ä¸Šå®ç°å¯é çš„ä¿¡æ¯ä¼ è¾“ã€‚å¦‚æœå‘é€æ–¹åœ¨å‘é€åä¸€æ®µæ—¶é—´ä¹‹å†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤å¸§ï¼Œå®ƒé€šå¸¸ä¼šé‡æ–°å‘é€ã€‚ARQ åŒ…æ‹¬åœæ­¢ç­‰å¾… ARQ åè®®å’Œè¿ç»­ ARQ åè®®ã€‚

###### åœæ­¢ç­‰å¾… ARQ åè®®

åœæ­¢ç­‰å¾…åè®®æ˜¯ä¸ºäº†å®ç°å¯é ä¼ è¾“çš„ï¼Œå®ƒçš„åŸºæœ¬åŸç†å°±æ˜¯æ¯å‘å®Œä¸€ä¸ªåˆ†ç»„å°±åœæ­¢å‘é€ï¼Œç­‰å¾…å¯¹æ–¹ç¡®è®¤ï¼ˆå›å¤ ACKï¼‰ã€‚å¦‚æœè¿‡äº†ä¸€æ®µæ—¶é—´ï¼ˆè¶…æ—¶æ—¶é—´åï¼‰ï¼Œè¿˜æ˜¯æ²¡æœ‰æ”¶åˆ° ACK ç¡®è®¤ï¼Œè¯´æ˜æ²¡æœ‰å‘é€æˆåŠŸï¼Œéœ€è¦é‡æ–°å‘é€ï¼Œç›´åˆ°æ”¶åˆ°ç¡®è®¤åå†å‘ä¸‹ä¸€ä¸ªåˆ†ç»„ã€‚

åœ¨åœæ­¢ç­‰å¾…åè®®ä¸­ï¼Œè‹¥æ¥æ”¶æ–¹æ”¶åˆ°é‡å¤åˆ†ç»„ï¼Œå°±ä¸¢å¼ƒè¯¥åˆ†ç»„ï¼Œä½†åŒæ—¶è¿˜è¦å‘é€ç¡®è®¤ã€‚

**ä¼˜ç¼ºç‚¹ï¼š**

- **ä¼˜ç‚¹ï¼š** ç®€å•
- **ç¼ºç‚¹ï¼š** ä¿¡é“åˆ©ç”¨ç‡ä½ï¼Œç­‰å¾…æ—¶é—´é•¿

**1) æ— å·®é”™æƒ…å†µ:**

å‘é€æ–¹å‘é€åˆ†ç»„, æ¥æ”¶æ–¹åœ¨è§„å®šæ—¶é—´å†…æ”¶åˆ°, å¹¶ä¸”å›å¤ç¡®è®¤. å‘é€æ–¹å†æ¬¡å‘é€ã€‚

**2) å‡ºç°å·®é”™æƒ…å†µï¼ˆè¶…æ—¶é‡ä¼ ï¼‰:**

åœæ­¢ç­‰å¾…åè®®ä¸­è¶…æ—¶é‡ä¼ æ˜¯æŒ‡åªè¦è¶…è¿‡ä¸€æ®µæ—¶é—´ä»ç„¶æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œå°±é‡ä¼ å‰é¢å‘é€è¿‡çš„åˆ†ç»„ï¼ˆè®¤ä¸ºåˆšæ‰å‘é€è¿‡çš„åˆ†ç»„ä¸¢å¤±äº†ï¼‰ã€‚å› æ­¤æ¯å‘é€å®Œä¸€ä¸ªåˆ†ç»„éœ€è¦è®¾ç½®ä¸€ä¸ªè¶…æ—¶è®¡æ—¶å™¨ï¼Œå…¶é‡ä¼ æ—¶é—´åº”æ¯”æ•°æ®åœ¨åˆ†ç»„ä¼ è¾“çš„å¹³å‡å¾€è¿”æ—¶é—´æ›´é•¿ä¸€äº›ã€‚è¿™ç§è‡ªåŠ¨é‡ä¼ æ–¹å¼å¸¸ç§°ä¸º **è‡ªåŠ¨é‡ä¼ è¯·æ±‚ ARQ** ã€‚å¦å¤–åœ¨åœæ­¢ç­‰å¾…åè®®ä¸­è‹¥æ”¶åˆ°é‡å¤åˆ†ç»„ï¼Œå°±ä¸¢å¼ƒè¯¥åˆ†ç»„ï¼Œä½†åŒæ—¶è¿˜è¦å‘é€ç¡®è®¤ã€‚**è¿ç»­ ARQ åè®®** å¯æé«˜ä¿¡é“åˆ©ç”¨ç‡ã€‚å‘é€ç»´æŒä¸€ä¸ªå‘é€çª—å£ï¼Œå‡¡ä½äºå‘é€çª—å£å†…çš„åˆ†ç»„å¯è¿ç»­å‘é€å‡ºå»ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å¯¹æ–¹ç¡®è®¤ã€‚æ¥æ”¶æ–¹ä¸€èˆ¬é‡‡ç”¨ç´¯ç§¯ç¡®è®¤ï¼Œå¯¹æŒ‰åºåˆ°è¾¾çš„æœ€åä¸€ä¸ªåˆ†ç»„å‘é€ç¡®è®¤ï¼Œè¡¨æ˜åˆ°è¿™ä¸ªåˆ†ç»„ä½ç½®çš„æ‰€æœ‰åˆ†ç»„éƒ½å·²ç»æ­£ç¡®æ”¶åˆ°äº†ã€‚

**3) ç¡®è®¤ä¸¢å¤±å’Œç¡®è®¤è¿Ÿåˆ°**

- **ç¡®è®¤ä¸¢å¤±** ï¼šç¡®è®¤æ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸¢å¤±ã€‚å½“ A å‘é€ M1 æ¶ˆæ¯ï¼ŒB æ”¶åˆ°åï¼ŒB å‘ A å‘é€äº†ä¸€ä¸ª M1 ç¡®è®¤æ¶ˆæ¯ï¼Œä½†å´åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±ã€‚è€Œ A å¹¶ä¸çŸ¥é“ï¼Œåœ¨è¶…æ—¶è®¡æ—¶è¿‡åï¼ŒA é‡ä¼  M1 æ¶ˆæ¯ï¼ŒB å†æ¬¡æ”¶åˆ°è¯¥æ¶ˆæ¯åé‡‡å–ä»¥ä¸‹ä¸¤ç‚¹æªæ–½ï¼š1. ä¸¢å¼ƒè¿™ä¸ªé‡å¤çš„ M1 æ¶ˆæ¯ï¼Œä¸å‘ä¸Šå±‚äº¤ä»˜ã€‚ 2. å‘ A å‘é€ç¡®è®¤æ¶ˆæ¯ã€‚ï¼ˆä¸ä¼šè®¤ä¸ºå·²ç»å‘é€è¿‡äº†ï¼Œå°±ä¸å†å‘é€ã€‚A èƒ½é‡ä¼ ï¼Œå°±è¯æ˜ B çš„ç¡®è®¤æ¶ˆæ¯ä¸¢å¤±ï¼‰ã€‚
- **ç¡®è®¤è¿Ÿåˆ°** ï¼šç¡®è®¤æ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¿Ÿåˆ°ã€‚A å‘é€ M1 æ¶ˆæ¯ï¼ŒB æ”¶åˆ°å¹¶å‘é€ç¡®è®¤ã€‚åœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤æ¶ˆæ¯ï¼ŒA é‡ä¼  M1 æ¶ˆæ¯ï¼ŒB ä»ç„¶æ”¶åˆ°å¹¶ç»§ç»­å‘é€ç¡®è®¤æ¶ˆæ¯ï¼ˆB æ”¶åˆ°äº† 2 ä»½ M1ï¼‰ã€‚æ­¤æ—¶ A æ”¶åˆ°äº† B ç¬¬äºŒæ¬¡å‘é€çš„ç¡®è®¤æ¶ˆæ¯ã€‚æ¥ç€å‘é€å…¶ä»–æ•°æ®ã€‚è¿‡äº†ä¸€ä¼šï¼ŒA æ”¶åˆ°äº† B ç¬¬ä¸€æ¬¡å‘é€çš„å¯¹ M1 çš„ç¡®è®¤æ¶ˆæ¯ï¼ˆA ä¹Ÿæ”¶åˆ°äº† 2 ä»½ç¡®è®¤æ¶ˆæ¯ï¼‰ã€‚å¤„ç†å¦‚ä¸‹ï¼š1. A æ”¶åˆ°é‡å¤çš„ç¡®è®¤åï¼Œç›´æ¥ä¸¢å¼ƒã€‚2. B æ”¶åˆ°é‡å¤çš„ M1 åï¼Œä¹Ÿç›´æ¥ä¸¢å¼ƒé‡å¤çš„ M1ã€‚

**è¿ç»­ ARQ åè®®**

è¿ç»­ ARQ åè®®å¯æé«˜ä¿¡é“åˆ©ç”¨ç‡ã€‚å‘é€æ–¹ç»´æŒä¸€ä¸ªå‘é€çª—å£ï¼Œå‡¡ä½äºå‘é€çª—å£å†…çš„åˆ†ç»„å¯ä»¥è¿ç»­å‘é€å‡ºå»ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å¯¹æ–¹ç¡®è®¤ã€‚æ¥æ”¶æ–¹ä¸€èˆ¬é‡‡ç”¨ç´¯è®¡ç¡®è®¤ï¼Œå¯¹æŒ‰åºåˆ°è¾¾çš„æœ€åä¸€ä¸ªåˆ†ç»„å‘é€ç¡®è®¤ï¼Œè¡¨æ˜åˆ°è¿™ä¸ªåˆ†ç»„ä¸ºæ­¢çš„æ‰€æœ‰åˆ†ç»„éƒ½å·²ç»æ­£ç¡®æ”¶åˆ°äº†ã€‚



##### æ»‘åŠ¨çª—å£

> å¼•å…¥çª—å£æ¦‚å¿µçš„åŸå› 

æˆ‘ä»¬éƒ½çŸ¥é“ TCP æ˜¯æ¯å‘é€ä¸€ä¸ªæ•°æ®ï¼Œéƒ½è¦è¿›è¡Œä¸€æ¬¡ç¡®è®¤åº”ç­”ã€‚å½“ä¸Šä¸€ä¸ªæ•°æ®åŒ…æ”¶åˆ°äº†åº”ç­”äº†ï¼Œ å†å‘é€ä¸‹ä¸€ä¸ªã€‚

è¿™ä¸ªæ¨¡å¼å°±æœ‰ç‚¹åƒæˆ‘å’Œä½ é¢å¯¹é¢èŠå¤©ï¼Œä½ ä¸€å¥æˆ‘ä¸€å¥ã€‚ä½†è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯æ•ˆç‡æ¯”è¾ƒä½çš„ã€‚

å¦‚æœä½ è¯´å®Œä¸€å¥è¯ï¼Œæˆ‘åœ¨å¤„ç†å…¶ä»–äº‹æƒ…ï¼Œæ²¡æœ‰åŠæ—¶å›å¤ä½ ï¼Œé‚£ä½ ä¸æ˜¯è¦å¹²ç­‰ç€æˆ‘åšå®Œå…¶ä»–äº‹æƒ…åï¼Œæˆ‘å›å¤ä½ ï¼Œä½ æ‰èƒ½è¯´ä¸‹ä¸€å¥è¯ï¼Œå¾ˆæ˜¾ç„¶è¿™ä¸ç°å®ã€‚

![æŒ‰æ•°æ®åŒ…è¿›è¡Œç¡®è®¤åº”ç­”](./images/14.jpg)

æ‰€ä»¥ï¼Œè¿™æ ·çš„ä¼ è¾“æ–¹å¼æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼šæ•°æ®åŒ…çš„**å¾€è¿”æ—¶é—´è¶Šé•¿ï¼Œé€šä¿¡çš„æ•ˆç‡å°±è¶Šä½**ã€‚

ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTCP å¼•å…¥äº†**çª—å£**è¿™ä¸ªæ¦‚å¿µã€‚å³ä½¿åœ¨å¾€è¿”æ—¶é—´è¾ƒé•¿çš„æƒ…å†µä¸‹ï¼Œå®ƒä¹Ÿä¸ä¼šé™ä½ç½‘ç»œé€šä¿¡çš„æ•ˆç‡ã€‚

é‚£ä¹ˆæœ‰äº†çª—å£ï¼Œå°±å¯ä»¥æŒ‡å®šçª—å£å¤§å°ï¼Œçª—å£å¤§å°å°±æ˜¯æŒ‡**æ— éœ€ç­‰å¾…ç¡®è®¤åº”ç­”ï¼Œè€Œå¯ä»¥ç»§ç»­å‘é€æ•°æ®çš„æœ€å¤§å€¼**ã€‚

çª—å£çš„å®ç°å®é™…ä¸Šæ˜¯æ“ä½œç³»ç»Ÿå¼€è¾Ÿçš„ä¸€ä¸ªç¼“å­˜ç©ºé—´ï¼Œå‘é€æ–¹ä¸»æœºåœ¨ç­‰åˆ°ç¡®è®¤åº”ç­”è¿”å›ä¹‹å‰ï¼Œå¿…é¡»åœ¨ç¼“å†²åŒºä¸­ä¿ç•™å·²å‘é€çš„æ•°æ®ã€‚å¦‚æœæŒ‰æœŸæ”¶åˆ°ç¡®è®¤åº”ç­”ï¼Œæ­¤æ—¶æ•°æ®å°±å¯ä»¥ä»ç¼“å­˜åŒºæ¸…é™¤ã€‚

å‡è®¾çª—å£å¤§å°ä¸º `3` ä¸ª TCP æ®µï¼Œé‚£ä¹ˆå‘é€æ–¹å°±å¯ä»¥ã€Œè¿ç»­å‘é€ã€ `3` ä¸ª TCP æ®µï¼Œå¹¶ä¸”ä¸­é€”è‹¥æœ‰ ACK ä¸¢å¤±ï¼Œå¯ä»¥é€šè¿‡ã€Œä¸‹ä¸€ä¸ªç¡®è®¤åº”ç­”è¿›è¡Œç¡®è®¤ã€ã€‚å¦‚ä¸‹å›¾ï¼š

![ç”¨æ»‘åŠ¨çª—å£æ–¹å¼å¹¶è¡Œå¤„ç†](./images/15.jpg)

å›¾ä¸­çš„ ACK 600 ç¡®è®¤åº”ç­”æŠ¥æ–‡ä¸¢å¤±ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡ä¸‹ä¸€ä¸ªç¡®è®¤åº”ç­”è¿›è¡Œç¡®è®¤ï¼Œåªè¦å‘é€æ–¹æ”¶åˆ°äº† ACK 700 ç¡®è®¤åº”ç­”ï¼Œå°±æ„å‘³ç€ 700 ä¹‹å‰çš„æ‰€æœ‰æ•°æ®ã€Œæ¥æ”¶æ–¹ã€éƒ½æ”¶åˆ°äº†ã€‚è¿™ä¸ªæ¨¡å¼å°±å«**ç´¯è®¡ç¡®è®¤**æˆ–è€…**ç´¯è®¡åº”ç­”**ã€‚

> çª—å£å¤§å°ç”±å“ªä¸€æ–¹å†³å®šï¼Ÿ

TCP å¤´é‡Œæœ‰ä¸€ä¸ªå­—æ®µå« `Window`ï¼Œä¹Ÿå°±æ˜¯çª—å£å¤§å°ã€‚

**è¿™ä¸ªå­—æ®µæ˜¯æ¥æ”¶ç«¯å‘Šè¯‰å‘é€ç«¯è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥æ¥æ”¶æ•°æ®ã€‚äºæ˜¯å‘é€ç«¯å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›æ¥å‘é€æ•°æ®ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¥æ”¶ç«¯å¤„ç†ä¸è¿‡æ¥ã€‚**

æ‰€ä»¥ï¼Œé€šå¸¸çª—å£çš„å¤§å°æ˜¯ç”±æ¥æ”¶æ–¹çš„çª—å£å¤§å°æ¥å†³å®šçš„ã€‚

å‘é€æ–¹å‘é€çš„æ•°æ®å¤§å°ä¸èƒ½è¶…è¿‡æ¥æ”¶æ–¹çš„çª—å£å¤§å°ï¼Œå¦åˆ™æ¥æ”¶æ–¹å°±æ— æ³•æ­£å¸¸æ¥æ”¶åˆ°æ•°æ®ã€‚

> å‘é€æ–¹çš„æ»‘åŠ¨çª—å£

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å‘é€æ–¹çš„çª—å£ï¼Œä¸‹å›¾å°±æ˜¯å‘é€æ–¹ç¼“å­˜çš„æ•°æ®ï¼Œæ ¹æ®å¤„ç†çš„æƒ…å†µåˆ†æˆå››ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­æ·±è“è‰²æ–¹æ¡†æ˜¯å‘é€çª—å£ï¼Œç´«è‰²æ–¹æ¡†æ˜¯å¯ç”¨çª—å£ï¼š

![img](./images/16.jpg)

- \#1 æ˜¯å·²å‘é€å¹¶æ”¶åˆ° ACKç¡®è®¤çš„æ•°æ®ï¼š1~31 å­—èŠ‚
- \#2 æ˜¯å·²å‘é€ä½†æœªæ”¶åˆ° ACKç¡®è®¤çš„æ•°æ®ï¼š32~45 å­—èŠ‚
- \#3 æ˜¯æœªå‘é€ä½†æ€»å¤§å°åœ¨æ¥æ”¶æ–¹å¤„ç†èŒƒå›´å†…ï¼ˆæ¥æ”¶æ–¹è¿˜æœ‰ç©ºé—´ï¼‰ï¼š46~51å­—èŠ‚
- \#4 æ˜¯æœªå‘é€ä½†æ€»å¤§å°è¶…è¿‡æ¥æ”¶æ–¹å¤„ç†èŒƒå›´ï¼ˆæ¥æ”¶æ–¹æ²¡æœ‰ç©ºé—´ï¼‰ï¼š52å­—èŠ‚ä»¥å

åœ¨ä¸‹å›¾ï¼Œå½“å‘é€æ–¹æŠŠæ•°æ®ã€Œå…¨éƒ¨ã€éƒ½ä¸€ä¸‹å‘é€å‡ºå»åï¼Œå¯ç”¨çª—å£çš„å¤§å°å°±ä¸º 0 äº†ï¼Œè¡¨æ˜å¯ç”¨çª—å£è€—å°½ï¼Œåœ¨æ²¡æ”¶åˆ° ACK ç¡®è®¤ä¹‹å‰æ˜¯æ— æ³•ç»§ç»­å‘é€æ•°æ®äº†ã€‚

![å¯ç”¨çª—å£è€—å°½](./images/17.jpg)

åœ¨ä¸‹å›¾ï¼Œå½“æ”¶åˆ°ä¹‹å‰å‘é€çš„æ•°æ® `32~36` å­—èŠ‚çš„ ACK ç¡®è®¤åº”ç­”åï¼Œå¦‚æœå‘é€çª—å£çš„å¤§å°æ²¡æœ‰å˜åŒ–ï¼Œåˆ™**æ»‘åŠ¨çª—å£å¾€å³è¾¹ç§»åŠ¨ 5 ä¸ªå­—èŠ‚ï¼Œå› ä¸ºæœ‰ 5 ä¸ªå­—èŠ‚çš„æ•°æ®è¢«åº”ç­”ç¡®è®¤**ï¼Œæ¥ä¸‹æ¥ `52~56` å­—èŠ‚åˆå˜æˆäº†å¯ç”¨çª—å£ï¼Œé‚£ä¹ˆåç»­ä¹Ÿå°±å¯ä»¥å‘é€ `52~56` è¿™ 5 ä¸ªå­—èŠ‚çš„æ•°æ®äº†ã€‚

![32 ~ 36 å­—èŠ‚å·²ç¡®è®¤](./images/18-165831079251519.jpg)

> ç¨‹åºæ˜¯å¦‚ä½•è¡¨ç¤ºå‘é€æ–¹çš„å››ä¸ªéƒ¨åˆ†çš„å‘¢ï¼Ÿ

TCP æ»‘åŠ¨çª—å£æ–¹æ¡ˆä½¿ç”¨ä¸‰ä¸ªæŒ‡é’ˆæ¥è·Ÿè¸ªåœ¨å››ä¸ªä¼ è¾“ç±»åˆ«ä¸­çš„æ¯ä¸€ä¸ªç±»åˆ«ä¸­çš„å­—èŠ‚ã€‚å…¶ä¸­ä¸¤ä¸ªæŒ‡é’ˆæ˜¯ç»å¯¹æŒ‡é’ˆï¼ˆæŒ‡ç‰¹å®šçš„åºåˆ—å·ï¼‰ï¼Œä¸€ä¸ªæ˜¯ç›¸å¯¹æŒ‡é’ˆï¼ˆéœ€è¦åšåç§»ï¼‰ã€‚

![SND.WNDã€SND.UNã€SND.NXT](./images/19-165831080294922.jpg)

- `SND.WND`ï¼šè¡¨ç¤ºå‘é€çª—å£çš„å¤§å°ï¼ˆå¤§å°æ˜¯ç”±æ¥æ”¶æ–¹æŒ‡å®šçš„ï¼‰ï¼›
- `SND.UNA`ï¼ˆ*Send Unacknoleged*ï¼‰ï¼šæ˜¯ä¸€ä¸ªç»å¯¹æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘çš„æ˜¯å·²å‘é€ä½†æœªæ”¶åˆ°ç¡®è®¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºåˆ—å·ï¼Œä¹Ÿå°±æ˜¯ #2 çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚
- `SND.NXT`ï¼šä¹Ÿæ˜¯ä¸€ä¸ªç»å¯¹æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘æœªå‘é€ä½†å¯å‘é€èŒƒå›´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºåˆ—å·ï¼Œä¹Ÿå°±æ˜¯ #3 çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚
- æŒ‡å‘ #4 çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ä¸ªç›¸å¯¹æŒ‡é’ˆï¼Œå®ƒéœ€è¦ `SND.UNA` æŒ‡é’ˆåŠ ä¸Š `SND.WND` å¤§å°çš„åç§»é‡ï¼Œå°±å¯ä»¥æŒ‡å‘ #4 çš„ç¬¬ä¸€ä¸ªå­—èŠ‚äº†ã€‚

é‚£ä¹ˆå¯ç”¨çª—å£å¤§å°çš„è®¡ç®—å°±å¯ä»¥æ˜¯ï¼š

**å¯ç”¨çª—å£å¤§ = SND.WND -ï¼ˆSND.NXT - SND.UNAï¼‰**

> æ¥æ”¶æ–¹çš„æ»‘åŠ¨çª—å£

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æ¥æ”¶æ–¹çš„çª—å£ï¼Œæ¥æ”¶çª—å£ç›¸å¯¹ç®€å•ä¸€äº›ï¼Œæ ¹æ®å¤„ç†çš„æƒ…å†µåˆ’åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼š

- \#1 + #2 æ˜¯å·²æˆåŠŸæ¥æ”¶å¹¶ç¡®è®¤çš„æ•°æ®ï¼ˆç­‰å¾…åº”ç”¨è¿›ç¨‹è¯»å–ï¼‰ï¼›
- \#3 æ˜¯æœªæ”¶åˆ°æ•°æ®ä½†å¯ä»¥æ¥æ”¶çš„æ•°æ®ï¼›
- \#4 æœªæ”¶åˆ°æ•°æ®å¹¶ä¸å¯ä»¥æ¥æ”¶çš„æ•°æ®ï¼›

![æ¥æ”¶çª—å£](./images/20-165831081796525.jpg)

å…¶ä¸­ä¸‰ä¸ªæ¥æ”¶éƒ¨åˆ†ï¼Œä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆè¿›è¡Œåˆ’åˆ†:

- `RCV.WND`ï¼šè¡¨ç¤ºæ¥æ”¶çª—å£çš„å¤§å°ï¼Œå®ƒä¼šé€šå‘Šç»™å‘é€æ–¹ã€‚
- `RCV.NXT`ï¼šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘æœŸæœ›ä»å‘é€æ–¹å‘é€æ¥çš„ä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚çš„åºåˆ—å·ï¼Œä¹Ÿå°±æ˜¯ #3 çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚
- æŒ‡å‘ #4 çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ä¸ªç›¸å¯¹æŒ‡é’ˆï¼Œå®ƒéœ€è¦ `RCV.NXT` æŒ‡é’ˆåŠ ä¸Š `RCV.WND` å¤§å°çš„åç§»é‡ï¼Œå°±å¯ä»¥æŒ‡å‘ #4 çš„ç¬¬ä¸€ä¸ªå­—èŠ‚äº†ã€‚

> æ¥æ”¶çª—å£å’Œå‘é€çª—å£çš„å¤§å°æ˜¯ç›¸ç­‰çš„å—ï¼Ÿ

å¹¶ä¸æ˜¯å®Œå…¨ç›¸ç­‰ï¼Œæ¥æ”¶çª—å£çš„å¤§å°æ˜¯**çº¦ç­‰äº**å‘é€çª—å£çš„å¤§å°çš„ã€‚

å› ä¸ºæ»‘åŠ¨çª—å£å¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ã€‚æ¯”å¦‚ï¼Œå½“æ¥æ”¶æ–¹çš„åº”ç”¨è¿›ç¨‹è¯»å–æ•°æ®çš„é€Ÿåº¦éå¸¸å¿«çš„è¯ï¼Œè¿™æ ·çš„è¯æ¥æ”¶çª—å£å¯ä»¥å¾ˆå¿«çš„å°±ç©ºç¼ºå‡ºæ¥ã€‚é‚£ä¹ˆæ–°çš„æ¥æ”¶çª—å£å¤§å°ï¼Œæ˜¯é€šè¿‡ TCP æŠ¥æ–‡ä¸­çš„ Windows å­—æ®µæ¥å‘Šè¯‰å‘é€æ–¹ã€‚é‚£ä¹ˆè¿™ä¸ªä¼ è¾“è¿‡ç¨‹æ˜¯å­˜åœ¨æ—¶å»¶çš„ï¼Œæ‰€ä»¥æ¥æ”¶çª—å£å’Œå‘é€çª—å£æ˜¯çº¦ç­‰äºçš„å…³ç³»ã€‚



##### ç²˜åŒ…

åœ¨è¿›è¡Œ Java NIO å­¦ä¹ æ—¶ï¼Œå¯èƒ½ä¼šå‘ç°ï¼šå¦‚æœå®¢æˆ·ç«¯è¿ç»­ä¸æ–­çš„å‘æœåŠ¡ç«¯å‘é€æ•°æ®åŒ…æ—¶ï¼ŒæœåŠ¡ç«¯æ¥æ”¶çš„æ•°æ®ä¼šå‡ºç°ä¸¤ä¸ªæ•°æ®åŒ…ç²˜åœ¨ä¸€èµ·çš„æƒ…å†µã€‚

1. TCP æ˜¯åŸºäºå­—èŠ‚æµçš„ï¼Œè™½ç„¶åº”ç”¨å±‚å’Œ TCP ä¼ è¾“å±‚ä¹‹é—´çš„æ•°æ®äº¤äº’æ˜¯å¤§å°ä¸ç­‰çš„æ•°æ®å—ï¼Œä½†æ˜¯ TCP æŠŠè¿™äº›æ•°æ®å—ä»…ä»…çœ‹æˆä¸€è¿ä¸²æ— ç»“æ„çš„å­—èŠ‚æµï¼Œæ²¡æœ‰è¾¹ç•Œ
2. ä» TCP çš„å¸§ç»“æ„ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œåœ¨ TCP çš„é¦–éƒ¨æ²¡æœ‰è¡¨ç¤ºæ•°æ®é•¿åº¦çš„å­—æ®µã€‚

åŸºäºä¸Šé¢ä¸¤ç‚¹ï¼Œåœ¨ä½¿ç”¨ TCP ä¼ è¾“æ•°æ®æ—¶ï¼Œæ‰æœ‰ç²˜åŒ…æˆ–è€…æ‹†åŒ…ç°è±¡å‘ç”Ÿçš„å¯èƒ½ã€‚ä¸€ä¸ªæ•°æ®åŒ…ä¸­åŒ…å«äº†å‘é€ç«¯å‘é€çš„ä¸¤ä¸ªæ•°æ®åŒ…çš„ä¿¡æ¯ï¼Œè¿™ç§ç°è±¡å³ä¸ºç²˜åŒ…ã€‚

æ¥æ”¶ç«¯æ”¶åˆ°äº†ä¸¤ä¸ªæ•°æ®åŒ…ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ•°æ®åŒ…è¦ä¹ˆæ˜¯ä¸å®Œæ•´çš„ï¼Œè¦ä¹ˆå°±æ˜¯å¤šå‡ºæ¥ä¸€å—ï¼Œè¿™ç§æƒ…å†µå³å‘ç”Ÿäº†æ‹†åŒ…å’Œç²˜åŒ…ã€‚æ‹†åŒ…å’Œç²˜åŒ…çš„é—®é¢˜å¯¼è‡´æ¥æ”¶ç«¯åœ¨å¤„ç†çš„æ—¶å€™ä¼šéå¸¸å›°éš¾ï¼Œå› ä¸ºæ— æ³•åŒºåˆ†ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ã€‚

- **å‘é€æ–¹äº§ç”Ÿç²˜åŒ…**

é‡‡ç”¨ TCP åè®®ä¼ è¾“æ•°æ®çš„å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç»å¸¸æ˜¯ä¿æŒä¸€ä¸ªé•¿è¿æ¥çš„çŠ¶æ€ï¼ˆä¸€æ¬¡è¿æ¥å‘ä¸€æ¬¡æ•°æ®ä¸å­˜åœ¨ç²˜åŒ…ï¼‰ï¼ŒåŒæ–¹åœ¨è¿æ¥ä¸æ–­å¼€çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸€ç›´ä¼ è¾“æ•°æ®ã€‚ä½†å½“å‘é€çš„æ•°æ®åŒ…è¿‡äºçš„å°æ—¶ï¼Œé‚£ä¹ˆ TCP åè®®é»˜è®¤çš„ä¼šå¯ç”¨ Nagle ç®—æ³•ï¼Œå°†è¿™äº›è¾ƒå°çš„æ•°æ®åŒ…è¿›è¡Œåˆå¹¶å‘é€ï¼ˆç¼“å†²åŒºæ•°æ®å‘é€æ˜¯ä¸€ä¸ªå †å‹çš„è¿‡ç¨‹ï¼‰ï¼›è¿™ä¸ªåˆå¹¶è¿‡ç¨‹å°±æ˜¯åœ¨å‘é€ç¼“å†²åŒºä¸­è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®å‘é€å‡ºæ¥å®ƒå·²ç»æ˜¯ç²˜åŒ…çš„çŠ¶æ€äº†ã€‚

- **æ¥æ”¶æ–¹äº§ç”Ÿç²˜åŒ…**

æ¥æ”¶æ–¹é‡‡ç”¨ TCP åè®®æ¥æ”¶æ•°æ®æ—¶çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šæ•°æ®åˆ°æ¥æ”¶æ–¹ï¼Œä»ç½‘ç»œæ¨¡å‹çš„ä¸‹æ–¹ä¼ é€’è‡³ä¼ è¾“å±‚ï¼Œä¼ è¾“å±‚çš„ TCP åè®®å¤„ç†æ˜¯å°†å…¶æ”¾ç½®æ¥æ”¶ç¼“å†²åŒºï¼Œç„¶åç”±åº”ç”¨å±‚æ¥ä¸»åŠ¨è·å–ï¼ˆC è¯­è¨€ç”¨ recvã€read ç­‰å‡½æ•°ï¼‰ï¼›è¿™æ—¶ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨ç¨‹åºä¸­è°ƒç”¨çš„è¯»å–æ•°æ®å‡½æ•°ä¸èƒ½åŠæ—¶çš„æŠŠç¼“å†²åŒºä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ï¼Œè€Œä¸‹ä¸€ä¸ªæ•°æ®åˆåˆ°æ¥å¹¶æœ‰ä¸€éƒ¨åˆ†æ”¾å…¥çš„ç¼“å†²åŒºæœ«å°¾ï¼Œç­‰æˆ‘ä»¬è¯»å–æ•°æ®æ—¶å°±æ˜¯ä¸€ä¸ªç²˜åŒ…ã€‚ï¼ˆæ”¾æ•°æ®çš„é€Ÿåº¦ > åº”ç”¨å±‚æ‹¿æ•°æ®é€Ÿåº¦





#### â­ï¸é”®å…¥ç½‘å€åˆ°ç½‘é¡µæ˜¾ç¤ºï¼ŒæœŸé—´å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

![img](./images/url%E8%BE%93%E5%85%A5%E5%88%B0%E5%B1%95%E7%A4%BA%E5%87%BA%E6%9D%A5%E7%9A%84%E8%BF%87%E7%A8%8B.jpg)

> ä¸Šå›¾æœ‰ä¸€ä¸ªé”™è¯¯ï¼Œè¯·æ³¨æ„ï¼Œæ˜¯ OSPF ä¸æ˜¯ OPSFã€‚ OSPFï¼ˆOpen Shortest Path Firstï¼Œospfï¼‰å¼€æ”¾æœ€çŸ­è·¯å¾„ä¼˜å…ˆåè®®, æ˜¯ç”± Internet å·¥ç¨‹ä»»åŠ¡ç»„å¼€å‘çš„è·¯ç”±é€‰æ‹©åè®®

æ€»ä½“æ¥è¯´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹:

1. DNS è§£æ
2. TCP è¿æ¥
3. å‘é€ HTTP è¯·æ±‚
4. æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å› HTTP æŠ¥æ–‡
5. æµè§ˆå™¨è§£ææ¸²æŸ“é¡µé¢
6. è¿æ¥ç»“æŸ

> æœ€è¿‘çœ‹é¢è¯•é¢˜è¦æ±‚è¯´çš„è¶Šè¯¦ç»†è¶Šå¥½å‘ç°è¶Šæ¥è¶Šå·ï¼Œæ‰€ä»¥åŠ å…¥äº†è¯¦ç»†å†…å®¹

##### HTTP

> æµè§ˆå™¨åšçš„ç¬¬ä¸€æ­¥å·¥ä½œæ˜¯è§£æ URL

é¦–å…ˆæµè§ˆå™¨åšçš„ç¬¬ä¸€æ­¥å·¥ä½œå°±æ˜¯è¦å¯¹ `URL` è¿›è¡Œè§£æï¼Œä»è€Œç”Ÿæˆå‘é€ç»™ `Web` æœåŠ¡å™¨çš„è¯·æ±‚ä¿¡æ¯ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ä¸€æ¡é•¿é•¿çš„ URL é‡Œçš„å„ä¸ªå…ƒç´ çš„ä»£è¡¨ä»€ä¹ˆï¼Œè§ä¸‹å›¾ï¼š

![image-20220718150512474](./images/image-20220718150512474.png)

æ‰€ä»¥å›¾ä¸­çš„é•¿é•¿çš„ URL å®é™…ä¸Šæ˜¯è¯·æ±‚æœåŠ¡å™¨é‡Œçš„æ–‡ä»¶èµ„æºã€‚

> è¦æ˜¯ä¸Šå›¾ä¸­çš„è“è‰²éƒ¨åˆ† URL å…ƒç´ éƒ½çœç•¥äº†ï¼Œé‚£åº”è¯¥æ˜¯è¯·æ±‚å“ªä¸ªæ–‡ä»¶å‘¢ï¼Ÿ

å½“æ²¡æœ‰è·¯å¾„åæ—¶ï¼Œå°±ä»£è¡¨è®¿é—®æ ¹ç›®å½•ä¸‹äº‹å…ˆè®¾ç½®çš„**é»˜è®¤æ–‡ä»¶**ï¼Œä¹Ÿå°±æ˜¯ `/index.html` æˆ–è€… `/default.html` è¿™äº›æ–‡ä»¶ï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿæ··ä¹±äº†ã€‚

> ç”Ÿäº§ HTTP è¯·æ±‚ä¿¡æ¯

å¯¹ `URL` è¿›è¡Œè§£æä¹‹åï¼Œæµè§ˆå™¨ç¡®å®šäº† Web æœåŠ¡å™¨å’Œæ–‡ä»¶åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®è¿™äº›ä¿¡æ¯æ¥ç”Ÿæˆ HTTP è¯·æ±‚æ¶ˆæ¯äº†ã€‚

![image-20220718150623675](./images/image-20220718150623675.png)

> ä¸€ä¸ªå­¤å• HTTP æ•°æ®åŒ…è¡¨ç¤ºï¼šâ€œæˆ‘è¿™ä¹ˆä¸€ä¸ªå°å°çš„æ•°æ®åŒ…ï¼Œæ²¡äº²æ²¡å‹ï¼Œç›´æ¥å‘åˆ°æµ©ç€šçš„ç½‘ç»œï¼Œè°ä¼šçŸ¥é“æˆ‘å‘¢ï¼Ÿè°èƒ½è½½æˆ‘ä¸€ç¨‹å‘¢ï¼Ÿè°èƒ½ä¿æŠ¤æˆ‘å‘¢ï¼Ÿæˆ‘çš„ç›®çš„åœ°åœ¨å“ªå‘¢ï¼Ÿâ€ã€‚å……æ»¡å„ç§ç–‘é—®çš„å®ƒï¼Œæ²¡æœ‰åœæ»ä¸å‰ï¼Œä¾ç„¶è¸ä¸Šäº†å¾é€”ï¼

##### DNS

é€šè¿‡æµè§ˆå™¨è§£æ URL å¹¶ç”Ÿæˆ HTTP æ¶ˆæ¯åï¼Œéœ€è¦å§”æ‰˜æ“ä½œç³»ç»Ÿå°†æ¶ˆæ¯å‘é€ç»™ `Web`  æœåŠ¡å™¨ã€‚

ä½†åœ¨å‘é€ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€é¡¹å·¥ä½œéœ€è¦å®Œæˆï¼Œé‚£å°±æ˜¯**æŸ¥è¯¢æœåŠ¡å™¨åŸŸåå¯¹åº”çš„ IP åœ°å€**ï¼Œå› ä¸ºå§”æ‰˜æ“ä½œç³»ç»Ÿå‘é€æ¶ˆæ¯æ—¶ï¼Œå¿…é¡»æä¾›é€šä¿¡å¯¹è±¡çš„ IP åœ°å€ã€‚

æ¯”å¦‚æˆ‘ä»¬æ‰“ç”µè¯çš„æ—¶å€™ï¼Œå¿…é¡»è¦çŸ¥é“å¯¹æ–¹çš„ç”µè¯å·ç ï¼Œä½†ç”±äºç”µè¯å·ç éš¾ä»¥è®°å¿†ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬ä¼šå°†å¯¹æ–¹ç”µè¯å· + å§“åä¿å­˜åœ¨é€šè®¯å½•é‡Œã€‚

æ‰€ä»¥ï¼Œæœ‰ä¸€ç§æœåŠ¡å™¨å°±ä¸“é—¨ä¿å­˜äº† `Web` æœåŠ¡å™¨åŸŸåä¸ `IP` çš„å¯¹åº”å…³ç³»ï¼Œå®ƒå°±æ˜¯ `DNS` æœåŠ¡å™¨ã€‚

> åŸŸåçš„å±‚çº§å…³ç³»

DNS ä¸­çš„åŸŸåéƒ½æ˜¯ç”¨**å¥ç‚¹**æ¥åˆ†éš”çš„ï¼Œæ¯”å¦‚ `www.server.com`ï¼Œè¿™é‡Œçš„å¥ç‚¹ä»£è¡¨äº†ä¸åŒå±‚æ¬¡ä¹‹é—´çš„**ç•Œé™**ã€‚

åœ¨åŸŸåä¸­ï¼Œ**è¶Šé å³**çš„ä½ç½®è¡¨ç¤ºå…¶å±‚çº§**è¶Šé«˜**ã€‚

æ¯•ç«ŸåŸŸåæ˜¯å¤–å›½äººå‘æ˜ï¼Œæ‰€ä»¥æ€ç»´å’Œä¸­å›½äººç›¸åï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªåŸå¸‚åœ°ç‚¹çš„æ—¶å€™ï¼Œå¤–å›½å–œæ¬¢ä»å°åˆ°å¤§çš„æ–¹å¼é¡ºåºè¯´èµ·ï¼ˆå¦‚ XX è¡—é“ XX åŒº XX å¸‚ XX çœï¼‰ï¼Œè€Œä¸­å›½åˆ™å–œæ¬¢ä»å¤§åˆ°å°çš„é¡ºåºï¼ˆå¦‚ XX çœ XX å¸‚ XX åŒº XX è¡—é“ï¼‰ã€‚

å®é™…ä¸ŠåŸŸåæœ€åè¿˜æœ‰ä¸€ä¸ªç‚¹ï¼Œæ¯”å¦‚ `www.server.com.`ï¼Œè¿™ä¸ªæœ€åçš„ä¸€ä¸ªç‚¹ä»£è¡¨æ ¹åŸŸåã€‚

ä¹Ÿå°±æ˜¯ï¼Œ`.` æ ¹åŸŸæ˜¯åœ¨æœ€é¡¶å±‚ï¼Œå®ƒçš„ä¸‹ä¸€å±‚å°±æ˜¯ `.com` é¡¶çº§åŸŸï¼Œå†ä¸‹é¢æ˜¯ `server.com`ã€‚

æ‰€ä»¥åŸŸåçš„å±‚çº§å…³ç³»ç±»ä¼¼ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼š

- æ ¹ DNS æœåŠ¡å™¨ï¼ˆ.ï¼‰
- é¡¶çº§åŸŸ DNS æœåŠ¡å™¨ï¼ˆ.comï¼‰
- æƒå¨ DNS æœåŠ¡å™¨ï¼ˆserver.comï¼‰

![image-20220718151134708](./images/image-20220718151134708.png)

æ ¹åŸŸçš„ DNS æœåŠ¡å™¨ä¿¡æ¯ä¿å­˜åœ¨äº’è”ç½‘ä¸­æ‰€æœ‰çš„ DNS æœåŠ¡å™¨ä¸­ã€‚

è¿™æ ·ä¸€æ¥ï¼Œä»»ä½• DNS æœåŠ¡å™¨å°±éƒ½å¯ä»¥æ‰¾åˆ°å¹¶è®¿é—®æ ¹åŸŸ DNS æœåŠ¡å™¨äº†ã€‚

å› æ­¤ï¼Œå®¢æˆ·ç«¯åªè¦èƒ½å¤Ÿæ‰¾åˆ°ä»»æ„ä¸€å° DNS æœåŠ¡å™¨ï¼Œå°±å¯ä»¥é€šè¿‡å®ƒæ‰¾åˆ°æ ¹åŸŸ DNS æœåŠ¡å™¨ï¼Œç„¶åå†ä¸€è·¯é¡ºè—¤æ‘¸ç“œæ‰¾åˆ°ä½äºä¸‹å±‚çš„æŸå°ç›®æ ‡ DNS æœåŠ¡å™¨ã€‚

> åŸŸåè§£æçš„å·¥ä½œæµç¨‹

1. å®¢æˆ·ç«¯é¦–å…ˆä¼šå‘å‡ºä¸€ä¸ª DNS è¯·æ±‚ï¼Œé—® www.server.com çš„ IP æ˜¯å•¥ï¼Œå¹¶å‘ç»™æœ¬åœ° DNS æœåŠ¡å™¨ï¼ˆä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯çš„ TCP/IP è®¾ç½®ä¸­å¡«å†™çš„ DNS æœåŠ¡å™¨åœ°å€ï¼‰ã€‚
2. æœ¬åœ°åŸŸåæœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œå¦‚æœç¼“å­˜é‡Œçš„è¡¨æ ¼èƒ½æ‰¾åˆ° www.server.comï¼Œåˆ™å®ƒç›´æ¥è¿”å› IP åœ°å€ã€‚å¦‚æœæ²¡æœ‰ï¼Œæœ¬åœ° DNS ä¼šå»é—®å®ƒçš„æ ¹åŸŸåæœåŠ¡å™¨ï¼šâ€œè€å¤§ï¼Œ èƒ½å‘Šè¯‰æˆ‘  www.server.com çš„ IP åœ°å€å—ï¼Ÿâ€ æ ¹åŸŸåæœåŠ¡å™¨æ˜¯æœ€é«˜å±‚æ¬¡çš„ï¼Œå®ƒä¸ç›´æ¥ç”¨äºåŸŸåè§£æï¼Œä½†èƒ½æŒ‡æ˜ä¸€æ¡é“è·¯ã€‚
3. æ ¹ DNS æ”¶åˆ°æ¥è‡ªæœ¬åœ° DNS çš„è¯·æ±‚åï¼Œå‘ç°åç½®æ˜¯ .comï¼Œè¯´ï¼šâ€œwww.server.com è¿™ä¸ªåŸŸåå½’ .com åŒºåŸŸç®¡ç†â€ï¼Œæˆ‘ç»™ä½  .com é¡¶çº§åŸŸåæœåŠ¡å™¨åœ°å€ç»™ä½ ï¼Œä½ å»é—®é—®å®ƒå§ã€‚â€
4. æœ¬åœ° DNS æ”¶åˆ°é¡¶çº§åŸŸåæœåŠ¡å™¨çš„åœ°å€åï¼Œå‘èµ·è¯·æ±‚é—®â€œè€äºŒï¼Œ ä½ èƒ½å‘Šè¯‰æˆ‘ www.server.com  çš„ IP åœ°å€å—ï¼Ÿâ€
5. é¡¶çº§åŸŸåæœåŠ¡å™¨è¯´ï¼šâ€œæˆ‘ç»™ä½ è´Ÿè´£ www.server.com åŒºåŸŸçš„æƒå¨ DNS æœåŠ¡å™¨çš„åœ°å€ï¼Œä½ å»é—®å®ƒåº”è¯¥èƒ½é—®åˆ°â€ã€‚
6. æœ¬åœ° DNS äºæ˜¯è½¬å‘é—®æƒå¨ DNS æœåŠ¡å™¨ï¼šâ€œè€ä¸‰ï¼Œwww.server.comå¯¹åº”çš„IPæ˜¯å•¥å‘€ï¼Ÿâ€ server.com çš„æƒå¨ DNS æœåŠ¡å™¨ï¼Œå®ƒæ˜¯åŸŸåè§£æç»“æœçš„åŸå‡ºå¤„ã€‚ä¸ºå•¥å«æƒå¨å‘¢ï¼Ÿå°±æ˜¯æˆ‘çš„åŸŸåæˆ‘åšä¸»ã€‚
7. æƒå¨ DNS æœåŠ¡å™¨æŸ¥è¯¢åå°†å¯¹åº”çš„ IP åœ°å€ X.X.X.X å‘Šè¯‰æœ¬åœ° DNSã€‚
8. æœ¬åœ° DNS å†å°† IP åœ°å€è¿”å›å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å’Œç›®æ ‡å»ºç«‹è¿æ¥ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº† DNS çš„è§£æè¿‡ç¨‹ã€‚ç°åœ¨æ€»ç»“ä¸€ä¸‹ï¼Œæ•´ä¸ªè¿‡ç¨‹æˆ‘ç”»æˆäº†ä¸€ä¸ªå›¾ã€‚

![image-20220718151150466](./images/image-20220718151150466.png)

DNS åŸŸåè§£æçš„è¿‡ç¨‹è›®æœ‰æ„æ€çš„ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±å’Œæˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­æ‰¾äººé—®è·¯çš„è¿‡ç¨‹ç±»ä¼¼ï¼Œ**åªæŒ‡è·¯ä¸å¸¦è·¯**ã€‚

> é‚£æ˜¯ä¸æ˜¯æ¯æ¬¡è§£æåŸŸåéƒ½è¦ç»è¿‡é‚£ä¹ˆå¤šçš„æ­¥éª¤å‘¢ï¼Ÿ

å½“ç„¶ä¸æ˜¯äº†ï¼Œè¿˜æœ‰ç¼“å­˜è¿™ä¸ªä¸œè¥¿çš„å˜›ã€‚

æµè§ˆå™¨ä¼šå…ˆçœ‹è‡ªèº«æœ‰æ²¡æœ‰å¯¹è¿™ä¸ªåŸŸåçš„ç¼“å­˜ï¼Œå¦‚æœæœ‰ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å»é—®æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿä¹Ÿä¼šå»çœ‹è‡ªå·±çš„ç¼“å­˜ï¼Œå¦‚æœæœ‰ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å» hosts æ–‡ä»¶çœ‹ï¼Œä¹Ÿæ²¡æœ‰ï¼Œæ‰ä¼šå»é—®ã€Œæœ¬åœ° DNS æœåŠ¡å™¨ã€ã€‚

> æ•°æ®åŒ…è¡¨ç¤ºï¼šâ€œDNS è€å¤§å“¥å‰å®³å‘€ï¼Œæ‰¾åˆ°äº†ç›®çš„åœ°äº†ï¼æˆ‘è¿˜æ˜¯å¾ˆè¿·èŒ«å‘€ï¼Œæˆ‘è¦å‘å‡ºå»ï¼Œæ¥ä¸‹æ¥æˆ‘éœ€è¦è°çš„å¸®åŠ©å‘¢?â€

##### åè®®æ ˆ

é€šè¿‡ DNS è·å–åˆ° IP åï¼Œå°±å¯ä»¥æŠŠ HTTP çš„ä¼ è¾“å·¥ä½œäº¤ç»™æ“ä½œç³»ç»Ÿä¸­çš„**åè®®æ ˆ**ã€‚

åè®®æ ˆçš„å†…éƒ¨åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ‰¿æ‹…ä¸åŒçš„å·¥ä½œã€‚ä¸Šä¸‹å…³ç³»æ˜¯æœ‰ä¸€å®šçš„è§„åˆ™çš„ï¼Œä¸Šé¢çš„éƒ¨åˆ†ä¼šå‘ä¸‹é¢çš„éƒ¨åˆ†å§”æ‰˜å·¥ä½œï¼Œä¸‹é¢çš„éƒ¨åˆ†æ”¶åˆ°å§”æ‰˜çš„å·¥ä½œå¹¶æ‰§è¡Œã€‚

![image-20220718151430741](./images/image-20220718151430741.png)

åº”ç”¨ç¨‹åºï¼ˆæµè§ˆå™¨ï¼‰é€šè¿‡è°ƒç”¨ Socket åº“ï¼Œæ¥å§”æ‰˜åè®®æ ˆå·¥ä½œã€‚åè®®æ ˆçš„ä¸ŠåŠéƒ¨åˆ†æœ‰ä¸¤å—ï¼Œåˆ†åˆ«æ˜¯è´Ÿè´£æ”¶å‘æ•°æ®çš„ TCP å’Œ UDP åè®®ï¼Œè¿™ä¸¤ä¸ªä¼ è¾“åè®®ä¼šæ¥å—åº”ç”¨å±‚çš„å§”æ‰˜æ‰§è¡Œæ”¶å‘æ•°æ®çš„æ“ä½œã€‚

åè®®æ ˆçš„ä¸‹é¢ä¸€åŠæ˜¯ç”¨ IP åè®®æ§åˆ¶ç½‘ç»œåŒ…æ”¶å‘æ“ä½œï¼Œåœ¨äº’è”ç½‘ä¸Šä¼ æ•°æ®æ—¶ï¼Œæ•°æ®ä¼šè¢«åˆ‡åˆ†æˆä¸€å—å—çš„ç½‘ç»œåŒ…ï¼Œè€Œå°†ç½‘ç»œåŒ…å‘é€ç»™å¯¹æ–¹çš„æ“ä½œå°±æ˜¯ç”± IP è´Ÿè´£çš„ã€‚

æ­¤å¤– IP ä¸­è¿˜åŒ…æ‹¬ `ICMP` åè®®å’Œ `ARP` åè®®ã€‚

- `ICMP` ç”¨äºå‘ŠçŸ¥ç½‘ç»œåŒ…ä¼ é€è¿‡ç¨‹ä¸­äº§ç”Ÿçš„é”™è¯¯ä»¥åŠå„ç§æ§åˆ¶ä¿¡æ¯ã€‚
- `ARP` ç”¨äºæ ¹æ® IP åœ°å€æŸ¥è¯¢ç›¸åº”çš„ä»¥å¤ªç½‘ MAC åœ°å€ã€‚

IP ä¸‹é¢çš„ç½‘å¡é©±åŠ¨ç¨‹åºè´Ÿè´£æ§åˆ¶ç½‘å¡ç¡¬ä»¶ï¼Œè€Œæœ€ä¸‹é¢çš„ç½‘å¡åˆ™è´Ÿè´£å®Œæˆå®é™…çš„æ”¶å‘æ“ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹ç½‘çº¿ä¸­çš„ä¿¡å·æ‰§è¡Œå‘é€å’Œæ¥æ”¶æ“ä½œã€‚

> æ•°æ®åŒ…çœ‹äº†è¿™ä»½æŒ‡å—è¡¨ç¤ºï¼šâ€œåŸæ¥æˆ‘éœ€è¦é‚£ä¹ˆå¤šå¤§ä½¬çš„ååŠ©å•Šï¼Œé‚£æˆ‘å…ˆå»æ‰¾æ‰¾ TCP å¤§ä½¬ï¼â€

##### TCP

HTTP æ˜¯åŸºäº TCP åè®®ä¼ è¾“çš„ï¼Œæ‰€ä»¥åœ¨è¿™æˆ‘ä»¬å…ˆäº†è§£ä¸‹ TCP åè®®ã€‚

> TCP åŒ…å¤´æ ¼å¼

æˆ‘ä»¬å…ˆçœ‹çœ‹ TCP æŠ¥æ–‡å¤´éƒ¨çš„æ ¼å¼ï¼š

![image-20220718151452778](./images/image-20220718151452778.png)

é¦–å…ˆï¼Œ**æºç«¯å£å·**å’Œ**ç›®æ ‡ç«¯å£**å·æ˜¯ä¸å¯å°‘çš„ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸¤ä¸ªç«¯å£å·ï¼Œæ•°æ®å°±ä¸çŸ¥é“åº”è¯¥å‘ç»™å“ªä¸ªåº”ç”¨ã€‚

æ¥ä¸‹æ¥æœ‰åŒ…çš„**åº**å·ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†è§£å†³åŒ…ä¹±åºçš„é—®é¢˜ã€‚

è¿˜æœ‰åº”è¯¥æœ‰çš„æ˜¯**ç¡®è®¤å·**ï¼Œç›®çš„æ˜¯ç¡®è®¤å‘å‡ºå»å¯¹æ–¹æ˜¯å¦æœ‰æ”¶åˆ°ã€‚å¦‚æœæ²¡æœ‰æ”¶åˆ°å°±åº”è¯¥é‡æ–°å‘é€ï¼Œç›´åˆ°é€è¾¾ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†è§£å†³ä¸ä¸¢åŒ…çš„é—®é¢˜ã€‚

æ¥ä¸‹æ¥è¿˜æœ‰ä¸€äº›**çŠ¶æ€ä½**ã€‚ä¾‹å¦‚ `SYN` æ˜¯å‘èµ·ä¸€ä¸ªè¿æ¥ï¼Œ`ACK` æ˜¯å›å¤ï¼Œ`RST` æ˜¯é‡æ–°è¿æ¥ï¼Œ`FIN` æ˜¯ç»“æŸè¿æ¥ç­‰ã€‚TCP æ˜¯é¢å‘è¿æ¥çš„ï¼Œå› è€ŒåŒæ–¹è¦ç»´æŠ¤è¿æ¥çš„çŠ¶æ€ï¼Œè¿™äº›å¸¦çŠ¶æ€ä½çš„åŒ…çš„å‘é€ï¼Œä¼šå¼•èµ·åŒæ–¹çš„çŠ¶æ€å˜æ›´ã€‚

è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å°±æ˜¯**çª—å£å¤§å°**ã€‚TCP è¦åš**æµé‡æ§åˆ¶**ï¼Œé€šä¿¡åŒæ–¹å„å£°æ˜ä¸€ä¸ªçª—å£ï¼ˆç¼“å­˜å¤§å°ï¼‰ï¼Œæ ‡è¯†è‡ªå·±å½“å‰èƒ½å¤Ÿçš„å¤„ç†èƒ½åŠ›ï¼Œåˆ«å‘é€çš„å¤ªå¿«ï¼Œæ’‘æ­»æˆ‘ï¼Œä¹Ÿåˆ«å‘çš„å¤ªæ…¢ï¼Œé¥¿æ­»æˆ‘ã€‚

é™¤äº†åšæµé‡æ§åˆ¶ä»¥å¤–ï¼ŒTCPè¿˜ä¼šåš**æ‹¥å¡æ§åˆ¶**ï¼Œå¯¹äºçœŸæ­£çš„é€šè·¯å µè½¦ä¸å µè½¦ï¼Œå®ƒæ— èƒ½ä¸ºåŠ›ï¼Œå”¯ä¸€èƒ½åšçš„å°±æ˜¯æ§åˆ¶è‡ªå·±ï¼Œä¹Ÿå³æ§åˆ¶å‘é€çš„é€Ÿåº¦ã€‚ä¸èƒ½æ”¹å˜ä¸–ç•Œï¼Œå°±æ”¹å˜è‡ªå·±å˜›ã€‚

> TCP ä¼ è¾“æ•°æ®ä¹‹å‰ï¼Œè¦å…ˆä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥

åœ¨ HTTP ä¼ è¾“æ•°æ®ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦ TCP å»ºç«‹è¿æ¥ï¼ŒTCP è¿æ¥çš„å»ºç«‹ï¼Œé€šå¸¸ç§°ä¸º**ä¸‰æ¬¡æ¡æ‰‹**ã€‚

è¿™ä¸ªæ‰€è°“çš„ã€Œè¿æ¥ã€ï¼Œåªæ˜¯åŒæ–¹è®¡ç®—æœºé‡Œç»´æŠ¤ä¸€ä¸ªçŠ¶æ€æœºï¼Œåœ¨è¿æ¥å»ºç«‹çš„è¿‡ç¨‹ä¸­ï¼ŒåŒæ–¹çš„çŠ¶æ€å˜åŒ–æ—¶åºå›¾å°±åƒè¿™æ ·ã€‚

![image-20220718151501747](./images/image-20220718151501747.png)

- ä¸€å¼€å§‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¤„äº `CLOSED` çŠ¶æ€ã€‚å…ˆæ˜¯æœåŠ¡ç«¯ä¸»åŠ¨ç›‘å¬æŸä¸ªç«¯å£ï¼Œå¤„äº `LISTEN` çŠ¶æ€ã€‚
- ç„¶åå®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¿æ¥ `SYN`ï¼Œä¹‹åå¤„äº `SYN-SENT` çŠ¶æ€ã€‚
- æœåŠ¡ç«¯æ”¶åˆ°å‘èµ·çš„è¿æ¥ï¼Œè¿”å› `SYN`ï¼Œå¹¶ä¸” `ACK` å®¢æˆ·ç«¯çš„ `SYN`ï¼Œä¹‹åå¤„äº `SYN-RCVD` çŠ¶æ€ã€‚
- å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯å‘é€çš„ `SYN` å’Œ `ACK` ä¹‹åï¼Œå‘é€å¯¹ `SYN` ç¡®è®¤çš„ `ACK`ï¼Œä¹‹åå¤„äº `ESTABLISHED` çŠ¶æ€ï¼Œå› ä¸ºå®ƒä¸€å‘ä¸€æ”¶æˆåŠŸäº†ã€‚
- æœåŠ¡ç«¯æ”¶åˆ° `ACK` çš„ `ACK` ä¹‹åï¼Œå¤„äº `ESTABLISHED` çŠ¶æ€ï¼Œå› ä¸ºå®ƒä¹Ÿä¸€å‘ä¸€æ”¶äº†ã€‚

æ‰€ä»¥ä¸‰æ¬¡æ¡æ‰‹ç›®çš„æ˜¯**ä¿è¯åŒæ–¹éƒ½æœ‰å‘é€å’Œæ¥æ”¶çš„èƒ½åŠ›**ã€‚

> å¦‚ä½•æŸ¥çœ‹ TCP çš„è¿æ¥çŠ¶æ€ï¼Ÿ

TCP çš„è¿æ¥çŠ¶æ€æŸ¥çœ‹ï¼Œåœ¨ Linux å¯ä»¥é€šè¿‡ `netstat -napt` å‘½ä»¤æŸ¥çœ‹ã€‚

![image-20220718151518568](./images/image-20220718151518568.png)

> TCP åˆ†å‰²æ•°æ®

å¦‚æœ HTTP è¯·æ±‚æ¶ˆæ¯æ¯”è¾ƒé•¿ï¼Œè¶…è¿‡äº† `MSS` çš„é•¿åº¦ï¼Œè¿™æ—¶ TCP å°±éœ€è¦æŠŠ HTTP çš„æ•°æ®æ‹†è§£æˆä¸€å—å—çš„æ•°æ®å‘é€ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰æ•°æ®ã€‚

![image-20220718151526400](./images/image-20220718151526400.png)

- `MTU`ï¼šä¸€ä¸ªç½‘ç»œåŒ…çš„æœ€å¤§é•¿åº¦ï¼Œä»¥å¤ªç½‘ä¸­ä¸€èˆ¬ä¸º `1500` å­—èŠ‚ã€‚
- `MSS`ï¼šé™¤å» IP å’Œ TCP å¤´éƒ¨ä¹‹åï¼Œä¸€ä¸ªç½‘ç»œåŒ…æ‰€èƒ½å®¹çº³çš„ TCP æ•°æ®çš„æœ€å¤§é•¿åº¦ã€‚

æ•°æ®ä¼šè¢«ä»¥ `MSS` çš„é•¿åº¦ä¸ºå•ä½è¿›è¡Œæ‹†åˆ†ï¼Œæ‹†åˆ†å‡ºæ¥çš„æ¯ä¸€å—æ•°æ®éƒ½ä¼šè¢«æ”¾è¿›å•ç‹¬çš„ç½‘ç»œåŒ…ä¸­ã€‚ä¹Ÿå°±æ˜¯åœ¨æ¯ä¸ªè¢«æ‹†åˆ†çš„æ•°æ®åŠ ä¸Š TCP å¤´ä¿¡æ¯ï¼Œç„¶åäº¤ç»™ IP æ¨¡å—æ¥å‘é€æ•°æ®ã€‚

![image-20220718151534470](./images/image-20220718151534470.png)

> TCP æŠ¥æ–‡ç”Ÿæˆ

TCP åè®®é‡Œé¢ä¼šæœ‰ä¸¤ä¸ªç«¯å£ï¼Œä¸€ä¸ªæ˜¯æµè§ˆå™¨ç›‘å¬çš„ç«¯å£ï¼ˆé€šå¸¸æ˜¯éšæœºç”Ÿæˆçš„ï¼‰ï¼Œä¸€ä¸ªæ˜¯ Web æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£ï¼ˆHTTP é»˜è®¤ç«¯å£å·æ˜¯ `80`ï¼Œ HTTPS é»˜è®¤ç«¯å£å·æ˜¯ `443`ï¼‰ã€‚

åœ¨åŒæ–¹å»ºç«‹äº†è¿æ¥åï¼ŒTCP æŠ¥æ–‡ä¸­çš„æ•°æ®éƒ¨åˆ†å°±æ˜¯å­˜æ”¾ HTTP å¤´éƒ¨ + æ•°æ®ï¼Œç»„è£…å¥½ TCP æŠ¥æ–‡ä¹‹åï¼Œå°±éœ€äº¤ç»™ä¸‹é¢çš„ç½‘ç»œå±‚å¤„ç†ã€‚

è‡³æ­¤ï¼Œç½‘ç»œåŒ…çš„æŠ¥æ–‡å¦‚ä¸‹å›¾ã€‚

![image-20220718151542331](./images/image-20220718151542331.png)

> æ­¤æ—¶ï¼Œé‡ä¸Šäº† TCP çš„  æ•°æ®åŒ…æ¿€åŠ¨è¡¨ç¤ºï¼šâ€œå¤ªå¥½äº†ï¼Œç¢°åˆ°äº†å¯é ä¼ è¾“çš„ TCP ä¼ è¾“ï¼Œå®ƒç»™æˆ‘åŠ ä¸Š TCP å¤´éƒ¨ï¼Œæˆ‘ä¸å†å­¤å•äº†ï¼Œå®‰å…¨æ„Ÿåè¶³å•Šï¼æœ‰å¤§ä½¬å¯ä»¥ä¿æŠ¤æˆ‘çš„å¯é é€è¾¾ï¼ä½†æˆ‘åº”è¯¥å¾€å“ªèµ°å‘¢ï¼Ÿâ€

##### IP

TCP æ¨¡å—åœ¨æ‰§è¡Œè¿æ¥ã€æ”¶å‘ã€æ–­å¼€ç­‰å„é˜¶æ®µæ“ä½œæ—¶ï¼Œéƒ½éœ€è¦å§”æ‰˜ IP æ¨¡å—å°†æ•°æ®å°è£…æˆ**ç½‘ç»œåŒ…**å‘é€ç»™é€šä¿¡å¯¹è±¡ã€‚

> IP åŒ…å¤´æ ¼å¼

æˆ‘ä»¬å…ˆçœ‹çœ‹ IP æŠ¥æ–‡å¤´éƒ¨çš„æ ¼å¼ï¼š

![image-20220718151640795](./images/image-20220718151640795.png)

åœ¨ IP åè®®é‡Œé¢éœ€è¦æœ‰**æºåœ°å€ IP** å’Œ **ç›®æ ‡åœ°å€ IP**ï¼š

- æºåœ°å€IPï¼Œå³æ˜¯å®¢æˆ·ç«¯è¾“å‡ºçš„ IP åœ°å€ï¼›
- ç›®æ ‡åœ°å€ï¼Œå³é€šè¿‡ DNS åŸŸåè§£æå¾—åˆ°çš„ Web æœåŠ¡å™¨ IPã€‚

å› ä¸º HTTP æ˜¯ç»è¿‡ TCP ä¼ è¾“çš„ï¼Œæ‰€ä»¥åœ¨ IP åŒ…å¤´çš„**åè®®å·**ï¼Œè¦å¡«å†™ä¸º `06`ï¼ˆåå…­è¿›åˆ¶ï¼‰ï¼Œè¡¨ç¤ºåè®®ä¸º TCPã€‚

> å‡è®¾å®¢æˆ·ç«¯æœ‰å¤šä¸ªç½‘å¡ï¼Œå°±ä¼šæœ‰å¤šä¸ª IP åœ°å€ï¼Œé‚£ IP å¤´éƒ¨çš„æºåœ°å€åº”è¯¥é€‰æ‹©å“ªä¸ª IP å‘¢ï¼Ÿ

å½“å­˜åœ¨å¤šä¸ªç½‘å¡æ—¶ï¼Œåœ¨å¡«å†™æºåœ°å€ IP æ—¶ï¼Œå°±éœ€è¦åˆ¤æ–­åˆ°åº•åº”è¯¥å¡«å†™å“ªä¸ªåœ°å€ã€‚è¿™ä¸ªåˆ¤æ–­ç›¸å½“äºåœ¨å¤šå—ç½‘å¡ä¸­åˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªä¸ªä¸€å—ç½‘å¡æ¥å‘é€åŒ…ã€‚

è¿™ä¸ªæ—¶å€™å°±éœ€è¦æ ¹æ®**è·¯ç”±è¡¨**è§„åˆ™ï¼Œæ¥åˆ¤æ–­å“ªä¸€ä¸ªç½‘å¡ä½œä¸ºæºåœ°å€ IPã€‚

åœ¨ Linux æ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `route -n` å‘½ä»¤æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„è·¯ç”±è¡¨ã€‚

![image-20220718151649816](./images/image-20220718151649816.png)

ä¸¾ä¸ªä¾‹å­ï¼Œæ ¹æ®ä¸Šé¢çš„è·¯ç”±è¡¨ï¼Œæˆ‘ä»¬å‡è®¾ Web æœåŠ¡å™¨çš„ç›®æ ‡åœ°å€æ˜¯ `192.168.10.200`ã€‚

![image-20220718151659105](./images/image-20220718151659105.png)

1. é¦–å…ˆå…ˆå’Œç¬¬ä¸€æ¡ç›®çš„å­ç½‘æ©ç ï¼ˆ`Genmask`ï¼‰è¿›è¡Œ **ä¸è¿ç®—**ï¼Œå¾—åˆ°ç»“æœä¸º `192.168.10.0`ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªæ¡ç›®çš„ `Destination` æ˜¯ `192.168.3.0`ï¼Œä¸¤è€…ä¸ä¸€è‡´æ‰€ä»¥åŒ¹é…å¤±è´¥ã€‚
2. å†ä¸ç¬¬äºŒæ¡ç›®çš„å­ç½‘æ©ç è¿›è¡Œ **ä¸è¿ç®—**ï¼Œå¾—åˆ°çš„ç»“æœä¸º `192.168.10.0`ï¼Œä¸ç¬¬äºŒæ¡ç›®çš„ `Destination 192.168.10.0` åŒ¹é…æˆåŠŸï¼Œæ‰€ä»¥å°†ä½¿ç”¨ `eth1` ç½‘å¡çš„ IP åœ°å€ä½œä¸º IP åŒ…å¤´çš„æºåœ°å€ã€‚

é‚£ä¹ˆå‡è®¾ Web æœåŠ¡å™¨çš„ç›®æ ‡åœ°å€æ˜¯ `10.100.20.100`ï¼Œé‚£ä¹ˆä¾ç„¶ä¾ç…§ä¸Šé¢çš„è·¯ç”±è¡¨è§„åˆ™åˆ¤æ–­ï¼Œåˆ¤æ–­åçš„ç»“æœæ˜¯å’Œç¬¬ä¸‰æ¡ç›®åŒ¹é…ã€‚

ç¬¬ä¸‰æ¡ç›®æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒç›®æ ‡åœ°å€å’Œå­ç½‘æ©ç éƒ½æ˜¯ `0.0.0.0`ï¼Œè¿™è¡¨ç¤º**é»˜è®¤ç½‘å…³**ï¼Œå¦‚æœå…¶ä»–æ‰€æœ‰æ¡ç›®éƒ½æ— æ³•åŒ¹é…ï¼Œå°±ä¼šè‡ªåŠ¨åŒ¹é…è¿™ä¸€è¡Œã€‚å¹¶ä¸”åç»­å°±æŠŠåŒ…å‘ç»™è·¯ç”±å™¨ï¼Œ`Gateway` å³æ˜¯è·¯ç”±å™¨çš„ IP åœ°å€ã€‚

> IP æŠ¥æ–‡ç”Ÿæˆ

è‡³æ­¤ï¼Œç½‘ç»œåŒ…çš„æŠ¥æ–‡å¦‚ä¸‹å›¾ã€‚

![image-20220718151712840](./images/image-20220718151712840.png)

> æ­¤æ—¶ï¼ŒåŠ ä¸Šäº† IP å¤´éƒ¨çš„æ•°æ®åŒ…è¡¨ç¤º ï¼šâ€œæœ‰ IP å¤§ä½¬ç»™æˆ‘æŒ‡è·¯äº†ï¼Œæ„Ÿè°¢ IP å±‚ç»™æˆ‘åŠ ä¸Šäº† IP åŒ…å¤´ï¼Œè®©æˆ‘æœ‰äº†è¿œç¨‹å®šä½çš„èƒ½åŠ›ï¼ä¸ä¼šå®³æ€•åœ¨æµ©ç€šçš„äº’è”ç½‘è¿·èŒ«äº†ï¼å¯æ˜¯ç›®çš„åœ°å¥½è¿œå•Šï¼Œæˆ‘ä¸‹ä¸€ç«™åº”è¯¥å»å“ªå‘¢ï¼Ÿâ€

##### MAC

ç”Ÿæˆäº† IP å¤´éƒ¨ä¹‹åï¼Œæ¥ä¸‹æ¥ç½‘ç»œåŒ…è¿˜éœ€è¦åœ¨ IP å¤´éƒ¨çš„å‰é¢åŠ ä¸Š **MAC å¤´éƒ¨**ã€‚

> MAC åŒ…å¤´æ ¼å¼

MAC å¤´éƒ¨æ˜¯ä»¥å¤ªç½‘ä½¿ç”¨çš„å¤´éƒ¨ï¼Œå®ƒåŒ…å«äº†æ¥æ”¶æ–¹å’Œå‘é€æ–¹çš„ MAC åœ°å€ç­‰ä¿¡æ¯ã€‚

![MAC åŒ…å¤´æ ¼å¼](./images/18.jpg)

åœ¨ MAC åŒ…å¤´é‡Œéœ€è¦**å‘é€æ–¹ MAC åœ°å€**å’Œ**æ¥æ”¶æ–¹ç›®æ ‡ MAC åœ°å€**ï¼Œç”¨äº**ä¸¤ç‚¹ä¹‹é—´çš„ä¼ è¾“**ã€‚

ä¸€èˆ¬åœ¨ TCP/IP é€šä¿¡é‡Œï¼ŒMAC åŒ…å¤´çš„**åè®®ç±»å‹**åªä½¿ç”¨ï¼š

- `0800` ï¼š IP åè®®
- `0806` ï¼š ARP åè®®

> MAC å‘é€æ–¹å’Œæ¥æ”¶æ–¹å¦‚ä½•ç¡®è®¤?

**å‘é€æ–¹**çš„ MAC åœ°å€è·å–å°±æ¯”è¾ƒç®€å•äº†ï¼ŒMAC åœ°å€æ˜¯åœ¨ç½‘å¡ç”Ÿäº§æ—¶å†™å…¥åˆ° ROM é‡Œçš„ï¼Œåªè¦å°†è¿™ä¸ªå€¼è¯»å–å‡ºæ¥å†™å…¥åˆ° MAC å¤´éƒ¨å°±å¯ä»¥äº†ã€‚

**æ¥æ”¶æ–¹**çš„ MAC åœ°å€å°±æœ‰ç‚¹å¤æ‚äº†ï¼Œåªè¦å‘Šè¯‰ä»¥å¤ªç½‘å¯¹æ–¹çš„ MAC çš„åœ°å€ï¼Œä»¥å¤ªç½‘å°±ä¼šå¸®æˆ‘ä»¬æŠŠåŒ…å‘é€è¿‡å»ï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶è¿™é‡Œåº”è¯¥å¡«å†™å¯¹æ–¹çš„ MAC åœ°å€ã€‚

æ‰€ä»¥å…ˆå¾—ææ¸…æ¥šåº”è¯¥æŠŠåŒ…å‘ç»™è°ï¼Œè¿™ä¸ªåªè¦æŸ¥ä¸€ä¸‹**è·¯ç”±è¡¨**å°±çŸ¥é“äº†ã€‚åœ¨è·¯ç”±è¡¨ä¸­æ‰¾åˆ°ç›¸åŒ¹é…çš„æ¡ç›®ï¼Œç„¶åæŠŠåŒ…å‘ç»™ `Gateway` åˆ—ä¸­çš„ IP åœ°å€å°±å¯ä»¥äº†ã€‚

> æ—¢ç„¶çŸ¥é“è¦å‘ç»™è°ï¼ŒæŒ‰å¦‚ä½•è·å–å¯¹æ–¹çš„ MAC åœ°å€å‘¢ï¼Ÿ

ä¸çŸ¥é“å¯¹æ–¹ MAC åœ°å€ï¼Ÿä¸çŸ¥é“å°±å–Šå‘—ã€‚

æ­¤æ—¶å°±éœ€è¦ `ARP` åè®®å¸®æˆ‘ä»¬æ‰¾åˆ°è·¯ç”±å™¨çš„ MAC åœ°å€ã€‚

![ARP å¹¿æ’­](./images/19.jpg)

ARP åè®®ä¼šåœ¨ä»¥å¤ªç½‘ä¸­ä»¥**å¹¿æ’­**çš„å½¢å¼ï¼Œå¯¹ä»¥å¤ªç½‘æ‰€æœ‰çš„è®¾å¤‡å–Šå‡ºï¼šâ€œè¿™ä¸ª IP åœ°å€æ˜¯è°çš„ï¼Ÿè¯·æŠŠä½ çš„ MAC åœ°å€å‘Šè¯‰æˆ‘â€ã€‚

ç„¶åå°±ä¼šæœ‰äººå›ç­”ï¼šâ€œè¿™ä¸ª IP åœ°å€æ˜¯æˆ‘çš„ï¼Œæˆ‘çš„ MAC åœ°å€æ˜¯ XXXXâ€ã€‚

å¦‚æœå¯¹æ–¹å’Œè‡ªå·±å¤„äºåŒä¸€ä¸ªå­ç½‘ä¸­ï¼Œé‚£ä¹ˆé€šè¿‡ä¸Šé¢çš„æ“ä½œå°±å¯ä»¥å¾—åˆ°å¯¹æ–¹çš„ MAC åœ°å€ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†è¿™ä¸ª MAC åœ°å€å†™å…¥ MAC å¤´éƒ¨ï¼ŒMAC å¤´éƒ¨å°±å®Œæˆäº†ã€‚

> å¥½åƒæ¯æ¬¡éƒ½è¦å¹¿æ’­è·å–ï¼Œè¿™ä¸æ˜¯å¾ˆéº»çƒ¦å—ï¼Ÿ

æ”¾å¿ƒï¼Œåœ¨åç»­æ“ä½œç³»ç»Ÿä¼šæŠŠæœ¬æ¬¡æŸ¥è¯¢ç»“æœæ”¾åˆ°ä¸€å—å«åš **ARP ç¼“å­˜**çš„å†…å­˜ç©ºé—´ç•™ç€ä»¥åç”¨ï¼Œä¸è¿‡ç¼“å­˜çš„æ—¶é—´å°±å‡ åˆ†é’Ÿã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å‘åŒ…æ—¶ï¼š

- å…ˆæŸ¥è¯¢ ARP ç¼“å­˜ï¼Œå¦‚æœå…¶ä¸­å·²ç»ä¿å­˜äº†å¯¹æ–¹çš„ MAC åœ°å€ï¼Œå°±ä¸éœ€è¦å‘é€ ARP æŸ¥è¯¢ï¼Œç›´æ¥ä½¿ç”¨ ARP ç¼“å­˜ä¸­çš„åœ°å€ã€‚
- è€Œå½“ ARP ç¼“å­˜ä¸­ä¸å­˜åœ¨å¯¹æ–¹ MAC åœ°å€æ—¶ï¼Œåˆ™å‘é€ ARP å¹¿æ’­æŸ¥è¯¢ã€‚

> æŸ¥çœ‹ ARP ç¼“å­˜å†…å®¹

åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `arp -a` å‘½ä»¤æ¥æŸ¥çœ‹ ARP ç¼“å­˜çš„å†…å®¹ã€‚

![ARP ç¼“å­˜å†…å®¹](./images/20.jpg)

> MAC æŠ¥æ–‡ç”Ÿæˆ

è‡³æ­¤ï¼Œç½‘ç»œåŒ…çš„æŠ¥æ–‡å¦‚ä¸‹å›¾ã€‚

![MAC å±‚æŠ¥æ–‡](./images/21.jpg)

> æ­¤æ—¶ï¼ŒåŠ ä¸Šäº† MAC å¤´éƒ¨çš„æ•°æ®åŒ…ä¸‡åˆ†æ„Ÿè°¢ï¼Œè¯´é“ ï¼šâ€œæ„Ÿè°¢ MAC å¤§ä½¬ï¼Œæˆ‘çŸ¥é“æˆ‘ä¸‹ä¸€æ­¥è¦å»å“ªäº†ï¼æˆ‘ç°åœ¨æœ‰å¾ˆå¤šå¤´éƒ¨å…„å¼Ÿï¼Œç›¸ä¿¡æˆ‘å¯ä»¥åˆ°è¾¾æœ€ç»ˆçš„ç›®çš„åœ°ï¼â€ã€‚ å¸¦ç€ä¼—å¤šå¤´éƒ¨å…„å¼Ÿçš„æ•°æ®åŒ…ï¼Œç»ˆäºå‡†å¤‡è¦å‡ºé—¨äº†ã€‚

##### ç½‘å¡

ç½‘ç»œåŒ…åªæ˜¯å­˜æ”¾åœ¨å†…å­˜ä¸­çš„ä¸€ä¸²äºŒè¿›åˆ¶æ•°å­—ä¿¡æ¯ï¼Œæ²¡æœ‰åŠæ³•ç›´æ¥å‘é€ç»™å¯¹æ–¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†**æ•°å­—ä¿¡æ¯è½¬æ¢ä¸ºç”µä¿¡å·**ï¼Œæ‰èƒ½åœ¨ç½‘çº¿ä¸Šä¼ è¾“ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„æ•°æ®å‘é€è¿‡ç¨‹ã€‚

è´Ÿè´£æ‰§è¡Œè¿™ä¸€æ“ä½œçš„æ˜¯**ç½‘å¡**ï¼Œè¦æ§åˆ¶ç½‘å¡è¿˜éœ€è¦é **ç½‘å¡é©±åŠ¨ç¨‹åº**ã€‚

ç½‘å¡é©±åŠ¨è·å–ç½‘ç»œåŒ…ä¹‹åï¼Œä¼šå°†å…¶**å¤åˆ¶**åˆ°ç½‘å¡å†…çš„ç¼“å­˜åŒºä¸­ï¼Œæ¥ç€ä¼šåœ¨å…¶**å¼€å¤´åŠ ä¸ŠæŠ¥å¤´å’Œèµ·å§‹å¸§åˆ†ç•Œç¬¦ï¼Œåœ¨æœ«å°¾åŠ ä¸Šç”¨äºæ£€æµ‹é”™è¯¯çš„å¸§æ ¡éªŒåºåˆ—**ã€‚

![æ•°æ®åŒ…](./images/%E6%95%B0%E6%8D%AE%E5%8C%85.drawio.png)

- èµ·å§‹å¸§åˆ†ç•Œç¬¦æ˜¯ä¸€ä¸ªç”¨æ¥è¡¨ç¤ºåŒ…èµ·å§‹ä½ç½®çš„æ ‡è®°
- æœ«å°¾çš„ `FCS`ï¼ˆå¸§æ ¡éªŒåºåˆ—ï¼‰ç”¨æ¥æ£€æŸ¥åŒ…ä¼ è¾“è¿‡ç¨‹æ˜¯å¦æœ‰æŸå

æœ€åç½‘å¡ä¼šå°†åŒ…è½¬ä¸ºç”µä¿¡å·ï¼Œé€šè¿‡ç½‘çº¿å‘é€å‡ºå»ã€‚

> å”‰ï¼ŒçœŸæ˜¯ä¸å®¹æ˜“ï¼Œå‘ä¸€ä¸ªåŒ…ï¼ŒçœŸæ˜¯å†ç»åƒè¾›ä¸‡è‹¦ã€‚è‡´æ­¤ï¼Œä¸€ä¸ªå¸¦æœ‰è®¸å¤šå¤´éƒ¨çš„æ•°æ®ç»ˆäºè¸ä¸Šå¯»æ‰¾ç›®çš„åœ°çš„å¾é€”äº†ï¼

##### äº¤æ¢æœº

ä¸‹é¢æ¥çœ‹ä¸€ä¸‹åŒ…æ˜¯å¦‚ä½•é€šè¿‡äº¤æ¢æœºçš„ã€‚äº¤æ¢æœºçš„è®¾è®¡æ˜¯å°†ç½‘ç»œåŒ…**åŸæ ·**è½¬å‘åˆ°ç›®çš„åœ°ã€‚äº¤æ¢æœºå·¥ä½œåœ¨ MAC å±‚ï¼Œä¹Ÿç§°ä¸º**äºŒå±‚ç½‘ç»œè®¾å¤‡**ã€‚

> äº¤æ¢æœºçš„åŒ…æ¥æ”¶æ“ä½œ

é¦–å…ˆï¼Œç”µä¿¡å·åˆ°è¾¾ç½‘çº¿æ¥å£ï¼Œäº¤æ¢æœºé‡Œçš„æ¨¡å—è¿›è¡Œæ¥æ”¶ï¼Œæ¥ä¸‹æ¥äº¤æ¢æœºé‡Œçš„æ¨¡å—å°†ç”µä¿¡å·è½¬æ¢ä¸ºæ•°å­—ä¿¡å·ã€‚

ç„¶åé€šè¿‡åŒ…æœ«å°¾çš„ `FCS` æ ¡éªŒé”™è¯¯ï¼Œå¦‚æœæ²¡é—®é¢˜åˆ™æ”¾åˆ°ç¼“å†²åŒºã€‚è¿™éƒ¨åˆ†æ“ä½œåŸºæœ¬å’Œè®¡ç®—æœºçš„ç½‘å¡ç›¸åŒï¼Œä½†äº¤æ¢æœºçš„å·¥ä½œæ–¹å¼å’Œç½‘å¡ä¸åŒã€‚

è®¡ç®—æœºçš„ç½‘å¡æœ¬èº«å…·æœ‰ MAC åœ°å€ï¼Œå¹¶é€šè¿‡æ ¸å¯¹æ”¶åˆ°çš„åŒ…çš„æ¥æ”¶æ–¹ MAC åœ°å€åˆ¤æ–­æ˜¯ä¸æ˜¯å‘ç»™è‡ªå·±çš„ï¼Œå¦‚æœä¸æ˜¯å‘ç»™è‡ªå·±çš„åˆ™ä¸¢å¼ƒï¼›ç›¸å¯¹åœ°ï¼Œäº¤æ¢æœºçš„ç«¯å£ä¸æ ¸å¯¹æ¥æ”¶æ–¹ MAC åœ°å€ï¼Œè€Œæ˜¯ç›´æ¥æ¥æ”¶æ‰€æœ‰çš„åŒ…å¹¶å­˜æ”¾åˆ°ç¼“å†²åŒºä¸­ã€‚å› æ­¤ï¼Œå’Œç½‘å¡ä¸åŒï¼Œ**äº¤æ¢æœºçš„ç«¯å£ä¸å…·æœ‰ MAC åœ°å€**ã€‚

å°†åŒ…å­˜å…¥ç¼“å†²åŒºåï¼Œæ¥ä¸‹æ¥éœ€è¦æŸ¥è¯¢ä¸€ä¸‹è¿™ä¸ªåŒ…çš„æ¥æ”¶æ–¹ MAC åœ°å€æ˜¯å¦å·²ç»åœ¨ MAC åœ°å€è¡¨ä¸­æœ‰è®°å½•äº†ã€‚

äº¤æ¢æœºçš„ MAC åœ°å€è¡¨ä¸»è¦åŒ…å«ä¸¤ä¸ªä¿¡æ¯ï¼š

- ä¸€ä¸ªæ˜¯è®¾å¤‡çš„ MAC åœ°å€ï¼Œ
- å¦ä¸€ä¸ªæ˜¯è¯¥è®¾å¤‡è¿æ¥åœ¨äº¤æ¢æœºçš„å“ªä¸ªç«¯å£ä¸Šã€‚

![äº¤æ¢æœºçš„ MAC åœ°å€è¡¨](./images/23.jpg)

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæ”¶åˆ°çš„åŒ…çš„æ¥æ”¶æ–¹ MAC åœ°å€ä¸º `00-02-B3-1C-9C-F9`ï¼Œåˆ™ä¸å›¾ä¸­è¡¨ä¸­çš„ç¬¬ 3 è¡ŒåŒ¹é…ï¼Œæ ¹æ®ç«¯å£åˆ—çš„ä¿¡æ¯ï¼Œå¯çŸ¥è¿™ä¸ªåœ°å€ä½äº `3` å·ç«¯å£ä¸Šï¼Œç„¶åå°±å¯ä»¥é€šè¿‡äº¤æ¢ç”µè·¯å°†åŒ…å‘é€åˆ°ç›¸åº”çš„ç«¯å£äº†ã€‚

æ‰€ä»¥ï¼Œ**äº¤æ¢æœºæ ¹æ® MAC åœ°å€è¡¨æŸ¥æ‰¾ MAC åœ°å€ï¼Œç„¶åå°†ä¿¡å·å‘é€åˆ°ç›¸åº”çš„ç«¯å£**ã€‚

> å½“ MAC åœ°å€è¡¨æ‰¾ä¸åˆ°æŒ‡å®šçš„ MAC åœ°å€ä¼šæ€ä¹ˆæ ·ï¼Ÿ

åœ°å€è¡¨ä¸­æ‰¾ä¸åˆ°æŒ‡å®šçš„ MAC åœ°å€ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºå…·æœ‰è¯¥åœ°å€çš„è®¾å¤‡è¿˜æ²¡æœ‰å‘äº¤æ¢æœºå‘é€è¿‡åŒ…ï¼Œæˆ–è€…è¿™ä¸ªè®¾å¤‡ä¸€æ®µæ—¶é—´æ²¡æœ‰å·¥ä½œå¯¼è‡´åœ°å€è¢«ä»åœ°å€è¡¨ä¸­åˆ é™¤äº†ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œäº¤æ¢æœºæ— æ³•åˆ¤æ–­åº”è¯¥æŠŠåŒ…è½¬å‘åˆ°å“ªä¸ªç«¯å£ï¼Œåªèƒ½å°†åŒ…è½¬å‘åˆ°é™¤äº†æºç«¯å£ä¹‹å¤–çš„æ‰€æœ‰ç«¯å£ä¸Šï¼Œæ— è®ºè¯¥è®¾å¤‡è¿æ¥åœ¨å“ªä¸ªç«¯å£ä¸Šéƒ½èƒ½æ”¶åˆ°è¿™ä¸ªåŒ…ã€‚

è¿™æ ·åšä¸ä¼šäº§ç”Ÿä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸ºä»¥å¤ªç½‘çš„è®¾è®¡æœ¬æ¥å°±æ˜¯å°†åŒ…å‘é€åˆ°æ•´ä¸ªç½‘ç»œçš„ï¼Œç„¶å**åªæœ‰ç›¸åº”çš„æ¥æ”¶è€…æ‰æ¥æ”¶åŒ…ï¼Œè€Œå…¶ä»–è®¾å¤‡åˆ™ä¼šå¿½ç•¥è¿™ä¸ªåŒ…**ã€‚

æœ‰äººä¼šè¯´ï¼šâ€œè¿™æ ·åšä¼šå‘é€å¤šä½™çš„åŒ…ï¼Œä¼šä¸ä¼šé€ æˆç½‘ç»œæ‹¥å¡å‘¢ï¼Ÿâ€

å…¶å®å®Œå…¨ä¸ç”¨è¿‡äºæ‹…å¿ƒï¼Œå› ä¸ºå‘é€äº†åŒ…ä¹‹åç›®æ ‡è®¾å¤‡ä¼šä½œå‡ºå“åº”ï¼Œåªè¦è¿”å›äº†å“åº”åŒ…ï¼Œäº¤æ¢æœºå°±å¯ä»¥å°†å®ƒçš„åœ°å€å†™å…¥ MAC åœ°å€è¡¨ï¼Œä¸‹æ¬¡ä¹Ÿå°±ä¸éœ€è¦æŠŠåŒ…å‘åˆ°æ‰€æœ‰ç«¯å£äº†ã€‚

å±€åŸŸç½‘ä¸­æ¯ç§’å¯ä»¥ä¼ è¾“ä¸Šåƒä¸ªåŒ…ï¼Œå¤šå‡ºä¸€ä¸¤ä¸ªåŒ…å¹¶æ— å¤§ç¢ã€‚

æ­¤å¤–ï¼Œå¦‚æœæ¥æ”¶æ–¹ MAC åœ°å€æ˜¯ä¸€ä¸ª**å¹¿æ’­åœ°å€**ï¼Œé‚£ä¹ˆäº¤æ¢æœºä¼šå°†åŒ…å‘é€åˆ°é™¤æºç«¯å£ä¹‹å¤–çš„æ‰€æœ‰ç«¯å£ã€‚

ä»¥ä¸‹ä¸¤ä¸ªå±äºå¹¿æ’­åœ°å€ï¼š

- MAC åœ°å€ä¸­çš„ `FF:FF:FF:FF:FF:FF`
- IP åœ°å€ä¸­çš„ `255.255.255.255`

> æ•°æ®åŒ…é€šè¿‡äº¤æ¢æœºè½¬å‘æŠµè¾¾äº†è·¯ç”±å™¨ï¼Œå‡†å¤‡è¦ç¦»å¼€åœŸç”ŸåœŸé•¿çš„å­ç½‘äº†ã€‚æ­¤æ—¶ï¼Œæ•°æ®åŒ…å’Œäº¤æ¢æœºç¦»åˆ«æ—¶è¯´é“ï¼šâ€œæ„Ÿè°¢äº¤æ¢æœºå…„å¼Ÿï¼Œå¸®æˆ‘è½¬å‘åˆ°å‡ºå¢ƒçš„å¤§é—¨ï¼Œæˆ‘è¦å‡ºè¿œé—¨å•¦ï¼â€

##### è·¯ç”±å™¨

> è·¯ç”±å™¨ä¸äº¤æ¢æœºçš„åŒºåˆ«

ç½‘ç»œåŒ…ç»è¿‡äº¤æ¢æœºä¹‹åï¼Œç°åœ¨åˆ°è¾¾äº†**è·¯ç”±å™¨**ï¼Œå¹¶åœ¨æ­¤è¢«è½¬å‘åˆ°ä¸‹ä¸€ä¸ªè·¯ç”±å™¨æˆ–ç›®æ ‡è®¾å¤‡ã€‚

è¿™ä¸€æ­¥è½¬å‘çš„å·¥ä½œåŸç†å’Œäº¤æ¢æœºç±»ä¼¼ï¼Œä¹Ÿæ˜¯é€šè¿‡æŸ¥è¡¨åˆ¤æ–­åŒ…è½¬å‘çš„ç›®æ ‡ã€‚

ä¸è¿‡åœ¨å…·ä½“çš„æ“ä½œè¿‡ç¨‹ä¸Šï¼Œè·¯ç”±å™¨å’Œäº¤æ¢æœºæ˜¯æœ‰åŒºåˆ«çš„ã€‚

- å› ä¸º**è·¯ç”±å™¨**æ˜¯åŸºäº IP è®¾è®¡çš„ï¼Œä¿—ç§°**ä¸‰å±‚**ç½‘ç»œè®¾å¤‡ï¼Œè·¯ç”±å™¨çš„å„ä¸ªç«¯å£éƒ½å…·æœ‰ MAC åœ°å€å’Œ IP åœ°å€ï¼›
- è€Œ**äº¤æ¢æœº**æ˜¯åŸºäºä»¥å¤ªç½‘è®¾è®¡çš„ï¼Œä¿—ç§°**äºŒå±‚**ç½‘ç»œè®¾å¤‡ï¼Œäº¤æ¢æœºçš„ç«¯å£ä¸å…·æœ‰ MAC åœ°å€ã€‚

> è·¯ç”±å™¨åŸºæœ¬åŸç†

è·¯ç”±å™¨çš„ç«¯å£å…·æœ‰ MAC åœ°å€ï¼Œå› æ­¤å®ƒå°±èƒ½å¤Ÿæˆä¸ºä»¥å¤ªç½‘çš„å‘é€æ–¹å’Œæ¥æ”¶æ–¹ï¼›åŒæ—¶è¿˜å…·æœ‰ IP åœ°å€ï¼Œä»è¿™ä¸ªæ„ä¹‰ä¸Šæ¥è¯´ï¼Œå®ƒå’Œè®¡ç®—æœºçš„ç½‘å¡æ˜¯ä¸€æ ·çš„ã€‚

å½“è½¬å‘åŒ…æ—¶ï¼Œé¦–å…ˆè·¯ç”±å™¨ç«¯å£ä¼šæ¥æ”¶å‘ç»™è‡ªå·±çš„ä»¥å¤ªç½‘åŒ…ï¼Œç„¶å**è·¯ç”±è¡¨**æŸ¥è¯¢è½¬å‘ç›®æ ‡ï¼Œå†ç”±ç›¸åº”çš„ç«¯å£ä½œä¸ºå‘é€æ–¹å°†ä»¥å¤ªç½‘åŒ…å‘é€å‡ºå»ã€‚

> è·¯ç”±å™¨çš„åŒ…æ¥æ”¶æ“ä½œ

é¦–å…ˆï¼Œç”µä¿¡å·åˆ°è¾¾ç½‘çº¿æ¥å£éƒ¨åˆ†ï¼Œè·¯ç”±å™¨ä¸­çš„æ¨¡å—ä¼šå°†ç”µä¿¡å·è½¬æˆæ•°å­—ä¿¡å·ï¼Œç„¶åé€šè¿‡åŒ…æœ«å°¾çš„ `FCS` è¿›è¡Œé”™è¯¯æ ¡éªŒã€‚

å¦‚æœæ²¡é—®é¢˜åˆ™æ£€æŸ¥ MAC å¤´éƒ¨ä¸­çš„**æ¥æ”¶æ–¹ MAC åœ°å€**ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å‘ç»™è‡ªå·±çš„åŒ…ï¼Œå¦‚æœæ˜¯å°±æ”¾åˆ°æ¥æ”¶ç¼“å†²åŒºä¸­ï¼Œå¦åˆ™å°±ä¸¢å¼ƒè¿™ä¸ªåŒ…ã€‚

æ€»çš„æ¥è¯´ï¼Œè·¯ç”±å™¨çš„ç«¯å£éƒ½å…·æœ‰ MAC åœ°å€ï¼Œåªæ¥æ”¶ä¸è‡ªèº«åœ°å€åŒ¹é…çš„åŒ…ï¼Œé‡åˆ°ä¸åŒ¹é…çš„åŒ…åˆ™ç›´æ¥ä¸¢å¼ƒã€‚

> æŸ¥è¯¢è·¯ç”±è¡¨ç¡®å®šè¾“å‡ºç«¯å£

å®ŒæˆåŒ…æ¥æ”¶æ“ä½œä¹‹åï¼Œè·¯ç”±å™¨å°±ä¼š**å»æ‰**åŒ…å¼€å¤´çš„ MAC å¤´éƒ¨ã€‚

**MAC å¤´éƒ¨çš„ä½œç”¨å°±æ˜¯å°†åŒ…é€è¾¾è·¯ç”±å™¨**ï¼Œå…¶ä¸­çš„æ¥æ”¶æ–¹ MAC åœ°å€å°±æ˜¯è·¯ç”±å™¨ç«¯å£çš„ MAC åœ°å€ã€‚å› æ­¤ï¼Œå½“åŒ…åˆ°è¾¾è·¯ç”±å™¨ä¹‹åï¼ŒMAC å¤´éƒ¨çš„ä»»åŠ¡å°±å®Œæˆäº†ï¼Œäºæ˜¯ MAC å¤´éƒ¨å°±ä¼š**è¢«ä¸¢å¼ƒ**ã€‚

æ¥ä¸‹æ¥ï¼Œè·¯ç”±å™¨ä¼šæ ¹æ® MAC å¤´éƒ¨åæ–¹çš„ `IP` å¤´éƒ¨ä¸­çš„å†…å®¹è¿›è¡ŒåŒ…çš„è½¬å‘æ“ä½œã€‚

è½¬å‘æ“ä½œåˆ†ä¸ºå‡ ä¸ªé˜¶æ®µï¼Œé¦–å…ˆæ˜¯æŸ¥è¯¢**è·¯ç”±è¡¨**åˆ¤æ–­è½¬å‘ç›®æ ‡ã€‚

![è·¯ç”±å™¨è½¬å‘](./images/24.jpg)

å…·ä½“çš„å·¥ä½œæµç¨‹æ ¹æ®ä¸Šå›¾ï¼Œä¸¾ä¸ªä¾‹å­ã€‚

å‡è®¾åœ°å€ä¸º `10.10.1.101` çš„è®¡ç®—æœºè¦å‘åœ°å€ä¸º `192.168.1.100` çš„æœåŠ¡å™¨å‘é€ä¸€ä¸ªåŒ…ï¼Œè¿™ä¸ªåŒ…å…ˆåˆ°è¾¾å›¾ä¸­çš„è·¯ç”±å™¨ã€‚

åˆ¤æ–­è½¬å‘ç›®æ ‡çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯æ ¹æ®åŒ…çš„æ¥æ”¶æ–¹ IP åœ°å€æŸ¥è¯¢è·¯ç”±è¡¨ä¸­çš„ç›®æ ‡åœ°å€æ ï¼Œä»¥æ‰¾åˆ°ç›¸åŒ¹é…çš„è®°å½•ã€‚

è·¯ç”±åŒ¹é…å’Œå‰é¢è®²çš„ä¸€æ ·ï¼Œæ¯ä¸ªæ¡ç›®çš„å­ç½‘æ©ç å’Œ `192.168.1.100` IP åš **& ä¸è¿ç®—**åï¼Œå¾—åˆ°çš„ç»“æœä¸å¯¹åº”æ¡ç›®çš„ç›®æ ‡åœ°å€è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…å°±ä¼šä½œä¸ºå€™é€‰è½¬å‘ç›®æ ‡ï¼Œå¦‚æœä¸åŒ¹é…å°±ç»§ç»­ä¸ä¸‹ä¸ªæ¡ç›®è¿›è¡Œè·¯ç”±åŒ¹é…ã€‚

å¦‚ç¬¬äºŒæ¡ç›®çš„å­ç½‘æ©ç  `255.255.255.0` ä¸ `192.168.1.100` IP åš **& ä¸è¿ç®—**åï¼Œå¾—åˆ°ç»“æœæ˜¯ `192.168.1.0` ï¼Œè¿™ä¸ç¬¬äºŒæ¡ç›®çš„ç›®æ ‡åœ°å€ `192.168.1.0` åŒ¹é…ï¼Œè¯¥ç¬¬äºŒæ¡ç›®è®°å½•å°±ä¼šè¢«ä½œä¸ºè½¬å‘ç›®æ ‡ã€‚

å®åœ¨æ‰¾ä¸åˆ°åŒ¹é…è·¯ç”±æ—¶ï¼Œå°±ä¼šé€‰æ‹©**é»˜è®¤è·¯ç”±**ï¼Œè·¯ç”±è¡¨ä¸­å­ç½‘æ©ç ä¸º `0.0.0.0` çš„è®°å½•è¡¨ç¤ºã€Œé»˜è®¤è·¯ç”±ã€ã€‚

> è·¯ç”±å™¨çš„å‘é€æ“ä½œ

æ¥ä¸‹æ¥å°±ä¼šè¿›å…¥åŒ…çš„**å‘é€æ“ä½œ**ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®**è·¯ç”±è¡¨çš„ç½‘å…³åˆ—**åˆ¤æ–­å¯¹æ–¹çš„åœ°å€ã€‚

- å¦‚æœç½‘å…³æ˜¯ä¸€ä¸ª IP åœ°å€ï¼Œåˆ™è¿™ä¸ªIP åœ°å€å°±æ˜¯æˆ‘ä»¬è¦è½¬å‘åˆ°çš„ç›®æ ‡åœ°å€ï¼Œ**è¿˜æœªæŠµè¾¾ç»ˆç‚¹**ï¼Œè¿˜éœ€ç»§ç»­éœ€è¦è·¯ç”±å™¨è½¬å‘ã€‚
- å¦‚æœç½‘å…³ä¸ºç©ºï¼Œåˆ™ IP å¤´éƒ¨ä¸­çš„æ¥æ”¶æ–¹ IP åœ°å€å°±æ˜¯è¦è½¬å‘åˆ°çš„ç›®æ ‡åœ°å€ï¼Œä¹Ÿæ˜¯å°±ç»ˆäºæ‰¾åˆ° IP åŒ…å¤´é‡Œçš„ç›®æ ‡åœ°å€äº†ï¼Œè¯´æ˜**å·²æŠµè¾¾ç»ˆç‚¹**ã€‚

çŸ¥é“å¯¹æ–¹çš„ IP åœ°å€ä¹‹åï¼Œæ¥ä¸‹æ¥éœ€è¦é€šè¿‡ `ARP` åè®®æ ¹æ® IP åœ°å€æŸ¥è¯¢ MAC åœ°å€ï¼Œå¹¶å°†æŸ¥è¯¢çš„ç»“æœä½œä¸ºæ¥æ”¶æ–¹ MAC åœ°å€ã€‚

è·¯ç”±å™¨ä¹Ÿæœ‰ ARP ç¼“å­˜ï¼Œå› æ­¤é¦–å…ˆä¼šåœ¨ ARP ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™å‘é€ ARP æŸ¥è¯¢è¯·æ±‚ã€‚

æ¥ä¸‹æ¥æ˜¯å‘é€æ–¹ MAC åœ°å€å­—æ®µï¼Œè¿™é‡Œå¡«å†™è¾“å‡ºç«¯å£çš„ MAC åœ°å€ã€‚è¿˜æœ‰ä¸€ä¸ªä»¥å¤ªç±»å‹å­—æ®µï¼Œå¡«å†™ `0800` ï¼ˆåå…­è¿›åˆ¶ï¼‰è¡¨ç¤º IP åè®®ã€‚

ç½‘ç»œåŒ…å®Œæˆåï¼Œæ¥ä¸‹æ¥ä¼šå°†å…¶è½¬æ¢æˆç”µä¿¡å·å¹¶é€šè¿‡ç«¯å£å‘é€å‡ºå»ã€‚è¿™ä¸€æ­¥çš„å·¥ä½œè¿‡ç¨‹å’Œè®¡ç®—æœºä¹Ÿæ˜¯ç›¸åŒçš„ã€‚

å‘é€å‡ºå»çš„ç½‘ç»œåŒ…ä¼šé€šè¿‡**äº¤æ¢æœº**åˆ°è¾¾ä¸‹ä¸€ä¸ªè·¯ç”±å™¨ã€‚ç”±äºæ¥æ”¶æ–¹ MAC åœ°å€å°±æ˜¯ä¸‹ä¸€ä¸ªè·¯ç”±å™¨çš„åœ°å€ï¼Œæ‰€ä»¥äº¤æ¢æœºä¼šæ ¹æ®è¿™ä¸€åœ°å€å°†åŒ…ä¼ è¾“åˆ°ä¸‹ä¸€ä¸ªè·¯ç”±å™¨ã€‚

æ¥ä¸‹æ¥ï¼Œä¸‹ä¸€ä¸ªè·¯ç”±å™¨ä¼šå°†åŒ…è½¬å‘ç»™å†ä¸‹ä¸€ä¸ªè·¯ç”±å™¨ï¼Œç»è¿‡å±‚å±‚è½¬å‘ä¹‹åï¼Œç½‘ç»œåŒ…å°±åˆ°è¾¾äº†æœ€ç»ˆçš„ç›®çš„åœ°ã€‚

ä¸çŸ¥ä½ å‘ç°äº†æ²¡æœ‰ï¼Œåœ¨ç½‘ç»œåŒ…ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œ**æº IP å’Œç›®æ ‡ IP å§‹ç»ˆæ˜¯ä¸ä¼šå˜çš„ï¼Œä¸€ç›´å˜åŒ–çš„æ˜¯ MAC åœ°å€**ï¼Œå› ä¸ºéœ€è¦ MAC åœ°å€åœ¨ä»¥å¤ªç½‘å†…è¿›è¡Œ**ä¸¤ä¸ªè®¾å¤‡**ä¹‹é—´çš„åŒ…ä¼ è¾“ã€‚

> æ•°æ®åŒ…é€šè¿‡å¤šä¸ªè·¯ç”±å™¨é“å‹çš„å¸®åŠ©ï¼Œåœ¨ç½‘ç»œä¸–ç•Œé€”ç»äº†å¾ˆå¤šè·¯ç¨‹ï¼Œæœ€ç»ˆæŠµè¾¾äº†ç›®çš„åœ°çš„åŸé—¨ï¼åŸé—¨å€¼å®ˆçš„è·¯ç”±å™¨ï¼Œå‘ç°äº†è¿™ä¸ªå°å…„å¼Ÿæ•°æ®åŒ…åŸæ¥æ˜¯æ‰¾åŸå†…çš„äººï¼Œäºæ˜¯å®ƒå°±å°†æ•°æ®åŒ…é€è¿›äº†åŸå†…ï¼Œå†ç»ç”±åŸå†…çš„äº¤æ¢æœºå¸®åŠ©ä¸‹ï¼Œæœ€ç»ˆè½¬å‘åˆ°äº†ç›®çš„åœ°äº†ã€‚æ•°æ®åŒ…æ„Ÿæ…¨ä¸‡åƒçš„è¯´é“ï¼šâ€œå¤šè°¢è¿™ä¸€è·¯ä¸Šï¼Œå„è·¯å¤§ä¾ çš„ç›¸åŠ©ï¼â€

##### æœåŠ¡å™¨ ä¸ å®¢æˆ·ç«¯

æ•°æ®åŒ…æŠµè¾¾äº†æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è‚¯å®šé«˜å…´å‘€ï¼Œæ­£æ‰€è°“æœ‰æœ‹è‡ªè¿œæ–¹æ¥ï¼Œä¸äº¦ä¹ä¹ï¼Ÿ

æœåŠ¡å™¨é«˜å…´çš„ä¸å¾—äº†ï¼Œäºæ˜¯å¼€å§‹æ‰’æ•°æ®åŒ…çš„çš®ï¼å°±å¥½åƒä½ æ”¶åˆ°å¿«é€’ï¼Œèƒ½ä¸å…´å¥‹å—ï¼Ÿ

![ç½‘ç»œåˆ†å±‚æ¨¡å‹](./images/25.jpg)

æ•°æ®åŒ…æŠµè¾¾æœåŠ¡å™¨åï¼ŒæœåŠ¡å™¨ä¼šå…ˆæ‰’å¼€æ•°æ®åŒ…çš„ MAC å¤´éƒ¨ï¼ŒæŸ¥çœ‹æ˜¯å¦å’ŒæœåŠ¡å™¨è‡ªå·±çš„ MAC åœ°å€ç¬¦åˆï¼Œç¬¦åˆå°±å°†åŒ…æ”¶èµ·æ¥ã€‚

æ¥ç€ç»§ç»­æ‰’å¼€æ•°æ®åŒ…çš„ IP å¤´ï¼Œå‘ç° IP åœ°å€ç¬¦åˆï¼Œæ ¹æ® IP å¤´ä¸­åè®®é¡¹ï¼ŒçŸ¥é“è‡ªå·±ä¸Šå±‚æ˜¯ TCP åè®®ã€‚

äºæ˜¯ï¼Œæ‰’å¼€ TCP çš„å¤´ï¼Œé‡Œé¢æœ‰åºåˆ—å·ï¼Œéœ€è¦çœ‹ä¸€çœ‹è¿™ä¸ªåºåˆ—åŒ…æ˜¯ä¸æ˜¯æˆ‘æƒ³è¦çš„ï¼Œå¦‚æœæ˜¯å°±æ”¾å…¥ç¼“å­˜ä¸­ç„¶åè¿”å›ä¸€ä¸ª ACKï¼Œå¦‚æœä¸æ˜¯å°±ä¸¢å¼ƒã€‚TCPå¤´éƒ¨é‡Œé¢è¿˜æœ‰ç«¯å£å·ï¼Œ HTTP çš„æœåŠ¡å™¨æ­£åœ¨ç›‘å¬è¿™ä¸ªç«¯å£å·ã€‚

äºæ˜¯ï¼ŒæœåŠ¡å™¨è‡ªç„¶å°±çŸ¥é“æ˜¯ HTTP è¿›ç¨‹æƒ³è¦è¿™ä¸ªåŒ…ï¼Œäºæ˜¯å°±å°†åŒ…å‘ç»™ HTTP è¿›ç¨‹ã€‚

æœåŠ¡å™¨çš„ HTTP è¿›ç¨‹çœ‹åˆ°ï¼ŒåŸæ¥è¿™ä¸ªè¯·æ±‚æ˜¯è¦è®¿é—®ä¸€ä¸ªé¡µé¢ï¼Œäºæ˜¯å°±æŠŠè¿™ä¸ªç½‘é¡µå°è£…åœ¨ HTTP å“åº”æŠ¥æ–‡é‡Œã€‚

HTTP å“åº”æŠ¥æ–‡ä¹Ÿéœ€è¦ç©¿ä¸Š TCPã€IPã€MAC å¤´éƒ¨ï¼Œä¸è¿‡è¿™æ¬¡æ˜¯æºåœ°å€æ˜¯æœåŠ¡å™¨ IP åœ°å€ï¼Œç›®çš„åœ°å€æ˜¯å®¢æˆ·ç«¯ IP åœ°å€ã€‚

ç©¿å¥½å¤´éƒ¨è¡£æœåï¼Œä»ç½‘å¡å‡ºå»ï¼Œäº¤ç”±äº¤æ¢æœºè½¬å‘åˆ°å‡ºåŸçš„è·¯ç”±å™¨ï¼Œè·¯ç”±å™¨å°±æŠŠå“åº”æ•°æ®åŒ…å‘åˆ°äº†ä¸‹ä¸€ä¸ªè·¯ç”±å™¨ï¼Œå°±è¿™æ ·è·³å•Šè·³ã€‚

æœ€åè·³åˆ°äº†å®¢æˆ·ç«¯çš„åŸé—¨æŠŠå®ˆçš„è·¯ç”±å™¨ï¼Œè·¯ç”±å™¨æ‰’å¼€ IP å¤´éƒ¨å‘ç°æ˜¯è¦æ‰¾åŸå†…çš„äººï¼Œäºæ˜¯åˆæŠŠåŒ…å‘ç»™äº†åŸå†…çš„äº¤æ¢æœºï¼Œå†ç”±äº¤æ¢æœºè½¬å‘åˆ°å®¢æˆ·ç«¯ã€‚

å®¢æˆ·ç«¯æ”¶åˆ°äº†æœåŠ¡å™¨çš„å“åº”æ•°æ®åŒ…åï¼ŒåŒæ ·ä¹Ÿéå¸¸çš„é«˜å…´ï¼Œå®¢æˆ·èƒ½æ‹†å¿«é€’äº†ï¼

äºæ˜¯ï¼Œå®¢æˆ·ç«¯å¼€å§‹æ‰’çš®ï¼ŒæŠŠæ”¶åˆ°çš„æ•°æ®åŒ…çš„çš®æ‰’å‰© HTTP å“åº”æŠ¥æ–‡åï¼Œäº¤ç»™æµè§ˆå™¨å»æ¸²æŸ“é¡µé¢ï¼Œä¸€ä»½ç‰¹åˆ«çš„æ•°æ®åŒ…å¿«é€’ï¼Œå°±è¿™æ ·æ˜¾ç¤ºå‡ºæ¥äº†ï¼

æœ€åï¼Œå®¢æˆ·ç«¯è¦ç¦»å¼€äº†ï¼Œå‘æœåŠ¡å™¨å‘èµ·äº† TCP å››æ¬¡æŒ¥æ‰‹ï¼Œè‡³æ­¤åŒæ–¹çš„è¿æ¥å°±æ–­å¼€äº†ã€‚

##### æ•°æ®åŒ…

> ä¸‹é¢å†…å®¹çš„ ã€Œæˆ‘ã€ï¼Œä»£è¡¨ã€Œè‡­ç¾çš„æ•°æ®åŒ…è§’è‰²ã€ã€‚æ³¨ï¼šï¼ˆæ‹¬å·çš„å†…å®¹ï¼‰ä»£è¡¨æˆ‘çš„åæ§½ï¼Œä¸‰è¿å‘¸ï¼

æˆ‘ä¸€å¼€å§‹æˆ‘è™½ç„¶å­¤å•ã€ä¸çŸ¥æ‰€æªï¼Œä½†æ²¡æœ‰åœæ»ä¸å‰ã€‚æˆ‘ä¾ç„¶æ»¡æ€€ä¿¡å¿ƒå’Œå‹‡æ°”å¼€å§‹äº†å¾é€”ã€‚ï¼ˆ**ä½ å½“ç„¶æœ‰å‹‡æ°”ï¼Œä½ æ˜¯åº”ç”¨å±‚æ•°æ®ï¼Œåé¢æœ‰åº•å±‚å…„å¼Ÿå½“é å±±ï¼Œæˆ‘å‘¸ï¼**ï¼‰

æˆ‘å¾ˆåº†å¹¸é‡åˆ°äº†å„è·¯ç¥é€šå¹¿å¤§çš„å¤§ä½¬ï¼Œæœ‰å¯é ä¼ è¾“çš„ TCPã€æœ‰è¿œç¨‹å®šä½åŠŸèƒ½çš„ IPã€æœ‰æŒ‡æ˜ä¸‹ä¸€ç«™ä½ç½®çš„ MAC ç­‰ï¼ˆ**ä½ å½“ç„¶ä¼šé‡åˆ°ï¼Œå› ä¸ºéƒ½è¢«è®¡ç®—æœºå®‰æ’å¥½çš„ï¼Œæˆ‘å‘¸ï¼**ï¼‰ã€‚

è¿™äº›å¤§ä½¬éƒ½ç»™æˆ‘å‰é¢åŠ ä¸Šäº†å¤´éƒ¨ï¼Œä½¿å¾—æˆ‘èƒ½åœ¨äº¤æ¢æœºå’Œè·¯ç”±å™¨çš„è½¬å‘ä¸‹ï¼ŒæŠµè¾¾åˆ°äº†ç›®çš„åœ°ï¼ï¼ˆ**å“ï¼Œä½ ä¹Ÿä¸å®¹æ˜“ï¼Œä¸åæ§½äº†ï¼Œæ”¾è¿‡ä½ ï¼**ï¼‰

è¿™ä¸€è·¯ä¸Šçš„ç»å†ï¼Œè®©æˆ‘è®¤è¯†åˆ°äº†ç½‘ç»œä¸–ç•Œä¸­å„è·¯å¤§ä¾ åä½œçš„é‡è¦æ€§ï¼Œæ˜¯ä»–ä»¬ç»´æŠ¤äº†ç½‘ç»œä¸–ç•Œçš„ç§©åºï¼Œæ„Ÿè°¢ä»–ä»¬ï¼ï¼ˆ**æˆ‘å‘¸ï¼Œä½ åº”è¯¥æ„Ÿè°¢ä¼—å¤šè®¡ç®—æœºç§‘å­¦å®¶ï¼**ï¼‰

#### TCPå¦‚ä½•ä¿è¯å¯é ä¼ è¾“ï¼Ÿ

1. åº”ç”¨æ•°æ®è¢«åˆ†å‰²æˆ TCP è®¤ä¸ºæœ€é€‚åˆå‘é€çš„æ•°æ®å—ã€‚
2. TCP ç»™å‘é€çš„æ¯ä¸€ä¸ªåŒ…è¿›è¡Œç¼–å·ï¼Œæ¥æ”¶æ–¹å¯¹æ•°æ®åŒ…è¿›è¡Œæ’åºï¼ŒæŠŠæœ‰åºæ•°æ®ä¼ é€ç»™åº”ç”¨å±‚ã€‚
3. **æ ¡éªŒå’Œï¼š** TCP å°†ä¿æŒå®ƒé¦–éƒ¨å’Œæ•°æ®çš„æ£€éªŒå’Œã€‚è¿™æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ£€éªŒå’Œï¼Œç›®çš„æ˜¯æ£€æµ‹æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„ä»»ä½•å˜åŒ–ã€‚å¦‚æœæ”¶åˆ°æ®µçš„æ£€éªŒå’Œæœ‰å·®é”™ï¼ŒTCP å°†ä¸¢å¼ƒè¿™ä¸ªæŠ¥æ–‡æ®µå’Œä¸ç¡®è®¤æ”¶åˆ°æ­¤æŠ¥æ–‡æ®µã€‚
4. TCP çš„æ¥æ”¶ç«¯ä¼šä¸¢å¼ƒé‡å¤çš„æ•°æ®ã€‚
5. **æµé‡æ§åˆ¶ï¼š** TCP è¿æ¥çš„æ¯ä¸€æ–¹éƒ½æœ‰å›ºå®šå¤§å°çš„ç¼“å†²ç©ºé—´ï¼ŒTCP  çš„æ¥æ”¶ç«¯åªå…è®¸å‘é€ç«¯å‘é€æ¥æ”¶ç«¯ç¼“å†²åŒºèƒ½æ¥çº³çš„æ•°æ®ã€‚å½“æ¥æ”¶æ–¹æ¥ä¸åŠå¤„ç†å‘é€æ–¹çš„æ•°æ®ï¼Œèƒ½æç¤ºå‘é€æ–¹é™ä½å‘é€çš„é€Ÿç‡ï¼Œé˜²æ­¢åŒ…ä¸¢å¤±ã€‚TCP  ä½¿ç”¨çš„æµé‡æ§åˆ¶åè®®æ˜¯å¯å˜å¤§å°çš„æ»‘åŠ¨çª—å£åè®®ã€‚ ï¼ˆTCP åˆ©ç”¨æ»‘åŠ¨çª—å£å®ç°æµé‡æ§åˆ¶ï¼‰
6. **æ‹¥å¡æ§åˆ¶ï¼š** å½“ç½‘ç»œæ‹¥å¡æ—¶ï¼Œå‡å°‘æ•°æ®çš„å‘é€ã€‚
7. **ARQ åè®®ï¼š** ä¹Ÿæ˜¯ä¸ºäº†å®ç°å¯é ä¼ è¾“çš„ï¼Œå®ƒçš„åŸºæœ¬åŸç†å°±æ˜¯æ¯å‘å®Œä¸€ä¸ªåˆ†ç»„å°±åœæ­¢å‘é€ï¼Œç­‰å¾…å¯¹æ–¹ç¡®è®¤ã€‚åœ¨æ”¶åˆ°ç¡®è®¤åå†å‘ä¸‹ä¸€ä¸ªåˆ†ç»„ã€‚
8. **è¶…æ—¶é‡ä¼ ï¼š** å½“ TCP å‘å‡ºä¸€ä¸ªæ®µåï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç­‰å¾…ç›®çš„ç«¯ç¡®è®¤æ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡æ®µã€‚å¦‚æœä¸èƒ½åŠæ—¶æ”¶åˆ°ä¸€ä¸ªç¡®è®¤ï¼Œå°†é‡å‘è¿™ä¸ªæŠ¥æ–‡æ®µã€‚

#### â­ï¸TCP ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ï¼ˆ+++æé™æ‹“å±•ï¼‰

è¯¦ç»†å¯è§ï¼šhttps://xiaolincoding.com/network/3_tcp/tcp_interview.html#tcp-%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B

> å‰ææ¦‚è¦ï¼š
>
> *SYNï¼ˆåŒæ­¥åºåˆ—ç¼–å· **Synchronize Sequence Numbers** ï¼‰*ï¼šè¯¥ä½ä¸º `1` æ—¶ï¼Œè¡¨ç¤ºå¸Œæœ›å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨å…¶ã€Œåºåˆ—å·ã€çš„å­—æ®µè¿›è¡Œåºåˆ—å·åˆå§‹å€¼çš„è®¾å®šã€‚
>
> *ACKï¼ˆç¡®è®¤å­—ç¬¦ **Acknowledge character**ï¼‰*ï¼šè¯¥ä½ä¸º `1` æ—¶ï¼Œã€Œç¡®è®¤åº”ç­”ã€çš„å­—æ®µå˜ä¸ºæœ‰æ•ˆï¼ŒTCP è§„å®šé™¤äº†æœ€åˆå»ºç«‹è¿æ¥æ—¶çš„ `SYN` åŒ…ä¹‹å¤–è¯¥ä½å¿…é¡»è®¾ç½®ä¸º `1` ã€‚

![image-20220622162158478](./images/image-20220622162158478.png)

- å®¢æˆ·ç«¯â€“å‘é€å¸¦æœ‰ SYN æ ‡å¿—çš„æ•°æ®åŒ…â€“ä¸€æ¬¡æ¡æ‰‹â€“æœåŠ¡ç«¯
- æœåŠ¡ç«¯â€“å‘é€å¸¦æœ‰ SYN/ACK æ ‡å¿—çš„æ•°æ®åŒ…â€“äºŒæ¬¡æ¡æ‰‹â€“å®¢æˆ·ç«¯
- å®¢æˆ·ç«¯â€“å‘é€å¸¦æœ‰å¸¦æœ‰ ACK æ ‡å¿—çš„æ•°æ®åŒ…â€“ä¸‰æ¬¡æ¡æ‰‹â€“æœåŠ¡ç«¯

or å¯ä»¥è¿™æ ·å›ç­”ğŸ§â€â™‚ï¸ï¼š

1. ç¬¬ä¸€æ¬¡æ¡æ‰‹ğŸ¤ï¼šå®¢æˆ·ç«¯ç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ª SYN æŠ¥æ–‡ã€‚
2. ç¬¬äºŒæ¬¡æ¡æ‰‹ğŸ¤ï¼šæœåŠ¡å™¨æ”¶åˆ° SYN æŠ¥æ–‡ä¹‹åï¼Œä¼šåº”ç­”ä¸€ä¸ª SYN+ACK æŠ¥æ–‡ã€‚
3. ç¬¬ä¸‰æ¬¡æ¡æ‰‹ğŸ¤ï¼šå®¢æˆ·ç«¯æ”¶åˆ° SYN+ACK æŠ¥æ–‡ä¹‹åï¼Œä¼šå›åº”ä¸€ä¸ª ACK æŠ¥æ–‡ã€‚

æœåŠ¡å™¨æ”¶åˆ° ACK æŠ¥æ–‡ä¹‹åï¼Œä¸‰æ¬¡æ¡æ‰‹å»ºç«‹å®Œæˆã€‚

> å¼ºåŒ–ç†è§£ï¼š
>
> Aï¼šæ˜¯Bå—ï¼Ÿæˆ‘è¦è·Ÿä½ é€šä¿¡ï¼Œå¬å¾—åˆ°æˆ‘è¯´è¯å—ï¼Ÿ
> Bï¼šå¯ä»¥é€šä¿¡ï¼Œä½ å¬å¾—åˆ°æˆ‘è¯´è¯å—ï¼Ÿ
> Aï¼šæˆ‘ä¹Ÿå¬å¾—åˆ°ã€‚

> å‰ææ¦‚è¦ï¼š
>
> *FINï¼ˆç»ˆæ­¢ **FINish**ï¼‰*ï¼šè¯¥ä½ä¸º `1` æ—¶ï¼Œè¡¨ç¤ºä»Šåä¸ä¼šå†æœ‰æ•°æ®å‘é€ï¼Œå¸Œæœ›æ–­å¼€è¿æ¥ã€‚å½“é€šä¿¡ç»“æŸå¸Œæœ›æ–­å¼€è¿æ¥æ—¶ï¼Œé€šä¿¡åŒæ–¹çš„ä¸»æœºä¹‹é—´å°±å¯ä»¥ç›¸äº’äº¤æ¢ `FIN` ä½ä¸º 1 çš„ TCP æ®µã€‚

![image-20220622171739797](./images/image-20220622171739797.png)

- å®¢æˆ·ç«¯-å‘é€ä¸€ä¸ª FINï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ•°æ®ä¼ é€
- æœåŠ¡å™¨-æ”¶åˆ°è¿™ä¸ª FINï¼Œå®ƒå‘å›ä¸€ä¸ª ACKï¼Œç¡®è®¤åºå·ä¸ºæ”¶åˆ°çš„åºå·åŠ  1 ã€‚å’Œ SYN ä¸€æ ·ï¼Œä¸€ä¸ª FIN å°†å ç”¨ä¸€ä¸ªåºå·
- æœåŠ¡å™¨-å…³é—­ä¸å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå‘é€ä¸€ä¸ª FIN ç»™å®¢æˆ·ç«¯
- å®¢æˆ·ç«¯-å‘å› ACK æŠ¥æ–‡ç¡®è®¤ï¼Œå¹¶å°†ç¡®è®¤åºå·è®¾ç½®ä¸ºæ”¶åˆ°åºå·åŠ  1

> å¼ºåŒ–ç†è§£ï¼š
>
> Aï¼šå‘¼å«Bï¼Œæˆ‘è¦è·Ÿä½ æ–­å¼€ã€‚
> Bï¼šçŸ¥é“äº†ï¼Œç­‰ä¸€ä¸‹æˆ‘è¿˜æœ‰è¯æ²¡è¯´å®Œ
> Bï¼šæˆ‘è¯´å®Œäº†ï¼Œå¯ä»¥æ–­å¼€äº†
> Aï¼šå¥½çš„
>
> ---
>
> Aï¼šå›°äº†ï¼Œåœ¨å¹²å˜›ï¼Ÿ
> Bï¼šåœ¨åˆ·è§†é¢‘ã€‚
> Bï¼šä½ è¦ç¡äº†å—ï¼Ÿ
> Aï¼šå¯¹ï¼Œæ™šå®‰ã€‚ï¼ˆç­‰å¥¹çœ‹åˆ°æ¶ˆæ¯å®‰å¿ƒå…¥ç¡ï¼‰

##### æé™æ‹“å±•

å¯ä»¥å…ˆè§‚çœ‹ï¼š[ä¸€æ¡è§†é¢‘è®²æ¸…æ¥šTCPåè®®ä¸UDPåè®®-ä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹](https://www.bilibili.com/video/BV1kV411j7hA?vd_source=e300c0e56286b6c321abd6aac8da8682)

> ä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿä¸¤æ¬¡ä¸è¡Œï¼Ÿ

* ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ç½‘ç»œåŒ…ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±èƒ½å¾—å‡ºç»“è®ºï¼šå®¢æˆ·ç«¯çš„å‘é€èƒ½åŠ›ã€æœåŠ¡ç«¯çš„æ¥æ”¶èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚
* ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šæœåŠ¡ç«¯å‘åŒ…ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°äº†ã€‚è¿™æ ·å®¢æˆ·ç«¯å°±èƒ½å¾—å‡ºç»“è®ºï¼šæœåŠ¡ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›ï¼Œå®¢æˆ·ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›æ˜¯æ­£å¸¸çš„ã€‚ä¸è¿‡æ­¤æ—¶æœåŠ¡å™¨å¹¶ä¸èƒ½ç¡®è®¤å®¢æˆ·ç«¯çš„æ¥æ”¶èƒ½åŠ›æ˜¯å¦æ­£å¸¸ã€‚
* ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šå®¢æˆ·ç«¯å‘åŒ…ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±èƒ½å¾—å‡ºç»“è®ºï¼šå®¢æˆ·ç«¯çš„æ¥æ”¶ã€å‘é€èƒ½åŠ›æ­£å¸¸ï¼ŒæœåŠ¡å™¨è‡ªå·±çš„å‘é€ã€æ¥æ”¶èƒ½åŠ›ä¹Ÿæ­£å¸¸ã€‚

å› æ­¤ï¼Œéœ€è¦ä¸‰æ¬¡æ¡æ‰‹æ‰èƒ½ç¡®è®¤åŒæ–¹çš„æ¥æ”¶ä¸å‘é€èƒ½åŠ›æ˜¯å¦æ­£å¸¸ã€‚

> ä¸ºä»€ä¹ˆéœ€è¦å››æ¬¡æŒ¥æ‰‹ï¼Ÿä¸‰æ¬¡ä¸è¡Œï¼Ÿ

å¯ä»¥åŠ å…¥çŸ¥ä¹è®¨è®ºï¼šhttps://www.zhihu.com/question/50646354

åˆšå¼€å§‹åŒæ–¹éƒ½å¤„äº establised çŠ¶æ€ï¼Œå‡å¦‚æ˜¯å®¢æˆ·ç«¯å…ˆå‘èµ·å…³é—­è¯·æ±‚ï¼Œåˆ™ï¼š

1. ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ª FIN æŠ¥æ–‡ï¼ŒæŠ¥æ–‡ä¸­ä¼šæŒ‡å®šä¸€ä¸ªåºåˆ—å·ã€‚æ­¤æ—¶å®¢æˆ·ç«¯å¤„äºFIN_WAIT1çŠ¶æ€ã€‚
2. ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡ç«¯æ”¶åˆ° FIN ä¹‹åï¼Œä¼šå‘é€ ACK æŠ¥æ–‡ï¼Œä¸”æŠŠå®¢æˆ·ç«¯çš„åºåˆ—å·å€¼ + 1 ä½œä¸º ACK æŠ¥æ–‡çš„åºåˆ—å·å€¼ï¼Œè¡¨æ˜å·²ç»æ”¶åˆ°å®¢æˆ·ç«¯çš„æŠ¥æ–‡äº†ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å¤„äº CLOSE_WAITçŠ¶æ€ã€‚
3. ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šå¦‚æœæœåŠ¡ç«¯ä¹Ÿæƒ³æ–­å¼€è¿æ¥äº†ï¼Œå’Œå®¢æˆ·ç«¯çš„ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ä¸€æ ·ï¼Œå‘ç»™ FIN æŠ¥æ–‡ï¼Œä¸”æŒ‡å®šä¸€ä¸ªåºåˆ—å·ã€‚æ­¤æ—¶æœåŠ¡ç«¯å¤„äº LAST_ACK çš„çŠ¶æ€ã€‚
4. ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ° FIN ä¹‹åï¼Œä¸€æ ·å‘é€ä¸€ä¸ª ACK æŠ¥æ–‡ä½œä¸ºåº”ç­”ï¼Œä¸”æŠŠæœåŠ¡ç«¯çš„åºåˆ—å·å€¼ + 1 ä½œä¸ºè‡ªå·± ACK æŠ¥æ–‡çš„åºåˆ—å·å€¼ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¤„äº TIME_WAIT çŠ¶æ€ã€‚éœ€è¦è¿‡ä¸€é˜µå­ä»¥ç¡®ä¿æœåŠ¡ç«¯æ”¶åˆ°è‡ªå·±çš„ ACK æŠ¥æ–‡ä¹‹åæ‰ä¼šè¿›å…¥ CLOSED çŠ¶æ€
5. æœåŠ¡ç«¯æ”¶åˆ° ACK æŠ¥æ–‡ä¹‹åï¼Œå°±å¤„äºå…³é—­è¿æ¥äº†ï¼Œå¤„äº CLOSED çŠ¶æ€ã€‚

> ä¸ºä»€ä¹ˆç¬¬äºŒæ¬¡æŒ¥æ‰‹å’Œç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ä¸èƒ½åƒæ¡æ‰‹ä¸€æ ·åœ¨åŒä¸€ä¸ªåŒ…ä¸­è®¾ç½® ACK å’Œ SYNï¼Ÿ

https://stackoverflow.com/questions/46212623/why-tcp-termination-need-4-way-handshake

å›ç­”æ¥è‡ªï¼šhttp://www.tcpipguide.com/index.htm

åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¯ä¸€æ–¹é€šè¿‡å‘é€ä¸€ä¸ªè®¾ç½®äº†FINï¼ˆç»“æŸï¼‰ä½çš„ç‰¹æ®Šæ¶ˆæ¯æ¥ç»ˆæ­¢å…¶è¿æ¥çš„æœ«ç«¯ã€‚è¿™ä¸ªæ¶ˆæ¯ï¼Œæœ‰æ—¶è¢«ç§°ä¸ºFINï¼Œä½œä¸ºå¯¹å¦ä¸€è®¾å¤‡çš„è¿æ¥ç»ˆæ­¢è¯·æ±‚ï¼ŒåŒæ—¶ä¹Ÿå¯èƒ½åƒæ™®é€šç½‘æ®µä¸€æ ·æºå¸¦æ•°æ®ã€‚æ”¶åˆ°FINçš„è®¾å¤‡ä¼šå¯¹FINè¿›è¡Œç¡®è®¤ï¼Œä»¥è¡¨ç¤ºæ”¶åˆ°äº†å®ƒã€‚åœ¨åŒæ–¹é€šè¿‡å‘é€FINå’Œæ¥æ”¶ACKå®Œæˆå…³é—­ç¨‹åºä¹‹å‰ï¼Œæ•´ä¸ªè¿æ¥ä¸è¢«è®¤ä¸ºæ˜¯ç»ˆæ­¢çš„ã€‚
å› æ­¤ï¼Œç»ˆæ­¢å¹¶ä¸åƒå»ºç«‹é‚£æ ·æ˜¯ä¸€ä¸ªä¸‰æ–¹æ¡æ‰‹ï¼šå®ƒæ˜¯ä¸€å¯¹åŒå‘æ¡æ‰‹ã€‚åœ¨æ­£å¸¸çš„è¿æ¥å…³é—­è¿‡ç¨‹ä¸­ï¼Œè¿æ¥ä¸­çš„ä¸¤ä¸ªè®¾å¤‡æ‰€ç»å†çš„çŠ¶æ€æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºå‘èµ·å…³é—­çš„è®¾å¤‡çš„è¡Œä¸ºå¿…é¡»ä¸æ¥æ”¶ç»ˆæ­¢è¯·æ±‚çš„è®¾å¤‡ä¸åŒã€‚ç‰¹åˆ«æ˜¯ï¼Œæ”¶åˆ°åˆå§‹ç»ˆæ­¢è¯·æ±‚çš„è®¾å¤‡ä¸Šçš„TCPå¿…é¡»é€šçŸ¥å…¶åº”ç”¨è¿›ç¨‹ï¼Œå¹¶ç­‰å¾…è¯¥è¿›ç¨‹å‡†å¤‡ç»§ç»­çš„ä¿¡å·ã€‚å‘èµ·çš„è®¾å¤‡ä¸éœ€è¦è¿™æ ·åšï¼Œå› ä¸ºåº”ç”¨ç¨‹åºæ˜¯é¦–å…ˆå¼€å§‹çš„ã€‚

æ€»ç»“ï¼šç¬¬äºŒæ¬¡æŒ¥æ‰‹å’Œç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ä¸èƒ½åˆå¹¶æˆä¸€ä¸ªåŒ…ï¼Œå› ä¸ºå®ƒä»¬å±äºä¸åŒçš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœåŠ¡å™¨åœ¨ä»å®¢æˆ·ç«¯æ”¶åˆ° FIN æ—¶æ²¡æœ‰æ›´å¤šçš„æ•°æ®æˆ–æ ¹æœ¬æ²¡æœ‰è¦å‘é€çš„æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥å°†ç¬¬äºŒæ¬¡æŒ¥æ‰‹å’Œç¬¬ä¸‰æ¬¡æŒ¥æ‰‹åˆå¹¶åˆ°ä¸€ä¸ªåŒ…ä¸­ã€‚

#### HTTP ä¸ HTTPS æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ

1. HTTP æ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œä¿¡æ¯æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œå­˜åœ¨å®‰å…¨é£é™©çš„é—®é¢˜ã€‚HTTPS åˆ™è§£å†³ HTTP ä¸å®‰å…¨çš„ç¼ºé™·ï¼Œåœ¨ TCP å’Œ HTTP ç½‘ç»œå±‚ä¹‹é—´åŠ å…¥äº† SSL/TLS å®‰å…¨åè®®ï¼Œä½¿å¾—æŠ¥æ–‡èƒ½å¤ŸåŠ å¯†ä¼ è¾“ã€‚
2. HTTP è¿æ¥å»ºç«‹ç›¸å¯¹ç®€å•ï¼Œ TCP ä¸‰æ¬¡æ¡æ‰‹ä¹‹åä¾¿å¯è¿›è¡Œ HTTP çš„æŠ¥æ–‡ä¼ è¾“ã€‚è€Œ HTTPS åœ¨ TCP ä¸‰æ¬¡æ¡æ‰‹ä¹‹åï¼Œè¿˜éœ€è¿›è¡Œ SSL/TLS çš„æ¡æ‰‹è¿‡ç¨‹ï¼Œæ‰å¯è¿›å…¥åŠ å¯†æŠ¥æ–‡ä¼ è¾“ã€‚
3. HTTP çš„ç«¯å£å·æ˜¯ 80ï¼ŒHTTPS çš„ç«¯å£å·æ˜¯ 443ã€‚
4. HTTPS åè®®éœ€è¦å‘ CAï¼ˆè¯ä¹¦æƒå¨æœºæ„ï¼‰ç”³è¯·æ•°å­—è¯ä¹¦ï¼Œæ¥ä¿è¯æœåŠ¡å™¨çš„èº«ä»½æ˜¯å¯ä¿¡çš„ã€‚



#### HTTPS æ˜¯å¦‚ä½•å»ºç«‹è¿æ¥çš„ï¼Ÿå…¶é—´äº¤äº’äº†ä»€ä¹ˆï¼Ÿ

SSL/TLS åè®®åŸºæœ¬æµç¨‹ï¼š

- å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç´¢è¦å¹¶éªŒè¯æœåŠ¡å™¨çš„å…¬é’¥ã€‚
- åŒæ–¹åå•†ç”Ÿäº§ã€Œä¼šè¯ç§˜é’¥ã€ã€‚
- åŒæ–¹é‡‡ç”¨ã€Œä¼šè¯ç§˜é’¥ã€è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚

å‰ä¸¤æ­¥ä¹Ÿå°±æ˜¯ SSL/TLS çš„å»ºç«‹è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ TLS æ¡æ‰‹é˜¶æ®µã€‚

SSL/TLS çš„ã€Œæ¡æ‰‹é˜¶æ®µã€æ¶‰åŠ**å››æ¬¡**é€šä¿¡ï¼ŒåŸºäº RSA æ¡æ‰‹è¿‡ç¨‹çš„ HTTPSè§ä¸‹å›¾ï¼š

![HTTPS è¿æ¥å»ºç«‹è¿‡ç¨‹](./images/23-HTTPS%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png)

SSL/TLS åè®®å»ºç«‹çš„è¯¦ç»†æµç¨‹ï¼š

*1. ClientHello*

é¦–å…ˆï¼Œç”±å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·åŠ å¯†é€šä¿¡è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ `ClientHello` è¯·æ±‚ã€‚

åœ¨è¿™ä¸€æ­¥ï¼Œå®¢æˆ·ç«¯ä¸»è¦å‘æœåŠ¡å™¨å‘é€ä»¥ä¸‹ä¿¡æ¯ï¼š

ï¼ˆ1ï¼‰å®¢æˆ·ç«¯æ”¯æŒçš„ SSL/TLS åè®®ç‰ˆæœ¬ï¼Œå¦‚ TLS 1.2 ç‰ˆæœ¬ã€‚

ï¼ˆ2ï¼‰å®¢æˆ·ç«¯ç”Ÿäº§çš„éšæœºæ•°ï¼ˆ`Client Random`ï¼‰ï¼Œåé¢ç”¨äºç”Ÿæˆã€Œä¼šè¯ç§˜é’¥ã€æ¡ä»¶ä¹‹ä¸€ã€‚

ï¼ˆ3ï¼‰å®¢æˆ·ç«¯æ”¯æŒçš„å¯†ç å¥—ä»¶åˆ—è¡¨ï¼Œå¦‚ RSA åŠ å¯†ç®—æ³•ã€‚

*2. SeverHello*

æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œå‘å®¢æˆ·ç«¯å‘å‡ºå“åº”ï¼Œä¹Ÿå°±æ˜¯ `SeverHello`ã€‚æœåŠ¡å™¨å›åº”çš„å†…å®¹æœ‰å¦‚ä¸‹å†…å®¹ï¼š

ï¼ˆ1ï¼‰ç¡®è®¤ SSL/ TLS åè®®ç‰ˆæœ¬ï¼Œå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒï¼Œåˆ™å…³é—­åŠ å¯†é€šä¿¡ã€‚

ï¼ˆ2ï¼‰æœåŠ¡å™¨ç”Ÿäº§çš„éšæœºæ•°ï¼ˆ`Server Random`ï¼‰ï¼Œä¹Ÿæ˜¯åé¢ç”¨äºç”Ÿäº§ã€Œä¼šè¯ç§˜é’¥ã€æ¡ä»¶ä¹‹ä¸€ã€‚

ï¼ˆ3ï¼‰ç¡®è®¤çš„å¯†ç å¥—ä»¶åˆ—è¡¨ï¼Œå¦‚ RSA åŠ å¯†ç®—æ³•ã€‚

ï¼ˆ4ï¼‰æœåŠ¡å™¨çš„æ•°å­—è¯ä¹¦ã€‚

*3.å®¢æˆ·ç«¯å›åº”*

å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„å›åº”ä¹‹åï¼Œé¦–å…ˆé€šè¿‡æµè§ˆå™¨æˆ–è€…æ“ä½œç³»ç»Ÿä¸­çš„ CA å…¬é’¥ï¼Œç¡®è®¤æœåŠ¡å™¨çš„æ•°å­—è¯ä¹¦çš„çœŸå®æ€§ã€‚

å¦‚æœè¯ä¹¦æ²¡æœ‰é—®é¢˜ï¼Œå®¢æˆ·ç«¯ä¼š**ä»æ•°å­—è¯ä¹¦ä¸­å–å‡ºæœåŠ¡å™¨çš„å…¬é’¥**ï¼Œç„¶åä½¿ç”¨å®ƒåŠ å¯†æŠ¥æ–‡ï¼Œå‘æœåŠ¡å™¨å‘é€å¦‚ä¸‹ä¿¡æ¯ï¼š

ï¼ˆ1ï¼‰ä¸€ä¸ªéšæœºæ•°ï¼ˆ`pre-master key`ï¼‰ã€‚è¯¥éšæœºæ•°ä¼šè¢«æœåŠ¡å™¨å…¬é’¥åŠ å¯†ã€‚

ï¼ˆ2ï¼‰åŠ å¯†é€šä¿¡ç®—æ³•æ”¹å˜é€šçŸ¥ï¼Œè¡¨ç¤ºéšåçš„ä¿¡æ¯éƒ½å°†ç”¨ã€Œä¼šè¯ç§˜é’¥ã€åŠ å¯†é€šä¿¡ã€‚

ï¼ˆ3ï¼‰å®¢æˆ·ç«¯æ¡æ‰‹ç»“æŸé€šçŸ¥ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯çš„æ¡æ‰‹é˜¶æ®µå·²ç»ç»“æŸã€‚è¿™ä¸€é¡¹åŒæ—¶æŠŠä¹‹å‰æ‰€æœ‰å†…å®¹çš„å‘ç”Ÿçš„æ•°æ®åšä¸ªæ‘˜è¦ï¼Œç”¨æ¥ä¾›æœåŠ¡ç«¯æ ¡éªŒã€‚

ä¸Šé¢ç¬¬ä¸€é¡¹çš„éšæœºæ•°æ˜¯æ•´ä¸ªæ¡æ‰‹é˜¶æ®µçš„ç¬¬ä¸‰ä¸ªéšæœºæ•°ï¼Œä¼šå‘ç»™æœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¿™ä¸ªéšæœºæ•°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚

**æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æœ‰äº†è¿™ä¸‰ä¸ªéšæœºæ•°ï¼ˆClient Randomã€Server Randomã€pre-master keyï¼‰ï¼Œæ¥ç€å°±ç”¨åŒæ–¹åå•†çš„åŠ å¯†ç®—æ³•ï¼Œå„è‡ªç”Ÿæˆæœ¬æ¬¡é€šä¿¡çš„ã€Œä¼šè¯ç§˜é’¥ã€**ã€‚

*4. æœåŠ¡å™¨çš„æœ€åå›åº”*

æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ç¬¬ä¸‰ä¸ªéšæœºæ•°ï¼ˆ`pre-master key`ï¼‰ä¹‹åï¼Œé€šè¿‡åå•†çš„åŠ å¯†ç®—æ³•ï¼Œè®¡ç®—å‡ºæœ¬æ¬¡é€šä¿¡çš„ã€Œä¼šè¯ç§˜é’¥ã€ã€‚

ç„¶åï¼Œå‘å®¢æˆ·ç«¯å‘é€æœ€åçš„ä¿¡æ¯ï¼š

ï¼ˆ1ï¼‰åŠ å¯†é€šä¿¡ç®—æ³•æ”¹å˜é€šçŸ¥ï¼Œè¡¨ç¤ºéšåçš„ä¿¡æ¯éƒ½å°†ç”¨ã€Œä¼šè¯ç§˜é’¥ã€åŠ å¯†é€šä¿¡ã€‚

ï¼ˆ2ï¼‰æœåŠ¡å™¨æ¡æ‰‹ç»“æŸé€šçŸ¥ï¼Œè¡¨ç¤ºæœåŠ¡å™¨çš„æ¡æ‰‹é˜¶æ®µå·²ç»ç»“æŸã€‚è¿™ä¸€é¡¹åŒæ—¶æŠŠä¹‹å‰æ‰€æœ‰å†…å®¹çš„å‘ç”Ÿçš„æ•°æ®åšä¸ªæ‘˜è¦ï¼Œç”¨æ¥ä¾›å®¢æˆ·ç«¯æ ¡éªŒã€‚

è‡³æ­¤ï¼Œæ•´ä¸ª SSL/TLS çš„æ¡æ‰‹é˜¶æ®µå…¨éƒ¨ç»“æŸã€‚æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›å…¥åŠ å¯†é€šä¿¡ï¼Œå°±å®Œå…¨æ˜¯ä½¿ç”¨æ™®é€šçš„ HTTP åè®®ï¼Œåªä¸è¿‡ç”¨ã€Œä¼šè¯ç§˜é’¥ã€åŠ å¯†å†…å®¹ã€‚

> å®¢æˆ·ç«¯æ ¡éªŒæ•°å­—è¯ä¹¦çš„æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

æ¥ä¸‹æ¥ï¼Œè¯¦ç»†è¯´ä¸€ä¸‹å®é™…ä¸­æ•°å­—è¯ä¹¦ç­¾å‘å’ŒéªŒè¯æµç¨‹ã€‚

å¦‚ä¸‹å›¾å›¾æ‰€ç¤ºï¼Œä¸ºæ•°å­—è¯ä¹¦ç­¾å‘å’ŒéªŒè¯æµç¨‹ï¼š

![img](./images/%E8%AF%81%E4%B9%A6%E7%9A%84%E6%A0%A1%E9%AA%8C.png)

CA ç­¾å‘è¯ä¹¦çš„è¿‡ç¨‹ï¼Œå¦‚ä¸Šå›¾å·¦è¾¹éƒ¨åˆ†ï¼š

- é¦–å…ˆ CA ä¼šæŠŠæŒæœ‰è€…çš„å…¬é’¥ã€ç”¨é€”ã€é¢å‘è€…ã€æœ‰æ•ˆæ—¶é—´ç­‰ä¿¡æ¯æ‰“æˆä¸€ä¸ªåŒ…ï¼Œç„¶åå¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œ Hash è®¡ç®—ï¼Œå¾—åˆ°ä¸€ä¸ª Hash å€¼ï¼›
- ç„¶å CA ä¼šä½¿ç”¨è‡ªå·±çš„ç§é’¥å°†è¯¥ Hash å€¼åŠ å¯†ï¼Œç”Ÿæˆ Certificate Signatureï¼Œä¹Ÿå°±æ˜¯ CA å¯¹è¯ä¹¦åšäº†ç­¾åï¼›
- æœ€åå°† Certificate Signature æ·»åŠ åœ¨æ–‡ä»¶è¯ä¹¦ä¸Šï¼Œå½¢æˆæ•°å­—è¯ä¹¦ï¼›

å®¢æˆ·ç«¯æ ¡éªŒæœåŠ¡ç«¯çš„æ•°å­—è¯ä¹¦çš„è¿‡ç¨‹ï¼Œå¦‚ä¸Šå›¾å³è¾¹éƒ¨åˆ†ï¼š

- é¦–å…ˆå®¢æˆ·ç«¯ä¼šä½¿ç”¨åŒæ ·çš„ Hash ç®—æ³•è·å–è¯¥è¯ä¹¦çš„ Hash å€¼ H1ï¼›
- é€šå¸¸æµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿä¸­é›†æˆäº† CA çš„å…¬é’¥ä¿¡æ¯ï¼Œæµè§ˆå™¨æ”¶åˆ°è¯ä¹¦åå¯ä»¥ä½¿ç”¨ CA çš„å…¬é’¥è§£å¯† Certificate Signature å†…å®¹ï¼Œå¾—åˆ°ä¸€ä¸ª Hash å€¼ H2 ï¼›
- æœ€åæ¯”è¾ƒ H1 å’Œ H2ï¼Œå¦‚æœå€¼ç›¸åŒï¼Œåˆ™ä¸ºå¯ä¿¡èµ–çš„è¯ä¹¦ï¼Œå¦åˆ™åˆ™è®¤ä¸ºè¯ä¹¦ä¸å¯ä¿¡ã€‚

ä½†äº‹å®ä¸Šï¼Œè¯ä¹¦çš„éªŒè¯è¿‡ç¨‹ä¸­**è¿˜å­˜åœ¨ä¸€ä¸ªè¯ä¹¦ä¿¡ä»»é“¾çš„é—®é¢˜**ï¼Œå› ä¸ºæˆ‘ä»¬å‘ CA ç”³è¯·çš„è¯ä¹¦ä¸€èˆ¬ä¸æ˜¯æ ¹è¯ä¹¦ç­¾å‘çš„ï¼Œè€Œæ˜¯ç”±ä¸­é—´è¯ä¹¦ç­¾å‘çš„ï¼Œæ¯”å¦‚ç™¾åº¦çš„è¯ä¹¦ï¼Œä»ä¸‹å›¾ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¯ä¹¦çš„å±‚çº§æœ‰ä¸‰çº§ï¼š

![img](./images/baidu%E8%AF%81%E4%B9%A6.png)

å¯¹äºè¿™ç§ä¸‰çº§å±‚çº§å…³ç³»çš„è¯ä¹¦çš„éªŒè¯è¿‡ç¨‹å¦‚ä¸‹ï¼š

- å®¢æˆ·ç«¯æ”¶åˆ° baidu.com çš„è¯ä¹¦åï¼Œå‘ç°è¿™ä¸ªè¯ä¹¦çš„ç­¾å‘è€…ä¸æ˜¯æ ¹è¯ä¹¦ï¼Œå°±æ— æ³•æ ¹æ®æœ¬åœ°å·²æœ‰çš„æ ¹è¯ä¹¦ä¸­çš„å…¬é’¥å»éªŒè¯ baidu.com è¯ä¹¦æ˜¯å¦å¯ä¿¡ã€‚äºæ˜¯ï¼Œå®¢æˆ·ç«¯æ ¹æ® baidu.com è¯ä¹¦ä¸­çš„ç­¾å‘è€…ï¼Œæ‰¾åˆ°è¯¥è¯ä¹¦çš„é¢å‘æœºæ„æ˜¯ â€œGlobalSign Organization Validation CA - SHA256 - G2â€ï¼Œç„¶åå‘ CA è¯·æ±‚è¯¥ä¸­é—´è¯ä¹¦ã€‚
- è¯·æ±‚åˆ°è¯ä¹¦åå‘ç° â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦æ˜¯ç”± â€œGlobalSign Root CAâ€ ç­¾å‘çš„ï¼Œç”±äº â€œGlobalSign Root CAâ€ æ²¡æœ‰å†ä¸Šçº§ç­¾å‘æœºæ„ï¼Œè¯´æ˜å®ƒæ˜¯æ ¹è¯ä¹¦ï¼Œä¹Ÿå°±æ˜¯è‡ªç­¾è¯ä¹¦ã€‚åº”ç”¨è½¯ä»¶ä¼šæ£€æŸ¥æ­¤è¯ä¹¦æœ‰å¦å·²é¢„è½½äºæ ¹è¯ä¹¦æ¸…å•ä¸Šï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¯ä»¥åˆ©ç”¨æ ¹è¯ä¹¦ä¸­çš„å…¬é’¥å»éªŒè¯ â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦ï¼Œå¦‚æœå‘ç°éªŒè¯é€šè¿‡ï¼Œå°±è®¤ä¸ºè¯¥ä¸­é—´è¯ä¹¦æ˜¯å¯ä¿¡çš„ã€‚
- â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦è¢«ä¿¡ä»»åï¼Œå¯ä»¥ä½¿ç”¨ â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦ä¸­çš„å…¬é’¥å»éªŒè¯ baidu.com è¯ä¹¦çš„å¯ä¿¡æ€§ï¼Œå¦‚æœéªŒè¯é€šè¿‡ï¼Œå°±å¯ä»¥ä¿¡ä»» baidu.com è¯ä¹¦ã€‚

åœ¨è¿™å››ä¸ªæ­¥éª¤ä¸­ï¼Œæœ€å¼€å§‹å®¢æˆ·ç«¯åªä¿¡ä»»æ ¹è¯ä¹¦ GlobalSign Root CA è¯ä¹¦çš„ï¼Œç„¶å â€œGlobalSign Root CAâ€ è¯ä¹¦ä¿¡ä»» â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦ï¼Œè€Œ â€œGlobalSign Organization Validation CA - SHA256 - G2â€ è¯ä¹¦åˆä¿¡ä»» baidu.com è¯ä¹¦ï¼Œäºæ˜¯å®¢æˆ·ç«¯ä¹Ÿä¿¡ä»» baidu.com è¯ä¹¦ã€‚

æ€»æ‹¬æ¥è¯´ï¼Œç”±äºç”¨æˆ·ä¿¡ä»» GlobalSignï¼Œæ‰€ä»¥ç”± GlobalSign æ‰€æ‹…ä¿çš„ baidu.com å¯ä»¥è¢«ä¿¡ä»»ï¼Œå¦å¤–ç”±äºç”¨æˆ·ä¿¡ä»»æ“ä½œç³»ç»Ÿæˆ–æµè§ˆå™¨çš„è½¯ä»¶å•†ï¼Œæ‰€ä»¥ç”±è½¯ä»¶å•†é¢„è½½äº†æ ¹è¯ä¹¦çš„ GlobalSign éƒ½å¯è¢«ä¿¡ä»»ã€‚

![img](./images/%E7%94%A8%E6%88%B7%E4%BF%A1%E4%BB%BB.png)

æ“ä½œç³»ç»Ÿé‡Œä¸€èˆ¬éƒ½ä¼šå†…ç½®ä¸€äº›æ ¹è¯ä¹¦ï¼Œæ¯”å¦‚æˆ‘çš„ MAC ç”µè„‘é‡Œå†…ç½®çš„æ ¹è¯ä¹¦æœ‰è¿™ä¹ˆå¤šï¼š

![img](./images/%E7%B3%BB%E7%BB%9F%E6%A0%B9%E8%AF%81%E4%B9%A6.png)

è¿™æ ·çš„ä¸€å±‚å±‚åœ°éªŒè¯å°±æ„æˆäº†ä¸€æ¡ä¿¡ä»»é“¾è·¯ï¼Œæ•´ä¸ªè¯ä¹¦ä¿¡ä»»é“¾éªŒè¯æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](./images/%E8%AF%81%E4%B9%A6%E9%93%BE.png)

æœ€åä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¯ä¹¦é“¾è¿™ä¹ˆéº»çƒ¦çš„æµç¨‹ï¼ŸRoot CA ä¸ºä»€ä¹ˆä¸ç›´æ¥é¢å‘è¯ä¹¦ï¼Œè€Œæ˜¯è¦æé‚£ä¹ˆå¤šä¸­é—´å±‚çº§å‘¢ï¼Ÿ

**è¿™æ˜¯ä¸ºäº†ç¡®ä¿æ ¹è¯ä¹¦çš„ç»å¯¹å®‰å…¨æ€§ï¼Œå°†æ ¹è¯ä¹¦éš”ç¦»åœ°è¶Šä¸¥æ ¼è¶Šå¥½ï¼Œä¸ç„¶æ ¹è¯ä¹¦å¦‚æœå¤±å®ˆäº†ï¼Œé‚£ä¹ˆæ•´ä¸ªä¿¡ä»»é“¾éƒ½ä¼šæœ‰é—®é¢˜ã€‚**

#### TCP, UDP åè®®çš„åŒºåˆ«

![TCPã€UDPåè®®çš„åŒºåˆ«](./images/tcp-vs-udp.jpg)

1. TCPæ˜¯å¯é ä¼ è¾“,UDPæ˜¯ä¸å¯é ä¼ è¾“;
2. TCPé¢å‘è¿æ¥,UDPæ— è¿æ¥;
3. TCPä¼ è¾“æ•°æ®æœ‰åº,UDPä¸ä¿è¯æ•°æ®çš„æœ‰åºæ€§;
4. TCPä¸ä¿å­˜æ•°æ®è¾¹ç•Œ,UDPä¿ç•™æ•°æ®è¾¹ç•Œ;
5. TCPä¼ è¾“é€Ÿåº¦ç›¸å¯¹UDPè¾ƒæ…¢;
6. TCPæœ‰æµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶,UDPæ²¡æœ‰;
7. TCPæ˜¯é‡é‡çº§åè®®,UDPæ˜¯è½»é‡çº§åè®®;
8. TCPé¦–éƒ¨è¾ƒé•¿20å­—èŠ‚,UDPé¦–éƒ¨è¾ƒçŸ­8å­—èŠ‚;

> æ‰©å±•ï¼šåº”ç”¨åœºæ™¯

TCPåº”ç”¨åœºæ™¯ï¼š

æ•ˆç‡è¦æ±‚ç›¸å¯¹ä½ï¼Œä½†å¯¹å‡†ç¡®æ€§è¦æ±‚ç›¸å¯¹é«˜çš„åœºæ™¯ã€‚å› ä¸ºä¼ è¾“ä¸­éœ€è¦å¯¹æ•°æ®ç¡®è®¤ã€é‡å‘ã€æ’åºç­‰æ“ä½œï¼Œç›¸æ¯”ä¹‹ä¸‹æ•ˆç‡æ²¡æœ‰UDPé«˜ã€‚ä¸¾å‡ ä¸ªä¾‹å­ï¼šæ–‡ä»¶ä¼ è¾“ï¼ˆå‡†ç¡®é«˜è¦æ±‚é«˜ã€ä½†æ˜¯é€Ÿåº¦å¯ä»¥ç›¸å¯¹æ…¢ï¼‰ã€æ¥å—é‚®ä»¶ã€è¿œç¨‹ç™»å½•ã€‚

UDPåº”ç”¨åœºæ™¯ï¼š

æ•ˆç‡è¦æ±‚ç›¸å¯¹é«˜ï¼Œå¯¹å‡†ç¡®æ€§è¦æ±‚ç›¸å¯¹ä½çš„åœºæ™¯ã€‚ä¸¾å‡ ä¸ªä¾‹å­ï¼šQQèŠå¤©ã€åœ¨çº¿è§†é¢‘ã€ç½‘ç»œè¯­éŸ³ç”µè¯ï¼ˆå³æ—¶é€šè®¯ï¼Œé€Ÿåº¦è¦æ±‚é«˜ï¼Œä½†æ˜¯å‡ºç°å¶å°”æ–­ç»­ä¸æ˜¯å¤ªå¤§é—®é¢˜ï¼Œå¹¶ä¸”æ­¤å¤„å®Œå…¨ä¸å¯ä»¥ä½¿ç”¨é‡å‘æœºåˆ¶ï¼‰ã€å¹¿æ’­é€šä¿¡ï¼ˆå¹¿æ’­ã€å¤šæ’­ï¼‰

#### HTTP å“ªäº›å¸¸ç”¨çš„çŠ¶æ€ç 

![ äº”å¤§ç±» HTTP çŠ¶æ€ç  ](./images/6-%E4%BA%94%E5%A4%A7%E7%B1%BBHTTP%E7%8A%B6%E6%80%81%E7%A0%81.png)

`1xx` ç±»çŠ¶æ€ç å±äº**æç¤ºä¿¡æ¯**ï¼Œæ˜¯åè®®å¤„ç†ä¸­çš„ä¸€ç§ä¸­é—´çŠ¶æ€ï¼Œå®é™…ç”¨åˆ°çš„æ¯”è¾ƒå°‘ã€‚

`2xx` ç±»çŠ¶æ€ç è¡¨ç¤ºæœåŠ¡å™¨**æˆåŠŸ**å¤„ç†äº†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æœ€æ„¿æ„çœ‹åˆ°çš„çŠ¶æ€ã€‚

- ã€Œ**200 OK**ã€æ˜¯æœ€å¸¸è§çš„æˆåŠŸçŠ¶æ€ç ï¼Œè¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ã€‚å¦‚æœæ˜¯é `HEAD` è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”å¤´éƒ½ä¼šæœ‰ body æ•°æ®ã€‚
- ã€Œ**204 No Content**ã€ä¹Ÿæ˜¯å¸¸è§çš„æˆåŠŸçŠ¶æ€ç ï¼Œä¸ 200 OK åŸºæœ¬ç›¸åŒï¼Œä½†å“åº”å¤´æ²¡æœ‰ body æ•°æ®ã€‚
- ã€Œ**206 Partial Content**ã€æ˜¯åº”ç”¨äº HTTP åˆ†å—ä¸‹è½½æˆ–æ–­ç‚¹ç»­ä¼ ï¼Œè¡¨ç¤ºå“åº”è¿”å›çš„ body æ•°æ®å¹¶ä¸æ˜¯èµ„æºçš„å…¨éƒ¨ï¼Œè€Œæ˜¯å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœåŠ¡å™¨å¤„ç†æˆåŠŸçš„çŠ¶æ€ã€‚

`3xx` ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„èµ„æºå‘ç”Ÿäº†å˜åŠ¨ï¼Œéœ€è¦å®¢æˆ·ç«¯ç”¨æ–°çš„ URL é‡æ–°å‘é€è¯·æ±‚è·å–èµ„æºï¼Œä¹Ÿå°±æ˜¯**é‡å®šå‘**ã€‚

- ã€Œ**301 Moved Permanently**ã€è¡¨ç¤ºæ°¸ä¹…é‡å®šå‘ï¼Œè¯´æ˜è¯·æ±‚çš„èµ„æºå·²ç»ä¸å­˜åœ¨äº†ï¼Œéœ€æ”¹ç”¨æ–°çš„ URL å†æ¬¡è®¿é—®ã€‚
- ã€Œ**302 Found**ã€è¡¨ç¤ºä¸´æ—¶é‡å®šå‘ï¼Œè¯´æ˜è¯·æ±‚çš„èµ„æºè¿˜åœ¨ï¼Œä½†æš‚æ—¶éœ€è¦ç”¨å¦ä¸€ä¸ª URL æ¥è®¿é—®ã€‚

301 å’Œ 302 éƒ½ä¼šåœ¨å“åº”å¤´é‡Œä½¿ç”¨å­—æ®µ `Location`ï¼ŒæŒ‡æ˜åç»­è¦è·³è½¬çš„ URLï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨é‡å®šå‘æ–°çš„ URLã€‚

- ã€Œ**304 Not Modified**ã€ä¸å…·æœ‰è·³è½¬çš„å«ä¹‰ï¼Œè¡¨ç¤ºèµ„æºæœªä¿®æ”¹ï¼Œé‡å®šå‘å·²å­˜åœ¨çš„ç¼“å†²æ–‡ä»¶ï¼Œä¹Ÿç§°ç¼“å­˜é‡å®šå‘ï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰å®¢æˆ·ç«¯å¯ä»¥ç»§ç»­ä½¿ç”¨ç¼“å­˜èµ„æºï¼Œç”¨äºç¼“å­˜æ§åˆ¶ã€‚

`4xx` ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯å‘é€çš„**æŠ¥æ–‡æœ‰è¯¯**ï¼ŒæœåŠ¡å™¨æ— æ³•å¤„ç†ï¼Œä¹Ÿå°±æ˜¯é”™è¯¯ç çš„å«ä¹‰ã€‚

- ã€Œ**400 Bad Request**ã€è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„æŠ¥æ–‡æœ‰é”™è¯¯ï¼Œä½†åªæ˜¯ä¸ªç¬¼ç»Ÿçš„é”™è¯¯ã€‚
- ã€Œ**403 Forbidden**ã€è¡¨ç¤ºæœåŠ¡å™¨ç¦æ­¢è®¿é—®èµ„æºï¼Œå¹¶ä¸æ˜¯å®¢æˆ·ç«¯çš„è¯·æ±‚å‡ºé”™ã€‚
- ã€Œ**404 Not Found**ã€è¡¨ç¤ºè¯·æ±‚çš„èµ„æºåœ¨æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨æˆ–æœªæ‰¾åˆ°ï¼Œæ‰€ä»¥æ— æ³•æä¾›ç»™å®¢æˆ·ç«¯ã€‚

`5xx` ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡æ­£ç¡®ï¼Œä½†æ˜¯**æœåŠ¡å™¨å¤„ç†æ—¶å†…éƒ¨å‘ç”Ÿäº†é”™è¯¯**ï¼Œå±äºæœåŠ¡å™¨ç«¯çš„é”™è¯¯ç ã€‚

- ã€Œ**500 Internal Server Error**ã€ä¸ 400 ç±»å‹ï¼Œæ˜¯ä¸ªç¬¼ç»Ÿé€šç”¨çš„é”™è¯¯ç ï¼ŒæœåŠ¡å™¨å‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ã€‚
- ã€Œ**501 Not Implemented**ã€è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„åŠŸèƒ½è¿˜ä¸æ”¯æŒï¼Œç±»ä¼¼â€œå³å°†å¼€ä¸šï¼Œæ•¬è¯·æœŸå¾…â€çš„æ„æ€ã€‚
- ã€Œ**502 Bad Gateway**ã€é€šå¸¸æ˜¯æœåŠ¡å™¨ä½œä¸ºç½‘å…³æˆ–ä»£ç†æ—¶è¿”å›çš„é”™è¯¯ç ï¼Œè¡¨ç¤ºæœåŠ¡å™¨è‡ªèº«å·¥ä½œæ­£å¸¸ï¼Œè®¿é—®åç«¯æœåŠ¡å™¨å‘ç”Ÿäº†é”™è¯¯ã€‚
- ã€Œ**503 Service Unavailable**ã€è¡¨ç¤ºæœåŠ¡å™¨å½“å‰å¾ˆå¿™ï¼Œæš‚æ—¶æ— æ³•å“åº”å®¢æˆ·ç«¯ï¼Œç±»ä¼¼â€œç½‘ç»œæœåŠ¡æ­£å¿™ï¼Œè¯·ç¨åé‡è¯•â€çš„æ„æ€ã€‚



#### HTTPå¦‚ä½•å®ç°é•¿è¿æ¥

æ—©æœŸ HTTP/1.0 æ€§èƒ½ä¸Šçš„ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯æ¯å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½è¦æ–°å»ºä¸€æ¬¡ TCP è¿æ¥ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰ï¼Œè€Œä¸”æ˜¯ä¸²è¡Œè¯·æ±‚ï¼Œåšäº†æ— è°“çš„ TCP è¿æ¥å»ºç«‹å’Œæ–­å¼€ï¼Œå¢åŠ äº†é€šä¿¡å¼€é”€ã€‚

ä¸ºäº†è§£å†³ä¸Šè¿° TCP è¿æ¥é—®é¢˜ï¼ŒHTTP/1.1 æå‡ºäº†**é•¿è¿æ¥**çš„é€šä¿¡æ–¹å¼ï¼Œä¹Ÿå«æŒä¹…è¿æ¥ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„åœ¨äºå‡å°‘äº† TCP è¿æ¥çš„é‡å¤å»ºç«‹å’Œæ–­å¼€æ‰€é€ æˆçš„é¢å¤–å¼€é”€ï¼Œå‡è½»äº†æœåŠ¡å™¨ç«¯çš„è´Ÿè½½ã€‚

æŒä¹…è¿æ¥çš„ç‰¹ç‚¹æ˜¯ï¼Œåªè¦ä»»æ„ä¸€ç«¯æ²¡æœ‰æ˜ç¡®æå‡ºæ–­å¼€è¿æ¥ï¼Œåˆ™ä¿æŒ TCP è¿æ¥çŠ¶æ€ã€‚

![çŸ­è¿æ¥ä¸é•¿è¿æ¥](./images/16-%E7%9F%AD%E8%BF%9E%E6%8E%A5%E4%B8%8E%E9%95%BF%E8%BF%9E%E6%8E%A5.png)

ä½†æ˜¯**æœåŠ¡å™¨å¿…é¡»æŒ‰ç…§æ¥æ”¶è¯·æ±‚çš„é¡ºåºå‘é€å¯¹è¿™äº›ç®¡é“åŒ–è¯·æ±‚çš„å“åº”**ã€‚

å¦‚æœæœåŠ¡ç«¯åœ¨å¤„ç† A è¯·æ±‚æ—¶è€—æ—¶æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆåç»­çš„è¯·æ±‚çš„å¤„ç†éƒ½ä¼šè¢«é˜»å¡ä½ï¼Œè¿™ç§°ä¸ºã€Œé˜Ÿå¤´å µå¡ã€ã€‚

æ‰€ä»¥ï¼Œ**HTTP/1.1 ç®¡é“è§£å†³äº†è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡ï¼Œä½†æ˜¯æ²¡æœ‰è§£å†³å“åº”çš„é˜Ÿå¤´é˜»å¡**ã€‚

***æ³¨æ„ï¼šå®é™…ä¸Š HTTP/1.1 ç®¡é“åŒ–æŠ€æœ¯ä¸æ˜¯é»˜è®¤å¼€å¯ï¼Œè€Œä¸”æµè§ˆå™¨åŸºæœ¬éƒ½æ²¡æœ‰æ”¯æŒï¼Œæ‰€ä»¥åé¢è®¨è®ºHTTP/1.1 éƒ½æ˜¯å»ºç«‹åœ¨æ²¡æœ‰ä½¿ç”¨ç®¡é“åŒ–çš„å‰æã€‚***



#### å¦‚ä½•è§£å†³ç²˜åŒ…ï¼Ÿ

ç²˜åŒ…çš„é—®é¢˜å‡ºç°æ˜¯å› ä¸ºä¸çŸ¥é“ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯çš„è¾¹ç•Œåœ¨å“ªï¼Œå¦‚æœçŸ¥é“äº†è¾¹ç•Œåœ¨å“ªï¼Œæ¥æ”¶æ–¹å°±å¯ä»¥é€šè¿‡è¾¹ç•Œæ¥åˆ’åˆ†å‡ºæœ‰æ•ˆçš„ç”¨æˆ·æ¶ˆæ¯ã€‚

ä¸€èˆ¬æœ‰ä¸‰ç§æ–¹å¼åˆ†åŒ…çš„æ–¹å¼ï¼š

- å›ºå®šé•¿åº¦çš„æ¶ˆæ¯ï¼›
- ç‰¹æ®Šå­—ç¬¦ä½œä¸ºè¾¹ç•Œï¼›
- è‡ªå®šä¹‰æ¶ˆæ¯ç»“æ„ã€‚

##### å›ºå®šé•¿åº¦çš„æ¶ˆæ¯

è¿™ç§æ˜¯æœ€ç®€å•æ–¹æ³•ï¼Œå³æ¯ä¸ªç”¨æˆ·æ¶ˆæ¯éƒ½æ˜¯å›ºå®šé•¿åº¦çš„ï¼Œæ¯”å¦‚è§„å®šä¸€ä¸ªæ¶ˆæ¯çš„é•¿åº¦æ˜¯ 64 ä¸ªå­—èŠ‚ï¼Œå½“æ¥æ”¶æ–¹æ¥æ»¡ 64 ä¸ªå­—èŠ‚ï¼Œå°±è®¤ä¸ºè¿™ä¸ªå†…å®¹æ˜¯ä¸€ä¸ªå®Œæ•´ä¸”æœ‰æ•ˆçš„æ¶ˆæ¯ã€‚

ä½†æ˜¯è¿™ç§æ–¹å¼çµæ´»æ€§ä¸é«˜ï¼Œå®é™…ä¸­å¾ˆå°‘ç”¨ã€‚

##### ç‰¹æ®Šå­—ç¬¦ä½œä¸ºè¾¹ç•Œ

æˆ‘ä»¬å¯ä»¥åœ¨ä¸¤ä¸ªç”¨æˆ·æ¶ˆæ¯ä¹‹é—´æ’å…¥ä¸€ä¸ªç‰¹æ®Šçš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·æ¥æ”¶æ–¹åœ¨æ¥æ”¶æ•°æ®æ—¶ï¼Œè¯»åˆ°äº†è¿™ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œå°±æŠŠè®¤ä¸ºå·²ç»è¯»å®Œä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ã€‚

HTTP æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¾‹å­ã€‚

![å›¾ç‰‡](./images/a49a6bb8cd38ae1738d9c00aec68b444.png)

HTTP é€šè¿‡è®¾ç½®å›è½¦ç¬¦ã€æ¢è¡Œç¬¦ä½œä¸º HTTP æŠ¥æ–‡åè®®çš„è¾¹ç•Œã€‚

æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œè¿™ä¸ªä½œä¸ºè¾¹ç•Œç‚¹çš„ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚æœåˆšå¥½æ¶ˆæ¯å†…å®¹é‡Œæœ‰è¿™ä¸ªç‰¹æ®Šå­—ç¬¦ï¼Œæˆ‘ä»¬è¦å¯¹è¿™ä¸ªå­—ç¬¦è½¬ä¹‰ï¼Œé¿å…è¢«æ¥æ”¶æ–¹å½“ä½œæ¶ˆæ¯çš„è¾¹ç•Œç‚¹è€Œè§£æåˆ°æ— æ•ˆçš„æ•°æ®

##### è‡ªå®šä¹‰æ¶ˆæ¯ç»“æ„

æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªæ¶ˆæ¯ç»“æ„ï¼Œç”±åŒ…å¤´å’Œæ•°æ®ç»„æˆï¼Œå…¶ä¸­åŒ…å¤´åŒ…æ˜¯å›ºå®šå¤§å°çš„ï¼Œè€Œä¸”åŒ…å¤´é‡Œæœ‰ä¸€ä¸ªå­—æ®µæ¥è¯´æ˜ç´§éšå…¶åçš„æ•°æ®æœ‰å¤šå¤§ã€‚

æ¯”å¦‚è¿™ä¸ªæ¶ˆæ¯ç»“æ„ä½“ï¼Œé¦–å…ˆ 4 ä¸ªå­—èŠ‚å¤§å°çš„å˜é‡æ¥è¡¨ç¤ºæ•°æ®é•¿åº¦ï¼ŒçœŸæ­£çš„æ•°æ®åˆ™åœ¨åé¢ã€‚

```c
struct { 
    u_int32_t message_length; 
    char message_data[]; 
} message;
```

å½“æ¥æ”¶æ–¹æ¥æ”¶åˆ°åŒ…å¤´çš„å¤§å°ï¼ˆæ¯”å¦‚ 4 ä¸ªå­—èŠ‚ï¼‰åï¼Œå°±è§£æåŒ…å¤´çš„å†…å®¹ï¼Œäºæ˜¯å°±å¯ä»¥çŸ¥é“æ•°æ®çš„é•¿åº¦ï¼Œç„¶åæ¥ä¸‹æ¥å°±ç»§ç»­è¯»å–æ•°æ®ï¼Œç›´åˆ°è¯»æ»¡æ•°æ®çš„é•¿åº¦ï¼Œå°±å¯ä»¥ç»„è£…æˆä¸€ä¸ªå®Œæ•´åˆ°ç”¨æˆ·æ¶ˆæ¯æ¥å¤„ç†äº†ã€‚





### ğŸ’»æ“ä½œç³»ç»Ÿ

#### ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ

åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ã€‚

åç¨‹ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸ç®¡ç†ï¼Œè€Œæ˜¯å®Œå…¨ç”±ç”¨æˆ·ç¨‹åºæ‰€æ§åˆ¶ï¼Œè¿™æ ·å¸¦æ¥çš„å¥½å¤„å°±æ˜¯æ€§èƒ½å¾—åˆ°äº†å¾ˆå¤§çš„æå‡ï¼Œä¸ä¼šåƒçº¿ç¨‹åˆ‡æ¢é‚£æ ·æ¶ˆè€—èµ„æºã€‚

åç¨‹å¯ä»¥ç†è§£ä¸ºå¯ä»¥æš‚åœæ‰§è¡Œçš„å‡½æ•°ã€‚å®ƒæ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œç›´æ¥æ“ä½œæ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éå¸¸å¿«ã€‚



#### è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜**: å¥½çš„ï¼æˆ‘æ˜ç™½äº†ï¼é‚£ä½ å†è¯´ä¸€ä¸‹ï¼š **è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«**ã€‚

ğŸ™‹ **æˆ‘ï¼š** å¥½çš„ï¼ ä¸‹å›¾æ˜¯ Java å†…å­˜åŒºåŸŸï¼Œæˆ‘ä»¬ä» JVM çš„è§’åº¦æ¥è¯´ä¸€ä¸‹çº¿ç¨‹å’Œè¿›ç¨‹ä¹‹é—´çš„å…³ç³»å§ï¼

![image-20220626201137158](./images/image-20220626201137158.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †**å’Œ**æ–¹æ³•åŒº (JDK1.8 ä¹‹åçš„å…ƒç©ºé—´)\**èµ„æºï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„\**ç¨‹åºè®¡æ•°å™¨**ã€**è™šæ‹Ÿæœºæ ˆ** å’Œ **æœ¬åœ°æ–¹æ³•æ ˆ**ã€‚

**æ€»ç»“ï¼š** çº¿ç¨‹æ˜¯è¿›ç¨‹åˆ’åˆ†æˆçš„æ›´å°çš„è¿è¡Œå•ä½,ä¸€ä¸ªè¿›ç¨‹åœ¨å…¶æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¯ä»¥äº§ç”Ÿå¤šä¸ªçº¿ç¨‹ã€‚çº¿ç¨‹å’Œè¿›ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºåŸºæœ¬ä¸Šå„è¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œå„çº¿ç¨‹åˆ™ä¸ä¸€å®šï¼Œå› ä¸ºåŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹ææœ‰å¯èƒ½ä¼šç›¸äº’å½±å“ã€‚çº¿ç¨‹æ‰§è¡Œå¼€é”€å°ï¼Œä½†ä¸åˆ©äºèµ„æºçš„ç®¡ç†å’Œä¿æŠ¤ï¼›è€Œè¿›ç¨‹æ­£ç›¸åã€‚

#### è¿›ç¨‹æœ‰å“ªå‡ ç§çŠ¶æ€?

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼š é‚£ä½ å†è¯´è¯´**è¿›ç¨‹æœ‰å“ªå‡ ç§çŠ¶æ€?**

ğŸ™‹ **æˆ‘** ï¼šæˆ‘ä»¬ä¸€èˆ¬æŠŠè¿›ç¨‹å¤§è‡´åˆ†ä¸º 5 ç§çŠ¶æ€ï¼Œè¿™ä¸€ç‚¹å’Œçº¿ç¨‹å¾ˆåƒï¼

- **åˆ›å»ºçŠ¶æ€(new)** ï¼šè¿›ç¨‹æ­£åœ¨è¢«åˆ›å»ºï¼Œå°šæœªåˆ°å°±ç»ªçŠ¶æ€ã€‚
- **å°±ç»ªçŠ¶æ€(ready)** ï¼šè¿›ç¨‹å·²å¤„äºå‡†å¤‡è¿è¡ŒçŠ¶æ€ï¼Œå³è¿›ç¨‹è·å¾—äº†é™¤äº†å¤„ç†å™¨ä¹‹å¤–çš„ä¸€åˆ‡æ‰€éœ€èµ„æºï¼Œä¸€æ—¦å¾—åˆ°å¤„ç†å™¨èµ„æº(å¤„ç†å™¨åˆ†é…çš„æ—¶é—´ç‰‡)å³å¯è¿è¡Œã€‚
- **è¿è¡ŒçŠ¶æ€(running)** ï¼šè¿›ç¨‹æ­£åœ¨å¤„ç†å™¨ä¸Šä¸Šè¿è¡Œ(å•æ ¸ CPU ä¸‹ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€)ã€‚
- **é˜»å¡çŠ¶æ€(waiting)** ï¼šåˆç§°ä¸ºç­‰å¾…çŠ¶æ€ï¼Œè¿›ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸€äº‹ä»¶è€Œæš‚åœè¿è¡Œå¦‚ç­‰å¾…æŸèµ„æºä¸ºå¯ç”¨æˆ–ç­‰å¾… IO æ“ä½œå®Œæˆã€‚å³ä½¿å¤„ç†å™¨ç©ºé—²ï¼Œè¯¥è¿›ç¨‹ä¹Ÿä¸èƒ½è¿è¡Œã€‚
- **ç»“æŸçŠ¶æ€(terminated)** ï¼šè¿›ç¨‹æ­£åœ¨ä»ç³»ç»Ÿä¸­æ¶ˆå¤±ã€‚å¯èƒ½æ˜¯è¿›ç¨‹æ­£å¸¸ç»“æŸæˆ–å…¶ä»–åŸå› ä¸­æ–­é€€å‡ºè¿è¡Œã€‚

#### è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼š**è¿›ç¨‹é—´çš„é€šä¿¡å¸¸è§çš„çš„æœ‰å“ªå‡ ç§æ–¹å¼å‘¢?**

ğŸ™‹ **æˆ‘** ï¼šå¤§æ¦‚æœ‰ 7 ç§å¸¸è§çš„è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼ã€‚

> ä¸‹é¢è¿™éƒ¨åˆ†æ€»ç»“å‚è€ƒäº†:[ã€Šè¿›ç¨‹é—´é€šä¿¡ IPC (InterProcess Communication)ã€‹](https://www.jianshu.com/p/c1015f5ffa74)è¿™ç¯‡æ–‡ç« ï¼Œæ¨èé˜…è¯»ï¼Œæ€»ç»“çš„éå¸¸ä¸é”™ã€‚

1. **ç®¡é“/åŒ¿åç®¡é“(Pipes)** ï¼šç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»çš„çˆ¶å­è¿›ç¨‹é—´æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚
2. **æœ‰åç®¡é“(Names Pipes)** : åŒ¿åç®¡é“ç”±äºæ²¡æœ‰åå­—ï¼Œåªèƒ½ç”¨äºäº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´é€šä¿¡ã€‚ä¸ºäº†å…‹æœè¿™ä¸ªç¼ºç‚¹ï¼Œæå‡ºäº†æœ‰åç®¡é“ã€‚æœ‰åç®¡é“ä¸¥æ ¼éµå¾ª**å…ˆè¿›å…ˆå‡º(first in first out)**ã€‚æœ‰åç®¡é“ä»¥ç£ç›˜æ–‡ä»¶çš„æ–¹å¼å­˜åœ¨ï¼Œå¯ä»¥å®ç°æœ¬æœºä»»æ„ä¸¤ä¸ªè¿›ç¨‹é€šä¿¡ã€‚
3. **ä¿¡å·(Signal)** ï¼šä¿¡å·æ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨äºé€šçŸ¥æ¥æ”¶è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿï¼›
4. **æ¶ˆæ¯é˜Ÿåˆ—(Message Queuing)**  ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ¶ˆæ¯çš„é“¾è¡¨,å…·æœ‰ç‰¹å®šçš„æ ¼å¼,å­˜æ”¾åœ¨å†…å­˜ä¸­å¹¶ç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ã€‚ç®¡é“å’Œæ¶ˆæ¯é˜Ÿåˆ—çš„é€šä¿¡æ•°æ®éƒ½æ˜¯å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™ã€‚ä¸ç®¡é“ï¼ˆæ— åç®¡é“ï¼šåªå­˜åœ¨äºå†…å­˜ä¸­çš„æ–‡ä»¶ï¼›å‘½åç®¡é“ï¼šå­˜åœ¨äºå®é™…çš„ç£ç›˜ä»‹è´¨æˆ–è€…æ–‡ä»¶ç³»ç»Ÿï¼‰ä¸åŒçš„æ˜¯æ¶ˆæ¯é˜Ÿåˆ—å­˜æ”¾åœ¨å†…æ ¸ä¸­ï¼Œåªæœ‰åœ¨å†…æ ¸é‡å¯(å³ï¼Œæ“ä½œç³»ç»Ÿé‡å¯)æˆ–è€…æ˜¾å¼åœ°åˆ é™¤ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—æ‰ä¼šè¢«çœŸæ­£çš„åˆ é™¤ã€‚æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å®ç°æ¶ˆæ¯çš„éšæœºæŸ¥è¯¢,æ¶ˆæ¯ä¸ä¸€å®šè¦ä»¥å…ˆè¿›å…ˆå‡ºçš„æ¬¡åºè¯»å–,ä¹Ÿå¯ä»¥æŒ‰æ¶ˆæ¯çš„ç±»å‹è¯»å–.æ¯” FIFO æ›´æœ‰ä¼˜åŠ¿ã€‚**æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·æ‰¿è½½ä¿¡æ¯é‡å°‘ï¼Œç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­— èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç¼ºç‚¹ã€‚**
5. **ä¿¡å·é‡(Semaphores)** ï¼šä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºå¤šè¿›ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼Œä¿¡å·é‡çš„æ„å›¾åœ¨äºè¿›ç¨‹é—´åŒæ­¥ã€‚è¿™ç§é€šä¿¡æ–¹å¼ä¸»è¦ç”¨äºè§£å†³ä¸åŒæ­¥ç›¸å…³çš„é—®é¢˜å¹¶é¿å…ç«äº‰æ¡ä»¶ã€‚
6. **å…±äº«å†…å­˜(Shared memory)** ï¼šä½¿å¾—å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹å¯ä»¥åŠæ—¶çœ‹åˆ°å¯¹æ–¹è¿›ç¨‹ä¸­å¯¹å…±äº«å†…å­˜ä¸­æ•°æ®çš„æ›´æ–°ã€‚è¿™ç§æ–¹å¼éœ€è¦ä¾é æŸç§åŒæ­¥æ“ä½œï¼Œå¦‚äº’æ–¥é”å’Œä¿¡å·é‡ç­‰ã€‚å¯ä»¥è¯´è¿™æ˜¯æœ€æœ‰ç”¨çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ã€‚
7. **å¥—æ¥å­—(Sockets)** : æ­¤æ–¹æ³•ä¸»è¦ç”¨äºåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´é€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚å¥—æ¥å­—æ˜¯æ”¯æŒ TCP/IP çš„ç½‘ç»œé€šä¿¡çš„åŸºæœ¬æ“ä½œå•å…ƒï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸åŒä¸»æœºä¹‹é—´çš„è¿›ç¨‹è¿›è¡ŒåŒå‘é€šä¿¡çš„ç«¯ç‚¹ï¼Œç®€å•çš„è¯´å°±æ˜¯é€šä¿¡çš„ä¸¤æ–¹çš„ä¸€ç§çº¦å®šï¼Œç”¨å¥—æ¥å­—ä¸­çš„ç›¸å…³å‡½æ•°æ¥å®Œæˆé€šä¿¡è¿‡ç¨‹ã€‚

#### çº¿ç¨‹é—´çš„åŒæ­¥çš„æ–¹å¼

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼š**é‚£çº¿ç¨‹é—´çš„åŒæ­¥çš„æ–¹å¼æœ‰å“ªäº›å‘¢?**

ğŸ™‹ **æˆ‘** ï¼šçº¿ç¨‹åŒæ­¥æ˜¯ä¸¤ä¸ªæˆ–å¤šä¸ªå…±äº«å…³é”®èµ„æºçš„çº¿ç¨‹çš„å¹¶å‘æ‰§è¡Œã€‚åº”è¯¥åŒæ­¥çº¿ç¨‹ä»¥é¿å…å…³é”®çš„èµ„æºä½¿ç”¨å†²çªã€‚æ“ä½œç³»ç»Ÿä¸€èˆ¬æœ‰ä¸‹é¢ä¸‰ç§çº¿ç¨‹åŒæ­¥çš„æ–¹å¼ï¼š

1. **äº’æ–¥é‡(Mutex)**ï¼šé‡‡ç”¨äº’æ–¥å¯¹è±¡æœºåˆ¶ï¼Œåªæœ‰æ‹¥æœ‰äº’æ–¥å¯¹è±¡çš„çº¿ç¨‹æ‰æœ‰è®¿é—®å…¬å…±èµ„æºçš„æƒé™ã€‚å› ä¸ºäº’æ–¥å¯¹è±¡åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯å…¬å…±èµ„æºä¸ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ã€‚æ¯”å¦‚ Java ä¸­çš„ synchronized å…³é”®è¯å’Œå„ç§ Lock éƒ½æ˜¯è¿™ç§æœºåˆ¶ã€‚
2. **ä¿¡å·é‡(Semaphore)** ï¼šå®ƒå…è®¸åŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºï¼Œä½†æ˜¯éœ€è¦æ§åˆ¶åŒä¸€æ—¶åˆ»è®¿é—®æ­¤èµ„æºçš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚
3. **äº‹ä»¶(Event)** :Wait/Notifyï¼šé€šè¿‡é€šçŸ¥æ“ä½œçš„æ–¹å¼æ¥ä¿æŒå¤šçº¿ç¨‹åŒæ­¥ï¼Œè¿˜å¯ä»¥æ–¹ä¾¿çš„å®ç°å¤šçº¿ç¨‹ä¼˜å…ˆçº§çš„æ¯”è¾ƒæ“ä½œ

#### è¿›ç¨‹çš„è°ƒåº¦ç®—æ³•

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼š**ä½ çŸ¥é“æ“ä½œç³»ç»Ÿä¸­è¿›ç¨‹çš„è°ƒåº¦ç®—æ³•æœ‰å“ªäº›å—?**

ğŸ™‹ **æˆ‘** ï¼šå—¯å—¯ï¼è¿™ä¸ªæˆ‘ä»¬å¤§å­¦çš„æ—¶å€™å­¦è¿‡ï¼Œæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„çŸ¥è¯†ç‚¹ï¼

ä¸ºäº†ç¡®å®šé¦–å…ˆæ‰§è¡Œå“ªä¸ªè¿›ç¨‹ä»¥åŠæœ€åæ‰§è¡Œå“ªä¸ªè¿›ç¨‹ä»¥å®ç°æœ€å¤§ CPU åˆ©ç”¨ç‡ï¼Œè®¡ç®—æœºç§‘å­¦å®¶å·²ç»å®šä¹‰äº†ä¸€äº›ç®—æ³•ï¼Œå®ƒä»¬æ˜¯ï¼š

- **å…ˆåˆ°å…ˆæœåŠ¡(FCFS)è°ƒåº¦ç®—æ³•** : ä»å°±ç»ªé˜Ÿåˆ—ä¸­é€‰æ‹©ä¸€ä¸ªæœ€å…ˆè¿›å…¥è¯¥é˜Ÿåˆ—çš„è¿›ç¨‹ä¸ºä¹‹åˆ†é…èµ„æºï¼Œä½¿å®ƒç«‹å³æ‰§è¡Œå¹¶ä¸€ç›´æ‰§è¡Œåˆ°å®Œæˆæˆ–å‘ç”ŸæŸäº‹ä»¶è€Œè¢«é˜»å¡æ”¾å¼ƒå ç”¨ CPU æ—¶å†é‡æ–°è°ƒåº¦ã€‚
- **çŸ­ä½œä¸šä¼˜å…ˆ(SJF)çš„è°ƒåº¦ç®—æ³•** : ä»å°±ç»ªé˜Ÿåˆ—ä¸­é€‰å‡ºä¸€ä¸ªä¼°è®¡è¿è¡Œæ—¶é—´æœ€çŸ­çš„è¿›ç¨‹ä¸ºä¹‹åˆ†é…èµ„æºï¼Œä½¿å®ƒç«‹å³æ‰§è¡Œå¹¶ä¸€ç›´æ‰§è¡Œåˆ°å®Œæˆæˆ–å‘ç”ŸæŸäº‹ä»¶è€Œè¢«é˜»å¡æ”¾å¼ƒå ç”¨ CPU æ—¶å†é‡æ–°è°ƒåº¦ã€‚
- **æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•** : æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦æ˜¯ä¸€ç§æœ€å¤è€ï¼Œæœ€ç®€å•ï¼Œæœ€å…¬å¹³ä¸”ä½¿ç”¨æœ€å¹¿çš„ç®—æ³•ï¼Œåˆç§° RR(Round robin)è°ƒåº¦ã€‚æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä½œå®ƒçš„æ—¶é—´ç‰‡ï¼Œå³è¯¥è¿›ç¨‹å…è®¸è¿è¡Œçš„æ—¶é—´ã€‚
- **å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•** ï¼šå‰é¢ä»‹ç»çš„å‡ ç§è¿›ç¨‹è°ƒåº¦çš„ç®—æ³•éƒ½æœ‰ä¸€å®šçš„å±€é™æ€§ã€‚å¦‚**çŸ­è¿›ç¨‹ä¼˜å…ˆçš„è°ƒåº¦ç®—æ³•ï¼Œä»…ç…§é¡¾äº†çŸ­è¿›ç¨‹è€Œå¿½ç•¥äº†é•¿è¿›ç¨‹** ã€‚å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•æ—¢èƒ½ä½¿é«˜ä¼˜å…ˆçº§çš„ä½œä¸šå¾—åˆ°å“åº”åˆèƒ½ä½¿çŸ­ä½œä¸šï¼ˆè¿›ç¨‹ï¼‰è¿…é€Ÿå®Œæˆã€‚ï¼Œå› è€Œå®ƒæ˜¯ç›®å‰**è¢«å…¬è®¤çš„ä¸€ç§è¾ƒå¥½çš„è¿›ç¨‹è°ƒåº¦ç®—æ³•**ï¼ŒUNIX æ“ä½œç³»ç»Ÿé‡‡å–çš„ä¾¿æ˜¯è¿™ç§è°ƒåº¦ç®—æ³•ã€‚
- **ä¼˜å…ˆçº§è°ƒåº¦** ï¼š ä¸ºæ¯ä¸ªæµç¨‹åˆ†é…ä¼˜å…ˆçº§ï¼Œé¦–å…ˆæ‰§è¡Œå…·æœ‰æœ€é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ï¼Œä¾æ­¤ç±»æ¨ã€‚å…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„è¿›ç¨‹ä»¥ FCFS æ–¹å¼æ‰§è¡Œã€‚å¯ä»¥æ ¹æ®å†…å­˜è¦æ±‚ï¼Œæ—¶é—´è¦æ±‚æˆ–ä»»ä½•å…¶ä»–èµ„æºè¦æ±‚æ¥ç¡®å®šä¼˜å…ˆçº§ã€‚

#### ä»€ä¹ˆæ˜¯æ­»é”

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼š**ä½ çŸ¥é“ä»€ä¹ˆæ˜¯æ­»é”å—?**

ğŸ™‹ **æˆ‘** ï¼šæ­»é”æè¿°çš„æ˜¯è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ã€‚ç”±äºè¿›ç¨‹/çº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢ã€‚

#### æ­»é”çš„å››ä¸ªæ¡ä»¶

ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼š**äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶æ˜¯ä»€ä¹ˆ?**

ğŸ™‹ **æˆ‘** ï¼šå¦‚æœç³»ç»Ÿä¸­ä»¥ä¸‹å››ä¸ªæ¡ä»¶åŒæ—¶æˆç«‹ï¼Œé‚£ä¹ˆå°±èƒ½å¼•èµ·æ­»é”ï¼š

- **äº’æ–¥**ï¼šèµ„æºå¿…é¡»å¤„äºéå…±äº«æ¨¡å¼ï¼Œå³ä¸€æ¬¡åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœå¦ä¸€è¿›ç¨‹ç”³è¯·è¯¥èµ„æºï¼Œé‚£ä¹ˆå¿…é¡»ç­‰å¾…ç›´åˆ°è¯¥èµ„æºè¢«é‡Šæ”¾ä¸ºæ­¢ã€‚
- **å æœ‰å¹¶ç­‰å¾…**ï¼šä¸€ä¸ªè¿›ç¨‹è‡³å°‘åº”è¯¥å æœ‰ä¸€ä¸ªèµ„æºï¼Œå¹¶ç­‰å¾…å¦ä¸€èµ„æºï¼Œè€Œè¯¥èµ„æºè¢«å…¶ä»–è¿›ç¨‹æ‰€å æœ‰ã€‚
- **éæŠ¢å **ï¼šèµ„æºä¸èƒ½è¢«æŠ¢å ã€‚åªèƒ½åœ¨æŒæœ‰èµ„æºçš„è¿›ç¨‹å®Œæˆä»»åŠ¡åï¼Œè¯¥èµ„æºæ‰ä¼šè¢«é‡Šæ”¾ã€‚
- **å¾ªç¯ç­‰å¾…**ï¼šæœ‰ä¸€ç»„ç­‰å¾…è¿›ç¨‹ `{P0, P1,..., Pn}`ï¼Œ `P0` ç­‰å¾…çš„èµ„æºè¢« `P1` å æœ‰ï¼Œ`P1` ç­‰å¾…çš„èµ„æºè¢« `P2` å æœ‰ï¼Œ......ï¼Œ`Pn-1` ç­‰å¾…çš„èµ„æºè¢« `Pn` å æœ‰ï¼Œ`Pn` ç­‰å¾…çš„èµ„æºè¢« `P0` å æœ‰ã€‚

#### é›¶æ‹·è´æ·±å…¥æµ…å‡º

##### DMA

åœ¨æ²¡æœ‰ DMA æŠ€æœ¯å‰ï¼ŒI/O çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

- CPU å‘å‡ºå¯¹åº”çš„æŒ‡ä»¤ç»™ç£ç›˜æ§åˆ¶å™¨ï¼Œç„¶åè¿”å›ï¼›
- ç£ç›˜æ§åˆ¶å™¨æ”¶åˆ°æŒ‡ä»¤åï¼Œäºæ˜¯å°±å¼€å§‹å‡†å¤‡æ•°æ®ï¼Œä¼šæŠŠæ•°æ®æ”¾å…¥åˆ°ç£ç›˜æ§åˆ¶å™¨çš„å†…éƒ¨ç¼“å†²åŒºä¸­ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ª**ä¸­æ–­**ï¼›
- CPU æ”¶åˆ°ä¸­æ–­ä¿¡å·åï¼Œåœä¸‹æ‰‹å¤´çš„å·¥ä½œï¼Œæ¥ç€æŠŠç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºçš„æ•°æ®ä¸€æ¬¡ä¸€ä¸ªå­—èŠ‚åœ°è¯»è¿›è‡ªå·±çš„å¯„å­˜å™¨ï¼Œç„¶åå†æŠŠå¯„å­˜å™¨é‡Œçš„æ•°æ®å†™å…¥åˆ°å†…å­˜ï¼Œè€Œåœ¨æ•°æ®ä¼ è¾“çš„æœŸé—´ CPU æ˜¯æ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡çš„ã€‚

ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€å‰¯å›¾ï¼š

![image-20220702132804386](./images/image-20220702132804386.png)

å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªæ•°æ®çš„ä¼ è¾“è¿‡ç¨‹ï¼Œéƒ½è¦éœ€è¦ CPU äº²è‡ªå‚ä¸æ¬è¿æ•°æ®çš„è¿‡ç¨‹ï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹ï¼ŒCPU æ˜¯ä¸èƒ½åšå…¶ä»–äº‹æƒ…çš„ã€‚

ç®€å•çš„æ¬è¿å‡ ä¸ªå­—ç¬¦æ•°æ®é‚£æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ç”¨åƒå…†ç½‘å¡æˆ–è€…ç¡¬ç›˜ä¼ è¾“å¤§é‡æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ç”¨ CPU æ¥æ¬è¿çš„è¯ï¼Œè‚¯å®šå¿™ä¸è¿‡æ¥ã€‚

è®¡ç®—æœºç§‘å­¦å®¶ä»¬å‘ç°äº†äº‹æƒ…çš„ä¸¥é‡æ€§åï¼Œäºæ˜¯å°±å‘æ˜äº† DMA æŠ€æœ¯ï¼Œä¹Ÿå°±æ˜¯**ç›´æ¥å†…å­˜è®¿é—®ï¼ˆ\*Direct Memory Access\*ï¼‰** æŠ€æœ¯ã€‚

ä»€ä¹ˆæ˜¯ DMA æŠ€æœ¯ï¼Ÿç®€å•ç†è§£å°±æ˜¯ï¼Œ**åœ¨è¿›è¡Œ I/O è®¾å¤‡å’Œå†…å­˜çš„æ•°æ®ä¼ è¾“çš„æ—¶å€™ï¼Œæ•°æ®æ¬è¿çš„å·¥ä½œå…¨éƒ¨äº¤ç»™ DMA æ§åˆ¶å™¨ï¼Œè€Œ CPU ä¸å†å‚ä¸ä»»ä½•ä¸æ•°æ®æ¬è¿ç›¸å…³çš„äº‹æƒ…ï¼Œè¿™æ · CPU å°±å¯ä»¥å»å¤„ç†åˆ«çš„äº‹åŠ¡**ã€‚

é‚£ä½¿ç”¨ DMA æ§åˆ¶å™¨è¿›è¡Œæ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹ã€‚

![image-20220702132824828](./images/image-20220702132824828.png)

å…·ä½“è¿‡ç¨‹ï¼š

- ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ read æ–¹æ³•ï¼Œå‘æ“ä½œç³»ç»Ÿå‘å‡º I/O è¯·æ±‚ï¼Œè¯·æ±‚è¯»å–æ•°æ®åˆ°è‡ªå·±çš„å†…å­˜ç¼“å†²åŒºä¸­ï¼Œè¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼›
- æ“ä½œç³»ç»Ÿæ”¶åˆ°è¯·æ±‚åï¼Œè¿›ä¸€æ­¥å°† I/O è¯·æ±‚å‘é€ DMAï¼Œç„¶åè®© CPU æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼›
- DMA è¿›ä¸€æ­¥å°† I/O è¯·æ±‚å‘é€ç»™ç£ç›˜ï¼›
- ç£ç›˜æ”¶åˆ° DMA çš„ I/O è¯·æ±‚ï¼ŒæŠŠæ•°æ®ä»ç£ç›˜è¯»å–åˆ°ç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºä¸­ï¼Œå½“ç£ç›˜æ§åˆ¶å™¨çš„ç¼“å†²åŒºè¢«è¯»æ»¡åï¼Œå‘ DMA å‘èµ·ä¸­æ–­ä¿¡å·ï¼Œå‘ŠçŸ¥è‡ªå·±ç¼“å†²åŒºå·²æ»¡ï¼›
- **DMA æ”¶åˆ°ç£ç›˜çš„ä¿¡å·ï¼Œå°†ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œæ­¤æ—¶ä¸å ç”¨ CPUï¼ŒCPU å¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡**ï¼›
- å½“ DMA è¯»å–äº†è¶³å¤Ÿå¤šçš„æ•°æ®ï¼Œå°±ä¼šå‘é€ä¸­æ–­ä¿¡å·ç»™ CPUï¼›
- CPU æ”¶åˆ° DMA çš„ä¿¡å·ï¼ŒçŸ¥é“æ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œäºæ˜¯å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›ï¼›

å¯ä»¥çœ‹åˆ°ï¼Œ æ•´ä¸ªæ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ï¼ŒCPU ä¸å†å‚ä¸æ•°æ®æ¬è¿çš„å·¥ä½œï¼Œè€Œæ˜¯å…¨ç¨‹ç”± DMA å®Œæˆï¼Œä½†æ˜¯ CPU åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå› ä¸ºä¼ è¾“ä»€ä¹ˆæ•°æ®ï¼Œä»å“ªé‡Œä¼ è¾“åˆ°å“ªé‡Œï¼Œéƒ½éœ€è¦ CPU æ¥å‘Šè¯‰ DMA æ§åˆ¶å™¨ã€‚

æ—©æœŸ DMA åªå­˜åœ¨åœ¨ä¸»æ¿ä¸Šï¼Œå¦‚ä»Šç”±äº I/O è®¾å¤‡è¶Šæ¥è¶Šå¤šï¼Œæ•°æ®ä¼ è¾“çš„éœ€æ±‚ä¹Ÿä¸å°½ç›¸åŒï¼Œæ‰€ä»¥æ¯ä¸ª I/O è®¾å¤‡é‡Œé¢éƒ½æœ‰è‡ªå·±çš„ DMA æ§åˆ¶å™¨

##### å¦‚ä½•å®ç°é›¶æ‹·è´ï¼Ÿ

é›¶æ‹·è´æŠ€æœ¯å®ç°çš„æ–¹å¼é€šå¸¸æœ‰ 2 ç§ï¼š

- mmap + write
- sendfile

ä¸‹é¢å°±è°ˆä¸€è°ˆï¼Œå®ƒä»¬æ˜¯å¦‚ä½•å‡å°‘ã€Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€å’Œã€Œæ•°æ®æ‹·è´ã€çš„æ¬¡æ•°ã€‚

###### mmap + write

åœ¨å‰é¢æˆ‘ä»¬çŸ¥é“ï¼Œ`read()` ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ä¸­ä¼šæŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·çš„ç¼“å†²åŒºé‡Œï¼Œäºæ˜¯ä¸ºäº†å‡å°‘è¿™ä¸€æ­¥å¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `mmap()` æ›¿æ¢ `read()` ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚

```c
buf = mmap(file, len);
write(sockfd, buf, len);
```

`mmap()` ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¼šç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®ã€Œ**æ˜ å°„**ã€åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•çš„æ•°æ®æ‹·è´æ“ä½œã€‚

![image-20220702133239391](./images/image-20220702133239391.png)

å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

- åº”ç”¨è¿›ç¨‹è°ƒç”¨äº† `mmap()` åï¼ŒDMA ä¼šæŠŠç£ç›˜çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸çš„ç¼“å†²åŒºé‡Œã€‚æ¥ç€ï¼Œåº”ç”¨è¿›ç¨‹è·Ÿæ“ä½œç³»ç»Ÿå†…æ ¸ã€Œå…±äº«ã€è¿™ä¸ªç¼“å†²åŒºï¼›
- åº”ç”¨è¿›ç¨‹å†è°ƒç”¨ `write()`ï¼Œæ“ä½œç³»ç»Ÿç›´æ¥å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œç”± CPU æ¥æ¬è¿æ•°æ®ï¼›
- æœ€åï¼ŒæŠŠå†…æ ¸çš„ socket ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œæ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ç”± DMA æ¬è¿çš„ã€‚

æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œé€šè¿‡ä½¿ç”¨ `mmap()` æ¥ä»£æ›¿ `read()`ï¼Œ å¯ä»¥å‡å°‘ä¸€æ¬¡æ•°æ®æ‹·è´çš„è¿‡ç¨‹ã€‚

ä½†è¿™è¿˜ä¸æ˜¯æœ€ç†æƒ³çš„é›¶æ‹·è´ï¼Œå› ä¸ºä»ç„¶éœ€è¦é€šè¿‡ CPU æŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œè€Œä¸”ä»ç„¶éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨è¿˜æ˜¯ 2 æ¬¡ã€‚

###### sendfile

åœ¨ Linux å†…æ ¸ç‰ˆæœ¬ 2.1 ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªä¸“é—¨å‘é€æ–‡ä»¶çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•° `sendfile()`ï¼Œå‡½æ•°å½¢å¼å¦‚ä¸‹ï¼š

```c
#include <sys/socket.h>
ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);
```

å®ƒçš„å‰ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ç›®çš„ç«¯å’Œæºç«¯çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåé¢ä¸¤ä¸ªå‚æ•°æ˜¯æºç«¯çš„åç§»é‡å’Œå¤åˆ¶æ•°æ®çš„é•¿åº¦ï¼Œè¿”å›å€¼æ˜¯å®é™…å¤åˆ¶æ•°æ®çš„é•¿åº¦ã€‚

é¦–å…ˆï¼Œå®ƒå¯ä»¥æ›¿ä»£å‰é¢çš„ `read()` å’Œ `write()` è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±å‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚

å…¶æ¬¡ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œä¸å†æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œè¿™æ ·å°±åªæœ‰ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ 3 æ¬¡æ•°æ®æ‹·è´ã€‚å¦‚ä¸‹å›¾ï¼š

![image-20220702133308560](./images/image-20220702133308560.png)

ä½†æ˜¯è¿™è¿˜ä¸æ˜¯çœŸæ­£çš„é›¶æ‹·è´æŠ€æœ¯ï¼Œå¦‚æœç½‘å¡æ”¯æŒ SG-DMAï¼ˆ*The Scatter-Gather Direct Memory Access*ï¼‰æŠ€æœ¯ï¼ˆå’Œæ™®é€šçš„ DMA æœ‰æ‰€ä¸åŒï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥å‡å°‘é€šè¿‡ CPU æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºçš„è¿‡ç¨‹ã€‚

ä½ å¯ä»¥åœ¨ä½ çš„ Linux ç³»ç»Ÿé€šè¿‡ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼ŒæŸ¥çœ‹ç½‘å¡æ˜¯å¦æ”¯æŒ scatter-gather ç‰¹æ€§ï¼š

```bash
$ ethtool -k eth0 | grep scatter-gather
scatter-gather: on
```

äºæ˜¯ï¼Œä» Linux å†…æ ¸ `2.4` ç‰ˆæœ¬å¼€å§‹èµ·ï¼Œå¯¹äºæ”¯æŒç½‘å¡æ”¯æŒ SG-DMA æŠ€æœ¯çš„æƒ…å†µä¸‹ï¼Œ `sendfile()` ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹å‘ç”Ÿäº†ç‚¹å˜åŒ–ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ DMA å°†ç£ç›˜ä¸Šçš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºé‡Œï¼›
- ç¬¬äºŒæ­¥ï¼Œç¼“å†²åŒºæè¿°ç¬¦å’Œæ•°æ®é•¿åº¦ä¼ åˆ° socket ç¼“å†²åŒºï¼Œè¿™æ ·ç½‘å¡çš„ SG-DMA æ§åˆ¶å™¨å°±å¯ä»¥ç›´æ¥å°†å†…æ ¸ç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œæ­¤è¿‡ç¨‹ä¸éœ€è¦å°†æ•°æ®ä»æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™æ ·å°±å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼›

æ‰€ä»¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹‹ä¸­ï¼Œåªè¿›è¡Œäº† 2 æ¬¡æ•°æ®æ‹·è´ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20220702133318801](./images/image-20220702133318801.png)

è¿™å°±æ˜¯æ‰€è°“çš„**é›¶æ‹·è´ï¼ˆ\*Zero-copy\*ï¼‰æŠ€æœ¯ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨å†…å­˜å±‚é¢å»æ‹·è´æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å…¨ç¨‹æ²¡æœ‰é€šè¿‡ CPU æ¥æ¬è¿æ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é€šè¿‡ DMA æ¥è¿›è¡Œä¼ è¾“çš„ã€‚**ã€‚

é›¶æ‹·è´æŠ€æœ¯çš„æ–‡ä»¶ä¼ è¾“æ–¹å¼ç›¸æ¯”ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“çš„æ–¹å¼ï¼Œå‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œ**åªéœ€è¦ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œå°±å¯ä»¥å®Œæˆæ–‡ä»¶çš„ä¼ è¾“ï¼Œè€Œä¸” 2 æ¬¡çš„æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œéƒ½ä¸éœ€è¦é€šè¿‡ CPUï¼Œ2 æ¬¡éƒ½æ˜¯ç”± DMA æ¥æ¬è¿ã€‚**

æ‰€ä»¥ï¼Œæ€»ä½“æ¥çœ‹ï¼Œ**é›¶æ‹·è´æŠ€æœ¯å¯ä»¥æŠŠæ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½æé«˜è‡³å°‘ä¸€å€ä»¥ä¸Š**

##### ä½¿ç”¨é›¶æ‹·è´æŠ€æœ¯çš„é¡¹ç›®

äº‹å®ä¸Šï¼ŒKafka è¿™ä¸ªå¼€æºé¡¹ç›®ï¼Œå°±åˆ©ç”¨äº†ã€Œé›¶æ‹·è´ã€æŠ€æœ¯ï¼Œä»è€Œå¤§å¹…æå‡äº† I/O çš„ååç‡ï¼Œè¿™ä¹Ÿæ˜¯ Kafka åœ¨å¤„ç†æµ·é‡æ•°æ®ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«çš„åŸå› ä¹‹ä¸€ã€‚

å¦‚æœä½ è¿½æº¯ Kafka æ–‡ä»¶ä¼ è¾“çš„ä»£ç ï¼Œä½ ä¼šå‘ç°ï¼Œæœ€ç»ˆå®ƒè°ƒç”¨äº† Java NIO åº“é‡Œçš„ `transferTo` æ–¹æ³•ï¼š

```java
@Overridepublic 
long transferFrom(FileChannel fileChannel, long position, long count) throws IOException { 
    return fileChannel.transferTo(position, count, socketChannel);
}
```

å¦‚æœ Linux ç³»ç»Ÿæ”¯æŒ `sendfile()` ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆ `transferTo()` å®é™…ä¸Šæœ€åå°±ä¼šä½¿ç”¨åˆ° `sendfile()` ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚

æ›¾ç»æœ‰å¤§ä½¬ä¸“é—¨å†™è¿‡ç¨‹åºæµ‹è¯•è¿‡ï¼Œåœ¨åŒæ ·çš„ç¡¬ä»¶æ¡ä»¶ä¸‹ï¼Œä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“å’Œé›¶æ‹·æ‹·è´æ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½å·®å¼‚ï¼Œä½ å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™å¼ æµ‹è¯•æ•°æ®å›¾ï¼Œä½¿ç”¨äº†é›¶æ‹·è´èƒ½å¤Ÿç¼©çŸ­ `65%` çš„æ—¶é—´ï¼Œå¤§å¹…åº¦æå‡äº†æœºå™¨ä¼ è¾“æ•°æ®çš„ååé‡ã€‚

![image-20220702133411785](./images/image-20220702133411785.png)

å¦å¤–ï¼ŒNginx ä¹Ÿæ”¯æŒé›¶æ‹·è´æŠ€æœ¯ï¼Œä¸€èˆ¬é»˜è®¤æ˜¯å¼€å¯é›¶æ‹·è´æŠ€æœ¯ï¼Œè¿™æ ·æœ‰åˆ©äºæé«˜æ–‡ä»¶ä¼ è¾“çš„æ•ˆç‡ï¼Œæ˜¯å¦å¼€å¯é›¶æ‹·è´æŠ€æœ¯çš„é…ç½®å¦‚ä¸‹ï¼š

```text
http {
...
    sendfile on
...
}
```

sendfile é…ç½®çš„å…·ä½“æ„æ€:

- è®¾ç½®ä¸º on è¡¨ç¤ºï¼Œä½¿ç”¨é›¶æ‹·è´æŠ€æœ¯æ¥ä¼ è¾“æ–‡ä»¶ï¼šsendfile ï¼Œè¿™æ ·åªéœ€è¦ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ 2 æ¬¡æ•°æ®æ‹·è´ã€‚
- è®¾ç½®ä¸º off è¡¨ç¤ºï¼Œä½¿ç”¨ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æŠ€æœ¯ï¼šread + writeï¼Œè¿™æ—¶å°±éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ 4 æ¬¡æ•°æ®æ‹·è´ã€‚

å½“ç„¶ï¼Œè¦ä½¿ç”¨ sendfileï¼ŒLinux å†…æ ¸ç‰ˆæœ¬å¿…é¡»è¦ 2.1 ä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚

#### åƒµå°¸è¿›ç¨‹å’Œå­¤å„¿è¿›ç¨‹

##### åƒµå°¸è¿›ç¨‹

ä¸€ä¸ªå­è¿›ç¨‹ç»“æŸåï¼Œå®ƒçš„çˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰ç­‰å¾…å®ƒï¼ˆè°ƒç”¨waitæˆ–è€…waitpidï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªå­è¿›ç¨‹å°†æˆä¸ºä¸€ä¸ªåƒµå°¸è¿›ç¨‹ã€‚åƒµå°¸è¿›ç¨‹æ˜¯ä¸€ä¸ªå·²ç»æ­»äº¡çš„è¿›ç¨‹ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰çœŸæ­£è¢«é”€æ¯ã€‚å®ƒå·²ç»æ”¾å¼ƒäº†å‡ ä¹æ‰€æœ‰å†…å­˜ç©ºé—´ï¼Œæ²¡æœ‰ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼Œä¹Ÿä¸èƒ½è¢«è°ƒåº¦ï¼Œä»…ä»…åœ¨è¿›ç¨‹è¡¨ä¸­ä¿ç•™ä¸€ä¸ªä½ç½®ï¼Œè®°è½½è¯¥è¿›ç¨‹çš„è¿›ç¨‹IDã€ç»ˆæ­¢çŠ¶æ€ä»¥åŠèµ„æºåˆ©ç”¨ä¿¡æ¯(CPUæ—¶é—´ï¼Œå†…å­˜ä½¿ç”¨é‡ç­‰ç­‰)ä¾›çˆ¶è¿›ç¨‹æ”¶é›†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåƒµå°¸è¿›ç¨‹ä¸å†å æœ‰ä»»ä½•å†…å­˜ç©ºé—´ã€‚è¿™ä¸ªåƒµå°¸è¿›ç¨‹å¯èƒ½ä¼šä¸€ç›´ç•™åœ¨ç³»ç»Ÿä¸­ç›´åˆ°ç³»ç»Ÿé‡å¯ã€‚

> ã€Šç™¾åº¦ç™¾ç§‘ã€‹è§£é‡Šï¼šåœ¨æ“ä½œç³»ç»Ÿé¢†åŸŸä¸­ï¼Œå­¤å„¿è¿›ç¨‹æŒ‡çš„**æ˜¯åœ¨å…¶çˆ¶è¿›ç¨‹æ‰§è¡Œå®Œæˆæˆ–è¢«ç»ˆæ­¢åä»ç»§ç»­è¿è¡Œçš„ä¸€ç±»è¿›ç¨‹**ã€‚è¿™äº›å­¤å„¿è¿›ç¨‹å°†è¢«initè¿›ç¨‹ (è¿›ç¨‹å·ä¸º1)æ‰€æ”¶å…»ï¼Œå¹¶ç”±initè¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚

å±å®³ï¼šå ç”¨è¿›ç¨‹å·ï¼Œè€Œç³»ç»Ÿæ‰€èƒ½ä½¿ç”¨çš„è¿›ç¨‹å·æ˜¯æœ‰é™çš„ï¼›å ç”¨å†…å­˜ã€‚

ä»¥ä¸‹æƒ…å†µä¸ä¼šäº§ç”Ÿåƒµå°¸è¿›ç¨‹ï¼š

- è¯¥è¿›ç¨‹çš„çˆ¶è¿›ç¨‹å…ˆç»“æŸäº†ã€‚æ¯ä¸ªè¿›ç¨‹ç»“æŸçš„æ—¶å€™ï¼Œç³»ç»Ÿéƒ½ä¼šæ‰«ææ˜¯å¦å­˜åœ¨å­è¿›ç¨‹ï¼Œå¦‚æœæœ‰åˆ™ç”¨Initè¿›ç¨‹æ¥ç®¡ï¼Œæˆä¸ºè¯¥è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨waitç­‰å¾…å…¶ç»“æŸã€‚
- çˆ¶è¿›ç¨‹è°ƒç”¨waitæˆ–è€…waitpidç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼ˆéœ€è¦æ¯éš”ä¸€æ®µæ—¶é—´æŸ¥è¯¢å­è¿›ç¨‹æ˜¯å¦ç»“æŸï¼‰ã€‚waitç³»ç»Ÿè°ƒç”¨ä¼šä½¿çˆ¶è¿›ç¨‹æš‚åœæ‰§è¡Œï¼Œç›´åˆ°å®ƒçš„ä¸€ä¸ªå­è¿›ç¨‹ç»“æŸä¸ºæ­¢ã€‚waitpidåˆ™å¯ä»¥åŠ å…¥ `WNOHANG`(wait-no-hang)é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰å‘ç°ç»“æŸçš„å­è¿›ç¨‹ï¼Œå°±ä¼šç«‹å³è¿”å›ï¼Œä¸ä¼šå°†è°ƒç”¨waitpidçš„è¿›ç¨‹é˜»å¡ã€‚åŒæ—¶ï¼Œwaitpidè¿˜å¯ä»¥é€‰æ‹©æ˜¯ç­‰å¾…ä»»ä¸€å­è¿›ç¨‹ï¼ˆåŒwaitï¼‰ï¼Œè¿˜æ˜¯ç­‰å¾…æŒ‡å®špidçš„å­è¿›ç¨‹ï¼Œè¿˜æ˜¯ç­‰å¾…åŒä¸€è¿›ç¨‹ç»„ä¸‹çš„ä»»ä¸€å­è¿›ç¨‹ï¼Œè¿˜æ˜¯ç­‰å¾…ç»„IDç­‰äºpidçš„ä»»ä¸€å­è¿›ç¨‹ï¼›
- å­è¿›ç¨‹ç»“æŸæ—¶ï¼Œç³»ç»Ÿä¼šäº§ç”Ÿ `SIGCHLD`(signal-child)ä¿¡å·ï¼Œå¯ä»¥æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­è°ƒç”¨waitpidï¼Œç­‰å¾…æ‰€æœ‰ç»“æŸçš„å­è¿›ç¨‹ï¼ˆæ³¨æ„ï¼šä¸€èˆ¬éƒ½éœ€è¦å¾ªç¯è°ƒç”¨waitpidï¼Œå› ä¸ºåœ¨ä¿¡å·å¤„ç†å‡½æ•°å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œå¯èƒ½å·²ç»æœ‰å¤šä¸ªå­è¿›ç¨‹ç»“æŸäº†ï¼Œè€Œä¿¡å·å¤„ç†å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥è¦å¾ªç¯è°ƒç”¨å°†æ‰€æœ‰ç»“æŸçš„å­è¿›ç¨‹å›æ”¶ï¼‰ï¼›
- ä¹Ÿå¯ä»¥ç”¨ `signal(SIGCLD, SIG_IGN)`(signal-ignore)é€šçŸ¥å†…æ ¸ï¼Œè¡¨ç¤ºå¿½ç•¥ `SIGCHLD`ä¿¡å·ï¼Œé‚£ä¹ˆå­è¿›ç¨‹ç»“æŸåï¼Œå†…æ ¸ä¼šè¿›è¡Œå›æ”¶ã€‚

##### å­¤å„¿è¿›ç¨‹

ä¸€ä¸ªçˆ¶è¿›ç¨‹å·²ç»ç»“æŸäº†ï¼Œä½†æ˜¯å®ƒçš„å­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆè¿™äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹ä¼šè¢«Initï¼ˆè¿›ç¨‹IDä¸º1ï¼‰æ¥ç®¡ï¼Œå½“è¿™äº›å­¤å„¿è¿›ç¨‹ç»“æŸæ—¶ç”±Initå®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚

### ğŸ§©æ•°æ®ç»“æ„

#### çº¢é»‘æ ‘

**çº¢é»‘æ ‘ç‰¹ç‚¹** :

1. æ¯ä¸ªèŠ‚ç‚¹éçº¢å³é»‘ï¼›
2. æ ¹èŠ‚ç‚¹æ€»æ˜¯é»‘è‰²çš„ï¼›
3. æ¯ä¸ªå¶å­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²çš„ç©ºèŠ‚ç‚¹ï¼ˆNILèŠ‚ç‚¹ï¼‰ï¼›
4. å¦‚æœèŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œåˆ™å®ƒçš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²çš„ï¼ˆåä¹‹ä¸ä¸€å®šï¼‰ï¼›
5. ä»æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æˆ–ç©ºå­èŠ‚ç‚¹çš„æ¯æ¡è·¯å¾„ï¼Œå¿…é¡»åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ï¼ˆå³ç›¸åŒçš„é»‘è‰²é«˜åº¦ï¼‰ã€‚

**çº¢é»‘æ ‘çš„åº”ç”¨** ï¼šTreeMapã€TreeSetä»¥åŠJDK1.8çš„HashMapåº•å±‚éƒ½ç”¨åˆ°äº†çº¢é»‘æ ‘ã€‚

**ä¸ºä»€ä¹ˆè¦ç”¨çº¢é»‘æ ‘ï¼Ÿ** ç®€å•æ¥è¯´çº¢é»‘æ ‘å°±æ˜¯ä¸ºäº†è§£å†³äºŒå‰æŸ¥æ‰¾æ ‘çš„ç¼ºé™·ï¼Œå› ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€€åŒ–æˆä¸€ä¸ªçº¿æ€§ç»“æ„ã€‚è¯¦ç»†äº†è§£å¯ä»¥æŸ¥çœ‹ [æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯çº¢é»‘æ ‘ï¼Ÿopen in new window](https://juejin.im/post/5a27c6946fb9a04509096248#comment)ï¼ˆä¹Ÿä»‹ç»åˆ°äº†äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œéå¸¸æ¨èï¼‰

**ç›¸å…³é˜…è¯»** ï¼š[ã€Šçº¢é»‘æ ‘æ·±å…¥å‰–æåŠJavaå®ç°ã€‹open in new window](https://zhuanlan.zhihu.com/p/24367771)ï¼ˆç¾å›¢ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿï¼‰



#### åå¤§ç»å…¸æ’åºç®—æ³•

##### ç®€ä»‹

æ’åºç®—æ³•å¯ä»¥åˆ†ä¸ºï¼š

- **å†…éƒ¨æ’åº** ï¼šæ•°æ®è®°å½•åœ¨å†…å­˜ä¸­è¿›è¡Œæ’åºã€‚
- **[å¤–éƒ¨æ’åº](https://zh.wikipedia.org/wiki/å¤–æ’åº)** ï¼šå› æ’åºçš„æ•°æ®å¾ˆå¤§ï¼Œä¸€æ¬¡ä¸èƒ½å®¹çº³å…¨éƒ¨çš„æ’åºè®°å½•ï¼Œåœ¨æ’åºè¿‡ç¨‹ä¸­éœ€è¦è®¿é—®å¤–å­˜ã€‚

å¸¸è§çš„å†…éƒ¨æ’åºç®—æ³•æœ‰ï¼š**æ’å…¥æ’åº**ã€**å¸Œå°”æ’åº**ã€**é€‰æ‹©æ’åº**ã€**å†’æ³¡æ’åº**ã€**å½’å¹¶æ’åº**ã€**å¿«é€Ÿæ’åº**ã€**å †æ’åº**ã€**åŸºæ•°æ’åº**ç­‰ï¼Œæœ¬æ–‡åªè®²è§£å†…éƒ¨æ’åºç®—æ³•ã€‚ç”¨ä¸€å¼ å›¾æ¦‚æ‹¬ï¼š

![åå¤§æ’åºç®—æ³•](./images/sort1.png)

**å›¾ç‰‡åè¯è§£é‡Šï¼š**

- **n**ï¼šæ•°æ®è§„æ¨¡
- **k**ï¼šâ€œæ¡¶â€ çš„ä¸ªæ•°
- **In-place**ï¼šå ç”¨å¸¸æ•°å†…å­˜ï¼Œä¸å ç”¨é¢å¤–å†…å­˜
- **Out-place**ï¼šå ç”¨é¢å¤–å†…å­˜

###### æœ¯è¯­è¯´æ˜

- **ç¨³å®š**ï¼šå¦‚æœ A åŸæœ¬åœ¨ B å‰é¢ï¼Œè€Œ A=Bï¼Œæ’åºä¹‹å A ä»ç„¶åœ¨ B çš„å‰é¢ã€‚
- **ä¸ç¨³å®š**ï¼šå¦‚æœ A åŸæœ¬åœ¨ B çš„å‰é¢ï¼Œè€Œ A=Bï¼Œæ’åºä¹‹å A å¯èƒ½ä¼šå‡ºç°åœ¨ B çš„åé¢ã€‚
- **å†…æ’åº**ï¼šæ‰€æœ‰æ’åºæ“ä½œéƒ½åœ¨å†…å­˜ä¸­å®Œæˆã€‚
- **å¤–æ’åº**ï¼šç”±äºæ•°æ®å¤ªå¤§ï¼Œå› æ­¤æŠŠæ•°æ®æ”¾åœ¨ç£ç›˜ä¸­ï¼Œè€Œæ’åºé€šè¿‡ç£ç›˜å’Œå†…å­˜çš„æ•°æ®ä¼ è¾“æ‰èƒ½è¿›è¡Œã€‚
- **æ—¶é—´å¤æ‚åº¦**ï¼š å®šæ€§æè¿°ä¸€ä¸ªç®—æ³•æ‰§è¡Œæ‰€è€—è´¹çš„æ—¶é—´ã€‚
- **ç©ºé—´å¤æ‚åº¦**ï¼šå®šæ€§æè¿°ä¸€ä¸ªç®—æ³•æ‰§è¡Œæ‰€éœ€å†…å­˜çš„å¤§å°ã€‚

###### ç®—æ³•åˆ†ç±»

åç§å¸¸è§æ’åºç®—æ³•å¯ä»¥åˆ†ç±»ä¸¤å¤§ç±»åˆ«ï¼š**æ¯”è¾ƒç±»æ’åº**å’Œ**éæ¯”è¾ƒç±»æ’åº**ã€‚

![1658302145982](./images/1658302145982.png)

å¸¸è§çš„**å¿«é€Ÿæ’åº**ã€**å½’å¹¶æ’åº**ã€**å †æ’åº**ä»¥åŠ**å†’æ³¡æ’åº**ç­‰éƒ½å±äº**æ¯”è¾ƒç±»æ’åºç®—æ³•**ã€‚æ¯”è¾ƒç±»æ’åºæ˜¯é€šè¿‡æ¯”è¾ƒæ¥å†³å®šå…ƒç´ é—´çš„ç›¸å¯¹æ¬¡åºï¼Œç”±äºå…¶æ—¶é—´å¤æ‚åº¦ä¸èƒ½çªç ´ `O(nlogn)`ï¼Œå› æ­¤ä¹Ÿç§°ä¸ºéçº¿æ€§æ—¶é—´æ¯”è¾ƒç±»æ’åºã€‚åœ¨å†’æ³¡æ’åºä¹‹ç±»çš„æ’åºä¸­ï¼Œé—®é¢˜è§„æ¨¡ä¸º `n`ï¼Œåˆå› ä¸ºéœ€è¦æ¯”è¾ƒ `n` æ¬¡ï¼Œæ‰€ä»¥å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º `O(nÂ²)`ã€‚åœ¨**å½’å¹¶æ’åº**ã€**å¿«é€Ÿæ’åº**ä¹‹ç±»çš„æ’åºä¸­ï¼Œé—®é¢˜è§„æ¨¡é€šè¿‡**åˆ†æ²»æ³•**æ¶ˆå‡ä¸º `logn` æ¬¡ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦å¹³å‡ `O(nlogn)`ã€‚

æ¯”è¾ƒç±»æ’åºçš„ä¼˜åŠ¿æ˜¯ï¼Œé€‚ç”¨äºå„ç§è§„æ¨¡çš„æ•°æ®ï¼Œä¹Ÿä¸åœ¨ä¹æ•°æ®çš„åˆ†å¸ƒï¼Œéƒ½èƒ½è¿›è¡Œæ’åºã€‚å¯ä»¥è¯´ï¼Œæ¯”è¾ƒæ’åºé€‚ç”¨äºä¸€åˆ‡éœ€è¦æ’åºçš„æƒ…å†µã€‚

è€Œ**è®¡æ•°æ’åº**ã€**åŸºæ•°æ’åº**ã€**æ¡¶æ’åº**åˆ™å±äº**éæ¯”è¾ƒç±»æ’åºç®—æ³•**ã€‚éæ¯”è¾ƒæ’åºä¸é€šè¿‡æ¯”è¾ƒæ¥å†³å®šå…ƒç´ é—´çš„ç›¸å¯¹æ¬¡åºï¼Œè€Œæ˜¯é€šè¿‡ç¡®å®šæ¯ä¸ªå…ƒç´ ä¹‹å‰ï¼Œåº”è¯¥æœ‰å¤šå°‘ä¸ªå…ƒç´ æ¥æ’åºã€‚ç”±äºå®ƒå¯ä»¥çªç ´åŸºäºæ¯”è¾ƒæ’åºçš„æ—¶é—´ä¸‹ç•Œï¼Œä»¥çº¿æ€§æ—¶é—´è¿è¡Œï¼Œå› æ­¤ç§°ä¸ºçº¿æ€§æ—¶é—´éæ¯”è¾ƒç±»æ’åºã€‚ éæ¯”è¾ƒæ’åºåªè¦ç¡®å®šæ¯ä¸ªå…ƒç´ ä¹‹å‰çš„å·²æœ‰çš„å…ƒç´ ä¸ªæ•°å³å¯ï¼Œæ‰€æœ‰ä¸€æ¬¡éå†å³å¯è§£å†³ã€‚ç®—æ³•æ—¶é—´å¤æ‚åº¦ `O(n)`ã€‚

éæ¯”è¾ƒæ’åºæ—¶é—´å¤æ‚åº¦åº•ï¼Œä½†ç”±äºéæ¯”è¾ƒæ’åºéœ€è¦å ç”¨ç©ºé—´æ¥ç¡®å®šå”¯ä¸€ä½ç½®ã€‚æ‰€ä»¥å¯¹æ•°æ®è§„æ¨¡å’Œæ•°æ®åˆ†å¸ƒæœ‰ä¸€å®šçš„è¦æ±‚ã€‚



##### å†’æ³¡æ’åº (Bubble Sort)

å†’æ³¡æ’åºæ˜¯ä¸€ç§ç®€å•çš„æ’åºç®—æ³•ã€‚å®ƒé‡å¤åœ°éå†è¦æ’åºçš„åºåˆ—ï¼Œä¾æ¬¡æ¯”è¾ƒä¸¤ä¸ªå…ƒç´ ï¼Œå¦‚æœå®ƒä»¬çš„é¡ºåºé”™è¯¯å°±æŠŠå®ƒä»¬äº¤æ¢è¿‡æ¥ã€‚éå†åºåˆ—çš„å·¥ä½œæ˜¯é‡å¤åœ°è¿›è¡Œç›´åˆ°æ²¡æœ‰å†éœ€è¦äº¤æ¢ä¸ºæ­¢ï¼Œæ­¤æ—¶è¯´æ˜è¯¥åºåˆ—å·²ç»æ’åºå®Œæˆã€‚è¿™ä¸ªç®—æ³•çš„åå­—ç”±æ¥æ˜¯å› ä¸ºè¶Šå°çš„å…ƒç´ ä¼šç»ç”±äº¤æ¢æ…¢æ…¢ â€œæµ®â€ åˆ°æ•°åˆ—çš„é¡¶ç«¯ã€‚

###### ç®—æ³•æ­¥éª¤

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/bubble_sort.gif)

###### ä»£ç å®ç°

```java
/**
 * å†’æ³¡æ’åº
 * @param arr
 * @return arr
 */
public static int[] bubbleSort(int[] arr) {
    for (int i = 1; i < arr.length; i++) {
        // Set a flag, if true, that means the loop has not been swapped,
        // that is, the sequence has been ordered, the sorting has been completed.
        boolean flag = true;
        for (int j = 0; j < arr.length - i; j++) {
            if (arr[j] > arr[j + 1]) {
                int tmp = arr[j];
                arr[j] = arr[j + 1];
                arr[j + 1] = tmp;
			    // Change flag
                flag = false;
            }
        }
        if (flag) {
            break;
        }
    }
    return arr;
}
```

**æ­¤å¤„å¯¹ä»£ç åšäº†ä¸€ä¸ªå°ä¼˜åŒ–ï¼ŒåŠ å…¥äº† `is_sorted` Flagï¼Œç›®çš„æ˜¯å°†ç®—æ³•çš„æœ€ä½³æ—¶é—´å¤æ‚åº¦ä¼˜åŒ–ä¸º `O(n)`ï¼Œå³å½“åŸè¾“å…¥åºåˆ—å°±æ˜¯æ’åºå¥½çš„æƒ…å†µä¸‹ï¼Œè¯¥ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯ `O(n)`ã€‚**

###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§**ï¼šç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼šO(n) ï¼Œæœ€å·®ï¼šO(n2)ï¼Œ å¹³å‡ï¼šO(n2)
- **ç©ºé—´å¤æ‚åº¦** ï¼šO(1)
- **æ’åºæ–¹å¼** ï¼šIn-place



##### é€‰æ‹©æ’åº (Selection Sort)

é€‰æ‹©æ’åºæ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ï¼Œæ— è®ºä»€ä¹ˆæ•°æ®è¿›å»éƒ½æ˜¯ `O(nÂ²)` çš„æ—¶é—´å¤æ‚åº¦ã€‚æ‰€ä»¥ç”¨åˆ°å®ƒçš„æ—¶å€™ï¼Œæ•°æ®è§„æ¨¡è¶Šå°è¶Šå¥½ã€‚å”¯ä¸€çš„å¥½å¤„å¯èƒ½å°±æ˜¯ä¸å ç”¨é¢å¤–çš„å†…å­˜ç©ºé—´äº†å§ã€‚å®ƒçš„å·¥ä½œåŸç†ï¼šé¦–å…ˆåœ¨æœªæ’åºåºåˆ—ä¸­æ‰¾åˆ°æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œå­˜æ”¾åˆ°æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®ï¼Œç„¶åï¼Œå†ä»å‰©ä½™æœªæ’åºå…ƒç´ ä¸­ç»§ç»­å¯»æ‰¾æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œç„¶åæ”¾åˆ°å·²æ’åºåºåˆ—çš„æœ«å°¾ã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ å‡æ’åºå®Œæ¯•ã€‚

###### ç®—æ³•æ­¥éª¤

1. é¦–å…ˆåœ¨æœªæ’åºåºåˆ—ä¸­æ‰¾åˆ°æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œå­˜æ”¾åˆ°æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®
2. å†ä»å‰©ä½™æœªæ’åºå…ƒç´ ä¸­ç»§ç»­å¯»æ‰¾æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œç„¶åæ”¾åˆ°å·²æ’åºåºåˆ—çš„æœ«å°¾ã€‚
3. é‡å¤ç¬¬ 2 æ­¥ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ å‡æ’åºå®Œæ¯•ã€‚

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/selection_sort.gif)

###### ä»£ç å®ç°

```java
/**
 * é€‰æ‹©æ’åº
 * @param arr
 * @return arr
 */
public static int[] selectionSort(int[] arr) {
    for (int i = 0; i < arr.length - 1; i++) {
        int minIndex = i;
        for (int j = i + 1; j < arr.length; j++) {
            if (arr[j] < arr[minIndex]) {
                minIndex = j;
            }
        }
        if (minIndex != i) {
            int tmp = arr[i];
            arr[i] = arr[minIndex];
            arr[minIndex] = tmp;
        }
    }
    return arr;
}
```

###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§**ï¼šä¸ç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼šO(n2) ï¼Œæœ€å·®ï¼šO(n2)ï¼Œ å¹³å‡ï¼šO(n2)
- **ç©ºé—´å¤æ‚åº¦** ï¼šO(1)
- **æ’åºæ–¹å¼** ï¼šIn-place



##### æ’å…¥æ’åº (Insertion Sort)

æ’å…¥æ’åºæ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯é€šè¿‡æ„å»ºæœ‰åºåºåˆ—ï¼Œå¯¹äºæœªæ’åºæ•°æ®ï¼Œåœ¨å·²æ’åºåºåˆ—ä¸­ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç›¸åº”ä½ç½®å¹¶æ’å…¥ã€‚æ’å…¥æ’åºåœ¨å®ç°ä¸Šï¼Œé€šå¸¸é‡‡ç”¨ in-place æ’åºï¼ˆå³åªéœ€ç”¨åˆ° `O(1)` çš„é¢å¤–ç©ºé—´çš„æ’åºï¼‰ï¼Œå› è€Œåœ¨ä»åå‘å‰æ‰«æè¿‡ç¨‹ä¸­ï¼Œéœ€è¦åå¤æŠŠå·²æ’åºå…ƒç´ é€æ­¥å‘åæŒªä½ï¼Œä¸ºæœ€æ–°å…ƒç´ æä¾›æ’å…¥ç©ºé—´ã€‚

æ’å…¥æ’åºçš„ä»£ç å®ç°è™½ç„¶æ²¡æœ‰å†’æ³¡æ’åºå’Œé€‰æ‹©æ’åºé‚£ä¹ˆç®€å•ç²—æš´ï¼Œä½†å®ƒçš„åŸç†åº”è¯¥æ˜¯æœ€å®¹æ˜“ç†è§£çš„äº†ï¼Œå› ä¸ºåªè¦æ‰“è¿‡æ‰‘å…‹ç‰Œçš„äººéƒ½åº”è¯¥èƒ½å¤Ÿç§’æ‡‚ã€‚æ’å…¥æ’åºæ˜¯ä¸€ç§æœ€ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ï¼Œå®ƒçš„å·¥ä½œåŸç†æ˜¯é€šè¿‡æ„å»ºæœ‰åºåºåˆ—ï¼Œå¯¹äºæœªæ’åºæ•°æ®ï¼Œåœ¨å·²æ’åºåºåˆ—ä¸­ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç›¸åº”ä½ç½®å¹¶æ’å…¥ã€‚

æ’å…¥æ’åºå’Œå†’æ³¡æ’åºä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸€ç§ä¼˜åŒ–ç®—æ³•ï¼Œå«åšæ‹†åŠæ’å…¥ã€‚

###### ç®—æ³•æ­¥éª¤

1. ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œè¯¥å…ƒç´ å¯ä»¥è®¤ä¸ºå·²ç»è¢«æ’åºï¼›
2. å–å‡ºä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨å·²ç»æ’åºçš„å…ƒç´ åºåˆ—ä¸­ä»åå‘å‰æ‰«æï¼›
3. å¦‚æœè¯¥å…ƒç´ ï¼ˆå·²æ’åºï¼‰å¤§äºæ–°å…ƒç´ ï¼Œå°†è¯¥å…ƒç´ ç§»åˆ°ä¸‹ä¸€ä½ç½®ï¼›
4. é‡å¤æ­¥éª¤ 3ï¼Œç›´åˆ°æ‰¾åˆ°å·²æ’åºçš„å…ƒç´ å°äºæˆ–è€…ç­‰äºæ–°å…ƒç´ çš„ä½ç½®ï¼›
5. å°†æ–°å…ƒç´ æ’å…¥åˆ°è¯¥ä½ç½®åï¼›
6. é‡å¤æ­¥éª¤ 2~5ã€‚

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/insertion_sort.gif)

###### ä»£ç å®ç°

```java
/**
 * æ’å…¥æ’åº
 * @param arr
 * @return arr
 */
public static int[] insertionSort(int[] arr) {
    for (int i = 1; i < arr.length; i++) {
        int preIndex = i - 1;
        int current = arr[i];
        while (preIndex >= 0 && current < arr[preIndex]) {
            arr[preIndex + 1] = arr[preIndex];
            preIndex -= 1;
        }
        arr[preIndex + 1] = current;
    }
    return arr;
}
```



###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§**ï¼šç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼šO(n) ï¼Œæœ€å·®ï¼šO(n2)ï¼Œ å¹³å‡ï¼šO(n2)
- **ç©ºé—´å¤æ‚åº¦** ï¼šO(1)
- **æ’åºæ–¹å¼** ï¼šIn-place



##### å¸Œå°”æ’åº (Shell Sort)

å¸Œå°”æ’åºæ˜¯å¸Œå°” (Donald Shell) äº 1959 å¹´æå‡ºçš„ä¸€ç§æ’åºç®—æ³•ã€‚å¸Œå°”æ’åºä¹Ÿæ˜¯ä¸€ç§æ’å…¥æ’åºï¼Œå®ƒæ˜¯ç®€å•æ’å…¥æ’åºç»è¿‡æ”¹è¿›ä¹‹åçš„ä¸€ä¸ªæ›´é«˜æ•ˆçš„ç‰ˆæœ¬ï¼Œä¹Ÿç§°ä¸ºé€’å‡å¢é‡æ’åºç®—æ³•ï¼ŒåŒæ—¶è¯¥ç®—æ³•æ˜¯å†²ç ´ `O(nÂ²)` çš„ç¬¬ä¸€æ‰¹ç®—æ³•ä¹‹ä¸€ã€‚

å¸Œå°”æ’åºçš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šå…ˆå°†æ•´ä¸ªå¾…æ’åºçš„è®°å½•åºåˆ—åˆ†å‰²æˆä¸ºè‹¥å¹²å­åºåˆ—åˆ†åˆ«è¿›è¡Œç›´æ¥æ’å…¥æ’åºï¼Œå¾…æ•´ä¸ªåºåˆ—ä¸­çš„è®°å½• â€œåŸºæœ¬æœ‰åºâ€ æ—¶ï¼Œå†å¯¹å…¨ä½“è®°å½•è¿›è¡Œä¾æ¬¡ç›´æ¥æ’å…¥æ’åºã€‚

###### ç®—æ³•æ­¥éª¤

æˆ‘ä»¬æ¥çœ‹ä¸‹å¸Œå°”æ’åºçš„åŸºæœ¬æ­¥éª¤ï¼Œåœ¨æ­¤æˆ‘ä»¬é€‰æ‹©å¢é‡ `gap=length/2`ï¼Œç¼©å°å¢é‡ç»§ç»­ä»¥ `gap = gap/2` çš„æ–¹å¼ï¼Œè¿™ç§å¢é‡é€‰æ‹©æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªåºåˆ—æ¥è¡¨ç¤ºï¼Œ`{n/2, (n/2)/2, ..., 1}`ï¼Œç§°ä¸º**å¢é‡åºåˆ—**ã€‚å¸Œå°”æ’åºçš„å¢é‡åºåˆ—çš„é€‰æ‹©ä¸è¯æ˜æ˜¯ä¸ªæ•°å­¦éš¾é¢˜ï¼Œæˆ‘ä»¬é€‰æ‹©çš„è¿™ä¸ªå¢é‡åºåˆ—æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ï¼Œä¹Ÿæ˜¯å¸Œå°”å»ºè®®çš„å¢é‡ï¼Œç§°ä¸ºå¸Œå°”å¢é‡ï¼Œä½†å…¶å®è¿™ä¸ªå¢é‡åºåˆ—ä¸æ˜¯æœ€ä¼˜çš„ã€‚æ­¤å¤„æˆ‘ä»¬åšç¤ºä¾‹ä½¿ç”¨å¸Œå°”å¢é‡ã€‚

å…ˆå°†æ•´ä¸ªå¾…æ’åºçš„è®°å½•åºåˆ—åˆ†å‰²æˆä¸ºè‹¥å¹²å­åºåˆ—åˆ†åˆ«è¿›è¡Œç›´æ¥æ’å…¥æ’åºï¼Œå…·ä½“ç®—æ³•æè¿°ï¼š

- é€‰æ‹©ä¸€ä¸ªå¢é‡åºåˆ— `{t1, t2, â€¦, tk}`ï¼Œå…¶ä¸­ `(ti>tj, i<j, tk=1)`ï¼›
- æŒ‰å¢é‡åºåˆ—ä¸ªæ•° kï¼Œå¯¹åºåˆ—è¿›è¡Œ k è¶Ÿæ’åºï¼›
- æ¯è¶Ÿæ’åºï¼Œæ ¹æ®å¯¹åº”çš„å¢é‡ `t`ï¼Œå°†å¾…æ’åºåˆ—åˆ†å‰²æˆè‹¥å¹²é•¿åº¦ä¸º `m` çš„å­åºåˆ—ï¼Œåˆ†åˆ«å¯¹å„å­è¡¨è¿›è¡Œç›´æ¥æ’å…¥æ’åºã€‚ä»…å¢é‡å› å­ä¸º 1 æ—¶ï¼Œæ•´ä¸ªåºåˆ—ä½œä¸ºä¸€ä¸ªè¡¨æ¥å¤„ç†ï¼Œè¡¨é•¿åº¦å³ä¸ºæ•´ä¸ªåºåˆ—çš„é•¿åº¦ã€‚

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/shell_sort.png)

###### ä»£ç å®ç°

```java
/**
 * å¸Œå°”æ’åº
 *
 * @param arr
 * @return arr
 */
public static int[] shellSort(int[] arr) {
    int n = arr.length;
    int gap = n / 2;
    while (gap > 0) {
        for (int i = gap; i < n; i++) {
            int current = arr[i];
            int preIndex = i - gap;
            // Insertion sort
            while (preIndex >= 0 && arr[preIndex] > current) {
                arr[preIndex + gap] = arr[preIndex];
                preIndex -= gap;
            }
            arr[preIndex + gap] = current;

        }
        gap /= 2;
    }
    return arr;
}
```

###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§**ï¼šç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼šO(nlogn)ï¼Œ æœ€å·®ï¼šO(n2) å¹³å‡ï¼šO(nlogn)
- **ç©ºé—´å¤æ‚åº¦** ï¼š`O(n)`



##### å½’å¹¶æ’åº (Merge Sort)

å½’å¹¶æ’åºæ˜¯å»ºç«‹åœ¨å½’å¹¶æ“ä½œä¸Šçš„ä¸€ç§æœ‰æ•ˆçš„æ’åºç®—æ³•ã€‚è¯¥ç®—æ³•æ˜¯é‡‡ç”¨åˆ†æ²»æ³• (Divide and Conquer) çš„ä¸€ä¸ªéå¸¸å…¸å‹çš„åº”ç”¨ã€‚å½’å¹¶æ’åºæ˜¯ä¸€ç§ç¨³å®šçš„æ’åºæ–¹æ³•ã€‚å°†å·²æœ‰åºçš„å­åºåˆ—åˆå¹¶ï¼Œå¾—åˆ°å®Œå…¨æœ‰åºçš„åºåˆ—ï¼›å³å…ˆä½¿æ¯ä¸ªå­åºåˆ—æœ‰åºï¼Œå†ä½¿å­åºåˆ—æ®µé—´æœ‰åºã€‚è‹¥å°†ä¸¤ä¸ªæœ‰åºè¡¨åˆå¹¶æˆä¸€ä¸ªæœ‰åºè¡¨ï¼Œç§°ä¸º 2 - è·¯å½’å¹¶ã€‚

å’Œé€‰æ‹©æ’åºä¸€æ ·ï¼Œå½’å¹¶æ’åºçš„æ€§èƒ½ä¸å—è¾“å…¥æ•°æ®çš„å½±å“ï¼Œä½†è¡¨ç°æ¯”é€‰æ‹©æ’åºå¥½çš„å¤šï¼Œå› ä¸ºå§‹ç»ˆéƒ½æ˜¯ `O(nlogn)` çš„æ—¶é—´å¤æ‚åº¦ã€‚ä»£ä»·æ˜¯éœ€è¦é¢å¤–çš„å†…å­˜ç©ºé—´ã€‚

###### ç®—æ³•æ­¥éª¤

å½’å¹¶æ’åºç®—æ³•æ˜¯ä¸€ä¸ªé€’å½’è¿‡ç¨‹ï¼Œè¾¹ç•Œæ¡ä»¶ä¸ºå½“è¾“å…¥åºåˆ—ä»…æœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œç›´æ¥è¿”å›ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. å¦‚æœè¾“å…¥å†…åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°†é•¿åº¦ä¸º `n` çš„è¾“å…¥åºåˆ—åˆ†æˆä¸¤ä¸ªé•¿åº¦ä¸º `n/2` çš„å­åºåˆ—ï¼›
2. åˆ†åˆ«å¯¹è¿™ä¸¤ä¸ªå­åºåˆ—è¿›è¡Œå½’å¹¶æ’åºï¼Œä½¿å­åºåˆ—å˜ä¸ºæœ‰åºçŠ¶æ€ï¼›
3. è®¾å®šä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘ä¸¤ä¸ªå·²ç»æ’åºå­åºåˆ—çš„èµ·å§‹ä½ç½®ï¼›
4. æ¯”è¾ƒä¸¤ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ ï¼Œé€‰æ‹©ç›¸å¯¹å°çš„å…ƒç´ æ”¾å…¥åˆ°åˆå¹¶ç©ºé—´ï¼ˆç”¨äºå­˜æ”¾æ’åºç»“æœï¼‰ï¼Œå¹¶ç§»åŠ¨æŒ‡é’ˆåˆ°ä¸‹ä¸€ä½ç½®ï¼›
5. é‡å¤æ­¥éª¤ 3 ~4 ç›´åˆ°æŸä¸€æŒ‡é’ˆè¾¾åˆ°åºåˆ—å°¾ï¼›
6. å°†å¦ä¸€åºåˆ—å‰©ä¸‹çš„æ‰€æœ‰å…ƒç´ ç›´æ¥å¤åˆ¶åˆ°åˆå¹¶åºåˆ—å°¾ã€‚

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/merge_sort.gif)

###### ä»£ç å®ç°

```java
/**
 * å½’å¹¶æ’åº
 *
 * @param arr
 * @return arr
 */
public static int[] mergeSort(int[] arr) {
    if (arr.length <= 1) {
        return arr;
    }
    int middle = arr.length / 2;
    int[] arr_1 = Arrays.copyOfRange(arr, 0, middle);
    int[] arr_2 = Arrays.copyOfRange(arr, middle, arr.length);
    return merge(mergeSort(arr_1), mergeSort(arr_2));
}

/**
 * Merge two sorted arrays
 *
 * @param arr_1
 * @param arr_2
 * @return sorted_arr
 */
public static int[] merge(int[] arr_1, int[] arr_2) {
    int[] sorted_arr = new int[arr_1.length + arr_2.length];
    int idx = 0, idx_1 = 0, idx_2 = 0;
    while (idx_1 < arr_1.length && idx_2 < arr_2.length) {
        if (arr_1[idx_1] < arr_2[idx_2]) {
            sorted_arr[idx] = arr_1[idx_1];
            idx_1 += 1;
        } else {
            sorted_arr[idx] = arr_2[idx_2];
            idx_2 += 1;
        }
        idx += 1;
    }
    if (idx_1 < arr_1.length) {
        while (idx_1 < arr_1.length) {
            sorted_arr[idx] = arr_1[idx_1];
            idx_1 += 1;
            idx += 1;
        }
    } else {
        while (idx_2 < arr_2.length) {
            sorted_arr[idx] = arr_2[idx_2];
            idx_2 += 1;
            idx += 1;
        }
    }
    return sorted_arr;
}
```

###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§**ï¼šç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼šO(nlogn)ï¼Œ æœ€å·®ï¼šO(nlogn)ï¼Œ å¹³å‡ï¼šO(nlogn)
- **ç©ºé—´å¤æ‚åº¦** ï¼šO(n)



##### å¿«é€Ÿæ’åº (Quick Sort)

å¿«é€Ÿæ’åºç”¨åˆ°äº†åˆ†æ²»æ€æƒ³ï¼ŒåŒæ ·çš„è¿˜æœ‰å½’å¹¶æ’åºã€‚ä¹çœ‹èµ·æ¥å¿«é€Ÿæ’åºå’Œå½’å¹¶æ’åºéå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯å°†é—®é¢˜å˜å°ï¼Œå…ˆæ’åºå­ä¸²ï¼Œæœ€ååˆå¹¶ã€‚ä¸åŒçš„æ˜¯å¿«é€Ÿæ’åºåœ¨åˆ’åˆ†å­é—®é¢˜çš„æ—¶å€™ç»è¿‡å¤šä¸€æ­¥å¤„ç†ï¼Œå°†åˆ’åˆ†çš„ä¸¤ç»„æ•°æ®åˆ’åˆ†ä¸ºä¸€å¤§ä¸€å°ï¼Œè¿™æ ·åœ¨æœ€ååˆå¹¶çš„æ—¶å€™å°±ä¸å¿…åƒå½’å¹¶æ’åºé‚£æ ·å†è¿›è¡Œæ¯”è¾ƒã€‚ä½†ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œåˆ’åˆ†çš„ä¸å®šæ€§ä½¿å¾—å¿«é€Ÿæ’åºçš„æ—¶é—´å¤æ‚åº¦å¹¶ä¸ç¨³å®šã€‚

å¿«é€Ÿæ’åºçš„åŸºæœ¬æ€æƒ³ï¼šé€šè¿‡ä¸€è¶Ÿæ’åºå°†å¾…æ’åºåˆ—åˆ†éš”æˆç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†è®°å½•çš„å…ƒç´ å‡æ¯”å¦ä¸€éƒ¨åˆ†çš„å…ƒç´ å°ï¼Œåˆ™å¯åˆ†åˆ«å¯¹è¿™ä¸¤éƒ¨åˆ†å­åºåˆ—ç»§ç»­è¿›è¡Œæ’åºï¼Œä»¥è¾¾åˆ°æ•´ä¸ªåºåˆ—æœ‰åºã€‚

###### ç®—æ³•æ­¥éª¤

å¿«é€Ÿæ’åºä½¿ç”¨[åˆ†æ²»æ³•](https://zh.wikipedia.org/wiki/åˆ†æ²»æ³•)ï¼ˆDivide and conquerï¼‰ç­–ç•¥æ¥æŠŠä¸€ä¸ªåºåˆ—åˆ†ä¸ºè¾ƒå°å’Œè¾ƒå¤§çš„ 2 ä¸ªå­åºåˆ—ï¼Œç„¶åé€’å›åœ°æ’åºä¸¤ä¸ªå­åºåˆ—ã€‚å…·ä½“ç®—æ³•æè¿°å¦‚ä¸‹ï¼š

1. ä»åºåˆ—ä¸­**éšæœº**æŒ‘å‡ºä¸€ä¸ªå…ƒç´ ï¼Œåšä¸º â€œåŸºå‡†â€(`pivot`)ï¼›
2. é‡æ–°æ’åˆ—åºåˆ—ï¼Œå°†æ‰€æœ‰æ¯”åŸºå‡†å€¼å°çš„å…ƒç´ æ‘†æ”¾åœ¨åŸºå‡†å‰é¢ï¼Œæ‰€æœ‰æ¯”åŸºå‡†å€¼å¤§çš„æ‘†åœ¨åŸºå‡†çš„åé¢ï¼ˆç›¸åŒçš„æ•°å¯ä»¥åˆ°ä»»ä¸€è¾¹ï¼‰ã€‚åœ¨è¿™ä¸ªæ“ä½œç»“æŸä¹‹åï¼Œè¯¥åŸºå‡†å°±å¤„äºæ•°åˆ—çš„ä¸­é—´ä½ç½®ã€‚è¿™ä¸ªç§°ä¸ºåˆ†åŒºï¼ˆpartitionï¼‰æ“ä½œï¼›
3. é€’å½’åœ°æŠŠå°äºåŸºå‡†å€¼å…ƒç´ çš„å­åºåˆ—å’Œå¤§äºåŸºå‡†å€¼å…ƒç´ çš„å­åºåˆ—è¿›è¡Œå¿«é€Ÿæ’åºã€‚

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/random_quick_sort.gif)



###### ä»£ç å®ç°

```java
public static int partition(int[] array, int low, int high) {
    int pivot = array[high];
    int pointer = low;
    for (int i = low; i < high; i++) {
        if (array[i] <= pivot) {
            int temp = array[i];
            array[i] = array[pointer];
            array[pointer] = temp;
            pointer++;
        }
        System.out.println(Arrays.toString(array));
    }
    int temp = array[pointer];
    array[pointer] = array[high];
    array[high] = temp;
    return pointer;
}
public static void quickSort(int[] array, int low, int high) {
    if (low < high) {
        int position = partition(array, low, high);
        quickSort(array, low, position - 1);
        quickSort(array, position + 1, high);
    }
}
```



###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§** ï¼šä¸ç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼šO(nlogn)ï¼Œ æœ€å·®ï¼šO(nlogn)ï¼Œå¹³å‡ï¼šO(nlogn)
- **ç©ºé—´å¤æ‚åº¦** ï¼šO(nlogn)



##### å †æ’åº (Heap Sort)

å †æ’åºæ˜¯æŒ‡åˆ©ç”¨å †è¿™ç§æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ä¸€ç§æ’åºç®—æ³•ã€‚å †æ˜¯ä¸€ä¸ªè¿‘ä¼¼å®Œå…¨äºŒå‰æ ‘çš„ç»“æ„ï¼Œå¹¶åŒæ—¶æ»¡è¶³**å †çš„æ€§è´¨**ï¼šå³**å­ç»“ç‚¹çš„å€¼æ€»æ˜¯å°äºï¼ˆæˆ–è€…å¤§äºï¼‰å®ƒçš„çˆ¶èŠ‚ç‚¹**ã€‚

###### ç®—æ³•æ­¥éª¤

1. å°†åˆå§‹å¾…æ’åºåˆ— `(R1, R2, â€¦â€¦, Rn)` æ„å»ºæˆå¤§é¡¶å †ï¼Œæ­¤å †ä¸ºåˆå§‹çš„æ— åºåŒºï¼›
2. å°†å †é¡¶å…ƒç´  `R[1]` ä¸æœ€åä¸€ä¸ªå…ƒç´  `R[n]` äº¤æ¢ï¼Œæ­¤æ—¶å¾—åˆ°æ–°çš„æ— åºåŒº `(R1, R2, â€¦â€¦, Rn-1)` å’Œæ–°çš„æœ‰åºåŒº (Rn), ä¸”æ»¡è¶³ `R[1, 2, â€¦â€¦, n-1]<=R[n]`ï¼›
3. ç”±äºäº¤æ¢åæ–°çš„å †é¡¶ `R[1]` å¯èƒ½è¿åå †çš„æ€§è´¨ï¼Œå› æ­¤éœ€è¦å¯¹å½“å‰æ— åºåŒº `(R1, R2, â€¦â€¦, Rn-1)` è°ƒæ•´ä¸ºæ–°å †ï¼Œç„¶åå†æ¬¡å°† R [1] ä¸æ— åºåŒºæœ€åä¸€ä¸ªå…ƒç´ äº¤æ¢ï¼Œå¾—åˆ°æ–°çš„æ— åºåŒº `(R1, R2, â€¦â€¦, Rn-2)` å’Œæ–°çš„æœ‰åºåŒº `(Rn-1, Rn)`ã€‚ä¸æ–­é‡å¤æ­¤è¿‡ç¨‹ç›´åˆ°æœ‰åºåŒºçš„å…ƒç´ ä¸ªæ•°ä¸º `n-1`ï¼Œåˆ™æ•´ä¸ªæ’åºè¿‡ç¨‹å®Œæˆ

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/heap_sort.gif)

###### ä»£ç å®ç°

```java
// Global variable that records the length of an array;
static int heapLen;

/**
 * Swap the two elements of an array
 * @param arr
 * @param i
 * @param j
 */
private static void swap(int[] arr, int i, int j) {
    int tmp = arr[i];
    arr[i] = arr[j];
    arr[j] = tmp;
}

/**
 * Build Max Heap
 * @param arr
 */
private static void buildMaxHeap(int[] arr) {
    for (int i = arr.length / 2 - 1; i >= 0; i--) {
        heapify(arr, i);
    }
}

/**
 * Adjust it to the maximum heap
 * @param arr
 * @param i
 */
private static void heapify(int[] arr, int i) {
    int left = 2 * i + 1;
    int right = 2 * i + 2;
    int largest = i;
    if (right < heapLen && arr[right] > arr[largest]) {
        largest = right;
    }
    if (left < heapLen && arr[left] > arr[largest]) {
        largest = left;
    }
    if (largest != i) {
        swap(arr, largest, i);
        heapify(arr, largest);
    }
}

/**
 * Heap Sort
 * @param arr
 * @return
 */
public static int[] heapSort(int[] arr) {
    // index at the end of the heap
    heapLen = arr.length;
    // build MaxHeap
    buildMaxHeap(arr);
    for (int i = arr.length - 1; i > 0; i--) {
        // Move the top of the heap to the tail of the heap in turn
        swap(arr, 0, i);
        heapLen -= 1;
        heapify(arr, 0);
    }
    return arr;
}
```

###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§** ï¼šä¸ç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼šO(nlogn)ï¼Œ æœ€å·®ï¼šO(nlogn)ï¼Œ å¹³å‡ï¼šO(nlogn)
- **ç©ºé—´å¤æ‚åº¦** ï¼šO(1)



##### è®¡æ•°æ’åº (Counting Sort)

è®¡æ•°æ’åºçš„æ ¸å¿ƒåœ¨äºå°†è¾“å…¥çš„æ•°æ®å€¼è½¬åŒ–ä¸ºé”®å­˜å‚¨åœ¨é¢å¤–å¼€è¾Ÿçš„æ•°ç»„ç©ºé—´ä¸­ã€‚ ä½œä¸ºä¸€ç§çº¿æ€§æ—¶é—´å¤æ‚åº¦çš„æ’åºï¼Œ**è®¡æ•°æ’åºè¦æ±‚è¾“å…¥çš„æ•°æ®å¿…é¡»æ˜¯æœ‰ç¡®å®šèŒƒå›´çš„æ•´æ•°**ã€‚

è®¡æ•°æ’åº (Counting sort) æ˜¯ä¸€ç§ç¨³å®šçš„æ’åºç®—æ³•ã€‚è®¡æ•°æ’åºä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„æ•°ç»„ `C`ï¼Œå…¶ä¸­ç¬¬ `i` ä¸ªå…ƒç´ æ˜¯å¾…æ’åºæ•°ç»„ `A` ä¸­å€¼ç­‰äº `i` çš„å…ƒç´ çš„ä¸ªæ•°ã€‚ç„¶åæ ¹æ®æ•°ç»„ `C` æ¥å°† `A` ä¸­çš„å…ƒç´ æ’åˆ°æ­£ç¡®çš„ä½ç½®ã€‚**å®ƒåªèƒ½å¯¹æ•´æ•°è¿›è¡Œæ’åº**ã€‚

###### ç®—æ³•æ­¥éª¤

1. æ‰¾å‡ºæ•°ç»„ä¸­çš„æœ€å¤§å€¼ `max`ã€æœ€å°å€¼ `min`ï¼›
2. åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ `C`ï¼Œå…¶é•¿åº¦æ˜¯ `max-min+1`ï¼Œå…¶å…ƒç´ é»˜è®¤å€¼éƒ½ä¸º 0ï¼›
3. éå†åŸæ•°ç»„ `A` ä¸­çš„å…ƒç´  `A[i]`ï¼Œä»¥ `A[i]-min` ä½œä¸º `C` æ•°ç»„çš„ç´¢å¼•ï¼Œä»¥ `A[i]` çš„å€¼åœ¨ `A` ä¸­å…ƒç´ å‡ºç°æ¬¡æ•°ä½œä¸º `C[A[i]-min]` çš„å€¼ï¼›
4. å¯¹ `C` æ•°ç»„å˜å½¢ï¼Œ**æ–°å…ƒç´ çš„å€¼æ˜¯è¯¥å…ƒç´ ä¸å‰ä¸€ä¸ªå…ƒç´ å€¼çš„å’Œ**ï¼Œå³å½“ `i>1` æ—¶ `C[i] = C[i] + C[i-1]`ï¼›
5. åˆ›å»ºç»“æœæ•°ç»„ `R`ï¼Œé•¿åº¦å’ŒåŸå§‹æ•°ç»„ä¸€æ ·ã€‚
6. **ä»åå‘å‰**éå†åŸå§‹æ•°ç»„ `A` ä¸­çš„å…ƒç´  `A[i]`ï¼Œä½¿ç”¨ `A[i]` å‡å»æœ€å°å€¼ `min` ä½œä¸ºç´¢å¼•ï¼Œåœ¨è®¡æ•°æ•°ç»„ `C` ä¸­æ‰¾åˆ°å¯¹åº”çš„å€¼ `C[A[i]-min]`ï¼Œ`C[A[i]-min]-1` å°±æ˜¯ `A[i]` åœ¨ç»“æœæ•°ç»„ `R` ä¸­çš„ä½ç½®ï¼Œåšå®Œä¸Šè¿°è¿™äº›æ“ä½œï¼Œå°† `count[A[i]-min]` å‡å° 1ã€‚

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/counting_sort.gif)

###### ä»£ç å®ç°

```java
/**
 * Gets the maximum and minimum values in the array
 *
 * @param arr
 * @return
 */
private static int[] getMinAndMax(int[] arr) {
    int maxValue = arr[0];
    int minValue = arr[0];
    for (int i = 0; i < arr.length; i++) {
        if (arr[i] > maxValue) {
            maxValue = arr[i];
        } else if (arr[i] < minValue) {
            minValue = arr[i];
        }
    }
    return new int[] { minValue, maxValue };
}

/**
 * Counting Sort
 *
 * @param arr
 * @return
 */
public static int[] countingSort(int[] arr) {
    if (arr.length < 2) {
        return arr;
    }
    int[] extremum = getMinAndMax(arr);
    int minValue = extremum[0];
    int maxValue = extremum[1];
    int[] countArr = new int[maxValue - minValue + 1];
    int[] result = new int[arr.length];

    for (int i = 0; i < arr.length; i++) {
        countArr[arr[i] - minValue] += 1;
    }
    for (int i = 1; i < countArr.length; i++) {
        countArr[i] += countArr[i - 1];
    }
    for (int i = arr.length - 1; i >= 0; i--) {
        int idx = countArr[arr[i] - minValue] - 1;
        result[idx] = arr[i];
        countArr[arr[i] - minValue] -= 1;
    }
    return result;
}
```

###### ç®—æ³•åˆ†æ

å½“è¾“å…¥çš„å…ƒç´ æ˜¯ `n` ä¸ª `0` åˆ° `k` ä¹‹é—´çš„æ•´æ•°æ—¶ï¼Œå®ƒçš„è¿è¡Œæ—¶é—´æ˜¯ `O(n+k)`ã€‚è®¡æ•°æ’åºä¸æ˜¯æ¯”è¾ƒæ’åºï¼Œæ’åºçš„é€Ÿåº¦å¿«äºä»»ä½•æ¯”è¾ƒæ’åºç®—æ³•ã€‚ç”±äºç”¨æ¥è®¡æ•°çš„æ•°ç»„ `C` çš„é•¿åº¦å–å†³äºå¾…æ’åºæ•°ç»„ä¸­æ•°æ®çš„èŒƒå›´ï¼ˆç­‰äºå¾…æ’åºæ•°ç»„çš„**æœ€å¤§å€¼ä¸æœ€å°å€¼çš„å·®åŠ ä¸Š 1**ï¼‰ï¼Œè¿™ä½¿å¾—è®¡æ•°æ’åºå¯¹äºæ•°æ®èŒƒå›´å¾ˆå¤§çš„æ•°ç»„ï¼Œéœ€è¦å¤§é‡é¢å¤–å†…å­˜ç©ºé—´ã€‚

- **ç¨³å®šæ€§** ï¼šç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼š`O(n+k)` æœ€å·®ï¼š`O(n+k)` å¹³å‡ï¼š`O(n+k)`
- **ç©ºé—´å¤æ‚åº¦** ï¼š`O(k)`



##### æ¡¶æ’åº (Bucket Sort)

æ¡¶æ’åºæ˜¯è®¡æ•°æ’åºçš„å‡çº§ç‰ˆã€‚å®ƒåˆ©ç”¨äº†å‡½æ•°çš„æ˜ å°„å…³ç³»ï¼Œé«˜æ•ˆä¸å¦çš„å…³é”®å°±åœ¨äºè¿™ä¸ªæ˜ å°„å‡½æ•°çš„ç¡®å®šã€‚ä¸ºäº†ä½¿æ¡¶æ’åºæ›´åŠ é«˜æ•ˆï¼Œæˆ‘ä»¬éœ€è¦åšåˆ°è¿™ä¸¤ç‚¹ï¼š

1. åœ¨é¢å¤–ç©ºé—´å……è¶³çš„æƒ…å†µä¸‹ï¼Œå°½é‡å¢å¤§æ¡¶çš„æ•°é‡
2. ä½¿ç”¨çš„æ˜ å°„å‡½æ•°èƒ½å¤Ÿå°†è¾“å…¥çš„ N ä¸ªæ•°æ®å‡åŒ€çš„åˆ†é…åˆ° K ä¸ªæ¡¶ä¸­

æ¡¶æ’åºçš„å·¥ä½œçš„åŸç†ï¼šå‡è®¾è¾“å…¥æ•°æ®æœä»å‡åŒ€åˆ†å¸ƒï¼Œå°†æ•°æ®åˆ†åˆ°æœ‰é™æ•°é‡çš„æ¡¶é‡Œï¼Œæ¯ä¸ªæ¡¶å†åˆ†åˆ«æ’åºï¼ˆæœ‰å¯èƒ½å†ä½¿ç”¨åˆ«çš„æ’åºç®—æ³•æˆ–æ˜¯ä»¥é€’å½’æ–¹å¼ç»§ç»­ä½¿ç”¨æ¡¶æ’åºè¿›è¡Œã€‚

###### ç®—æ³•æ­¥éª¤

1. è®¾ç½®ä¸€ä¸ª BucketSizeï¼Œä½œä¸ºæ¯ä¸ªæ¡¶æ‰€èƒ½æ”¾ç½®å¤šå°‘ä¸ªä¸åŒæ•°å€¼ï¼›
2. éå†è¾“å…¥æ•°æ®ï¼Œå¹¶ä¸”æŠŠæ•°æ®ä¾æ¬¡æ˜ å°„åˆ°å¯¹åº”çš„æ¡¶é‡Œå»ï¼›
3. å¯¹æ¯ä¸ªéç©ºçš„æ¡¶è¿›è¡Œæ’åºï¼Œå¯ä»¥ä½¿ç”¨å…¶å®ƒæ’åºæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥é€’å½’ä½¿ç”¨æ¡¶æ’åºï¼›
4. ä»éç©ºæ¡¶é‡ŒæŠŠæ’å¥½åºçš„æ•°æ®æ‹¼æ¥èµ·æ¥ã€‚

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/bucket_sort.gif)

###### ä»£ç å®ç°

```java
/**
 * Gets the maximum and minimum values in the array
 * @param arr
 * @return
 */
private static int[] getMinAndMax(List<Integer> arr) {
    int maxValue = arr.get(0);
    int minValue = arr.get(0);
    for (int i : arr) {
        if (i > maxValue) {
            maxValue = i;
        } else if (i < minValue) {
            minValue = i;
        }
    }
    return new int[] { minValue, maxValue };
}

/**
 * Bucket Sort
 * @param arr
 * @return
 */
public static List<Integer> bucketSort(List<Integer> arr, int bucket_size) {
    if (arr.size() < 2 || bucket_size == 0) {
        return arr;
    }
    int[] extremum = getMinAndMax(arr);
    int minValue = extremum[0];
    int maxValue = extremum[1];
    int bucket_cnt = (maxValue - minValue) / bucket_size + 1;
    List<List<Integer>> buckets = new ArrayList<>();
    for (int i = 0; i < bucket_cnt; i++) {
        buckets.add(new ArrayList<Integer>());
    }
    for (int element : arr) {
        int idx = (element - minValue) / bucket_size;
        buckets.get(idx).add(element);
    }
    for (int i = 0; i < buckets.size(); i++) {
        if (buckets.get(i).size() > 1) {
            buckets.set(i, sort(buckets.get(i), bucket_size / 2));
        }
    }
    ArrayList<Integer> result = new ArrayList<>();
    for (List<Integer> bucket : buckets) {
        for (int element : bucket) {
            result.add(element);
        }
    }
    return result;
}
```

###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§** ï¼šç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼š`O(n+k)` æœ€å·®ï¼š`O(nÂ²)` å¹³å‡ï¼š`O(n+k)`
- **ç©ºé—´å¤æ‚åº¦** ï¼š`O(k)`



##### åŸºæ•°æ’åº (Radix Sort)

åŸºæ•°æ’åºä¹Ÿæ˜¯éæ¯”è¾ƒçš„æ’åºç®—æ³•ï¼Œå¯¹å…ƒç´ ä¸­çš„æ¯ä¸€ä½æ•°å­—è¿›è¡Œæ’åºï¼Œä»æœ€ä½ä½å¼€å§‹æ’åºï¼Œå¤æ‚åº¦ä¸º `O(nÃ—k)`ï¼Œ`n` ä¸ºæ•°ç»„é•¿åº¦ï¼Œ`k` ä¸ºæ•°ç»„ä¸­å…ƒç´ çš„æœ€å¤§çš„ä½æ•°ï¼›

åŸºæ•°æ’åºæ˜¯æŒ‰ç…§ä½ä½å…ˆæ’åºï¼Œç„¶åæ”¶é›†ï¼›å†æŒ‰ç…§é«˜ä½æ’åºï¼Œç„¶åå†æ”¶é›†ï¼›ä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°æœ€é«˜ä½ã€‚æœ‰æ—¶å€™æœ‰äº›å±æ€§æ˜¯æœ‰ä¼˜å…ˆçº§é¡ºåºçš„ï¼Œå…ˆæŒ‰ä½ä¼˜å…ˆçº§æ’åºï¼Œå†æŒ‰é«˜ä¼˜å…ˆçº§æ’åºã€‚æœ€åçš„æ¬¡åºå°±æ˜¯é«˜ä¼˜å…ˆçº§é«˜çš„åœ¨å‰ï¼Œé«˜ä¼˜å…ˆçº§ç›¸åŒçš„ä½ä¼˜å…ˆçº§é«˜çš„åœ¨å‰ã€‚åŸºæ•°æ’åºåŸºäºåˆ†åˆ«æ’åºï¼Œåˆ†åˆ«æ”¶é›†ï¼Œæ‰€ä»¥æ˜¯ç¨³å®šçš„ã€‚

###### ç®—æ³•æ­¥éª¤

1. å–å¾—æ•°ç»„ä¸­çš„æœ€å¤§æ•°ï¼Œå¹¶å–å¾—ä½æ•°ï¼Œå³ä¸ºè¿­ä»£æ¬¡æ•° `N`ï¼ˆä¾‹å¦‚ï¼šæ•°ç»„ä¸­æœ€å¤§æ•°å€¼ä¸º 1000ï¼Œåˆ™ `N=4`ï¼‰ï¼›
2. `A` ä¸ºåŸå§‹æ•°ç»„ï¼Œä»æœ€ä½ä½å¼€å§‹å–æ¯ä¸ªä½ç»„æˆ `radix` æ•°ç»„ï¼›
3. å¯¹ `radix` è¿›è¡Œè®¡æ•°æ’åºï¼ˆåˆ©ç”¨è®¡æ•°æ’åºé€‚ç”¨äºå°èŒƒå›´æ•°çš„ç‰¹ç‚¹ï¼‰ï¼›
4. å°† `radix` ä¾æ¬¡èµ‹å€¼ç»™åŸæ•°ç»„ï¼›
5. é‡å¤ 2~4 æ­¥éª¤ `N` æ¬¡

![](https://guide-blog-./images.oss-cn-shenzhen.aliyuncs.com/github/javaguide/cs-basics/sorting-algorithms/radix_sort.gif)

###### ä»£ç å®ç°

```java
/**
 * Radix Sort
 *
 * @param arr
 * @return
 */
public static int[] radixSort(int[] arr) {
    if (arr.length < 2) {
        return arr;
    }
    int N = 1;
    int maxValue = arr[0];
    for (int element : arr) {
        if (element > maxValue) {
            maxValue = element;
        }
    }
    while (maxValue / 10 != 0) {
        maxValue = maxValue / 10;
        N += 1;
    }
    for (int i = 0; i < N; i++) {
        List<List<Integer>> radix = new ArrayList<>();
        for (int k = 0; k < 10; k++) {
            radix.add(new ArrayList<Integer>());
        }
        for (int element : arr) {
            int idx = (element / (int) Math.pow(10, i)) % 10;
            radix.get(idx).add(element);
        }
        int idx = 0;
        for (List<Integer> l : radix) {
            for (int n : l) {
                arr[idx++] = n;
            }
        }
    }
    return arr;
}
```

###### ç®—æ³•åˆ†æ

- **ç¨³å®šæ€§** ï¼šç¨³å®š
- **æ—¶é—´å¤æ‚åº¦** ï¼šæœ€ä½³ï¼š`O(nÃ—k)` æœ€å·®ï¼š`O(nÃ—k)` å¹³å‡ï¼š`O(nÃ—k)`
- **ç©ºé—´å¤æ‚åº¦** ï¼š`O(n+k)`

**åŸºæ•°æ’åº vs è®¡æ•°æ’åº vs æ¡¶æ’åº**

è¿™ä¸‰ç§æ’åºç®—æ³•éƒ½åˆ©ç”¨äº†æ¡¶çš„æ¦‚å¿µï¼Œä½†å¯¹æ¡¶çš„ä½¿ç”¨æ–¹æ³•ä¸Šæœ‰æ˜æ˜¾å·®å¼‚ï¼š

- åŸºæ•°æ’åºï¼šæ ¹æ®é”®å€¼çš„æ¯ä½æ•°å­—æ¥åˆ†é…æ¡¶
- è®¡æ•°æ’åºï¼šæ¯ä¸ªæ¡¶åªå­˜å‚¨å•ä¸€é”®å€¼
- æ¡¶æ’åºï¼šæ¯ä¸ªæ¡¶å­˜å‚¨ä¸€å®šèŒƒå›´çš„æ•°å€¼




## ğŸ¨è®¾è®¡æ¨¡å¼

## ğŸ™‡â€â™‚ï¸æ™ºåŠ›é¢˜

### èµ›é©¬æ‰¾æœ€å¿«çš„é©¬åŒ¹ï¼ˆé«˜é¢‘é¢˜ï¼‰

ä¸€èˆ¬æœ‰è¿™ä¹ˆå‡ ç§é—®æ³•ï¼š

25åŒ¹é©¬5æ¡è·‘é“æ‰¾æœ€å¿«çš„3åŒ¹é©¬ï¼Œéœ€è¦è·‘å‡ æ¬¡ï¼Ÿå‚è€ƒå›ç­”ï¼š7

64åŒ¹é©¬8æ¡è·‘é“æ‰¾æœ€å¿«çš„4åŒ¹é©¬ï¼Œéœ€è¦è·‘å‡ æ¬¡ï¼Ÿå‚è€ƒå›ç­”ï¼š11

25åŒ¹é©¬5æ¡è·‘é“æ‰¾æœ€å¿«çš„5åŒ¹é©¬ï¼Œéœ€è¦è·‘å‡ æ¬¡ï¼Ÿå‚è€ƒå›ç­”ï¼šæœ€å°‘8æ¬¡æœ€å¤š9æ¬¡

å»ºè®®ç”»å›¾è¡¨æ¥çœ‹ï¼Œå°†é—®é¢˜ç®€å•åŒ–ä¸€ç‚¹ï¼Œå°†å¤§é—®é¢˜åŒ–æˆå°é—®é¢˜å³å¯ï¼ŒåŒæ—¶Bç«™æœ‰ä¸ªè®²è§£è§†é¢‘è¿˜ä¸é”™ï¼šhttps://www.bilibili.com/video/BV1KJ411g78y

è¯¦ç»†è§£æ³•ï¼š

**1ã€25åŒ¹é©¬5æ¡è·‘é“æ‰¾æœ€å¿«çš„3åŒ¹é©¬ï¼Œéœ€è¦è·‘å‡ æ¬¡ï¼Ÿ**

![image-20220626130705310](./images/image-20220626130705310.png)

å°†25åŒ¹é©¬åˆ†æˆABCDE5ç»„ï¼Œå‡è®¾æ¯ç»„çš„æ’åå°±æ˜¯A1>A2>A3>A4>A5,ç”¨è¾¹ç›¸è¿ï¼Œè¿™é‡Œæ¯”èµ›5æ¬¡

ç¬¬6æ¬¡ï¼Œæ¯ç»„çš„ç¬¬ä¸€åè¿›è¡Œæ¯”èµ›ï¼Œå¯ä»¥æ‰¾å‡ºæœ€å¿«çš„é©¬ï¼Œè¿™é‡Œå‡è®¾A1>B1>C1>D1>E1

D1ï¼ŒE1è‚¯å®šè¿›ä¸äº†å‰3ï¼Œç›´æ¥æ’é™¤æ‰

ç¬¬7æ¬¡ï¼ŒB1 C1 A2 B2 A3æ¯”èµ›ï¼Œå¯ä»¥æ‰¾å‡ºç¬¬äºŒï¼Œç¬¬ä¸‰å

æ‰€ä»¥æœ€å°‘æ¯”èµ›éœ€è¦7æ¬¡

**2ã€64åŒ¹é©¬8æ¡è·‘é“æ‰¾æœ€å¿«çš„4åŒ¹é©¬ï¼Œéœ€è¦è·‘å‡ æ¬¡ï¼Ÿ**

ç¬¬ä¸€æ­¥ å…¨éƒ¨é©¬åˆ†ä¸º8ç»„ï¼Œæ¯ç»„8åŒ¹ï¼Œæ¯ç»„å„è·‘ä¸€æ¬¡ï¼Œç„¶åæ·˜æ±°æ‰æ¯ç»„çš„åå››åï¼Œå¦‚ä¸‹å›¾ï¼ˆéœ€è¦æ¯”èµ›8åœºï¼‰

![image-20220626130716212](./images/image-20220626130716212.png)

ç¬¬äºŒæ­¥ å–æ¯ç»„ç¬¬ä¸€åè¿›è¡Œä¸€æ¬¡æ¯”èµ›ï¼Œç„¶åæ·˜æ±°æœ€åå››åæ‰€åœ¨ç»„çš„æ‰€æœ‰é©¬ï¼Œå¦‚ä¸‹å›¾ï¼ˆéœ€è¦æ¯”èµ›1åœºï¼‰

![image-20220626130732424](./images/image-20220626130732424.png)

è¿™ä¸ªæ—¶å€™æ€»å† å†›å·²ç»è¯ç”Ÿï¼Œå®ƒå°±æ˜¯A1ï¼Œè“åŸŸï¼ˆå®ƒä¸éœ€è¦æ¯”èµ›äº†ï¼‰ã€‚

è€Œå…¶ä»–å¯èƒ½è·‘å¾—æœ€å¿«çš„ä¸‰åŒ¹é©¬åªå¯èƒ½æ˜¯ä¸‹å›¾ä¸­çš„é»„åŸŸäº†ï¼ˆA2,A3,A4,B1,B2,B3,C1,C2,D1ï¼Œå…±9åŒ¹é©¬ï¼‰

![image-20220626130742122](./images/image-20220626130742122.png)

ç¬¬ä¸‰æ­¥ åªè¦ä»ä¸Šé¢çš„9åŒ¹é©¬ä¸­æ‰¾å‡ºè·‘å¾—æœ€å¿«çš„ä¸‰åŒ¹é©¬å°±å¯ä»¥äº†ï¼Œä½†æ˜¯ç°åœ¨åªè¦8ä¸ªè·‘é“ï¼Œæ€ä¹ˆåŠï¼Ÿ

é‚£å°±éšæœºé€‰å‡º8åŒ¹é©¬è¿›è¡Œä¸€æ¬¡æ¯”èµ›å§ï¼ˆéœ€è¦æ¯”èµ›ä¸€åœºï¼‰

ç¬¬å››æ­¥ ä¸Šé¢æ¯”èµ›å®Œï¼Œé€‰å‡ºäº†å‰ä¸‰åï¼Œä½†æ˜¯9åŒ¹é©¬ä¸­è¿˜æœ‰ä¸€åŒ¹é©¬æ²¡è·‘å‘¢ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªæ½œåŠ›è‚¡å•Šï¼Œé‚£å°±å’Œå‰ä¸‰åæ¯”ä¸€æ¯”å§ï¼Œè¿™å››åŒ¹é©¬æ¯”ä¸€åœºï¼Œé€‰å‡ºå‰ä¸‰åã€‚æœ€ååŠ ä¸Šæ€»å† å†›ï¼Œè·‘å¾—æœ€å¿«çš„å››åŒ¹é©¬è¯ç”Ÿäº†ï¼ï¼ï¼ï¼ˆéœ€è¦ä¸€åœºæ¯”èµ›ï¼‰

æœ€åï¼Œä¸€å…±éœ€è¦æ¯”èµ›çš„åœºæ¬¡ï¼š8 + 1 + 1 + 1 = 11 åœº

**3ã€25åŒ¹é©¬5æ¡è·‘é“æ‰¾æœ€å¿«çš„5åŒ¹é©¬ï¼Œéœ€è¦è·‘å‡ æ¬¡ï¼Ÿ**

(1) é¦–å…ˆå°†25åŒ¹é©¬åˆ†æˆ5ç»„ï¼Œå¹¶åˆ†åˆ«è¿›è¡Œ5åœºæ¯”èµ›ä¹‹åå¾—åˆ°çš„åæ¬¡æ’åˆ—å¦‚ä¸‹ï¼š

Aç»„ï¼š [A1 A2 A3  A4 A5]

Bç»„ï¼š [B1 B2 B3  B4 B5]

Cç»„ï¼š [C1 C2 C3 C4 C5]

Dç»„ï¼š [D1 D2 D3 D4 D5]

Eç»„ï¼š [E1 E2 E3  E4 E5]

å…¶ä¸­ï¼Œæ¯ä¸ªå°ç»„æœ€å¿«çš„é©¬ä¸º[A1ã€B1ã€C1ã€D1ã€E1]ã€‚

(2) å°†[A1ã€B1ã€C1ã€D1ã€E1]è¿›è¡Œç¬¬6åœºï¼Œé€‰å‡ºç¬¬1åçš„é©¬ï¼Œä¸å¦¨è®¾ A1>B1>C1>D1>E1. æ­¤æ—¶ç¬¬1åçš„é©¬ä¸ºA1ã€‚

(3) å°†[A2ã€B1ã€C1ã€D1ã€E1]è¿›è¡Œç¬¬7åœºï¼Œæ­¤æ—¶é€‰æ‹©å‡ºæ¥çš„å¿…å®šæ˜¯ç¬¬2åçš„é©¬ï¼Œä¸å¦¨å‡è®¾ä¸ºB1ã€‚å› ä¸ºè¿™5åŒ¹é©¬æ˜¯é™¤å»A1ä¹‹å¤–æ¯ä¸ªå°ç»„å½“å‰æœ€å¿«çš„é©¬ã€‚

(3) è¿›è¡Œç¬¬8åœºï¼Œé€‰æ‹©[A2ã€B2ã€C1ã€D1ã€E1]è§’é€å‡ºç¬¬3åçš„é©¬ã€‚

(4) ä¾æ¬¡ç±»æ¨ï¼Œç¬¬9ï¼Œ10åœºå¯ä»¥åˆ†åˆ«å†³å‡ºç¬¬4ï¼Œ5åçš„å—ã€‚

å› æ­¤ï¼Œä¾ç…§è¿™ç§ç«æ ‡èµ›æ’åºæ€æƒ³ï¼Œéœ€è¦10åœºæ¯”èµ›æ˜¯ä¸€å®šå¯ä»¥å–å‡ºå‰5åçš„ã€‚

**ä»”ç»†æƒ³ä¸€ä¸‹ï¼Œå¦‚æœéœ€è¦å‡å°‘æ¯”èµ›åœºæ¬¡ï¼Œå°±ä¸€å®šéœ€è¦åœ¨æŸä¸€æ¬¡æ¯”èµ›ä¸­åŒæ—¶å†³å‡º2ä¸ªåæ¬¡ï¼Œè€Œä¸”æ¯ä¸€åœºæ¯”èµ›ä¹‹åï¼Œæœ‰ä¸€äº›ä¸å¯èƒ½è¿›å…¥å‰5åçš„é©¬å¯ä»¥æå‰å‡ºå±€ã€‚**

å½“ç„¶è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå°±å¿…é¡»å°å¿ƒé€‰æ‹©æ¯ä¸€åœºæ¯”èµ›çš„é©¬åŒ¹ã€‚æˆ‘ä»¬åœ¨ä¸Šé¢çš„æ–¹æ³•åŸºç¡€ä¸Šè¿›ä¸€æ­¥æ€è€ƒè¿™ä¸ªé—®é¢˜ï¼Œå¸Œæœ›èƒ½å¤Ÿå¾—åˆ°è§£å†³ã€‚

(1) é¦–å…ˆåˆ©ç”¨5åœºæ¯”èµ›è§’é€å‡ºæ¯ä¸ªå°ç»„çš„æ’åæ¬¡åºæ˜¯ç»å¯¹å¿…è¦çš„ã€‚

(2) ç¬¬6åœºæ¯”èµ›é€‰å‡ºç¬¬1åçš„é©¬ä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ã€‚å‡å¦‚ä»ç„¶æ˜¯A1é©¬(A1>B1>C1>D1>E1)ã€‚é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªé‡è¦çš„ç»“è®ºï¼šæœ‰ä¸€äº›é©¬åœ¨å‰6åœºæ¯”èµ›ä¹‹åå°±å†³å®šå‡ºå±€çš„å‘½è¿äº†(ä¸‹é¢ç²‰è‰²å­—ä½“æ ‡å¿—å‡ºå±€)ã€‚

Aç»„ï¼š [A1 A2 A3  A4 A5]

Bç»„ï¼š [B1 B2 B3  B4 B5 ]

Cç»„ï¼š [C1 C2 C3  C4 C5 ]

Dç»„ï¼š [D1 D2 D3 D4 D5 ]

Eç»„ï¼š [E1  E2 E3  E4 E5 ]

(3) ç¬¬7åœºæ¯”èµ›æ˜¯å…³é”®ï¼Œèƒ½å¦åŒæ—¶å†³å‡ºç¬¬2ï¼Œ3åçš„é©¬å‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆåšä¸‹åˆ†æï¼š

åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼Œç¬¬7åœºæ¯”èµ›[A2ã€B1ã€C1ã€D1ã€E1]æ˜¯ä¸ºäº†å†³å®šç¬¬2åçš„é©¬ã€‚ä½†æ˜¯åœ¨ç¬¬6åœºæ¯”èµ›ä¸­æˆ‘ä»¬å·²ç»å¾—åˆ°(B1>C1>D1>E1)ï¼Œè¯•é—®ï¼Ÿæœ‰B1åœ¨çš„æ¯”èµ›ï¼ŒC1ã€D1ã€E1è¿˜æœ‰å¯èƒ½äº‰å¤ºç¬¬2åå—ï¼Ÿ å½“ç„¶ä¸å¯èƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬2ååªèƒ½åœ¨A2ã€B1ä¸­å‡ºç°ã€‚å®é™…ä¸Šåªéœ€è¦2æ¡è·‘é“å°±å¯ä»¥å†³å‡ºç¬¬2åï¼Œå‰©ä¸‹C1ã€D1ã€E1çš„3æ¡è·‘é“éƒ½åªèƒ½ç”¨æ¥å‡‘çƒ­é—¹çš„å—ï¼Ÿ

èƒ½å¤Ÿä¼˜åŒ–çš„å…³é”®å‡ºæ¥äº†ï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿé€šè¿‡å‰©ä¸‹çš„3ä¸ªè·‘é“æ¥å†³å‡ºç¬¬3åå‘¢ï¼Ÿå½“ç„¶å¯ä»¥ï¼Œæˆ‘ä»¬æ¥è¿›ä¸€æ­¥åˆ†æç¬¬3åçš„æƒ…å†µï¼Ÿ

â— å¦‚æœA2>B1(å³ç¬¬2åä¸ºA2)ï¼Œé‚£ä¹ˆæ ¹æ®ç¬¬6åœºæ¯”èµ›ä¸­çš„(B1>C1>D1>E1)ã€‚ å¯ä»¥æ–­å®šç¬¬3ååªèƒ½åœ¨A3å’ŒB1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœB1>A2(å³ç¬¬2åä¸ºB1)ï¼Œé‚£ä¹ˆå¯ä»¥æ–­å®šçš„ç¬¬3ååªèƒ½åœ¨A2, B2,C1 ä¸­äº§ç”Ÿã€‚

å¥½äº†ï¼Œç»“è®ºä¹Ÿå‡ºæ¥äº†ï¼Œåªè¦æˆ‘ä»¬æŠŠ[A2ã€B1ã€A3ã€B2ã€C1]ä½œä¸ºç¬¬7åœºæ¯”èµ›çš„é©¬ï¼Œé‚£ä¹ˆè¿™åœºæ¯”èµ›çš„ç¬¬2ï¼Œ3åä¸€å®šæ˜¯æ•´ä¸ª25åŒ¹é©¬ä¸­çš„ç¬¬2ï¼Œ3åã€‚

æˆ‘ä»¬åœ¨è¿™é‡Œåˆ—ä¸¾å‡ºç¬¬7åœºçš„2ï¼Œ3åæ¬¡çš„æ‰€æœ‰å¯èƒ½æƒ…å†µï¼š

â‘  ç¬¬2å=A2ï¼Œç¬¬3å=A3

â‘¡ ç¬¬2å=A2ï¼Œç¬¬3å=B1

â‘¢ ç¬¬2å=B1ï¼Œç¬¬3å=A2

â‘£ ç¬¬2å=B1ï¼Œç¬¬3å=B2

â‘¤ ç¬¬2å=B1ï¼Œç¬¬3å=C1

(4) ç¬¬8åœºæ¯”èµ›å¾ˆå¤æ‚ï¼Œæˆ‘ä»¬è¦æ ¹æ®ç¬¬7åœºçš„æ‰€æœ‰å¯èƒ½çš„æ¯”èµ›æƒ…å†µè¿›è¡Œåˆ†æã€‚

â‘  ç¬¬2å=A2ï¼Œç¬¬3å=A3ã€‚é‚£ä¹ˆæ­¤ç§æƒ…å†µä¸‹ç¬¬4ååªèƒ½åœ¨A4å’ŒB1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=A4ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A5ã€B1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=B1ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A4ã€B2ã€C1ä¸­äº§ç”Ÿã€‚

ä¸ç®¡ç»“æœå¦‚ä½•ï¼Œæ­¤ç§æƒ…å†µä¸‹ï¼Œç¬¬4ã€5åéƒ½å¯ä»¥åœ¨ç¬¬8åœºæ¯”èµ›ä¸­å†³å‡ºã€‚å…¶ä¸­æ¯”èµ›é©¬åŒ¹ä¸º[A4ã€A5ã€B1ã€B2ã€C1]

â‘¡ ç¬¬2å=A2ï¼Œç¬¬3å=B1ã€‚é‚£ä¹ˆæ­¤ç§æƒ…å†µä¸‹ç¬¬4ååªèƒ½åœ¨A3ã€B2ã€C1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=A3ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A4ã€B2ã€C1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=B2ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A3ã€B3ã€C1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=C1ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A3ã€B2ã€C2ã€D1ä¸­äº§ç”Ÿã€‚

é‚£ä¹ˆï¼Œç¬¬4ã€5åéœ€è¦åœ¨é©¬åŒ¹[A3ã€B2ã€B3ã€C1ã€A4ã€C2ã€D1]ä¸ƒåŒ¹é©¬ä¸­äº§ç”Ÿï¼Œåˆ™å¿…é¡»æ¯”èµ›ä¸¤åœºæ‰è¡Œï¼Œä¹Ÿå°±æ˜¯åˆ°ç¬¬9åœºè§’é€å‡ºå…¨éƒ¨çš„å‰5åã€‚

â‘¢ ç¬¬2å=B1ï¼Œç¬¬3å=A2ã€‚é‚£ä¹ˆæ­¤ç§æƒ…å†µä¸‹ç¬¬4ååªèƒ½åœ¨A3ã€B2ã€C1ä¸­äº§ç”Ÿã€‚

æƒ…å†µå’Œâ‘¡ä¸€æ ·ï¼Œå¿…é¡»è§’é€ç¬¬9åœº

â‘£ ç¬¬2å=B1ï¼Œç¬¬3å=B2ã€‚ é‚£ä¹ˆæ­¤ç§æƒ…å†µä¸‹ç¬¬4ååªèƒ½åœ¨A2ã€B3ã€C1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=A2ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A3ã€B3ã€C1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=B3ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A2ã€B4ã€C1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=C1ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A2ã€B3ã€C2ã€D1ä¸­äº§ç”Ÿã€‚

é‚£ä¹ˆï¼Œç¬¬4ã€5åéœ€è¦åœ¨é©¬åŒ¹[A2ã€B3ã€B4ã€C1ã€A3ã€C2ã€D1]ä¸ƒåŒ¹é©¬ä¸­äº§ ç”Ÿï¼Œåˆ™å¿…é¡»æ¯”èµ›ä¸¤åœºæ‰è¡Œï¼Œä¹Ÿå°±æ˜¯åˆ°ç¬¬9åœºè§’é€å‡ºå…¨éƒ¨çš„å‰5åã€‚

â‘¤ ç¬¬2å=B1ï¼Œç¬¬3å=C1ã€‚é‚£ä¹ˆæ­¤ç§æƒ…å†µä¸‹ç¬¬4ååªèƒ½åœ¨A2ã€B2ã€C2ã€D1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=A2ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A3ã€B2ã€C2ã€D1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=B2ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A2ã€B3ã€C2ã€D1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=C2ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A2ã€B2ã€C3ã€D1ä¸­äº§ç”Ÿã€‚

â— å¦‚æœç¬¬4å=D1ï¼Œé‚£ä¹ˆç¬¬5ååªèƒ½åœ¨A2ã€B2ã€C2ã€D2ã€E2ä¸­äº§ç”Ÿã€‚

é‚£ä¹ˆï¼Œç¬¬4ã€5åéœ€è¦åœ¨é©¬åŒ¹[A2ã€B2ã€C2ã€D1ã€A3ã€B3ã€C3ã€D2ã€E1]ä¹åŒ¹é©¬ä¸­ äº§ ç”Ÿï¼Œå› æ­¤ä¹Ÿå¿…é¡»æ¯”èµ›ä¸¤åœºï¼Œä¹Ÿå°±æ˜¯åˆ°ç¬¬9é•¿å†³å‡ºèƒœè´Ÿã€‚

æ€»ç»“ï¼šæœ€å¥½æƒ…å†µå¯ä»¥åœ¨ç¬¬8åœºè§’é€å‡ºå‰5åï¼Œæœ€å·®ä¹Ÿå¯ä»¥åœ¨ç¬¬9åœºæå®šã€‚
